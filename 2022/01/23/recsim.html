<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Recsim Catalyst | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Recsim Catalyst" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="We will create a recommender bot by neural networks, and use RL methods to train it." />
<meta property="og:description" content="We will create a recommender bot by neural networks, and use RL methods to train it." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/23/recsim.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/23/recsim.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-23T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Recsim Catalyst" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-23T00:00:00-06:00","datePublished":"2022-01-23T00:00:00-06:00","description":"We will create a recommender bot by neural networks, and use RL methods to train it.","headline":"Recsim Catalyst","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/23/recsim.html"},"url":"https://nb.recohut.com/2022/01/23/recsim.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Recsim Catalyst</h1><p class="page-description">We will create a recommender bot by neural networks, and use RL methods to train it.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-23T00:00:00-06:00" itemprop="datePublished">
        Jan 23, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      12 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-23-recsim.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-23-recsim.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-23-recsim.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-23-recsim.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-23-recsim.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Abstract">Abstract<a class="anchor-link" href="#Abstract"> </a></h2><p><em>We propose RecSim, a configurable platform for authoring simulation environments for recommender systems (RSs) that naturally supports sequential interaction with users. RecSim allows the creation of new environments that reflect particular aspects of user behavior and item structure at a level of abstraction well-suited to pushing the limits of current reinforcement learning (RL) and RS techniques in sequential interactive recommendation problems. Environments can be easily configured that vary assumptions about: user preferences and item familiarity; user latent state and its dynamics; and choice models and other user response behavior. We outline how RecSim offers value to RL and RS researchers and practitioners, and how it can serve as a vehicle for academic-industrial collaboration.</em></p>
<p><a href="https://arxiv.org/abs/1909.04847">https://arxiv.org/abs/1909.04847</a></p>
<p><a href="https://github.com/google-research/recsim">GitHub</a>, <a href="https://youtu.be/T6ZLpi65Bsc">Video</a>, <a href="https://medium.com/dataseries/googles-recsim-is-an-open-source-simulation-framework-for-recommender-systems-9a802377acc2">Medium</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>RecSim is a configurable platform for authoring simulation environments for recommender systems (RSs) that naturally supports sequential interaction with users. RecSim allows the creation of new environments that reflect particular aspects of user behavior and item structure at a level of abstraction well-suited to pushing the limits of current reinforcement learning (RL) and RS techniques in sequential interactive recommendation problems. Environments can be easily configured that vary assumptions about: user preferences and item familiarity; user latent state and its dynamics; and choice models and other user response behavior. We outline how RecSim offers value to RL and RS researchers and practitioners, and how it can serve as a vehicle for academic-industrial collaboration. For a detailed description of the RecSim architecture please read Ie et al. Please cite the paper if you use the code from this repository in your work.</p>
<p>RecSim simulates a recommender agent’s interaction with an environment where the agent interacts by doing some recommendations to users. Both the user and the subject of recommendations are simulated. The simulations are done based on popularity, interests, demographics, frequency and other traits. When an RL agent recommends something to a user, then depending on the user’s acceptance, few traits are scored high. This still sounds like a typical recommendation system. However, with RecSim, a developer can author these traits. The features in a user choice model can be made more customised as the agent gets rewarded for making the right recommendation.</p>
<p><img src="https://github.com/recohut/nbs/blob/main/raw/_images/T219174_1.png?raw=1" alt="" /></p>
<p><em>Green and blue boxes show the environment. We need to implement special classes, User and Document. Our bot("Agent") have to choose from several documents the most relevant for the user. The user can move to the offered document if he accepts it, to random document overwise or stay on the current document.</em></p>
<p>Green and blue boxes show the environment. We need to implement special classes, User and Document. Our bot("Agent") have to choose from several documents the most relevant for the user. The user can move to the offered document if he accepts it, to random document overwise or stay on the current document.</p>
<p>Recsim is a configurable simulation platform for recommender systems make by Google, which utilized the document and user database directly. We can break Recsim into two parts,</p>
<ul>
<li>The environment consists of a user model, a document (item) model and a user-choice model. The user model samples users from a prior distribution of observable and latent user features; the document model samples items from a prior over observable and latent document features; and the user-choice model determines the user’s response, which is dependent on observable document features, observable and latent user features.</li>
<li>The SlateQ Simulation Environment, which uses the SlateQ Algorithm to return a slate of items back to the simulation environment.</li>
</ul>
<p>Unlike virtual Taobao, Recsim has a concrete representation of items, and the actions returned by the reinforcement learning agent can be directly associated with items. However, the user model and item model of Recsim are too simple, and without sufficient data support, the prior probability distribution for generating simulated users and virtual items is difficult to be accurate.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">Uq</span> <span class="n">catalyst</span> <span class="n">gym</span> <span class="n">recsim</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gym</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="kn">from</span> <span class="nn">catalyst</span> <span class="kn">import</span> <span class="n">dl</span><span class="p">,</span> <span class="n">utils</span>

<span class="kn">from</span> <span class="nn">gym</span> <span class="kn">import</span> <span class="n">spaces</span>

<span class="kn">from</span> <span class="nn">recsim</span> <span class="kn">import</span> <span class="n">document</span><span class="p">,</span> <span class="n">user</span>
<span class="kn">from</span> <span class="nn">recsim.choice_model</span> <span class="kn">import</span> <span class="n">AbstractChoiceModel</span>
<span class="kn">from</span> <span class="nn">recsim.simulator</span> <span class="kn">import</span> <span class="n">recsim_gym</span><span class="p">,</span> <span class="n">environment</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Params">Params<a class="anchor-link" href="#Params"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_device</span><span class="p">()</span>
<span class="n">utils</span><span class="o">.</span><span class="n">set_global_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">DOC_NUM</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">EMB_SIZE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">P_EXIT_ACCEPTED</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">P_EXIT_NOT_ACCEPTED</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="c1"># let&#39;s define a matrix W for simulation of users&#39; respose</span>
<span class="c1"># (based on the section 7.3 of the paper https://arxiv.org/pdf/1512.07679.pdf)</span>
<span class="c1"># W_ij defines the probability that a user will accept recommendation j</span>
<span class="c1"># given that he is consuming item i at the moment</span>

<span class="n">W</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">DOC_NUM</span><span class="p">,</span> <span class="n">DOC_NUM</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">DOC_NUM</span><span class="p">))</span> <span class="o">*</span> \
     <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">P_EXIT_NOT_ACCEPTED</span><span class="p">,</span> <span class="p">(</span><span class="n">DOC_NUM</span><span class="p">,</span> <span class="n">DOC_NUM</span><span class="p">))</span> <span class="o">+</span> \
     <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">P_EXIT_ACCEPTED</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">DOC_NUM</span><span class="p">))</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">DOC_NUM</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Document-Model">Document Model<a class="anchor-link" href="#Document-Model"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Document</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">AbstractDocument</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doc_id</span><span class="p">,)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">observation_space</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="n">DOC_NUM</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Document #</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doc_id</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DocumentSampler</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">AbstractDocumentSampler</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_ctor</span><span class="o">=</span><span class="n">Document</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">doc_ctor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doc_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">sample_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doc_ctor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_doc_count</span> <span class="o">%</span> <span class="n">DOC_NUM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doc_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">doc</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="User-Model">User Model<a class="anchor-link" href="#User-Model"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">UserState</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">AbstractUserState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">active_session</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_session</span> <span class="o">=</span> <span class="n">active_session</span>

    <span class="k">def</span> <span class="nf">create_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;User #</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">observation_space</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="n">DOC_NUM</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">score_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_obs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">W</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">,</span> <span class="n">doc_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>


<span class="k">class</span> <span class="nc">StaticUserSampler</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">AbstractUserSampler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_ctor</span><span class="o">=</span><span class="n">UserState</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">user_ctor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">sample_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sampled_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_ctor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">DOC_NUM</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sampled_user</span>


<span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">AbstractResponse</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accept</span> <span class="o">=</span> <span class="n">accept</span>

    <span class="k">def</span> <span class="nf">create_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">),)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">response_space</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UserChoiceModel</span><span class="p">(</span><span class="n">AbstractChoiceModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_score_no_click</span> <span class="o">=</span> <span class="n">P_EXIT_ACCEPTED</span>

    <span class="k">def</span> <span class="nf">score_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_state</span><span class="p">,</span> <span class="n">doc_obs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_obs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expecting single document, but got: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc_obs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">user_state</span><span class="o">.</span><span class="n">score_document</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">doc_obs</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">choose_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">UserModel</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">AbstractUserModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="n">StaticUserSampler</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choice_model</span> <span class="o">=</span> <span class="n">UserChoiceModel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">simulate_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slate_documents</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slate_documents</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expecting single document, but got: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">slate_documents</span><span class="p">))</span>

        <span class="n">responses</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_model_ctor</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">slate_documents</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">choice_model</span><span class="o">.</span><span class="n">score_documents</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_state</span><span class="p">,</span>
            <span class="p">[</span><span class="n">doc</span><span class="o">.</span><span class="n">create_observation</span><span class="p">()</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">slate_documents</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">selected_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice_model</span><span class="o">.</span><span class="n">choose_item</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">selected_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">responses</span><span class="p">[</span><span class="n">selected_index</span><span class="p">]</span><span class="o">.</span><span class="n">accept</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">responses</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slate_documents</span><span class="p">,</span> <span class="n">responses</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slate_documents</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expecting single document, but got: </span><span class="si">{</span><span class="n">slate_documents</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">slate_documents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">accept</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_state</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">doc_id</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_state</span><span class="o">.</span><span class="n">active_session</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">P_EXIT_ACCEPTED</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_state</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">DOC_NUM</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_state</span><span class="o">.</span><span class="n">active_session</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">P_EXIT_NOT_ACCEPTED</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a boolean indicating if the session is over.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_state</span><span class="o">.</span><span class="n">active_session</span>


<span class="k">def</span> <span class="nf">clicked_reward</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
    <span class="n">reward</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">accept</span><span class="p">:</span>
            <span class="n">reward</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">reward</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="RecSim-Environment">RecSim Environment<a class="anchor-link" href="#RecSim-Environment"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">make_env</span><span class="p">():</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">recsim_gym</span><span class="o">.</span><span class="n">RecSimGymEnv</span><span class="p">(</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span>
            <span class="n">UserModel</span><span class="p">(),</span> 
            <span class="n">DocumentSampler</span><span class="p">(),</span> 
            <span class="n">DOC_NUM</span><span class="p">,</span> 
            <span class="mi">1</span><span class="p">,</span> 
            <span class="n">resample_documents</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">),</span>
        <span class="n">clicked_reward</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">env</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Actor-Critic-Policy">Actor-Critic Policy<a class="anchor-link" href="#Actor-Critic-Policy"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The actor is a simple NN, that generate embedding action vector based on current state. The critic model is more complicated. In our implementation, we need action embeddings. Our actions is a picking a document. So, we just need a embedding vector for each document. They can be trained as well as a critic model. And we have to implement choosing process by choosing top-k variants and calculate q-value on them.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">from</span> <span class="nn">catalyst.contrib.nn</span> <span class="kn">import</span> <span class="n">Normalize</span>


<span class="n">inner_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_optimal_inner_init</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">)</span>
<span class="n">outer_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">outer_init</span>


<span class="k">class</span> <span class="nc">ActorModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">doc_num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">doc_emb_size</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">actor</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">doc_num</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">doc_emb_size</span><span class="p">),</span>
            <span class="n">Normalize</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">inner_fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">outer_fn</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">doc_num</span> <span class="o">=</span> <span class="n">doc_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc_emb_size</span> <span class="o">=</span> <span class="n">doc_emb_size</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actor</span><span class="p">(</span><span class="n">states</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">CriticModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">doc_num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">doc_emb_size</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">critic</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">doc_num</span> <span class="o">+</span> <span class="n">doc_emb_size</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">inner_fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">outer_fn</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">doc_embs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">doc_num</span><span class="p">,</span> <span class="n">doc_emb_size</span><span class="p">),</span>
            <span class="n">Normalize</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">doc_num</span> <span class="o">=</span> <span class="n">doc_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc_emb_size</span> <span class="o">=</span> <span class="n">doc_emb_size</span>
        
    <span class="k">def</span> <span class="nf">_generate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">proto_actions</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">states</span><span class="p">,</span> <span class="n">proto_actions</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">proto_actions</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_input</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">proto_actions</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">get_topk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">proto_actions</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Instead of kNN algorithm we can calculate distance across all of the objects.</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">proto_actions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_embs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">doc_embs</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">]),</span> <span class="n">indexes</span>
    
    <span class="k">def</span> <span class="nf">get_best</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">proto_actions</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">doc_embs</span><span class="p">,</span> <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_topk</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">proto_actions</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>
        <span class="n">top_k</span> <span class="o">=</span> <span class="n">doc_embs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">best_values</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">best_indexes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">doc_embs</span><span class="p">,</span> <span class="n">indexes</span><span class="p">)):</span>
            <span class="n">new_states</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">top_k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># for each pair of state and action we use critic to calculate values</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">new_states</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">best_values</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">best</span><span class="p">]</span>
            <span class="n">best_indexes</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">best</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">best_indexes</span><span class="p">,</span> <span class="n">best_values</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training">Training<a class="anchor-link" href="#Training"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">namedtuple</span>

<span class="n">Transition</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;Transition&#39;</span><span class="p">,</span> 
    <span class="n">field_names</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;state&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;action&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;reward&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;next_state&#39;</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">ReplayBuffer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">capacity</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transition</span><span class="p">:</span> <span class="n">Transition</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">),</span> 
            <span class="n">batch_size</span><span class="p">,</span> 
            <span class="n">replace</span><span class="o">=</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">dones</span><span class="p">,</span> <span class="n">next_states</span> <span class="o">=</span> \
            <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dones</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">next_states</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data.dataset</span> <span class="kn">import</span> <span class="n">IterableDataset</span>


<span class="k">class</span> <span class="nc">ReplayDataset</span><span class="p">(</span><span class="n">IterableDataset</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">ReplayBuffer</span><span class="p">,</span> <span class="n">epoch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e3</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_size</span> <span class="o">=</span> <span class="n">epoch_size</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">dones</span><span class="p">,</span> <span class="n">next_states</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dones</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">actions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rewards</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dones</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">next_states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_size</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">extract_state</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">user_space</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">spaces</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">user_space</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">critic</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Our framework is created by PG process and it must be trained with </span>
    <span class="c1"># a noise added to the actor&#39;s output.</span>
    <span class="c1"># But in our framework it&#39;s better to sample action from the enviroment.</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epsilon</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
        <span class="n">proto_action</span> <span class="o">=</span> <span class="n">actor</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">critic</span><span class="o">.</span><span class="n">get_best</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">proto_action</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">action</span>


<span class="k">def</span> <span class="nf">generate_session</span><span class="p">(</span>
    <span class="n">env</span><span class="p">,</span> 
    <span class="n">actor</span><span class="p">,</span>
    <span class="n">critic</span><span class="p">,</span>
    <span class="n">replay_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">top_k</span><span class="o">=</span><span class="mi">10</span>
<span class="p">):</span>
    <span class="n">total_reward</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">extract_state</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">critic</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">)</span>
        <span class="n">next_s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">next_s</span> <span class="o">=</span> <span class="n">extract_state</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">next_s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">replay_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="n">Transition</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">next_s</span><span class="p">)</span>
            <span class="n">replay_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>

        <span class="n">total_reward</span> <span class="o">+=</span> <span class="n">r</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">next_s</span>
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">total_reward</span>

<span class="k">def</span> <span class="nf">generate_sessions</span><span class="p">(</span>
    <span class="n">env</span><span class="p">,</span> 
    <span class="n">actor</span><span class="p">,</span>
    <span class="n">critic</span><span class="p">,</span>
    <span class="n">replay_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">num_sessions</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">top_k</span><span class="o">=</span><span class="mi">10</span>
<span class="p">):</span>
    <span class="n">sessions_reward</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i_episone</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sessions</span><span class="p">):</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="n">generate_session</span><span class="p">(</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> 
            <span class="n">actor</span><span class="o">=</span><span class="n">actor</span><span class="p">,</span>
            <span class="n">critic</span><span class="o">=</span><span class="n">critic</span><span class="p">,</span>
            <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span>
            <span class="n">replay_buffer</span><span class="o">=</span><span class="n">replay_buffer</span><span class="p">,</span>
            <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span>
        <span class="p">)</span>
        <span class="n">sessions_reward</span> <span class="o">+=</span> <span class="n">reward</span>
    <span class="n">sessions_reward</span> <span class="o">/=</span> <span class="n">num_sessions</span>
    <span class="k">return</span> <span class="n">sessions_reward</span>

<span class="k">def</span> <span class="nf">soft_update</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates the target data with smoothing by ``tau``&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">target_param</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">source</span><span class="o">.</span><span class="n">parameters</span><span class="p">()):</span>
        <span class="n">target_param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span>
            <span class="n">target_param</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">tau</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It's a standart GameCallback!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">RecSimCallback</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">session_period</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_period</span> <span class="o">=</span> <span class="n">session_period</span>
        
    <span class="k">def</span> <span class="nf">on_stage_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">dl</span><span class="o">.</span><span class="n">IRunner</span><span class="p">):</span>
        <span class="n">generate_sessions</span><span class="p">(</span>
            <span class="n">env</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
            <span class="n">actor</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_actor&quot;</span><span class="p">],</span>
            <span class="n">critic</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">],</span>
            <span class="n">replay_buffer</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">replay_buffer</span><span class="p">,</span>
            <span class="n">top_k</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
            <span class="n">epsilon</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">on_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">dl</span><span class="o">.</span><span class="n">IRunner</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">global_batch_step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">session_reward</span> <span class="o">=</span> <span class="n">generate_session</span><span class="p">(</span>
                <span class="n">env</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
                <span class="n">actor</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_actor&quot;</span><span class="p">],</span>
                <span class="n">critic</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">],</span>
                <span class="n">replay_buffer</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">replay_buffer</span><span class="p">,</span>
                <span class="n">top_k</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                <span class="n">epsilon</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">runner</span><span class="o">.</span><span class="n">batch_metrics</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;s_reward&quot;</span><span class="p">:</span> <span class="n">session_reward</span><span class="p">})</span>
            
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">dl</span><span class="o">.</span><span class="n">IRunner</span><span class="p">):</span>
        <span class="n">valid_reward</span> <span class="o">=</span> <span class="n">generate_sessions</span><span class="p">(</span>
            <span class="n">env</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
            <span class="n">actor</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_actor&quot;</span><span class="p">],</span>
            <span class="n">critic</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">],</span>
            <span class="n">top_k</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
            <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">epoch_metrics</span><span class="p">[</span><span class="s2">&quot;_epoch_&quot;</span><span class="p">][</span><span class="s2">&quot;train_v_reward&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_reward</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">CustomRunner</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">Runner</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">replay_buffer</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">tau_period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span> <span class="o">=</span> <span class="n">replay_buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_period</span> <span class="o">=</span> <span class="n">tau_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
    
    <span class="k">def</span> <span class="nf">on_stage_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">dl</span><span class="o">.</span><span class="n">IRunner</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_stage_start</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
        <span class="n">soft_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_actor&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;target_actor&quot;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">soft_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;target_critic&quot;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="c1"># model train/valid step</span>
        <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">dones</span><span class="p">,</span> <span class="n">next_states</span> <span class="o">=</span> <span class="n">batch</span>
        
        <span class="n">proto_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_actor&quot;</span><span class="p">](</span><span class="n">states</span><span class="p">)</span>
        <span class="n">policy_loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">](</span><span class="n">states</span><span class="p">,</span> <span class="n">proto_actions</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">target_proto_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;target_actor&quot;</span><span class="p">](</span><span class="n">next_states</span><span class="p">)</span>
            <span class="n">target_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;target_critic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_best</span><span class="p">(</span><span class="n">next_states</span><span class="p">,</span> <span class="n">target_proto_actions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="n">dones</span> <span class="o">=</span> <span class="n">dones</span> <span class="o">*</span> <span class="mf">1.0</span>
        <span class="n">expected_values</span> <span class="o">=</span> <span class="n">target_values</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dones</span><span class="p">)</span> <span class="o">+</span> <span class="n">rewards</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">doc_embs</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">](</span><span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        
        <span class="n">value_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span>
            <span class="n">values</span><span class="p">,</span>
            <span class="n">expected_values</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;critic_loss&quot;</span><span class="p">:</span> <span class="n">value_loss</span><span class="p">,</span> 
                <span class="s2">&quot;actor_loss&quot;</span><span class="p">:</span> <span class="n">policy_loss</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train_loader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">[</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">policy_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">[</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">[</span><span class="s2">&quot;critic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">value_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">[</span><span class="s2">&quot;critic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_batch_step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">soft_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;target_critic&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
                <span class="n">soft_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;target_actor&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;origin_actor&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's train our model and check the results.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">set_global_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">make_env</span><span class="p">()</span>
<span class="n">replay_buffer</span> <span class="o">=</span> <span class="n">ReplayBuffer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">))</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">tau</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">tau_period</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">session_period</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">epoch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span>


<span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;origin_actor&quot;</span><span class="p">:</span> <span class="n">ActorModel</span><span class="p">(</span><span class="n">doc_num</span><span class="o">=</span><span class="n">DOC_NUM</span><span class="p">,</span> <span class="n">doc_emb_size</span><span class="o">=</span><span class="n">EMB_SIZE</span><span class="p">),</span>
    <span class="s2">&quot;origin_critic&quot;</span><span class="p">:</span> <span class="n">CriticModel</span><span class="p">(</span><span class="n">doc_num</span><span class="o">=</span><span class="n">DOC_NUM</span><span class="p">,</span> <span class="n">doc_emb_size</span><span class="o">=</span><span class="n">EMB_SIZE</span><span class="p">),</span>
    <span class="s2">&quot;target_actor&quot;</span><span class="p">:</span> <span class="n">ActorModel</span><span class="p">(</span><span class="n">doc_num</span><span class="o">=</span><span class="n">DOC_NUM</span><span class="p">,</span> <span class="n">doc_emb_size</span><span class="o">=</span><span class="n">EMB_SIZE</span><span class="p">),</span>
    <span class="s2">&quot;target_critic&quot;</span><span class="p">:</span> <span class="n">CriticModel</span><span class="p">(</span><span class="n">doc_num</span><span class="o">=</span><span class="n">DOC_NUM</span><span class="p">,</span> <span class="n">doc_emb_size</span><span class="o">=</span><span class="n">EMB_SIZE</span><span class="p">),</span>
<span class="p">}</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
  <span class="n">models</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">doc_embs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;target_critic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">doc_embs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

<span class="n">utils</span><span class="o">.</span><span class="n">set_requires_grad</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;target_actor&quot;</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">set_requires_grad</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;target_critic&quot;</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;origin_actor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
    <span class="s2">&quot;critic&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;origin_critic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">loaders</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">ReplayDataset</span><span class="p">(</span><span class="n">replay_buffer</span><span class="p">,</span> <span class="n">epoch_size</span><span class="o">=</span><span class="n">epoch_size</span><span class="p">),</span> 
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">}</span>


<span class="n">runner</span> <span class="o">=</span> <span class="n">CustomRunner</span><span class="p">(</span>
    <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> 
    <span class="n">replay_buffer</span><span class="o">=</span><span class="n">replay_buffer</span><span class="p">,</span> 
    <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span> 
    <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
    <span class="n">tau_period</span><span class="o">=</span><span class="n">tau_period</span>
<span class="p">)</span>

<span class="n">runner</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">models</span><span class="p">,</span>
    <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
    <span class="n">loaders</span><span class="o">=</span><span class="n">loaders</span><span class="p">,</span>
    <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;./logs_rl&quot;</span><span class="p">,</span>
    <span class="n">valid_loader</span><span class="o">=</span><span class="s2">&quot;_epoch_&quot;</span><span class="p">,</span>
    <span class="n">valid_metric</span><span class="o">=</span><span class="s2">&quot;train_v_reward&quot;</span><span class="p">,</span>
    <span class="n">minimize_valid_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">load_best_on_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">RecSimCallback</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">session_period</span><span class="o">=</span><span class="n">session_period</span><span class="p">)]</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/usr/local/lib/python3.7/dist-packages/catalyst/core/runner.py:624: UserWarning: No ``ICriterionCallback/CriterionCallback`` were found while runner.criterion is not None.Do you compute the loss during ``runner.handle_batch``?
  &#34;No ``ICriterionCallback/CriterionCallback`` were found &#34;
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>train (1/20) 
* Epoch (1/20) train_v_reward: 4.45
train (2/20) 
* Epoch (2/20) train_v_reward: 5.48
train (3/20) 
* Epoch (3/20) train_v_reward: 4.35
train (4/20) 
* Epoch (4/20) train_v_reward: 4.73
train (5/20) 
* Epoch (5/20) train_v_reward: 5.52
train (6/20) 
* Epoch (6/20) train_v_reward: 4.36
train (7/20) 
* Epoch (7/20) train_v_reward: 4.88
train (8/20) 
* Epoch (8/20) train_v_reward: 4.33
train (9/20) 
* Epoch (9/20) train_v_reward: 5.01
train (10/20) 
* Epoch (10/20) train_v_reward: 4.78
train (11/20) 
* Epoch (11/20) train_v_reward: 4.9
train (12/20) 
* Epoch (12/20) train_v_reward: 5.41
train (13/20) 
* Epoch (13/20) train_v_reward: 4.63
train (14/20) 
* Epoch (14/20) train_v_reward: 4.86
train (15/20) 
* Epoch (15/20) train_v_reward: 4.38
train (16/20) 
* Epoch (16/20) train_v_reward: 4.15
train (17/20) 
* Epoch (17/20) train_v_reward: 4.45
train (18/20) 
* Epoch (18/20) train_v_reward: 4.27
train (19/20) 
* Epoch (19/20) train_v_reward: 5.27
train (20/20) 
* Epoch (20/20) train_v_reward: 5.14
Top best models:
logs_rl/checkpoints/train.5.pth	5.5200
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In our case, we can compare RL bot results with the optimal recommender agent. The agent can be built by the relation matrix W. We need to chose an index with the maximum value in the column.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">from</span> <span class="nn">recsim.agent</span> <span class="kn">import</span> <span class="n">AbstractEpisodicRecommenderAgent</span>

<span class="k">class</span> <span class="nc">OptimalRecommender</span><span class="p">(</span><span class="n">AbstractEpisodicRecommenderAgent</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_space</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">observation_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_W</span> <span class="o">=</span> <span class="n">W</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_W</span><span class="p">[</span><span class="n">observation</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">run_agent</span><span class="p">(</span>
    <span class="n">env</span><span class="p">,</span> 
    <span class="n">agent</span><span class="p">,</span> 
    <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">),</span> 
    <span class="n">log_every</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e3</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">reward_history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">step</span><span class="p">,</span> <span class="n">episode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>

    <span class="n">observation</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="n">num_steps</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">begin_episode</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">episode_reward</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">episode_reward</span> <span class="o">+=</span> <span class="n">reward</span>

            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">log_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">reward_history</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">:]))</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">reward</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">end_episode</span><span class="p">(</span><span class="n">reward</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
        <span class="n">reward_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">episode_reward</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reward_history</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">make_env</span><span class="p">()</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">OptimalRecommender</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>

<span class="n">reward_history</span> <span class="o">=</span> <span class="n">run_agent</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1000 8.26
2000 7.22
3000 8.18
4000 9.14
5000 8.22
6000 8.22
7000 10.76
8000 9.44
9000 8.2
10000 9.5
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/2022/01/23/recsim.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
