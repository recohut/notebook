<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Itempop and two-stage recommender on MTS data | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Itempop and two-stage recommender on MTS data" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/29/mts.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/29/mts.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-29T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Itempop and two-stage recommender on MTS data" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-29T00:00:00-06:00","datePublished":"2022-01-29T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Itempop and two-stage recommender on MTS data","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/29/mts.html"},"url":"https://nb.recohut.com/2022/01/29/mts.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Itempop and two-stage recommender on MTS data</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-29T00:00:00-06:00" itemprop="datePublished">
        Jan 29, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      27 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-29-mts.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-29-mts.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-29-mts.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-29-mts.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-29-mts.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">pip</span> <span class="n">setuptools</span> <span class="n">wheel</span>
<span class="err">!</span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">benfred</span><span class="o">/</span><span class="n">implicit</span>
<span class="err">!</span><span class="n">cd</span> <span class="n">implicit</span> <span class="o">&amp;&amp;</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">.</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">catboost</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">recohut</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">shuffle</span>

<span class="kn">from</span> <span class="nn">implicit</span> <span class="kn">import</span> <span class="n">nearest_neighbours</span> <span class="k">as</span> <span class="n">NN</span>
<span class="kn">from</span> <span class="nn">implicit.nearest_neighbours</span> <span class="kn">import</span> <span class="n">TFIDFRecommender</span>

<span class="kn">from</span> <span class="nn">catboost</span> <span class="kn">import</span> <span class="n">CatBoostClassifier</span>

<span class="kn">from</span> <span class="nn">recohut.datasets.mts</span> <span class="kn">import</span> <span class="n">MTSDataset</span>
<span class="kn">from</span> <span class="nn">recohut.utils.common_utils</span> <span class="kn">import</span> <span class="n">get_coo_matrix</span>
<span class="kn">from</span> <span class="nn">recohut.transforms.splitting</span> <span class="kn">import</span> <span class="n">TimeRangeSplit</span>
<span class="kn">from</span> <span class="nn">recohut.models.itempop</span> <span class="kn">import</span> <span class="n">ItemPop</span> <span class="k">as</span> <span class="n">PopularRecommender</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">MTSDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="s1">&#39;/content/data&#39;</span><span class="p">,</span> <span class="n">sample_frac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">users_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">processed_dir</span><span class="p">,</span> <span class="s1">&#39;users_processed.csv&#39;</span><span class="p">))</span>
<span class="n">items_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">processed_dir</span><span class="p">,</span> <span class="s1">&#39;items_processed.csv&#39;</span><span class="p">))</span>
<span class="n">interactions_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">processed_dir</span><span class="p">,</span> <span class="s1">&#39;interactions_processed.csv&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">])</span>
<span class="n">interactions_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Winning-Solution">Winning Solution<a class="anchor-link" href="#Winning-Solution"> </a></h2><p>This solution includes a two-stage model. I used item-item CF from implicit library to generate candidates with their scores and Catboost classifier to predict final ranks with classification objective. Recommendations for cold users were made with Popular items.</p>
<p>Implicit model parameters were chosen on sliding time window cross validation. The best scores were achieved by Cosine recommender model, taking only last 20 interactions for each user. 100 candidates with their scores were generated for each user, filtering all items that user had interactions with.</p>
<p>Implicit candidates were calculated for the last 14 days of the interactions. Then catboost model was trained on positive interactions from the candidates list on last 14 days. Random negative sampling was applied.</p>
<p>For final submission implicit candidates and catboost predictions were recalculated on the whole dataset.</p>
<p>Ref: <a href="https://github.com/blondered/ods_MTS_RecSys_Challenge_solution">Daria</a></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">users_inv_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="n">users_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">users_inv_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">items_inv_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="n">items_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items_inv_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">last_date_df</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">boosting_split_date</span> <span class="o">=</span> <span class="n">last_date_df</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">boosting_data</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[(</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span> <span class="o">&gt;</span>
                                 <span class="n">boosting_split_date</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">boost_idx</span> <span class="o">=</span> <span class="n">boosting_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> 
<span class="n">before_boosting</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[(</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span> <span class="o">&lt;=</span>
                                   <span class="n">boosting_split_date</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">before_boosting_known_items</span> <span class="o">=</span> <span class="n">before_boosting</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="s1">&#39;user_id&#39;</span><span class="p">)[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

<span class="n">before_boosting_known_items_mapped</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">recommend</span> <span class="ow">in</span> <span class="n">before_boosting_known_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">before_boosting_known_items_mapped</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                                        <span class="n">items_mapping</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
                                                        <span class="n">recommend</span><span class="p">))</span>
<span class="n">before_boosting</span><span class="p">[</span><span class="s1">&#39;order_from_recent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">before_boosting</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">boost_warm_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">before_boosting</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                                <span class="n">boosting_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Calculates top candidates from implicit model with their scores. Implicit parameters were chosen on time range split cross-validation. History offset stands for taking only lask X items from user history. Day offset stands for taking items from last X days of user history.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">k_neighbours</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">day_offset</span> <span class="o">=</span> <span class="mi">170</span>
<span class="n">history_offset</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">distance</span> <span class="o">=</span> <span class="s1">&#39;Cosine&#39;</span>
<span class="n">num_candidates</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">before_boosting</span><span class="p">[</span><span class="s1">&#39;order_from_recent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">before_boosting</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">before_boosting</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">date_window</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">day_offset</span><span class="p">)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">date_window</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">if</span> <span class="n">history_offset</span><span class="p">:</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;order_from_recent&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">history_offset</span><span class="p">]</span>
    
<span class="k">if</span> <span class="n">distance</span> <span class="o">==</span> <span class="s1">&#39;Cosine&#39;</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">NN</span><span class="o">.</span><span class="n">CosineRecommender</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="n">k_neighbours</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">NN</span><span class="o">.</span><span class="n">TFIDFRecommender</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="n">k_neighbours</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">train_mat</span> <span class="o">=</span> <span class="n">get_coo_matrix</span><span class="p">(</span>
    <span class="n">train</span><span class="p">,</span>
    <span class="n">users_mapping</span><span class="o">=</span><span class="n">users_mapping</span><span class="p">,</span>
    <span class="n">items_mapping</span><span class="o">=</span><span class="n">items_mapping</span><span class="p">,</span>
    <span class="n">weight_col</span><span class="o">=</span><span class="n">weights</span>
<span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_mat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">generate_implicit_recs_mapper</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">train_matrix</span><span class="p">,</span>
        <span class="n">top_N</span><span class="p">,</span>
        <span class="n">user_mapping</span><span class="p">,</span>
        <span class="n">item_inv_mapping</span><span class="p">,</span>
        <span class="n">filter_already_liked_items</span><span class="p">,</span>
        <span class="n">known_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">return_scores</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="nf">_recs_mapper</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_mapping</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filter_items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">known_items</span><span class="p">:</span>
                <span class="n">filtering</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">known_items</span><span class="p">[</span><span class="n">user</span><span class="p">])</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">filter_items</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filtering</span> <span class="o">=</span> <span class="n">filter_items</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">known_items</span> <span class="ow">and</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">known_items</span><span class="p">:</span>
                <span class="n">filtering</span> <span class="o">=</span> <span class="n">known_items</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filtering</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span>
                               <span class="n">train_matrix</span><span class="p">,</span>
                               <span class="n">N</span><span class="o">=</span><span class="n">top_N</span><span class="p">,</span>
                               <span class="n">filter_already_liked_items</span><span class="o">=</span><span class="n">filter_already_liked_items</span><span class="p">,</span>
                               <span class="n">filter_items</span><span class="o">=</span><span class="n">filtering</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_scores</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">recs</span>
        <span class="k">return</span> <span class="n">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">_recs_mapper</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">mapper</span> <span class="o">=</span> <span class="n">generate_implicit_recs_mapper</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">train_mat</span><span class="p">,</span>
    <span class="n">num_candidates</span><span class="p">,</span>
    <span class="n">users_mapping</span><span class="p">,</span>
    <span class="n">items_inv_mapping</span><span class="p">,</span>
    <span class="n">filter_already_liked_items</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">known_items</span><span class="o">=</span><span class="n">before_boosting_known_items_mapped</span><span class="p">,</span>
    <span class="n">filter_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">return_scores</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">boost_warm_idx</span><span class="p">})</span>
<span class="n">recs</span><span class="p">[</span><span class="s1">&#39;item_id_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
<span class="n">recs</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;item_id_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">recs</span><span class="p">[</span><span class="s1">&#39;implicit_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;item_id_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">recs</span><span class="p">[</span><span class="s1">&#39;tmp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;implicit_score&#39;</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
<span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
<span class="n">recs</span><span class="p">[[</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span><span class="s1">&#39;implicit_score&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">recs</span><span class="p">[</span><span class="s1">&#39;tmp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">recs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">recs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">recs</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;item_id_score&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">recs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-fabe3051-a22f-4625-8df0-44ae8f721f86">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>implicit_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>199262.0</td>
      <td>0.707107</td>
    </tr>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>203105.0</td>
      <td>0.707107</td>
    </tr>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>199886.0</td>
      <td>0.707107</td>
    </tr>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>219904.0</td>
      <td>0.707107</td>
    </tr>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>203206.0</td>
      <td>0.707107</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>22231</th>
      <td>1097544</td>
      <td>263721.0</td>
      <td>0.577350</td>
    </tr>
    <tr>
      <th>22231</th>
      <td>1097544</td>
      <td>227113.0</td>
      <td>0.577350</td>
    </tr>
    <tr>
      <th>22231</th>
      <td>1097544</td>
      <td>239830.0</td>
      <td>0.577350</td>
    </tr>
    <tr>
      <th>22231</th>
      <td>1097544</td>
      <td>139002.0</td>
      <td>0.577350</td>
    </tr>
    <tr>
      <th>22231</th>
      <td>1097544</td>
      <td>243127.0</td>
      <td>0.577350</td>
    </tr>
  </tbody>
</table>
<p>2109153 rows × 3 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-fabe3051-a22f-4625-8df0-44ae8f721f86')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-fabe3051-a22f-4625-8df0-44ae8f721f86 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-fabe3051-a22f-4625-8df0-44ae8f721f86');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">recs</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">processed_dir</span><span class="p">,</span> <span class="s1">&#39;impl_scores.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">candidates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">processed_dir</span><span class="p">,</span> <span class="s1">&#39;impl_scores.csv&#39;</span><span class="p">))</span>
<span class="n">candidates</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
<span class="n">candidates</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">index</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">boosting_data</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]],</span> 
                       <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">pos</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">pos</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-7814e304-0b3e-4e09-8c46-a2ec33c48b64">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>implicit_score</th>
      <th>id</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>109925</td>
      <td>5543</td>
      <td>1.000000</td>
      <td>211288</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>126087</td>
      <td>5518</td>
      <td>1.000000</td>
      <td>240448</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>131803</td>
      <td>7807</td>
      <td>0.707107</td>
      <td>250989</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>140179</td>
      <td>5011</td>
      <td>0.707107</td>
      <td>264967</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>223763</td>
      <td>2780</td>
      <td>1.000000</td>
      <td>425032</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>316074</td>
      <td>7033</td>
      <td>1.000000</td>
      <td>604543</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>419536</td>
      <td>10267</td>
      <td>1.000000</td>
      <td>806723</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>482854</td>
      <td>13237</td>
      <td>1.000000</td>
      <td>923066</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>484834</td>
      <td>7558</td>
      <td>0.500000</td>
      <td>927130</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>487160</td>
      <td>3784</td>
      <td>1.000000</td>
      <td>931333</td>
      <td>1</td>
    </tr>
    <tr>
      <th>10</th>
      <td>522481</td>
      <td>13787</td>
      <td>0.516398</td>
      <td>995099</td>
      <td>1</td>
    </tr>
    <tr>
      <th>11</th>
      <td>616140</td>
      <td>8254</td>
      <td>0.169031</td>
      <td>1176238</td>
      <td>1</td>
    </tr>
    <tr>
      <th>12</th>
      <td>626147</td>
      <td>5216</td>
      <td>1.000000</td>
      <td>1193879</td>
      <td>1</td>
    </tr>
    <tr>
      <th>13</th>
      <td>779743</td>
      <td>10971</td>
      <td>0.353553</td>
      <td>1494276</td>
      <td>1</td>
    </tr>
    <tr>
      <th>14</th>
      <td>860928</td>
      <td>14431</td>
      <td>0.500000</td>
      <td>1650890</td>
      <td>1</td>
    </tr>
    <tr>
      <th>15</th>
      <td>928023</td>
      <td>9113</td>
      <td>0.500000</td>
      <td>1784750</td>
      <td>1</td>
    </tr>
    <tr>
      <th>16</th>
      <td>947916</td>
      <td>1173</td>
      <td>1.000000</td>
      <td>1822962</td>
      <td>1</td>
    </tr>
    <tr>
      <th>17</th>
      <td>1030860</td>
      <td>657</td>
      <td>0.333333</td>
      <td>1983602</td>
      <td>1</td>
    </tr>
    <tr>
      <th>18</th>
      <td>1043861</td>
      <td>15384</td>
      <td>1.000000</td>
      <td>2006821</td>
      <td>1</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1093253</td>
      <td>11769</td>
      <td>1.000000</td>
      <td>2101280</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-7814e304-0b3e-4e09-8c46-a2ec33c48b64')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-7814e304-0b3e-4e09-8c46-a2ec33c48b64 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-7814e304-0b3e-4e09-8c46-a2ec33c48b64');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">num_negatives</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">pos_group</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">neg</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="o">~</span><span class="n">candidates</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">neg_sampling</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">neg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pos_group</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span>  <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">neg_sampling</span><span class="p">[</span><span class="s1">&#39;num_choices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">neg_sampling</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_negatives</span><span class="p">,</span> 
                                      <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                    <span class="n">size</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;num_choices&#39;</span><span class="p">],</span>
                                    <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">neg_sampling</span><span class="p">[</span><span class="s1">&#39;sample_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neg_sampling</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">idx_chosen</span> <span class="o">=</span> <span class="n">neg_sampling</span><span class="p">[</span><span class="s1">&#39;sample_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">neg</span> <span class="o">=</span> <span class="n">neg</span><span class="p">[</span><span class="n">neg</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">idx_chosen</span><span class="p">)]</span>
<span class="n">neg</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">neg</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-41398640-f9ca-4be4-8c6d-5342f5fa98fc">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>implicit_score</th>
      <th>id</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>211232</th>
      <td>109925</td>
      <td>12948</td>
      <td>1.000000</td>
      <td>211232</td>
      <td>0</td>
    </tr>
    <tr>
      <th>211234</th>
      <td>109925</td>
      <td>31205</td>
      <td>1.000000</td>
      <td>211234</td>
      <td>0</td>
    </tr>
    <tr>
      <th>211287</th>
      <td>109925</td>
      <td>251132</td>
      <td>1.000000</td>
      <td>211287</td>
      <td>0</td>
    </tr>
    <tr>
      <th>240482</th>
      <td>126087</td>
      <td>38859</td>
      <td>1.000000</td>
      <td>240482</td>
      <td>0</td>
    </tr>
    <tr>
      <th>240493</th>
      <td>126087</td>
      <td>65257</td>
      <td>1.000000</td>
      <td>240493</td>
      <td>0</td>
    </tr>
    <tr>
      <th>240494</th>
      <td>126087</td>
      <td>41067</td>
      <td>1.000000</td>
      <td>240494</td>
      <td>0</td>
    </tr>
    <tr>
      <th>250980</th>
      <td>131803</td>
      <td>207587</td>
      <td>0.577350</td>
      <td>250980</td>
      <td>0</td>
    </tr>
    <tr>
      <th>250988</th>
      <td>131803</td>
      <td>6113</td>
      <td>0.707107</td>
      <td>250988</td>
      <td>0</td>
    </tr>
    <tr>
      <th>251041</th>
      <td>131803</td>
      <td>107381</td>
      <td>1.000000</td>
      <td>251041</td>
      <td>0</td>
    </tr>
    <tr>
      <th>265003</th>
      <td>140179</td>
      <td>30433</td>
      <td>1.000000</td>
      <td>265003</td>
      <td>0</td>
    </tr>
    <tr>
      <th>265014</th>
      <td>140179</td>
      <td>21064</td>
      <td>1.000000</td>
      <td>265014</td>
      <td>0</td>
    </tr>
    <tr>
      <th>265031</th>
      <td>140179</td>
      <td>16373</td>
      <td>1.000000</td>
      <td>265031</td>
      <td>0</td>
    </tr>
    <tr>
      <th>425049</th>
      <td>223763</td>
      <td>77169</td>
      <td>1.000000</td>
      <td>425049</td>
      <td>0</td>
    </tr>
    <tr>
      <th>425052</th>
      <td>223763</td>
      <td>12948</td>
      <td>1.000000</td>
      <td>425052</td>
      <td>0</td>
    </tr>
    <tr>
      <th>425074</th>
      <td>223763</td>
      <td>109280</td>
      <td>1.000000</td>
      <td>425074</td>
      <td>0</td>
    </tr>
    <tr>
      <th>604542</th>
      <td>316074</td>
      <td>7107</td>
      <td>1.000000</td>
      <td>604542</td>
      <td>0</td>
    </tr>
    <tr>
      <th>604554</th>
      <td>316074</td>
      <td>11829</td>
      <td>1.000000</td>
      <td>604554</td>
      <td>0</td>
    </tr>
    <tr>
      <th>604556</th>
      <td>316074</td>
      <td>73997</td>
      <td>1.000000</td>
      <td>604556</td>
      <td>0</td>
    </tr>
    <tr>
      <th>806662</th>
      <td>419536</td>
      <td>12854</td>
      <td>1.000000</td>
      <td>806662</td>
      <td>0</td>
    </tr>
    <tr>
      <th>806668</th>
      <td>419536</td>
      <td>13076</td>
      <td>1.000000</td>
      <td>806668</td>
      <td>0</td>
    </tr>
    <tr>
      <th>806742</th>
      <td>419536</td>
      <td>9204</td>
      <td>1.000000</td>
      <td>806742</td>
      <td>0</td>
    </tr>
    <tr>
      <th>923002</th>
      <td>482854</td>
      <td>34763</td>
      <td>1.000000</td>
      <td>923002</td>
      <td>0</td>
    </tr>
    <tr>
      <th>923018</th>
      <td>482854</td>
      <td>11361</td>
      <td>1.000000</td>
      <td>923018</td>
      <td>0</td>
    </tr>
    <tr>
      <th>923061</th>
      <td>482854</td>
      <td>12965</td>
      <td>1.000000</td>
      <td>923061</td>
      <td>0</td>
    </tr>
    <tr>
      <th>927151</th>
      <td>484834</td>
      <td>30217</td>
      <td>0.707107</td>
      <td>927151</td>
      <td>0</td>
    </tr>
    <tr>
      <th>927180</th>
      <td>484834</td>
      <td>12652</td>
      <td>0.500000</td>
      <td>927180</td>
      <td>0</td>
    </tr>
    <tr>
      <th>927201</th>
      <td>484834</td>
      <td>65037</td>
      <td>0.707107</td>
      <td>927201</td>
      <td>0</td>
    </tr>
    <tr>
      <th>931310</th>
      <td>487160</td>
      <td>7616</td>
      <td>0.707107</td>
      <td>931310</td>
      <td>0</td>
    </tr>
    <tr>
      <th>931343</th>
      <td>487160</td>
      <td>7107</td>
      <td>1.000000</td>
      <td>931343</td>
      <td>0</td>
    </tr>
    <tr>
      <th>931370</th>
      <td>487160</td>
      <td>21317</td>
      <td>1.000000</td>
      <td>931370</td>
      <td>0</td>
    </tr>
    <tr>
      <th>995170</th>
      <td>522481</td>
      <td>120210</td>
      <td>0.707107</td>
      <td>995170</td>
      <td>0</td>
    </tr>
    <tr>
      <th>995173</th>
      <td>522481</td>
      <td>33260</td>
      <td>1.000000</td>
      <td>995173</td>
      <td>0</td>
    </tr>
    <tr>
      <th>995183</th>
      <td>522481</td>
      <td>176089</td>
      <td>1.000000</td>
      <td>995183</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1176201</th>
      <td>616140</td>
      <td>40776</td>
      <td>0.133631</td>
      <td>1176201</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1176203</th>
      <td>616140</td>
      <td>35411</td>
      <td>0.133631</td>
      <td>1176203</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1176252</th>
      <td>616140</td>
      <td>75552</td>
      <td>0.267261</td>
      <td>1176252</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1193820</th>
      <td>626147</td>
      <td>118355</td>
      <td>0.707107</td>
      <td>1193820</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1193836</th>
      <td>626147</td>
      <td>245945</td>
      <td>0.707107</td>
      <td>1193836</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1193877</th>
      <td>626147</td>
      <td>2239</td>
      <td>1.000000</td>
      <td>1193877</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1494296</th>
      <td>779743</td>
      <td>73398</td>
      <td>0.353553</td>
      <td>1494296</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1494302</th>
      <td>779743</td>
      <td>2209</td>
      <td>0.500000</td>
      <td>1494302</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1494338</th>
      <td>779743</td>
      <td>88020</td>
      <td>0.500000</td>
      <td>1494338</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1650910</th>
      <td>860928</td>
      <td>22021</td>
      <td>0.577350</td>
      <td>1650910</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1650945</th>
      <td>860928</td>
      <td>43326</td>
      <td>1.000000</td>
      <td>1650945</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1650951</th>
      <td>860928</td>
      <td>38736</td>
      <td>0.577350</td>
      <td>1650951</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1784731</th>
      <td>928023</td>
      <td>11357</td>
      <td>0.447214</td>
      <td>1784731</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1784770</th>
      <td>928023</td>
      <td>220290</td>
      <td>1.000000</td>
      <td>1784770</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1784781</th>
      <td>928023</td>
      <td>30716</td>
      <td>0.324443</td>
      <td>1784781</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1822946</th>
      <td>947916</td>
      <td>8637</td>
      <td>1.000000</td>
      <td>1822946</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1822954</th>
      <td>947916</td>
      <td>226402</td>
      <td>0.707107</td>
      <td>1822954</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1822957</th>
      <td>947916</td>
      <td>21772</td>
      <td>0.707107</td>
      <td>1822957</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1983609</th>
      <td>1030860</td>
      <td>7223</td>
      <td>0.500000</td>
      <td>1983609</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1983645</th>
      <td>1030860</td>
      <td>110861</td>
      <td>0.707107</td>
      <td>1983645</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1983663</th>
      <td>1030860</td>
      <td>16007</td>
      <td>0.408248</td>
      <td>1983663</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2006811</th>
      <td>1043861</td>
      <td>108934</td>
      <td>0.707107</td>
      <td>2006811</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2006872</th>
      <td>1043861</td>
      <td>38242</td>
      <td>1.000000</td>
      <td>2006872</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2006889</th>
      <td>1043861</td>
      <td>57489</td>
      <td>1.000000</td>
      <td>2006889</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2101213</th>
      <td>1093253</td>
      <td>194512</td>
      <td>0.707107</td>
      <td>2101213</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2101240</th>
      <td>1093253</td>
      <td>150161</td>
      <td>0.707107</td>
      <td>2101240</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2101261</th>
      <td>1093253</td>
      <td>225008</td>
      <td>0.707107</td>
      <td>2101261</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-41398640-f9ca-4be4-8c6d-5342f5fa98fc')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-41398640-f9ca-4be4-8c6d-5342f5fa98fc button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-41398640-f9ca-4be4-8c6d-5342f5fa98fc');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">boost_idx_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">boost_idx</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">boost_train_users</span><span class="p">,</span> <span class="n">boost_eval_users</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">boost_idx_train</span><span class="p">,</span> 
                                                       <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                       <span class="n">random_state</span><span class="o">=</span><span class="mi">345</span><span class="p">)</span>
<span class="n">select_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;implicit_score&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="n">boost_train</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
               <span class="n">pos</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">boost_train_users</span><span class="p">)],</span>
               <span class="n">neg</span><span class="p">[</span><span class="n">neg</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">boost_train_users</span><span class="p">)]</span>
    <span class="p">])[</span><span class="n">select_col</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">boost_eval</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
               <span class="n">pos</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">boost_eval_users</span><span class="p">)],</span>
               <span class="n">neg</span><span class="p">[</span><span class="n">neg</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">boost_eval_users</span><span class="p">)]</span>
    <span class="p">])[</span><span class="n">select_col</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">user_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span><span class="s1">&#39;age&#39;</span><span class="p">,</span><span class="s1">&#39;income&#39;</span><span class="p">,</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span><span class="s1">&#39;kids_flg&#39;</span><span class="p">,</span><span class="s1">&#39;boost_user_watch_cnt_all&#39;</span><span class="p">,</span>
            <span class="s1">&#39;boost_user_watch_cnt_last_14&#39;</span><span class="p">]</span>

<span class="n">item_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span><span class="s1">&#39;content_type&#39;</span><span class="p">,</span><span class="s1">&#39;countries_max&#39;</span><span class="p">,</span><span class="s1">&#39;for_kids&#39;</span><span class="p">,</span><span class="s1">&#39;age_rating&#39;</span><span class="p">,</span>
            <span class="s1">&#39;studios_max&#39;</span><span class="p">,</span><span class="s1">&#39;genres_max&#39;</span><span class="p">,</span><span class="s1">&#39;genres_min&#39;</span><span class="p">,</span><span class="s1">&#39;genres_med&#39;</span><span class="p">,</span><span class="s1">&#39;release_novelty&#39;</span><span class="p">]</span>

<span class="n">item_stats_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span><span class="s1">&#39;watched_in_7_days&#39;</span><span class="p">,</span><span class="s1">&#39;watch_ts_std&#39;</span><span class="p">,</span><span class="s1">&#39;trend_slope&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;watch_ts_quantile_95_diff&#39;</span><span class="p">,</span><span class="s1">&#39;watch_ts_median_diff&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;watched_in_all_time&#39;</span><span class="p">,</span><span class="s1">&#39;male_watchers_fraction&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;female_watchers_fraction&#39;</span><span class="p">,</span><span class="s1">&#39;younger_35_fraction&#39;</span><span class="p">,</span><span class="s1">&#39;older_35_fraction&#39;</span><span class="p">]</span>
                  
<span class="n">cat_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span><span class="s1">&#39;income&#39;</span><span class="p">,</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span><span class="s1">&#39;content_type&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">train_feat</span> <span class="o">=</span> <span class="n">boost_train</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">users_df</span><span class="p">[</span><span class="n">user_col</span><span class="p">],</span>
                               <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                               <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>\
                               <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">items_df</span><span class="p">[</span><span class="n">item_col</span><span class="p">],</span>
                                      <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">],</span>
                                      <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                               
<span class="n">eval_feat</span> <span class="o">=</span> <span class="n">boost_eval</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">users_df</span><span class="p">[</span><span class="n">user_col</span><span class="p">],</span>
                             <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                             <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> \
                               <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">items_df</span><span class="p">[</span><span class="n">item_col</span><span class="p">],</span>
                                      <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">],</span>
                                      <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                               
<span class="n">eval_feat</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-cddd1f74-24e7-42f5-a9ed-36c34d2380fe">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>implicit_score</th>
      <th>target</th>
      <th>age</th>
      <th>income</th>
      <th>sex</th>
      <th>kids_flg</th>
      <th>boost_user_watch_cnt_all</th>
      <th>boost_user_watch_cnt_last_14</th>
      <th>content_type</th>
      <th>countries_max</th>
      <th>for_kids</th>
      <th>age_rating</th>
      <th>studios_max</th>
      <th>genres_max</th>
      <th>genres_min</th>
      <th>genres_med</th>
      <th>release_novelty</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>316074</td>
      <td>7033</td>
      <td>1.000000</td>
      <td>1</td>
      <td>age_18_24</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>False</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>series</td>
      <td>4340.0</td>
      <td>False</td>
      <td>16.0</td>
      <td>14898.0</td>
      <td>3858.0</td>
      <td>2778.0</td>
      <td>3318.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>131803</td>
      <td>6113</td>
      <td>0.707107</td>
      <td>0</td>
      <td>age_35_44</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>film</td>
      <td>5065.0</td>
      <td>False</td>
      <td>12.0</td>
      <td>14898.0</td>
      <td>3503.0</td>
      <td>1820.0</td>
      <td>1877.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>316074</td>
      <td>11829</td>
      <td>1.000000</td>
      <td>0</td>
      <td>age_18_24</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>False</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>film</td>
      <td>5065.0</td>
      <td>False</td>
      <td>18.0</td>
      <td>14898.0</td>
      <td>1820.0</td>
      <td>1033.0</td>
      <td>1426.5</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>131803</td>
      <td>207587</td>
      <td>0.577350</td>
      <td>0</td>
      <td>age_35_44</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>316074</td>
      <td>7107</td>
      <td>1.000000</td>
      <td>0</td>
      <td>age_18_24</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>False</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>series</td>
      <td>4340.0</td>
      <td>False</td>
      <td>12.0</td>
      <td>14898.0</td>
      <td>5431.0</td>
      <td>626.0</td>
      <td>1877.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>131803</td>
      <td>7807</td>
      <td>0.707107</td>
      <td>1</td>
      <td>age_35_44</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>film</td>
      <td>4340.0</td>
      <td>False</td>
      <td>16.0</td>
      <td>14898.0</td>
      <td>3858.0</td>
      <td>3858.0</td>
      <td>3858.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>316074</td>
      <td>73997</td>
      <td>1.000000</td>
      <td>0</td>
      <td>age_18_24</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>False</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>131803</td>
      <td>107381</td>
      <td>1.000000</td>
      <td>0</td>
      <td>age_35_44</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-cddd1f74-24e7-42f5-a9ed-36c34d2380fe')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-cddd1f74-24e7-42f5-a9ed-36c34d2380fe button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-cddd1f74-24e7-42f5-a9ed-36c34d2380fe');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">item_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">processed_dir</span><span class="p">,</span> <span class="s1">&#39;item_stats.csv&#39;</span><span class="p">))</span>
<span class="n">item_stats</span> <span class="o">=</span> <span class="n">item_stats</span><span class="p">[</span><span class="n">item_stats_col</span><span class="p">]</span>
<span class="n">train_feat</span> <span class="o">=</span> <span class="n">train_feat</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item_stats</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">),</span> 
                             <span class="n">on</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">eval_feat</span> <span class="o">=</span> <span class="n">eval_feat</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item_stats</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">),</span> 
                           <span class="n">on</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">drop_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span>
<span class="n">target_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">train_feat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_col</span> <span class="o">+</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_feat</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>
<span class="n">X_val</span> <span class="o">=</span> <span class="n">eval_feat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_col</span> <span class="o">+</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_val</span> <span class="o">=</span> <span class="n">eval_feat</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>
<span class="n">X_train</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_val</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">[</span><span class="n">cat_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">cat_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">X_val</span><span class="p">[</span><span class="n">cat_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_val</span><span class="p">[</span><span class="n">cat_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

<span class="n">X_train</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-1bc0bcc5-28fc-4ddd-b561-4b12896c4706">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>implicit_score</th>
      <th>age</th>
      <th>income</th>
      <th>sex</th>
      <th>kids_flg</th>
      <th>boost_user_watch_cnt_all</th>
      <th>boost_user_watch_cnt_last_14</th>
      <th>content_type</th>
      <th>countries_max</th>
      <th>for_kids</th>
      <th>age_rating</th>
      <th>studios_max</th>
      <th>genres_max</th>
      <th>genres_min</th>
      <th>genres_med</th>
      <th>release_novelty</th>
      <th>watched_in_7_days</th>
      <th>watch_ts_std</th>
      <th>trend_slope</th>
      <th>watch_ts_quantile_95_diff</th>
      <th>watch_ts_median_diff</th>
      <th>watched_in_all_time</th>
      <th>male_watchers_fraction</th>
      <th>female_watchers_fraction</th>
      <th>younger_35_fraction</th>
      <th>older_35_fraction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.000000</td>
      <td>age_35_44</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>film</td>
      <td>5065</td>
      <td>False</td>
      <td>16</td>
      <td>14898</td>
      <td>2418</td>
      <td>1820</td>
      <td>2119</td>
      <td>3</td>
      <td>46</td>
      <td>0.787585</td>
      <td>0.195783</td>
      <td>0</td>
      <td>1</td>
      <td>46</td>
      <td>0.422222</td>
      <td>0.355556</td>
      <td>0.311111</td>
      <td>0.466667</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.000000</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>1</td>
      <td>1</td>
      <td>series</td>
      <td>4340</td>
      <td>False</td>
      <td>12</td>
      <td>14898</td>
      <td>1339</td>
      <td>1339</td>
      <td>1339</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.500000</td>
      <td>age_18_24</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>film</td>
      <td>5065</td>
      <td>False</td>
      <td>18</td>
      <td>14898</td>
      <td>5431</td>
      <td>1224</td>
      <td>2418</td>
      <td>5</td>
      <td>5</td>
      <td>46.3813</td>
      <td>-0.0692771</td>
      <td>5</td>
      <td>74</td>
      <td>89</td>
      <td>0.431818</td>
      <td>0.409091</td>
      <td>0.420455</td>
      <td>0.420455</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.000000</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.707107</td>
      <td>age_18_24</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>3</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>67</th>
      <td>0.707107</td>
      <td>age_35_44</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>68</th>
      <td>0.447214</td>
      <td>age_18_24</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>film</td>
      <td>295</td>
      <td>False</td>
      <td>18</td>
      <td>14898</td>
      <td>3858</td>
      <td>31</td>
      <td>3140.5</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>69</th>
      <td>0.500000</td>
      <td>age_25_34</td>
      <td>income_40_60</td>
      <td>M</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>film</td>
      <td>1272</td>
      <td>False</td>
      <td>18</td>
      <td>14898</td>
      <td>5431</td>
      <td>254</td>
      <td>3503</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>68</td>
      <td>68</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>70</th>
      <td>1.000000</td>
      <td>age_45_54</td>
      <td>income_40_60</td>
      <td>M</td>
      <td>True</td>
      <td>2</td>
      <td>0</td>
      <td>film</td>
      <td>5065</td>
      <td>False</td>
      <td>16</td>
      <td>14898</td>
      <td>3858</td>
      <td>2778</td>
      <td>3503</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71</th>
      <td>0.707107</td>
      <td>age_65_inf</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>False</td>
      <td>5</td>
      <td>5</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
<p>72 rows × 26 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-1bc0bcc5-28fc-4ddd-b561-4b12896c4706')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-1bc0bcc5-28fc-4ddd-b561-4b12896c4706 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-1bc0bcc5-28fc-4ddd-b561-4b12896c4706');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.97</span><span class="p">,</span> 
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> 
    <span class="s1">&#39;scale_pos_weight&#39;</span><span class="p">:</span> <span class="n">num_negatives</span><span class="p">,</span> 
    <span class="s1">&#39;l2_leaf_reg&#39;</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span> 
    <span class="s1">&#39;thread_count&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s2">&quot;CPU&quot;</span><span class="p">,</span>
    <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="s1">&#39;0:1&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;bootstrap_type&#39;: &#39;Poisson&#39;</span>
<span class="p">}</span>
<span class="n">boost_model</span> <span class="o">=</span> <span class="n">CatBoostClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
<span class="n">boost_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span>
                <span class="n">y_train</span><span class="p">,</span>
                <span class="n">eval_set</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
                <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                <span class="n">cat_features</span><span class="o">=</span><span class="n">cat_col</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0:	learn: 0.6814278	test: 0.6853672	best: 0.6853672 (0)	total: 57.5ms	remaining: 1m 54s
200:	learn: 0.1793975	test: 0.5471784	best: 0.5422113 (146)	total: 1.19s	remaining: 10.7s
Stopped by overfitting detector  (200 iterations wait)

bestTest = 0.5422113159
bestIteration = 146

Shrink model to first 147 iterations.
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;catboost.core.CatBoostClassifier at 0x7f157243ac90&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;catboost_trained.pkl&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">boost_model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="c1">#     boost_model = pickle.load(f)</span>
<span class="n">boost_model</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;catboost.core.CatBoostClassifier at 0x7f157243ac90&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">random_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">cold_items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">]</span>
<span class="n">random_items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cold_items</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">warm_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">random_items</span><span class="p">,</span> <span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">warm_idx</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([ 20000, 133452, 332832, 341075, 622570, 728808])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">_candidates</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">_candidates</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">submit_feat</span> <span class="o">=</span> <span class="n">_candidates</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">users_df</span><span class="p">[</span><span class="n">user_col</span><span class="p">],</span>
                               <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                               <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">items_df</span><span class="p">[</span><span class="n">item_col</span><span class="p">],</span>
           <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">],</span>
           <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">submit_feat</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-35b42475-9190-46c5-860b-c77115415f77">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>implicit_score</th>
      <th>id</th>
      <th>age</th>
      <th>income</th>
      <th>sex</th>
      <th>kids_flg</th>
      <th>boost_user_watch_cnt_all</th>
      <th>boost_user_watch_cnt_last_14</th>
      <th>content_type</th>
      <th>countries_max</th>
      <th>for_kids</th>
      <th>age_rating</th>
      <th>studios_max</th>
      <th>genres_max</th>
      <th>genres_min</th>
      <th>genres_med</th>
      <th>release_novelty</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>199262</td>
      <td>0.707107</td>
      <td>0</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>30</td>
      <td>203105</td>
      <td>0.707107</td>
      <td>1</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30</td>
      <td>199886</td>
      <td>0.707107</td>
      <td>2</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30</td>
      <td>219904</td>
      <td>0.707107</td>
      <td>3</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>30</td>
      <td>203206</td>
      <td>0.707107</td>
      <td>4</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2109148</th>
      <td>1097544</td>
      <td>263721</td>
      <td>0.577350</td>
      <td>2109148</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109149</th>
      <td>1097544</td>
      <td>227113</td>
      <td>0.577350</td>
      <td>2109149</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109150</th>
      <td>1097544</td>
      <td>239830</td>
      <td>0.577350</td>
      <td>2109150</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109151</th>
      <td>1097544</td>
      <td>139002</td>
      <td>0.577350</td>
      <td>2109151</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109152</th>
      <td>1097544</td>
      <td>243127</td>
      <td>0.577350</td>
      <td>2109152</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>2109153 rows × 19 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-35b42475-9190-46c5-860b-c77115415f77')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-35b42475-9190-46c5-860b-c77115415f77 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-35b42475-9190-46c5-860b-c77115415f77');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">full_train</span> <span class="o">=</span> <span class="n">submit_feat</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
<span class="n">full_train</span><span class="p">[</span><span class="n">cat_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_train</span><span class="p">[</span><span class="n">cat_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="c1"># item_stats = pd.read_csv(&#39;data/item_stats_for_submit.csv&#39;)</span>
<span class="n">full_train</span> <span class="o">=</span> <span class="n">full_train</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item_stats</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">),</span>
                             <span class="n">on</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">full_train</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-fe4a4367-2a35-4be6-af46-c6f5c7cde5b0">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>implicit_score</th>
      <th>id</th>
      <th>age</th>
      <th>income</th>
      <th>sex</th>
      <th>kids_flg</th>
      <th>boost_user_watch_cnt_all</th>
      <th>boost_user_watch_cnt_last_14</th>
      <th>content_type</th>
      <th>countries_max</th>
      <th>for_kids</th>
      <th>age_rating</th>
      <th>studios_max</th>
      <th>genres_max</th>
      <th>genres_min</th>
      <th>genres_med</th>
      <th>release_novelty</th>
      <th>watched_in_7_days</th>
      <th>watch_ts_std</th>
      <th>trend_slope</th>
      <th>watch_ts_quantile_95_diff</th>
      <th>watch_ts_median_diff</th>
      <th>watched_in_all_time</th>
      <th>male_watchers_fraction</th>
      <th>female_watchers_fraction</th>
      <th>younger_35_fraction</th>
      <th>older_35_fraction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>199262</td>
      <td>0.707107</td>
      <td>0</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>30</td>
      <td>203105</td>
      <td>0.707107</td>
      <td>1</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30</td>
      <td>199886</td>
      <td>0.707107</td>
      <td>2</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30</td>
      <td>219904</td>
      <td>0.707107</td>
      <td>3</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>30</td>
      <td>203206</td>
      <td>0.707107</td>
      <td>4</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2109148</th>
      <td>1097544</td>
      <td>263721</td>
      <td>0.57735</td>
      <td>2109148</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109149</th>
      <td>1097544</td>
      <td>227113</td>
      <td>0.57735</td>
      <td>2109149</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109150</th>
      <td>1097544</td>
      <td>239830</td>
      <td>0.57735</td>
      <td>2109150</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109151</th>
      <td>1097544</td>
      <td>139002</td>
      <td>0.57735</td>
      <td>2109151</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109152</th>
      <td>1097544</td>
      <td>243127</td>
      <td>0.57735</td>
      <td>2109152</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>2109153 rows × 29 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-fe4a4367-2a35-4be6-af46-c6f5c7cde5b0')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-fe4a4367-2a35-4be6-af46-c6f5c7cde5b0 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-fe4a4367-2a35-4be6-af46-c6f5c7cde5b0');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">cols</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;user_id&#39;,
 &#39;item_id&#39;,
 &#39;implicit_score&#39;,
 &#39;age&#39;,
 &#39;income&#39;,
 &#39;sex&#39;,
 &#39;kids_flg&#39;,
 &#39;user_watch_cnt_all&#39;,
 &#39;user_watch_cnt_last_14&#39;,
 &#39;content_type&#39;,
 &#39;countries_max&#39;,
 &#39;for_kids&#39;,
 &#39;age_rating&#39;,
 &#39;studios_max&#39;,
 &#39;genres_max&#39;,
 &#39;genres_min&#39;,
 &#39;genres_med&#39;,
 &#39;release_novelty&#39;,
 &#39;watched_in_7_days&#39;,
 &#39;watch_ts_std&#39;,
 &#39;trend_slope&#39;,
 &#39;watch_ts_quantile_95_diff&#39;,
 &#39;watch_ts_median_diff&#39;,
 &#39;watched_in_all_time&#39;,
 &#39;male_watchers_fraction&#39;,
 &#39;female_watchers_fraction&#39;,
 &#39;younger_35_fraction&#39;,
 &#39;older_35_fraction&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span>
<span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">boost_model</span><span class="o">.</span><span class="n">feature_names_</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;boost_user_watch_cnt_all&#39;</span><span class="p">,</span> <span class="s1">&#39;boost_user_watch_cnt_last_14&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
<span class="n">full_train</span> <span class="o">=</span> <span class="n">full_train</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">full_train_new_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">boost_model</span><span class="o">.</span><span class="n">feature_names_</span>
<span class="n">full_train</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">full_train_new_names</span>
<span class="n">full_train</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-f467ec66-0ad1-4690-b086-b821de405671">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>implicit_score</th>
      <th>age</th>
      <th>income</th>
      <th>sex</th>
      <th>kids_flg</th>
      <th>boost_user_watch_cnt_all</th>
      <th>boost_user_watch_cnt_last_14</th>
      <th>content_type</th>
      <th>countries_max</th>
      <th>for_kids</th>
      <th>age_rating</th>
      <th>studios_max</th>
      <th>genres_max</th>
      <th>genres_min</th>
      <th>genres_med</th>
      <th>release_novelty</th>
      <th>watched_in_7_days</th>
      <th>watch_ts_std</th>
      <th>trend_slope</th>
      <th>watch_ts_quantile_95_diff</th>
      <th>watch_ts_median_diff</th>
      <th>watched_in_all_time</th>
      <th>male_watchers_fraction</th>
      <th>female_watchers_fraction</th>
      <th>younger_35_fraction</th>
      <th>older_35_fraction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>199262</td>
      <td>0.707107</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>30</td>
      <td>203105</td>
      <td>0.707107</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30</td>
      <td>199886</td>
      <td>0.707107</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30</td>
      <td>219904</td>
      <td>0.707107</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>30</td>
      <td>203206</td>
      <td>0.707107</td>
      <td>age_unknown</td>
      <td>income_unknown</td>
      <td>sex_unknown</td>
      <td>False</td>
      <td>2</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2109148</th>
      <td>1097544</td>
      <td>263721</td>
      <td>0.57735</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109149</th>
      <td>1097544</td>
      <td>227113</td>
      <td>0.57735</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109150</th>
      <td>1097544</td>
      <td>239830</td>
      <td>0.57735</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109151</th>
      <td>1097544</td>
      <td>139002</td>
      <td>0.57735</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2109152</th>
      <td>1097544</td>
      <td>243127</td>
      <td>0.57735</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>1</td>
      <td>1</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>2109153 rows × 28 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-f467ec66-0ad1-4690-b086-b821de405671')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-f467ec66-0ad1-4690-b086-b821de405671 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-f467ec66-0ad1-4690-b086-b821de405671');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">y_pred_all</span> <span class="o">=</span> <span class="n">boost_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">full_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">full_train</span><span class="p">[</span><span class="s1">&#39;boost_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred_all</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">full_train</span> <span class="o">=</span> <span class="n">full_train</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;boost_pred&#39;</span><span class="p">]]</span>
<span class="n">full_train</span> <span class="o">=</span> <span class="n">full_train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;boost_pred&#39;</span><span class="p">],</span>
                                    <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
<span class="n">full_train</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">full_train</span> <span class="o">=</span> <span class="n">full_train</span><span class="p">[</span><span class="n">full_train</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;boost_pred&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">full_train</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_train</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
<span class="n">boost_recs</span> <span class="o">=</span> <span class="n">full_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">boost_recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">boost_recs</span><span class="p">)</span>
<span class="n">boost_recs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">boost_recs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-81a34650-db94-4143-b82e-a331feadcdd0">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>[16986, 199262, 203105, 199886, 219904, 203206...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>55</td>
      <td>[12232, 7634, 6489, 15987, 14556, 5573, 15058,...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>106</td>
      <td>[8821, 10700, 10497, 3399, 9154, 3629, 12189, ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>144</td>
      <td>[79668, 85771, 79780, 100360, 87071, 80158, 14...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>155</td>
      <td>[10747, 2236, 67784, 78954, 139975, 137705, 22...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>22227</th>
      <td>1097444</td>
      <td>[7300, 16181, 110702, 114582, 113097, 86716, 1...</td>
    </tr>
    <tr>
      <th>22228</th>
      <td>1097459</td>
      <td>[68578, 71663, 68642, 74552, 71682, 68811, 777...</td>
    </tr>
    <tr>
      <th>22229</th>
      <td>1097470</td>
      <td>[196242, 201115, 196364, 201461, 203105, 19904...</td>
    </tr>
    <tr>
      <th>22230</th>
      <td>1097508</td>
      <td>[207809, 210545, 208388, 212164, 213627, 21296...</td>
    </tr>
    <tr>
      <th>22231</th>
      <td>1097544</td>
      <td>[71485, 75317, 72714, 94880, 75852, 72851, 112...</td>
    </tr>
  </tbody>
</table>
<p>22232 rows × 2 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-81a34650-db94-4143-b82e-a331feadcdd0')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-81a34650-db94-4143-b82e-a331feadcdd0 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-81a34650-db94-4143-b82e-a331feadcdd0');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">idx_for_popular</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">random_items</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">boost_recs</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
<span class="n">idx_for_popular</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[20000, 728808, 622570, 133452, 10000, 341075]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">interactions_df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-57cada63-c5f5-4d40-b5fa-7abe37b514c1">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>last_watch_dt</th>
      <th>total_dur</th>
      <th>watched_pct</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>917575</td>
      <td>10353</td>
      <td>2021-03-13</td>
      <td>11131</td>
      <td>58</td>
    </tr>
    <tr>
      <th>1060</th>
      <td>275080</td>
      <td>15574</td>
      <td>2021-03-13</td>
      <td>670</td>
      <td>11</td>
    </tr>
    <tr>
      <th>1059</th>
      <td>120517</td>
      <td>9550</td>
      <td>2021-03-13</td>
      <td>32456</td>
      <td>100</td>
    </tr>
    <tr>
      <th>1058</th>
      <td>15045</td>
      <td>6115</td>
      <td>2021-03-13</td>
      <td>22830</td>
      <td>100</td>
    </tr>
    <tr>
      <th>1057</th>
      <td>92904</td>
      <td>10135</td>
      <td>2021-03-13</td>
      <td>3709</td>
      <td>71</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>542914</th>
      <td>484870</td>
      <td>9157</td>
      <td>2021-08-22</td>
      <td>9435</td>
      <td>6</td>
    </tr>
    <tr>
      <th>542913</th>
      <td>8428</td>
      <td>5732</td>
      <td>2021-08-22</td>
      <td>6570</td>
      <td>100</td>
    </tr>
    <tr>
      <th>542912</th>
      <td>818134</td>
      <td>11505</td>
      <td>2021-08-22</td>
      <td>60</td>
      <td>0</td>
    </tr>
    <tr>
      <th>542923</th>
      <td>314358</td>
      <td>14111</td>
      <td>2021-08-22</td>
      <td>2590</td>
      <td>35</td>
    </tr>
    <tr>
      <th>547624</th>
      <td>755517</td>
      <td>5693</td>
      <td>2021-08-22</td>
      <td>6174</td>
      <td>88</td>
    </tr>
  </tbody>
</table>
<p>547625 rows × 5 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-57cada63-c5f5-4d40-b5fa-7abe37b514c1')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-57cada63-c5f5-4d40-b5fa-7abe37b514c1 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-57cada63-c5f5-4d40-b5fa-7abe37b514c1');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">pop_model</span> <span class="o">=</span> <span class="n">PopularRecommender</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">dt_column</span><span class="o">=</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">,</span>
                               <span class="n">with_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pop_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">recs_popular</span> <span class="o">=</span> <span class="n">pop_model</span><span class="o">.</span><span class="n">recommend_with_filter</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">,</span> <span class="n">idx_for_popular</span><span class="p">,</span> <span class="n">top_K</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">recs_popular</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-a35ca8ba-75a0-4725-8b16-dd6d20461792">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>10000</td>
      <td>[10440, 9728, 15297, 13865, 3734, 12192, 4151,...</td>
    </tr>
    <tr>
      <th>0</th>
      <td>20000</td>
      <td>[10440, 9728, 15297, 13865, 3734, 12192, 4151,...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>728808</td>
      <td>[10440, 9728, 15297, 13865, 12192, 4151, 11863...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>622570</td>
      <td>[10440, 9728, 15297, 13865, 12192, 4151, 11863...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>133452</td>
      <td>[10440, 9728, 15297, 13865, 3734, 12192, 4151,...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>341075</td>
      <td>[10440, 9728, 15297, 13865, 3734, 12192, 4151,...</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-a35ca8ba-75a0-4725-8b16-dd6d20461792')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-a35ca8ba-75a0-4725-8b16-dd6d20461792 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-a35ca8ba-75a0-4725-8b16-dd6d20461792');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">all_recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">boost_recs</span><span class="p">,</span> <span class="n">recs_popular</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">fill_with_popular</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span> <span class="n">pop_model_fitted</span><span class="p">,</span> <span class="n">interactions_df</span><span class="p">,</span> <span class="n">top_K</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fills missing recommendations with Popular Recommender.</span>
<span class="sd">    Takes top_K first recommendations if length of recs exceeds top_K</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">recs_good</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="n">recs</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">top_K</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">recs_good</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">recs_good</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">top_K</span><span class="p">),</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs_good</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">recs_good</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">recs_bad</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="n">recs</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">top_K</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">recs_bad</span><span class="p">[</span><span class="s1">&#39;num_popular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_K</span> <span class="o">-</span> <span class="n">recs_bad</span><span class="o">.</span><span class="n">len</span>
    <span class="n">idx_for_filling</span> <span class="o">=</span> <span class="n">recs_bad</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">filling_recs</span> <span class="o">=</span> <span class="n">pop_model_fitted</span><span class="o">.</span><span class="n">recommend_with_filter</span><span class="p">(</span>
        <span class="n">interactions_df</span><span class="p">,</span> <span class="n">idx_for_filling</span><span class="p">,</span> <span class="n">top_K</span><span class="o">=</span><span class="n">top_K</span><span class="p">)</span>
    <span class="n">recs_bad</span> <span class="o">=</span> <span class="n">recs_bad</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filling_recs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span>
                             <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">recs_bad</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">recs_bad</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">recs_bad</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">recs_bad</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">+</span> \
        <span class="n">recs_bad</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">recs_bad</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;item_id1&#39;</span><span class="p">]</span>
    <span class="n">recs_bad</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">recs_bad</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs_bad</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">recs_bad</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;item_id1&#39;</span><span class="p">]</span>
    <span class="n">recs_bad</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs_bad</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="n">top_K</span><span class="p">])</span>
    <span class="n">total_recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">recs_good</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]],</span>
                            <span class="n">recs_bad</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total_recs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">all_recs</span> <span class="o">=</span> <span class="n">fill_with_popular</span><span class="p">(</span><span class="n">all_recs</span><span class="p">,</span> <span class="n">pop_model</span><span class="p">,</span> <span class="n">interactions_df</span><span class="p">)</span>
<span class="n">all_recs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-ac794ca1-5724-421a-971d-198102c68254">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>[16986, 199262, 203105, 199886, 219904, 203206...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>55</td>
      <td>[12232, 7634, 6489, 15987, 14556, 5573, 15058,...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>106</td>
      <td>[8821, 10700, 10497, 3399, 9154, 3629, 12189, ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>144</td>
      <td>[79668, 85771, 79780, 100360, 87071, 80158, 14...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>155</td>
      <td>[10747, 2236, 67784, 78954, 139975, 137705, 22...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>22054</th>
      <td>1087746</td>
      <td>[366, 4784, 33316, 63977, 10440, 9728, 15297, ...</td>
    </tr>
    <tr>
      <th>22137</th>
      <td>1092833</td>
      <td>[15355, 198132, 191636, 50599, 177761, 10440, ...</td>
    </tr>
    <tr>
      <th>22159</th>
      <td>1093784</td>
      <td>[296, 124311, 20002, 219743, 10440, 9728, 1529...</td>
    </tr>
    <tr>
      <th>22160</th>
      <td>1093836</td>
      <td>[1343, 11710, 3254, 1967, 3356, 5292, 70331, 2...</td>
    </tr>
    <tr>
      <th>22171</th>
      <td>1094683</td>
      <td>[15355, 198132, 191636, 50599, 177761, 10440, ...</td>
    </tr>
  </tbody>
</table>
<p>22238 rows × 2 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-ac794ca1-5724-421a-971d-198102c68254')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-ac794ca1-5724-421a-971d-198102c68254 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-ac794ca1-5724-421a-971d-198102c68254');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Baseline">Baseline<a class="anchor-link" href="#Baseline"> </a></h2><p>Popularity based model</p>
<p>Ref: <a href="https://github.com/recohut/notebooks/blob/main/extras/mts_baseline.ipynb">Official baseline tutorial</a></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">calculate_novelty</span><span class="p">(</span><span class="n">train_interactions</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">,</span> <span class="n">top_n</span><span class="p">):</span> 
    <span class="n">users</span> <span class="o">=</span> <span class="n">recommendations</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">n_users</span> <span class="o">=</span> <span class="n">train_interactions</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">n_users_per_item</span> <span class="o">=</span> <span class="n">train_interactions</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">)[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

    <span class="n">recommendations</span> <span class="o">=</span> <span class="n">recommendations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">recommendations</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_n</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">recommendations</span><span class="p">[</span><span class="s1">&#39;n_users_per_item&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommendations</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">n_users_per_item</span><span class="p">)</span>
    <span class="n">recommendations</span><span class="p">[</span><span class="s1">&#39;n_users_per_item&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommendations</span><span class="p">[</span><span class="s1">&#39;n_users_per_item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">recommendations</span><span class="p">[</span><span class="s1">&#39;item_novelty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">recommendations</span><span class="p">[</span><span class="s1">&#39;n_users_per_item&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_users</span><span class="p">)</span>

    <span class="n">item_novelties</span> <span class="o">=</span> <span class="n">recommendations</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;item_novelty&#39;</span><span class="p">]]</span>
    
    <span class="n">miuf_at_k</span> <span class="o">=</span> <span class="n">item_novelties</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">item_novelties</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_n</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_novelty&#39;</span><span class="p">]]</span>
    <span class="n">miuf_at_k</span> <span class="o">=</span> <span class="n">miuf_at_k</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">miuf_at_k</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">top_N</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">test_recs</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recs</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]))</span>
    <span class="n">test_recs</span> <span class="o">=</span> <span class="n">test_recs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">])</span>

    <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;users_item_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_recs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">)[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;reciprocal_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;cumulative_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_recs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;cumulative_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;cumulative_rank&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
    
    <span class="n">users_count</span> <span class="o">=</span> <span class="n">test_recs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">top_N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">hit_k</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;hit@</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">test_recs</span><span class="p">[</span><span class="n">hit_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">k</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Precision@</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_recs</span><span class="p">[</span><span class="n">hit_k</span><span class="p">]</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">users_count</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Recall@</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_recs</span><span class="p">[</span><span class="n">hit_k</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;users_item_count&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">users_count</span>
        
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MAP@</span><span class="si">{</span><span class="n">top_N</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;cumulative_rank&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_recs</span><span class="p">[</span><span class="s1">&#39;users_item_count&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">users_count</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Novelty@</span><span class="si">{</span><span class="n">top_N</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_novelty</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">top_N</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-on-one-fold">Example on one fold<a class="anchor-link" href="#Example-on-one-fold"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">pop_model</span> <span class="o">=</span> <span class="n">PopularRecommender</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">dt_column</span><span class="o">=</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">)</span>
<span class="n">pop_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">top10_recs</span> <span class="o">=</span> <span class="n">pop_model</span><span class="o">.</span><span class="n">recommend</span><span class="p">()</span>
<span class="n">top10_recs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([ 9728, 15297, 10440, 13865, 12360, 14488, 12192,   512,   341,
        3734])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">item_titles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">items_df</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">items_df</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">item_titles</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">top10_recs</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;гнев человеческий&#39;,
 &#39;клиника счастья&#39;,
 &#39;хрустальный&#39;,
 &#39;девятаев&#39;,
 &#39;круэлла&#39;,
 &#39;мастер меча&#39;,
 &#39;фемида видит&#39;,
 &#39;рядовой чээрин&#39;,
 &#39;лето - это море&#39;,
 &#39;прабабушка легкого поведения&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()})</span>
<span class="n">top_N</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">recs</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_model</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">recs</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">N</span><span class="o">=</span><span class="n">top_N</span><span class="p">)</span>
<span class="n">recs</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-bf8ac65a-354b-406f-a98d-5962505f5a51">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>[9728, 15297, 10440, 13865, 12360, 14488, 1219...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>279776</td>
      <td>[9728, 15297, 10440, 13865, 12360, 14488, 1219...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>321739</td>
      <td>[9728, 15297, 10440, 13865, 12360, 14488, 1219...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>98693</td>
      <td>[9728, 15297, 10440, 13865, 12360, 14488, 1219...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>267998</td>
      <td>[9728, 15297, 10440, 13865, 12360, 14488, 1219...</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-bf8ac65a-354b-406f-a98d-5962505f5a51')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-bf8ac65a-354b-406f-a98d-5962505f5a51 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-bf8ac65a-354b-406f-a98d-5962505f5a51');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">recs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">recs</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_N</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-750315e1-28d0-49b8-9a4b-d06a95dc8abe">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>rank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>9728</td>
      <td>1</td>
    </tr>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>15297</td>
      <td>2</td>
    </tr>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>10440</td>
      <td>3</td>
    </tr>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>13865</td>
      <td>4</td>
    </tr>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>12360</td>
      <td>5</td>
    </tr>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>14488</td>
      <td>6</td>
    </tr>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>12192</td>
      <td>7</td>
    </tr>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>512</td>
      <td>8</td>
    </tr>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>341</td>
      <td>9</td>
    </tr>
    <tr>
      <th>0</th>
      <td>936370</td>
      <td>3734</td>
      <td>10</td>
    </tr>
    <tr>
      <th>1</th>
      <td>279776</td>
      <td>9728</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>279776</td>
      <td>15297</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-750315e1-28d0-49b8-9a4b-d06a95dc8abe')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-750315e1-28d0-49b8-9a4b-d06a95dc8abe button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-750315e1-28d0-49b8-9a4b-d06a95dc8abe');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">compute_metrics</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Precision@1     0.034862
Recall@1        0.033231
Precision@2     0.033945
Recall@2        0.065418
Precision@3     0.032875
Recall@3        0.095387
Precision@4     0.029128
Recall@4        0.112564
Precision@5     0.023425
Recall@5        0.113175
Precision@6     0.022273
Recall@6        0.128721
Precision@7     0.021669
Recall@7        0.145846
Precision@8     0.019897
Recall@8        0.152727
Precision@9     0.018926
Recall@9        0.163532
Precision@10    0.018211
Recall@10       0.174618
MAP@10          0.071974
Novelty@10      6.242784
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Folder-validation">Folder validation<a class="anchor-link" href="#Folder-validation"> </a></h3><p>Let's take the last 3 weeks from our data and test them sequentially (1 test fold - 1 week). Don't forget about the cold start problem.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">last_date</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
<span class="n">folds</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">last_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">folds</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
<span class="n">start_date</span><span class="p">,</span> <span class="n">last_date</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(Timestamp(&#39;2021-08-01 00:00:00&#39;), Timestamp(&#39;2021-08-22 00:00:00&#39;))</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">cv</span> <span class="o">=</span> <span class="n">TimeRangeSplit</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">folds</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">)</span>

<span class="n">cv</span><span class="o">.</span><span class="n">max_n_splits</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">get_n_splits</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">,</span> <span class="n">datetime_column</span><span class="o">=</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(3, 3)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">cv</span><span class="o">.</span><span class="n">date_range</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>DatetimeIndex([&#39;2021-08-01&#39;, &#39;2021-08-08&#39;, &#39;2021-08-15&#39;, &#39;2021-08-22&#39;], dtype=&#39;datetime64[ns]&#39;, freq=&#39;W-SUN&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">folds_with_stats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
    <span class="n">interactions_df</span><span class="p">,</span> 
    <span class="n">user_column</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
    <span class="n">item_column</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span>
    <span class="n">datetime_column</span><span class="o">=</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">,</span>
    <span class="n">fold_stats</span><span class="o">=</span><span class="kc">True</span>
<span class="p">))</span>

<span class="n">folds_info_with_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">info</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">folds_with_stats</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Already seen number: 0
Already seen number: 0
Already seen number: 0
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">folds_info_with_stats</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-ed1ea0bd-6d28-4823-b023-743f267d1336">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Start date</th>
      <th>End date</th>
      <th>Train</th>
      <th>New users</th>
      <th>New users interactions</th>
      <th>New items</th>
      <th>New items interactions</th>
      <th>Known interactions</th>
      <th>Test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2021-08-01</td>
      <td>2021-08-08</td>
      <td>420915</td>
      <td>19360</td>
      <td>22608</td>
      <td>166</td>
      <td>907</td>
      <td>0</td>
      <td>14717</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2021-08-08</td>
      <td>2021-08-15</td>
      <td>459147</td>
      <td>19615</td>
      <td>22955</td>
      <td>136</td>
      <td>609</td>
      <td>0</td>
      <td>15979</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2021-08-15</td>
      <td>2021-08-22</td>
      <td>498690</td>
      <td>20501</td>
      <td>24032</td>
      <td>99</td>
      <td>476</td>
      <td>0</td>
      <td>17371</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-ed1ea0bd-6d28-4823-b023-743f267d1336')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-ed1ea0bd-6d28-4823-b023-743f267d1336 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-ed1ea0bd-6d28-4823-b023-743f267d1336');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Popular-on-folds">Popular on folds<a class="anchor-link" href="#Popular-on-folds"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">top_N</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">last_n_days</span> <span class="o">=</span> <span class="mi">7</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">final_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">validation_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">folds_with_stats</span><span class="p">:</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
        
    <span class="n">pop_model</span> <span class="o">=</span> <span class="n">PopularRecommender</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">last_n_days</span><span class="p">,</span> <span class="n">dt_column</span><span class="o">=</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">)</span>
    <span class="n">pop_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

    <span class="n">recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()})</span>
    <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_model</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">recs</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">N</span><span class="o">=</span><span class="n">top_N</span><span class="p">)</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">)</span>
    <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">fold_result</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">top_N</span><span class="p">)</span>

    <span class="n">validation_results</span> <span class="o">=</span> <span class="n">validation_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold_result</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">validation_results</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;MAP@10&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Novelty@10&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>MAP@10        0.039814
Novelty@10    5.778481
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Popular-Prediction">Popular Prediction<a class="anchor-link" href="#Popular-Prediction"> </a></h3><p>Let's see if it makes sense to predict the popular depending on the social group</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">folds_with_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
<span class="n">date_window_for_popular</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">last_n_days</span><span class="p">)</span>
<span class="n">train_slice</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">date_window_for_popular</span><span class="p">],</span> <span class="n">users_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>we have users without features, so we need to define padding for them</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">train_slice</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-3d5d565c-cff3-4e66-b2ab-204c5b044228">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>last_watch_dt</th>
      <th>total_dur</th>
      <th>watched_pct</th>
      <th>age</th>
      <th>income</th>
      <th>sex</th>
      <th>kids_flg</th>
      <th>boost_user_watch_cnt_all</th>
      <th>boost_user_watch_cnt_last_14</th>
      <th>user_watch_cnt_all</th>
      <th>user_watch_cnt_last_14</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>689871</td>
      <td>6404</td>
      <td>2021-07-24</td>
      <td>905</td>
      <td>16</td>
      <td>age_45_54</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>482718</td>
      <td>2624</td>
      <td>2021-07-24</td>
      <td>1898</td>
      <td>25</td>
      <td>age_18_24</td>
      <td>income_40_60</td>
      <td>F</td>
      <td>False</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>183195</td>
      <td>11239</td>
      <td>2021-07-24</td>
      <td>1037</td>
      <td>14</td>
      <td>age_35_44</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1077534</td>
      <td>4457</td>
      <td>2021-07-24</td>
      <td>151</td>
      <td>2</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>274241</td>
      <td>16228</td>
      <td>2021-07-24</td>
      <td>19306</td>
      <td>18</td>
      <td>age_65_inf</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>False</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-3d5d565c-cff3-4e66-b2ab-204c5b044228')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-3d5d565c-cff3-4e66-b2ab-204c5b044228 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-3d5d565c-cff3-4e66-b2ab-204c5b044228');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">train_slice</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="s1">&#39;age_unknown&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;sex&#39;</span><span class="p">:</span><span class="s1">&#39;sex_unknown&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;income&#39;</span><span class="p">:</span> <span class="s1">&#39;income_unknown&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;kids_flg&#39;</span><span class="p">:</span> <span class="kc">False</span>
                   <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For example, you can watch popular by age, gender and presence of children</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">train_slice</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-d9127d46-8cd5-4284-b405-9fab46ae10cd">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>last_watch_dt</th>
      <th>total_dur</th>
      <th>watched_pct</th>
      <th>age</th>
      <th>income</th>
      <th>sex</th>
      <th>kids_flg</th>
      <th>boost_user_watch_cnt_all</th>
      <th>boost_user_watch_cnt_last_14</th>
      <th>user_watch_cnt_all</th>
      <th>user_watch_cnt_last_14</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>689871</td>
      <td>6404</td>
      <td>2021-07-24</td>
      <td>905</td>
      <td>16</td>
      <td>age_45_54</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>482718</td>
      <td>2624</td>
      <td>2021-07-24</td>
      <td>1898</td>
      <td>25</td>
      <td>age_18_24</td>
      <td>income_40_60</td>
      <td>F</td>
      <td>False</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>183195</td>
      <td>11239</td>
      <td>2021-07-24</td>
      <td>1037</td>
      <td>14</td>
      <td>age_35_44</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>True</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1077534</td>
      <td>4457</td>
      <td>2021-07-24</td>
      <td>151</td>
      <td>2</td>
      <td>age_25_34</td>
      <td>income_20_40</td>
      <td>M</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>274241</td>
      <td>16228</td>
      <td>2021-07-24</td>
      <td>19306</td>
      <td>18</td>
      <td>age_65_inf</td>
      <td>income_20_40</td>
      <td>F</td>
      <td>False</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-d9127d46-8cd5-4284-b405-9fab46ae10cd')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-d9127d46-8cd5-4284-b405-9fab46ae10cd button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-d9127d46-8cd5-4284-b405-9fab46ae10cd');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">soc_dem_recommendations</span> <span class="o">=</span> <span class="n">train_slice</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">soc_dem_recommendations</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-9694a1ef-ec84-41d8-93be-06eac493b01a">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>sex</th>
      <th>income</th>
      <th>item_id</th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>age_18_24</td>
      <td>F</td>
      <td>income_0_20</td>
      <td>14</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>age_18_24</td>
      <td>F</td>
      <td>income_0_20</td>
      <td>111</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>age_18_24</td>
      <td>F</td>
      <td>income_0_20</td>
      <td>162</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>age_18_24</td>
      <td>F</td>
      <td>income_0_20</td>
      <td>288</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>age_18_24</td>
      <td>F</td>
      <td>income_0_20</td>
      <td>334</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>18651</th>
      <td>age_unknown</td>
      <td>sex_unknown</td>
      <td>income_unknown</td>
      <td>16488</td>
      <td>1</td>
    </tr>
    <tr>
      <th>18652</th>
      <td>age_unknown</td>
      <td>sex_unknown</td>
      <td>income_unknown</td>
      <td>16498</td>
      <td>1</td>
    </tr>
    <tr>
      <th>18653</th>
      <td>age_unknown</td>
      <td>sex_unknown</td>
      <td>income_unknown</td>
      <td>16499</td>
      <td>3</td>
    </tr>
    <tr>
      <th>18654</th>
      <td>age_unknown</td>
      <td>sex_unknown</td>
      <td>income_unknown</td>
      <td>16509</td>
      <td>21</td>
    </tr>
    <tr>
      <th>18655</th>
      <td>age_unknown</td>
      <td>sex_unknown</td>
      <td>income_unknown</td>
      <td>16516</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>18656 rows × 5 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-9694a1ef-ec84-41d8-93be-06eac493b01a')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-9694a1ef-ec84-41d8-93be-06eac493b01a button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-9694a1ef-ec84-41d8-93be-06eac493b01a');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now you just need to select for each user the most popular top_n objects in his group</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can check this option on folds</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">validation_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">folds_with_stats</span><span class="p">:</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
    <span class="n">date_window</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">last_n_days</span><span class="p">)</span>
    <span class="n">train_slice</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">date_window</span><span class="p">],</span> <span class="n">users_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    
    <span class="n">train_slice</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span>
        <span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="s1">&#39;age_unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sex&#39;</span><span class="p">:</span><span class="s1">&#39;sex_unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;income&#39;</span><span class="p">:</span> <span class="s1">&#39;income_unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;kids_flg&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">soc_dem_recommendations</span> <span class="o">=</span> <span class="n">train_slice</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="n">top_soc_dem</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">soc_dem_recommendations</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">income</span> <span class="ow">in</span> <span class="n">soc_dem_recommendations</span><span class="o">.</span><span class="n">income</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sex</span> <span class="ow">in</span> <span class="n">soc_dem_recommendations</span><span class="o">.</span><span class="n">sex</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">top_items</span> <span class="o">=</span> <span class="n">soc_dem_recommendations</span><span class="p">[</span>
                <span class="p">(</span><span class="n">soc_dem_recommendations</span><span class="o">.</span><span class="n">age</span> <span class="o">==</span> <span class="n">age</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">soc_dem_recommendations</span><span class="o">.</span><span class="n">income</span> <span class="o">==</span> <span class="n">income</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">soc_dem_recommendations</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="n">sex</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">item_id</span><span class="o">.</span><span class="n">values</span>
                <span class="n">top_soc_dem</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">age</span><span class="p">,</span> <span class="n">income</span><span class="p">,</span> <span class="n">sex</span><span class="p">,</span> <span class="n">top_items</span><span class="p">])</span>

    <span class="n">top_soc_dem</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">top_soc_dem</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">])</span>
    
    <span class="n">recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()})</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">recs</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]],</span> <span class="n">users_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">recs</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span>
        <span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="s1">&#39;age_unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sex&#39;</span><span class="p">:</span><span class="s1">&#39;sex_unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;income&#39;</span><span class="p">:</span> <span class="s1">&#39;income_unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;kids_flg&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span> <span class="n">top_soc_dem</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">])</span>
    
    <span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">)</span>
    <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fold_result</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">top_N</span><span class="p">)</span>
    
    <span class="n">validation_results</span> <span class="o">=</span> <span class="n">validation_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold_result</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">validation_results</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;MAP@10&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Novelty@10&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>MAP@10        0.040677
Novelty@10    6.050588
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this case, the features by which you build the popular are selected, as well as the number of days that you take to calculate the popular</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Tfidf">Tfidf<a class="anchor-link" href="#Tfidf"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">users_inv_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="n">users_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">users_inv_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">items_inv_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="n">items_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items_inv_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">validation_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">folds_with_stats</span><span class="p">:</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>

    <span class="n">date_window</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">date_window</span><span class="p">]</span>

    <span class="n">test</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>

    <span class="n">train_mat</span> <span class="o">=</span> <span class="n">get_coo_matrix</span><span class="p">(</span>
        <span class="n">train</span><span class="p">,</span>
        <span class="n">users_mapping</span><span class="o">=</span><span class="n">users_mapping</span><span class="p">,</span>
        <span class="n">items_mapping</span><span class="o">=</span><span class="n">items_mapping</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">TFIDFRecommender</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="n">top_N</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_mat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 

    <span class="n">mapper</span> <span class="o">=</span> <span class="n">generate_implicit_recs_mapper</span><span class="p">(</span> 
        <span class="n">model</span><span class="p">,</span>
        <span class="n">train_mat</span><span class="p">,</span>
        <span class="n">top_N</span><span class="p">,</span>
        <span class="n">users_mapping</span><span class="p">,</span>
        <span class="n">items_inv_mapping</span><span class="p">,</span>
        <span class="n">filter_already_liked_items</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()})</span>
    <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">)</span>
    <span class="n">recs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fold_result</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">top_N</span><span class="p">)</span>

    <span class="n">validation_results</span> <span class="o">=</span> <span class="n">validation_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold_result</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">validation_results</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;MAP@10&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Novelty@10&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">,})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>MAP@10         0.698575
Novelty@10    17.440547
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Simply using the code above for submission won't work due to cold users. We'll have to figure out how to process them.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Predictions">Predictions<a class="anchor-link" href="#Predictions"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">random_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">interactions_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">cold_items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">]</span>
<span class="n">random_items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cold_items</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">random_items</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[754950, 758416, 83485, 636568, 669127, 10000, 20000]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">interactions_df</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">random_items</span>

<span class="n">pop_model</span> <span class="o">=</span> <span class="n">PopularRecommender</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">last_n_days</span><span class="p">,</span> <span class="n">dt_column</span><span class="o">=</span><span class="s1">&#39;last_watch_dt&#39;</span><span class="p">)</span>
<span class="n">pop_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="n">recs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()})</span>
<span class="n">recs</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_model</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">recs</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">N</span><span class="o">=</span><span class="n">top_N</span><span class="p">)</span>
<span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">)</span>
<span class="n">recs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;item_id&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">recs</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-c94e46b5-edc1-423d-a57e-d4343514d989">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10000</td>
      <td>[9728, 15297, 10440, 14488, 13865, 12192, 341,...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>20000</td>
      <td>[9728, 15297, 10440, 14488, 13865, 12192, 341,...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>83485</td>
      <td>[9728, 15297, 10440, 14488, 13865, 12192, 341,...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>636568</td>
      <td>[9728, 15297, 10440, 14488, 13865, 12192, 341,...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>669127</td>
      <td>[9728, 15297, 10440, 14488, 13865, 12192, 341,...</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-c94e46b5-edc1-423d-a57e-d4343514d989')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z" /><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z" />
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-c94e46b5-edc1-423d-a57e-d4343514d989 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-c94e46b5-edc1-423d-a57e-d4343514d989');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">reload_ext</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;Sparsh A.&quot;</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">t</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="n">implicit</span><span class="p">,</span><span class="n">catboost</span><span class="p">,</span><span class="n">recohut</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>numpy  1.19.5
pandas 1.1.5
Sparsh A. 
last updated: 2022-01-14 19:35:09 

implicit 0.4.8
catboost 1.0.4
recohut 0.0.11

compiler   : GCC 7.5.0
system     : Linux
release    : 5.4.144+
machine    : x86_64
processor  : x86_64
CPU cores  : 2
interpreter: 64bit
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>END</strong></p>

</div>
</div>
</div>
</div>

<script type="application/vnd.jupyter.widget-state+json">
{"1150ae9b77d04ee089151cdf9b3c97fd": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_cd203aa954364d05a2d9197f04bac18a", "IPY_MODEL_7d5a993575214d4189c013bb12fc9080", "IPY_MODEL_552747c596b440929459610765a70c67"], "layout": "IPY_MODEL_6404fcf9360b4c8bafac3d0c62dc7d58"}}, "163ead0dd46c434ea3412e462a0938db": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": ""}}, "1cfcd7deb21741cc95481b1ece102ced": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "552747c596b440929459610765a70c67": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_1cfcd7deb21741cc95481b1ece102ced", "placeholder": "\u200b", "style": "IPY_MODEL_6773a61987794d45bf453ac8a8f78a34", "value": " 266854/266854 [00:23&lt;00:00, 14342.15it/s]"}}, "6404fcf9360b4c8bafac3d0c62dc7d58": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "6773a61987794d45bf453ac8a8f78a34": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "6b9c40da36c746169708e1251c893b47": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "7d5a993575214d4189c013bb12fc9080": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "success", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_b6183320801a4148b75f6b36b65a9b13", "max": 266854, "min": 0, "orientation": "horizontal", "style": "IPY_MODEL_163ead0dd46c434ea3412e462a0938db", "value": 266854}}, "b6183320801a4148b75f6b36b65a9b13": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "cd203aa954364d05a2d9197f04bac18a": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_e6fb3757a3db480aa1be1f0a91e19f4d", "placeholder": "\u200b", "style": "IPY_MODEL_6b9c40da36c746169708e1251c893b47", "value": "100%"}}, "e6fb3757a3db480aa1be1f0a91e19f4d": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}}
</script>



  </div><a class="u-url" href="/2022/01/29/mts.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
