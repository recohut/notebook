<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Training Explainable BPR model on LastFM dataset | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Training Explainable BPR model on LastFM dataset" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/13/explainable-bpr-lastfm.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/13/explainable-bpr-lastfm.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-13T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Training Explainable BPR model on LastFM dataset" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-13T00:00:00-06:00","datePublished":"2022-01-13T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Training Explainable BPR model on LastFM dataset","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/13/explainable-bpr-lastfm.html"},"url":"https://nb.recohut.com/2022/01/13/explainable-bpr-lastfm.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Training Explainable BPR model on LastFM dataset</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-13T00:00:00-06:00" itemprop="datePublished">
        Jan 13, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      42 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-13-explainable-bpr-lastfm.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-13-explainable-bpr-lastfm.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-13-explainable-bpr-lastfm.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-13-explainable-bpr-lastfm.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-13-explainable-bpr-lastfm.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Executive-summary">Executive summary<a class="anchor-link" href="#Executive-summary"> </a></h2><table>
<thead><tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Problem</td>
<td>BPR is black-box model and vulnerable to Missing-not-at-random (MNaR) based exposure bias.</td>
</tr>
<tr>
<td>Solution</td>
<td>An explainable loss function and a corresponding Matrix Factorization-based model called Explainable Bayesian Personalized Ranking (EBPR) that generates recommendations along with item-based explanations.</td>
</tr>
<tr>
<td>Dataset</td>
<td>ML-100k, ML-1m, LastFM-200k, Yahoo R3.</td>
</tr>
<tr>
<td>Preprocessing</td>
<td>Interactions were converted into binary interactions, regardless of their values. Then we filtered out users with less than 10 interactions to ensure enough training and evaluation samples for every user and reduce the data sparsity. We follow the standard Leave-One-Out (LOO) procedure that consists of considering the latest interaction of each user as a test item and comparing it to 100 randomly sampled negative items. In the training, we sample, at every epoch, one negative item for every positive user-item interaction.</td>
</tr>
<tr>
<td>Metrics</td>
<td>NDCG@K, HR@K, Mean Explainability Precision (MEP@K), WMEP@K, Avg_Pop@K, EFD@K, and Div@K.</td>
</tr>
<tr>
<td>Hyperparams</td>
<td>NUM_CONFIGURATIONS, NUM_REPS, NUM_EPOCH, WEIGHT_DECAY, NEIGHBORHOOD, TOP_K, LR, OPTIMIZER, SGD_MOMENTUM, RMSPROP_ALPHA, RMSPROP_MOMENTUM, LOO_EVAL, TEST_RATE, USE_CUDA, DEVICE_ID, SAVE_MODELS, SAVE_RESULTS, INT_PER_ITEM.</td>
</tr>
<tr>
<td>Models</td>
<td>BPR, UBPR, EBPR, pUEBPR, UEBPR.</td>
</tr>
<tr>
<td>Cluster</td>
<td>Python 3.7+, PyTorch</td>
</tr>
<tr>
<td>Tags</td>
<td><code>Fairness</code>, <code>Explainability</code>, <code>ExposureBias</code>, <code>ExplainableBPR</code></td>
</tr>
<tr>
<td>Credits</td>
<td>Khalil Damak</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Process-flow">Process flow<a class="anchor-link" href="#Process-flow"> </a></h2><p><img src="https://github.com/RecoHut-Stanzas/S241566/raw/main/images/process_flow.svg" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">ml_metrics</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">pyprind</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>  Building wheel for ml-metrics (setup.py) ... done
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">pairwise_distances</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">ml_metrics</span> <span class="kn">import</span> <span class="n">mapk</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pyprind</span>
<span class="kn">import</span> <span class="nn">argparse</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">Output</span><span class="o">/</span><span class="n">checkpoints</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset">Dataset<a class="anchor-link" href="#Dataset"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Download LastFM raw dataset</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">Data</span><span class="o">/</span><span class="n">lastfm</span><span class="o">-</span><span class="mi">2</span><span class="n">k</span>
<span class="err">!</span><span class="n">git</span> <span class="n">clone</span> <span class="o">--</span><span class="n">branch</span> <span class="n">v1</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">RecoHut</span><span class="o">-</span><span class="n">Datasets</span><span class="o">/</span><span class="n">lastfm</span><span class="o">.</span><span class="n">git</span> <span class="n">Data</span><span class="o">/</span><span class="n">lastfm</span><span class="o">-</span><span class="mi">2</span><span class="n">k</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Cloning into &#39;data&#39;...
remote: Enumerating objects: 16, done.
remote: Counting objects: 100% (16/16), done.
remote: Compressing objects: 100% (13/13), done.
remote: Total 16 (delta 2), reused 12 (delta 2), pack-reused 0
Unpacking objects: 100% (16/16), done.
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">int_per_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read dataset&quot;&quot;&quot;</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dataset_name</span> <span class="o">==</span> <span class="s1">&#39;ml-100k&#39;</span><span class="p">:</span>
        <span class="c1"># Load Movielens 100K Data</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;Data/ml-100k/u.data&#39;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
                                  <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset_name</span> <span class="o">==</span> <span class="s1">&#39;ml-1m&#39;</span><span class="p">:</span>
        <span class="c1"># Load Movielens 1M Data</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;Data/ml-1m/ratings.dat&#39;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>  <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">dataset_name</span> <span class="o">==</span> <span class="s1">&#39;lastfm-2k&#39;</span><span class="p">:</span>
        <span class="c1"># Load Last.FM 2K Data</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;Data/lastfm-2k/user_artists.dat&#39;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">],</span>  <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
        <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))]</span>
        <span class="c1"># Filtering items with more than int_per_item interactions</span>
        <span class="n">item_count</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;mid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">item_count</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">int_per_item</span><span class="p">][[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]]</span>
        <span class="c1"># Filtering users with more than 10 interactions</span>
        <span class="n">user_count</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">user_count</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;uid&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">][[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]]</span>

    <span class="k">elif</span> <span class="n">dataset_name</span> <span class="o">==</span> <span class="s1">&#39;yahoo-r3&#39;</span><span class="p">:</span>
        <span class="c1"># Load Yahoo! R3 Data</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;Data/yahoo-r3/ydata-ymusic-rating-study-v1_0-train.txt&#39;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">],</span>  <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
        <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))]</span>

    <span class="k">elif</span> <span class="n">dataset_name</span> <span class="o">==</span> <span class="s1">&#39;yahoo-r3-unbiased&#39;</span><span class="p">:</span>
        <span class="c1"># Load Yahoo! R3 Data</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;Data/yahoo-r3/ydata-ymusic-rating-study-v1_0-train.txt&#39;</span>
        <span class="n">test_data_dir</span> <span class="o">=</span> <span class="s1">&#39;Data/yahoo-r3/ydata-ymusic-rating-study-v1_0-test.txt&#39;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">],</span>  <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
        <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))]</span>
        <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">],</span>  <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
        <span class="n">test_dataset</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">))]</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">])</span>
        <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))]</span>
    <span class="c1"># Reindex data</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[[</span><span class="s1">&#39;uid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reindex</span><span class="p">()</span>
    <span class="n">user_id</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">item_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[[</span><span class="s1">&#39;mid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">item_id</span><span class="p">[</span><span class="s1">&#39;itemId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item_id</span><span class="p">))</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">dataset</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">data_loader</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert user, item, negative and target Tensors into Pytorch Dataset&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_tensor</span><span class="p">,</span> <span class="n">positive_item_tensor</span><span class="p">,</span> <span class="n">negative_item_tensor</span><span class="p">,</span> <span class="n">target_tensor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tensor</span> <span class="o">=</span> <span class="n">user_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive_item_tensor</span> <span class="o">=</span> <span class="n">positive_item_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negative_item_tensor</span> <span class="o">=</span> <span class="n">negative_item_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_tensor</span> <span class="o">=</span> <span class="n">target_tensor</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_item_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_item_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tensor</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">data_loader_implicit</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert user and item Tensors into Pytorch Dataset&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_tensor</span><span class="p">,</span> <span class="n">item_tensor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tensor</span> <span class="o">=</span> <span class="n">user_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_tensor</span> <span class="o">=</span> <span class="n">item_tensor</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tensor</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">data_loader_test_explicit</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert user, item and target Tensors into Pytorch Dataset&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_tensor</span><span class="p">,</span> <span class="n">item_tensor</span><span class="p">,</span> <span class="n">target_tensor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tensor</span> <span class="o">=</span> <span class="n">user_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_tensor</span> <span class="o">=</span> <span class="n">item_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_tensor</span> <span class="o">=</span> <span class="n">target_tensor</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tensor</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">data_loader_negatives</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert user and item negative Tensors into Pytorch Dataset&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_neg_tensor</span><span class="p">,</span> <span class="n">item_neg_tensor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_neg_tensor</span> <span class="o">=</span> <span class="n">user_neg_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_neg_tensor</span> <span class="o">=</span> <span class="n">item_neg_tensor</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_neg_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_neg_tensor</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_neg_tensor</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">SampleGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct dataset&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">split_val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        args:</span>
<span class="sd">            ratings: pd.DataFrame containing 4 columns = [&#39;userId&#39;, &#39;itemId&#39;, &#39;rating&#39;, &#39;timestamp&#39;]</span>
<span class="sd">            config: dictionary containing the configuration hyperparameters</span>
<span class="sd">            split_val: boolean that takes True if we are using a validation set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39;userId&#39;</span> <span class="ow">in</span> <span class="n">ratings</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;itemId&#39;</span> <span class="ow">in</span> <span class="n">ratings</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;rating&#39;</span> <span class="ow">in</span> <span class="n">ratings</span><span class="o">.</span><span class="n">columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_val</span> <span class="o">=</span> <span class="n">split_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binarize</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_pool</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_pool</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;itemId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="c1"># create negative item samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negatives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_negative</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_val</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;loo_eval&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_val</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_loo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="p">,</span> <span class="n">split_val</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_loo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="p">,</span> <span class="n">split_val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;test_rate&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_val</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_test_split_random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratings</span><span class="p">,</span> <span class="n">split_val</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_test_split_random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratings</span><span class="p">,</span> <span class="n">split_val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_binarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;binarize into 0 or 1 for imlicit feedback&quot;&quot;&quot;</span>
        <span class="n">ratings</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
        <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">ratings</span>

    <span class="k">def</span> <span class="nf">train_test_split_random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">split_val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Random train/test split&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_rate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">split_val</span><span class="p">:</span>
            <span class="n">train</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_rate</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_rate</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">train</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]],</span> <span class="n">val</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">train</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]],</span> <span class="n">test</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_split_loo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">split_val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;leave-one-out train/test split&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">split_val</span><span class="p">:</span>
                <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;rank_latest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;userId&#39;</span><span class="p">])[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;rank_latest&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">train</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;rank_latest&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">train</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]],</span> <span class="n">val</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">ratings</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]],</span> <span class="n">test</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
        <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;rank_latest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;userId&#39;</span><span class="p">])[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;rank_latest&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">split_val</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;rank_latest&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;rank_latest&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">train</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]],</span> <span class="n">val</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;rank_latest&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">train</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]],</span> <span class="n">test</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_sample_negative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">split_val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return all negative items &amp; 100 sampled negative test items &amp; 100 sampled negative val items&quot;&quot;&quot;</span>
        <span class="n">interact_status</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;userId&#39;</span><span class="p">)[</span><span class="s1">&#39;itemId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;itemId&#39;</span><span class="p">:</span> <span class="s1">&#39;interacted_items&#39;</span><span class="p">})</span>
        <span class="n">interact_status</span><span class="p">[</span><span class="s1">&#39;negative_items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interact_status</span><span class="p">[</span><span class="s1">&#39;interacted_items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_pool</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">interact_status</span><span class="p">[</span><span class="s1">&#39;test_negative_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interact_status</span><span class="p">[</span><span class="s1">&#39;negative_items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
        <span class="n">interact_status</span><span class="p">[</span><span class="s1">&#39;negative_items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interact_status</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">negative_items</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">test_negative_samples</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">split_val</span><span class="p">:</span>
            <span class="n">interact_status</span><span class="p">[</span><span class="s1">&#39;val_negative_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interact_status</span><span class="p">[</span><span class="s1">&#39;negative_items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
            <span class="n">interact_status</span><span class="p">[</span><span class="s1">&#39;negative_items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interact_status</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">negative_items</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">val_negative_samples</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">interact_status</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;negative_items&#39;</span><span class="p">,</span> <span class="s1">&#39;test_negative_samples&#39;</span><span class="p">,</span> <span class="s1">&#39;val_negative_samples&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">interact_status</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;negative_items&#39;</span><span class="p">,</span> <span class="s1">&#39;test_negative_samples&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">train_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;instance train loader for one training epoch&quot;&quot;&quot;</span>
        <span class="n">train_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">negatives</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;negative_items&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;userId&#39;</span><span class="p">)</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">train_ratings</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">train_ratings</span><span class="p">[</span><span class="s1">&#39;itemId&#39;</span><span class="p">]]</span>
        <span class="n">ratings</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">train_ratings</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
        <span class="n">neg_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">neg_list</span><span class="p">))</span> <span class="k">for</span> <span class="n">neg_list</span> <span class="ow">in</span> <span class="n">train_ratings</span><span class="p">[</span><span class="s1">&#39;negative_items&#39;</span><span class="p">]]</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">data_loader</span><span class="p">(</span><span class="n">user_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">users</span><span class="p">),</span>
                              <span class="n">positive_item_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">items</span><span class="p">),</span>
                              <span class="n">negative_item_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">neg_items</span><span class="p">),</span>
                              <span class="n">target_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">ratings</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create evaluation data&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;loo_eval&#39;</span><span class="p">]:</span>
            <span class="n">test_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">negatives</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;test_negative_samples&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;userId&#39;</span><span class="p">)</span>
            <span class="n">test_users</span><span class="p">,</span> <span class="n">test_items</span><span class="p">,</span> <span class="n">negative_users</span><span class="p">,</span> <span class="n">negative_items</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">test_ratings</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
                <span class="n">test_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">userId</span><span class="p">))</span>
                <span class="n">test_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">itemId</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">test_negative_samples</span><span class="p">)):</span>
                    <span class="n">negative_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">userId</span><span class="p">))</span>
                    <span class="n">negative_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">test_negative_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">data_loader_implicit</span><span class="p">(</span><span class="n">user_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">test_users</span><span class="p">),</span>
                                           <span class="n">item_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">test_items</span><span class="p">))</span>
            <span class="n">dataset_negatives</span> <span class="o">=</span> <span class="n">data_loader_negatives</span><span class="p">(</span><span class="n">user_neg_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">negative_users</span><span class="p">),</span>
                                                      <span class="n">item_neg_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">negative_items</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset_negatives</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ratings</span>
            <span class="n">test_users</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">test_ratings</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]]</span>
            <span class="n">test_items</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">test_ratings</span><span class="p">[</span><span class="s1">&#39;itemId&#39;</span><span class="p">]]</span>
            <span class="n">test_ratings</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">test_ratings</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">data_loader_test_explicit</span><span class="p">(</span><span class="n">user_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">test_users</span><span class="p">),</span>
                                                <span class="n">item_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">test_items</span><span class="p">),</span>
                                                <span class="n">target_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">test_ratings</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">val_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create validation data&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;loo_eval&#39;</span><span class="p">]:</span>
            <span class="n">val_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">negatives</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;val_negative_samples&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;userId&#39;</span><span class="p">)</span>
            <span class="n">val_users</span><span class="p">,</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">negative_users</span><span class="p">,</span> <span class="n">negative_items</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">val_ratings</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
                <span class="n">val_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">userId</span><span class="p">))</span>
                <span class="n">val_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">itemId</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">val_negative_samples</span><span class="p">)):</span>
                    <span class="n">negative_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">userId</span><span class="p">))</span>
                    <span class="n">negative_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">val_negative_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">data_loader_implicit</span><span class="p">(</span><span class="n">user_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">val_users</span><span class="p">),</span>
                                           <span class="n">item_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">val_items</span><span class="p">))</span>
            <span class="n">dataset_negatives</span> <span class="o">=</span> <span class="n">data_loader_negatives</span><span class="p">(</span><span class="n">user_neg_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">negative_users</span><span class="p">),</span>
                                                      <span class="n">item_neg_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">negative_items</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset_negatives</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span>
            <span class="n">val_users</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val_ratings</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]]</span>
            <span class="n">val_items</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val_ratings</span><span class="p">[</span><span class="s1">&#39;itemId&#39;</span><span class="p">]]</span>
            <span class="n">val_ratings</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val_ratings</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">data_loader_test_explicit</span><span class="p">(</span><span class="n">user_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">val_users</span><span class="p">),</span>
                                                <span class="n">item_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">val_items</span><span class="p">),</span>
                                                <span class="n">target_tensor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">val_ratings</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_explainability_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create explainability matrix&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_test</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating explainability matrix...&#39;</span><span class="p">)</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">userId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="p">)</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)))</span>
            <span class="n">missing_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_users&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">missing_column</span> <span class="ow">in</span> <span class="n">missing_columns</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="p">[</span><span class="n">missing_column</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">missing_row</span> <span class="ow">in</span> <span class="n">missing_rows</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_row</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_val</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating test explainability matrix...&#39;</span><span class="p">)</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="o">.</span><span class="n">userId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="p">)[</span>
                                              <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating val explainability matrix...&#39;</span><span class="p">)</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">userId</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span><span class="o">.</span><span class="n">userId</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="p">))</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)))</span>
            <span class="n">missing_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_users&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">missing_column</span> <span class="ow">in</span> <span class="n">missing_columns</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="p">[</span><span class="n">missing_column</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">missing_row</span> <span class="ow">in</span> <span class="n">missing_rows</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_row</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
        <span class="c1">#item_similarity_matrix = 1 - pairwise_distances(interaction_matrix.T, metric = &quot;hamming&quot;)</span>
        <span class="n">item_similarity_matrix</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">item_similarity_matrix</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">neighborhood</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;neighborhood&#39;</span><span class="p">])[</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;neighborhood&#39;</span><span class="p">]:]</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">item_similarity_matrix</span><span class="p">]</span>
        <span class="n">explainability_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">sum</span><span class="p">([</span><span class="n">interaction_matrix</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">neighbor</span><span class="p">]</span> <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">neighborhood</span><span class="p">[</span><span class="n">item</span><span class="p">]])</span>
                                           <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">])]</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span>
                                          <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_users&#39;</span><span class="p">])])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;neighborhood&#39;</span><span class="p">]</span>
        <span class="c1">#explainability_matrix[explainability_matrix &lt; 0.1] = 0</span>
        <span class="c1">#explainability_matrix = explainability_matrix + self.config[&#39;epsilon&#39;]</span>
        <span class="k">return</span> <span class="n">explainability_matrix</span>

    <span class="k">def</span> <span class="nf">create_popularity_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create popularity vector&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_test</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating popularity vector...&#39;</span><span class="p">)</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">userId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="p">)</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)))</span>
            <span class="n">missing_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_users&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">missing_column</span> <span class="ow">in</span> <span class="n">missing_columns</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="p">[</span><span class="n">missing_column</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">missing_row</span> <span class="ow">in</span> <span class="n">missing_rows</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_row</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_val</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating test popularity vector...&#39;</span><span class="p">)</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="o">.</span><span class="n">userId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="p">)[</span>
                                              <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating val popularity vector...&#39;</span><span class="p">)</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">userId</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span><span class="o">.</span><span class="n">userId</span><span class="p">),</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="p">))</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)))</span>
            <span class="n">missing_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_users&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">missing_column</span> <span class="ow">in</span> <span class="n">missing_columns</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="p">[</span><span class="n">missing_column</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">missing_row</span> <span class="ow">in</span> <span class="n">missing_rows</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_row</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
        <span class="n">popularity_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">popularity_vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">popularity_vector</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">popularity_vector</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">popularity_vector</span>

    <span class="k">def</span> <span class="nf">create_neighborhood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine item neighbors&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_test</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determining item neighborhoods...&#39;</span><span class="p">)</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">userId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="p">)</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)))</span>
            <span class="n">missing_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_users&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">missing_column</span> <span class="ow">in</span> <span class="n">missing_columns</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="p">[</span><span class="n">missing_column</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">missing_row</span> <span class="ow">in</span> <span class="n">missing_rows</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_row</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_val</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determining test item neighborhoods...&#39;</span><span class="p">)</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="o">.</span><span class="n">userId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="p">)[</span>
                                              <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determining val item neighborhoods...&#39;</span><span class="p">)</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">userId</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span><span class="o">.</span><span class="n">userId</span><span class="p">),</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratings</span><span class="o">.</span><span class="n">itemId</span><span class="p">))</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)))</span>
            <span class="n">missing_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_users&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">missing_column</span> <span class="ow">in</span> <span class="n">missing_columns</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="p">[</span><span class="n">missing_column</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">missing_row</span> <span class="ow">in</span> <span class="n">missing_rows</span><span class="p">:</span>
                <span class="n">interaction_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_row</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]</span>
            <span class="n">interaction_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>
        <span class="n">item_similarity_matrix</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">interaction_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">item_similarity_matrix</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;neighborhood&#39;</span><span class="p">])[</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;neighborhood&#39;</span><span class="p">]:]</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">item_similarity_matrix</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">neighborhood</span><span class="p">,</span> <span class="n">item_similarity_matrix</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Utils">Utils<a class="anchor-link" href="#Utils"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_dir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">resume_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">,</span> <span class="n">device_id</span><span class="p">):</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span>
                            <span class="n">map_location</span><span class="o">=</span><span class="k">lambda</span> <span class="n">storage</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span> <span class="n">storage</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device_id</span><span class="p">))</span>  <span class="c1"># ensure all storage are on gpu</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>


<span class="c1"># Hyper params</span>
<span class="k">def</span> <span class="nf">use_cuda</span><span class="p">(</span><span class="n">enabled</span><span class="p">,</span> <span class="n">device_id</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">enabled</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">(),</span> <span class="s1">&#39;CUDA is not available&#39;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">use_optimizer</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sgd&#39;</span><span class="p">:</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                                    <span class="n">lr</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span>
                                    <span class="n">momentum</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sgd_momentum&#39;</span><span class="p">],</span>
                                    <span class="n">weight_decay</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                                                          <span class="n">lr</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span>
                                                          <span class="n">weight_decay</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rmsprop&#39;</span><span class="p">:</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                                        <span class="n">lr</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span>
                                        <span class="n">alpha</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rmsprop_alpha&#39;</span><span class="p">],</span>
                                        <span class="n">momentum</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rmsprop_momentum&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">optimizer</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metrics">Metrics<a class="anchor-link" href="#Metrics"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">MetronAtK</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">loo_eval</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loo_eval</span> <span class="o">=</span> <span class="n">loo_eval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Subjects which we ran evaluation on</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">top_k</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>

    <span class="nd">@top_k</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">top_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span> <span class="o">=</span> <span class="n">top_k</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span>

    <span class="nd">@subjects</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subjects</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loo_eval</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">test_users</span><span class="p">,</span> <span class="n">test_items</span><span class="p">,</span> <span class="n">test_scores</span> <span class="o">=</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">neg_users</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">,</span> <span class="n">neg_scores</span> <span class="o">=</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="c1"># the golden set</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">test_users</span><span class="p">,</span>
                                 <span class="s1">&#39;test_item&#39;</span><span class="p">:</span> <span class="n">test_items</span><span class="p">,</span>
                                 <span class="s1">&#39;test_score&#39;</span><span class="p">:</span> <span class="n">test_scores</span><span class="p">})</span>
            <span class="c1"># the full set</span>
            <span class="n">full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">neg_users</span> <span class="o">+</span> <span class="n">test_users</span><span class="p">,</span>
                                 <span class="s1">&#39;item&#39;</span><span class="p">:</span> <span class="n">neg_items</span> <span class="o">+</span> <span class="n">test_items</span><span class="p">,</span>
                                 <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">neg_scores</span> <span class="o">+</span> <span class="n">test_scores</span><span class="p">})</span>
            <span class="n">full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="c1"># rank the items according to the scores for each user</span>
            <span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">full</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span> <span class="o">=</span> <span class="n">full</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_users</span><span class="p">,</span> <span class="n">test_items</span><span class="p">,</span> <span class="n">test_true</span><span class="p">,</span> <span class="n">test_output</span> <span class="o">=</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">subjects</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1"># the golden set</span>
            <span class="n">full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">test_users</span><span class="p">,</span>
                                 <span class="s1">&#39;test_item&#39;</span><span class="p">:</span> <span class="n">test_items</span><span class="p">,</span>
                                 <span class="s1">&#39;test_true&#39;</span><span class="p">:</span> <span class="n">test_true</span><span class="p">,</span>
                                 <span class="s1">&#39;test_output&#39;</span><span class="p">:</span> <span class="n">test_output</span><span class="p">})</span>

            <span class="c1"># rank the items according to the scores for each user</span>
            <span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)[</span><span class="s1">&#39;test_output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank_true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)[</span><span class="s1">&#39;test_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">full</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span> <span class="o">=</span> <span class="n">full</span>

    <span class="k">def</span> <span class="nf">cal_ndcg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;NDCG@K for explicit evaluation&quot;&quot;&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="n">top_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>
        <span class="n">topp_k</span> <span class="o">=</span> <span class="n">full</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank_true&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">topp_k</span><span class="p">[</span><span class="s1">&#39;idcg_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">topp_k</span><span class="p">[</span><span class="s1">&#39;rank_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span>  <span class="c1"># the rank starts from 1</span>
        <span class="n">topp_k</span><span class="p">[</span><span class="s1">&#39;idcg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">topp_k</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;user&#39;</span><span class="p">])[</span><span class="s1">&#39;idcg_unit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>

        <span class="n">test_in_top_k</span> <span class="o">=</span> <span class="n">topp_k</span><span class="p">[</span><span class="n">topp_k</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">test_in_top_k</span><span class="p">[</span><span class="s1">&#39;dcg_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_in_top_k</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span>  <span class="c1"># the rank starts from 1</span>
        <span class="n">test_in_top_k</span><span class="p">[</span><span class="s1">&#39;dcg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_in_top_k</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;user&#39;</span><span class="p">])[</span><span class="s1">&#39;dcg_unit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="n">test_in_top_k</span><span class="p">[</span><span class="s1">&#39;ndcg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_in_top_k</span><span class="p">[</span><span class="s1">&#39;dcg&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">topp_k</span><span class="p">[</span><span class="s1">&#39;idcg&#39;</span><span class="p">]</span>
        <span class="n">ndcg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">test_in_top_k</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;user&#39;</span><span class="p">])[</span><span class="s1">&#39;ndcg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">del</span> <span class="p">(</span><span class="n">topp_k</span><span class="p">,</span> <span class="n">test_in_top_k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ndcg</span>

    <span class="k">def</span> <span class="nf">cal_map_at_k</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;MAP@K for explicit evaluation&quot;&quot;&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="n">top_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>
        <span class="n">users</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])))</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="p">[(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank_true&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">)][</span><span class="s1">&#39;test_item&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="p">[(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">)][</span><span class="s1">&#39;test_item&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mapk</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">top_k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cal_hit_ratio_loo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;HR@K for Leave-One-Out evaluation&quot;&quot;&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="n">top_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>
        <span class="n">top_k</span> <span class="o">=</span> <span class="n">full</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">]</span>
        <span class="n">test_in_top_k</span> <span class="o">=</span> <span class="n">top_k</span><span class="p">[</span><span class="n">top_k</span><span class="p">[</span><span class="s1">&#39;test_item&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">top_k</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]]</span>  <span class="c1"># golden items hit in the top_K items</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_in_top_k</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">full</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">cal_ndcg_loo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;NDCG@K for Leave-One-Out evaluation&quot;&quot;&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="n">top_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>
        <span class="n">top_k</span> <span class="o">=</span> <span class="n">full</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">]</span>
        <span class="n">test_in_top_k</span> <span class="o">=</span> <span class="n">top_k</span><span class="p">[</span><span class="n">top_k</span><span class="p">[</span><span class="s1">&#39;test_item&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">top_k</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]]</span>
        <span class="n">test_in_top_k</span><span class="p">[</span><span class="s1">&#39;ndcg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_in_top_k</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span>  <span class="c1"># the rank starts from 1</span>
        <span class="k">return</span> <span class="n">test_in_top_k</span><span class="p">[</span><span class="s1">&#39;ndcg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">full</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">cal_mep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mean Explainability Precision at cutoff top_k and threshold theta&quot;&quot;&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="n">top_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loo_eval</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">full</span><span class="p">[</span><span class="s1">&#39;exp_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">full</span><span class="p">[</span><span class="s1">&#39;exp_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;test_item&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">full</span><span class="p">[</span><span class="s1">&#39;exp_and_rec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;exp_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">theta</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="n">full</span><span class="p">[</span><span class="s1">&#39;topN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">full</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)[</span><span class="s1">&#39;exp_and_rec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">full</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)[</span><span class="s1">&#39;topN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">cal_weighted_mep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Weighted Mean Explainability Precision at cutoff top_k and threshold theta&quot;&quot;&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="n">top_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loo_eval</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">full</span><span class="p">[</span><span class="s1">&#39;exp_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">full</span><span class="p">[</span><span class="s1">&#39;exp_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;test_item&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">full</span><span class="p">[</span><span class="s1">&#39;exp_and_rec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;exp_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">theta</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;exp_score&#39;</span><span class="p">])</span>
        <span class="n">full</span><span class="p">[</span><span class="s1">&#39;topN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">full</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)[</span><span class="s1">&#39;exp_and_rec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">full</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)[</span><span class="s1">&#39;topN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">avg_popularity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">popularity_vector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Average popularity of top_k recommended items&quot;&quot;&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="n">top_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loo_eval</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">recommended_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">][</span><span class="s1">&#39;item&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recommended_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">][</span><span class="s1">&#39;test_item&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">popularity_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recommended_items</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">efd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">popularity_vector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Expected Free Discovery (EFD) in top_k recommended items&quot;&quot;&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="n">top_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loo_eval</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">recommended_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">][</span><span class="s1">&#39;item&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recommended_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">][</span><span class="s1">&#39;test_item&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">popularity_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recommended_items</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">avg_pairwise_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_similarity_matrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Average Pairwise Similarity of top_k recommended items&quot;&quot;&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="n">top_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span>
        <span class="n">full</span> <span class="o">=</span> <span class="n">full</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k</span><span class="p">]</span>
        <span class="n">users</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loo_eval</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">rec_items_for_users</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">u</span><span class="p">][</span><span class="s1">&#39;item&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rec_items_for_users</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">full</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">u</span><span class="p">][</span><span class="s1">&#39;test_item&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]</span>
            <span class="n">rec_items_for_users</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rec_items_for_users</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">item_combinations</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">rec_items_for_user</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">rec_items_for_user</span> <span class="ow">in</span> <span class="n">rec_items_for_users</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">item_similarity_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">item_combinations</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item_combinations</span><span class="p">))])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model">Model<a class="anchor-link" href="#Model"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta Engine for training &amp; evaluating BPR&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span> <span class="o">=</span> <span class="n">MetronAtK</span><span class="p">(</span><span class="n">top_k</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">loo_eval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;loo_eval&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">use_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_single_batch_EBPR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">pos_items</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">popularity_vector</span><span class="p">,</span> <span class="n">neighborhood</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">),</span> <span class="s1">&#39;Please specify the exact model!&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;BPR&#39;</span><span class="p">,</span> <span class="s1">&#39;UBPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EBPR&#39;</span><span class="p">,</span> <span class="s1">&#39;pUEBPR&#39;</span><span class="p">,</span> <span class="s1">&#39;UEBPR&#39;</span><span class="p">],</span> <span class="s1">&#39;Please specify the right model!&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">users</span><span class="p">,</span> <span class="n">pos_items</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">,</span> <span class="n">ratings</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">pos_items</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">neg_items</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">ratings</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">pos_prediction</span><span class="p">,</span> <span class="n">neg_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">pos_items</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BPR&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_prediction</span> <span class="o">-</span> <span class="n">neg_prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;UBPR&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span> <span class="p">((</span><span class="n">pos_prediction</span> <span class="o">-</span> <span class="n">neg_prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="o">/</span> <span class="n">popularity_vector</span><span class="p">[</span><span class="n">pos_items</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EBPR&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span> <span class="p">((</span><span class="n">pos_prediction</span> <span class="o">-</span> <span class="n">neg_prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="o">*</span> <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">users</span><span class="p">,</span> <span class="n">pos_items</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">users</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pUEBPR&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span> <span class="p">((</span><span class="n">pos_prediction</span> <span class="o">-</span> <span class="n">neg_prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="o">/</span> <span class="n">popularity_vector</span><span class="p">[</span><span class="n">pos_items</span><span class="p">]</span> <span class="o">*</span>
                      <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">users</span><span class="p">,</span> <span class="n">pos_items</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">users</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;UEBPR&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span> <span class="p">((</span><span class="n">pos_prediction</span> <span class="o">-</span> <span class="n">neg_prediction</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="o">/</span> <span class="n">popularity_vector</span><span class="p">[</span><span class="n">pos_items</span><span class="p">]</span> <span class="o">*</span>
                      <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">users</span><span class="p">,</span> <span class="n">pos_items</span><span class="p">]</span> <span class="o">/</span> <span class="n">popularity_vector</span><span class="p">[</span>
                          <span class="n">neighborhood</span><span class="p">[</span><span class="n">pos_items</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_items</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;neighborhood&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">explainability_matrix</span><span class="p">[</span><span class="n">users</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">]</span> <span class="o">/</span> <span class="n">popularity_vector</span><span class="p">[</span>
                        <span class="n">neighborhood</span><span class="p">[</span><span class="n">neg_items</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_items</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;neighborhood&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;l2_regularization&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">l2_reg</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                <span class="n">l2_reg</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;l2_regularization&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">l2_reg</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">train_an_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">popularity_vector</span><span class="p">,</span> <span class="n">neighborhood</span><span class="p">,</span> <span class="n">epoch_id</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">),</span> <span class="s1">&#39;Please specify the exact model!&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">explainability_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">explainability_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">popularity_vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">popularity_vector</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">neighborhood</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">pyprind</span><span class="o">.</span><span class="n">ProgBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">)</span>
            <span class="n">user</span><span class="p">,</span> <span class="n">pos_item</span><span class="p">,</span> <span class="n">neg_item</span><span class="p">,</span> <span class="n">rating</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_single_batch_EBPR</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">pos_item</span><span class="p">,</span> <span class="n">neg_item</span><span class="p">,</span> <span class="n">rating</span><span class="p">,</span> <span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">popularity_vector</span><span class="p">,</span> <span class="n">neighborhood</span><span class="p">)</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluate_data</span><span class="p">,</span> <span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">popularity_vector</span><span class="p">,</span> <span class="n">item_similarity_matrix</span><span class="p">,</span> <span class="n">epoch_id</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">),</span> <span class="s1">&#39;Please specify the exact model !&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;loo_eval&#39;</span><span class="p">]:</span>
            <span class="n">test_users_eval</span><span class="p">,</span> <span class="n">test_items_eval</span><span class="p">,</span> <span class="n">test_scores_eval</span><span class="p">,</span> <span class="n">negative_users_eval</span><span class="p">,</span> <span class="n">negative_items_eval</span><span class="p">,</span> <span class="n">negative_scores_eval</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_users_eval</span><span class="p">,</span> <span class="n">test_items_eval</span><span class="p">,</span> <span class="n">test_scores_eval</span><span class="p">,</span> <span class="n">test_output_eval</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;loo_eval&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evaluate_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">test_users</span><span class="p">,</span> <span class="n">test_items</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">test_users</span> <span class="o">=</span> <span class="n">test_users</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                        <span class="n">test_items</span> <span class="o">=</span> <span class="n">test_items</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                    <span class="n">test_scores</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">test_users</span><span class="p">,</span> <span class="n">test_items</span><span class="p">,</span> <span class="n">test_items</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">test_users_eval</span> <span class="o">+=</span> <span class="n">test_users</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">test_items_eval</span> <span class="o">+=</span> <span class="n">test_items</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">test_scores_eval</span> <span class="o">+=</span> <span class="n">test_scores</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evaluate_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">negative_users</span><span class="p">,</span> <span class="n">negative_items</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">negative_users</span> <span class="o">=</span> <span class="n">negative_users</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                        <span class="n">negative_items</span> <span class="o">=</span> <span class="n">negative_items</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                    <span class="n">negative_scores</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">negative_users</span><span class="p">,</span> <span class="n">negative_items</span><span class="p">,</span> <span class="n">negative_items</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">negative_users_eval</span> <span class="o">+=</span> <span class="n">negative_users</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">negative_items_eval</span> <span class="o">+=</span> <span class="n">negative_items</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">negative_scores_eval</span> <span class="o">+=</span> <span class="n">negative_scores</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_users_eval</span><span class="p">,</span> <span class="n">test_items_eval</span><span class="p">,</span> <span class="n">test_scores_eval</span><span class="p">,</span> <span class="n">negative_users_eval</span><span class="p">,</span>
                                         <span class="n">negative_items_eval</span><span class="p">,</span> <span class="n">negative_scores_eval</span><span class="p">]</span>
                <span class="n">hr</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">cal_hit_ratio_loo</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">cal_ndcg_loo</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">cal_mep</span><span class="p">(</span><span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">cal_weighted_mep</span><span class="p">(</span><span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">avg_popularity</span><span class="p">(</span><span class="n">popularity_vector</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">efd</span><span class="p">(</span><span class="n">popularity_vector</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">avg_pairwise_similarity</span><span class="p">(</span><span class="n">item_similarity_matrix</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Evaluating Epoch </span><span class="si">{}</span><span class="s1">: NDCG@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, HR@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, MEP@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, WMEP@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, Avg_Pop@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, EFD@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, Avg_Pair_Sim@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span>
                                                                                     <span class="n">ndcg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">hr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">mep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">wmep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">efd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">avg_pair_sim</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">hr</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evaluate_data</span><span class="p">):</span>
                    <span class="n">test_users</span><span class="p">,</span> <span class="n">test_items</span><span class="p">,</span> <span class="n">test_output</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">test_users</span> <span class="o">=</span> <span class="n">test_users</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                        <span class="n">test_items</span> <span class="o">=</span> <span class="n">test_items</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                        <span class="n">test_output</span> <span class="o">=</span> <span class="n">test_output</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                    <span class="n">test_scores</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">test_users</span><span class="p">,</span> <span class="n">test_items</span><span class="p">,</span> <span class="n">test_items</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">test_users_eval</span> <span class="o">+=</span> <span class="n">test_users</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">test_items_eval</span> <span class="o">+=</span> <span class="n">test_items</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">test_scores_eval</span> <span class="o">+=</span> <span class="n">test_scores</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">test_output_eval</span> <span class="o">+=</span> <span class="n">test_output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_users_eval</span><span class="p">,</span> <span class="n">test_items_eval</span><span class="p">,</span> <span class="n">test_output_eval</span><span class="p">,</span> <span class="n">test_scores_eval</span><span class="p">]</span>
            <span class="nb">map</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">cal_map_at_k</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">cal_ndcg</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">cal_mep</span><span class="p">(</span><span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">cal_weighted_mep</span><span class="p">(</span><span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">avg_popularity</span><span class="p">(</span><span class="n">popularity_vector</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">efd</span><span class="p">(</span><span class="n">popularity_vector</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metron</span><span class="o">.</span><span class="n">avg_pairwise_similarity</span><span class="p">(</span><span class="n">item_similarity_matrix</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Evaluating Epoch </span><span class="si">{}</span><span class="s1">: MAP@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, NDCG@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, MEP@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, WMEP@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, Avg_Pop@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, EFD@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">, Avg_Pair_Sim@</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="nb">map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">ndcg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">mep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">wmep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">efd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">avg_pair_sim</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">map</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span>

    <span class="k">def</span> <span class="nf">save_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_id</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span><span class="p">,</span> <span class="n">num_epoch</span><span class="p">,</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">best_performance</span><span class="p">,</span> <span class="n">save_models</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">),</span> <span class="s1">&#39;Please specify the exact model !&#39;</span>
        <span class="k">if</span> <span class="n">ndcg</span> <span class="o">&gt;</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndcg</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mep</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">wmep</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_pop</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">efd</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_pair_sim</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_id</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="n">epoch_id</span> <span class="o">==</span> <span class="n">num_epoch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_batchsize_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_opt_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_lr_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_latent_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_latent&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_l2reg_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;l2_regularization&#39;</span><span class="p">])</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_dir_explicit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Best model: &#39;</span> <span class="o">+</span> <span class="n">model_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_models</span><span class="p">:</span>
                <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">best_performance</span>

    <span class="k">def</span> <span class="nf">save_implicit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_id</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">hr</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span><span class="p">,</span> <span class="n">num_epoch</span><span class="p">,</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">best_performance</span><span class="p">,</span> <span class="n">save_models</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">),</span> <span class="s1">&#39;Please specify the exact model !&#39;</span>
        <span class="k">if</span> <span class="n">ndcg</span> <span class="o">&gt;</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndcg</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hr</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mep</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">wmep</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_pop</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">efd</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_pair_sim</span>
            <span class="n">best_performance</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_id</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="n">epoch_id</span> <span class="o">==</span> <span class="n">num_epoch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_batchsize_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_opt_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_lr_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_latent_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_latent&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_l2reg_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;l2_regularization&#39;</span><span class="p">])</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_dir_implicit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">],</span> <span class="n">best_performance</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Best model: &#39;</span> <span class="o">+</span> <span class="n">model_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_models</span><span class="p">:</span>
                <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">best_performance</span>

    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_model_path</span><span class="p">):</span>
        <span class="n">resume_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">test_model_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;device_id&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>EBPR model</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">BPR</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;BPR model definition&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BPR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_users&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_items&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_latent</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_latent&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loo_eval</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;loo_eval&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embed_user</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_latent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_latent</span><span class="p">)</span>

        <span class="c1"># torch.nn.init.xavier_uniform_(self.embed_user.weight)</span>
        <span class="c1"># torch.nn.init.xavier_uniform_(self.embed_item.weight)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_user</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_item</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_indices</span><span class="p">,</span> <span class="n">pos_item_indices</span><span class="p">,</span> <span class="n">neg_item_indices</span><span class="p">):</span>

        <span class="n">user_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_user</span><span class="p">(</span><span class="n">user_indices</span><span class="p">)</span>
        <span class="n">pos_item_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_item</span><span class="p">(</span><span class="n">pos_item_indices</span><span class="p">)</span>
        <span class="n">neg_item_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_item</span><span class="p">(</span><span class="n">neg_item_indices</span><span class="p">)</span>

        <span class="n">pos_prediction</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_latent</span> <span class="o">*</span> <span class="n">pos_item_latent</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">neg_prediction</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_latent</span> <span class="o">*</span> <span class="n">neg_item_latent</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pos_prediction</span><span class="p">,</span> <span class="n">neg_prediction</span>

    <span class="k">def</span> <span class="nf">init_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">BPREngine</span><span class="p">(</span><span class="n">Engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Engine for training &amp; evaluating BPR&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">BPR</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">use_cuda</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;device_id&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BPREngine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training-and-Evaluation">Training and Evaluation<a class="anchor-link" href="#Training-and-Evaluation"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># Read dataset</span>
    <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset</span>  <span class="c1"># &#39;ml-100k&#39; for Movielens 100K. &#39;ml-1m&#39; for the Movielens 1M dataset. &#39;lastfm-2k&#39; for the</span>
    <span class="c1"># Last.FM 2K dataset. &#39;yahoo-r3&#39; for the Yahoo! R3 dataset.</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">int_per_item</span><span class="p">)</span>

    <span class="c1"># Define hyperparameters</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>  <span class="c1"># Model to train: &#39;BPR&#39;, &#39;UBPR&#39;, &#39;EBPR&#39;, &#39;pUEBPR&#39;, &#39;UEBPR&#39;.</span>
              <span class="s1">&#39;dataset&#39;</span><span class="p">:</span> <span class="n">dataset_name</span><span class="p">,</span>
              <span class="s1">&#39;num_epoch&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">num_epoch</span><span class="p">,</span>  <span class="c1"># Number of training epochs.</span>
              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>  <span class="c1"># Batch size.</span>
              <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span>  <span class="c1"># Learning rate.</span>
              <span class="c1">#&#39;optimizer&#39;: &#39;sgd&#39;,</span>
              <span class="s1">&#39;sgd_momentum&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">sgd_momentum</span><span class="p">,</span>
              <span class="c1">#&#39;optimizer&#39;: &#39;rmsprop&#39;,</span>
              <span class="s1">&#39;rmsprop_alpha&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">rmsprop_alpha</span><span class="p">,</span>
              <span class="s1">&#39;rmsprop_momentum&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">rmsprop_momentum</span><span class="p">,</span>
              <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
              <span class="s1">&#39;num_users&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
              <span class="s1">&#39;num_items&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;itemId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
              <span class="s1">&#39;test_rate&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">test_rate</span><span class="p">,</span>  <span class="c1"># Test rate for random train/val/test split. test_rate is the rate of test + validation. Used when &#39;loo_eval&#39; is set to False.</span>
              <span class="s1">&#39;num_latent&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">num_latent</span><span class="p">,</span>  <span class="c1"># Number of latent factors.</span>
              <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">,</span>
              <span class="s1">&#39;l2_regularization&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">l2_regularization</span><span class="p">,</span>
              <span class="s1">&#39;use_cuda&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">,</span>
              <span class="s1">&#39;device_id&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span>
              <span class="s1">&#39;top_k&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">top_k</span><span class="p">,</span>  <span class="c1"># k in MAP@k, HR@k and NDCG@k.</span>
              <span class="s1">&#39;loo_eval&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">loo_eval</span><span class="p">,</span>  <span class="c1"># True: LOO evaluation with HR@k and NDCG@k. False: Random train/test split</span>
              <span class="c1"># evaluation with MAP@k and NDCG@k.</span>
              <span class="s1">&#39;neighborhood&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">neighborhood</span><span class="p">,</span>  <span class="c1"># Neighborhood size for explainability.</span>
              <span class="s1">&#39;model_dir_explicit&#39;</span><span class="p">:</span><span class="s1">&#39;Output/checkpoints/</span><span class="si">{}</span><span class="s1">_Epoch</span><span class="si">{}</span><span class="s1">_MAP@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_NDCG@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_MEP@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_WMEP@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_Avg_Pop@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_EFD@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_Avg_Pair_Sim@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">.model&#39;</span><span class="p">,</span>
              <span class="s1">&#39;model_dir_implicit&#39;</span><span class="p">:</span><span class="s1">&#39;Output/checkpoints/</span><span class="si">{}</span><span class="s1">_Epoch</span><span class="si">{}</span><span class="s1">_NDCG@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_HR@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_MEP@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_WMEP@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_Avg_Pop@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_EFD@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">_Avg_Pair_Sim@</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:.4f}</span><span class="s1">.model&#39;</span><span class="p">}</span>

    <span class="c1"># DataLoader</span>
    <span class="n">sample_generator</span> <span class="o">=</span> <span class="n">SampleGenerator</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">split_val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="n">test_data_loader</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>

    <span class="c1"># Create explainability matrix</span>
    <span class="n">explainability_matrix</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="n">create_explainability_matrix</span><span class="p">()</span>
    <span class="n">test_explainability_matrix</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="n">create_explainability_matrix</span><span class="p">(</span><span class="n">include_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create popularity vector</span>
    <span class="n">popularity_vector</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="n">create_popularity_vector</span><span class="p">()</span>
    <span class="n">test_popularity_vector</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="n">create_popularity_vector</span><span class="p">(</span><span class="n">include_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#Create item neighborhood</span>
    <span class="n">neighborhood</span><span class="p">,</span> <span class="n">item_similarity_matrix</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="n">create_neighborhood</span><span class="p">()</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">test_item_similarity_matrix</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="n">create_neighborhood</span><span class="p">(</span><span class="n">include_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Specify the exact model</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">BPREngine</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Initialize list of optimal results</span>
    <span class="n">best_performance</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="n">best_ndcg</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">best_model</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_epoch&#39;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training epoch </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="n">train_loader</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="n">train_data_loader</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">train_an_epoch</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">explainability_matrix</span><span class="p">,</span> <span class="n">popularity_vector</span><span class="p">,</span> <span class="n">neighborhood</span><span class="p">,</span> <span class="n">epoch_id</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;loo_eval&#39;</span><span class="p">]:</span>
            <span class="n">ndcg</span><span class="p">,</span> <span class="n">hr</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_explainability_matrix</span><span class="p">,</span> <span class="n">test_popularity_vector</span><span class="p">,</span> <span class="n">test_item_similarity_matrix</span><span class="p">,</span> <span class="n">epoch_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; on test data&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
            <span class="n">best_model</span><span class="p">,</span> <span class="n">best_performance</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">save_implicit</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">hr</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_epoch&#39;</span><span class="p">],</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">best_performance</span><span class="p">,</span> <span class="n">save_models</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">save_models</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">map</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_explainability_matrix</span><span class="p">,</span> <span class="n">test_popularity_vector</span><span class="p">,</span> <span class="n">test_item_similarity_matrix</span><span class="p">,</span> <span class="n">epoch_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; on test data&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
            <span class="n">best_model</span><span class="p">,</span> <span class="n">best_performance</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">save_explicit</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">mep</span><span class="p">,</span> <span class="n">wmep</span><span class="p">,</span> <span class="n">avg_pop</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">avg_pair_sim</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_epoch&#39;</span><span class="p">],</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">best_performance</span><span class="p">,</span> <span class="n">save_models</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">save_models</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p><div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Training script.&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;EBPR&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model to train: &#39;BPR&#39;, &#39;UBPR&#39;, &#39;EBPR&#39;, &#39;pUEBPR&#39;, &quot;</span>
                                                                   <span class="s2">&quot;&#39;UEBPR&#39;.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dataset&quot;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;lastfm-2k&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&#39;ml-100k&#39; for Movielens 100K. &#39;ml-1m&#39; for &quot;</span>
                                                                        <span class="s2">&quot;the Movielens 1M dataset. &#39;lastfm-2k&#39; for &quot;</span>
                                                                        <span class="s2">&quot;the Last.FM 2K dataset. &#39;yahoo-r3&#39; for the &quot;</span>
                                                                        <span class="s2">&quot;Yahoo! R3 dataset.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num_epoch&quot;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of training epochs.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Batch size.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num_latent&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of latent features.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--l2_regularization&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;L2 regularization coefficient.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--weight_decay&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Weight decay coefficient.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--neighborhood&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Neighborhood size for explainability.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--top_k&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Cutoff k in MAP@k, HR@k and NDCG@k, etc.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--lr&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Learning rate.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--optimizer&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optimizer: &#39;adam&#39;, &#39;sgd&#39;, &#39;rmsprop&#39;.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sgd_momentum&quot;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Momentum for SGD optimizer.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--rmsprop_alpha&quot;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;alpha hyperparameter for RMSProp optimizer.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--rmsprop_momentum&quot;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Momentum for RMSProp optimizer.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--loo_eval&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;True: LOO evaluation. False: Random &quot;</span>
                                                                            <span class="s2">&quot;train/test split&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--test_rate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Test rate for random train/val/test &quot;</span>
                                                                            <span class="s2">&quot;split. test_rate is the rate of test + &quot;</span>
                                                                            <span class="s2">&quot;validation. Used when &#39;loo_eval&#39; is set &quot;</span>
                                                                            <span class="s2">&quot;to False.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--use_cuda&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;True is you want to use a CUDA device.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--device_id&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;ID of CUDA device if &#39;use_cuda&#39; is True.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--save_models&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;True if you want to save the best model(s).&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--int_per_item&quot;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Minimum number of interactions per item for studying effect sparsity on the lastfm-2k dataset.&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([])</span>
    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>
</p>
    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating explainability matrix...
Creating test explainability matrix...
Creating popularity vector...
Creating test popularity vector...
Determining item neighborhoods...
Determining test item neighborhoods...
Training epoch 0
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 0 on test data: NDCG@10 = 0.5700, HR@10 = 0.7060, MEP@10 = 0.1927, WMEP@10 = 0.0412, Avg_Pop@10 = 0.1881, EFD@10 = 3.0274, Avg_Pair_Sim@10 = 0.0141
--------------------------------------------------------------------------------
Training epoch 1
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 1 on test data: NDCG@10 = 0.5989, HR@10 = 0.7487, MEP@10 = 0.2025, WMEP@10 = 0.0426, Avg_Pop@10 = 0.1948, EFD@10 = 2.9236, Avg_Pair_Sim@10 = 0.0157
--------------------------------------------------------------------------------
Training epoch 2
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 2 on test data: NDCG@10 = 0.6113, HR@10 = 0.7839, MEP@10 = 0.2126, WMEP@10 = 0.0440, Avg_Pop@10 = 0.1925, EFD@10 = 2.9495, Avg_Pair_Sim@10 = 0.0162
--------------------------------------------------------------------------------
Training epoch 3
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 3 on test data: NDCG@10 = 0.6104, HR@10 = 0.7716, MEP@10 = 0.2122, WMEP@10 = 0.0439, Avg_Pop@10 = 0.1879, EFD@10 = 2.9977, Avg_Pair_Sim@10 = 0.0160
--------------------------------------------------------------------------------
Training epoch 4
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 4 on test data: NDCG@10 = 0.6143, HR@10 = 0.7684, MEP@10 = 0.2178, WMEP@10 = 0.0445, Avg_Pop@10 = 0.1829, EFD@10 = 3.0525, Avg_Pair_Sim@10 = 0.0161
--------------------------------------------------------------------------------
Training epoch 5
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 5 on test data: NDCG@10 = 0.6084, HR@10 = 0.7604, MEP@10 = 0.2199, WMEP@10 = 0.0444, Avg_Pop@10 = 0.1784, EFD@10 = 3.1006, Avg_Pair_Sim@10 = 0.0158
--------------------------------------------------------------------------------
Training epoch 6
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:02
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 6 on test data: NDCG@10 = 0.6086, HR@10 = 0.7556, MEP@10 = 0.2224, WMEP@10 = 0.0445, Avg_Pop@10 = 0.1747, EFD@10 = 3.1421, Avg_Pair_Sim@10 = 0.0158
--------------------------------------------------------------------------------
Training epoch 7
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 7 on test data: NDCG@10 = 0.6119, HR@10 = 0.7561, MEP@10 = 0.2269, WMEP@10 = 0.0449, Avg_Pop@10 = 0.1713, EFD@10 = 3.1823, Avg_Pair_Sim@10 = 0.0156
--------------------------------------------------------------------------------
Training epoch 8
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 8 on test data: NDCG@10 = 0.6085, HR@10 = 0.7551, MEP@10 = 0.2308, WMEP@10 = 0.0453, Avg_Pop@10 = 0.1692, EFD@10 = 3.2058, Avg_Pair_Sim@10 = 0.0155
--------------------------------------------------------------------------------
Training epoch 9
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 9 on test data: NDCG@10 = 0.6164, HR@10 = 0.7620, MEP@10 = 0.2335, WMEP@10 = 0.0457, Avg_Pop@10 = 0.1674, EFD@10 = 3.2273, Avg_Pair_Sim@10 = 0.0154
--------------------------------------------------------------------------------
Training epoch 10
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 10 on test data: NDCG@10 = 0.6156, HR@10 = 0.7567, MEP@10 = 0.2349, WMEP@10 = 0.0458, Avg_Pop@10 = 0.1654, EFD@10 = 3.2469, Avg_Pair_Sim@10 = 0.0153
--------------------------------------------------------------------------------
Training epoch 11
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 11 on test data: NDCG@10 = 0.6087, HR@10 = 0.7487, MEP@10 = 0.2374, WMEP@10 = 0.0458, Avg_Pop@10 = 0.1633, EFD@10 = 3.2697, Avg_Pair_Sim@10 = 0.0150
--------------------------------------------------------------------------------
Training epoch 12
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 12 on test data: NDCG@10 = 0.6114, HR@10 = 0.7487, MEP@10 = 0.2385, WMEP@10 = 0.0459, Avg_Pop@10 = 0.1622, EFD@10 = 3.2824, Avg_Pair_Sim@10 = 0.0151
--------------------------------------------------------------------------------
Training epoch 13
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 13 on test data: NDCG@10 = 0.6064, HR@10 = 0.7492, MEP@10 = 0.2405, WMEP@10 = 0.0461, Avg_Pop@10 = 0.1610, EFD@10 = 3.2928, Avg_Pair_Sim@10 = 0.0150
--------------------------------------------------------------------------------
Training epoch 14
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 14 on test data: NDCG@10 = 0.6073, HR@10 = 0.7556, MEP@10 = 0.2400, WMEP@10 = 0.0460, Avg_Pop@10 = 0.1605, EFD@10 = 3.2986, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 15
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 15 on test data: NDCG@10 = 0.6096, HR@10 = 0.7535, MEP@10 = 0.2423, WMEP@10 = 0.0462, Avg_Pop@10 = 0.1598, EFD@10 = 3.3039, Avg_Pair_Sim@10 = 0.0147
--------------------------------------------------------------------------------
Training epoch 16
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 16 on test data: NDCG@10 = 0.6182, HR@10 = 0.7668, MEP@10 = 0.2444, WMEP@10 = 0.0465, Avg_Pop@10 = 0.1596, EFD@10 = 3.3070, Avg_Pair_Sim@10 = 0.0148
--------------------------------------------------------------------------------
Training epoch 17
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 17 on test data: NDCG@10 = 0.6176, HR@10 = 0.7689, MEP@10 = 0.2445, WMEP@10 = 0.0465, Avg_Pop@10 = 0.1593, EFD@10 = 3.3106, Avg_Pair_Sim@10 = 0.0148
--------------------------------------------------------------------------------
Training epoch 18
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 18 on test data: NDCG@10 = 0.6203, HR@10 = 0.7700, MEP@10 = 0.2450, WMEP@10 = 0.0466, Avg_Pop@10 = 0.1588, EFD@10 = 3.3160, Avg_Pair_Sim@10 = 0.0148
--------------------------------------------------------------------------------
Training epoch 19
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 19 on test data: NDCG@10 = 0.6310, HR@10 = 0.7737, MEP@10 = 0.2472, WMEP@10 = 0.0468, Avg_Pop@10 = 0.1586, EFD@10 = 3.3176, Avg_Pair_Sim@10 = 0.0148
--------------------------------------------------------------------------------
Training epoch 20
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 20 on test data: NDCG@10 = 0.6313, HR@10 = 0.7748, MEP@10 = 0.2476, WMEP@10 = 0.0469, Avg_Pop@10 = 0.1587, EFD@10 = 3.3182, Avg_Pair_Sim@10 = 0.0148
--------------------------------------------------------------------------------
Training epoch 21
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 21 on test data: NDCG@10 = 0.6265, HR@10 = 0.7812, MEP@10 = 0.2493, WMEP@10 = 0.0471, Avg_Pop@10 = 0.1590, EFD@10 = 3.3133, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 22
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 22 on test data: NDCG@10 = 0.6291, HR@10 = 0.7828, MEP@10 = 0.2497, WMEP@10 = 0.0472, Avg_Pop@10 = 0.1585, EFD@10 = 3.3179, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 23
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 23 on test data: NDCG@10 = 0.6213, HR@10 = 0.7898, MEP@10 = 0.2507, WMEP@10 = 0.0474, Avg_Pop@10 = 0.1590, EFD@10 = 3.3139, Avg_Pair_Sim@10 = 0.0150
--------------------------------------------------------------------------------
Training epoch 24
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 24 on test data: NDCG@10 = 0.6248, HR@10 = 0.7908, MEP@10 = 0.2495, WMEP@10 = 0.0472, Avg_Pop@10 = 0.1590, EFD@10 = 3.3156, Avg_Pair_Sim@10 = 0.0148
--------------------------------------------------------------------------------
Training epoch 25
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 25 on test data: NDCG@10 = 0.6160, HR@10 = 0.7898, MEP@10 = 0.2509, WMEP@10 = 0.0473, Avg_Pop@10 = 0.1586, EFD@10 = 3.3186, Avg_Pair_Sim@10 = 0.0148
--------------------------------------------------------------------------------
Training epoch 26
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:02
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 26 on test data: NDCG@10 = 0.6178, HR@10 = 0.7924, MEP@10 = 0.2510, WMEP@10 = 0.0473, Avg_Pop@10 = 0.1586, EFD@10 = 3.3178, Avg_Pair_Sim@10 = 0.0148
--------------------------------------------------------------------------------
Training epoch 27
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 27 on test data: NDCG@10 = 0.6195, HR@10 = 0.7892, MEP@10 = 0.2504, WMEP@10 = 0.0472, Avg_Pop@10 = 0.1587, EFD@10 = 3.3151, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 28
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 28 on test data: NDCG@10 = 0.6155, HR@10 = 0.7860, MEP@10 = 0.2513, WMEP@10 = 0.0472, Avg_Pop@10 = 0.1586, EFD@10 = 3.3153, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 29
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 29 on test data: NDCG@10 = 0.6234, HR@10 = 0.7898, MEP@10 = 0.2521, WMEP@10 = 0.0473, Avg_Pop@10 = 0.1586, EFD@10 = 3.3147, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 30
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 30 on test data: NDCG@10 = 0.6276, HR@10 = 0.7930, MEP@10 = 0.2527, WMEP@10 = 0.0474, Avg_Pop@10 = 0.1586, EFD@10 = 3.3117, Avg_Pair_Sim@10 = 0.0147
--------------------------------------------------------------------------------
Training epoch 31
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 31 on test data: NDCG@10 = 0.6294, HR@10 = 0.7978, MEP@10 = 0.2532, WMEP@10 = 0.0474, Avg_Pop@10 = 0.1594, EFD@10 = 3.3045, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 32
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 32 on test data: NDCG@10 = 0.6329, HR@10 = 0.7988, MEP@10 = 0.2520, WMEP@10 = 0.0474, Avg_Pop@10 = 0.1592, EFD@10 = 3.3070, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 33
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 33 on test data: NDCG@10 = 0.6287, HR@10 = 0.7978, MEP@10 = 0.2519, WMEP@10 = 0.0474, Avg_Pop@10 = 0.1597, EFD@10 = 3.3019, Avg_Pair_Sim@10 = 0.0147
--------------------------------------------------------------------------------
Training epoch 34
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 34 on test data: NDCG@10 = 0.6365, HR@10 = 0.8063, MEP@10 = 0.2542, WMEP@10 = 0.0477, Avg_Pop@10 = 0.1599, EFD@10 = 3.3000, Avg_Pair_Sim@10 = 0.0148
--------------------------------------------------------------------------------
Training epoch 35
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 35 on test data: NDCG@10 = 0.6322, HR@10 = 0.8058, MEP@10 = 0.2536, WMEP@10 = 0.0475, Avg_Pop@10 = 0.1602, EFD@10 = 3.2970, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 36
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 36 on test data: NDCG@10 = 0.6308, HR@10 = 0.8047, MEP@10 = 0.2538, WMEP@10 = 0.0476, Avg_Pop@10 = 0.1604, EFD@10 = 3.2917, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 37
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 37 on test data: NDCG@10 = 0.6359, HR@10 = 0.8036, MEP@10 = 0.2538, WMEP@10 = 0.0475, Avg_Pop@10 = 0.1608, EFD@10 = 3.2883, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 38
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 38 on test data: NDCG@10 = 0.6394, HR@10 = 0.8084, MEP@10 = 0.2555, WMEP@10 = 0.0478, Avg_Pop@10 = 0.1610, EFD@10 = 3.2856, Avg_Pair_Sim@10 = 0.0150
--------------------------------------------------------------------------------
Training epoch 39
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 39 on test data: NDCG@10 = 0.6408, HR@10 = 0.8047, MEP@10 = 0.2570, WMEP@10 = 0.0479, Avg_Pop@10 = 0.1605, EFD@10 = 3.2903, Avg_Pair_Sim@10 = 0.0150
--------------------------------------------------------------------------------
Training epoch 40
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 40 on test data: NDCG@10 = 0.6461, HR@10 = 0.8111, MEP@10 = 0.2570, WMEP@10 = 0.0479, Avg_Pop@10 = 0.1611, EFD@10 = 3.2859, Avg_Pair_Sim@10 = 0.0150
--------------------------------------------------------------------------------
Training epoch 41
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 41 on test data: NDCG@10 = 0.6421, HR@10 = 0.8095, MEP@10 = 0.2578, WMEP@10 = 0.0479, Avg_Pop@10 = 0.1610, EFD@10 = 3.2850, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 42
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 42 on test data: NDCG@10 = 0.6463, HR@10 = 0.8132, MEP@10 = 0.2582, WMEP@10 = 0.0479, Avg_Pop@10 = 0.1613, EFD@10 = 3.2833, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 43
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 43 on test data: NDCG@10 = 0.6459, HR@10 = 0.8132, MEP@10 = 0.2582, WMEP@10 = 0.0480, Avg_Pop@10 = 0.1616, EFD@10 = 3.2800, Avg_Pair_Sim@10 = 0.0150
--------------------------------------------------------------------------------
Training epoch 44
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 44 on test data: NDCG@10 = 0.6427, HR@10 = 0.8127, MEP@10 = 0.2584, WMEP@10 = 0.0480, Avg_Pop@10 = 0.1616, EFD@10 = 3.2795, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 45
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 45 on test data: NDCG@10 = 0.6438, HR@10 = 0.8106, MEP@10 = 0.2578, WMEP@10 = 0.0480, Avg_Pop@10 = 0.1616, EFD@10 = 3.2779, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 46
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 46 on test data: NDCG@10 = 0.6407, HR@10 = 0.8138, MEP@10 = 0.2596, WMEP@10 = 0.0481, Avg_Pop@10 = 0.1620, EFD@10 = 3.2751, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 47
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 47 on test data: NDCG@10 = 0.6397, HR@10 = 0.8106, MEP@10 = 0.2598, WMEP@10 = 0.0481, Avg_Pop@10 = 0.1622, EFD@10 = 3.2711, Avg_Pair_Sim@10 = 0.0150
--------------------------------------------------------------------------------
Training epoch 48
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:02
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 48 on test data: NDCG@10 = 0.6416, HR@10 = 0.8175, MEP@10 = 0.2599, WMEP@10 = 0.0482, Avg_Pop@10 = 0.1627, EFD@10 = 3.2672, Avg_Pair_Sim@10 = 0.0149
--------------------------------------------------------------------------------
Training epoch 49
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0% [##############################] 100% | ETA: 00:00:00
Total time elapsed: 00:00:03
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:90: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evaluating Epoch 49 on test data: NDCG@10 = 0.6474, HR@10 = 0.8186, MEP@10 = 0.2617, WMEP@10 = 0.0484, Avg_Pop@10 = 0.1628, EFD@10 = 3.2679, Avg_Pair_Sim@10 = 0.0151
--------------------------------------------------------------------------------
Best model: Output/checkpoints/EBPR_lastfm-2k_batchsize_100_opt_adam_lr_0.001_latent_50_l2reg_0.0_Epoch49_NDCG@10_0.6474_HR@10_0.8186_MEP@10_0.2617_WMEP@10_0.0484_Avg_Pop@10_0.1628_EFD@10_3.2679_Avg_Pair_Sim@10_0.0151.model
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">qq</span> <span class="n">install</span> <span class="n">tree</span>
<span class="err">!</span><span class="n">rm</span> <span class="o">-</span><span class="n">r</span> <span class="n">sample_data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">tree</span> <span class="o">-</span><span class="n">h</span> <span class="o">--</span><span class="n">du</span> <span class="o">.</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>.
â”œâ”€â”€ [ 12M]  data
â”‚Â Â  â”œâ”€â”€ [1.8M]  artists.dat
â”‚Â Â  â”œâ”€â”€ [4.7K]  readme.md
â”‚Â Â  â”œâ”€â”€ [217K]  tags.dat
â”‚Â Â  â”œâ”€â”€ [1.1M]  user_artists.dat
â”‚Â Â  â”œâ”€â”€ [221K]  user_friends.dat
â”‚Â Â  â”œâ”€â”€ [4.0M]  user_taggedartists.dat
â”‚Â Â  â””â”€â”€ [4.8M]  user_taggedartists-timestamps.dat
â””â”€â”€ [3.7M]  Output
    â””â”€â”€ [3.7M]  checkpoints
        â””â”€â”€ [3.7M]  EBPR_lastfm-2k_batchsize_100_opt_adam_lr_0.001_latent_50_l2reg_0.0_Epoch49_NDCG@10_0.6474_HR@10_0.8186_MEP@10_0.2617_WMEP@10_0.0484_Avg_Pop@10_0.1628_EFD@10_3.2679_Avg_Pair_Sim@10_0.0151.model

  16M used in 3 directories, 8 files
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">reload_ext</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;Sparsh A.&quot;</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">t</span> <span class="o">-</span><span class="n">d</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Author: Sparsh A.

Last updated: 2021-12-11 12:09:53

Compiler    : GCC 7.5.0
OS          : Linux
Release     : 5.4.104+
Machine     : x86_64
Processor   : x86_64
CPU cores   : 2
Architecture: 64bit

IPython : 5.5.0
pandas  : 1.1.5
sys     : 3.7.12 (default, Sep 10 2021, 00:21:48) 
[GCC 7.5.0]
torch   : 1.10.0+cu111
argparse: 1.1
pyprind : 2.11.3
numpy   : 1.19.5

</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>END</strong></p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/2022/01/13/explainable-bpr-lastfm.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
