<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Equal Experience in Recommender Systems on ML-1m and Synthetic biased data | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Equal Experience in Recommender Systems on ML-1m and Synthetic biased data" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/13/equal-experience.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/13/equal-experience.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-13T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Equal Experience in Recommender Systems on ML-1m and Synthetic biased data" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-13T00:00:00-06:00","datePublished":"2022-01-13T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Equal Experience in Recommender Systems on ML-1m and Synthetic biased data","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/13/equal-experience.html"},"url":"https://nb.recohut.com/2022/01/13/equal-experience.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Equal Experience in Recommender Systems on ML-1m and Synthetic biased data</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-13T00:00:00-06:00" itemprop="datePublished">
        Jan 13, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      15 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-13-equal-experience.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-13-equal-experience.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-13-equal-experience.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-13-equal-experience.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-13-equal-experience.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Executive-summary">Executive summary<a class="anchor-link" href="#Executive-summary"> </a></h2><table>
<thead><tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Problem</td>
<td>Biased data due to inherent stereotypes of particular groups (e.g., male students’ average rating on mathematics is often higher than that on humanities, and vice versa for females) may yield a limited scope of suggested items to a certain group of users.</td>
</tr>
<tr>
<td>Solution</td>
<td>The novel fairness notion, coined <strong><em>Equal Experience</em></strong>, tries to capture the degree of the equal experience of item recommendations across distinct groups. Specifically, the prediction $\hat{Y}$ should be independent of the 1) user group $Z_{user}$, and 2) item group $Z_{item}$. Formally, $I(\hat{Y};Z<em>{user},Z</em>{item}) = I(\hat{Y};Z<em>{item}) + I(\hat{Y};Z</em>{user}</td>
<td>Z<em>{item}) = I(\hat{Y};Z</em>{user}) + I(\hat{Y};Z_{item}</td>
<td>Z_{user})$</td>
</tr>
<tr>
<td>Dataset</td>
<td>ML-1m, LastFM-360k, Synthetic.</td>
</tr>
<tr>
<td>Preprocessing</td>
<td>For ML-1m, we divide user and item groups based on gender and genre, respectively. Action, crime, film-noir, war are selected as male-preferred genre, whereas children, fantasy, musical, romance are selected as female-preferred genre. We can select male-preferred and female-preferred genres in a variety of ways based on ratings and observations. In case of LastFM-360k, the associated task is to predict whether the user likes the artist or not. The data for play counts is converted to binary rating. We divide user and item groups based on gender and genre, respectively. We also randomly select 5000 male and 5000 female users. Among 10 genres, we choose hip-hop and musical for male and female preferred genres, respectively. The final rating matrix of 10,000 users and 5,706 artists is 0.55% full. We randomly split the real datasets into 90% train set and 10% test set. In case of MovieLens data, the rating is five-star based, so we set the threshold $\tau$ = 3, on the other hand, for LastFM and for synthetic dataset, we set $\tau$ = 0 as $M_{ij} \in \{+1, −1\}$.</td>
</tr>
<tr>
<td>Metrics</td>
<td>RMSE, DEE, VAL, UGF, CVS</td>
</tr>
<tr>
<td>Models</td>
<td>MF class models, AE class models</td>
</tr>
<tr>
<td>Cluster</td>
<td>Python 3.6+, PyTorch</td>
</tr>
<tr>
<td>Tags</td>
<td><code>Fairness</code>, <code>MatrixFactorization</code>, <code>AutoEncoder</code>,  <code>ExposureBias</code>, <code>PopulationBias</code></td>
</tr>
<tr>
<td>Credits</td>
<td>cjw2525</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Process-flow">Process flow<a class="anchor-link" href="#Process-flow"> </a></h2><p><img src="https://github.com/RecoHut-Stanzas/S035564/raw/main/images/process_flow.svg" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">livelossplot</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">livelossplot</span> <span class="kn">import</span> <span class="n">PlotLosses</span>  

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data">Data<a class="anchor-link" href="#Data"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ML-1m">ML-1m<a class="anchor-link" href="#ML-1m"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Download</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">progress</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">files</span><span class="o">.</span><span class="n">grouplens</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">datasets</span><span class="o">/</span><span class="n">movielens</span><span class="o">/</span><span class="n">ml</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">zip</span>
<span class="err">!</span><span class="n">unzip</span> <span class="n">ml</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">zip</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>ml-1m.zip           100%[===================&gt;]   5.64M  7.06MB/s    in 0.8s    
Archive:  ml-1m.zip
   creating: ml-1m/
  inflating: ml-1m/movies.dat        
  inflating: ml-1m/ratings.dat       
  inflating: ml-1m/README            
  inflating: ml-1m/users.dat         
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Preprocessing</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">data_loader_movielens</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./ml-1m/&#39;</span>
    <span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span> <span class="o">=</span> <span class="mi">6040</span><span class="p">,</span> <span class="mi">3952</span>
      
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">train_ratio</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_users</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">genre</span> <span class="o">=</span> <span class="n">load_items</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">genre</span><span class="p">[</span><span class="s1">&#39;War&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">genre</span><span class="p">[</span><span class="s1">&#39;Crime&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">genre</span><span class="p">[</span><span class="s1">&#39;Film-Noir&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">genre</span><span class="p">[</span><span class="s1">&#39;Sci-Fi&#39;</span><span class="p">]</span>
    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">genre</span><span class="p">[</span><span class="s1">&#39;Children</span><span class="se">\&#39;</span><span class="s1">s&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">genre</span><span class="p">[</span><span class="s1">&#39;Fantasy&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">genre</span><span class="p">[</span><span class="s1">&#39;Musical&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">genre</span><span class="p">[</span><span class="s1">&#39;Romance&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">load_users</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;users.dat&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">gender</span><span class="p">,</span> <span class="n">age</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span> <span class="c1"># generate dictionaries</span>
    <span class="n">gender_index</span><span class="p">,</span> <span class="n">age_index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">56</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gender_index</span><span class="p">:</span>
        <span class="n">gender</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">age_index</span><span class="p">:</span>
        <span class="n">age</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
        <span class="n">gender</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">age</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> 

    <span class="k">return</span> <span class="n">gender</span><span class="p">,</span> <span class="n">age</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">load_items</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;multiple_genre&#39;</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;movies.dat&quot;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">genre</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">genre_index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Action&#39;</span><span class="p">,</span> <span class="s1">&#39;Adventure&#39;</span><span class="p">,</span> <span class="s1">&#39;Animation&#39;</span><span class="p">,</span> <span class="s1">&#39;Children</span><span class="se">\&#39;</span><span class="s1">s&#39;</span><span class="p">,</span> 
                   <span class="s1">&#39;Comedy&#39;</span><span class="p">,</span> <span class="s1">&#39;Crime&#39;</span><span class="p">,</span> <span class="s1">&#39;Documentary&#39;</span><span class="p">,</span> <span class="s1">&#39;Drama&#39;</span><span class="p">,</span> <span class="s1">&#39;Fantasy&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Film-Noir&#39;</span><span class="p">,</span> <span class="s1">&#39;Horror&#39;</span><span class="p">,</span> <span class="s1">&#39;Musical&#39;</span><span class="p">,</span> <span class="s1">&#39;Mystery&#39;</span><span class="p">,</span> 
                   <span class="s1">&#39;Romance&#39;</span><span class="p">,</span> <span class="s1">&#39;Sci-Fi&#39;</span><span class="p">,</span> <span class="s1">&#39;Thriller&#39;</span><span class="p">,</span> <span class="s1">&#39;War&#39;</span><span class="p">,</span> <span class="s1">&#39;Western&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">genre_index</span><span class="p">:</span>
        <span class="n">genre</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="n">tags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">==</span><span class="s1">&#39;multiple_genre&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">genre</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">genre</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">genre</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">train_ratio</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read data by lines and produce train/test data matrices.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;ratings.dat&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  

    <span class="n">num_ratings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="p">))</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">rating</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
        <span class="n">user_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">item_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_ratings</span> <span class="o">*</span> <span class="n">train_ratio</span><span class="p">):</span>
            <span class="n">X_train</span><span class="p">[</span><span class="n">user_idx</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_test</span><span class="p">[</span><span class="n">user_idx</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Synthetic-dataset">Synthetic dataset<a class="anchor-link" href="#Synthetic-dataset"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">data_loader_synthetic</span><span class="p">(</span><span class="n">p</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">q</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">r</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ground truth matrix Y</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">400</span>
    <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">num_users</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num_items</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">Y_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">rank</span><span class="p">,</span> <span class="n">n2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">Y_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">rank</span><span class="p">,</span> <span class="n">n2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Y_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y_1</span><span class="p">,</span> <span class="n">Y_2</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">Y_m</span> <span class="o">=</span> <span class="n">Y_rank</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_users</span> <span class="o">//</span> <span class="p">(</span><span class="n">rank</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">Y_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y_m</span><span class="p">,</span> <span class="n">Y_rank</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span>
    <span class="n">Y_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">rank</span><span class="p">,</span> <span class="n">n2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span>
    <span class="n">Y_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">rank</span><span class="p">,</span> <span class="n">n2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Y_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y_1</span><span class="p">,</span> <span class="n">Y_2</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">Y_f</span> <span class="o">=</span> <span class="n">Y_rank</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_users</span> <span class="o">//</span> <span class="p">(</span><span class="n">rank</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">Y_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y_f</span><span class="p">,</span> <span class="n">Y_rank</span><span class="p">))</span>
    
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">Y_m</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">Y_f</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y_m</span><span class="p">,</span> <span class="n">Y_f</span><span class="p">))</span>
    
    <span class="n">I_obs_mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">I_obs_mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">I_obs_fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">I_obs_ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">I_obs_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">I_obs_mm</span><span class="p">,</span> <span class="n">I_obs_mf</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">I_obs_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">I_obs_fm</span><span class="p">,</span> <span class="n">I_obs_ff</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">I_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">I_obs_m</span><span class="p">,</span> <span class="n">I_obs_f</span><span class="p">))</span>
    
    <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">*</span> <span class="n">I_obs</span>
    
    <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_obs</span><span class="p">,</span> <span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">Y_obs</span><span class="p">)</span>
<span class="c1">#     Y_train, Y_test = np.zeros((num_users, num_items)), np.zeros((num_users, num_items))</span>

<span class="c1">#     for i in tqdm(range(num_users)):</span>
<span class="c1">#         for j in range(num_items):</span>
<span class="c1">#             if Y_obs[i, j] != 0:</span>
<span class="c1">#                 k = np.random.random()</span>
<span class="c1">#                 if k &gt; 0.9:</span>
<span class="c1">#                     Y_test[i, j] = Y_obs[i, j]</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     Y_train[i, j] = Y_obs[i, j]</span>
                    
                    
    <span class="n">user</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="n">user</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
    <span class="n">user</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n1</span><span class="o">*</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n2</span><span class="p">)]</span>
    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">n2</span><span class="o">*</span><span class="mi">2</span><span class="p">)]</span>
                    
    <span class="k">return</span> <span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">),</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metrics">Metrics<a class="anchor-link" href="#Metrics"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_tuple</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;AE&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    
    <span class="n">data</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="n">data_tuple</span>
    <span class="n">measures</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span> 
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model_type</span><span class="o">==</span><span class="s1">&#39;PQ&#39;</span><span class="p">:</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>   
        <span class="c1"># 1. rmse</span>
        <span class="n">test_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">Y_test</span><span class="p">[</span><span class="n">Y_test</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pred</span><span class="p">[</span><span class="n">Y_test</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Y_tilde </span>
        <span class="n">pred_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pred</span> <span class="o">&gt;</span> <span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># 2. DEE</span>
        <span class="n">DEE</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]:</span>
                <span class="n">DEE</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_hat</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_hat</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="n">g</span><span class="p">]][:,</span> <span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="c1"># 3. value_fairness</span>
        <span class="n">VAL</span> <span class="o">=</span> <span class="n">VAL_measure</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="c1"># 4. DP_user</span>
        <span class="n">UGF</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]:</span>
            <span class="n">UGF</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_hat</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_hat</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="n">g</span><span class="p">]]))</span>
        <span class="c1"># 4. DP_item</span>
        <span class="n">CVS</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]:</span>
            <span class="n">CVS</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_hat</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_hat</span><span class="p">[:,</span> <span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="n">measures</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_rmse</span>
        <span class="n">measures</span><span class="p">[</span><span class="s1">&#39;DEE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEE</span>
        <span class="n">measures</span><span class="p">[</span><span class="s1">&#39;VAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VAL</span> 
        <span class="n">measures</span><span class="p">[</span><span class="s1">&#39;UGF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UGF</span>
        <span class="n">measures</span><span class="p">[</span><span class="s1">&#39;CVS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CVS</span>
    <span class="k">return</span> <span class="n">measures</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">VAL_measure</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">train_data</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">y_m</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]]</span>
    <span class="n">y_f</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]]</span>
    <span class="n">y_hat_m</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]]</span>
    <span class="n">y_hat_f</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]]</span>

    <span class="c1">#average ratings</span>
    <span class="n">d_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_m</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mf">1e-8</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_hat_m</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]))</span>
    <span class="n">d_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_f</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mf">1e-8</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_hat_f</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]))</span>

    <span class="n">v_fairness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d_m</span><span class="o">-</span><span class="n">d_f</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">v_fairness</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Regularizers">Regularizers<a class="anchor-link" href="#Regularizers"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">normal_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">normal_cdf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="c1"># Approximation of Q-function given by López-Benítez &amp; Casadevall (2011)</span>
    <span class="c1"># based on a second-order exponential function &amp; Q(x) = 1 - Q(-x):</span>
    <span class="n">Q_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4920</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.2887</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="mf">1.1893</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_prime</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">h</span>
    <span class="n">sum_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Q_fn</span><span class="p">(</span><span class="n">y_prime</span><span class="p">[</span><span class="n">y_prime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span> \
           <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Q_fn</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_prime</span><span class="p">[</span><span class="n">y_prime</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])))</span> \
           <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_prime</span><span class="p">[</span><span class="n">y_prime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sum_</span> <span class="o">/</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">Huber_loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">delta</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">-</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Huber_loss_derivative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">delta</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">delta</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">delta</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">delta</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">FairnessLoss</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">data_tuple</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s1">&#39;EqualExp&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type_</span> <span class="o">=</span> <span class="n">type_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_tuple</span> <span class="o">=</span> <span class="n">data_tuple</span>

    <span class="k">def</span> <span class="nf">DEE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">backward_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logging_loss_</span> <span class="o">=</span> <span class="mi">0</span> 
        
        <span class="k">for</span> <span class="n">gender_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">item_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]:</span>
                <span class="n">gender_idx</span> <span class="o">=</span> <span class="n">gender</span><span class="p">[</span><span class="n">gender_key</span><span class="p">]</span> 
                <span class="n">item_idx</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">item_key</span><span class="p">]</span>
                <span class="n">m_gi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gender_idx</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">item_idx</span><span class="p">)</span>
                <span class="n">y_hat_gender_item</span> <span class="o">=</span> <span class="n">y_hat</span><span class="p">[</span><span class="n">gender_idx</span><span class="p">][:,</span> <span class="n">item_idx</span><span class="p">]</span>

                <span class="n">Prob_diff_Z</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="n">y_hat</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span><span class="o">-</span><span class="n">normal_cdf</span><span class="p">(</span><span class="n">y_hat_gender_item</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
                
                <span class="n">_dummy</span> <span class="o">=</span> <span class="n">Huber_loss_derivative</span><span class="p">(</span><span class="n">Prob_diff_Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
                <span class="n">_dummy</span> <span class="o">*=</span> \
                    <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                        <span class="n">normal_pdf</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">-</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
                        <span class="n">y_hat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>\
                    <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                        <span class="n">normal_pdf</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">-</span> <span class="n">y_hat_gender_item</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
                        <span class="n">y_hat_gender_item</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">m_gi</span><span class="p">)</span>
                <span class="n">backward_loss</span> <span class="o">+=</span> <span class="n">_dummy</span>
        <span class="k">return</span> <span class="n">backward_loss</span>
        
    <span class="k">def</span> <span class="nf">VAL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
        
        <span class="n">backward_loss</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">train_data</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">train_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">y_m</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]]</span>
        <span class="n">y_f</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]]</span>
        <span class="n">y_hat_m</span> <span class="o">=</span> <span class="n">y_hat</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]]</span>
        <span class="n">y_hat_f</span> <span class="o">=</span> <span class="n">y_hat</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]]</span>

        <span class="c1">#average ratings</span>
        <span class="n">d_m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_m</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mf">1e-8</span><span class="p">)</span>
        <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_hat_m</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]))</span>

        <span class="n">d_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_f</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mf">1e-8</span><span class="p">)</span>
        <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_hat_f</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">gender</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]))</span>


        <span class="n">backward_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d_m</span><span class="o">-</span><span class="n">d_f</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">backward_loss</span>
    
    <span class="k">def</span> <span class="nf">UGF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">backward_loss</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]:</span>
            
            <span class="n">gender_idx</span> <span class="o">=</span> <span class="n">gender</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">m_i</span> <span class="o">=</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">gender_idx</span><span class="p">)</span>
            <span class="n">y_hat_group</span> <span class="o">=</span> <span class="n">y_hat</span><span class="p">[</span><span class="n">gender_idx</span><span class="p">]</span>
            
            <span class="n">Prob_diff_Z</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="n">y_hat</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span><span class="o">-</span><span class="n">normal_cdf</span><span class="p">(</span><span class="n">y_hat_group</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>

            <span class="n">_dummy</span> <span class="o">=</span> <span class="n">Huber_loss_derivative</span><span class="p">(</span><span class="n">Prob_diff_Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
            <span class="n">_dummy</span> <span class="o">*=</span> \
                <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">normal_pdf</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">-</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
                    <span class="n">y_hat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>\
                <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">normal_pdf</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">-</span> <span class="n">y_hat_group</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
                    <span class="n">y_hat_group</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">m_i</span><span class="p">)</span>
            <span class="n">backward_loss</span> <span class="o">+=</span> <span class="n">_dummy</span>
        <span class="k">return</span> <span class="n">backward_loss</span>
    
    <span class="k">def</span> <span class="nf">CVS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">backward_loss</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]:</span>
            <span class="n">item_idx</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">m_i</span> <span class="o">=</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">item_idx</span><span class="p">)</span>
            <span class="n">y_hat_group</span> <span class="o">=</span> <span class="n">y_hat</span><span class="p">[:,</span> <span class="n">item_idx</span><span class="p">]</span>

            <span class="n">Prob_diff_Z</span> <span class="o">=</span> <span class="n">normal_cdf</span><span class="p">(</span><span class="n">y_hat</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span><span class="o">-</span><span class="n">normal_cdf</span><span class="p">(</span><span class="n">y_hat_group</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>

            <span class="n">_dummy</span> <span class="o">=</span> <span class="n">Huber_loss_derivative</span><span class="p">(</span><span class="n">Prob_diff_Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
            <span class="n">_dummy</span> <span class="o">*=</span> \
                <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">normal_pdf</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">-</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
                    <span class="n">y_hat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>\
                <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">normal_pdf</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">-</span> <span class="n">y_hat_group</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
                    <span class="n">y_hat_group</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">m_i</span><span class="p">)</span>
            <span class="n">backward_loss</span> <span class="o">+=</span> <span class="n">_dummy</span>
        <span class="k">return</span> <span class="n">backward_loss</span>
        
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;EqualExp&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEE</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;VAL&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">VAL</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;UGF&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">UGF</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;CVS&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CVS</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Models">Models<a class="anchor-link" href="#Models"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Matrix-factorization">Matrix factorization<a class="anchor-link" href="#Matrix-factorization"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">PQ</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rating</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">rank</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PQ</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rating</span> <span class="o">=</span> <span class="n">rating</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_users</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rating</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rating</span> <span class="o">==</span> <span class="s1">&#39;five-stars&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;unavailable rating scale&quot;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Autoencoder">Autoencoder<a class="anchor-link" href="#Autoencoder"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">AE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rating</span><span class="p">,</span> <span class="n">num_user</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rating</span> <span class="o">=</span> <span class="n">rating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
          <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_user</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
          <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
          <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
          <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.7</span><span class="p">),</span>
          <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
          <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_user</span><span class="p">),</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rating</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rating</span> <span class="o">==</span> <span class="s1">&#39;five-stars&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Trainer">Trainer<a class="anchor-link" href="#Trainer"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">mklogs</span><span class="p">():</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train_loss&#39;</span><span class="p">:[],</span> 
            <span class="s1">&#39;train_f_loss&#39;</span><span class="p">:[],</span> 
            <span class="s1">&#39;RMSE&#39;</span><span class="p">:[],</span>
            <span class="s1">&#39;acc&#39;</span><span class="p">:[],</span> 
            <span class="s1">&#39;DEE&#39;</span><span class="p">:[],</span> 
            <span class="s1">&#39;DP_user&#39;</span><span class="p">:[],</span> 
            <span class="s1">&#39;DP_item&#39;</span><span class="p">:[],</span> 
            <span class="s1">&#39;v_fairness&#39;</span><span class="p">:[]</span>
           <span class="p">}</span>
    <span class="k">return</span> <span class="n">logs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">get_test_logs</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span>
              <span class="s1">&#39;acc&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;DEE&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;DP_user&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;DP_item&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;v_fairness&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">measure</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">:</span>
        <span class="n">logs</span><span class="p">[</span><span class="n">measure</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="n">measure</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">train_PQ</span><span class="p">(</span><span class="n">data_tuple</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> 
             <span class="n">num_epochs</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">l_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">f_criterion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>

    <span class="n">logs</span> <span class="o">=</span> <span class="n">mklogs</span><span class="p">()</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="n">data_tuple</span>
    
    <span class="c1"># data_input </span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> 
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">identity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">train_data</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    
    <span class="c1">#losses</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">rmse</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">W</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span>
        <span class="n">W_fro</span><span class="p">,</span> <span class="n">V_fro</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">x_hat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">loss</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lambda_</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">criterion</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">x_hat</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">/</span><span class="n">count</span> <span class="o">+</span> <span class="n">l_value</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W_fro</span> <span class="o">+</span> <span class="n">V_fro</span> <span class="p">))</span>
        <span class="k">if</span> <span class="n">f_criterion</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> 
            <span class="n">f_loss</span> <span class="o">=</span> <span class="n">f_criterion</span><span class="p">(</span><span class="n">x_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;train_f_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="n">lambda_</span><span class="o">*</span><span class="n">f_loss</span>
        
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        
        <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        
    <span class="k">return</span> <span class="n">logs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">train_AE</span><span class="p">(</span><span class="n">data_tuple</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> 
             <span class="n">num_epochs</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">l_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">f_criterion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>

    <span class="n">logs</span> <span class="o">=</span> <span class="n">mklogs</span><span class="p">()</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="n">data_tuple</span>
    
    <span class="c1"># data_input </span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> 
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">train_data</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    
    <span class="c1">#losses</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">rmse</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">W</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span>
        <span class="n">W_fro</span><span class="p">,</span> <span class="n">V_fro</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">x_hat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">loss</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lambda_</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">criterion</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">x_hat</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">/</span><span class="n">count</span> <span class="o">+</span> <span class="n">l_value</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W_fro</span> <span class="o">+</span> <span class="n">V_fro</span> <span class="p">))</span>
        <span class="k">if</span> <span class="n">f_criterion</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> 
            <span class="n">f_loss</span> <span class="o">=</span> <span class="n">f_criterion</span><span class="p">(</span><span class="n">x_hat</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;train_f_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="n">lambda_</span><span class="o">*</span><span class="n">f_loss</span>
        
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        
        <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        
    <span class="k">return</span> <span class="n">logs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Run">Run<a class="anchor-link" href="#Run"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;movielens&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q1</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;binary&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;PQ&#39;</span> <span class="c1"># Choose model type: &#39;PQ&#39; or &#39;AE&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_type</span> <span class="o">=</span> <span class="s1">&#39;EqualExp&#39;</span> <span class="c1"># Choose algorithm: &#39;unfair&#39;, &#39;EqualExp&#39;, &#39;VAL&#39;, &#39;UGF&#39;, &#39;CVS&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">==</span><span class="s1">&#39;movielens&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;five-stars&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_loader_movielens</span><span class="p">())</span>
        <span class="c1"># elif self.dataset==&#39;lastfm&#39;:</span>
        <span class="c1">#     self.data_tuple = (data_loader_lastfm())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">==</span><span class="s1">&#39;synthetic&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_loader_synthetic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q1</span><span class="p">))</span> <span class="c1"># return ((train_data, test_data), user attribute, item attribute)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span> <span class="o">=</span> <span class="mf">0.99</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_type</span> <span class="o">==</span> <span class="s1">&#39;unfair&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_criterion</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">f_criterion</span> <span class="o">=</span> <span class="n">FairnessLoss</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> 
                                            <span class="n">data_tuple</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">,</span> 
                                            <span class="n">type_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm_type</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Experiment-on-ML-1m">Experiment on ML-1m<a class="anchor-link" href="#Experiment-on-ML-1m"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;movielens&#39;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">model_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PQ&#39;</span><span class="p">,</span><span class="s1">&#39;AE&#39;</span><span class="p">]</span>
<span class="n">algorithm_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;unfair&#39;</span><span class="p">,</span> <span class="s1">&#39;EqualExp&#39;</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">,</span> <span class="s1">&#39;UGF&#39;</span><span class="p">,</span> <span class="s1">&#39;CVS&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model_type</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">algo</span> <span class="ow">in</span> <span class="n">algorithm_type</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">args</span><span class="o">.</span><span class="n">algorithm_type</span> <span class="o">=</span> <span class="n">algo</span>
            <span class="c1"># train the model</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;PQ&#39;</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">PQ</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="n">train_PQ</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">l_value</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">l_value</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lambda_</span><span class="p">,</span>
                                <span class="n">f_criterion</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">f_criterion</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;AE&#39;</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">AE</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="n">train_AE</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">l_value</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">l_value</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lambda_</span><span class="p">,</span>
                                <span class="n">f_criterion</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">f_criterion</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
                
            <span class="n">result</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">algo</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;RMSE&#39;: 0.9027500699012365, &#39;DEE&#39;: 0.0012048745340699218, &#39;VAL&#39;: 0.31501372873975914, &#39;UGF&#39;: 0.0002971521526640153, &#39;CVS&#39;: 0.0006153119059790768}
{&#39;RMSE&#39;: 0.9015563787906975, &#39;DEE&#39;: 0.001095268864150678, &#39;VAL&#39;: 0.30451721083300864, &#39;UGF&#39;: 0.0001496180935723901, &#39;CVS&#39;: 0.0005326444826091459}
{&#39;RMSE&#39;: 0.9133768224920821, &#39;DEE&#39;: 0.0009910946781319652, &#39;VAL&#39;: 0.307643166842646, &#39;UGF&#39;: 6.867560418755136e-05, &#39;CVS&#39;: 0.00048708791966778353}
{&#39;RMSE&#39;: 0.9130855504041286, &#39;DEE&#39;: 0.001214569441231883, &#39;VAL&#39;: 0.30696451034405997, &#39;UGF&#39;: 2.6442839102136517e-05, &#39;CVS&#39;: 0.0005941362836467956}
{&#39;RMSE&#39;: 0.9142809402166817, &#39;DEE&#39;: 0.0009662139592129249, &#39;VAL&#39;: 0.3151116659819781, &#39;UGF&#39;: 1.7062581478044514e-05, &#39;CVS&#39;: 0.0004522546364315039}
{&#39;RMSE&#39;: 0.8623466023698251, &#39;DEE&#39;: 0.0, &#39;VAL&#39;: 0.3562827773780338, &#39;UGF&#39;: 0.0, &#39;CVS&#39;: 0.0}
{&#39;RMSE&#39;: 0.8626359054188043, &#39;DEE&#39;: 0.0, &#39;VAL&#39;: 0.3361190263181524, &#39;UGF&#39;: 0.0, &#39;CVS&#39;: 0.0}
{&#39;RMSE&#39;: 0.8609437988471073, &#39;DEE&#39;: 0.0, &#39;VAL&#39;: 0.3366856844320138, &#39;UGF&#39;: 0.0, &#39;CVS&#39;: 0.0}
{&#39;RMSE&#39;: 0.8623010810731232, &#39;DEE&#39;: 0.0, &#39;VAL&#39;: 0.3466369815510938, &#39;UGF&#39;: 0.0, &#39;CVS&#39;: 0.0}
{&#39;RMSE&#39;: 0.8644324054752013, &#39;DEE&#39;: 0.0, &#39;VAL&#39;: 0.33675105885736717, &#39;UGF&#39;: 0.0, &#39;CVS&#39;: 0.0}
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">df_ml</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">df_ml</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span><span class="s1">&#39;Metrics&#39;</span><span class="p">]</span>
<span class="n">df_ml</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_ml</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Metrics&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_ml</span><span class="p">[</span><span class="s1">&#39;Metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_ml</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Model</th>
      <th>Algorithm</th>
      <th>RMSE</th>
      <th>DEE</th>
      <th>VAL</th>
      <th>UGF</th>
      <th>CVS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>PQ</td>
      <td>unfair</td>
      <td>0.902750</td>
      <td>0.001205</td>
      <td>0.315014</td>
      <td>0.000297</td>
      <td>0.000615</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PQ</td>
      <td>EqualExp</td>
      <td>0.901556</td>
      <td>0.001095</td>
      <td>0.304517</td>
      <td>0.000150</td>
      <td>0.000533</td>
    </tr>
    <tr>
      <th>2</th>
      <td>PQ</td>
      <td>VAL</td>
      <td>0.913377</td>
      <td>0.000991</td>
      <td>0.307643</td>
      <td>0.000069</td>
      <td>0.000487</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PQ</td>
      <td>UGF</td>
      <td>0.913086</td>
      <td>0.001215</td>
      <td>0.306965</td>
      <td>0.000026</td>
      <td>0.000594</td>
    </tr>
    <tr>
      <th>4</th>
      <td>PQ</td>
      <td>CVS</td>
      <td>0.914281</td>
      <td>0.000966</td>
      <td>0.315112</td>
      <td>0.000017</td>
      <td>0.000452</td>
    </tr>
    <tr>
      <th>5</th>
      <td>AE</td>
      <td>unfair</td>
      <td>0.862347</td>
      <td>0.000000</td>
      <td>0.356283</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>AE</td>
      <td>EqualExp</td>
      <td>0.862636</td>
      <td>0.000000</td>
      <td>0.336119</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>AE</td>
      <td>VAL</td>
      <td>0.860944</td>
      <td>0.000000</td>
      <td>0.336686</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>AE</td>
      <td>UGF</td>
      <td>0.862301</td>
      <td>0.000000</td>
      <td>0.346637</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>AE</td>
      <td>CVS</td>
      <td>0.864432</td>
      <td>0.000000</td>
      <td>0.336751</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;synthetic&#39;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">model_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PQ&#39;</span><span class="p">,</span><span class="s1">&#39;AE&#39;</span><span class="p">]</span>
<span class="n">algorithm_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;unfair&#39;</span><span class="p">,</span> <span class="s1">&#39;EqualExp&#39;</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">,</span> <span class="s1">&#39;UGF&#39;</span><span class="p">,</span> <span class="s1">&#39;CVS&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model_type</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">algo</span> <span class="ow">in</span> <span class="n">algorithm_type</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">args</span><span class="o">.</span><span class="n">algorithm_type</span> <span class="o">=</span> <span class="n">algo</span>
            <span class="c1"># train the model</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;PQ&#39;</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">PQ</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="n">train_PQ</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">l_value</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">l_value</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lambda_</span><span class="p">,</span>
                                <span class="n">f_criterion</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">f_criterion</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;AE&#39;</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">AE</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="n">train_AE</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">l_value</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">l_value</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lambda_</span><span class="p">,</span>
                                <span class="n">f_criterion</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">f_criterion</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
                
            <span class="n">result</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">data_tuple</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">algo</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;RMSE&#39;: 0.6843796436520339, &#39;DEE&#39;: 0.01281666666666667, &#39;VAL&#39;: 0.1854790271175086, &#39;UGF&#39;: 0.00025833333333333264, &#39;CVS&#39;: 0.0001916666666666733}
{&#39;RMSE&#39;: 0.6746158616275792, &#39;DEE&#39;: 0.012016666666666648, &#39;VAL&#39;: 0.2008466635558418, &#39;UGF&#39;: 0.00044166666666667354, &#39;CVS&#39;: 0.0001916666666666733}
{&#39;RMSE&#39;: 0.6793149919984537, &#39;DEE&#39;: 0.012683333333333324, &#39;VAL&#39;: 0.18660142754964093, &#39;UGF&#39;: 0.00019166666666664556, &#39;CVS&#39;: 0.0004250000000000087}
{&#39;RMSE&#39;: 0.6832201142217881, &#39;DEE&#39;: 0.012466666666666654, &#39;VAL&#39;: 0.17845580133450958, &#39;UGF&#39;: 0.00016666666666667607, &#39;CVS&#39;: 0.0005499999999999949}
{&#39;RMSE&#39;: 0.6938836450573082, &#39;DEE&#39;: 0.012716666666666682, &#39;VAL&#39;: 0.17499607298075928, &#39;UGF&#39;: 4.166666666668983e-05, &#39;CVS&#39;: 0.00032499999999999196}
{&#39;RMSE&#39;: 0.7856401140827461, &#39;DEE&#39;: 0.00470000000000001, &#39;VAL&#39;: 0.23203744433583628, &#39;UGF&#39;: 0.0016333333333333477, &#39;CVS&#39;: 0.001366666666666655}
{&#39;RMSE&#39;: 0.7835545178404618, &#39;DEE&#39;: 0.0076833333333333476, &#39;VAL&#39;: 0.22803320192722268, &#39;UGF&#39;: 0.001758333333333334, &#39;CVS&#39;: 0.0008749999999999869}
{&#39;RMSE&#39;: 0.7866292590094013, &#39;DEE&#39;: 0.006083333333333357, &#39;VAL&#39;: 0.23135340622980244, &#39;UGF&#39;: 0.001375000000000015, &#39;CVS&#39;: 0.00030833333333332713}
{&#39;RMSE&#39;: 0.7702876717396616, &#39;DEE&#39;: 0.01795000000000002, &#39;VAL&#39;: 0.23573769919824103, &#39;UGF&#39;: 0.00330833333333333, &#39;CVS&#39;: 0.004041666666666666}
{&#39;RMSE&#39;: 0.7700274351377913, &#39;DEE&#39;: 0.01801666666666668, &#39;VAL&#39;: 0.2296288573835572, &#39;UGF&#39;: 0.0016583333333333172, &#39;CVS&#39;: 0.002141666666666653}
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">df_synthetic</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">df_synthetic</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span><span class="s1">&#39;Metrics&#39;</span><span class="p">]</span>
<span class="n">df_synthetic</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_synthetic</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Metrics&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_synthetic</span><span class="p">[</span><span class="s1">&#39;Metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_synthetic</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Model</th>
      <th>Algorithm</th>
      <th>RMSE</th>
      <th>DEE</th>
      <th>VAL</th>
      <th>UGF</th>
      <th>CVS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>PQ</td>
      <td>unfair</td>
      <td>0.684380</td>
      <td>0.012817</td>
      <td>0.185479</td>
      <td>0.000258</td>
      <td>0.000192</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PQ</td>
      <td>EqualExp</td>
      <td>0.674616</td>
      <td>0.012017</td>
      <td>0.200847</td>
      <td>0.000442</td>
      <td>0.000192</td>
    </tr>
    <tr>
      <th>2</th>
      <td>PQ</td>
      <td>VAL</td>
      <td>0.679315</td>
      <td>0.012683</td>
      <td>0.186601</td>
      <td>0.000192</td>
      <td>0.000425</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PQ</td>
      <td>UGF</td>
      <td>0.683220</td>
      <td>0.012467</td>
      <td>0.178456</td>
      <td>0.000167</td>
      <td>0.000550</td>
    </tr>
    <tr>
      <th>4</th>
      <td>PQ</td>
      <td>CVS</td>
      <td>0.693884</td>
      <td>0.012717</td>
      <td>0.174996</td>
      <td>0.000042</td>
      <td>0.000325</td>
    </tr>
    <tr>
      <th>5</th>
      <td>AE</td>
      <td>unfair</td>
      <td>0.785640</td>
      <td>0.004700</td>
      <td>0.232037</td>
      <td>0.001633</td>
      <td>0.001367</td>
    </tr>
    <tr>
      <th>6</th>
      <td>AE</td>
      <td>EqualExp</td>
      <td>0.783555</td>
      <td>0.007683</td>
      <td>0.228033</td>
      <td>0.001758</td>
      <td>0.000875</td>
    </tr>
    <tr>
      <th>7</th>
      <td>AE</td>
      <td>VAL</td>
      <td>0.786629</td>
      <td>0.006083</td>
      <td>0.231353</td>
      <td>0.001375</td>
      <td>0.000308</td>
    </tr>
    <tr>
      <th>8</th>
      <td>AE</td>
      <td>UGF</td>
      <td>0.770288</td>
      <td>0.017950</td>
      <td>0.235738</td>
      <td>0.003308</td>
      <td>0.004042</td>
    </tr>
    <tr>
      <th>9</th>
      <td>AE</td>
      <td>CVS</td>
      <td>0.770027</td>
      <td>0.018017</td>
      <td>0.229629</td>
      <td>0.001658</td>
      <td>0.002142</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">reload_ext</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;Sparsh A.&quot;</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">t</span> <span class="o">-</span><span class="n">d</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Author: Sparsh A.

Last updated: 2021-12-11 16:39:24

Compiler    : GCC 7.5.0
OS          : Linux
Release     : 5.4.104+
Machine     : x86_64
Processor   : x86_64
CPU cores   : 2
Architecture: 64bit

IPython   : 5.5.0
sys       : 3.7.12 (default, Sep 10 2021, 00:21:48) 
[GCC 7.5.0]
matplotlib: 3.2.2
torch     : 1.10.0+cu111
pandas    : 1.1.5
numpy     : 1.19.5

</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>END</strong></p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/2022/01/13/equal-experience.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
