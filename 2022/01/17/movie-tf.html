<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Recommendation Systems with TensorFlow | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Recommendation Systems with TensorFlow" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/17/movie-tf.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/17/movie-tf.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-17T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Recommendation Systems with TensorFlow" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-17T00:00:00-06:00","datePublished":"2022-01-17T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Recommendation Systems with TensorFlow","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/17/movie-tf.html"},"url":"https://nb.recohut.com/2022/01/17/movie-tf.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Recommendation Systems with TensorFlow</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-17T00:00:00-06:00" itemprop="datePublished">
        Jan 17, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      35 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-17-movie-tf.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-17-movie-tf.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-17-movie-tf.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-17-movie-tf.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-17-movie-tf.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This Colab notebook complements the course on <a href="https://developers.google.com/machine-learning/recommendation/">Recommendation Systems</a>. Specifically, we'll be using matrix factorization to learn user and movie embeddings.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Introduction</p>
<p>We will create a movie recommendation system based on the <a href="https://movielens.org/">MovieLens</a> dataset available <a href="http://grouplens.org/datasets/movielens/">here</a>.  The data consists of movies ratings (on a scale of 1 to 5).</p>
<h3 id="Outline">Outline<a class="anchor-link" href="#Outline"> </a></h3><ol>
<li>Exploring the MovieLens Data (10 minutes)</li>
<li>Preliminaries (25 minutes)</li>
<li>Training a matrix factorization model (15 minutes)</li>
<li>Inspecting the Embeddings (15 minutes)</li>
<li>Regularization in matrix factorization (15 minutes)</li>
<li>Softmax model training (30 minutes)</li>
</ol>
<h3 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h3><p>Let's get started by importing the required packages.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">sklearn.manifold</span>
<span class="kn">import</span> <span class="nn">tensorflow.compat.v1</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">tf</span><span class="o">.</span><span class="n">disable_v2_behavior</span><span class="p">()</span>
<span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="c1">## Add some convenience functions to Pandas DataFrame.</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns a filtered dataframe, by applying function to key&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">function</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">])]</span>

<span class="k">def</span> <span class="nf">flatten_cols</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
  <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">df</span>

<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">flatten_cols</span> <span class="o">=</span> <span class="n">flatten_cols</span>

<span class="c1">## Install Altair and activate its colab renderer.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installing Altair...&quot;</span><span class="p">)</span>
<span class="o">!</span>pip install git+git://github.com/altair-viz/altair.git
<span class="kn">import</span> <span class="nn">altair</span> <span class="k">as</span> <span class="nn">alt</span>
<span class="n">alt</span><span class="o">.</span><span class="n">data_transformers</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">alt</span><span class="o">.</span><span class="n">renderers</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="s1">&#39;colab&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done installing Altair.&quot;</span><span class="p">)</span>

<span class="c1">## Install spreadsheets and import authentication module.</span>
<span class="n">USER_RATINGS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="o">!</span>pip install --upgrade -q gspread
<span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">auth</span>
<span class="kn">import</span> <span class="nn">gspread</span>
<span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">GoogleCredentials</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We then download the MovieLens Data, and create DataFrames containing movies, users, and ratings.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">## Download MovieLens data.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading movielens data...&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="n">urlretrieve</span><span class="p">(</span><span class="s2">&quot;http://files.grouplens.org/datasets/movielens/ml-100k.zip&quot;</span><span class="p">,</span> <span class="s2">&quot;movielens.zip&quot;</span><span class="p">)</span>
<span class="n">zip_ref</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">&#39;movielens.zip&#39;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done. Dataset contains:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">zip_ref</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;ml-100k/u.info&#39;</span><span class="p">))</span>

<span class="c1">## Load each data set (users, movies, and ratings).</span>
<span class="n">users_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">,</span> <span class="s1">&#39;zip_code&#39;</span><span class="p">]</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;ml-100k/u.user&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">users_cols</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>

<span class="n">ratings_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;unix_timestamp&#39;</span><span class="p">]</span>
<span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;ml-100k/u.data&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">ratings_cols</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>

<span class="c1">## The movies file contains a binary feature for each genre.</span>
<span class="n">genre_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;genre_unknown&quot;</span><span class="p">,</span> <span class="s2">&quot;Action&quot;</span><span class="p">,</span> <span class="s2">&quot;Adventure&quot;</span><span class="p">,</span> <span class="s2">&quot;Animation&quot;</span><span class="p">,</span> <span class="s2">&quot;Children&quot;</span><span class="p">,</span> <span class="s2">&quot;Comedy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Crime&quot;</span><span class="p">,</span> <span class="s2">&quot;Documentary&quot;</span><span class="p">,</span> <span class="s2">&quot;Drama&quot;</span><span class="p">,</span> <span class="s2">&quot;Fantasy&quot;</span><span class="p">,</span> <span class="s2">&quot;Film-Noir&quot;</span><span class="p">,</span> <span class="s2">&quot;Horror&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Musical&quot;</span><span class="p">,</span> <span class="s2">&quot;Mystery&quot;</span><span class="p">,</span> <span class="s2">&quot;Romance&quot;</span><span class="p">,</span> <span class="s2">&quot;Sci-Fi&quot;</span><span class="p">,</span> <span class="s2">&quot;Thriller&quot;</span><span class="p">,</span> <span class="s2">&quot;War&quot;</span><span class="p">,</span> <span class="s2">&quot;Western&quot;</span>
<span class="p">]</span>
<span class="n">movies_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;movie_id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;release_date&#39;</span><span class="p">,</span> <span class="s2">&quot;video_release_date&quot;</span><span class="p">,</span> <span class="s2">&quot;imdb_url&quot;</span>
<span class="p">]</span> <span class="o">+</span> <span class="n">genre_cols</span>
<span class="n">movies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;ml-100k/u.item&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">movies_cols</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>

<span class="c1">## Since the ids start at 1, we shift them to start at 0.</span>
<span class="n">users</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">movies</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">movies</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;release_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c1">## Compute the number of movies to which a genre is assigned.</span>
<span class="n">genre_occurences</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="n">genre_cols</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

<span class="c1">## Since some movies can belong to more than one genre, we create different</span>
<span class="c1">## &#39;genre&#39; columns as follows:</span>
<span class="c1">## - all_genres: all the active genres of the movie.</span>
<span class="c1">## - genre: randomly sampled from the active genres.</span>
<span class="k">def</span> <span class="nf">mark_genres</span><span class="p">(</span><span class="n">movies</span><span class="p">,</span> <span class="n">genres</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get_random_genre</span><span class="p">(</span><span class="n">gs</span><span class="p">):</span>
    <span class="n">active</span> <span class="o">=</span> <span class="p">[</span><span class="n">genre</span> <span class="k">for</span> <span class="n">genre</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">genres</span><span class="p">,</span> <span class="n">gs</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;Other&#39;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">active</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_all_genres</span><span class="p">(</span><span class="n">gs</span><span class="p">):</span>
    <span class="n">active</span> <span class="o">=</span> <span class="p">[</span><span class="n">genre</span> <span class="k">for</span> <span class="n">genre</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">genres</span><span class="p">,</span> <span class="n">gs</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;Other&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">active</span><span class="p">)</span>
  <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;genre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="n">get_random_genre</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span> <span class="k">for</span> <span class="n">gs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">movies</span><span class="p">[</span><span class="n">genre</span><span class="p">]</span> <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">])]</span>
  <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;all_genres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="n">get_all_genres</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span> <span class="k">for</span> <span class="n">gs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">movies</span><span class="p">[</span><span class="n">genre</span><span class="p">]</span> <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">])]</span>

<span class="n">mark_genres</span><span class="p">(</span><span class="n">movies</span><span class="p">,</span> <span class="n">genre_cols</span><span class="p">)</span>

<span class="c1">## Create one merged DataFrame containing all the movielens data.</span>
<span class="n">movielens</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">movies</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;movie_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>

<span class="c1">## Utility to split the data into training and test sets.</span>
<span class="k">def</span> <span class="nf">split_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">holdout_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Splits a DataFrame into training and test sets.</span>
<span class="sd">  Args:</span>
<span class="sd">    df: a dataframe.</span>
<span class="sd">    holdout_fraction: fraction of dataframe rows to use in the test set.</span>
<span class="sd">  Returns:</span>
<span class="sd">    train: dataframe for training</span>
<span class="sd">    test: dataframe for testing</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="n">holdout_fraction</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
  <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="I.-Exploring-the-Movielens-Data">I. Exploring the Movielens Data<a class="anchor-link" href="#I.-Exploring-the-Movielens-Data"> </a></h2><p>Before we dive into model building, let's inspect our MovieLens dataset. It is usually helpful to understand the statistics of the dataset.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Users">Users<a class="anchor-link" href="#Users"> </a></h4><p>We start by printing some basic statistics describing the numeric user features.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">users</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also print some basic statistics describing the categorical user features</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">users</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also create histograms to further understand the distribution of the users. We use Altair to create an interactive chart.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">## The following functions are used to generate interactive Altair charts.</span>
<span class="c1">## We will display histograms of the data, sliced by a given attribute.</span>

<span class="c1">## Create filters to be used to slice the data.</span>
<span class="n">occupation_filter</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">selection_multi</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;occupation&quot;</span><span class="p">])</span>
<span class="n">occupation_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">()</span><span class="o">.</span><span class="n">mark_bar</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;count()&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s2">&quot;occupation:N&quot;</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span>
        <span class="n">occupation_filter</span><span class="p">,</span>
        <span class="n">alt</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;occupation:N&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;category20&#39;</span><span class="p">)),</span>
        <span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;lightgray&quot;</span><span class="p">)),</span>
<span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="n">occupation_filter</span><span class="p">)</span>

<span class="c1">## A function that generates a histogram of filtered data.</span>
<span class="k">def</span> <span class="nf">filtered_hist</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Creates a layered chart of histograms.</span>
<span class="sd">  The first layer (light gray) contains the histogram of the full data, and the</span>
<span class="sd">  second contains the histogram of the filtered data.</span>
<span class="sd">  Args:</span>
<span class="sd">    field: the field for which to generate the histogram.</span>
<span class="sd">    label: String label of the histogram.</span>
<span class="sd">    filter: an alt.Selection object to be used to filter the data.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">base</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">()</span><span class="o">.</span><span class="n">mark_bar</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
      <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">bin</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Bin</span><span class="p">(</span><span class="n">maxbins</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">label</span><span class="p">),</span>
      <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count()&quot;</span><span class="p">,</span>
  <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
      <span class="n">width</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span>
      <span class="n">base</span><span class="o">.</span><span class="n">transform_filter</span><span class="p">(</span><span class="nb">filter</span><span class="p">),</span>
      <span class="n">base</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;lightgray&#39;</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="o">.</span><span class="mi">7</span><span class="p">)),</span>
  <span class="p">)</span><span class="o">.</span><span class="n">resolve_scale</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;independent&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we look at the distribution of ratings per user. Clicking on an occupation in the right chart will filter the data by that occupation. The corresponding histogram is shown in blue, and superimposed with the histogram for the whole data (in light gray). You can use SHIFT+click to select multiple subsets.</p>
<p>What do you observe, and how might this affect the recommendations?</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">users_ratings</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ratings</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]})</span>
    <span class="o">.</span><span class="n">flatten_cols</span><span class="p">()</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">## Create a chart for the count, and one for the mean.</span>
<span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span>
    <span class="n">filtered_hist</span><span class="p">(</span><span class="s1">&#39;rating count&#39;</span><span class="p">,</span> <span class="s1">&#39;## ratings / user&#39;</span><span class="p">,</span> <span class="n">occupation_filter</span><span class="p">),</span>
    <span class="n">filtered_hist</span><span class="p">(</span><span class="s1">&#39;rating mean&#39;</span><span class="p">,</span> <span class="s1">&#39;mean user rating&#39;</span><span class="p">,</span> <span class="n">occupation_filter</span><span class="p">),</span>
    <span class="n">occupation_chart</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">users_ratings</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Movies">Movies<a class="anchor-link" href="#Movies"> </a></h4><p>It is also useful to look at information about the movies and their ratings.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movies_ratings</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">ratings</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;movie_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]})</span>
    <span class="o">.</span><span class="n">flatten_cols</span><span class="p">(),</span>
    <span class="n">on</span><span class="o">=</span><span class="s1">&#39;movie_id&#39;</span><span class="p">)</span>

<span class="n">genre_filter</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">selection_multi</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;genre&#39;</span><span class="p">])</span>
<span class="n">genre_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">()</span><span class="o">.</span><span class="n">mark_bar</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;count()&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;genre&#39;</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span>
        <span class="n">genre_filter</span><span class="p">,</span>
        <span class="n">alt</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;genre:N&quot;</span><span class="p">),</span>
        <span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;lightgray&#39;</span><span class="p">))</span>
<span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="n">genre_filter</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">movies_ratings</span><span class="p">[[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;rating count&#39;</span><span class="p">,</span> <span class="s1">&#39;rating mean&#39;</span><span class="p">]]</span>
 <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rating count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
 <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">movies_ratings</span><span class="p">[[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;rating count&#39;</span><span class="p">,</span> <span class="s1">&#39;rating mean&#39;</span><span class="p">]]</span>
 <span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="s1">&#39;rating count&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rating mean&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
 <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, the last chart shows the distribution of the number of ratings and average rating.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span>
    <span class="n">filtered_hist</span><span class="p">(</span><span class="s1">&#39;rating count&#39;</span><span class="p">,</span> <span class="s1">&#39;## ratings / movie&#39;</span><span class="p">,</span> <span class="n">genre_filter</span><span class="p">),</span>
    <span class="n">filtered_hist</span><span class="p">(</span><span class="s1">&#39;rating mean&#39;</span><span class="p">,</span> <span class="s1">&#39;mean movie rating&#39;</span><span class="p">,</span> <span class="n">genre_filter</span><span class="p">),</span>
    <span class="n">genre_chart</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">movies_ratings</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="II.-Preliminaries">II. Preliminaries<a class="anchor-link" href="#II.-Preliminaries"> </a></h2><p>Our goal is to factorize the ratings matrix $A$ into the product of a user embedding matrix $U$ and movie embedding matrix $V$, such that $A \approx UV^\top$ with
$U = \begin{bmatrix} u_{1} \\ \hline \vdots \\ \hline u_{N} \end{bmatrix}$ and
$V = \begin{bmatrix} v_{1} \\ \hline \vdots \\ \hline v_{M} \end{bmatrix}$.</p>
<p>Here</p>
<ul>
<li>$N$ is the number of users,</li>
<li>$M$ is the number of movies,</li>
<li>$A_{ij}$ is the rating of the $j$th movies by the $i$th user,</li>
<li>each row $U_i$ is a $d$-dimensional vector (embedding) representing user $i$,</li>
<li>each row $V_j$ is a $d$-dimensional vector (embedding) representing movie $j$,</li>
<li>the prediction of the model for the $(i, j)$ pair is the dot product $\langle U_i, V_j \rangle$.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Sparse-Representation-of-the-Rating-Matrix">Sparse Representation of the Rating Matrix<a class="anchor-link" href="#Sparse-Representation-of-the-Rating-Matrix"> </a></h3><p>The rating matrix could be very large and, in general, most of the entries are unobserved, since a given user will only rate a small subset of movies. For effcient representation, we will use a <a href="https://www.tensorflow.org/api_docs/python/tf/SparseTensor">tf.SparseTensor</a>. A <code>SparseTensor</code> uses three tensors to represent the matrix: <code>tf.SparseTensor(indices, values, dense_shape)</code> represents a tensor, where a value $A_{ij} = a$ is encoded by setting <code>indices[k] = [i, j]</code> and <code>values[k] = a</code>. The last tensor <code>dense_shape</code> is used to specify the shape of the full underlying matrix.</p>
<h5 id="Toy-example">Toy example<a class="anchor-link" href="#Toy-example"> </a></h5><p>Assume we have $2$ users and $4$ movies. Our toy ratings dataframe has three ratings,</p>
<table>
<thead><tr>
<th style="text-align:right">user_id</th>
<th style="text-align:right">movie_id</th>
<th style="text-align:right">rating</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">0</td>
<td style="text-align:right">0</td>
<td style="text-align:right">5.0</td>
</tr>
<tr>
<td style="text-align:right">0</td>
<td style="text-align:right">1</td>
<td style="text-align:right">3.0</td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td style="text-align:right">3</td>
<td style="text-align:right">1.0</td>
</tr>
</tbody>
</table>
<p>The corresponding rating matrix is</p>
$$
A =
\begin{bmatrix}
5.0 &amp; 3.0 &amp; 0 &amp; 0 \\
0   &amp;   0 &amp; 0 &amp; 1.0
\end{bmatrix}
$$<p>And the SparseTensor representation is,</p>
<div class="highlight"><pre><span></span><span class="n">SparseTensor</span><span class="p">(</span>
  <span class="n">indices</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span>
  <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
  <span class="n">dense_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Exercise-1:-Build-a-tf.SparseTensor-representation-of-the-Rating-Matrix.">Exercise 1: Build a tf.SparseTensor representation of the Rating Matrix.<a class="anchor-link" href="#Exercise-1:-Build-a-tf.SparseTensor-representation-of-the-Rating-Matrix."> </a></h4><p>In this exercise, we'll write a function that maps from our <code>ratings</code> DataFrame to a <code>tf.SparseTensor</code>.</p>
<p>Hint: you can select the values of a given column of a Dataframe <code>df</code> using <code>df['column_name'].values</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">build_rating_sparse_tensor</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>
<span class="sd">    ratings_df: a pd.DataFrame with `user_id`, `movie_id` and `rating` columns.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A tf.SparseTensor representing the ratings matrix.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">## ========================= Complete this section ============================</span>
  <span class="c1">## indices =</span>
  <span class="c1">## values =</span>
  <span class="c1">## ============================================================================</span>

  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">(</span>
      <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
      <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
      <span class="n">dense_shape</span><span class="o">=</span><span class="p">[</span><span class="n">users</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">movies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">build_rating_sparse_tensor</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>
<span class="sd">    ratings_df: a pd.DataFrame with `user_id`, `movie_id` and `rating` columns.</span>
<span class="sd">  Returns:</span>
<span class="sd">    a tf.SparseTensor representing the ratings matrix.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">indices</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
  <span class="n">values</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">(</span>
      <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
      <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
      <span class="n">dense_shape</span><span class="o">=</span><span class="p">[</span><span class="n">users</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">movies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Calculating-the-error">Calculating the error<a class="anchor-link" href="#Calculating-the-error"> </a></h3><p>The model approximates the ratings matrix $A$ by a low-rank product $UV^\top$. We need a way to measure the approximation error. We'll start by using the Mean Squared Error of observed entries only (we will revisit this later). It is defined as</p>
$$
\begin{align*}
\text{MSE}(A, UV^\top)
&amp;= \frac{1}{|\Omega|}\sum_{(i, j) \in\Omega}{( A_{ij} - (UV^\top)_{ij})^2} \\
&amp;= \frac{1}{|\Omega|}\sum_{(i, j) \in\Omega}{( A_{ij} - \langle U_i, V_j\rangle)^2}
\end{align*}
$$<p>where $\Omega$ is the set of observed ratings, and $|\Omega|$ is the cardinality of $\Omega$.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Exercise-2:-Mean-Squared-Error">Exercise 2: Mean Squared Error<a class="anchor-link" href="#Exercise-2:-Mean-Squared-Error"> </a></h4><p>Write a TensorFlow function that takes a sparse rating matrix $A$ and the two embedding matrices $U, V$ and returns the mean squared error $\text{MSE}(A, UV^\top)$.</p>
<p>Hints:</p>
<ul>
<li>in this section, we only consider observed entries when calculating the loss.</li>
<li>a <code>SparseTensor</code> <code>sp_x</code> is a tuple of three Tensors: <code>sp_x.indices</code>, <code>sp_x.values</code> and <code>sp_x.dense_shape</code>.</li>
<li>you may find <code>tf.gather_nd</code> and  <code>tf.losses.mean_squared_error</code> helpful.</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sparse_mean_square_error</span><span class="p">(</span><span class="n">sparse_ratings</span><span class="p">,</span> <span class="n">user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>
<span class="sd">    sparse_ratings: A SparseTensor rating matrix, of dense_shape [N, M]</span>
<span class="sd">    user_embeddings: A dense Tensor U of shape [N, k] where k is the embedding</span>
<span class="sd">      dimension, such that U_i is the embedding of user i.</span>
<span class="sd">    movie_embeddings: A dense Tensor V of shape [M, k] where k is the embedding</span>
<span class="sd">      dimension, such that V_j is the embedding of movie j.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A scalar Tensor representing the MSE between the true ratings and the</span>
<span class="sd">      model&#39;s predictions.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">## ========================= Complete this section ============================</span>
  <span class="c1">## loss =</span>
  <span class="c1">## ============================================================================</span>
  <span class="k">return</span> <span class="n">loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sparse_mean_square_error</span><span class="p">(</span><span class="n">sparse_ratings</span><span class="p">,</span> <span class="n">user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>
<span class="sd">    sparse_ratings: A SparseTensor rating matrix, of dense_shape [N, M]</span>
<span class="sd">    user_embeddings: A dense Tensor U of shape [N, k] where k is the embedding</span>
<span class="sd">      dimension, such that U_i is the embedding of user i.</span>
<span class="sd">    movie_embeddings: A dense Tensor V of shape [M, k] where k is the embedding</span>
<span class="sd">      dimension, such that V_j is the embedding of movie j.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A scalar Tensor representing the MSE between the true ratings and the</span>
<span class="sd">      model&#39;s predictions.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
      <span class="n">sparse_ratings</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
  <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">sparse_ratings</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note: One approach is to compute the full prediction matrix $UV^\top$, then gather the entries corresponding to the observed pairs. The memory cost of this approach is $O(NM)$. For the MovieLens dataset, this is fine, as the dense $N \times M$ matrix is small enough to fit in memory ($N = 943$, $M = 1682$).</p>
<p>Another approach (given in the alternate solution below) is to only gather the embeddings of the observed pairs, then compute their dot products. The memory cost is $O(|\Omega| d)$ where $d$ is the embedding dimension. In our case, $|\Omega| = 10^5$, and the embedding dimension is on the order of $10$, so the memory cost of both methods is comparable. But when the number of users or movies is much larger, the first approach becomes infeasible.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sparse_mean_square_error</span><span class="p">(</span><span class="n">sparse_ratings</span><span class="p">,</span> <span class="n">user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>
<span class="sd">    sparse_ratings: A SparseTensor rating matrix, of dense_shape [N, M]</span>
<span class="sd">    user_embeddings: A dense Tensor U of shape [N, k] where k is the embedding</span>
<span class="sd">      dimension, such that U_i is the embedding of user i.</span>
<span class="sd">    movie_embeddings: A dense Tensor V of shape [M, k] where k is the embedding</span>
<span class="sd">      dimension, such that V_j is the embedding of movie j.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A scalar Tensor representing the MSE between the true ratings and the</span>
<span class="sd">      model&#39;s predictions.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">user_embeddings</span><span class="p">,</span> <span class="n">sparse_ratings</span><span class="o">.</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">movie_embeddings</span><span class="p">,</span> <span class="n">sparse_ratings</span><span class="o">.</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
      <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">sparse_ratings</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Exercise-3-(Optional):-adding-your-own-ratings-to-the-data-set">Exercise 3 (Optional): adding your own ratings to the data set<a class="anchor-link" href="#Exercise-3-(Optional):-adding-your-own-ratings-to-the-data-set"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You have the option to add your own ratings to the data set. If you choose to do so, you will be able to see recommendations for yourself.</p>
<p>Start by checking the box below. Running the next cell will authenticate you to your google Drive account, and create a spreadsheet, that contains all movie titles in column 'A'. Follow the link to the spreadsheet and take 3 minutes to rate some of the movies. Your ratings should be entered in column 'B'.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">USER_RATINGS</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#@param {type:&quot;boolean&quot;}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">## Authenticate user.</span>
<span class="k">if</span> <span class="n">USER_RATINGS</span><span class="p">:</span>
  <span class="n">auth</span><span class="o">.</span><span class="n">authenticate_user</span><span class="p">()</span>
  <span class="n">gc</span> <span class="o">=</span> <span class="n">gspread</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">GoogleCredentials</span><span class="o">.</span><span class="n">get_application_default</span><span class="p">())</span>
  <span class="c1">## Create the spreadsheet and print a link to it.</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;MovieLens-test&#39;</span><span class="p">)</span>
  <span class="k">except</span><span class="p">(</span><span class="n">gspread</span><span class="o">.</span><span class="n">SpreadsheetNotFound</span><span class="p">):</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;MovieLens-test&#39;</span><span class="p">)</span>

  <span class="n">worksheet</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">sheet1</span>
  <span class="n">titles</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
  <span class="n">cell_list</span> <span class="o">=</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cell_list</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">title</span>
  <span class="n">worksheet</span><span class="o">.</span><span class="n">update_cells</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Link to the spreadsheet: &quot;</span>
        <span class="s2">&quot;https://docs.google.com/spreadsheets/d/</span><span class="si">{}</span><span class="s2">/edit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Run the next  cell to load your ratings and add them to the main <code>ratings</code> DataFrame.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">## Load the ratings from the spreadsheet and create a DataFrame.</span>
<span class="k">if</span> <span class="n">USER_RATINGS</span><span class="p">:</span>
  <span class="n">my_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">get_all_values</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
  <span class="n">my_ratings</span> <span class="o">=</span> <span class="n">my_ratings</span><span class="p">[</span><span class="n">my_ratings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
  <span class="n">my_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
      <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s2">&quot;943&quot;</span><span class="p">,</span>
      <span class="s1">&#39;movie_id&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">my_ratings</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])),</span>
      <span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">my_ratings</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
  <span class="p">})</span>
  <span class="c1">## Remove previous ratings.</span>
  <span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="s2">&quot;943&quot;</span><span class="p">]</span>
  <span class="c1">## Add new ratings.</span>
  <span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_ratings</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="c1">## Add new user to the users DataFrame.</span>
  <span class="k">if</span> <span class="n">users</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">943</span><span class="p">:</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">942</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">users</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">][</span><span class="mi">943</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;943&quot;</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Added your </span><span class="si">%d</span><span class="s2"> ratings; you have great taste!&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_ratings</span><span class="p">))</span>
  <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="o">.</span><span class="n">user_id</span><span class="o">==</span><span class="s2">&quot;943&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">movies</span><span class="p">[[</span><span class="s1">&#39;movie_id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="III.-Training-a-Matrix-Factorization-model">III. Training a Matrix Factorization model<a class="anchor-link" href="#III.-Training-a-Matrix-Factorization-model"> </a></h2><h3 id="CFModel-(Collaborative-Filtering-Model)-helper-class">CFModel (Collaborative Filtering Model) helper class<a class="anchor-link" href="#CFModel-(Collaborative-Filtering-Model)-helper-class"> </a></h3><p>This is a simple class to train a matrix factorization model using stochastic gradient descent.</p>
<p>The class constructor takes</p>
<ul>
<li>the user embeddings U (a <code>tf.Variable</code>).</li>
<li>the movie embeddings V, (a <code>tf.Variable</code>).</li>
<li>a loss to optimize (a <code>tf.Tensor</code>).</li>
<li>an optional list of metrics dictionaries, each mapping a string (the name of the metric) to a tensor. These are evaluated and plotted during training (e.g. training error and test error).</li>
</ul>
<p>After training, one can access the trained embeddings using the <code>model.embeddings</code> dictionary.</p>
<p>Example usage:</p>

<pre><code>U_var = ...
V_var = ...
loss = ...
model = CFModel(U_var, V_var, loss)
model.train(iterations=100, learning_rate=1.0)
user_embeddings = model.embeddings['user_id']
movie_embeddings = model.embeddings['movie_id']</code></pre>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CFModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Simple class that represents a collaborative filtering model&quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embedding_vars</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a CFModel.</span>
<span class="sd">    Args:</span>
<span class="sd">      embedding_vars: A dictionary of tf.Variables.</span>
<span class="sd">      loss: A float Tensor. The loss to optimize.</span>
<span class="sd">      metrics: optional list of dictionaries of Tensors. The metrics in each</span>
<span class="sd">        dictionary will be plotted in a separate figure during training.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_vars</span> <span class="o">=</span> <span class="n">embedding_vars</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_loss</span> <span class="o">=</span> <span class="n">loss</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span> <span class="o">=</span> <span class="n">metrics</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_embeddings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">embedding_vars</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The embeddings dictionary.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embeddings</span>

  <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">GradientDescentOptimizer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trains the model.</span>
<span class="sd">    Args:</span>
<span class="sd">      iterations: number of iterations to run.</span>
<span class="sd">      learning_rate: optimizer learning rate.</span>
<span class="sd">      plot_results: whether to plot the results at the end of training.</span>
<span class="sd">      optimizer: the optimizer to use. Default to GradientDescentOptimizer.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The metrics dictionary evaluated at the last iteration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
      <span class="n">opt</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">)</span>
      <span class="n">train_op</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loss</span><span class="p">)</span>
      <span class="n">local_init_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">group</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">variables_initializer</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">variables</span><span class="p">()),</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">local_variables_initializer</span><span class="p">())</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">tables_initializer</span><span class="p">())</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">start_queue_runners</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
      <span class="n">local_init_op</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
      <span class="n">iterations</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span> <span class="ow">or</span> <span class="p">({},)</span>
      <span class="n">metrics_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">]</span>

      <span class="c1">## Train and append results.</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">((</span><span class="n">train_op</span><span class="p">,</span> <span class="n">metrics</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">num_iterations</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2"> iteration </span><span class="si">%d</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">items</span><span class="p">()]),</span>
                <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
          <span class="n">iterations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">metric_val</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">metrics_vals</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
              <span class="n">metric_val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_embeddings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">plot_results</span><span class="p">:</span>
        <span class="c1">## Plot the metrics.</span>
        <span class="n">num_subplots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">num_subplots</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric_vals</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics_vals</span><span class="p">):</span>
          <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_subplots</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metric_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
          <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">])</span>
          <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">results</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Exercise-4:-Build-a-Matrix-Factorization-model-and-train-it">Exercise 4: Build a Matrix Factorization model and train it<a class="anchor-link" href="#Exercise-4:-Build-a-Matrix-Factorization-model-and-train-it"> </a></h4><p>Using your <code>sparse_mean_square_error</code> function, write a function that builds a <code>CFModel</code> by creating the embedding variables and the train and test losses.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">init_stddev</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>
<span class="sd">    ratings: a DataFrame of the ratings</span>
<span class="sd">    embedding_dim: the dimension of the embedding vectors.</span>
<span class="sd">    init_stddev: float, the standard deviation of the random initial embeddings.</span>
<span class="sd">  Returns:</span>
<span class="sd">    model: a CFModel.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">## Split the ratings DataFrame into train and test.</span>
  <span class="n">train_ratings</span><span class="p">,</span> <span class="n">test_ratings</span> <span class="o">=</span> <span class="n">split_dataframe</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
  <span class="c1">## SparseTensor representation of the train and test datasets.</span>
  <span class="c1">## ========================= Complete this section ============================</span>
  <span class="c1">## A_train =</span>
  <span class="c1">## A_test =</span>
  <span class="c1">## ============================================================================</span>
  <span class="c1">## Initialize the embeddings using a normal distribution.</span>
  <span class="n">U</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span>
      <span class="p">[</span><span class="n">A_train</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">embedding_dim</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="n">init_stddev</span><span class="p">))</span>
  <span class="n">V</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span>
      <span class="p">[</span><span class="n">A_train</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">embedding_dim</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="n">init_stddev</span><span class="p">))</span>
  <span class="c1">## ========================= Complete this section ============================</span>
  <span class="c1">## train_loss =</span>
  <span class="c1">## test_loss =</span>
  <span class="c1">## ============================================================================</span>
  <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;train_error&#39;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span>
      <span class="s1">&#39;test_error&#39;</span><span class="p">:</span> <span class="n">test_loss</span>
  <span class="p">}</span>
  <span class="n">embeddings</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">U</span><span class="p">,</span>
      <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">V</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">CFModel</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="p">[</span><span class="n">metrics</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">init_stddev</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>
<span class="sd">    ratings: a DataFrame of the ratings</span>
<span class="sd">    embedding_dim: the dimension of the embedding vectors.</span>
<span class="sd">    init_stddev: float, the standard deviation of the random initial embeddings.</span>
<span class="sd">  Returns:</span>
<span class="sd">    model: a CFModel.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">## Split the ratings DataFrame into train and test.</span>
  <span class="n">train_ratings</span><span class="p">,</span> <span class="n">test_ratings</span> <span class="o">=</span> <span class="n">split_dataframe</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
  <span class="c1">## SparseTensor representation of the train and test datasets.</span>
  <span class="n">A_train</span> <span class="o">=</span> <span class="n">build_rating_sparse_tensor</span><span class="p">(</span><span class="n">train_ratings</span><span class="p">)</span>
  <span class="n">A_test</span> <span class="o">=</span> <span class="n">build_rating_sparse_tensor</span><span class="p">(</span><span class="n">test_ratings</span><span class="p">)</span>
  <span class="c1">## Initialize the embeddings using a normal distribution.</span>
  <span class="n">U</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span>
      <span class="p">[</span><span class="n">A_train</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">embedding_dim</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="n">init_stddev</span><span class="p">))</span>
  <span class="n">V</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span>
      <span class="p">[</span><span class="n">A_train</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">embedding_dim</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="n">init_stddev</span><span class="p">))</span>
  <span class="n">train_loss</span> <span class="o">=</span> <span class="n">sparse_mean_square_error</span><span class="p">(</span><span class="n">A_train</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
  <span class="n">test_loss</span> <span class="o">=</span> <span class="n">sparse_mean_square_error</span><span class="p">(</span><span class="n">A_test</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
  <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;train_error&#39;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span>
      <span class="s1">&#39;test_error&#39;</span><span class="p">:</span> <span class="n">test_loss</span>
  <span class="p">}</span>
  <span class="n">embeddings</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">U</span><span class="p">,</span>
      <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">V</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">CFModel</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="p">[</span><span class="n">metrics</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Great, now it's time to train the model!</p>
<p>Go ahead and run the next cell, trying different parameters (embedding dimension, learning rate, iterations). The training and test errors are plotted at the end of training. You can inspect these values to validate the hyper-parameters.</p>
<p>Note: by calling <code>model.train</code> again, the model will continue training starting from the current values of the embeddings.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">init_stddev</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The movie and user embeddings are also displayed in the right figure. When the embedding dimension is greater than 3, the embeddings are projected on the first 3 dimensions. The next section will have a more detailed look at the embeddings.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="IV.-Inspecting-the-Embeddings">IV. Inspecting the Embeddings<a class="anchor-link" href="#IV.-Inspecting-the-Embeddings"> </a></h2><p>In this section, we take a closer look at the learned embeddings, by</p>
<ul>
<li>computing your recommendations</li>
<li>looking at the nearest neighbors of some movies,</li>
<li>looking at the norms of the movie embeddings,</li>
<li>visualizing the embedding in a projected embedding space.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Exercise-5:-Write-a-function-that-computes-the-scores-of-the-candidates">Exercise 5: Write a function that computes the scores of the candidates<a class="anchor-link" href="#Exercise-5:-Write-a-function-that-computes-the-scores-of-the-candidates"> </a></h4><p>We start by writing a function that, given a query embedding $u \in \mathbb R^d$ and item embeddings $V \in \mathbb R^{N \times d}$, computes the item scores.</p>
<p>As discussed in the lecture, there are different similarity measures we can use, and these can yield different results. We will compare the following:</p>
<ul>
<li>dot product: the score of item j is $\langle u, V_j \rangle$.</li>
<li>cosine: the score of item j is $\frac{\langle u, V_j \rangle}{\|u\|\|V_j\|}$.</li>
</ul>
<p>Hints:</p>
<ul>
<li>you can use <code>np.dot</code> to compute the product of two np.Arrays.</li>
<li>you can use <code>np.linalg.norm</code> to compute the norm of a np.Array.</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DOT</span> <span class="o">=</span> <span class="s1">&#39;dot&#39;</span>
<span class="n">COSINE</span> <span class="o">=</span> <span class="s1">&#39;cosine&#39;</span>
<span class="k">def</span> <span class="nf">compute_scores</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="n">item_embeddings</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">DOT</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes the scores of the candidates given a query.</span>
<span class="sd">  Args:</span>
<span class="sd">    query_embedding: a vector of shape [k], representing the query embedding.</span>
<span class="sd">    item_embeddings: a matrix of shape [N, k], such that row i is the embedding</span>
<span class="sd">      of item i.</span>
<span class="sd">    measure: a string specifying the similarity measure to be used. Can be</span>
<span class="sd">      either DOT or COSINE.</span>
<span class="sd">  Returns:</span>
<span class="sd">    scores: a vector of shape [N], such that scores[i] is the score of item i.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">## ========================= Complete this section ============================</span>
  <span class="c1">## scores =</span>
  <span class="c1">## ============================================================================</span>
  <span class="k">return</span> <span class="n">scores</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DOT</span> <span class="o">=</span> <span class="s1">&#39;dot&#39;</span>
<span class="n">COSINE</span> <span class="o">=</span> <span class="s1">&#39;cosine&#39;</span>
<span class="k">def</span> <span class="nf">compute_scores</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="n">item_embeddings</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">DOT</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes the scores of the candidates given a query.</span>
<span class="sd">  Args:</span>
<span class="sd">    query_embedding: a vector of shape [k], representing the query embedding.</span>
<span class="sd">    item_embeddings: a matrix of shape [N, k], such that row i is the embedding</span>
<span class="sd">      of item i.</span>
<span class="sd">    measure: a string specifying the similarity measure to be used. Can be</span>
<span class="sd">      either DOT or COSINE.</span>
<span class="sd">  Returns:</span>
<span class="sd">    scores: a vector of shape [N], such that scores[i] is the score of item i.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">u</span> <span class="o">=</span> <span class="n">query_embedding</span>
  <span class="n">V</span> <span class="o">=</span> <span class="n">item_embeddings</span>
  <span class="k">if</span> <span class="n">measure</span> <span class="o">==</span> <span class="n">COSINE</span><span class="p">:</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
  <span class="n">scores</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">scores</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Equipped with this function, we can compute recommendations, where the query embedding can be either a user embedding or a movie embedding.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">user_recommendations</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">DOT</span><span class="p">,</span> <span class="n">exclude_rated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">USER_RATINGS</span><span class="p">:</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">compute_scores</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">][</span><span class="mi">943</span><span class="p">],</span> <span class="n">model</span><span class="o">.</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">],</span> <span class="n">measure</span><span class="p">)</span>
    <span class="n">score_key</span> <span class="o">=</span> <span class="n">measure</span> <span class="o">+</span> <span class="s1">&#39; score&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="n">score_key</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
        <span class="s1">&#39;movie_id&#39;</span><span class="p">:</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;movie_id&#39;</span><span class="p">],</span>
        <span class="s1">&#39;titles&#39;</span><span class="p">:</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
        <span class="s1">&#39;genres&#39;</span><span class="p">:</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;all_genres&#39;</span><span class="p">],</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="n">exclude_rated</span><span class="p">:</span>
      <span class="c1">## remove movies that are already rated</span>
      <span class="n">rated_movies</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">ratings</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="s2">&quot;943&quot;</span><span class="p">][</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
      <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">movie_id</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">movie_id</span><span class="p">:</span> <span class="n">movie_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rated_movies</span><span class="p">)]</span>
    <span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">score_key</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>  

<span class="k">def</span> <span class="nf">movie_neighbors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">title_substring</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">DOT</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
  <span class="c1">## Search for movie ids that match the given substring.</span>
  <span class="n">ids</span> <span class="o">=</span>  <span class="n">movies</span><span class="p">[</span><span class="n">movies</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">title_substring</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
  <span class="n">titles</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ids</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found no movies with title </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">title_substring</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nearest neighbors of : </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">titles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Found more than one matching movie. Other candidates: </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
  <span class="n">movie_id</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">scores</span> <span class="o">=</span> <span class="n">compute_scores</span><span class="p">(</span>
      <span class="n">model</span><span class="o">.</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">][</span><span class="n">movie_id</span><span class="p">],</span> <span class="n">model</span><span class="o">.</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">],</span>
      <span class="n">measure</span><span class="p">)</span>
  <span class="n">score_key</span> <span class="o">=</span> <span class="n">measure</span> <span class="o">+</span> <span class="s1">&#39; score&#39;</span>
  <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
      <span class="n">score_key</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
      <span class="s1">&#39;titles&#39;</span><span class="p">:</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
      <span class="s1">&#39;genres&#39;</span><span class="p">:</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;all_genres&#39;</span><span class="p">]</span>
  <span class="p">})</span>
  <span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">score_key</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Your-recommendations">Your recommendations<a class="anchor-link" href="#Your-recommendations"> </a></h4><p>If you chose to input your recommendations, you can run the next cell to generate recommendations for you.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user_recommendations</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">COSINE</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>How do the recommendations look?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Movie-Nearest-neighbors">Movie Nearest neighbors<a class="anchor-link" href="#Movie-Nearest-neighbors"> </a></h4><p>Let's look at the neareast neighbors for some of the movies.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_neighbors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;Aladdin&quot;</span><span class="p">,</span> <span class="n">DOT</span><span class="p">)</span>
<span class="n">movie_neighbors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;Aladdin&quot;</span><span class="p">,</span> <span class="n">COSINE</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It seems that the quality of learned embeddings may not be very good. This will be addressed in Section V by adding several regularization techniques. First, we will further inspect the embeddings.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Movie-Embedding-Norm">Movie Embedding Norm<a class="anchor-link" href="#Movie-Embedding-Norm"> </a></h3><p>We can also observe that the recommendations with dot-product and cosine are different: with dot-product, the model tends to recommend popular movies. This can be explained by the fact that in matrix factorization models, the norm of the embedding is often correlated with popularity (popular movies have a larger norm), which makes it more likely to recommend more popular items. We can confirm this hypothesis by sorting the movies by their embedding norm, as done in the next cell.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">movie_embedding_norm</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Visualizes the norm and number of ratings of the movie embeddings.</span>
<span class="sd">  Args:</span>
<span class="sd">    model: A MFModel object.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="p">]</span>
  <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
      <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
      <span class="s1">&#39;genre&#39;</span><span class="p">:</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;genre&#39;</span><span class="p">],</span>
      <span class="s1">&#39;num_ratings&#39;</span><span class="p">:</span> <span class="n">movies_ratings</span><span class="p">[</span><span class="s1">&#39;rating count&#39;</span><span class="p">],</span>
  <span class="p">})</span>
  <span class="n">charts</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">brush</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">selection_interval</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
    <span class="n">norm_key</span> <span class="o">=</span> <span class="s1">&#39;norm&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nearest</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">encodings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">empty</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">()</span><span class="o">.</span><span class="n">mark_circle</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;num_ratings&#39;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">norm_key</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">brush</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;#4c78a8&#39;</span><span class="p">),</span> <span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;lightgray&#39;</span><span class="p">))</span>
    <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
        <span class="n">selection</span><span class="o">=</span><span class="n">nearest</span><span class="p">)</span><span class="o">.</span><span class="n">add_selection</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">()</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dy</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;num_ratings&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">norm_key</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">nearest</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)))</span>
    <span class="n">charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="o">*</span><span class="n">charts</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">visualize_movie_embeddings</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="n">nearest</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span>
      <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">encodings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">empty</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
  <span class="n">base</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">()</span><span class="o">.</span><span class="n">mark_circle</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
      <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
      <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
      <span class="n">color</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">genre_filter</span><span class="p">,</span> <span class="s2">&quot;genre&quot;</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;whitesmoke&quot;</span><span class="p">)),</span>
  <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
      <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
      <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
      <span class="n">selection</span><span class="o">=</span><span class="n">nearest</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">()</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dy</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
      <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
      <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
      <span class="n">text</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">nearest</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">text</span><span class="p">),</span> <span class="n">genre_chart</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tsne_movie_embeddings</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Visualizes the movie embeddings, projected using t-SNE with Cosine measure.</span>
<span class="sd">  Args:</span>
<span class="sd">    model: A MFModel object.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">tsne</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">manifold</span><span class="o">.</span><span class="n">TSNE</span><span class="p">(</span>
      <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">early_exaggeration</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
      <span class="n">init</span><span class="o">=</span><span class="s1">&#39;pca&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running t-SNE...&#39;</span><span class="p">)</span>
  <span class="n">V_proj</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">])</span>
  <span class="n">movies</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V_proj</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="n">movies</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V_proj</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">visualize_movie_embeddings</span><span class="p">(</span><span class="n">movies</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_embedding_norm</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note: Depending on how the model is initialized, you may observe that some niche movies (ones with few ratings) have a high norm, leading to spurious recommendations. This can happen if the embedding of that movie happens to be initialized with a high norm. Then, because the movie has few ratings, it is infrequently updated, and can keep its high norm. This will be alleviated by using regularization.</p>
<p>Try changing the value of the hyper-parameter <code>init_stddev</code>. One quantity that can be helpful is that the expected norm of a $d$-dimensional vector with entries $\sim \mathcal N(0, \sigma^2)$ is approximatley $\sigma \sqrt d$.</p>
<p>How does this affect the embedding norm distribution, and the ranking of the top-norm movies?</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_lowinit</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">init_stddev</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">model_lowinit</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
<span class="n">movie_neighbors</span><span class="p">(</span><span class="n">model_lowinit</span><span class="p">,</span> <span class="s2">&quot;Aladdin&quot;</span><span class="p">,</span> <span class="n">DOT</span><span class="p">)</span>
<span class="n">movie_neighbors</span><span class="p">(</span><span class="n">model_lowinit</span><span class="p">,</span> <span class="s2">&quot;Aladdin&quot;</span><span class="p">,</span> <span class="n">COSINE</span><span class="p">)</span>
<span class="n">movie_embedding_norm</span><span class="p">([</span><span class="n">model</span><span class="p">,</span> <span class="n">model_lowinit</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Embedding-visualization">Embedding visualization<a class="anchor-link" href="#Embedding-visualization"> </a></h3><p>Since it is hard to visualize embeddings in a higher-dimensional space (when the embedding dimension $k &gt; 3$), one approach is to project the embeddings to a lower dimensional space. T-SNE (T-distributed Stochastic Neighbor Embedding) is an algorithm that projects the embeddings while attempting to preserve their pariwise distances. It can be useful for visualization, but one should use it with care. For more information on using t-SNE, see <a href="https://distill.pub/2016/misread-tsne/">How to Use t-SNE Effectively</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tsne_movie_embeddings</span><span class="p">(</span><span class="n">model_lowinit</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can highlight the embeddings of a given genre by clicking on the genres panel (SHIFT+click to select multiple genres).</p>
<p>We can observe that the embeddings do not seem to have any notable structure, and the embeddings of a given genre are located all over the embedding space. This confirms the poor quality of the learned embeddings. One of the main reasons, which we will address in the next section, is that we only trained the model on observed pairs, and without regularization.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="V.-Regularization-In-Matrix-Factorization">V. Regularization In Matrix Factorization<a class="anchor-link" href="#V.-Regularization-In-Matrix-Factorization"> </a></h2><p>In the previous section, our loss was defined as the mean squared error on the observed part of the rating matrix.  As discussed in the lecture, this can be problematic as the model does not learn how to place the embeddings of irrelevant movies. This phenomenon is known as <em>folding</em>.</p>
<p>We will add regularization terms that will address this issue. We will use two types of regularization:</p>
<ul>
<li>Regularization of the model parameters. This is a common $\ell_2$ regularization term on the embedding matrices, given by $r(U, V) =  \frac{1}{N} \sum_i \|U_i\|^2 + \frac{1}{M}\sum_j \|V_j\|^2$.</li>
<li>A global prior that pushes the prediction of any pair towards zero, called the <em>gravity</em> term. This is given by $g(U, V) = \frac{1}{MN} \sum_{i = 1}^N \sum_{j = 1}^M \langle U_i, V_j \rangle^2$.</li>
</ul>
<p>The total loss is then given by
$$
\frac{1}{|\Omega|}\sum_{(i, j) \in \Omega} (A_{ij} - \langle U_i, V_j\rangle)^2 + \lambda _r r(U, V) + \lambda_g g(U, V)
$$
where $\lambda_r$ and $\lambda_g$ are two regularization coefficients (hyper-parameters).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Exercise-6:-Build-a-regularized-Matrix-Factorization-model-and-train-it">Exercise 6: Build a regularized Matrix Factorization model and train it<a class="anchor-link" href="#Exercise-6:-Build-a-regularized-Matrix-Factorization-model-and-train-it"> </a></h4><p>Write a function that builds a regularized model. You are given a function <code>gravity(U, V)</code> that computes the gravity term given the two embedding matrices $U$ and $V$.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">gravity</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Creates a gravity loss given two embedding matrices.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">transpose_a</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">transpose_a</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">build_regularized_model</span><span class="p">(</span>
    <span class="n">ratings</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">regularization_coeff</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">gravity_coeff</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
    <span class="n">init_stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>
<span class="sd">    ratings: the DataFrame of movie ratings.</span>
<span class="sd">    embedding_dim: The dimension of the embedding space.</span>
<span class="sd">    regularization_coeff: The regularization coefficient lambda.</span>
<span class="sd">    gravity_coeff: The gravity regularization coefficient lambda_g.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A CFModel object that uses a regularized loss.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">## Split the ratings DataFrame into train and test.</span>
  <span class="n">train_ratings</span><span class="p">,</span> <span class="n">test_ratings</span> <span class="o">=</span> <span class="n">split_dataframe</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
  <span class="c1">## SparseTensor representation of the train and test datasets.</span>
  <span class="n">A_train</span> <span class="o">=</span> <span class="n">build_rating_sparse_tensor</span><span class="p">(</span><span class="n">train_ratings</span><span class="p">)</span>
  <span class="n">A_test</span> <span class="o">=</span> <span class="n">build_rating_sparse_tensor</span><span class="p">(</span><span class="n">test_ratings</span><span class="p">)</span>
  <span class="n">U</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span>
      <span class="p">[</span><span class="n">A_train</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">embedding_dim</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="n">init_stddev</span><span class="p">))</span>
  <span class="n">V</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span>
      <span class="p">[</span><span class="n">A_train</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">embedding_dim</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="n">init_stddev</span><span class="p">))</span>

  <span class="c1">## ========================= Complete this section ============================</span>
  <span class="c1">## error_train =</span>
  <span class="c1">## error_test =</span>
  <span class="c1">## gravity_loss =</span>
  <span class="c1">## regularization_loss =</span>
  <span class="c1">## ============================================================================</span>
  <span class="n">total_loss</span> <span class="o">=</span> <span class="n">error_train</span> <span class="o">+</span> <span class="n">regularization_loss</span> <span class="o">+</span> <span class="n">gravity_loss</span>
  <span class="n">losses</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;train_error&#39;</span><span class="p">:</span> <span class="n">error_train</span><span class="p">,</span>
      <span class="s1">&#39;test_error&#39;</span><span class="p">:</span> <span class="n">error_test</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">loss_components</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;observed_loss&#39;</span><span class="p">:</span> <span class="n">error_train</span><span class="p">,</span>
      <span class="s1">&#39;regularization_loss&#39;</span><span class="p">:</span> <span class="n">regularization_loss</span><span class="p">,</span>
      <span class="s1">&#39;gravity_loss&#39;</span><span class="p">:</span> <span class="n">gravity_loss</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">embeddings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">U</span><span class="p">,</span> <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">V</span><span class="p">}</span>

  <span class="k">return</span> <span class="n">CFModel</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">,</span> <span class="p">[</span><span class="n">losses</span><span class="p">,</span> <span class="n">loss_components</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">gravity</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Creates a gravity loss given two embedding matrices.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">transpose_a</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">transpose_a</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">build_regularized_model</span><span class="p">(</span>
    <span class="n">ratings</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">regularization_coeff</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">gravity_coeff</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
    <span class="n">init_stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>
<span class="sd">    ratings: the DataFrame of movie ratings.</span>
<span class="sd">    embedding_dim: The dimension of the embedding space.</span>
<span class="sd">    regularization_coeff: The regularization coefficient lambda.</span>
<span class="sd">    gravity_coeff: The gravity regularization coefficient lambda_g.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A CFModel object that uses a regularized loss.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">## Split the ratings DataFrame into train and test.</span>
  <span class="n">train_ratings</span><span class="p">,</span> <span class="n">test_ratings</span> <span class="o">=</span> <span class="n">split_dataframe</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
  <span class="c1">## SparseTensor representation of the train and test datasets.</span>
  <span class="n">A_train</span> <span class="o">=</span> <span class="n">build_rating_sparse_tensor</span><span class="p">(</span><span class="n">train_ratings</span><span class="p">)</span>
  <span class="n">A_test</span> <span class="o">=</span> <span class="n">build_rating_sparse_tensor</span><span class="p">(</span><span class="n">test_ratings</span><span class="p">)</span>
  <span class="n">U</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span>
      <span class="p">[</span><span class="n">A_train</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">embedding_dim</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="n">init_stddev</span><span class="p">))</span>
  <span class="n">V</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span>
      <span class="p">[</span><span class="n">A_train</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">embedding_dim</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="n">init_stddev</span><span class="p">))</span>

  <span class="n">error_train</span> <span class="o">=</span> <span class="n">sparse_mean_square_error</span><span class="p">(</span><span class="n">A_train</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
  <span class="n">error_test</span> <span class="o">=</span> <span class="n">sparse_mean_square_error</span><span class="p">(</span><span class="n">A_test</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
  <span class="n">gravity_loss</span> <span class="o">=</span> <span class="n">gravity_coeff</span> <span class="o">*</span> <span class="n">gravity</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
  <span class="n">regularization_loss</span> <span class="o">=</span> <span class="n">regularization_coeff</span> <span class="o">*</span> <span class="p">(</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">U</span><span class="o">*</span><span class="n">U</span><span class="p">)</span><span class="o">/</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">V</span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
  <span class="n">total_loss</span> <span class="o">=</span> <span class="n">error_train</span> <span class="o">+</span> <span class="n">regularization_loss</span> <span class="o">+</span> <span class="n">gravity_loss</span>
  <span class="n">losses</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;train_error_observed&#39;</span><span class="p">:</span> <span class="n">error_train</span><span class="p">,</span>
      <span class="s1">&#39;test_error_observed&#39;</span><span class="p">:</span> <span class="n">error_test</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">loss_components</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;observed_loss&#39;</span><span class="p">:</span> <span class="n">error_train</span><span class="p">,</span>
      <span class="s1">&#39;regularization_loss&#39;</span><span class="p">:</span> <span class="n">regularization_loss</span><span class="p">,</span>
      <span class="s1">&#39;gravity_loss&#39;</span><span class="p">:</span> <span class="n">gravity_loss</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">embeddings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">U</span><span class="p">,</span> <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">V</span><span class="p">}</span>

  <span class="k">return</span> <span class="n">CFModel</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">,</span> <span class="p">[</span><span class="n">losses</span><span class="p">,</span> <span class="n">loss_components</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It is now time to train the regularized model! You can try different values of the regularization coefficients, and different embedding dimensions.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reg_model</span> <span class="o">=</span> <span class="n">build_regularized_model</span><span class="p">(</span>
    <span class="n">ratings</span><span class="p">,</span> <span class="n">regularization_coeff</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">gravity_coeff</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span>
    <span class="n">init_stddev</span><span class="o">=.</span><span class="mi">05</span><span class="p">)</span>
<span class="n">reg_model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_iterations</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Observe that adding the regularization terms results in a higher MSE, both on the training and test set. However, as we will see, the quality of the recommendations improves. This highlights a tension between fitting the observed data and minimizing the regularization terms. Fitting the observed data often emphasizes learning high similarity (between items with many interactions), but a good embedding representation also requires learning low similarity (between items with few or no interactions).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Inspect-the-results">Inspect the results<a class="anchor-link" href="#Inspect-the-results"> </a></h4><p>Let's see if the results with regularization look better.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user_recommendations</span><span class="p">(</span><span class="n">reg_model</span><span class="p">,</span> <span class="n">DOT</span><span class="p">,</span> <span class="n">exclude_rated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Hopefully, these recommendations look better. You can change the similarity measure from COSINE to DOT and observe how this affects the recommendations.</p>
<p>Since the model is likely to recommend items that you rated highly, you have the option to exclude the items you rated, using <code>exclude_rated=True</code>.</p>
<p>In the following cells, we display the nearest neighbors, the embedding norms, and the t-SNE projection of the movie embeddings.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_neighbors</span><span class="p">(</span><span class="n">reg_model</span><span class="p">,</span> <span class="s2">&quot;Aladdin&quot;</span><span class="p">,</span> <span class="n">DOT</span><span class="p">)</span>
<span class="n">movie_neighbors</span><span class="p">(</span><span class="n">reg_model</span><span class="p">,</span> <span class="s2">&quot;Aladdin&quot;</span><span class="p">,</span> <span class="n">COSINE</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here we compare the embedding norms for <code>model</code> and <code>reg_model</code>. Selecting a subset of the embeddings will highlight them on both charts simultaneously.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_embedding_norm</span><span class="p">([</span><span class="n">model</span><span class="p">,</span> <span class="n">model_lowinit</span><span class="p">,</span> <span class="n">reg_model</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tsne_movie_embeddings</span><span class="p">(</span><span class="n">reg_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We should observe that the embeddings have a lot more structure than the unregularized case. Try selecting different genres and observe how they tend to form clusters (for example Horror, Animation and Children).</p>
<h4 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion"> </a></h4><p>This concludes this section on matrix factorization models. Note that while the scale of the problem is small enough to allow efficient training using SGD, many practical problems need to be trained using more specialized algorithms such as Alternating Least Squares (see <a href="https://www.tensorflow.org/api_docs/python/tf/contrib/factorization/WALSMatrixFactorization">tf.contrib.factorization.WALSMatrixFactorization</a> for a TF implementation).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="VI.-Softmax-model">VI. Softmax model<a class="anchor-link" href="#VI.-Softmax-model"> </a></h2><p>In this section, we will train a simple softmax model that predicts whether a given user has rated a movie.</p>
<p><strong>Note</strong>: if you are taking the self-study version of the class, make sure to read through the part of the class covering Softmax training before working on this part.</p>
<p>The model will take as input a feature vector $x$ representing the list of movies the user has rated. We start from the ratings DataFrame, which we group by user_id.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rated_movies</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratings</span><span class="p">[[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;movie_id&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="n">rated_movies</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We then create a function that generates an example batch, such that each example contains the following features:</p>
<ul>
<li>movie_id: A tensor of strings of the movie ids that the user rated.</li>
<li>genre: A tensor of strings of the genres of those movies</li>
<li>year: A tensor of strings of the release year.</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">years_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">movie</span><span class="p">:</span> <span class="n">year</span> <span class="k">for</span> <span class="n">movie</span><span class="p">,</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">movies</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">],</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>
<span class="p">}</span>
<span class="n">genres_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">movie</span><span class="p">:</span> <span class="n">genres</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">movie</span><span class="p">,</span> <span class="n">genres</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">movies</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">],</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;all_genres&quot;</span><span class="p">])</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">make_batch</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Creates a batch of examples.</span>
<span class="sd">  Args:</span>
<span class="sd">    ratings: A DataFrame of ratings such that examples[&quot;movie_id&quot;] is a list of</span>
<span class="sd">      movies rated by a user.</span>
<span class="sd">    batch_size: The batch size.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fill</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">fill</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

  <span class="n">movie</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">year</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">genre</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">movie_ids</span> <span class="ow">in</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="n">movie</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">movie_ids</span><span class="p">)</span>
    <span class="n">genre</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">movie_id</span> <span class="ow">in</span> <span class="n">movie_ids</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">genres_dict</span><span class="p">[</span><span class="n">movie_id</span><span class="p">]])</span>
    <span class="n">year</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">years_dict</span><span class="p">[</span><span class="n">movie_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">movie_id</span> <span class="ow">in</span> <span class="n">movie_ids</span><span class="p">])</span>
    <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">movie_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">movie_id</span> <span class="ow">in</span> <span class="n">movie_ids</span><span class="p">])</span>
  <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">movie</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
      <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
      <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
      <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">batch</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
      <span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
      <span class="o">.</span><span class="n">repeat</span><span class="p">()</span>
      <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
      <span class="o">.</span><span class="n">make_one_shot_iterator</span><span class="p">()</span>
      <span class="o">.</span><span class="n">get_next</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">batch</span>

<span class="k">def</span> <span class="nf">select_random</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Selectes a random elements from each row of x.&quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">to_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
  <span class="n">batch_size</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">rn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
  <span class="n">nnz</span> <span class="o">=</span> <span class="n">to_float</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">rnd</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">([</span><span class="n">batch_size</span><span class="p">])</span>
  <span class="n">ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">to_int</span><span class="p">(</span><span class="n">rn</span><span class="p">),</span> <span class="n">to_int</span><span class="p">(</span><span class="n">nnz</span> <span class="o">*</span> <span class="n">rnd</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">to_int</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ids</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Loss-function">Loss function<a class="anchor-link" href="#Loss-function"> </a></h4><p>Recall that the softmax model maps the input features $x$ to a user embedding $\psi(x) \in \mathbb R^d$, where $d$ is the embedding dimension. This vector is then multiplied by a movie embedding matrix $V \in \mathbb R^{m \times d}$ (where $m$ is the number of movies), and the final output of the model is the softmax of the product
$$
\hat p(x) = \text{softmax}(\psi(x) V^\top).
$$
Given a target label $y$, if we denote by $p = 1_y$ a one-hot encoding of this target label, then the loss is the cross-entropy between $\hat p(x)$ and $p$.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Exercise-7:-Write-a-loss-function-for-the-softmax-model.">Exercise 7: Write a loss function for the softmax model.<a class="anchor-link" href="#Exercise-7:-Write-a-loss-function-for-the-softmax-model."> </a></h4><p>In this exercise, we will write a function that takes tensors representing the user embeddings $\psi(x)$, movie embeddings $V$, target label $y$, and return the cross-entropy loss.</p>
<p>Hint: You can use the function <code>tf.nn.sparse_softmax_cross_entropy_with_logits</code>, which takes <code>logits</code> as input, where <code>logits</code> refers to the product $\psi(x) V^\top$.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">softmax_loss</span><span class="p">(</span><span class="n">user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the cross-entropy loss of the softmax model.</span>
<span class="sd">  Args:</span>
<span class="sd">    user_embeddings: A tensor of shape [batch_size, embedding_dim].</span>
<span class="sd">    movie_embeddings: A tensor of shape [num_movies, embedding_dim].</span>
<span class="sd">    labels: A sparse tensor of dense_shape [batch_size, 1], such that</span>
<span class="sd">      labels[i] is the target label for example i.</span>
<span class="sd">  Returns:</span>
<span class="sd">    The mean cross-entropy loss.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">## ========================= Complete this section ============================</span>
  <span class="c1">## logits =</span>
  <span class="c1">## loss =</span>
  <span class="c1">## ============================================================================</span>
  <span class="k">return</span> <span class="n">loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">softmax_loss</span><span class="p">(</span><span class="n">user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the cross-entropy loss of the softmax model.</span>
<span class="sd">  Args:</span>
<span class="sd">    user_embeddings: A tensor of shape [batch_size, embedding_dim].</span>
<span class="sd">    movie_embeddings: A tensor of shape [num_movies, embedding_dim].</span>
<span class="sd">    labels: A tensor of [batch_size], such that labels[i] is the target label</span>
<span class="sd">      for example i.</span>
<span class="sd">  Returns:</span>
<span class="sd">    The mean cross-entropy loss.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">## Verify that the embddings have compatible dimensions</span>
  <span class="n">user_emb_dim</span> <span class="o">=</span> <span class="n">user_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
  <span class="n">movie_emb_dim</span> <span class="o">=</span> <span class="n">movie_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
  <span class="k">if</span> <span class="n">user_emb_dim</span> <span class="o">!=</span> <span class="n">movie_emb_dim</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;The user embedding dimension </span><span class="si">%d</span><span class="s2"> should match the movie embedding &quot;</span>
        <span class="s2">&quot;dimension </span><span class="si">% d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user_emb_dim</span><span class="p">,</span> <span class="n">movie_emb_dim</span><span class="p">))</span>

  <span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">(</span>
      <span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Exercise-8:-Build-a-softmax-model,-train-it,-and-inspect-its-embeddings.">Exercise 8: Build a softmax model, train it, and inspect its embeddings.<a class="anchor-link" href="#Exercise-8:-Build-a-softmax-model,-train-it,-and-inspect-its-embeddings."> </a></h4><p>We are now ready to build a softmax CFModel. Complete the <code>build_softmax_model</code> function in the next cell. The architecture of the model is defined in the function <code>create_user_embeddings</code> and illustrated in the figure below. The input embeddings (movie_id, genre and year) are concatenated to form the input layer, then we have hidden layers with dimensions specified by the <code>hidden_dims</code> argument. Finally, the last hidden layer is multiplied by the movie embeddings to obtain the logits layer. For the target label, we will use a randomly-sampled movie_id from the list of movies the user rated.</p>
<p><img src="https://github.com/google/eng-edu/blob/master/ml/recommendation-systems/images/softmax-model.png?raw=true" alt="Softmax model" /></p>
<p>Complete the function below by creating the feature columns and embedding columns, then creating the loss tensors both for the train and test sets (using the <code>softmax_loss</code> function of the previous exercise).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">build_softmax_model</span><span class="p">(</span><span class="n">rated_movies</span><span class="p">,</span> <span class="n">embedding_cols</span><span class="p">,</span> <span class="n">hidden_dims</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Builds a Softmax model for MovieLens.</span>
<span class="sd">  Args:</span>
<span class="sd">    rated_movies: DataFrame of traing examples.</span>
<span class="sd">    embedding_cols: A dictionary mapping feature names (string) to embedding</span>
<span class="sd">      column objects. This will be used in tf.feature_column.input_layer() to</span>
<span class="sd">      create the input layer.</span>
<span class="sd">    hidden_dims: int list of the dimensions of the hidden layers.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A CFModel object.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">create_network</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps input features dictionary to user embeddings.</span>
<span class="sd">    Args:</span>
<span class="sd">      features: A dictionary of input string tensors.</span>
<span class="sd">    Returns:</span>
<span class="sd">      outputs: A tensor of shape [batch_size, embedding_dim].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## Create a bag-of-words embedding for each sparse feature.</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">input_layer</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">embedding_cols</span><span class="p">)</span>
    <span class="c1">## Hidden layers.</span>
    <span class="n">input_dim</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output_dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hidden_dims</span><span class="p">):</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span>
          <span class="s2">&quot;hidden</span><span class="si">%d</span><span class="s2">_w_&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">],</span>
          <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal_initializer</span><span class="p">(</span>
              <span class="n">stddev</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">output_dim</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">10.</span>
      <span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
      <span class="n">input_dim</span> <span class="o">=</span> <span class="n">output_dim</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">outputs</span>
    <span class="k">return</span> <span class="n">outputs</span>

  <span class="n">train_rated_movies</span><span class="p">,</span> <span class="n">test_rated_movies</span> <span class="o">=</span> <span class="n">split_dataframe</span><span class="p">(</span><span class="n">rated_movies</span><span class="p">)</span>
  <span class="n">train_batch</span> <span class="o">=</span> <span class="n">make_batch</span><span class="p">(</span><span class="n">train_rated_movies</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
  <span class="n">test_batch</span> <span class="o">=</span> <span class="n">make_batch</span><span class="p">(</span><span class="n">test_rated_movies</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

  <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">## Train</span>
    <span class="n">train_user_embeddings</span> <span class="o">=</span> <span class="n">create_network</span><span class="p">(</span><span class="n">train_batch</span><span class="p">)</span>
    <span class="n">train_labels</span> <span class="o">=</span> <span class="n">select_random</span><span class="p">(</span><span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
  <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">## Test</span>
    <span class="n">test_user_embeddings</span> <span class="o">=</span> <span class="n">create_network</span><span class="p">(</span><span class="n">test_batch</span><span class="p">)</span>
    <span class="n">test_labels</span> <span class="o">=</span> <span class="n">select_random</span><span class="p">(</span><span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
    <span class="n">movie_embeddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span>
        <span class="s2">&quot;input_layer/movie_id_embedding/embedding_weights&quot;</span><span class="p">)</span>

  <span class="c1">## ========================= Complete this section ============================</span>
  <span class="c1">## train_loss =</span>
  <span class="c1">## test_loss =</span>
  <span class="c1">## test_precision_at_10 =</span>
  <span class="c1">## ============================================================================</span>

  <span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">{</span><span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span> <span class="s2">&quot;test_loss&quot;</span><span class="p">:</span> <span class="n">test_loss</span><span class="p">},</span>
      <span class="p">{</span><span class="s2">&quot;test_precision_at_10&quot;</span><span class="p">:</span> <span class="n">test_precision_at_10</span><span class="p">}</span>
  <span class="p">)</span>
  <span class="n">embeddings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">movie_embeddings</span><span class="p">}</span>
  <span class="k">return</span> <span class="n">CFModel</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">build_softmax_model</span><span class="p">(</span><span class="n">rated_movies</span><span class="p">,</span> <span class="n">embedding_cols</span><span class="p">,</span> <span class="n">hidden_dims</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Builds a Softmax model for MovieLens.</span>
<span class="sd">  Args:</span>
<span class="sd">    rated_movies: DataFrame of traing examples.</span>
<span class="sd">    embedding_cols: A dictionary mapping feature names (string) to embedding</span>
<span class="sd">      column objects. This will be used in tf.feature_column.input_layer() to</span>
<span class="sd">      create the input layer.</span>
<span class="sd">    hidden_dims: int list of the dimensions of the hidden layers.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A CFModel object.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">create_network</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps input features dictionary to user embeddings.</span>
<span class="sd">    Args:</span>
<span class="sd">      features: A dictionary of input string tensors.</span>
<span class="sd">    Returns:</span>
<span class="sd">      outputs: A tensor of shape [batch_size, embedding_dim].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## Create a bag-of-words embedding for each sparse feature.</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">input_layer</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">embedding_cols</span><span class="p">)</span>
    <span class="c1">## Hidden layers.</span>
    <span class="n">input_dim</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output_dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hidden_dims</span><span class="p">):</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span>
          <span class="s2">&quot;hidden</span><span class="si">%d</span><span class="s2">_w_&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">],</span>
          <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal_initializer</span><span class="p">(</span>
              <span class="n">stddev</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">output_dim</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">10.</span>
      <span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
      <span class="n">input_dim</span> <span class="o">=</span> <span class="n">output_dim</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">outputs</span>
    <span class="k">return</span> <span class="n">outputs</span>

  <span class="n">train_rated_movies</span><span class="p">,</span> <span class="n">test_rated_movies</span> <span class="o">=</span> <span class="n">split_dataframe</span><span class="p">(</span><span class="n">rated_movies</span><span class="p">)</span>
  <span class="n">train_batch</span> <span class="o">=</span> <span class="n">make_batch</span><span class="p">(</span><span class="n">train_rated_movies</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
  <span class="n">test_batch</span> <span class="o">=</span> <span class="n">make_batch</span><span class="p">(</span><span class="n">test_rated_movies</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

  <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">## Train</span>
    <span class="n">train_user_embeddings</span> <span class="o">=</span> <span class="n">create_network</span><span class="p">(</span><span class="n">train_batch</span><span class="p">)</span>
    <span class="n">train_labels</span> <span class="o">=</span> <span class="n">select_random</span><span class="p">(</span><span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
  <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">## Test</span>
    <span class="n">test_user_embeddings</span> <span class="o">=</span> <span class="n">create_network</span><span class="p">(</span><span class="n">test_batch</span><span class="p">)</span>
    <span class="n">test_labels</span> <span class="o">=</span> <span class="n">select_random</span><span class="p">(</span><span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
    <span class="n">movie_embeddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span>
        <span class="s2">&quot;input_layer/movie_id_embedding/embedding_weights&quot;</span><span class="p">)</span>

  <span class="n">test_loss</span> <span class="o">=</span> <span class="n">softmax_loss</span><span class="p">(</span>
      <span class="n">test_user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>
  <span class="n">train_loss</span> <span class="o">=</span> <span class="n">softmax_loss</span><span class="p">(</span>
      <span class="n">train_user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">test_precision_at_10</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">precision_at_k</span><span class="p">(</span>
      <span class="n">labels</span><span class="o">=</span><span class="n">test_labels</span><span class="p">,</span>
      <span class="n">predictions</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">test_user_embeddings</span><span class="p">,</span> <span class="n">movie_embeddings</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
      <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

  <span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">{</span><span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span> <span class="s2">&quot;test_loss&quot;</span><span class="p">:</span> <span class="n">test_loss</span><span class="p">},</span>
      <span class="p">{</span><span class="s2">&quot;test_precision_at_10&quot;</span><span class="p">:</span> <span class="n">test_precision_at_10</span><span class="p">}</span>
  <span class="p">)</span>
  <span class="n">embeddings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">movie_embeddings</span><span class="p">}</span>
  <span class="k">return</span> <span class="n">CFModel</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Train-the-Softmax-model">Train the Softmax model<a class="anchor-link" href="#Train-the-Softmax-model"> </a></h4><p>We are now ready to train the softmax model. You can set the following hyperparameters:</p>
<ul>
<li>learning rate</li>
<li>number of iterations. Note: you can run <code>softmax_model.train()</code> again to continue training the model from its current state.</li>
<li>input embedding dimensions (the <code>input_dims</code> argument)</li>
<li>number of hidden layers and size of each layer (the <code>hidden_dims</code> argument)</li>
</ul>
<p>Note: since our input features are string-valued (movie_id, genre, and year), we need to map them to integer ids. This is done using <code>tf.feature_column.categorical_column_with_vocabulary_list</code>, which takes a vocabulary list specifying all the values the feature can take. Then each id is mapped to an embedding vector using <code>tf.feature_column.embedding_column</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">make_embedding_col</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">):</span>
  <span class="n">categorical_col</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">categorical_column_with_vocabulary_list</span><span class="p">(</span>
      <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">vocabulary_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">movies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="n">num_oov_buckets</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">embedding_column</span><span class="p">(</span>
      <span class="n">categorical_column</span><span class="o">=</span><span class="n">categorical_col</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">,</span>
      <span class="c1">## default initializer: trancated normal with stddev=1/sqrt(dimension)</span>
      <span class="n">combiner</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
  <span class="n">softmax_model</span> <span class="o">=</span> <span class="n">build_softmax_model</span><span class="p">(</span>
      <span class="n">rated_movies</span><span class="p">,</span>
      <span class="n">embedding_cols</span><span class="o">=</span><span class="p">[</span>
          <span class="n">make_embedding_col</span><span class="p">(</span><span class="s2">&quot;movie_id&quot;</span><span class="p">,</span> <span class="mi">35</span><span class="p">),</span>
          <span class="n">make_embedding_col</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
          <span class="n">make_embedding_col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
      <span class="p">],</span>
      <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">35</span><span class="p">])</span>

<span class="n">softmax_model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">8.</span><span class="p">,</span> <span class="n">num_iterations</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdagradOptimizer</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Inspect-the-embeddings">Inspect the embeddings<a class="anchor-link" href="#Inspect-the-embeddings"> </a></h4><p>We can inspect the movie embeddings as we did for the previous models. Note that in this case, the movie embeddings are used at the same time as input embeddings (for the bag of words representation of the user history), and as softmax weights.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_neighbors</span><span class="p">(</span><span class="n">softmax_model</span><span class="p">,</span> <span class="s2">&quot;Aladdin&quot;</span><span class="p">,</span> <span class="n">DOT</span><span class="p">)</span>
<span class="n">movie_neighbors</span><span class="p">(</span><span class="n">softmax_model</span><span class="p">,</span> <span class="s2">&quot;Aladdin&quot;</span><span class="p">,</span> <span class="n">COSINE</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_embedding_norm</span><span class="p">([</span><span class="n">reg_model</span><span class="p">,</span> <span class="n">softmax_model</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tsne_movie_embeddings</span><span class="p">(</span><span class="n">softmax_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Congratulations!">Congratulations!<a class="anchor-link" href="#Congratulations!"> </a></h3><p>You have completed this Colab notebook.</p>
<p>If you would like to further explore these models, we encourage you to try different hyperparameters and observe how this affects the quality of the model and the structure of the embedding space. Here are some suggestions:</p>
<ul>
<li>Change the embedding dimension.</li>
<li>In the softmax model: change the number of hidden layers, and the input features. For example, you can try a model with no hidden layers, and only the movie ids as inputs.</li>
<li>Using other similarity measures: In this Colab notebook, we used dot product $d(u, V_j) = \langle u, V_j \rangle$ and cosine $d(u, V_j) = \frac{\langle u, V_j \rangle}{\|u\|\|V_j\|}$, and discussed how the norms of the embeddings affect the recommendations. You can also try other variants which apply a transformation to the norm, for example $d(u, V_j) = \frac{\langle u, V_j \rangle}{\|V_j\|^\alpha}$.</li>
</ul>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/2022/01/17/movie-tf.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
