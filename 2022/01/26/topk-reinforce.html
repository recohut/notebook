<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Top-K Off-Policy Correction for a REINFORCE Recommender System | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Top-K Off-Policy Correction for a REINFORCE Recommender System" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/26/topk-reinforce.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/26/topk-reinforce.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-26T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Top-K Off-Policy Correction for a REINFORCE Recommender System" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-26T00:00:00-06:00","datePublished":"2022-01-26T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Top-K Off-Policy Correction for a REINFORCE Recommender System","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/26/topk-reinforce.html"},"url":"https://nb.recohut.com/2022/01/26/topk-reinforce.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Top-K Off-Policy Correction for a REINFORCE Recommender System</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-26T00:00:00-06:00" itemprop="datePublished">
        Jan 26, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      12 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-26-topk-reinforce.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-26-topk-reinforce.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-26-topk-reinforce.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-26-topk-reinforce.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-26-topk-reinforce.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="CLI-run">CLI run<a class="anchor-link" href="#CLI-run"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">gdown</span> <span class="o">--</span><span class="nb">id</span> <span class="mi">1</span><span class="n">erBjYEOa7IuOIGpI8pGPn1WNBAC4Rv0</span><span class="o">-</span>
<span class="err">!</span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">massquantity</span><span class="o">/</span><span class="n">DBRL</span><span class="o">.</span><span class="n">git</span>
<span class="err">!</span><span class="n">unzip</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">ECommAI_EUIR_round2_train_20190821</span><span class="o">.</span><span class="n">zip</span>
<span class="err">!</span><span class="n">mv</span> <span class="n">ECommAI_EUIR_round2_train_20190816</span><span class="o">/*.</span><span class="n">csv</span> <span class="n">DBRL</span><span class="o">/</span><span class="n">dbrl</span><span class="o">/</span><span class="n">resources</span>
<span class="o">%</span><span class="n">cd</span> <span class="n">DBRL</span><span class="o">/</span><span class="n">dbrl</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Downloading...
From: https://drive.google.com/uc?id=1erBjYEOa7IuOIGpI8pGPn1WNBAC4Rv0-
To: /content/ECommAI_EUIR_round2_train_20190821.zip
100% 894M/894M [00:06&lt;00:00, 146MB/s]
Cloning into &#39;DBRL&#39;...
remote: Enumerating objects: 118, done.
remote: Counting objects: 100% (118/118), done.
remote: Compressing objects: 100% (83/83), done.
remote: Total 118 (delta 29), reused 114 (delta 25), pack-reused 0
Receiving objects: 100% (118/118), 203.89 KiB | 2.87 MiB/s, done.
Resolving deltas: 100% (29/29), done.
Archive:  /content/ECommAI_EUIR_round2_train_20190821.zip
   creating: ECommAI_EUIR_round2_train_20190816/
  inflating: ECommAI_EUIR_round2_train_20190816/user_behavior.csv  
  inflating: ECommAI_EUIR_round2_train_20190816/item.csv  
  inflating: ECommAI_EUIR_round2_train_20190816/user.csv  
/content/DBRL/dbrl
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">python</span> <span class="n">run_prepare_data</span><span class="o">.</span><span class="n">py</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;seed&#39;: 0}
tcmalloc: large alloc 1931411456 bytes == 0x559fe1e9e000 @  0x7fbeb7c811e7 0x7fbeb580146e 0x7fbeb5851c7b 0x7fbeb585235f 0x7fbeb58f4103 0x559fd33e4544 0x559fd33e4240 0x559fd3458627 0x559fd33e5afa 0x559fd3453915 0x559fd34529ee 0x559fd33e5bda 0x559fd3453915 0x559fd33e5afa 0x559fd3453915 0x559fd33e5afa 0x559fd3453915 0x559fd34529ee 0x559fd33e5bda 0x559fd3454737 0x559fd3452ced 0x559fd33e5bda 0x559fd3454737 0x559fd3452ced 0x559fd33e648c 0x559fd3427159 0x559fd34240a4 0x559fd33e4d49 0x559fd345894f 0x559fd34529ee 0x559fd33e5bda
tcmalloc: large alloc 1931411456 bytes == 0x55a1625c8000 @  0x7fbeb7c811e7 0x7fbeb580146e 0x7fbeb5851c7b 0x7fbeb585235f 0x7fbeb58f4103 0x559fd33e4544 0x559fd33e4240 0x559fd3458627 0x559fd34529ee 0x559fd33e5bda 0x559fd3454737 0x559fd34529ee 0x559fd33e5bda 0x559fd3454737 0x559fd3452ced 0x559fd33e5bda 0x559fd3453915 0x559fd3452ced 0x559fd33e5bda 0x559fd3454737 0x559fd34529ee 0x559fd33e5bda 0x559fd3454737 0x559fd3452ced 0x559fd33e5bda 0x559fd3454737 0x559fd34529ee 0x559fd34526f3 0x559fd351c4c2 0x559fd351c83d 0x559fd351c6e6
tcmalloc: large alloc 1931411456 bytes == 0x55a1d57b8000 @  0x7fbeb7c811e7 0x7fbeb580146e 0x7fbeb5851c7b 0x7fbeb5851d97 0x7fbeb584b4a5 0x7fbeb58e8eab 0x559fd33e44b0 0x559fd34d5e1d 0x559fd3457e99 0x559fd34529ee 0x559fd33e648c 0x559fd33e6698 0x559fd3454fe4 0x559fd3452ced 0x559fd33e5bda 0x559fd3454737 0x559fd3452ced 0x559fd33e5bda 0x559fd3454737 0x559fd34529ee 0x559fd33e5bda 0x559fd3457d00 0x559fd3452ced 0x559fd33e5bda 0x559fd3454737 0x559fd34529ee 0x559fd34526f3 0x559fd351c4c2 0x559fd351c83d 0x559fd351c6e6 0x559fd34f4163
tcmalloc: large alloc 1548664832 bytes == 0x559fe1e9e000 @  0x7fbeb7c811e7 0x7fbeb580146e 0x7fbeb5851c7b 0x7fbeb585235f 0x7fbeb58f4103 0x559fd33e4544 0x559fd33e4240 0x559fd3458627 0x559fd34529ee 0x559fd33e5bda 0x559fd3454737 0x559fd34529ee 0x559fd33e5bda 0x559fd3454737 0x559fd3452ced 0x559fd33e5bda 0x559fd3453915 0x559fd3452ced 0x559fd33e5bda 0x559fd3454737 0x559fd34529ee 0x559fd33e5bda 0x559fd3454737 0x559fd34529ee 0x559fd33e5bda 0x559fd3454737 0x559fd34529ee 0x559fd33e5bda 0x559fd3454737 0x559fd33e5afa 0x559fd3457d00
n_users: 80000, n_items: 1047166, behavior length: 3234367
prepare data done!, time elapsed: 173.06
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">python</span> <span class="n">run_pretrain_embeddings</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">lr</span> <span class="mf">0.001</span> <span class="o">--</span><span class="n">n_epochs</span> <span class="mi">4</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>A list all args: 
======================
{&#39;batch_size&#39;: 2048,
 &#39;data&#39;: &#39;tianchi.csv&#39;,
 &#39;embed_size&#39;: 32,
 &#39;loss&#39;: &#39;cosine&#39;,
 &#39;lr&#39;: 0.001,
 &#39;n_epochs&#39;: 4,
 &#39;neg_item&#39;: 1,
 &#39;seed&#39;: 0}

n_users: 80000, n_items: 912114, train_shape: (2587518, 10), eval_shape: (646849, 10)
100% 2527/2527 [02:22&lt;00:00, 17.73it/s]
100% 632/632 [00:11&lt;00:00, 56.31it/s]
epoch 1, train_loss: 0.3253, eval loss: 0.3537, eval roc: 0.7370
100% 2527/2527 [02:21&lt;00:00, 17.85it/s]
100% 632/632 [00:11&lt;00:00, 55.87it/s]
epoch 2, train_loss: 0.2568, eval loss: 0.3351, eval roc: 0.7697
100% 2527/2527 [02:21&lt;00:00, 17.84it/s]
100% 632/632 [00:11&lt;00:00, 56.34it/s]
epoch 3, train_loss: 0.2260, eval loss: 0.3309, eval roc: 0.7772
100% 2527/2527 [02:20&lt;00:00, 17.96it/s]
100% 632/632 [00:11&lt;00:00, 57.03it/s]
epoch 4, train_loss: 0.2036, eval loss: 0.3296, eval roc: 0.7829
user_embeds shape: (80000, 32), item_embeds shape: (912115, 32)
pretrain embeddings done!
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">python</span> <span class="n">run_reinforce</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">n_epochs</span> <span class="mi">1</span> <span class="o">--</span><span class="n">lr</span> <span class="mf">1e-5</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>A list all args: 
======================
{&#39;batch_size&#39;: 128,
 &#39;data&#39;: &#39;tianchi.csv&#39;,
 &#39;gamma&#39;: 0.99,
 &#39;hidden_size&#39;: 64,
 &#39;hist_num&#39;: 10,
 &#39;item_embeds&#39;: &#39;tianchi_item_embeddings.npy&#39;,
 &#39;lr&#39;: 1e-05,
 &#39;n_epochs&#39;: 1,
 &#39;n_rec&#39;: 10,
 &#39;seed&#39;: 0,
 &#39;sess_mode&#39;: &#39;interval&#39;,
 &#39;user_embeds&#39;: &#39;tianchi_user_embeddings.npy&#39;,
 &#39;weight_decay&#39;: 0.0}

Number of parameters: policy: 118628454,  beta: 59310067
Caution: Will compute loss every 10 step(s)

Epoch 1 start-time: 2021-10-21 10:46:33

train: 100% 19590/19590 [2:24:05&lt;00:00,  2.27it/s]
last_eval: 100% 625/625 [00:47&lt;00:00, 13.12it/s]

policy_loss: 665.2355, beta_loss: 13.6349, importance_weight: 0.8856, lambda_k: 9.9993, 
reward: 455, ndcg_next_item: 0.000999, ndcg_all_item: 0.039790, ndcg: 0.027800

******************** EVAL ********************
eval: 100% 10516/10516 [20:26&lt;00:00,  8.58it/s]
last_eval: 100% 625/625 [00:47&lt;00:00, 13.12it/s]

policy_loss: 1333.3558, beta_loss: 13.5444, importance_weight: 0.9655, lambda_k: 9.9992, 
reward: 290, ndcg_next_item: 0.001165, ndcg_all_item: 0.008780, ndcg: 0.007617
================================================================================
train and save done!
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">qq</span> <span class="n">install</span> <span class="n">tree</span>
<span class="err">!</span><span class="n">tree</span> <span class="o">--</span><span class="n">du</span> <span class="o">-</span><span class="n">h</span> <span class="o">.</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Selecting previously unselected package tree.
(Reading database ... 155047 files and directories currently installed.)
Preparing to unpack .../tree_1.7.0-5_amd64.deb ...
Unpacking tree (1.7.0-5) ...
Setting up tree (1.7.0-5) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
.
├── [ 56K]  data
│   ├── [7.7K]  dataset.py
│   ├── [ 126]  __init__.py
│   ├── [8.4K]  process.py
│   ├── [ 24K]  __pycache__
│   │   ├── [5.5K]  dataset.cpython-37.pyc
│   │   ├── [ 284]  __init__.cpython-37.pyc
│   │   ├── [5.6K]  process.cpython-37.pyc
│   │   ├── [6.3K]  session.cpython-37.pyc
│   │   └── [2.2K]  split.cpython-37.pyc
│   ├── [9.6K]  session.py
│   └── [2.5K]  split.py
├── [ 17K]  evaluate
│   ├── [4.1K]  evaluate.py
│   ├── [  45]  __init__.py
│   ├── [1.6K]  metrics.py
│   └── [7.3K]  __pycache__
│       ├── [1.9K]  evaluate.cpython-37.pyc
│       ├── [ 178]  __init__.cpython-37.pyc
│       └── [1.2K]  metrics.cpython-37.pyc
├── [   0]  __init__.py
├── [ 44K]  models
│   ├── [7.6K]  bcq.py
│   ├── [4.2K]  ddpg.py
│   ├── [3.3K]  dssm.py
│   ├── [ 103]  __init__.py
│   ├── [ 19K]  __pycache__
│   │   ├── [5.1K]  bcq.cpython-37.pyc
│   │   ├── [3.3K]  ddpg.cpython-37.pyc
│   │   ├── [2.4K]  dssm.cpython-37.pyc
│   │   ├── [ 256]  __init__.cpython-37.pyc
│   │   └── [3.9K]  youtube_topk.cpython-37.pyc
│   └── [5.7K]  youtube_topk.py
├── [ 24K]  network
│   ├── [  20]  __init__.py
│   ├── [9.1K]  net.py
│   └── [ 11K]  __pycache__
│       ├── [ 134]  __init__.cpython-37.pyc
│       └── [7.2K]  net.cpython-37.pyc
├── [4.1K]  __pycache__
│   └── [ 106]  __init__.cpython-37.pyc
├── [3.0G]  resources
│   ├── [   0]  aa
│   ├── [114M]  item.csv
│   ├── [ 15M]  item_map.json
│   ├── [574M]  model_reinforce.pt
│   ├── [160M]  tianchi.csv
│   ├── [111M]  tianchi_item_embeddings.npy
│   ├── [9.8M]  tianchi_user_embeddings.npy
│   ├── [2.0G]  user_behavior.csv
│   ├── [ 19M]  user.csv
│   └── [1.2M]  user_map.json
├── [5.9K]  run_bcq.py
├── [5.1K]  run_ddpg.py
├── [2.5K]  run_prepare_data.py
├── [4.4K]  run_pretrain_embeddings.py
├── [5.1K]  run_reinforce.py
├── [9.9K]  serialization
│   ├── [  43]  __init__.py
│   ├── [5.0K]  __pycache__
│   │   ├── [ 182]  __init__.cpython-37.pyc
│   │   └── [ 845]  serialize.cpython-37.pyc
│   └── [ 889]  serialize.py
├── [ 18K]  trainer
│   ├── [  68]  __init__.py
│   ├── [1.9K]  pretrain.py
│   ├── [8.2K]  __pycache__
│   │   ├── [ 202]  __init__.cpython-37.pyc
│   │   ├── [1.5K]  pretrain.cpython-37.pyc
│   │   └── [2.5K]  train.cpython-37.pyc
│   └── [3.9K]  train.py
└── [ 21K]  utils
    ├── [1.7K]  info.py
    ├── [ 156]  __init__.py
    ├── [2.2K]  misc.py
    ├── [1.7K]  params.py
    ├── [ 10K]  __pycache__
    │   ├── [1.5K]  info.cpython-37.pyc
    │   ├── [ 325]  __init__.cpython-37.pyc
    │   ├── [2.0K]  misc.cpython-37.pyc
    │   ├── [1.5K]  params.cpython-37.pyc
    │   └── [ 920]  sampling.cpython-37.pyc
    └── [ 908]  sampling.py

 3.0G used in 16 directories, 67 files
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Code-analysis">Code analysis<a class="anchor-link" href="#Code-analysis"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Data-preparation">Data preparation<a class="anchor-link" href="#Data-preparation"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;run_prepare_data&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--seed&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{})</span>


<span class="k">def</span> <span class="nf">bucket_age</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="c1"># 1. loading the data into memory</span>

    <span class="n">user_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;resources/user.csv&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;pur_power&quot;</span><span class="p">])</span>
    <span class="n">item_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;resources/item.csv&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;shop&quot;</span><span class="p">,</span> <span class="s2">&quot;brand&quot;</span><span class="p">])</span>
    <span class="n">behavior</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;resources/user_behavior.csv&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="s2">&quot;behavior&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">])</span>
    
    <span class="c1"># 2. sorting values chronologically and dropping duplicate records</span>

    <span class="n">behavior</span> <span class="o">=</span> <span class="n">behavior</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">behavior</span> <span class="o">=</span> <span class="n">behavior</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="s2">&quot;behavior&quot;</span><span class="p">])</span>

    <span class="c1"># 3. Choosing 60K random users with short journey and 20K with long journey</span>
    <span class="n">user_counts</span> <span class="o">=</span> <span class="n">behavior</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)[[</span><span class="s2">&quot;user&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;count_user&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;count_user&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">short_users</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">user_counts</span><span class="p">[</span>
            <span class="p">(</span><span class="n">user_counts</span><span class="o">.</span><span class="n">count_user</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">user_counts</span><span class="o">.</span><span class="n">count_user</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>
    <span class="n">long_users</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">user_counts</span><span class="p">[</span>
            <span class="p">(</span><span class="n">user_counts</span><span class="o">.</span><span class="n">count_user</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">user_counts</span><span class="o">.</span><span class="n">count_user</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>
    <span class="n">short_chosen_users</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">short_users</span><span class="p">,</span> <span class="mi">60000</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">long_chosen_users</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">long_users</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">chosen_users</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">short_chosen_users</span><span class="p">,</span> <span class="n">long_chosen_users</span><span class="p">])</span>

    <span class="n">behavior</span> <span class="o">=</span> <span class="n">behavior</span><span class="p">[</span><span class="n">behavior</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">chosen_users</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_users: </span><span class="si">{</span><span class="n">behavior</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;n_items: </span><span class="si">{</span><span class="n">behavior</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;behavior length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">behavior</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 4. merge with all features, bucketizing the age and saving the processed data</span>
    <span class="n">behavior</span> <span class="o">=</span> <span class="n">behavior</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">user_feat</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
    <span class="n">behavior</span> <span class="o">=</span> <span class="n">behavior</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">item_feat</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">)</span>
    <span class="n">behavior</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">behavior</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">bucket_age</span><span class="p">)</span>
    <span class="n">behavior</span> <span class="o">=</span> <span class="n">behavior</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">behavior</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;resources/tianchi.csv&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prepare data done!, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;time elapsed: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Embeddings">Embeddings<a class="anchor-link" href="#Embeddings"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">dbrl.data</span> <span class="kn">import</span> <span class="n">process_feat_data</span><span class="p">,</span> <span class="n">FeatDataset</span>
<span class="kn">from</span> <span class="nn">dbrl.models</span> <span class="kn">import</span> <span class="n">DSSM</span>
<span class="kn">from</span> <span class="nn">dbrl.utils</span> <span class="kn">import</span> <span class="n">sample_items_random</span><span class="p">,</span> <span class="n">init_param_dssm</span><span class="p">,</span> <span class="n">generate_embeddings</span>
<span class="kn">from</span> <span class="nn">dbrl.trainer</span> <span class="kn">import</span> <span class="n">pretrain_model</span>
<span class="kn">from</span> <span class="nn">dbrl.serialization</span> <span class="kn">import</span> <span class="n">save_npy</span><span class="p">,</span> <span class="n">save_json</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;run_pretrain_embeddings&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;tianchi.csv&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--n_epochs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--lr&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--embed_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--loss&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;cosine or bce loss&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--neg_item&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--seed&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A list all args: </span><span class="se">\n</span><span class="s2">======================&quot;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># 1. Setting arguments/params</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">EMBEDDING_PATH</span> <span class="o">=</span> <span class="s2">&quot;resources/&quot;</span>
    <span class="n">static_feat</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;pur_power&quot;</span><span class="p">]</span>
    <span class="n">dynamic_feat</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;shop&quot;</span><span class="p">,</span> <span class="s2">&quot;brand&quot;</span><span class="p">]</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">n_epochs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_epochs</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">lr</span>
    <span class="n">item_embed_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">embed_size</span>
    <span class="n">feat_embed_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">embed_size</span>
    <span class="n">hidden_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">CosineEmbeddingLoss</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;cosine&quot;</span>
        <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">criterion_type</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;cosine&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;cosine&quot;</span> <span class="ow">in</span> <span class="n">criterion</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span> <span class="s2">&quot;bce&quot;</span>
    <span class="p">)</span>
    <span class="n">neg_label</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="k">if</span> <span class="n">criterion_type</span> <span class="o">==</span> <span class="s2">&quot;cosine&quot;</span> <span class="k">else</span> <span class="mf">0.</span>
    <span class="n">neg_item</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">neg_item</span>

    <span class="c1"># 2. Preprocessing</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;pur_power&quot;</span><span class="p">,</span>
               <span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;shop&quot;</span><span class="p">,</span> <span class="s2">&quot;brand&quot;</span><span class="p">]</span>

    <span class="p">(</span>
        <span class="n">n_users</span><span class="p">,</span>
        <span class="n">n_items</span><span class="p">,</span>
        <span class="n">train_user_consumed</span><span class="p">,</span>
        <span class="n">eval_user_consumed</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">eval_data</span><span class="p">,</span>
        <span class="n">user_map</span><span class="p">,</span>
        <span class="n">item_map</span><span class="p">,</span>
        <span class="n">feat_map</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">process_feat_data</span><span class="p">(</span>
        <span class="n">PATH</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">time_col</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">static_feat</span><span class="o">=</span><span class="n">static_feat</span><span class="p">,</span> <span class="n">dynamic_feat</span><span class="o">=</span><span class="n">dynamic_feat</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_users: </span><span class="si">{</span><span class="n">n_users</span><span class="si">}</span><span class="s2">, n_items: </span><span class="si">{</span><span class="n">n_items</span><span class="si">}</span><span class="s2">, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;train_shape: </span><span class="si">{</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, eval_shape: </span><span class="si">{</span><span class="n">eval_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># 3. Random negative sampling</span>

    <span class="n">train_user</span><span class="p">,</span> <span class="n">train_item</span><span class="p">,</span> <span class="n">train_label</span> <span class="o">=</span> <span class="n">sample_items_random</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">train_user_consumed</span><span class="p">,</span> <span class="n">neg_label</span><span class="p">,</span> <span class="n">neg_item</span>
    <span class="p">)</span>
    <span class="n">eval_user</span><span class="p">,</span> <span class="n">eval_item</span><span class="p">,</span> <span class="n">eval_label</span> <span class="o">=</span> <span class="n">sample_items_random</span><span class="p">(</span>
        <span class="n">eval_data</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">eval_user_consumed</span><span class="p">,</span> <span class="n">neg_label</span><span class="p">,</span> <span class="n">neg_item</span>
    <span class="p">)</span>

    <span class="c1"># 4. Putting data into torch dataset format and dataloader</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">FeatDataset</span><span class="p">(</span>
        <span class="n">train_user</span><span class="p">,</span>
        <span class="n">train_item</span><span class="p">,</span>
        <span class="n">train_label</span><span class="p">,</span>
        <span class="n">feat_map</span><span class="p">,</span>
        <span class="n">static_feat</span><span class="p">,</span>
        <span class="n">dynamic_feat</span>
    <span class="p">)</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">FeatDataset</span><span class="p">(</span>
        <span class="n">eval_user</span><span class="p">,</span>
        <span class="n">eval_item</span><span class="p">,</span>
        <span class="n">eval_label</span><span class="p">,</span>
        <span class="n">feat_map</span><span class="p">,</span>
        <span class="n">static_feat</span><span class="p">,</span>
        <span class="n">dynamic_feat</span>
    <span class="p">)</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">eval_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                             <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 5. DSSM embedding model training</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">DSSM</span><span class="p">(</span>
        <span class="n">item_embed_size</span><span class="p">,</span>
        <span class="n">feat_embed_size</span><span class="p">,</span>
        <span class="n">n_users</span><span class="p">,</span>
        <span class="n">n_items</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">feat_map</span><span class="p">,</span>
        <span class="n">static_feat</span><span class="p">,</span>
        <span class="n">dynamic_feat</span><span class="p">,</span>
        <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">init_param_dssm</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>  <span class="c1"># weight_decay</span>

    <span class="n">pretrain_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">eval_loader</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span>
                   <span class="n">criterion_type</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># 6. Generate and save embeddings</span>
    
    <span class="n">user_embeddings</span><span class="p">,</span> <span class="n">item_embeddings</span> <span class="o">=</span> <span class="n">generate_embeddings</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">feat_map</span><span class="p">,</span> <span class="n">static_feat</span><span class="p">,</span> <span class="n">dynamic_feat</span><span class="p">,</span> <span class="n">device</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;user_embeds shape: </span><span class="si">{</span><span class="n">user_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">,&quot;</span>
          <span class="sa">f</span><span class="s2">&quot; item_embeds shape: </span><span class="si">{</span><span class="n">item_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">save_npy</span><span class="p">(</span><span class="n">user_embeddings</span><span class="p">,</span> <span class="n">item_embeddings</span><span class="p">,</span> <span class="n">EMBEDDING_PATH</span><span class="p">)</span>
    <span class="n">save_json</span><span class="p">(</span>
        <span class="n">user_map</span><span class="p">,</span> <span class="n">item_map</span><span class="p">,</span> <span class="n">user_embeddings</span><span class="p">,</span> <span class="n">item_embeddings</span><span class="p">,</span> <span class="n">EMBEDDING_PATH</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pretrain embeddings done!&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="REINFORCE-model">REINFORCE model<a class="anchor-link" href="#REINFORCE-model"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">Categorical</span>


<span class="k">class</span> <span class="nc">Reinforce</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">policy</span><span class="p">,</span>
            <span class="n">policy_optim</span><span class="p">,</span>
            <span class="n">beta</span><span class="p">,</span>
            <span class="n">beta_optim</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">weight_clip</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
            <span class="n">offpolicy_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">topk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">adaptive_softmax</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">cutoffs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Reinforce</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_optim</span> <span class="o">=</span> <span class="n">policy_optim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_optim</span> <span class="o">=</span> <span class="n">beta_optim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_clip</span> <span class="o">=</span> <span class="n">weight_clip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offpolicy_correction</span> <span class="o">=</span> <span class="n">offpolicy_correction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topk</span> <span class="o">=</span> <span class="n">topk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_softmax</span> <span class="o">=</span> <span class="n">adaptive_softmax</span>
        <span class="k">if</span> <span class="n">adaptive_softmax</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cutoffs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;must provide cutoffs when using adaptive_softmax&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">softmax_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveLogSoftmaxWithLoss</span><span class="p">(</span>
                <span class="n">in_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
                <span class="n">n_classes</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">item_embeds</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">cutoffs</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">,</span>
                <span class="n">div_value</span><span class="o">=</span><span class="mf">4.</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">policy_loss</span><span class="p">,</span>
            <span class="n">beta_loss</span><span class="p">,</span>
            <span class="n">action</span><span class="p">,</span>
            <span class="n">importance_weight</span><span class="p">,</span>
            <span class="n">lambda_k</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_loss</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">policy_optim</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">policy_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beta_optim</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">beta_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;policy_loss&#39;</span><span class="p">:</span> <span class="n">policy_loss</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s1">&#39;beta_loss&#39;</span><span class="p">:</span> <span class="n">beta_loss</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s1">&#39;importance_weight&#39;</span><span class="p">:</span> <span class="n">importance_weight</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s1">&#39;lambda_k&#39;</span><span class="p">:</span> <span class="n">lambda_k</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">_compute_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_logp</span><span class="p">,</span> <span class="n">beta_logp</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offpolicy_correction</span><span class="p">:</span>
            <span class="n">importance_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">policy_logp</span> <span class="o">-</span> <span class="n">beta_logp</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_clip</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">importance_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">importance_weight</span><span class="p">,</span> <span class="n">wc</span><span class="p">)</span>
        <span class="c1">#    importance_weight = torch.clamp(</span>
        <span class="c1">#        importance_weight, self.weight_clip[0], self.weight_clip[1]</span>
        <span class="c1">#    )</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">importance_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">importance_weight</span>

    <span class="k">def</span> <span class="nf">_compute_lambda_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_logp</span><span class="p">):</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">policy_logp</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topk</span>
            <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">lam</span>

    <span class="k">def</span> <span class="nf">_compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_softmax</span><span class="p">:</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">policy_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax_loss</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">])</span>
            <span class="n">policy_logp</span> <span class="o">=</span> <span class="n">policy_out</span><span class="o">.</span><span class="n">output</span>

            <span class="n">beta_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">beta_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax_loss</span><span class="p">(</span><span class="n">beta_action</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">])</span>
            <span class="n">beta_logp</span> <span class="o">=</span> <span class="n">beta_out</span><span class="o">.</span><span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">all_logp</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">get_log_probs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">policy_logp</span> <span class="o">=</span> <span class="n">all_logp</span><span class="p">[:,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]]</span>

            <span class="n">b_logp</span><span class="p">,</span> <span class="n">beta_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">get_log_probs</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">beta_logp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_logp</span><span class="p">[:,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="n">importance_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_weight</span><span class="p">(</span><span class="n">policy_logp</span><span class="p">,</span> <span class="n">beta_logp</span><span class="p">)</span>
        <span class="n">lambda_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_lambda_k</span><span class="p">(</span><span class="n">policy_logp</span><span class="p">)</span>

        <span class="n">policy_loss</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span>
                <span class="n">importance_weight</span> <span class="o">*</span> <span class="n">lambda_k</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;return&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">policy_logp</span>
        <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_softmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;beta_label&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">b_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">get_beta_state</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">b_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">b_state</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
                <span class="n">b_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax_loss</span><span class="p">(</span><span class="n">b_action</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta_label&quot;</span><span class="p">])</span>
                <span class="n">beta_loss</span> <span class="o">=</span> <span class="n">b_out</span><span class="o">.</span><span class="n">loss</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">beta_loss</span> <span class="o">=</span> <span class="n">beta_out</span><span class="o">.</span><span class="n">loss</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;beta_label&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">b_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">get_beta_state</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">b_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">get_log_probs</span><span class="p">(</span><span class="n">b_state</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
                <span class="n">beta_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_criterion</span><span class="p">(</span><span class="n">b_logits</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta_label&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">beta_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_criterion</span><span class="p">(</span><span class="n">beta_logits</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">policy_loss</span><span class="p">,</span> <span class="n">beta_loss</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">importance_weight</span><span class="p">,</span> <span class="n">lambda_k</span>

    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">policy_loss</span><span class="p">,</span>
            <span class="n">beta_loss</span><span class="p">,</span>
            <span class="n">action</span><span class="p">,</span>
            <span class="n">importance_weight</span><span class="p">,</span>
            <span class="n">lambda_k</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_loss</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;policy_loss&#39;</span><span class="p">:</span> <span class="n">policy_loss</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s1">&#39;beta_loss&#39;</span><span class="p">:</span> <span class="n">beta_loss</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s1">&#39;importance_weight&#39;</span><span class="p">:</span> <span class="n">importance_weight</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s1">&#39;lambda_k&#39;</span><span class="p">:</span> <span class="n">lambda_k</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">get_log_probs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_softmax</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">log_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax_loss</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
            <span class="c1">#    _, log_probs = self.policy.get_log_probs(data)</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">log_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">softmax_fc</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">log_probs</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">policy_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">policy_dist</span> <span class="o">=</span> <span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">policy_logits</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">rec_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">policy_dist</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rec_idxs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Trainer">Trainer<a class="anchor-link" href="#Trainer"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">dbrl.data</span> <span class="kn">import</span> <span class="n">process_data</span><span class="p">,</span> <span class="n">build_dataloader</span>
<span class="kn">from</span> <span class="nn">dbrl.models</span> <span class="kn">import</span> <span class="n">Reinforce</span>
<span class="kn">from</span> <span class="nn">dbrl.network</span> <span class="kn">import</span> <span class="n">PolicyPi</span><span class="p">,</span> <span class="n">Beta</span>
<span class="kn">from</span> <span class="nn">dbrl.trainer</span> <span class="kn">import</span> <span class="n">train_model</span>
<span class="kn">from</span> <span class="nn">dbrl.utils</span> <span class="kn">import</span> <span class="n">count_vars</span><span class="p">,</span> <span class="n">init_param</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;run_reinforce&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;tianchi.csv&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--user_embeds&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;tianchi_user_embeddings.npy&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--item_embeds&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;tianchi_item_embeddings.npy&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--n_epochs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--hist_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;num of history items to consider&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--n_rec&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;num of items to recommend&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--hidden_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--lr&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--weight_decay&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--gamma&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sess_mode&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify when to end a session&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--seed&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A list all args: </span><span class="se">\n</span><span class="s2">======================&quot;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># 1. Loading user and item embeddings</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">user_embeds</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">user_embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">item_embeds</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">item_embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">item_embeddings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>   <span class="c1"># last item is used for padding</span>

    <span class="c1"># 2. Setting model arguments/params</span>

    <span class="n">n_epochs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_epochs</span>
    <span class="n">hist_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hist_num</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">eval_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span>
    <span class="n">embed_size</span> <span class="o">=</span> <span class="n">item_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hidden_size</span>
    <span class="n">input_dim</span> <span class="o">=</span> <span class="n">embed_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">hist_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">action_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_embeddings</span><span class="p">)</span>
    <span class="n">policy_lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">lr</span>
    <span class="n">beta_lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">lr</span>
    <span class="n">weight_decay</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">weight_decay</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">gamma</span>
    <span class="n">n_rec</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_rec</span>
    <span class="n">pad_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_embeddings</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">sess_mode</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sess_mode</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">one_hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">reward_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pv&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span> <span class="s2">&quot;cart&quot;</span><span class="p">:</span> <span class="mf">2.</span><span class="p">,</span> <span class="s2">&quot;fav&quot;</span><span class="p">:</span> <span class="mf">2.</span><span class="p">,</span> <span class="s2">&quot;buy&quot;</span><span class="p">:</span> <span class="mf">3.</span><span class="p">}</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;pur_power&quot;</span><span class="p">,</span>
               <span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;shop&quot;</span><span class="p">,</span> <span class="s2">&quot;brand&quot;</span><span class="p">]</span>

    <span class="n">cutoffs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">item_embeddings</span><span class="p">)</span> <span class="o">//</span> <span class="mi">20</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">item_embeddings</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">item_embeddings</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span>
    <span class="p">]</span>

    <span class="c1"># 3. Building the data loader</span>

    <span class="p">(</span>
        <span class="n">n_users</span><span class="p">,</span>
        <span class="n">n_items</span><span class="p">,</span>
        <span class="n">train_user_consumed</span><span class="p">,</span>
        <span class="n">test_user_consumed</span><span class="p">,</span>
        <span class="n">train_sess_end</span><span class="p">,</span>
        <span class="n">test_sess_end</span><span class="p">,</span>
        <span class="n">train_rewards</span><span class="p">,</span>
        <span class="n">test_rewards</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">time_col</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">sess_mode</span><span class="o">=</span><span class="n">sess_mode</span><span class="p">,</span>
                     <span class="n">interval</span><span class="o">=</span><span class="n">one_hour</span><span class="p">,</span> <span class="n">reward_shape</span><span class="o">=</span><span class="n">reward_map</span><span class="p">)</span>

    <span class="n">train_loader</span><span class="p">,</span> <span class="n">eval_loader</span> <span class="o">=</span> <span class="n">build_dataloader</span><span class="p">(</span>
        <span class="n">n_users</span><span class="p">,</span>
        <span class="n">n_items</span><span class="p">,</span>
        <span class="n">hist_num</span><span class="p">,</span>
        <span class="n">train_user_consumed</span><span class="p">,</span>
        <span class="n">test_user_consumed</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">sess_mode</span><span class="o">=</span><span class="n">sess_mode</span><span class="p">,</span>
        <span class="n">train_sess_end</span><span class="o">=</span><span class="n">train_sess_end</span><span class="p">,</span>
        <span class="n">test_sess_end</span><span class="o">=</span><span class="n">test_sess_end</span><span class="p">,</span>
        <span class="n">n_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">compute_return</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">train_rewards</span><span class="o">=</span><span class="n">train_rewards</span><span class="p">,</span>
        <span class="n">test_rewards</span><span class="o">=</span><span class="n">test_rewards</span><span class="p">,</span>
        <span class="n">reward_shape</span><span class="o">=</span><span class="n">reward_map</span>
    <span class="p">)</span>

    <span class="c1"># 4. Building the model</span>

    <span class="n">policy</span> <span class="o">=</span> <span class="n">PolicyPi</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">user_embeddings</span><span class="p">,</span>
        <span class="n">item_embeddings</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pad_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">Beta</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">init_param</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>

    <span class="n">policy_optim</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">policy_lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">)</span>
    <span class="n">beta_optim</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">beta</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">beta_lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Reinforce</span><span class="p">(</span>
        <span class="n">policy</span><span class="p">,</span>
        <span class="n">policy_optim</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">,</span>
        <span class="n">beta_optim</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">,</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">weight_clip</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="n">offpolicy_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">topk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">adaptive_softmax</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cutoffs</span><span class="o">=</span><span class="n">cutoffs</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">var_counts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">count_vars</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="p">[</span><span class="n">policy</span><span class="p">,</span> <span class="n">beta</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of parameters: policy: </span><span class="si">{</span><span class="n">var_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, &#39;</span>
          <span class="sa">f</span><span class="s1">&#39; beta: </span><span class="si">{</span><span class="n">var_counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># 5. Training the model</span>

    <span class="n">train_model</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">n_epochs</span><span class="p">,</span>
        <span class="n">n_rec</span><span class="p">,</span>
        <span class="n">n_users</span><span class="p">,</span>
        <span class="n">train_user_consumed</span><span class="p">,</span>
        <span class="n">test_user_consumed</span><span class="p">,</span>
        <span class="n">hist_num</span><span class="p">,</span>
        <span class="n">train_loader</span><span class="p">,</span>
        <span class="n">eval_loader</span><span class="p">,</span>
        <span class="n">item_embeddings</span><span class="p">,</span>
        <span class="n">eval_batch_size</span><span class="p">,</span>
        <span class="n">pad_val</span><span class="p">,</span>
        <span class="n">device</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
        <span class="n">eval_interval</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;resources/model_reinforce.pt&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train and save done!&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/2022/01/26/topk-reinforce.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
