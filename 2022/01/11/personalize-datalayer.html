<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Amazon Personalize Generic Module - Data Layer | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Amazon Personalize Generic Module - Data Layer" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/11/personalize-datalayer.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/11/personalize-datalayer.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-11T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Amazon Personalize Generic Module - Data Layer" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-11T00:00:00-06:00","datePublished":"2022-01-11T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Amazon Personalize Generic Module - Data Layer","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/11/personalize-datalayer.html"},"url":"https://nb.recohut.com/2022/01/11/personalize-datalayer.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Amazon Personalize Generic Module - Data Layer</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-11T00:00:00-06:00" itemprop="datePublished">
        Jan 11, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      13 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-11-personalize-datalayer.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-11-personalize-datalayer.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-11-personalize-datalayer.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-11-personalize-datalayer.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-11-personalize-datalayer.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">code</span><span class="o">/</span><span class="n">cloudformation</span>
<span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">progress</span> <span class="o">-</span><span class="n">O</span> <span class="n">code</span><span class="o">/</span><span class="n">cloudformation</span><span class="o">/</span><span class="n">immersion_day</span><span class="o">.</span><span class="n">yaml</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">personalization</span><span class="o">-</span><span class="n">at</span><span class="o">-</span><span class="n">amazon</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">amazon</span><span class="o">-</span><span class="n">personalize</span><span class="o">/</span><span class="n">AmazonPersonalizeImmersionDay</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>code/cloudformation 100%[===================&gt;]   2.57K  --.-KB/s    in 0s      
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">cat</span> <span class="n">code</span><span class="o">/</span><span class="n">cloudformation</span><span class="o">/</span><span class="n">immersion_day</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>---
AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Creates an S3 Bucket, IAM Policies, and SageMaker Notebook to work with Personalize.

Parameters:
  NotebookName:
    Type: String
    Default: AmazonPersonalizeImmersionDay
    Description: Enter the name of the SageMaker notebook instance. Default is PersonalizeImmersionDay.

  VolumeSize:
    Type: Number
    Default: 64
    MinValue: 5
    MaxValue: 16384
    ConstraintDescription: Must be an integer between 5 (GB) and 16384 (16 TB).
    Description: Enter the size of the EBS volume in GB.
    
  domain:
    Type: String
    Default: Media
    Description: Enter the name of the domain (Retail, Media, or CPG) you would like to use in your Amazon Personalize Immersion Day.


Resources:
  SAMArtifactsBucket:
    Type: AWS::S3::Bucket
  # SageMaker Execution Role
  SageMakerIamRole:
    Type: &#34;AWS::IAM::Role&#34;
    Properties:
      AssumeRolePolicyDocument:
        Version: &#34;2012-10-17&#34;
        Statement:
          -
            Effect: Allow
            Principal:
              Service: sagemaker.amazonaws.com
            Action: sts:AssumeRole
      Path: &#34;/&#34;
      ManagedPolicyArns:
        - &#34;arn:aws:iam::aws:policy/IAMFullAccess&#34;
        - &#34;arn:aws:iam::aws:policy/AWSCloudFormationFullAccess&#34;
        - &#34;arn:aws:iam::aws:policy/AmazonS3FullAccess&#34;
        - &#34;arn:aws:iam::aws:policy/AmazonSageMakerFullAccess&#34;
        - &#34;arn:aws:iam::aws:policy/AWSStepFunctionsFullAccess&#34;
        - &#34;arn:aws:iam::aws:policy/AWSLambda_FullAccess&#34;
        - &#34;arn:aws:iam::aws:policy/AmazonSNSFullAccess&#34;
        - &#34;arn:aws:iam::aws:policy/service-role/AmazonPersonalizeFullAccess&#34;
        
        

  # SageMaker notebook
  NotebookInstance:
    Type: &#34;AWS::SageMaker::NotebookInstance&#34;
    Properties:
      InstanceType: &#34;ml.t2.medium&#34;
      NotebookInstanceName: !Ref NotebookName
      RoleArn: !GetAtt SageMakerIamRole.Arn
      VolumeSizeInGB: !Ref VolumeSize
      LifecycleConfigName: !GetAtt AmazonPersonalizeMLOpsLifecycleConfig.NotebookInstanceLifecycleConfigName


  AmazonPersonalizeMLOpsLifecycleConfig:
    Type: &#34;AWS::SageMaker::NotebookInstanceLifecycleConfig&#34;
    Properties:
      OnStart:
        - Content:
            Fn::Base64: 
              !Sub |
                #!/bin/bash
                sudo -u ec2-user -i &lt;&lt;&#39;EOF&#39;
                cd /home/ec2-user/SageMaker/
                git clone https://github.com/aws-samples/amazon-personalize-immersion-day.git
                cd /home/ec2-user/SageMaker/amazon-personalize-immersion-day/automation/ml_ops/
                nohup sh deploy.sh &#34;${SAMArtifactsBucket}&#34; &#34;${domain}&#34; &amp;
                EOF</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-Preparation">Data Preparation<a class="anchor-link" href="#Data-Preparation"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">original_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/bronze/ml-latest-small/ratings.csv&#39;</span><span class="p">)</span>
<span class="n">original_data</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 100836 entries, 0 to 100835
Data columns (total 4 columns):
 #   Column     Non-Null Count   Dtype  
---  ------     --------------   -----  
 0   userId     100836 non-null  int64  
 1   movieId    100836 non-null  int64  
 2   rating     100836 non-null  float64
 3   timestamp  100836 non-null  int64  
dtypes: float64(1), int64(3)
memory usage: 3.1 MB
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The int64 format is clearly suitable for userId and movieId. However, we need to dive deeper to understand the timestamps in the data. To use Amazon Personalize, you need to save timestamps in Unix Epoch format. Currently, the timestamp values are not human-readable. So let's grab an arbitrary timestamp value and figure out how to interpret it. Do a quick sanity check on the transformed dataset by picking an arbitrary timestamp and transforming it to a human-readable format.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">arb_time_stamp</span> <span class="o">=</span> <span class="n">original_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">50</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">arb_time_stamp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">arb_time_stamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>964982681.0
2000-07-30 18:44:41
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since this is a dataset of an explicit feedback movie ratings, it includes movies rated from 1 to 5. We want to include only moves that were "liked" by the users, and simulate a dataset of data that would be gathered by a VOD platform. In order to do that, we will filter out all interactions under 2 out of 5, and create two EVENT_Types "click" and and "watch". We will then assign all movies rated 2 and above as "click" and movies rated 4 and above as both "click" and "watch".</p>
<p>Note that this is to correspond with the events we are modeling, for a real data set you would actually model based on implicit feedback such as clicks, watches and/or explicit feedback such as ratings, likes etc.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">watched_df</span> <span class="o">=</span> <span class="n">original_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">watched_df</span> <span class="o">=</span> <span class="n">watched_df</span><span class="p">[</span><span class="n">watched_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">watched_df</span> <span class="o">=</span> <span class="n">watched_df</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;movieId&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]]</span>
<span class="n">watched_df</span><span class="p">[</span><span class="s1">&#39;EVENT_TYPE&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;watch&#39;</span>
<span class="n">display</span><span class="p">(</span><span class="n">watched_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="n">clicked_df</span> <span class="o">=</span> <span class="n">original_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">clicked_df</span> <span class="o">=</span> <span class="n">clicked_df</span><span class="p">[</span><span class="n">clicked_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">clicked_df</span> <span class="o">=</span> <span class="n">clicked_df</span><span class="p">[[</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;movieId&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]]</span>
<span class="n">clicked_df</span><span class="p">[</span><span class="s1">&#39;EVENT_TYPE&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;click&#39;</span>
<span class="n">display</span><span class="p">(</span><span class="n">clicked_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="n">interactions_df</span> <span class="o">=</span> <span class="n">clicked_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">interactions_df</span> <span class="o">=</span> <span class="n">interactions_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">watched_df</span><span class="p">)</span>
<span class="n">interactions_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                 <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">na_position</span> <span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span> 
<span class="n">interactions_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>timestamp</th>
      <th>EVENT_TYPE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>964982703</td>
      <td>watch</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>964981247</td>
      <td>watch</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>6</td>
      <td>964982224</td>
      <td>watch</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>47</td>
      <td>964983815</td>
      <td>watch</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>50</td>
      <td>964982931</td>
      <td>watch</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>timestamp</th>
      <th>EVENT_TYPE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>964982703</td>
      <td>click</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>964981247</td>
      <td>click</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>6</td>
      <td>964982224</td>
      <td>click</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>47</td>
      <td>964983815</td>
      <td>click</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>50</td>
      <td>964982931</td>
      <td>click</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 158371 entries, 66679 to 81092
Data columns (total 4 columns):
 #   Column      Non-Null Count   Dtype 
---  ------      --------------   ----- 
 0   userId      158371 non-null  int64 
 1   movieId     158371 non-null  int64 
 2   timestamp   158371 non-null  int64 
 3   EVENT_TYPE  158371 non-null  object
dtypes: int64(3), object(1)
memory usage: 6.0+ MB
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Amazon Personalize has default column names for users, items, and timestamp. These default column names are USER_ID, ITEM_ID, AND TIMESTAMP. So the final modification to the dataset is to replace the existing column headers with the default headers.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">interactions_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;userId&#39;</span><span class="p">:</span><span class="s1">&#39;USER_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;movieId&#39;</span><span class="p">:</span><span class="s1">&#39;ITEM_ID&#39;</span><span class="p">,</span> 
                              <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">interactions_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>USER_ID</th>
      <th>ITEM_ID</th>
      <th>TIMESTAMP</th>
      <th>EVENT_TYPE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>66679</th>
      <td>429</td>
      <td>222</td>
      <td>828124615</td>
      <td>watch</td>
    </tr>
    <tr>
      <th>66681</th>
      <td>429</td>
      <td>227</td>
      <td>828124615</td>
      <td>click</td>
    </tr>
    <tr>
      <th>66719</th>
      <td>429</td>
      <td>595</td>
      <td>828124615</td>
      <td>watch</td>
    </tr>
    <tr>
      <th>66718</th>
      <td>429</td>
      <td>592</td>
      <td>828124615</td>
      <td>watch</td>
    </tr>
    <tr>
      <th>66717</th>
      <td>429</td>
      <td>590</td>
      <td>828124615</td>
      <td>watch</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">interactions_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;./data/silver/ml-latest-small/interactions.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.0f</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">original_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/bronze/ml-latest-small/movies.csv&#39;</span><span class="p">)</span>
<span class="n">original_data</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 9742 entries, 0 to 9741
Data columns (total 3 columns):
 #   Column   Non-Null Count  Dtype 
---  ------   --------------  ----- 
 0   movieId  9742 non-null   int64 
 1   title    9742 non-null   object
 2   genres   9742 non-null   object
dtypes: int64(1), object(2)
memory usage: 228.5+ KB
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">original_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">original_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;.*\((.*)\).*&#39;</span><span class="p">,</span><span class="n">expand</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">original_data</span> <span class="o">=</span> <span class="n">original_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">itemmetadata_df</span> <span class="o">=</span> <span class="n">original_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">itemmetadata_df</span> <span class="o">=</span> <span class="n">itemmetadata_df</span><span class="p">[[</span><span class="s1">&#39;movieId&#39;</span><span class="p">,</span> <span class="s1">&#39;genres&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]]</span>
<span class="n">itemmetadata_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>genres</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Adventure|Animation|Children|Comedy|Fantasy</td>
      <td>1995</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Adventure|Children|Fantasy</td>
      <td>1995</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Comedy|Romance</td>
      <td>1995</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Comedy|Drama|Romance</td>
      <td>1995</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Comedy</td>
      <td>1995</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We will add a new dataframe to help us generate a creation timestamp. If you donâ€™t provide the CREATION_TIMESTAMP for an item, the model infers this information from the interaction dataset and uses the timestamp of the itemâ€™s earliest interaction as its corresponding release date. If an item doesnâ€™t have an interaction, its release date is set as the timestamp of the latest interaction in the training set and it is considered a new item. For the current dataset we will set the CREATION_TIMESTAMP to 0.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">itemmetadata_df</span><span class="p">[</span><span class="s1">&#39;CREATION_TIMESTAMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">itemmetadata_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;genres&#39;</span><span class="p">:</span><span class="s1">&#39;GENRE&#39;</span><span class="p">,</span> <span class="s1">&#39;movieId&#39;</span><span class="p">:</span><span class="s1">&#39;ITEM_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="s1">&#39;YEAR&#39;</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
<span class="n">itemmetadata_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;./data/silver/ml-latest-small/item-meta.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.0f</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="AWS-Personalize">AWS Personalize<a class="anchor-link" href="#AWS-Personalize"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">boto3</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">~/.</span><span class="n">aws</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">drive</span><span class="o">/</span><span class="n">MyDrive</span><span class="o">/</span><span class="n">AWS</span><span class="o">/</span><span class="n">d01_admin</span><span class="o">/*</span> <span class="o">~/.</span><span class="n">aws</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ETL-Job-for-Interactions-data-without-using-generic-data-loading-module">ETL Job for Interactions data without using generic data loading module<a class="anchor-link" href="#ETL-Job-for-Interactions-data-without-using-generic-data-loading-module"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">personalize</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;personalize&#39;</span><span class="p">)</span>
<span class="n">personalize_runtime</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;personalize-runtime&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We can communicate with Personalize!&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>We can communicate with Personalize!
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">create_dataset_group_response</span> <span class="o">=</span> <span class="n">personalize</span><span class="o">.</span><span class="n">create_dataset_group</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;immersion-day-dataset-group-movielens-latest&quot;</span>
<span class="p">)</span>

<span class="n">dataset_group_arn</span> <span class="o">=</span> <span class="n">create_dataset_group_response</span><span class="p">[</span><span class="s1">&#39;datasetGroupArn&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">create_dataset_group_response</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># wait for it to become active</span>
<span class="n">max_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span> <span class="c1"># 3 hours</span>
<span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">max_time</span><span class="p">:</span>
    <span class="n">describe_dataset_group_response</span> <span class="o">=</span> <span class="n">personalize</span><span class="o">.</span><span class="n">describe_dataset_group</span><span class="p">(</span>
        <span class="n">datasetGroupArn</span> <span class="o">=</span> <span class="n">dataset_group_arn</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">describe_dataset_group_response</span><span class="p">[</span><span class="s2">&quot;datasetGroup&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DatasetGroup: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">or</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;CREATE FAILED&quot;</span><span class="p">:</span>
        <span class="k">break</span>
        
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">interactions_schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;record&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Interactions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;com.amazonaws.personalize.schema&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;USER_ID&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ITEM_ID&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;EVENT_TYPE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;long&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span>
<span class="p">}</span>

<span class="n">create_schema_response</span> <span class="o">=</span> <span class="n">personalize</span><span class="o">.</span><span class="n">create_schema</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;personalize-poc-movielens-interactions&quot;</span><span class="p">,</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">interactions_schema</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">interaction_schema_arn</span> <span class="o">=</span> <span class="n">create_schema_response</span><span class="p">[</span><span class="s1">&#39;schemaArn&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">create_schema_response</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

<span class="n">dataset_type</span> <span class="o">=</span> <span class="s2">&quot;INTERACTIONS&quot;</span>
<span class="n">create_dataset_response</span> <span class="o">=</span> <span class="n">personalize</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;personalize-poc-movielens-ints&quot;</span><span class="p">,</span>
    <span class="n">datasetType</span> <span class="o">=</span> <span class="n">dataset_type</span><span class="p">,</span>
    <span class="n">datasetGroupArn</span> <span class="o">=</span> <span class="n">dataset_group_arn</span><span class="p">,</span>
    <span class="n">schemaArn</span> <span class="o">=</span> <span class="n">interaction_schema_arn</span>
<span class="p">)</span>

<span class="n">interactions_dataset_arn</span> <span class="o">=</span> <span class="n">create_dataset_response</span><span class="p">[</span><span class="s1">&#39;datasetArn&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">create_dataset_response</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">region</span> <span class="o">=</span> <span class="s1">&#39;us-east-1&#39;</span>
<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="n">account_id</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;sts&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_caller_identity</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Account&#39;</span><span class="p">)</span>
<span class="n">bucket_name</span> <span class="o">=</span> <span class="n">account_id</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">region</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;personalizepocvod&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
<span class="k">if</span> <span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">:</span>
    <span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span>
        <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span>
        <span class="n">CreateBucketConfiguration</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;LocationConstraint&#39;</span><span class="p">:</span> <span class="n">region</span><span class="p">}</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>746888961694-us-east-1-personalizepocvod
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">interactions_file_path</span> <span class="o">=</span> <span class="s1">&#39;./data/silver/ml-latest-small/interactions.csv&#39;</span>
<span class="n">interactions_filename</span> <span class="o">=</span> <span class="s1">&#39;interactions.csv&#39;</span>
<span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">interactions_filename</span><span class="p">)</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">interactions_file_path</span><span class="p">)</span>
<span class="n">interactions_s3DataPath</span> <span class="o">=</span> <span class="s2">&quot;s3://&quot;</span><span class="o">+</span><span class="n">bucket_name</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">interactions_filename</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="s2">&quot;PersonalizeS3BucketAccessPolicy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;PersonalizeS3BucketAccessPolicy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;personalize.amazonaws.com&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;s3:*Object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:ListBucket&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;arn:aws:s3:::</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">),</span>
                <span class="s2">&quot;arn:aws:s3:::</span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">s3</span><span class="o">.</span><span class="n">put_bucket_policy</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Policy</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">policy</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">iam</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;iam&quot;</span><span class="p">)</span>

<span class="n">role_name</span> <span class="o">=</span> <span class="s2">&quot;PersonalizeRolePOC&quot;</span>
<span class="n">assume_role_policy_document</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
          <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;personalize.amazonaws.com&quot;</span>
          <span class="p">},</span>
          <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">create_role_response</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">create_role</span><span class="p">(</span>
    <span class="n">RoleName</span> <span class="o">=</span> <span class="n">role_name</span><span class="p">,</span>
    <span class="n">AssumeRolePolicyDocument</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">assume_role_policy_document</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># AmazonPersonalizeFullAccess provides access to any S3 bucket with a name that includes &quot;personalize&quot; or &quot;Personalize&quot; </span>
<span class="c1"># if you would like to use a bucket with a different name, please consider creating and attaching a new policy</span>
<span class="c1"># that provides read access to your bucket or attaching the AmazonS3ReadOnlyAccess policy to the role</span>
<span class="n">policy_arn</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:iam::aws:policy/service-role/AmazonPersonalizeFullAccess&quot;</span>
<span class="n">iam</span><span class="o">.</span><span class="n">attach_role_policy</span><span class="p">(</span>
    <span class="n">RoleName</span> <span class="o">=</span> <span class="n">role_name</span><span class="p">,</span>
    <span class="n">PolicyArn</span> <span class="o">=</span> <span class="n">policy_arn</span>
<span class="p">)</span>

<span class="c1"># Now add S3 support</span>
<span class="n">iam</span><span class="o">.</span><span class="n">attach_role_policy</span><span class="p">(</span>
    <span class="n">PolicyArn</span><span class="o">=</span><span class="s1">&#39;arn:aws:iam::aws:policy/AmazonS3FullAccess&#39;</span><span class="p">,</span>
    <span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span>
<span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="c1"># wait for a minute to allow IAM role policy attachment to propagate</span>

<span class="n">role_arn</span> <span class="o">=</span> <span class="n">create_role_response</span><span class="p">[</span><span class="s2">&quot;Role&quot;</span><span class="p">][</span><span class="s2">&quot;Arn&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">role_arn</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>arn:aws:iam::746888961694:role/PersonalizeRolePOC
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">create_dataset_import_job_response</span> <span class="o">=</span> <span class="n">personalize</span><span class="o">.</span><span class="n">create_dataset_import_job</span><span class="p">(</span>
    <span class="n">jobName</span> <span class="o">=</span> <span class="s2">&quot;personalize-poc-import1&quot;</span><span class="p">,</span>
    <span class="n">datasetArn</span> <span class="o">=</span> <span class="n">interactions_dataset_arn</span><span class="p">,</span>
    <span class="n">dataSource</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dataLocation&quot;</span><span class="p">:</span> <span class="s2">&quot;s3://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">interactions_filename</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">roleArn</span> <span class="o">=</span> <span class="n">role_arn</span>
<span class="p">)</span>

<span class="n">dataset_import_job_arn</span> <span class="o">=</span> <span class="n">create_dataset_import_job_response</span><span class="p">[</span><span class="s1">&#39;datasetImportJobArn&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">create_dataset_import_job_response</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># wait fir this import job to gets activated</span>

<span class="n">max_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span> <span class="c1"># 6 hours</span>
<span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">max_time</span><span class="p">:</span>
    <span class="n">describe_dataset_import_job_response</span> <span class="o">=</span> <span class="n">personalize</span><span class="o">.</span><span class="n">describe_dataset_import_job</span><span class="p">(</span>
        <span class="n">datasetImportJobArn</span> <span class="o">=</span> <span class="n">dataset_import_job_arn</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">describe_dataset_import_job_response</span><span class="p">[</span><span class="s2">&quot;datasetImportJob&quot;</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DatasetImportJob: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">or</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;CREATE FAILED&quot;</span><span class="p">:</span>
        <span class="k">break</span>
        
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ETL-Job-for-Item-meta-using-generic-data-loading-module">ETL Job for Item meta using generic data loading module<a class="anchor-link" href="#ETL-Job-for-Item-meta-using-generic-data-loading-module"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;./code&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">generic_modules.import_dataset</span> <span class="kn">import</span> <span class="n">personalize_dataset</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">dataset_group_arn</span> <span class="o">=</span> <span class="s1">&#39;arn:aws:personalize:us-east-1:746888961694:dataset-group/immersion-day-dataset-group-movielens-latest&#39;</span>
<span class="n">bucket_name</span> <span class="o">=</span> <span class="s1">&#39;746888961694-us-east-1-personalizepocvod&#39;</span>
<span class="n">role_arn</span> <span class="o">=</span> <span class="s1">&#39;arn:aws:iam::746888961694:role/PersonalizeRolePOC&#39;</span>

<span class="n">dataset_type</span> <span class="o">=</span> <span class="s1">&#39;ITEMS&#39;</span>
<span class="n">source_data_path</span> <span class="o">=</span> <span class="s1">&#39;./data/silver/ml-latest-small/item-meta.csv&#39;</span>
<span class="n">target_file_name</span> <span class="o">=</span> <span class="s1">&#39;item-meta.csv&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">personalize_item_meta</span> <span class="o">=</span> <span class="n">personalize_dataset</span><span class="p">(</span>
    <span class="n">dataset_group_arn</span> <span class="o">=</span> <span class="n">dataset_group_arn</span><span class="p">,</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">bucket_name</span><span class="p">,</span>
    <span class="n">role_arn</span> <span class="o">=</span> <span class="n">role_arn</span><span class="p">,</span>
    <span class="n">dataset_type</span> <span class="o">=</span> <span class="n">dataset_type</span><span class="p">,</span>
    <span class="n">source_data_path</span> <span class="o">=</span> <span class="n">source_data_path</span><span class="p">,</span>
    <span class="n">target_file_name</span> <span class="o">=</span> <span class="n">target_file_name</span><span class="p">,</span>
    <span class="n">dataset_arn</span> <span class="o">=</span> <span class="n">dataset_arn</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">personalize_item_meta</span><span class="o">.</span><span class="n">setup_connection</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>SUCCESS | We can communicate with Personalize!
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">itemmetadata_schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;record&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Items&quot;</span><span class="p">,</span>
    <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;com.amazonaws.personalize.schema&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ITEM_ID&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;GENRE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;categorical&quot;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">},{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;YEAR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;CREATION_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;long&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">personalize_item_meta</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">itemmetadata_schema</span><span class="p">,</span>
                                     <span class="n">schema_name</span><span class="o">=</span><span class="s1">&#39;personalize-poc-movielens-item&#39;</span><span class="p">,</span>
                                     <span class="n">dataset_name</span><span class="o">=</span><span class="s1">&#39;personalize-poc-movielens-items&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">personalize_item_meta</span><span class="o">.</span><span class="n">dataset_arn</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;arn:aws:personalize:us-east-1:746888961694:dataset/immersion-day-dataset-group-movielens-latest/ITEMS&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">personalize_item_meta</span><span class="o">.</span><span class="n">upload_data_to_s3</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">personalize_item_meta</span><span class="o">.</span><span class="n">import_data_from_s3</span><span class="p">(</span><span class="n">import_job_name</span><span class="o">=</span><span class="s1">&#39;personalize-poc-item-import1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">personalize_dataset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">dataset_group_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">schema_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dataset_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dataset_type</span><span class="o">=</span><span class="s1">&#39;INTERACTIONS&#39;</span><span class="p">,</span>
                 <span class="n">region</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">,</span>
                 <span class="n">bucket_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">source_data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">target_file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dataset_import_job_arn</span><span class="o">=</span><span class="kc">None</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">personalize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">personalize_runtime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_group_arn</span> <span class="o">=</span> <span class="n">dataset_group_arn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema_arn</span> <span class="o">=</span> <span class="n">schema_arn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_arn</span> <span class="o">=</span> <span class="n">dataset_arn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_type</span> <span class="o">=</span> <span class="n">dataset_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span> <span class="o">=</span> <span class="n">bucket_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role_arn</span> <span class="o">=</span> <span class="n">role_arn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_data_path</span> <span class="o">=</span> <span class="n">source_data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_file_name</span> <span class="o">=</span> <span class="n">target_file_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_import_job_arn</span> <span class="o">=</span> <span class="n">dataset_import_job_arn</span>

    <span class="k">def</span> <span class="nf">setup_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">personalize</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;personalize&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">personalize_runtime</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;personalize-runtime&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iam</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;iam&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SUCCESS | We can communicate with Personalize!&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR | Connection can&#39;t be established!&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">create_dataset_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_group_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The highest level of isolation and abstraction with Amazon Personalize</span>
<span class="sd">        is a dataset group. Information stored within one of these dataset groups</span>
<span class="sd">        has no impact on any other dataset group or models created from one. they</span>
<span class="sd">        are completely isolated. This allows you to run many experiments and is</span>
<span class="sd">        part of how we keep your models private and fully trained only on your data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">create_dataset_group_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">personalize</span><span class="o">.</span><span class="n">create_dataset_group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dataset_group_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_group_arn</span> <span class="o">=</span> <span class="n">create_dataset_group_response</span><span class="p">[</span><span class="s1">&#39;datasetGroupArn&#39;</span><span class="p">]</span>
        <span class="c1"># print(json.dumps(create_dataset_group_response, indent=2))</span>

        <span class="c1"># Before we can use the dataset group, it must be active. </span>
        <span class="c1"># This can take a minute or two. Execute the cell below and wait for it</span>
        <span class="c1"># to show the ACTIVE status. It checks the status of the dataset group</span>
        <span class="c1"># every minute, up to a maximum of 3 hours.</span>
        <span class="n">max_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span> <span class="c1"># 3 hours</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">max_time</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dataset_group_status</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DatasetGroup: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">or</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;CREATE FAILED&quot;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_dataset_group_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the status of dataset group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">describe_dataset_group_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">personalize</span><span class="o">.</span><span class="n">describe_dataset_group</span><span class="p">(</span>
            <span class="n">datasetGroupArn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_group_arn</span>
            <span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">describe_dataset_group_response</span><span class="p">[</span><span class="s2">&quot;datasetGroup&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        First, define a schema to tell Amazon Personalize what type of dataset</span>
<span class="sd">        you are uploading. There are several reserved and mandatory keywords</span>
<span class="sd">        required in the schema, based on the type of dataset. More detailed</span>
<span class="sd">        information can be found in the documentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">create_schema_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">personalize</span><span class="o">.</span><span class="n">create_schema</span><span class="p">(</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">schema_name</span><span class="p">,</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema_arn</span> <span class="o">=</span> <span class="n">create_schema_response</span><span class="p">[</span><span class="s1">&#39;schemaArn&#39;</span><span class="p">]</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        With a schema created, you can create a dataset within the dataset group.</span>
<span class="sd">        Note that this does not load the data yet, it just defines the schema for</span>
<span class="sd">        the data. The data will be loaded a few steps later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">create_dataset_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">personalize</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dataset_name</span><span class="p">,</span>
            <span class="n">datasetType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_type</span><span class="p">,</span>
            <span class="n">datasetGroupArn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_group_arn</span><span class="p">,</span>
            <span class="n">schemaArn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_arn</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_arn</span> <span class="o">=</span> <span class="n">create_dataset_response</span><span class="p">[</span><span class="s1">&#39;datasetArn&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">create_s3_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span>
                <span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                <span class="n">CreateBucketConfiguration</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;LocationConstraint&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">}</span>
                <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">upload_data_to_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Now that your Amazon S3 bucket has been created, upload the CSV file of</span>
<span class="sd">        our user-item-interaction data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_data_path</span><span class="p">)</span>
        <span class="n">s3DataPath</span> <span class="o">=</span> <span class="s2">&quot;s3://&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">target_file_name</span>
    
    <span class="k">def</span> <span class="nf">set_s3_bucket_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Amazon Personalize needs to be able to read the contents of your S3</span>
<span class="sd">        bucket. So add a bucket policy which allows that.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="s2">&quot;PersonalizeS3BucketAccessPolicy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;PersonalizeS3BucketAccessPolicy&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;personalize.amazonaws.com&quot;</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="s2">&quot;s3:*Object&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;s3:ListBucket&quot;</span>
                        <span class="p">],</span>
                        <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="s2">&quot;arn:aws:s3:::</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">),</span>
                            <span class="s2">&quot;arn:aws:s3:::</span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">put_bucket_policy</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Policy</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">policy</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_iam_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Amazon Personalize needs the ability to assume roles in AWS in order to</span>
<span class="sd">        have the permissions to execute certain tasks. Let&#39;s create an IAM role</span>
<span class="sd">        and attach the required policies to it. The code below attaches very permissive</span>
<span class="sd">        policies; please use more restrictive policies for any production application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assume_role_policy_document</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;personalize.amazonaws.com&quot;</span>
                <span class="p">},</span>
                <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">create_role_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iam</span><span class="o">.</span><span class="n">create_role</span><span class="p">(</span>
            <span class="n">RoleName</span> <span class="o">=</span> <span class="n">role_name</span><span class="p">,</span>
            <span class="n">AssumeRolePolicyDocument</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">assume_role_policy_document</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># AmazonPersonalizeFullAccess provides access to any S3 bucket with a name that includes &quot;personalize&quot; or &quot;Personalize&quot; </span>
        <span class="c1"># if you would like to use a bucket with a different name, please consider creating and attaching a new policy</span>
        <span class="c1"># that provides read access to your bucket or attaching the AmazonS3ReadOnlyAccess policy to the role</span>
        <span class="n">policy_arn</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:iam::aws:policy/service-role/AmazonPersonalizeFullAccess&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iam</span><span class="o">.</span><span class="n">attach_role_policy</span><span class="p">(</span>
            <span class="n">RoleName</span> <span class="o">=</span> <span class="n">role_name</span><span class="p">,</span>
            <span class="n">PolicyArn</span> <span class="o">=</span> <span class="n">policy_arn</span>
        <span class="p">)</span>
        <span class="c1"># Now add S3 support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iam</span><span class="o">.</span><span class="n">attach_role_policy</span><span class="p">(</span>
            <span class="n">PolicyArn</span><span class="o">=</span><span class="s1">&#39;arn:aws:iam::aws:policy/AmazonS3FullAccess&#39;</span><span class="p">,</span>
            <span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span>
        <span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="c1"># wait for a minute to allow IAM role policy attachment to propagate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role_arn</span> <span class="o">=</span> <span class="n">create_role_response</span><span class="p">[</span><span class="s2">&quot;Role&quot;</span><span class="p">][</span><span class="s2">&quot;Arn&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">import_data_from_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_job_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Earlier you created the dataset group and dataset to house your information,</span>
<span class="sd">        so now you will execute an import job that will load the data from the S3</span>
<span class="sd">        bucket into the Amazon Personalize dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">create_dataset_import_job_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">personalize</span><span class="o">.</span><span class="n">create_dataset_import_job</span><span class="p">(</span>
        <span class="n">jobName</span> <span class="o">=</span> <span class="n">import_job_name</span><span class="p">,</span>
        <span class="n">datasetArn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_arn</span><span class="p">,</span>
        <span class="n">dataSource</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dataLocation&quot;</span><span class="p">:</span> <span class="s2">&quot;s3://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_file_name</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="n">roleArn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">role_arn</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_import_job_arn</span> <span class="o">=</span> <span class="n">create_dataset_import_job_response</span><span class="p">[</span><span class="s1">&#39;datasetImportJobArn&#39;</span><span class="p">]</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Before we can use the dataset, the import job must be active. Execute the</span>
<span class="sd">        cell below and wait for it to show the ACTIVE status. It checks the status</span>
<span class="sd">        of the import job every minute, up to a maximum of 6 hours.</span>
<span class="sd">        Importing the data can take some time, depending on the size of the dataset.</span>
<span class="sd">        In this workshop, the data import job should take around 15 minutes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span> <span class="c1"># 6 hours</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">max_time</span><span class="p">:</span>
            <span class="n">describe_dataset_import_job_response</span> <span class="o">=</span> <span class="n">personalize</span><span class="o">.</span><span class="n">describe_dataset_import_job</span><span class="p">(</span>
                <span class="n">datasetImportJobArn</span> <span class="o">=</span> <span class="n">dataset_import_job_arn</span>
            <span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_import_job_status</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DatasetImportJob: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">or</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;CREATE FAILED&quot;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">check_import_job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">describe_dataset_import_job_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">personalize</span><span class="o">.</span><span class="n">describe_dataset_import_job</span><span class="p">(</span>
            <span class="n">datasetImportJobArn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_import_job_arn</span>
        <span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">describe_dataset_import_job_response</span><span class="p">[</span><span class="s2">&quot;datasetImportJob&quot;</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;personalize&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;personalize_runtime&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;iam&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">attributes</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">dataset_arn</span> <span class="o">=</span> <span class="s1">&#39;arn:aws:personalize:us-east-1:746888961694:dataset/immersion-day-dataset-group-movielens-latest/ITEMS&#39;</span>
<span class="n">dataset_import_job_arn</span> <span class="o">=</span> <span class="s1">&#39;arn:aws:personalize:us-east-1:746888961694:dataset-import-job/personalize-poc-item-import1&#39;</span>

<span class="n">personalize_item_meta</span> <span class="o">=</span> <span class="n">personalize_dataset</span><span class="p">(</span>
    <span class="n">dataset_group_arn</span> <span class="o">=</span> <span class="n">dataset_group_arn</span><span class="p">,</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">bucket_name</span><span class="p">,</span>
    <span class="n">role_arn</span> <span class="o">=</span> <span class="n">role_arn</span><span class="p">,</span>
    <span class="n">dataset_type</span> <span class="o">=</span> <span class="n">dataset_type</span><span class="p">,</span>
    <span class="n">source_data_path</span> <span class="o">=</span> <span class="n">source_data_path</span><span class="p">,</span>
    <span class="n">target_file_name</span> <span class="o">=</span> <span class="n">target_file_name</span><span class="p">,</span>
    <span class="n">dataset_arn</span> <span class="o">=</span> <span class="n">dataset_arn</span><span class="p">,</span>
    <span class="n">dataset_import_job_arn</span> <span class="o">=</span> <span class="n">dataset_import_job_arn</span>
<span class="p">)</span>

<span class="n">personalize_item_meta</span><span class="o">.</span><span class="n">setup_connection</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>SUCCESS | We can communicate with Personalize!
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">personalize_item_meta</span><span class="o">.</span><span class="n">check_import_job_status</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;ACTIVE&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Saving-the-state">Saving the state<a class="anchor-link" href="#Saving-the-state"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./artifacts/etc/personalize_item_meta.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outp</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">personalize_item_meta</span><span class="p">,</span> <span class="n">outp</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">personalize_item_meta</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;bucket_name&#39;: &#39;746888961694-us-east-1-personalizepocvod&#39;,
 &#39;dataset_arn&#39;: &#39;arn:aws:personalize:us-east-1:746888961694:dataset/immersion-day-dataset-group-movielens-latest/ITEMS&#39;,
 &#39;dataset_group_arn&#39;: &#39;arn:aws:personalize:us-east-1:746888961694:dataset-group/immersion-day-dataset-group-movielens-latest&#39;,
 &#39;dataset_import_job_arn&#39;: &#39;arn:aws:personalize:us-east-1:746888961694:dataset-import-job/personalize-poc-item-import1&#39;,
 &#39;dataset_type&#39;: &#39;ITEMS&#39;,
 &#39;region&#39;: &#39;us-east-1&#39;,
 &#39;role_arn&#39;: &#39;arn:aws:iam::746888961694:role/PersonalizeRolePOC&#39;,
 &#39;schema_arn&#39;: None,
 &#39;source_data_path&#39;: &#39;./data/silver/ml-latest-small/item-meta.csv&#39;,
 &#39;target_file_name&#39;: &#39;item-meta.csv&#39;}</pre>
</div>

</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/2022/01/11/personalize-datalayer.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
