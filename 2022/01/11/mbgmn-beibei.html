<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>MB-GMN on BeiBei | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="MB-GMN on BeiBei" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/11/mbgmn-beibei.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/11/mbgmn-beibei.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-11T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="MB-GMN on BeiBei" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-11T00:00:00-06:00","datePublished":"2022-01-11T00:00:00-06:00","description":"Jupyter notebook database.","headline":"MB-GMN on BeiBei","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/11/mbgmn-beibei.html"},"url":"https://nb.recohut.com/2022/01/11/mbgmn-beibei.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">MB-GMN on BeiBei</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-11T00:00:00-06:00" itemprop="datePublished">
        Jan 11, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      22 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-11-mbgmn-beibei.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-11-mbgmn-beibei.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-11-mbgmn-beibei.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-11-mbgmn-beibei.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-11-mbgmn-beibei.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Executive-summary">Executive summary<a class="anchor-link" href="#Executive-summary"> </a></h2><table>
<thead><tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Problem</td>
<td>Modern recommender systems often embed users and items into low-dimensional latent representations, based on their observed interactions. In practical recommendation scenarios, users often exhibit various intents which drive them to interact with items with multiple behavior types (e.g., click, tag-as-favorite, purchase). However, the diversity of user behaviors is ignored in most of the existing approaches, which makes them difficult to capture heterogeneous relational structures across different types of interactive behaviors.</td>
</tr>
<tr>
<td>Prblm Stmt.</td>
<td>We define a three-way tensor $X \in \mathbb{R}^{𝐼×𝐽×𝐾}$ to reflect the multi-typed interaction (e.g., click, tag-as-favorite, purchase) between user ($𝑢_𝑖 \in U$) and item ($𝑣_𝑗 \in V$). Here, 𝐾 denotes the number of behavior types. Specifically, the individual element $𝑥_{i,j}^k \in X$ is set as 1 if user $𝑢_𝑖$ interacts with item $𝑣_𝑗$ under the 𝑘-th behavior type, and $𝑘_{𝑖,𝑗}$ = 0 otherwise. In the multi-behavior recommendation scenario, one type of user-item interaction will be treated as target behavior (e.g., purchase). Other behaviors are referred to as context behaviors (e.g., click, tag-as-favorite, add-to-cart) for providing insightful knowledge in assisting the target behavior prediction. Based on the aforementioned definitions, we formally state our studied problem as: • Input: the observed multi-behavior interaction tensor $X \in \mathbb{R}^{𝐼×𝐽×𝐾}$ between users U and items V across 𝐾 behavior types. • Output: the predictive function which estimates the likelihood of user $𝑢_𝑖$ adopts the item $𝑣_𝑗$ with the target behavior type.</td>
</tr>
<tr>
<td>Solution</td>
<td>Multi-Behavior recommendation framework with Graph Meta Network (MB-GMN) incorporate the multi-behavior pattern modeling into a meta-learning paradigm. Our developed MB-GMN empowers the user-item interaction learning with the capability of uncovering type-dependent behavior representations, which automatically distills the behavior heterogeneity and interaction diversity for recommendations. MB-GMN is composed of two key components: i) multi-behavior pattern encoding, a meta-knowledge learner that captures the personalized multi-behavior characteristics; ii) cross-type behavior dependency modeling, a transfer learning paradigm which learns a well-customized prediction network by transferring knowledge across different behavior types.</td>
</tr>
<tr>
<td>Dataset</td>
<td>BeiBei.</td>
</tr>
<tr>
<td>Preprocessing</td>
<td>Leave-one-out evaluation is leveraged for training and test set partition. We generate the test data set by including the last interactive item and consider the rest of data for training. For efficient and fair model evaluation, we pair each positive item instance with 99 randomly sampled non-interactive items for each user. We regard users’ purchases as the target behaviors.</td>
</tr>
<tr>
<td>Metrics</td>
<td>NDCG, HR</td>
</tr>
<tr>
<td>Models</td>
<td>MB-GMN</td>
</tr>
<tr>
<td>Cluster</td>
<td>Python 3.6+, Tensorflow 1.x</td>
</tr>
<tr>
<td>Tags</td>
<td><code>MetaLearning</code>, <code>GNN</code></td>
</tr>
<tr>
<td>Credits</td>
<td>akaxlh</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Process-flow">Process flow<a class="anchor-link" href="#Process-flow"> </a></h2><p><img src="https://github.com/RecoHut-Stanzas/S346877/raw/main/images/process_flow.svg" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model-architecture">Model architecture<a class="anchor-link" href="#Model-architecture"> </a></h2><p><img src="https://github.com/RecoHut-Stanzas/S346877/raw/main/images/mbgmn_model.png" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>The model architecture of MB-GMN. (a) Multi-behavior pattern modeling with meta-knowledge learner for behavior heterogeneity; (b) Meta graph neural network which preserves the behavior semantics with high-order connectivity; (c) Metaknowledge transfer networks that customize the parameter of prediction layer to capture cross-type behavior dependency.</em></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="o">%</span><span class="n">tensorflow_version</span> <span class="mf">1.</span><span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>TensorFlow 1.x selected.
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.core.protobuf</span> <span class="kn">import</span> <span class="n">config_pb2</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">tensorflow.contrib.layers</span> <span class="kn">import</span> <span class="n">xavier_initializer</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;./History&#39;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
	<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Model Params&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lr&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;learning rate&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;batch size&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--reg&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;weight decay regularizer&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--epoch&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of epochs&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--decay&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.96</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;weight decay rate&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_path&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;tem&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;file name to save model and training record&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--latdim&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;embedding size&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rank&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;embedding size&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--memosize&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;memory size&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sampNum&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;batch size for sampling&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--att_head&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of attention heads&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--gnn_layer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of gnn layers&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--trnNum&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of training instances per epoch&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--load_model&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;model name to load&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--shoot&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;K of top k&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--data&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;beibei&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;name of dataset&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--target&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;target behavior to predict on&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--deep_layer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of deep layers to make the final prediction&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--mult&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;multiplier for the result&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--keepRate&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;rate for dropout&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slot&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;length of time slots&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--graphSampleN&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use 25000 for training and 200000 for testing, empirically&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--divSize&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;div size for smallTestEpoch&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tstEpoch&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of epoch to test while training&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--subUsrSize&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of item for each sub-user&#39;</span><span class="p">)</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--subUsrDcy&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;decay factor for sub-users over time&#39;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([])</span>
 
<span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>

<span class="n">args</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="mi">21716</span>
<span class="n">args</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">7977</span>
<span class="n">args</span><span class="o">.</span><span class="n">decay_step</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">trnNum</span><span class="o">//</span><span class="n">args</span><span class="o">.</span><span class="n">batch</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Utils">Utils<a class="anchor-link" href="#Utils"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">logmsg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">timemark</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">saveDefault</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">oneline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">logmsg</span>
	<span class="k">global</span> <span class="n">saveDefault</span>
	<span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
	<span class="n">tem</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">save</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">save</span><span class="p">:</span>
			<span class="n">logmsg</span> <span class="o">+=</span> <span class="n">tem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
	<span class="k">elif</span> <span class="n">saveDefault</span><span class="p">:</span>
		<span class="n">logmsg</span> <span class="o">+=</span> <span class="n">tem</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
	<span class="k">if</span> <span class="n">oneline</span><span class="p">:</span>
		<span class="nb">print</span><span class="p">(</span><span class="n">tem</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="nb">print</span><span class="p">(</span><span class="n">tem</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">marktime</span><span class="p">(</span><span class="n">marker</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">timemark</span>
	<span class="n">timemark</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">SpentTime</span><span class="p">(</span><span class="n">marker</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">timemark</span>
	<span class="k">if</span> <span class="n">marker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">timemark</span><span class="p">:</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;LOGGER ERROR, marker&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="s1">&#39; not found&#39;</span>
		<span class="n">tem</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="n">tem</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">False</span>
	<span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timemark</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">SpentTooLong</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">timemark</span>
	<span class="k">if</span> <span class="n">marker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">timemark</span><span class="p">:</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;LOGGER ERROR, marker&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="s1">&#39; not found&#39;</span>
		<span class="n">tem</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="n">tem</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">False</span>
	<span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timemark</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">day</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">hour</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="n">minute</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="n">second</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">RandomShuffle</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">deleteSchema</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
		<span class="n">arr</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
		<span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
	<span class="k">if</span> <span class="n">deleteSchema</span><span class="p">:</span>
		<span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
	<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
			<span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
	<span class="k">del</span> <span class="n">arr</span>

<span class="k">def</span> <span class="nf">WriteToBuff</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
	<span class="n">BUFF_SIZE</span> <span class="o">=</span> <span class="mi">1000000</span>
	<span class="n">buff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span> <span class="o">==</span> <span class="n">BUFF_SIZE</span><span class="p">:</span>
		<span class="n">WriteToDisk</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">WriteToDisk</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">buff</span><span class="p">:</span>
			<span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
	<span class="n">buff</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">SubDataSet</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile1</span><span class="p">,</span> <span class="n">outfile2</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
	<span class="n">out1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
	<span class="n">out2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">rate</span><span class="p">:</span>
				<span class="n">WriteToBuff</span><span class="p">(</span><span class="n">out1</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">outfile1</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">WriteToBuff</span><span class="p">(</span><span class="n">out2</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">outfile2</span><span class="p">)</span>
	<span class="n">WriteToDisk</span><span class="p">(</span><span class="n">out1</span><span class="p">,</span> <span class="n">outfile1</span><span class="p">)</span>
	<span class="n">WriteToDisk</span><span class="p">(</span><span class="n">out2</span><span class="p">,</span> <span class="n">outfile2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">CombineFiles</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
	<span class="n">buff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
				<span class="n">WriteToBuff</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
	<span class="n">WriteToDisk</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="NN-Layers">NN Layers<a class="anchor-link" href="#NN-Layers"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">paramId</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">biasDefault</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">regParams</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ita</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">leaky</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="k">def</span> <span class="nf">getParamId</span><span class="p">():</span>
	<span class="k">global</span> <span class="n">paramId</span>
	<span class="n">paramId</span> <span class="o">+=</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="n">paramId</span>

<span class="k">def</span> <span class="nf">setIta</span><span class="p">(</span><span class="n">ITA</span><span class="p">):</span>
	<span class="n">ita</span> <span class="o">=</span> <span class="n">ITA</span>

<span class="k">def</span> <span class="nf">setBiasDefault</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">biasDefault</span>
	<span class="n">biasDefault</span> <span class="o">=</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">getParam</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">addReg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">regParams</span>
	<span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">regParams</span><span class="p">:</span>
		<span class="n">regParams</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Parameter already exists&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">addParam</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">params</span>
	<span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
		<span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>

<span class="k">def</span> <span class="nf">defineRandomNameParam</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;defaultParamName</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">getParamId</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">defineParam</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">trainable</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">defineParam</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">params</span>
	<span class="k">global</span> <span class="n">regParams</span>
	<span class="k">assert</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">,</span> <span class="s1">&#39;name </span><span class="si">%s</span><span class="s1"> already exists&#39;</span> <span class="o">%</span> <span class="n">name</span>
	<span class="k">if</span> <span class="n">initializer</span> <span class="o">==</span> <span class="s1">&#39;xavier&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
			<span class="n">initializer</span><span class="o">=</span><span class="n">xavier_initializer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
			<span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">initializer</span> <span class="o">==</span> <span class="s1">&#39;trunc_normal&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span>
	<span class="k">elif</span> <span class="n">initializer</span> <span class="o">==</span> <span class="s1">&#39;zeros&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
			<span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
			<span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">initializer</span> <span class="o">==</span> <span class="s1">&#39;ones&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">)</span>
	<span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initializer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
			<span class="n">initializer</span><span class="o">=</span><span class="n">initializer</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Unrecognized initializer&#39;</span><span class="p">)</span>
		<span class="n">exit</span><span class="p">()</span>
	<span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
	<span class="k">if</span> <span class="n">reg</span><span class="p">:</span>
		<span class="n">regParams</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
	<span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">getOrDefineParam</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">params</span>
	<span class="k">global</span> <span class="n">regParams</span>
	<span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
		<span class="k">assert</span> <span class="n">reuse</span><span class="p">,</span> <span class="s1">&#39;Reusing Param </span><span class="si">%s</span><span class="s1"> Not Specified&#39;</span> <span class="o">%</span> <span class="n">name</span>
		<span class="k">if</span> <span class="n">reg</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">regParams</span><span class="p">:</span>
			<span class="n">regParams</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
	<span class="k">return</span> <span class="n">defineParam</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">trainable</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">BN</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">ita</span>
	<span class="n">dim</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;defaultParamName</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">getParamId</span><span class="p">()</span>
	<span class="n">scale</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">dim</span><span class="p">]))</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dim</span><span class="p">]))</span>
	<span class="n">fcMean</span><span class="p">,</span> <span class="n">fcVar</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">ema</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ExponentialMovingAverage</span><span class="p">(</span><span class="n">decay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
	<span class="n">emaApplyOp</span> <span class="o">=</span> <span class="n">ema</span><span class="o">.</span><span class="n">apply</span><span class="p">([</span><span class="n">fcMean</span><span class="p">,</span> <span class="n">fcVar</span><span class="p">])</span>
	<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">control_dependencies</span><span class="p">([</span><span class="n">emaApplyOp</span><span class="p">]):</span>
		<span class="n">mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">fcMean</span><span class="p">)</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">fcVar</span><span class="p">)</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">batch_normalization</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span>
		<span class="n">scale</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">FC</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">outDim</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useBN</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">biasReg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">biasInitializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">params</span>
	<span class="k">global</span> <span class="n">regParams</span>
	<span class="k">global</span> <span class="n">leaky</span>
	<span class="n">inDim</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">temName</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span><span class="o">!=</span><span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;defaultParamName</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">getParamId</span><span class="p">()</span>
	<span class="n">W</span> <span class="o">=</span> <span class="n">getOrDefineParam</span><span class="p">(</span><span class="n">temName</span><span class="p">,</span> <span class="p">[</span><span class="n">inDim</span><span class="p">,</span> <span class="n">outDim</span><span class="p">],</span> <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">initializer</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">dropout</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span> <span class="o">@</span> <span class="n">W</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">inp</span> <span class="o">@</span> <span class="n">W</span>
	<span class="k">if</span> <span class="n">useBias</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">Bias</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="n">biasReg</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">biasInitializer</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">useBN</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">BN</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">activation</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">Activate</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">activation</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">Bias</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">):</span>
	<span class="n">inDim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">temName</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span><span class="o">!=</span><span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;defaultParamName</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">getParamId</span><span class="p">()</span>
	<span class="n">temBiasName</span> <span class="o">=</span> <span class="n">temName</span> <span class="o">+</span> <span class="s1">&#39;Bias&#39;</span>
	<span class="n">bias</span> <span class="o">=</span> <span class="n">getOrDefineParam</span><span class="p">(</span><span class="n">temBiasName</span><span class="p">,</span> <span class="n">inDim</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">initializer</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">reg</span><span class="p">:</span>
		<span class="n">regParams</span><span class="p">[</span><span class="n">temBiasName</span><span class="p">]</span> <span class="o">=</span> <span class="n">bias</span>
	<span class="k">return</span> <span class="n">data</span> <span class="o">+</span> <span class="n">bias</span>

<span class="k">def</span> <span class="nf">ActivateHelp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;relu&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;tanh&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;softmax&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;leakyRelu&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">leaky</span><span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;twoWayLeakyRelu6&#39;</span><span class="p">:</span>
		<span class="n">temMask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">temMask</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">leaky</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="mi">6</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">temMask</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">leaky</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;-1relu&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;relu6&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">6.0</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
	<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;relu3&#39;</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error Activation Function&#39;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">Activate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">useBN</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">leaky</span>
	<span class="k">if</span> <span class="n">useBN</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">BN</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">data</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ActivateHelp</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">Regularize</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L2&#39;</span><span class="p">):</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;L1&#39;</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">names</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
				<span class="n">ret</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">getParam</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">regParams</span><span class="p">:</span>
				<span class="n">ret</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">regParams</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
	<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;L2&#39;</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">names</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
				<span class="n">ret</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">getParam</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">regParams</span><span class="p">:</span>
				<span class="n">ret</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">regParams</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
	<span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">Dropout</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">rate</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">data</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">selfAttention</span><span class="p">(</span><span class="n">localReps</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">,</span> <span class="n">numHeads</span><span class="p">):</span>
	<span class="n">Q</span> <span class="o">=</span> <span class="n">defineRandomNameParam</span><span class="p">([</span><span class="n">inpDim</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">],</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">K</span> <span class="o">=</span> <span class="n">defineRandomNameParam</span><span class="p">([</span><span class="n">inpDim</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">],</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">V</span> <span class="o">=</span> <span class="n">defineRandomNameParam</span><span class="p">([</span><span class="n">inpDim</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">],</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">rspReps</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">localReps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">])</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rspReps</span> <span class="o">@</span> <span class="n">Q</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numHeads</span><span class="p">,</span> <span class="n">inpDim</span><span class="o">//</span><span class="n">numHeads</span><span class="p">])</span>
	<span class="n">k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rspReps</span> <span class="o">@</span> <span class="n">K</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">numHeads</span><span class="p">,</span> <span class="n">inpDim</span><span class="o">//</span><span class="n">numHeads</span><span class="p">])</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rspReps</span> <span class="o">@</span> <span class="n">V</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">numHeads</span><span class="p">,</span> <span class="n">inpDim</span><span class="o">//</span><span class="n">numHeads</span><span class="p">])</span>
	<span class="n">att</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">inpDim</span><span class="o">/</span><span class="n">numHeads</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
	<span class="n">attval</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">att</span> <span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">])</span>
	<span class="n">rets</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number</span>
	<span class="n">paramId</span> <span class="o">=</span> <span class="s1">&#39;dfltP</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">getParamId</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
		<span class="n">tem1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">attval</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">])</span>
		<span class="c1"># tem2 = FC(tem1, inpDim, useBias=True, name=paramId+&#39;_1&#39;, reg=True, activation=&#39;relu&#39;, reuse=True) + localReps[i]</span>
		<span class="n">rets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tem1</span> <span class="o">+</span> <span class="n">localReps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	<span class="k">return</span> <span class="n">rets</span>

<span class="k">def</span> <span class="nf">lightSelfAttention</span><span class="p">(</span><span class="n">localReps</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">,</span> <span class="n">numHeads</span><span class="p">):</span>
	<span class="n">Q</span> <span class="o">=</span> <span class="n">defineRandomNameParam</span><span class="p">([</span><span class="n">inpDim</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">],</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">rspReps</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">localReps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">])</span>
	<span class="n">tem</span> <span class="o">=</span> <span class="n">rspReps</span> <span class="o">@</span> <span class="n">Q</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tem</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numHeads</span><span class="p">,</span> <span class="n">inpDim</span><span class="o">//</span><span class="n">numHeads</span><span class="p">])</span>
	<span class="n">k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tem</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">numHeads</span><span class="p">,</span> <span class="n">inpDim</span><span class="o">//</span><span class="n">numHeads</span><span class="p">])</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rspReps</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">numHeads</span><span class="p">,</span> <span class="n">inpDim</span><span class="o">//</span><span class="n">numHeads</span><span class="p">])</span>
	<span class="c1"># att = tf.nn.softmax(tf.reduce_sum(q * k, axis=-1, keepdims=True) * tf.sqrt(inpDim/numHeads), axis=2)</span>
	<span class="n">att</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">inpDim</span><span class="o">/</span><span class="n">numHeads</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
	<span class="n">attval</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">att</span> <span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">])</span>
	<span class="n">rets</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number</span>
	<span class="n">paramId</span> <span class="o">=</span> <span class="s1">&#39;dfltP</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">getParamId</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
		<span class="n">tem1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">attval</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">inpDim</span><span class="p">])</span>
		<span class="c1"># tem2 = FC(tem1, inpDim, useBias=True, name=paramId+&#39;_1&#39;, reg=True, activation=&#39;relu&#39;, reuse=True) + localReps[i]</span>
		<span class="n">rets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tem1</span> <span class="o">+</span> <span class="n">localReps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	<span class="k">return</span> <span class="n">rets</span><span class="c1">#, tf.squeeze(att)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset">Dataset<a class="anchor-link" href="#Dataset"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">git</span> <span class="n">clone</span> <span class="o">--</span><span class="n">branch</span> <span class="n">v1</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">RecoHut</span><span class="o">-</span><span class="n">Datasets</span><span class="o">/</span><span class="n">beibei</span><span class="o">.</span><span class="n">git</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
	<span class="n">coomat</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">coomat</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">negSamp</span><span class="p">(</span><span class="n">temLabel</span><span class="p">,</span> <span class="n">sampSize</span><span class="p">,</span> <span class="n">nodeNum</span><span class="p">):</span>
	<span class="n">negset</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sampSize</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">while</span> <span class="n">cur</span> <span class="o">&lt;</span> <span class="n">sampSize</span><span class="p">:</span>
		<span class="n">rdmItm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nodeNum</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">temLabel</span><span class="p">[</span><span class="n">rdmItm</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">negset</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdmItm</span>
			<span class="n">cur</span> <span class="o">+=</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="n">negset</span>

<span class="k">def</span> <span class="nf">transToLsts</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
	<span class="n">coomat</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
	<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coomat</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">coomat</span><span class="o">.</span><span class="n">col</span><span class="p">))),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">coomat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
		<span class="n">rowD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)))</span>
		<span class="n">colD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)))</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
			<span class="n">row</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
			<span class="n">col</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rowD</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">*</span> <span class="n">colD</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

	<span class="c1"># half mask</span>
	<span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
		<span class="n">spMask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">spMask</span>

	<span class="k">if</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">indices</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">shape</span>

<span class="k">class</span> <span class="nc">DataHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">predir</span> <span class="o">=</span> <span class="s1">&#39;./beibei/&#39;</span>
        <span class="n">behs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">,</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predir</span> <span class="o">=</span> <span class="n">predir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behs</span> <span class="o">=</span> <span class="n">behs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trnfile</span> <span class="o">=</span> <span class="n">predir</span> <span class="o">+</span> <span class="s1">&#39;trn_&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstfile</span> <span class="o">=</span> <span class="n">predir</span> <span class="o">+</span> <span class="s1">&#39;tst_&#39;</span>

    <span class="k">def</span> <span class="nf">LoadData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">trnMats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behs</span><span class="p">)):</span>
            <span class="n">beh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trnfile</span> <span class="o">+</span> <span class="n">beh</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">trnMats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="c1"># test set</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstfile</span> <span class="o">+</span> <span class="s1">&#39;int&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
            <span class="n">tstInt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fs</span><span class="p">))</span>
        <span class="n">tstStat</span> <span class="o">=</span> <span class="p">(</span><span class="n">tstInt</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">tstUsrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">tstStat</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trnMats</span> <span class="o">=</span> <span class="n">trnMats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstInt</span> <span class="o">=</span> <span class="n">tstInt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstUsrs</span> <span class="o">=</span> <span class="n">tstUsrs</span>
        <span class="n">args</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trnMats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">args</span><span class="o">.</span><span class="n">behNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepareGlobalData</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">prepareGlobalData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span><span class="p">):</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="n">adj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trnMats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">adj</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">tpadj</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>
        <span class="n">adjNorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">tpadjNorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tpadj</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">adj</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">adj</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">adj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">adjNorm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tpadj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tpadj</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tpadj</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">tpadj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">tpadjNorm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adj</span> <span class="o">=</span> <span class="n">adj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tpadj</span> <span class="o">=</span> <span class="n">tpadj</span>

    <span class="k">def</span> <span class="nf">sampleLargeGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pckUsrs</span><span class="p">,</span> <span class="n">pckItms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sampDepth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sampNum</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">graphSampleN</span><span class="p">,</span> <span class="n">preSamp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adj</span>
        <span class="n">tpadj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpadj</span>
        <span class="k">def</span> <span class="nf">makeMask</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">nodes</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">return</span> <span class="n">mask</span>

        <span class="k">def</span> <span class="nf">updateBdgt</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="n">tembat</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">/</span> <span class="n">tembat</span><span class="p">))):</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">tembat</span> <span class="o">*</span> <span class="n">i</span>
                <span class="n">ed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tembat</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>
                <span class="n">temNodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">st</span><span class="p">:</span> <span class="n">ed</span><span class="p">]</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">temNodes</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">sampNum</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">budget</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">sampNum</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">score</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">score</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span>
            <span class="n">arrScore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="n">posNum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">posNum</span> <span class="o">&lt;</span> <span class="n">sampNum</span><span class="p">:</span>
                <span class="n">pckNodes1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">arrScore</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span>
                <span class="c1"># pckNodes2 = np.random.choice(np.squeeze(np.argwhere(arrScore==0.0)), min(len(score) - posNum, sampNum - posNum), replace=False)</span>
                <span class="c1"># pckNodes = np.concatenate([pckNodes1, pckNodes2], axis=0)</span>
                <span class="n">pckNodes</span> <span class="o">=</span> <span class="n">pckNodes1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pckNodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="n">sampNum</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">score</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pckNodes</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">sampNum</span> <span class="o">-</span> <span class="n">posNum</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">constructData</span><span class="p">(</span><span class="n">usrs</span><span class="p">,</span> <span class="n">itms</span><span class="p">):</span>
            <span class="n">adjs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trnMats</span>
            <span class="n">pckAdjs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pckTpAdjs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adjs</span><span class="p">)):</span>
                <span class="n">pckU</span> <span class="o">=</span> <span class="n">adjs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">usrs</span><span class="p">]</span>
                <span class="n">tpPckI</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">pckU</span><span class="p">)[</span><span class="n">itms</span><span class="p">]</span>
                <span class="n">pckTpAdjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpPckI</span><span class="p">)</span>
                <span class="n">pckAdjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">tpPckI</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">pckAdjs</span><span class="p">,</span> <span class="n">pckTpAdjs</span><span class="p">,</span> <span class="n">usrs</span><span class="p">,</span> <span class="n">itms</span>

        <span class="n">usrMask</span> <span class="o">=</span> <span class="n">makeMask</span><span class="p">(</span><span class="n">pckUsrs</span><span class="p">,</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">itmMask</span> <span class="o">=</span> <span class="n">makeMask</span><span class="p">(</span><span class="n">pckItms</span><span class="p">,</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">itmBdgt</span> <span class="o">=</span> <span class="n">updateBdgt</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">pckUsrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pckItms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pckItms</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">itmBdgt</span><span class="p">,</span> <span class="n">itmMask</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pckUsrs</span><span class="p">))</span>
            <span class="n">itmMask</span> <span class="o">=</span> <span class="n">itmMask</span> <span class="o">*</span> <span class="n">makeMask</span><span class="p">(</span><span class="n">pckItms</span><span class="p">,</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">usrBdgt</span> <span class="o">=</span> <span class="n">updateBdgt</span><span class="p">(</span><span class="n">tpadj</span><span class="p">,</span> <span class="n">pckItms</span><span class="p">)</span>
        <span class="n">uSampRes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iSampRes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sampDepth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">uSamp</span> <span class="o">=</span> <span class="n">uSampRes</span> <span class="o">+</span> <span class="p">(</span><span class="n">sampNum</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sampDepth</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">iSamp</span> <span class="o">=</span> <span class="n">iSampRes</span> <span class="o">+</span> <span class="p">(</span><span class="n">sampNum</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sampDepth</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">newUsrs</span><span class="p">,</span> <span class="n">uSampRes</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">usrBdgt</span><span class="p">,</span> <span class="n">usrMask</span><span class="p">,</span> <span class="n">uSamp</span><span class="p">)</span>
            <span class="n">usrMask</span> <span class="o">=</span> <span class="n">usrMask</span> <span class="o">*</span> <span class="n">makeMask</span><span class="p">(</span><span class="n">newUsrs</span><span class="p">,</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">newItms</span><span class="p">,</span> <span class="n">iSampRes</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">itmBdgt</span><span class="p">,</span> <span class="n">itmMask</span><span class="p">,</span> <span class="n">iSamp</span><span class="p">)</span>
            <span class="n">itmMask</span> <span class="o">=</span> <span class="n">itmMask</span> <span class="o">*</span> <span class="n">makeMask</span><span class="p">(</span><span class="n">newItms</span><span class="p">,</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">sampDepth</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">sampDepth</span> <span class="ow">and</span> <span class="n">uSampRes</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">iSampRes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">usrBdgt</span> <span class="o">+=</span> <span class="n">updateBdgt</span><span class="p">(</span><span class="n">tpadj</span><span class="p">,</span> <span class="n">newItms</span><span class="p">)</span>
            <span class="n">itmBdgt</span> <span class="o">+=</span> <span class="n">updateBdgt</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">newUsrs</span><span class="p">)</span>
        <span class="n">usrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">usrMask</span><span class="o">==</span><span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">itms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">itmMask</span><span class="o">==</span><span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">constructData</span><span class="p">(</span><span class="n">usrs</span><span class="p">,</span> <span class="n">itms</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model">Model<a class="anchor-link" href="#Model"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Recommender</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>

		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;USER&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;ITEM&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">item</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
		<span class="n">mets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Loss&#39;</span><span class="p">,</span> <span class="s1">&#39;preLoss&#39;</span><span class="p">,</span> <span class="s1">&#39;HR&#39;</span><span class="p">,</span> <span class="s1">&#39;NDCG&#39;</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">mets</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Train&#39;</span> <span class="o">+</span> <span class="n">met</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span> <span class="o">+</span> <span class="n">met</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">makePrint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">reses</span><span class="p">,</span> <span class="n">save</span><span class="p">):</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s1">&#39;Epoch </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">, </span><span class="si">%s</span><span class="s1">: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">reses</span><span class="p">:</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">reses</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%.4f</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">tem</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="n">metric</span>
			<span class="k">if</span> <span class="n">save</span> <span class="ow">and</span> <span class="n">tem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">tem</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prepareModel</span><span class="p">()</span>
		<span class="n">log</span><span class="p">(</span><span class="s1">&#39;Model Prepared&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load_model</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">loadModel</span><span class="p">()</span>
			<span class="n">stloc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;TrainLoss&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">tstEpoch</span> <span class="o">-</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tstEpoch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">stloc</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">init</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
			<span class="n">log</span><span class="p">(</span><span class="s1">&#39;Variables Initiated&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stloc</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">)):</span>
			<span class="n">test</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">tstEpoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">reses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainEpoch</span><span class="p">()</span>
			<span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">makePrint</span><span class="p">(</span><span class="s1">&#39;Train&#39;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">reses</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">test</span><span class="p">:</span>
				<span class="n">reses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testEpoch</span><span class="p">()</span>
				<span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">makePrint</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">reses</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">ep</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">tstEpoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">saveHistory</span><span class="p">()</span>
			<span class="nb">print</span><span class="p">()</span>
		<span class="n">reses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testEpoch</span><span class="p">()</span>
		<span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">makePrint</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">reses</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">saveHistory</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">messagePropagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">adj</span><span class="p">,</span> <span class="n">lats2</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">Activate</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">sparse_dense_matmul</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">lats</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">actFunc</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">metaForSpecialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uEmbed</span><span class="p">,</span> <span class="n">iEmbed</span><span class="p">,</span> <span class="n">behEmbed</span><span class="p">,</span> <span class="n">adjs</span><span class="p">,</span> <span class="n">tpAdjs</span><span class="p">):</span>
		<span class="n">latdim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">latdim</span> <span class="o">//</span> <span class="mi">2</span>
		<span class="n">rank</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">rank</span>
		<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">adjs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tpAdjs</span><span class="p">)</span>
		<span class="n">uNeighbor</span> <span class="o">=</span> <span class="n">iNeighbor</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adjs</span><span class="p">)):</span>
			<span class="n">uNeighbor</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">sparse_dense_matmul</span><span class="p">(</span><span class="n">adjs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">iEmbed</span><span class="p">)</span>
			<span class="n">iNeighbor</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">sparse_dense_matmul</span><span class="p">(</span><span class="n">tpAdjs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">uEmbed</span><span class="p">)</span>
		<span class="n">ubehEmbed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">behEmbed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">uEmbed</span><span class="p">)</span>
		<span class="n">ibehEmbed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">behEmbed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">iEmbed</span><span class="p">)</span>
		<span class="n">uMetaLat</span> <span class="o">=</span> <span class="n">FC</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ubehEmbed</span><span class="p">,</span> <span class="n">uEmbed</span><span class="p">,</span> <span class="n">uNeighbor</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actFunc</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;specMeta_FC1&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">iMetaLat</span> <span class="o">=</span> <span class="n">FC</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ibehEmbed</span><span class="p">,</span> <span class="n">iEmbed</span><span class="p">,</span> <span class="n">iNeighbor</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actFunc</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;specMeta_FC1&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">uW1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">FC</span><span class="p">(</span><span class="n">uMetaLat</span><span class="p">,</span> <span class="n">rank</span> <span class="o">*</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">biasInitializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">,</span> <span class="n">biasReg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;specMeta_FC2&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">rank</span><span class="p">])</span>
		<span class="n">uW2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">FC</span><span class="p">(</span><span class="n">uMetaLat</span><span class="p">,</span> <span class="n">rank</span> <span class="o">*</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">biasInitializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">,</span> <span class="n">biasReg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;specMeta_FC3&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">latdim</span><span class="p">])</span>
		<span class="n">iW1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">FC</span><span class="p">(</span><span class="n">iMetaLat</span><span class="p">,</span> <span class="n">rank</span> <span class="o">*</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">biasInitializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">,</span> <span class="n">biasReg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;specMeta_FC4&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">rank</span><span class="p">])</span>
		<span class="n">iW2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">FC</span><span class="p">(</span><span class="n">iMetaLat</span><span class="p">,</span> <span class="n">rank</span> <span class="o">*</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">biasInitializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">,</span> <span class="n">biasReg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;specMeta_FC5&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">latdim</span><span class="p">])</span>

		<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uW1&#39;</span><span class="p">:</span> <span class="n">uW1</span><span class="p">,</span> <span class="s1">&#39;uW2&#39;</span><span class="p">:</span> <span class="n">uW2</span><span class="p">,</span> <span class="s1">&#39;iW1&#39;</span><span class="p">:</span> <span class="n">iW1</span><span class="p">,</span> <span class="s1">&#39;iW2&#39;</span><span class="p">:</span> <span class="n">iW2</span><span class="p">}</span>
		<span class="k">return</span> <span class="n">params</span>

	<span class="k">def</span> <span class="nf">specialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uEmbed</span><span class="p">,</span> <span class="n">iEmbed</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
		<span class="n">retUEmbed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">uEmbed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;uW1&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">retUEmbed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">retUEmbed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;uW2&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">retUEmbed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">retUEmbed</span><span class="p">,</span> <span class="n">uEmbed</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">retIEmbed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">iEmbed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;iW1&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">retIEmbed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">retIEmbed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;iW2&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">retIEmbed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">retIEmbed</span><span class="p">,</span> <span class="n">iEmbed</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retUEmbed</span><span class="p">,</span> <span class="n">retIEmbed</span>

	<span class="k">def</span> <span class="nf">defineModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">uEmbed0</span> <span class="o">=</span> <span class="n">defineParam</span><span class="p">(</span><span class="s1">&#39;uEmbed0&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">latdim</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">iEmbed0</span> <span class="o">=</span> <span class="n">defineParam</span><span class="p">(</span><span class="s1">&#39;iEmbed0&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">item</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">latdim</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">behEmbeds</span> <span class="o">=</span> <span class="n">defineParam</span><span class="p">(</span><span class="s1">&#39;behEmbeds&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">latdim</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ulat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ilat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">beh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span><span class="p">):</span>
			<span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaForSpecialize</span><span class="p">(</span><span class="n">uEmbed0</span><span class="p">,</span> <span class="n">iEmbed0</span><span class="p">,</span> <span class="n">behEmbeds</span><span class="p">[</span><span class="n">beh</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">adjs</span><span class="p">[</span><span class="n">beh</span><span class="p">]],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tpAdjs</span><span class="p">[</span><span class="n">beh</span><span class="p">]])</span>
			<span class="n">behUEmbed0</span><span class="p">,</span> <span class="n">behIEmbed0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specialize</span><span class="p">(</span><span class="n">uEmbed0</span><span class="p">,</span> <span class="n">iEmbed0</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
			<span class="c1"># behUEmbed0 = uEmbed0</span>
			<span class="c1"># behIEmbed0 = iEmbed0</span>
			<span class="n">ulats</span> <span class="o">=</span> <span class="p">[</span><span class="n">behUEmbed0</span><span class="p">]</span>
			<span class="n">ilats</span> <span class="o">=</span> <span class="p">[</span><span class="n">behIEmbed0</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gnn_layer</span><span class="p">):</span>
				<span class="n">ulat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">messagePropagate</span><span class="p">(</span><span class="n">ilats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjs</span><span class="p">[</span><span class="n">beh</span><span class="p">],</span> <span class="n">ulats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">ilat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">messagePropagate</span><span class="p">(</span><span class="n">ulats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpAdjs</span><span class="p">[</span><span class="n">beh</span><span class="p">],</span> <span class="n">ilats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">ulats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ulat</span> <span class="o">+</span> <span class="n">ulats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">ilats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ilat</span> <span class="o">+</span> <span class="n">ilats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ulat</span><span class="p">[</span><span class="n">beh</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">ulats</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ilat</span><span class="p">[</span><span class="n">beh</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">ilats</span><span class="p">)</span>

		<span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaForSpecialize</span><span class="p">(</span><span class="n">uEmbed0</span><span class="p">,</span> <span class="n">iEmbed0</span><span class="p">,</span> <span class="n">behEmbeds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpAdjs</span><span class="p">)</span>
		<span class="n">behUEmbed0</span><span class="p">,</span> <span class="n">behIEmbed0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specialize</span><span class="p">(</span><span class="n">uEmbed0</span><span class="p">,</span> <span class="n">iEmbed0</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
		<span class="n">ulats</span> <span class="o">=</span> <span class="p">[</span><span class="n">behUEmbed0</span><span class="p">]</span>
		<span class="n">ilats</span> <span class="o">=</span> <span class="p">[</span><span class="n">behIEmbed0</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gnn_layer</span><span class="p">):</span>
			<span class="n">ubehLats</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="n">ibehLats</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">beh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span><span class="p">):</span>
				<span class="n">ulat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">messagePropagate</span><span class="p">(</span><span class="n">ilats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjs</span><span class="p">[</span><span class="n">beh</span><span class="p">],</span> <span class="n">ulats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">ilat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">messagePropagate</span><span class="p">(</span><span class="n">ulats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpAdjs</span><span class="p">[</span><span class="n">beh</span><span class="p">],</span> <span class="n">ilats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">ubehLats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ulat</span><span class="p">)</span>
				<span class="n">ibehLats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ilat</span><span class="p">)</span>
			<span class="n">ulat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">lightSelfAttention</span><span class="p">(</span><span class="n">ubehLats</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">behNum</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">latdim</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">att_head</span><span class="p">))</span>
			<span class="n">ilat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">lightSelfAttention</span><span class="p">(</span><span class="n">ibehLats</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">behNum</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">latdim</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">att_head</span><span class="p">))</span>
			<span class="n">ulats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ulat</span><span class="p">)</span>
			<span class="n">ilats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ilat</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ulat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">ulats</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ilat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">ilats</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">metaForPredict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_ulat</span><span class="p">,</span> <span class="n">src_ilat</span><span class="p">,</span> <span class="n">tgt_ulat</span><span class="p">,</span> <span class="n">tgt_ilat</span><span class="p">):</span>
		<span class="n">latdim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">latdim</span>
		<span class="n">src_ui</span> <span class="o">=</span> <span class="n">FC</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">src_ulat</span> <span class="o">*</span> <span class="n">src_ilat</span><span class="p">,</span> <span class="n">src_ulat</span><span class="p">,</span> <span class="n">src_ilat</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actFunc</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predMeta_FC1&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">tgt_ui</span> <span class="o">=</span> <span class="n">FC</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tgt_ulat</span> <span class="o">*</span> <span class="n">tgt_ilat</span><span class="p">,</span> <span class="n">tgt_ulat</span><span class="p">,</span> <span class="n">tgt_ilat</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actFunc</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predMeta_FC1&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">metalat</span> <span class="o">=</span> <span class="n">FC</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">src_ui</span> <span class="o">*</span> <span class="n">tgt_ui</span><span class="p">,</span> <span class="n">src_ui</span><span class="p">,</span> <span class="n">tgt_ui</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">latdim</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actFunc</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predMeta_FC2&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">w1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">FC</span><span class="p">(</span><span class="n">metalat</span><span class="p">,</span> <span class="n">latdim</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predMeta_FC3&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">biasReg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">biasInitializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">latdim</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">latdim</span><span class="p">])</span>
		<span class="n">b1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">FC</span><span class="p">(</span><span class="n">metalat</span><span class="p">,</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predMeta_FC4&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">latdim</span><span class="p">])</span>
		<span class="n">w2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">FC</span><span class="p">(</span><span class="n">metalat</span><span class="p">,</span> <span class="n">latdim</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useBias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predMeta_FC5&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">biasReg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">biasInitializer</span><span class="o">=</span><span class="s1">&#39;xavier&#39;</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">latdim</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

		<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s1">&#39;w1&#39;</span><span class="p">:</span> <span class="n">w1</span><span class="p">,</span>
			<span class="s1">&#39;b1&#39;</span><span class="p">:</span> <span class="n">b1</span><span class="p">,</span>
			<span class="s1">&#39;w2&#39;</span><span class="p">:</span> <span class="n">w2</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">params</span>

	<span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ulat</span><span class="p">,</span> <span class="n">ilat</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
		<span class="n">predEmbed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ulat</span> <span class="o">*</span> <span class="n">ilat</span><span class="p">,</span> <span class="n">ulat</span><span class="p">,</span> <span class="n">ilat</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">predEmbed</span> <span class="o">=</span> <span class="n">Activate</span><span class="p">(</span><span class="n">predEmbed</span> <span class="o">@</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">actFunc</span><span class="p">)</span>
		<span class="n">preds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">predEmbed</span> <span class="o">@</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;w2&#39;</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">preds</span>

	<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">):</span>
		<span class="n">uids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">[</span><span class="n">tgt</span><span class="p">]</span>
		<span class="n">iids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iids</span><span class="p">[</span><span class="n">tgt</span><span class="p">]</span>

		<span class="n">src_ulat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">embedding_lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ulat</span><span class="p">[</span><span class="n">src</span><span class="p">],</span> <span class="n">uids</span><span class="p">)</span>
		<span class="n">src_ilat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">embedding_lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ilat</span><span class="p">[</span><span class="n">src</span><span class="p">],</span> <span class="n">iids</span><span class="p">)</span>
		<span class="n">tgt_ulat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">embedding_lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ulat</span><span class="p">[</span><span class="n">tgt</span><span class="p">],</span> <span class="n">uids</span><span class="p">)</span>
		<span class="n">tgt_ilat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">embedding_lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ilat</span><span class="p">[</span><span class="n">tgt</span><span class="p">],</span> <span class="n">iids</span><span class="p">)</span>

		<span class="n">predParams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaForPredict</span><span class="p">(</span><span class="n">src_ulat</span><span class="p">,</span> <span class="n">src_ilat</span><span class="p">,</span> <span class="n">tgt_ulat</span><span class="p">,</span> <span class="n">tgt_ilat</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">src_ulat</span><span class="p">,</span> <span class="n">src_ilat</span><span class="p">,</span> <span class="n">predParams</span><span class="p">)</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">mult</span>

	<span class="k">def</span> <span class="nf">prepareModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">actFunc</span> <span class="o">=</span> <span class="s1">&#39;leakyRelu&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">adjs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tpAdjs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span><span class="p">):</span>
			<span class="n">adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">trnMats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">transToLsts</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">adjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span>
			<span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">transToLsts</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">adj</span><span class="p">),</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">tpAdjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;uids&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">iids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;iids&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]))</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">defineModel</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">preLoss</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">tgt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span><span class="p">):</span>
				<span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)</span>
				<span class="n">sampNum</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">[</span><span class="n">tgt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
				<span class="n">posPred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">sampNum</span><span class="p">])</span>
				<span class="n">negPred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="p">[</span><span class="n">sampNum</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">preLoss</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">posPred</span> <span class="o">-</span> <span class="n">negPred</span><span class="p">)))</span>
				<span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="n">args</span><span class="o">.</span><span class="n">behNum</span> <span class="ow">and</span> <span class="n">tgt</span> <span class="o">==</span> <span class="n">args</span><span class="o">.</span><span class="n">behNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">targetPreds</span> <span class="o">=</span> <span class="n">preds</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">regLoss</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">reg</span> <span class="o">*</span> <span class="n">Regularize</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preLoss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">regLoss</span>

		<span class="n">globalStep</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">learningRate</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">exponential_decay</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">globalStep</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">decay_step</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">decay</span><span class="p">,</span> <span class="n">staircase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="n">learningRate</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">globalStep</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">sampleTrainBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batIds</span><span class="p">,</span> <span class="n">labelMat</span><span class="p">):</span>
		<span class="n">temLabel</span> <span class="o">=</span> <span class="n">labelMat</span><span class="p">[</span><span class="n">batIds</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
		<span class="n">batch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batIds</span><span class="p">)</span>
		<span class="n">temlen</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">sampNum</span>
		<span class="n">uLocs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">temlen</span>
		<span class="n">iLocs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">temlen</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
			<span class="n">posset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">temLabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">sampNum</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sampNum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">posset</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">sampNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">poslocs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">item</span><span class="p">)]</span>
				<span class="n">neglocs</span> <span class="o">=</span> <span class="p">[</span><span class="n">poslocs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">poslocs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">posset</span><span class="p">,</span> <span class="n">sampNum</span><span class="p">)</span>
				<span class="n">neglocs</span> <span class="o">=</span> <span class="n">negSamp</span><span class="p">(</span><span class="n">temLabel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sampNum</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">item</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sampNum</span><span class="p">):</span>
				<span class="n">posloc</span> <span class="o">=</span> <span class="n">poslocs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
				<span class="n">negloc</span> <span class="o">=</span> <span class="n">neglocs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
				<span class="n">uLocs</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="n">uLocs</span><span class="p">[</span><span class="n">cur</span><span class="o">+</span><span class="n">temlen</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">batIds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="n">iLocs</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="n">posloc</span>
				<span class="n">iLocs</span><span class="p">[</span><span class="n">cur</span><span class="o">+</span><span class="n">temlen</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">negloc</span>
				<span class="n">cur</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="n">uLocs</span> <span class="o">=</span> <span class="n">uLocs</span><span class="p">[:</span><span class="n">cur</span><span class="p">]</span> <span class="o">+</span> <span class="n">uLocs</span><span class="p">[</span><span class="n">temlen</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span> <span class="n">temlen</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cur</span><span class="p">]</span>
		<span class="n">iLocs</span> <span class="o">=</span> <span class="n">iLocs</span><span class="p">[:</span><span class="n">cur</span><span class="p">]</span> <span class="o">+</span> <span class="n">iLocs</span><span class="p">[</span><span class="n">temlen</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span> <span class="n">temlen</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cur</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">uLocs</span><span class="p">,</span> <span class="n">iLocs</span>

	<span class="k">def</span> <span class="nf">trainEpoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">user</span>
		<span class="n">sfIds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num</span><span class="p">)[:</span><span class="n">args</span><span class="o">.</span><span class="n">trnNum</span><span class="p">]</span>
		<span class="n">epochLoss</span><span class="p">,</span> <span class="n">epochPreLoss</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
		<span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sfIds</span><span class="p">)</span>
		<span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">batch</span><span class="p">))</span>

		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
			<span class="n">st</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">batch</span>
			<span class="n">ed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
			<span class="n">batIds</span> <span class="o">=</span> <span class="n">sfIds</span><span class="p">[</span><span class="n">st</span><span class="p">:</span> <span class="n">ed</span><span class="p">]</span>

			<span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preLoss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regLoss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">]</span>
			<span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">beh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">behNum</span><span class="p">):</span>
				<span class="n">uLocs</span><span class="p">,</span> <span class="n">iLocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampleTrainBatch</span><span class="p">(</span><span class="n">batIds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">trnMats</span><span class="p">[</span><span class="n">beh</span><span class="p">])</span>
				<span class="n">feed_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">[</span><span class="n">beh</span><span class="p">]]</span> <span class="o">=</span> <span class="n">uLocs</span>
				<span class="n">feed_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iids</span><span class="p">[</span><span class="n">beh</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iLocs</span>

			<span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">config_pb2</span><span class="o">.</span><span class="n">RunOptions</span><span class="p">(</span><span class="n">report_tensor_allocations_upon_oom</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

			<span class="n">preLoss</span><span class="p">,</span> <span class="n">regLoss</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

			<span class="n">epochLoss</span> <span class="o">+=</span> <span class="n">loss</span>
			<span class="n">epochPreLoss</span> <span class="o">+=</span> <span class="n">preLoss</span>
			<span class="n">log</span><span class="p">(</span><span class="s1">&#39;Step </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">: loss = </span><span class="si">%.2f</span><span class="s1">, regLoss = </span><span class="si">%.2f</span><span class="s1">         &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">regLoss</span><span class="p">),</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">oneline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
		<span class="n">ret</span><span class="p">[</span><span class="s1">&#39;Loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epochLoss</span> <span class="o">/</span> <span class="n">steps</span>
		<span class="n">ret</span><span class="p">[</span><span class="s1">&#39;preLoss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epochPreLoss</span> <span class="o">/</span> <span class="n">steps</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span> <span class="nf">sampleTestBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batIds</span><span class="p">,</span> <span class="n">labelMat</span><span class="p">):</span>
		<span class="n">batch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batIds</span><span class="p">)</span>
		<span class="n">temTst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">tstInt</span><span class="p">[</span><span class="n">batIds</span><span class="p">]</span>
		<span class="n">temLabel</span> <span class="o">=</span> <span class="n">labelMat</span><span class="p">[</span><span class="n">batIds</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
		<span class="n">temlen</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">*</span> <span class="mi">100</span>
		<span class="n">uLocs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">temlen</span>
		<span class="n">iLocs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">temlen</span>
		<span class="n">tstLocs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
			<span class="n">posloc</span> <span class="o">=</span> <span class="n">temTst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">negset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">temLabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">rdnNegSet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">negset</span><span class="p">)[:</span><span class="mi">99</span><span class="p">]</span>
			<span class="n">locset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rdnNegSet</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">posloc</span><span class="p">])))</span>
			<span class="n">tstLocs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">locset</span>
			<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
				<span class="n">uLocs</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="n">batIds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="n">iLocs</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="n">locset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
				<span class="n">cur</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">return</span> <span class="n">uLocs</span><span class="p">,</span> <span class="n">iLocs</span><span class="p">,</span> <span class="n">temTst</span><span class="p">,</span> <span class="n">tstLocs</span>

	<span class="k">def</span> <span class="nf">testEpoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">epochHit</span><span class="p">,</span> <span class="n">epochNdcg</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
		<span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">tstUsrs</span>
		<span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
		<span class="n">tstBat</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">batch</span>
		<span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">tstBat</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
			<span class="n">st</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">tstBat</span>
			<span class="n">ed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tstBat</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
			<span class="n">batIds</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">st</span><span class="p">:</span> <span class="n">ed</span><span class="p">]</span>
			<span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="n">uLocs</span><span class="p">,</span> <span class="n">iLocs</span><span class="p">,</span> <span class="n">temTst</span><span class="p">,</span> <span class="n">tstLocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampleTestBatch</span><span class="p">(</span><span class="n">batIds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">trnMats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">feed_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">uLocs</span>
			<span class="n">feed_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iLocs</span>
			<span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetPreds</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">config_pb2</span><span class="o">.</span><span class="n">RunOptions</span><span class="p">(</span><span class="n">report_tensor_allocations_upon_oom</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
			<span class="n">hit</span><span class="p">,</span> <span class="n">ndcg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcRes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="p">[</span><span class="n">ed</span><span class="o">-</span><span class="n">st</span><span class="p">,</span> <span class="mi">100</span><span class="p">]),</span> <span class="n">temTst</span><span class="p">,</span> <span class="n">tstLocs</span><span class="p">)</span>
			<span class="n">epochHit</span> <span class="o">+=</span> <span class="n">hit</span>
			<span class="n">epochNdcg</span> <span class="o">+=</span> <span class="n">ndcg</span>
			<span class="n">log</span><span class="p">(</span><span class="s1">&#39;Steps </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">: hit = </span><span class="si">%d</span><span class="s1">, ndcg = </span><span class="si">%d</span><span class="s1">          &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">hit</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">),</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">oneline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
		<span class="n">ret</span><span class="p">[</span><span class="s1">&#39;HR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epochHit</span> <span class="o">/</span> <span class="n">num</span>
		<span class="n">ret</span><span class="p">[</span><span class="s1">&#39;NDCG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epochNdcg</span> <span class="o">/</span> <span class="n">num</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span> <span class="nf">calcRes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">temTst</span><span class="p">,</span> <span class="n">tstLocs</span><span class="p">):</span>
		<span class="n">hit</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">ndcg</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
			<span class="n">predvals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">tstLocs</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
			<span class="n">predvals</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">shoot</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">predvals</span><span class="p">[:</span><span class="n">args</span><span class="o">.</span><span class="n">shoot</span><span class="p">]))</span>
			<span class="k">if</span> <span class="n">temTst</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">shoot</span><span class="p">:</span>
				<span class="n">hit</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="n">ndcg</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">shoot</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">temTst</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">hit</span><span class="p">,</span> <span class="n">ndcg</span>
	
	<span class="k">def</span> <span class="nf">saveHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;History/&#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">save_path</span> <span class="o">+</span> <span class="s1">&#39;.his&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
			<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>

		<span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
		<span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;Models/&#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
		<span class="n">log</span><span class="p">(</span><span class="s1">&#39;Model Saved: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">loadModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
		<span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;Models/&#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">load_model</span><span class="p">)</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;History/&#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">load_model</span> <span class="o">+</span> <span class="s1">&#39;.his&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
		<span class="n">log</span><span class="p">(</span><span class="s1">&#39;Model Loaded&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training-&amp;-Evaluation">Training &amp; Evaluation<a class="anchor-link" href="#Training-&amp;-Evaluation"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
	<span class="n">saveDefault</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="n">config</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ConfigProto</span><span class="p">()</span>
	<span class="n">config</span><span class="o">.</span><span class="n">gpu_options</span><span class="o">.</span><span class="n">allow_growth</span> <span class="o">=</span> <span class="kc">True</span>

	<span class="n">log</span><span class="p">(</span><span class="s1">&#39;Start&#39;</span><span class="p">)</span>
	<span class="n">handler</span> <span class="o">=</span> <span class="n">DataHandler</span><span class="p">()</span>
	<span class="n">handler</span><span class="o">.</span><span class="n">LoadData</span><span class="p">()</span>
	<span class="n">log</span><span class="p">(</span><span class="s1">&#39;Load Data&#39;</span><span class="p">)</span>

	<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
		<span class="n">recom</span> <span class="o">=</span> <span class="n">Recommender</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
		<span class="n">recom</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2021-12-12 08:37:23.971121: Start
2021-12-12 08:37:27.161611: Load Data
USER 21716 ITEM 7977
WARNING:tensorflow:From /tensorflow-1.15.2/python3.7/tensorflow_core/python/ops/math_grad.py:1424: where (from tensorflow.python.ops.array_ops) is deprecated and will be removed in a future version.
Instructions for updating:
Use tf.where in 2.0, which has the same broadcast rule as np.where
2021-12-12 08:38:00.972851: Model Prepared
2021-12-12 08:38:01.834669: Variables Initiated
2021-12-12 08:39:42.215211: Epoch 0/10, Train: Loss = 12.1183, preLoss = 6.3383  
2021-12-12 08:39:53.562941: Epoch 0/10, Test: HR = 0.5946, NDCG = 0.3332  
2021-12-12 08:39:55.301442: Model Saved: tem

2021-12-12 08:40:47.575082: Epoch 1/10, Train: Loss = 9.0478, preLoss = 5.1342  

2021-12-12 08:41:40.084938: Epoch 2/10, Train: Loss = 7.5280, preLoss = 4.5253  

2021-12-12 08:42:32.611271: Epoch 3/10, Train: Loss = 6.5597, preLoss = 4.1519  
2021-12-12 08:42:42.480947: Epoch 3/10, Test: HR = 0.6345, NDCG = 0.3680  
2021-12-12 08:42:44.058778: Model Saved: tem

2021-12-12 08:43:36.462615: Epoch 4/10, Train: Loss = 5.9555, preLoss = 3.9571  

2021-12-12 08:44:29.043362: Epoch 5/10, Train: Loss = 5.5330, preLoss = 3.8189  

2021-12-12 08:45:21.376325: Epoch 6/10, Train: Loss = 5.2156, preLoss = 3.7027  
2021-12-12 08:45:31.129196: Epoch 6/10, Test: HR = 0.6427, NDCG = 0.3792  
2021-12-12 08:45:32.804393: Model Saved: tem

2021-12-12 08:46:25.139950: Epoch 7/10, Train: Loss = 4.9785, preLoss = 3.6121  

2021-12-12 08:47:17.625253: Epoch 8/10, Train: Loss = 4.7693, preLoss = 3.5099  

2021-12-12 08:48:10.046328: Epoch 9/10, Train: Loss = 4.6129, preLoss = 3.4353  
2021-12-12 08:48:19.891913: Epoch 9/10, Test: HR = 0.6497, NDCG = 0.3784  
2021-12-12 08:48:21.573201: Model Saved: tem

2021-12-12 08:48:31.548992: Epoch 10/10, Test: HR = 0.6583, NDCG = 0.3822  
2021-12-12 08:48:33.469254: Model Saved: tem
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="References">References<a class="anchor-link" href="#References"> </a></h2><ol>
<li><a href="https://github.com/RecoHut-Stanzas/S346877">https://github.com/RecoHut-Stanzas/S346877</a></li>
<li><a href="https://arxiv.org/abs/2110.03969v1">https://arxiv.org/abs/2110.03969v1</a></li>
<li><a href="https://github.com/akaxlh/MB-GMN">https://github.com/akaxlh/MB-GMN</a></li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">qq</span> <span class="n">install</span> <span class="n">tree</span>
<span class="err">!</span><span class="n">rm</span> <span class="o">-</span><span class="n">r</span> <span class="n">sample_data</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Selecting previously unselected package tree.
(Reading database ... 155222 files and directories currently installed.)
Preparing to unpack .../tree_1.7.0-5_amd64.deb ...
Unpacking tree (1.7.0-5) ...
Setting up tree (1.7.0-5) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">tree</span> <span class="o">-</span><span class="n">h</span> <span class="o">--</span><span class="n">du</span> <span class="o">.</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>.
├── [ 26M]  beibei
│   ├── [ 233]  README.md
│   ├── [2.2M]  trn_buy
│   ├── [5.0M]  trn_cart
│   ├── [ 18M]  trn_pv
│   └── [275K]  tst_int
├── [4.6K]  History
│   └── [ 587]  tem.his
└── [139M]  Models
    ├── [  63]  checkpoint
    ├── [9.2M]  tem.data-00000-of-00001
    ├── [2.6K]  tem.index
    └── [129M]  tem.meta

 165M used in 3 directories, 10 files
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">reload_ext</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;Sparsh A.&quot;</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">t</span> <span class="o">-</span><span class="n">d</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Author: Sparsh A.

Last updated: 2021-12-12 08:51:08

Compiler    : GCC 7.5.0
OS          : Linux
Release     : 5.4.104+
Machine     : x86_64
Processor   : x86_64
CPU cores   : 2
Architecture: 64bit

tensorflow: 1.15.2
IPython   : 5.5.0
argparse  : 1.1
scipy     : 1.4.1
numpy     : 1.19.5

</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>END</strong></p>

</div>
</div>
</div>
</div>

<script type="application/vnd.jupyter.widget-state+json">
{"24c87c2912974b6d8becb5b9190aa829": {"model_module": "@jupyter-widgets/controls", "model_name": "HBoxModel", "model_module_version": "1.5.0", "state": {"_view_name": "HBoxView", "_dom_classes": [], "_model_name": "HBoxModel", "_view_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_view_count": null, "_view_module_version": "1.5.0", "box_style": "", "layout": "IPY_MODEL_4314716903e64982b95392e7e37156bd", "_model_module": "@jupyter-widgets/controls", "children": ["IPY_MODEL_6f654bcada5d41f78b08c66d2e692fde", "IPY_MODEL_9dd6ba2d32ff4c0cb76b467e51e8060c", "IPY_MODEL_7fd736fa68424784a086f63ba9a43657"]}}, "4314716903e64982b95392e7e37156bd": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "model_module_version": "1.2.0", "state": {"_view_name": "LayoutView", "grid_template_rows": null, "right": null, "justify_content": null, "_view_module": "@jupyter-widgets/base", "overflow": null, "_model_module_version": "1.2.0", "_view_count": null, "flex_flow": null, "width": null, "min_width": null, "border": null, "align_items": null, "bottom": null, "_model_module": "@jupyter-widgets/base", "top": null, "grid_column": null, "overflow_y": null, "overflow_x": null, "grid_auto_flow": null, "grid_area": null, "grid_template_columns": null, "flex": null, "_model_name": "LayoutModel", "justify_items": null, "grid_row": null, "max_height": null, "align_content": null, "visibility": null, "align_self": null, "height": null, "min_height": null, "padding": null, "grid_auto_rows": null, "grid_gap": null, "max_width": null, "order": null, "_view_module_version": "1.2.0", "grid_template_areas": null, "object_position": null, "object_fit": null, "grid_auto_columns": null, "margin": null, "display": null, "left": null}}, "6f654bcada5d41f78b08c66d2e692fde": {"model_module": "@jupyter-widgets/controls", "model_name": "HTMLModel", "model_module_version": "1.5.0", "state": {"_view_name": "HTMLView", "style": "IPY_MODEL_0bbb945cc6d54d289cbf67827ae1b723", "_dom_classes": [], "description": "", "_model_name": "HTMLModel", "placeholder": "\u200b", "_view_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "value": "100%", "_view_count": null, "_view_module_version": "1.5.0", "description_tooltip": null, "_model_module": "@jupyter-widgets/controls", "layout": "IPY_MODEL_551b14c6f28644eea7c40845274e672c"}}, "9dd6ba2d32ff4c0cb76b467e51e8060c": {"model_module": "@jupyter-widgets/controls", "model_name": "FloatProgressModel", "model_module_version": "1.5.0", "state": {"_view_name": "ProgressView", "style": "IPY_MODEL_02be78ca98ab4b39adaa14cfd532ce00", "_dom_classes": [], "description": "", "_model_name": "FloatProgressModel", "bar_style": "success", "max": 10, "_view_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "value": 10, "_view_count": null, "_view_module_version": "1.5.0", "orientation": "horizontal", "min": 0, "description_tooltip": null, "_model_module": "@jupyter-widgets/controls", "layout": "IPY_MODEL_0343c7f1998946c68782b6fa7993b824"}}, "7fd736fa68424784a086f63ba9a43657": {"model_module": "@jupyter-widgets/controls", "model_name": "HTMLModel", "model_module_version": "1.5.0", "state": {"_view_name": "HTMLView", "style": "IPY_MODEL_439b1cc5861d446b84eba9b023d4d410", "_dom_classes": [], "description": "", "_model_name": "HTMLModel", "placeholder": "\u200b", "_view_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "value": " 10/10 [10:19&lt;00:00, 58.37s/it]", "_view_count": null, "_view_module_version": "1.5.0", "description_tooltip": null, "_model_module": "@jupyter-widgets/controls", "layout": "IPY_MODEL_1ceba6676a0f4736961546da9a54dac6"}}, "0bbb945cc6d54d289cbf67827ae1b723": {"model_module": "@jupyter-widgets/controls", "model_name": "DescriptionStyleModel", "model_module_version": "1.5.0", "state": {"_view_name": "StyleView", "_model_name": "DescriptionStyleModel", "description_width": "", "_view_module": "@jupyter-widgets/base", "_model_module_version": "1.5.0", "_view_count": null, "_view_module_version": "1.2.0", "_model_module": "@jupyter-widgets/controls"}}, "551b14c6f28644eea7c40845274e672c": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "model_module_version": "1.2.0", "state": {"_view_name": "LayoutView", "grid_template_rows": null, "right": null, "justify_content": null, "_view_module": "@jupyter-widgets/base", "overflow": null, "_model_module_version": "1.2.0", "_view_count": null, "flex_flow": null, "width": null, "min_width": null, "border": null, "align_items": null, "bottom": null, "_model_module": "@jupyter-widgets/base", "top": null, "grid_column": null, "overflow_y": null, "overflow_x": null, "grid_auto_flow": null, "grid_area": null, "grid_template_columns": null, "flex": null, "_model_name": "LayoutModel", "justify_items": null, "grid_row": null, "max_height": null, "align_content": null, "visibility": null, "align_self": null, "height": null, "min_height": null, "padding": null, "grid_auto_rows": null, "grid_gap": null, "max_width": null, "order": null, "_view_module_version": "1.2.0", "grid_template_areas": null, "object_position": null, "object_fit": null, "grid_auto_columns": null, "margin": null, "display": null, "left": null}}, "02be78ca98ab4b39adaa14cfd532ce00": {"model_module": "@jupyter-widgets/controls", "model_name": "ProgressStyleModel", "model_module_version": "1.5.0", "state": {"_view_name": "StyleView", "_model_name": "ProgressStyleModel", "description_width": "", "_view_module": "@jupyter-widgets/base", "_model_module_version": "1.5.0", "_view_count": null, "_view_module_version": "1.2.0", "bar_color": null, "_model_module": "@jupyter-widgets/controls"}}, "0343c7f1998946c68782b6fa7993b824": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "model_module_version": "1.2.0", "state": {"_view_name": "LayoutView", "grid_template_rows": null, "right": null, "justify_content": null, "_view_module": "@jupyter-widgets/base", "overflow": null, "_model_module_version": "1.2.0", "_view_count": null, "flex_flow": null, "width": null, "min_width": null, "border": null, "align_items": null, "bottom": null, "_model_module": "@jupyter-widgets/base", "top": null, "grid_column": null, "overflow_y": null, "overflow_x": null, "grid_auto_flow": null, "grid_area": null, "grid_template_columns": null, "flex": null, "_model_name": "LayoutModel", "justify_items": null, "grid_row": null, "max_height": null, "align_content": null, "visibility": null, "align_self": null, "height": null, "min_height": null, "padding": null, "grid_auto_rows": null, "grid_gap": null, "max_width": null, "order": null, "_view_module_version": "1.2.0", "grid_template_areas": null, "object_position": null, "object_fit": null, "grid_auto_columns": null, "margin": null, "display": null, "left": null}}, "439b1cc5861d446b84eba9b023d4d410": {"model_module": "@jupyter-widgets/controls", "model_name": "DescriptionStyleModel", "model_module_version": "1.5.0", "state": {"_view_name": "StyleView", "_model_name": "DescriptionStyleModel", "description_width": "", "_view_module": "@jupyter-widgets/base", "_model_module_version": "1.5.0", "_view_count": null, "_view_module_version": "1.2.0", "_model_module": "@jupyter-widgets/controls"}}, "1ceba6676a0f4736961546da9a54dac6": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "model_module_version": "1.2.0", "state": {"_view_name": "LayoutView", "grid_template_rows": null, "right": null, "justify_content": null, "_view_module": "@jupyter-widgets/base", "overflow": null, "_model_module_version": "1.2.0", "_view_count": null, "flex_flow": null, "width": null, "min_width": null, "border": null, "align_items": null, "bottom": null, "_model_module": "@jupyter-widgets/base", "top": null, "grid_column": null, "overflow_y": null, "overflow_x": null, "grid_auto_flow": null, "grid_area": null, "grid_template_columns": null, "flex": null, "_model_name": "LayoutModel", "justify_items": null, "grid_row": null, "max_height": null, "align_content": null, "visibility": null, "align_self": null, "height": null, "min_height": null, "padding": null, "grid_auto_rows": null, "grid_gap": null, "max_width": null, "order": null, "_view_module_version": "1.2.0", "grid_template_areas": null, "object_position": null, "object_fit": null, "grid_auto_columns": null, "margin": null, "display": null, "left": null}}}
</script>



  </div><a class="u-url" href="/2022/01/11/mbgmn-beibei.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
