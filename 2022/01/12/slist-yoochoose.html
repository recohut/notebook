<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>SLIST on Yoochoose Preprocessed Sample Dataset | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="SLIST on Yoochoose Preprocessed Sample Dataset" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/12/slist-yoochoose.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/12/slist-yoochoose.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-12T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="SLIST on Yoochoose Preprocessed Sample Dataset" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-12T00:00:00-06:00","datePublished":"2022-01-12T00:00:00-06:00","description":"Jupyter notebook database.","headline":"SLIST on Yoochoose Preprocessed Sample Dataset","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/12/slist-yoochoose.html"},"url":"https://nb.recohut.com/2022/01/12/slist-yoochoose.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">SLIST on Yoochoose Preprocessed Sample Dataset</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-12T00:00:00-06:00" itemprop="datePublished">
        Jan 12, 2022
      </time>
       ‚Ä¢ <span class="read-time" title="Estimated read time">
    
    
      23 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-12-slist-yoochoose.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-12-slist-yoochoose.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-12-slist-yoochoose.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-12-slist-yoochoose.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-12-slist-yoochoose.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Executive-summary">Executive summary<a class="anchor-link" href="#Executive-summary"> </a></h2><table>
<thead><tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Prblm Stmnt</td>
<td>The goal of session-based recommendation is to predict the next item(s) a user would likely choose to consume, given a sequence of previously consumed items in a session. Formally, we build a session-based model M(ùë†) that takes a session ‚Åç for ‚Åç as input and returns a list of top-ùëÅ candidate items to be consumed as the next one ‚Åç.</td>
</tr>
<tr>
<td>Solution</td>
<td>Firstly, we devise two linear models focusing on different properties of sessions: (i) Session-aware Linear Item Similarity (SLIS) model aims at better handling session consistency, and (ii) Session-aware Linear Item Transition (SLIT) model focuses more on sequential dependency. With both SLIS and SLIT, we relax the constraint to incorporate repeated items and introduce a weighting scheme to take the timeliness of sessions into account. Combining these two types of models, we then suggest a unified model, namely Session-aware Item Similarity/Transition (SLIST) model, which is a generalized solution to holistically cover various properties of sessions.</td>
</tr>
<tr>
<td>Dataset</td>
<td>Yoochoose</td>
</tr>
<tr>
<td>Preprocessing</td>
<td>We discard the sessions having only one interaction and items appearing less than five times following the convention. We hold-out the sessions from the last ùëÅ-days for test purposes and used the last ùëÅ days in the training set for the validation set. To evaluate session-based recommender models, we adopt the iterative revealing scheme, which iteratively exposes the item of a session to the model. Each item in the session is sequentially appended to the input of the model. Therefore, this scheme is useful for reflecting the sequential user behavior throughout a session</td>
</tr>
<tr>
<td>Metrics</td>
<td>HR, MRR, Coverage, Popularity</td>
</tr>
<tr>
<td>Models</td>
<td>SLIST</td>
</tr>
<tr>
<td>Cluster</td>
<td>Python 3.x</td>
</tr>
<tr>
<td>Tags</td>
<td>LinearRecommender, SessionBasedRecommender</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Process-flow">Process flow<a class="anchor-link" href="#Process-flow"> </a></h2><p><img src="https://github.com/RecoHut-Stanzas/S181315/raw/main/images/process_flow_prototype_1.svg" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Imports">Imports<a class="anchor-link" href="#Imports"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">_datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">collections</span> <span class="k">as</span> <span class="nn">col</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">inv</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span><span class="p">,</span> <span class="n">csc_matrix</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">normalize</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset">Dataset<a class="anchor-link" href="#Dataset"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-data">Load data<a class="anchor-link" href="#Load-data"> </a></h3><p>Preprocessed Yoochoose clicks 100k</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">prepared</span>
<span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="n">prepared</span><span class="o">/</span><span class="n">events_test</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">progress</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">RecoHut</span><span class="o">-</span><span class="n">Stanzas</span><span class="o">/</span><span class="n">S181315</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">rsc15</span><span class="o">/</span><span class="n">prepared</span><span class="o">/</span><span class="n">yoochoose</span><span class="o">-</span><span class="n">clicks</span><span class="o">-</span><span class="mi">100</span><span class="n">k_test</span><span class="o">.</span><span class="n">txt</span>
<span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="n">prepared</span><span class="o">/</span><span class="n">events_train_full</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">progress</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">RecoHut</span><span class="o">-</span><span class="n">Stanzas</span><span class="o">/</span><span class="n">S181315</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">rsc15</span><span class="o">/</span><span class="n">prepared</span><span class="o">/</span><span class="n">yoochoose</span><span class="o">-</span><span class="n">clicks</span><span class="o">-</span><span class="mi">100</span><span class="n">k_train_full</span><span class="o">.</span><span class="n">txt</span>
<span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="n">prepared</span><span class="o">/</span><span class="n">events_train_tr</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">progress</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">RecoHut</span><span class="o">-</span><span class="n">Stanzas</span><span class="o">/</span><span class="n">S181315</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">rsc15</span><span class="o">/</span><span class="n">prepared</span><span class="o">/</span><span class="n">yoochoose</span><span class="o">-</span><span class="n">clicks</span><span class="o">-</span><span class="mi">100</span><span class="n">k_train_tr</span><span class="o">.</span><span class="n">txt</span>
<span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="n">prepared</span><span class="o">/</span><span class="n">events_train_valid</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">progress</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">RecoHut</span><span class="o">-</span><span class="n">Stanzas</span><span class="o">/</span><span class="n">S181315</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">rsc15</span><span class="o">/</span><span class="n">prepared</span><span class="o">/</span><span class="n">yoochoose</span><span class="o">-</span><span class="n">clicks</span><span class="o">-</span><span class="mi">100</span><span class="n">k_train_valid</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>prepared/events_tes 100%[===================&gt;] 404.64K  --.-KB/s    in 0.007s  
prepared/events_tra 100%[===================&gt;]   2.05M  --.-KB/s    in 0.02s   
prepared/events_tra 100%[===================&gt;]   1.55M  --.-KB/s    in 0.02s   
prepared/events_tra 100%[===================&gt;] 493.18K  --.-KB/s    in 0.008s  
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">load_data_session</span><span class="p">(</span> <span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">sessions_train</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sessions_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slice_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Loads a tuple of training and test set with the given parameters. </span>
<span class="sd">    Parameters</span>
<span class="sd">    --------</span>
<span class="sd">    path : string</span>
<span class="sd">        Base path to look in for the prepared data files</span>
<span class="sd">    file : string</span>
<span class="sd">        Prefix of  the dataset you want to use.</span>
<span class="sd">        &quot;yoochoose-clicks-full&quot; loads yoochoose-clicks-full_train_full.txt and yoochoose-clicks-full_test.txt</span>
<span class="sd">    rows_train : int or None</span>
<span class="sd">        Number of rows to load from the training set file. </span>
<span class="sd">        This option will automatically filter the test set to only retain items included in the training set.  </span>
<span class="sd">    rows_test : int or None</span>
<span class="sd">        Number of rows to load from the test set file. </span>
<span class="sd">    slice_num : </span>
<span class="sd">        Adds a slice index to the constructed file_path</span>
<span class="sd">        yoochoose-clicks-full_train_full.0.txt</span>
<span class="sd">    density : float</span>
<span class="sd">        Percentage of the sessions to randomly retain from the original data (0-1). </span>
<span class="sd">        The result is cached for the execution of multiple experiments. </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    out : tuple of pandas.DataFrame</span>
<span class="sd">        (train, test)</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;START load data&#39;</span><span class="p">)</span> 
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
    <span class="n">split</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">slice_num</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slice_num</span><span class="p">,</span> <span class="nb">int</span> <span class="p">)</span> <span class="p">):</span>
        <span class="n">split</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">slice_num</span><span class="p">)</span>
    
    <span class="n">train_appendix</span> <span class="o">=</span> <span class="s1">&#39;_train_full&#39;</span>
    <span class="n">test_appendix</span> <span class="o">=</span> <span class="s1">&#39;_test&#39;</span>
    <span class="k">if</span> <span class="n">train_eval</span><span class="p">:</span>
        <span class="n">train_appendix</span> <span class="o">=</span> <span class="s1">&#39;_train_tr&#39;</span>
        <span class="n">test_appendix</span> <span class="o">=</span> <span class="s1">&#39;_train_valid&#39;</span>
            
    <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">file</span> <span class="o">+</span> <span class="n">train_appendix</span> <span class="o">+</span><span class="n">split</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">file</span> <span class="o">+</span> <span class="n">test_appendix</span> <span class="o">+</span><span class="n">split</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="p">)</span>
        
    <span class="k">if</span><span class="p">(</span> <span class="n">sessions_train</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">):</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">SessionId</span><span class="o">.</span><span class="n">unique</span><span class="p">()[:(</span><span class="n">sessions_train</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span> <span class="n">train</span><span class="o">.</span><span class="n">SessionId</span><span class="p">,</span> <span class="n">keep</span> <span class="p">)</span> <span class="p">]</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">ItemId</span><span class="p">,</span> <span class="n">train</span><span class="o">.</span><span class="n">ItemId</span><span class="p">)]</span>
    
    <span class="k">if</span><span class="p">(</span> <span class="n">sessions_test</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">):</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">SessionId</span><span class="o">.</span><span class="n">unique</span><span class="p">()[:(</span><span class="n">sessions_test</span><span class="p">)]</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span> <span class="n">test</span><span class="o">.</span><span class="n">SessionId</span><span class="p">,</span> <span class="n">keep</span> <span class="p">)</span> <span class="p">]</span>
    
    <span class="n">session_lengths</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;SessionId&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">SessionId</span><span class="p">,</span> <span class="n">session_lengths</span><span class="p">[</span> <span class="n">session_lengths</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
    
    <span class="c1">#output</span>
    <span class="n">data_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span> <span class="n">train</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span> <span class="p">)</span>
    <span class="n">data_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span> <span class="n">train</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span> <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded train set</span><span class="se">\n\t</span><span class="s1">Events: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Sessions: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Items: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Span: </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span>
          <span class="nb">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">),</span> <span class="n">train</span><span class="o">.</span><span class="n">SessionId</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="n">train</span><span class="o">.</span><span class="n">ItemId</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="n">data_start</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">data_end</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
    
    <span class="n">data_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span> <span class="n">test</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span> <span class="p">)</span>
    <span class="n">data_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span> <span class="n">test</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span> <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded test set</span><span class="se">\n\t</span><span class="s1">Events: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Sessions: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Items: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Span: </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span>
          <span class="nb">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">),</span> <span class="n">test</span><span class="o">.</span><span class="n">SessionId</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="n">test</span><span class="o">.</span><span class="n">ItemId</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="n">data_start</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">data_end</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
    
    <span class="n">check_data</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;END load data &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">sc</span><span class="p">),</span> <span class="s1">&#39;c / &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">),</span> <span class="s1">&#39;s&#39;</span> <span class="p">)</span> 
    
    <span class="k">return</span> <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">check_data</span><span class="p">(</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="p">):</span>
    
    <span class="k">if</span> <span class="s1">&#39;ItemId&#39;</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;SessionId&#39;</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    
        <span class="n">new_in_test</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="n">test</span><span class="o">.</span><span class="n">ItemId</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span> <span class="n">train</span><span class="o">.</span><span class="n">ItemId</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">new_in_test</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;WAAAAAARRRNIIIIING: new items in test set&#39;</span> <span class="p">)</span>
            
        <span class="n">session_min_train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> <span class="s1">&#39;SessionId&#39;</span> <span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">session_min_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;WAAAAAARRRNIIIIING: session length 1 in train set&#39;</span> <span class="p">)</span>
            
        <span class="n">session_min_test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> <span class="s1">&#39;SessionId&#39;</span> <span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">session_min_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;WAAAAAARRRNIIIIING: session length 1 in train set&#39;</span> <span class="p">)</span>
          
    <span class="k">else</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;data check not possible due to individual column names&#39;</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">evaluate_sessions</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_off</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;SessionId&#39;</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;ItemId&#39;</span><span class="p">,</span> <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Evaluates the baselines wrt. recommendation accuracy measured by recall@N and MRR@N. Has no batch evaluation capabilities. Breaks up ties.</span>
<span class="sd">    Parameters</span>
<span class="sd">    --------</span>
<span class="sd">    pr : baseline predictor</span>
<span class="sd">        A trained instance of a baseline predictor.</span>
<span class="sd">    metrics : list</span>
<span class="sd">        A list of metric classes providing the proper methods</span>
<span class="sd">    test_data : pandas.DataFrame</span>
<span class="sd">        Test data. It contains the transactions of the test set.It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">        It must have a header. Column names are arbitrary, but must correspond to the keys you use in this function.</span>
<span class="sd">    train_data : pandas.DataFrame</span>
<span class="sd">        Training data. Only required for selecting the set of item IDs of the training set.</span>
<span class="sd">    items : 1D list or None</span>
<span class="sd">        The list of item ID that you want to compare the score of the relevant item to. If None, all items of the training set are used. Default value is None.</span>
<span class="sd">    cut-off : int</span>
<span class="sd">        Cut-off value (i.e. the length of the recommendation list; N for recall@N and MRR@N). Defauld value is 20.</span>
<span class="sd">    session_key : string</span>
<span class="sd">        Header of the session ID column in the input file (default: &#39;SessionId&#39;)</span>
<span class="sd">    item_key : string</span>
<span class="sd">        Header of the item ID column in the input file (default: &#39;ItemId&#39;)</span>
<span class="sd">    time_key : string</span>
<span class="sd">        Header of the timestamp column in the input file (default: &#39;Time&#39;)</span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    out :  list of tuples</span>
<span class="sd">        (metric_name, value)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">actions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="n">session_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;START evaluation of &#39;</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="s1">&#39; actions in &#39;</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span> <span class="s1">&#39; sessions&#39;</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">time_sum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_sum_clock</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">test_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">session_key</span><span class="p">,</span> <span class="n">time_key</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">items_to_predict</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">prev_iid</span><span class="p">,</span> <span class="n">prev_sid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">))):</span>

        <span class="c1"># if count % 1000 == 0:</span>
        <span class="c1">#     print(f&#39;eval process: {count} of  {actions} actions: {(count / actions * 100.0):.2f} % in {(time.time()-st):.2f} s&#39;)</span>

        <span class="n">sid</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">session_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">iid</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">time_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">prev_sid</span> <span class="o">!=</span> <span class="n">sid</span><span class="p">:</span>
            <span class="n">prev_sid</span> <span class="o">=</span> <span class="n">sid</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">iid</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
                    <span class="n">items_to_predict</span> <span class="o">=</span> <span class="n">items</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">items_to_predict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">iid</span><span class="p">],</span> <span class="n">items</span><span class="p">))</span>

            <span class="n">crs</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">trs</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;start_predict&#39;</span><span class="p">):</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">start_predict</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>

            <span class="n">preds</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">predict_next</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">prev_iid</span><span class="p">,</span> <span class="n">items_to_predict</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;stop_predict&#39;</span><span class="p">):</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">stop_predict</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>

            <span class="n">preds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">preds</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#             preds += 1e-8 * np.random.rand(len(preds)) #Breaking up ties</span>
            <span class="n">preds</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">time_sum_clock</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">crs</span>
            <span class="n">time_sum</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">trs</span>
            <span class="n">time_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">):</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">iid</span><span class="p">,</span> <span class="n">for_item</span><span class="o">=</span><span class="n">prev_iid</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">prev_iid</span> <span class="o">=</span> <span class="n">iid</span>

        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">END evaluation in &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">sc</span><span class="p">),</span> <span class="s1">&#39;c / &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">),</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    avg rt &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time_sum</span><span class="o">/</span><span class="n">time_count</span><span class="p">),</span> <span class="s1">&#39;s / &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time_sum_clock</span><span class="o">/</span><span class="n">time_count</span><span class="p">),</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    time count &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time_count</span><span class="p">),</span> <span class="s1">&#39;count/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time_sum</span><span class="p">),</span> <span class="s1">&#39; sum&#39;</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Time_usage_testing&#39;</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">result_second</span><span class="p">(</span><span class="n">time_sum_clock</span><span class="o">/</span><span class="n">time_count</span><span class="p">))</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">result_cpu</span><span class="p">(</span><span class="n">time_sum_clock</span> <span class="o">/</span> <span class="n">time_count</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">res</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metrics">Metrics<a class="anchor-link" href="#Metrics"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">MRR</span><span class="p">:</span> 
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MRR( length=20 )</span>
<span class="sd">    Used to iteratively calculate the average mean reciprocal rank for a result list with the defined length. </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    length : int</span>
<span class="sd">        MRR@length</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
    
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Do initialization work here.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        train: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reset for usage in multiple evaluations</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_popbin</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_position</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_item</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_item</span><span class="p">,</span> <span class="n">for_item</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pop_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the metric with a result set and the correct next item.</span>
<span class="sd">        Result must be sorted correctly.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        result: pandas.Series</span>
<span class="sd">            Series of scores with the item id as the index</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">pop_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pop_bin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">[</span><span class="n">pop_bin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos_popbin</span><span class="p">[</span><span class="n">pop_bin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">[</span><span class="n">pop_bin</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">position</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos_position</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">next_item</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">rank</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span> <span class="n">next_item</span> <span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="p">(</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">rank</span> <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">pop_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos_popbin</span><span class="p">[</span><span class="n">pop_bin</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">rank</span> <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos_position</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">rank</span> <span class="p">)</span>
                   
        
        
    <span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_item</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the metric with a result set and the correct next item.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        result: pandas.DataFrame</span>
<span class="sd">            Prediction scores for selected items for every event of the batch.</span>
<span class="sd">            Columns: events of the batch; rows: items. Rows are indexed by the item IDs.</span>
<span class="sd">        next_item: Array of correct next items</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> 
            <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span> <span class="n">part</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">series</span><span class="p">,</span> <span class="n">next_item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tuple of a description string and the current averaged value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;MRR@&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_pop_bin</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_position</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">result_pop_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tuple of a description string and the current averaged value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">csv</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">csv</span> <span class="o">+=</span> <span class="s1">&#39;Bin: ;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">:</span>
            <span class="n">csv</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
        <span class="n">csv</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Precision@&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: ;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">:</span>
            <span class="n">csv</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_popbin</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
            
        <span class="k">return</span> <span class="n">csv</span>
    
    <span class="k">def</span> <span class="nf">result_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tuple of a description string and the current averaged value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">csv</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">csv</span> <span class="o">+=</span> <span class="s1">&#39;Pos: ;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">:</span>
            <span class="n">csv</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
        <span class="n">csv</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Precision@&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: ;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">:</span>
            <span class="n">csv</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_position</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
            
        <span class="k">return</span> <span class="n">csv</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">HitRate</span><span class="p">:</span> 
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MRR( length=20 )</span>
<span class="sd">    Used to iteratively calculate the average hit rate for a result list with the defined length. </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    length : int</span>
<span class="sd">        HitRate@length</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
    
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Do initialization work here.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        train: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reset for usage in multiple evaluations</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hit</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hit_popbin</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hit_position</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_item</span><span class="p">,</span> <span class="n">for_item</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pop_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the metric with a result set and the correct next item.</span>
<span class="sd">        Result must be sorted correctly.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        result: pandas.Series</span>
<span class="sd">            Series of scores with the item id as the index</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">+=</span> <span class="mi">1</span>
         
        <span class="k">if</span> <span class="n">pop_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pop_bin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">[</span><span class="n">pop_bin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hit_popbin</span><span class="p">[</span><span class="n">pop_bin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">[</span><span class="n">pop_bin</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">position</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hit_position</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                
        <span class="k">if</span> <span class="n">next_item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hit</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">pop_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hit_popbin</span><span class="p">[</span><span class="n">pop_bin</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hit_position</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            
        
        
    <span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_item</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the metric with a result set and the correct next item.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        result: pandas.DataFrame</span>
<span class="sd">            Prediction scores for selected items for every event of the batch.</span>
<span class="sd">            Columns: events of the batch; rows: items. Rows are indexed by the item IDs.</span>
<span class="sd">        next_item: Array of correct next items</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> 
            <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span> <span class="n">part</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">series</span><span class="p">,</span> <span class="n">next_item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tuple of a description string and the current averaged value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;HitRate@&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hit</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_pop_bin</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_position</span><span class="p">()</span>

    
    <span class="k">def</span> <span class="nf">result_pop_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tuple of a description string and the current averaged value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">csv</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">csv</span> <span class="o">+=</span> <span class="s1">&#39;Bin: ;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">:</span>
            <span class="n">csv</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
        <span class="n">csv</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">HitRate@&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: ;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">:</span>
            <span class="n">csv</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">hit_popbin</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_popbin</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
            
        <span class="k">return</span> <span class="n">csv</span>
    
    <span class="k">def</span> <span class="nf">result_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tuple of a description string and the current averaged value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">csv</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">csv</span> <span class="o">+=</span> <span class="s1">&#39;Pos: ;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">:</span>
            <span class="n">csv</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
        <span class="n">csv</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">HitRate@&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: ;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">:</span>
            <span class="n">csv</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">hit_position</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_position</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
            
        <span class="k">return</span> <span class="n">csv</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Coverage</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Coverage( length=20 )</span>
<span class="sd">    Used to iteratively calculate the coverage of an algorithm regarding the item space. </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    length : int</span>
<span class="sd">        Coverage@length</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">item_key</span> <span class="o">=</span> <span class="s1">&#39;ItemId&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Do initialization work here.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        train: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">        &#39;&#39;&#39;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">coverage_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="c1"># keep track of full item list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reset for usage in multiple evaluations</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverage_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">return</span>
    
    <span class="k">def</span> <span class="nf">skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_item</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_item</span><span class="p">,</span> <span class="n">for_item</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pop_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the metric with a result set and the correct next item.</span>
<span class="sd">        Result must be sorted correctly.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        result: pandas.Series</span>
<span class="sd">            Series of scores with the item id as the index</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverage_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">items</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">items</span> <span class="p">)</span> <span class="c1"># update items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">add_multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_items</span><span class="p">,</span> <span class="n">for_item</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">next_items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">for_item</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_item</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the metric with a result set and the correct next item.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        result: pandas.DataFrame</span>
<span class="sd">            Prediction scores for selected items for every event of the batch.</span>
<span class="sd">            Columns: events of the batch; rows: items. Rows are indexed by the item IDs.</span>
<span class="sd">        next_item: Array of correct next items</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> 
            <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span> <span class="n">part</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">series</span><span class="p">,</span> <span class="n">next_item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
        
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tuple of a description string and the current averaged value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Coverage@&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span><span class="p">),</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coverage_set</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Popularity</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Popularity( length=20 )</span>
<span class="sd">    Used to iteratively calculate the average overall popularity of an algorithm&#39;s recommendations. </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    length : int</span>
<span class="sd">        Coverage@length</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">session_key</span> <span class="o">=</span> <span class="s1">&#39;SessionId&#39;</span>
    <span class="n">item_key</span>    <span class="o">=</span> <span class="s1">&#39;ItemId&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Do initialization work here.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        train: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_actions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">train</span><span class="o">.</span><span class="n">index</span> <span class="p">)</span>
        <span class="c1">#group the data by the itemIds</span>
        <span class="n">grp</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">)</span>
        <span class="c1">#count the occurence of every itemid in the trainingdataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_scores</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="c1">#sort it according to the  score</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_scores</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_scores</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_scores</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reset for usage in multiple evaluations</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span><span class="o">=</span><span class="mi">0</span>
     
    <span class="k">def</span> <span class="nf">skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_item</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">):</span>
        <span class="k">pass</span> 
        
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_item</span><span class="p">,</span> <span class="n">for_item</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pop_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the metric with a result set and the correct next item.</span>
<span class="sd">        Result must be sorted correctly.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        result: pandas.Series</span>
<span class="sd">            Series of scores with the item id as the index</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#only keep the k- first predictions</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">]</span>
        <span class="c1">#take the unique values out of those top scorers</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_scores</span><span class="p">[</span> <span class="n">items</span> <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span> <span class="n">items</span> <span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">add_multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_items</span><span class="p">,</span> <span class="n">for_item</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">next_items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">for_item</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_item</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the metric with a result set and the correct next item.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        result: pandas.DataFrame</span>
<span class="sd">            Prediction scores for selected items for every event of the batch.</span>
<span class="sd">            Columns: events of the batch; rows: items. Rows are indexed by the item IDs.</span>
<span class="sd">        next_item: Array of correct next items</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> 
            <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span> <span class="n">part</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">series</span><span class="p">,</span> <span class="n">next_item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tuple of a description string and the current averaged value</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Popularity@&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span><span class="p">),</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="SLIST-model">SLIST model<a class="anchor-link" href="#SLIST-model"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">SLIST</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    SLIST(reg=10)</span>
<span class="sd">    Parameters</span>
<span class="sd">    --------</span>
<span class="sd">    Will be added</span>
<span class="sd">    --------</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Must need</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">session_weight</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">train_weight</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">predict_weight</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;part&#39;</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;SessionId&#39;</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;ItemId&#39;</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">train_weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">train_weight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">predict_weight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_weight</span> <span class="o">=</span> <span class="n">session_weight</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">3600</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">session_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_key</span> <span class="o">=</span> <span class="n">item_key</span>

        <span class="c1"># updated while recommending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="c1"># Must need</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Trains the predictor.</span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        data: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># make new session ids(1 ~ #sessions)</span>
        <span class="n">sessionids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sessions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessionids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessionidmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sessions</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">sessionids</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">:</span> <span class="n">sessionids</span><span class="p">,</span> <span class="s1">&#39;SessionIdx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessionidmap</span><span class="p">[</span><span class="n">sessionids</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}),</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

        <span class="c1"># make new item ids(1 ~ #items)</span>
        <span class="n">itemids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">itemids</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">:</span> <span class="n">itemids</span><span class="p">,</span> <span class="s1">&#39;ItemIdx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">itemids</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}),</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

        <span class="c1"># ||X - XB||</span>
        <span class="n">input1</span><span class="p">,</span> <span class="n">target1</span><span class="p">,</span> <span class="n">row_weight1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_train_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weight_by</span><span class="o">=</span><span class="s1">&#39;SLIS&#39;</span><span class="p">)</span>
        <span class="c1"># ||Y - ZB||</span>
        <span class="n">input2</span><span class="p">,</span> <span class="n">target2</span><span class="p">,</span> <span class="n">row_weight2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_train_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weight_by</span><span class="o">=</span><span class="s1">&#39;SLIT&#39;</span><span class="p">)</span>
        <span class="c1"># alpha * ||X - XB|| + (1-alpha) * ||Y - ZB||</span>
        <span class="n">input1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">input1</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">target1</span><span class="o">.</span><span class="n">data</span>
        <span class="n">input2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">input2</span><span class="o">.</span><span class="n">data</span>
        <span class="n">target2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">target2</span><span class="o">.</span><span class="n">data</span>

        <span class="n">input_matrix</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">input1</span><span class="p">,</span> <span class="n">input2</span><span class="p">])</span>
        <span class="n">target_matrix</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">target1</span><span class="p">,</span> <span class="n">target2</span><span class="p">])</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">row_weight1</span> <span class="o">+</span> <span class="n">row_weight2</span>  <span class="c1"># list</span>

        <span class="c1"># P = (X^T * X + ŒªI)^‚àí1 = (G + ŒªI)^‚àí1</span>
        <span class="c1"># (A+B)^-1 = A^-1 - A^-1 * B * (A+B)^-1</span>
        <span class="c1"># P =  G</span>
        <span class="n">W2</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">input_matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">input_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;G is made. Sparsity:</span><span class="si">{</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">G</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">G</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;P is made&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">G</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="o">-</span><span class="n">P</span> <span class="o">@</span> <span class="p">(</span><span class="n">input_matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">input_matrix</span><span class="o">-</span><span class="n">target_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>

            <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
            <span class="n">mu</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span>
            <span class="n">mu_nonzero_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
            <span class="n">mu</span><span class="p">[</span><span class="n">mu_nonzero_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">P</span><span class="p">))[</span><span class="n">mu_nonzero_idx</span><span class="p">]</span>

            <span class="c1"># B = I - PŒª + C</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enc_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="n">P</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;weight matrix is made&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enc_w</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">input_matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W2</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">target_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">make_train_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">weight_by</span><span class="o">=</span><span class="s1">&#39;SLIT&#39;</span><span class="p">):</span>
        <span class="n">input_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">input_col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">maxtime</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sessionlengthmap</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SessionIdx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">rowid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="s1">&#39;./data_ckpt/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">weight_by</span> <span class="o">==</span> <span class="s1">&#39;SLIT&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./data_ckpt/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sessions</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s1">_SLIT.p&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./data_ckpt/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sessions</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s1">_SLIT.p&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">input_row</span><span class="p">,</span> <span class="n">input_col</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">target_row</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;SessionIdx&#39;</span><span class="p">]),</span> <span class="n">desc</span><span class="o">=</span><span class="n">weight_by</span><span class="p">):</span>
                    <span class="n">slen</span> <span class="o">=</span> <span class="n">sessionlengthmap</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                    <span class="c1"># sessionitems = session[&#39;ItemIdx&#39;].tolist() # sorted by itemid</span>
                    <span class="n">sessionitems</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;Time&#39;</span><span class="p">])[</span><span class="s1">&#39;ItemIdx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># sorted by time</span>
                    <span class="n">slen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessionitems</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">slen</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">stime</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">w2</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stime</span><span class="o">-</span><span class="n">maxtime</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">slen</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slen</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">rowid</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># input matrix</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;part&#39;</span><span class="p">:</span>
                            <span class="n">input_row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rowid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">input_col</span> <span class="o">+=</span> <span class="n">sessionitems</span><span class="p">[:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">input_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">s</span><span class="p">))</span>
                            <span class="n">target_row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rowid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">slen</span> <span class="o">-</span> <span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                            <span class="n">target_col</span> <span class="o">+=</span> <span class="n">sessionitems</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">slen</span><span class="p">):</span>
                                <span class="n">target_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">((</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">s</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                            <span class="n">input_row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rowid</span><span class="p">]</span> <span class="o">*</span> <span class="n">slen</span>
                            <span class="n">input_col</span> <span class="o">+=</span> <span class="n">sessionitems</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slen</span><span class="p">):</span>
                                <span class="n">input_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">s</span><span class="p">))</span>
                            <span class="n">target_row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rowid</span><span class="p">]</span> <span class="o">*</span> <span class="n">slen</span>
                            <span class="n">target_col</span> <span class="o">+=</span> <span class="n">sessionitems</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slen</span><span class="p">):</span>
                                <span class="n">target_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">((</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">s</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;sr&#39;</span><span class="p">:</span>
                            <span class="n">input_row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rowid</span><span class="p">]</span>
                            <span class="n">input_col</span> <span class="o">+=</span> <span class="p">[</span><span class="n">sessionitems</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>
                            <span class="n">input_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">target_row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rowid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">slen</span> <span class="o">-</span> <span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                            <span class="n">target_col</span> <span class="o">+=</span> <span class="n">sessionitems</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">slen</span><span class="p">):</span>
                                <span class="n">target_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">((</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">s</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;You have to choose right &#39;direction&#39;!&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./data_ckpt/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sessions</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s1">_SLIT.p&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">input_row</span><span class="p">,</span> <span class="n">input_col</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">target_row</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">w2</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_weight</span><span class="p">))</span>
            <span class="n">target_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_data</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_weight</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">weight_by</span> <span class="o">==</span> <span class="s1">&#39;SLIS&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./data_ckpt/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sessions</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="si">}</span><span class="s1">_SLIS.p&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./data_ckpt/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sessions</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="si">}</span><span class="s1">_SLIS.p&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">input_row</span><span class="p">,</span> <span class="n">input_col</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">target_row</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;SessionIdx&#39;</span><span class="p">]),</span> <span class="n">desc</span><span class="o">=</span><span class="n">weight_by</span><span class="p">):</span>
                    <span class="n">rowid</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">slen</span> <span class="o">=</span> <span class="n">sessionlengthmap</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                    <span class="n">sessionitems</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;ItemIdx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">stime</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">w2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stime</span><span class="o">-</span><span class="n">maxtime</span><span class="p">)</span>
                    <span class="n">input_row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rowid</span><span class="p">]</span> <span class="o">*</span> <span class="n">slen</span>
                    <span class="n">input_col</span> <span class="o">+=</span> <span class="n">sessionitems</span>

                <span class="n">target_row</span> <span class="o">=</span> <span class="n">input_row</span>
                <span class="n">target_col</span> <span class="o">=</span> <span class="n">input_col</span>
                <span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">input_row</span><span class="p">)</span>
                <span class="n">target_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">target_row</span><span class="p">)</span>
                
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./data_ckpt/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sessions</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="si">}</span><span class="s1">_SLIS.p&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">input_row</span><span class="p">,</span> <span class="n">input_col</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">target_row</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">w2</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;You have to choose right &#39;weight_by&#39;!&quot;</span><span class="p">)</span>

        <span class="c1"># Use train_weight or not</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
        <span class="n">target_data</span> <span class="o">=</span> <span class="n">target_data</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">target_data</span><span class="p">))</span>

        <span class="c1"># Use session_weight or not</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_weight</span><span class="p">))</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">w2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">w2</span><span class="p">))</span>

        <span class="c1"># Make sparse_matrix</span>
        <span class="n">input_matrix</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">input_data</span><span class="p">,</span> <span class="p">(</span><span class="n">input_row</span><span class="p">,</span> <span class="n">input_col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">input_row</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">target_matrix</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">target_data</span><span class="p">,</span> <span class="p">(</span><span class="n">target_row</span><span class="p">,</span> <span class="n">target_col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">input_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">weight_by</span><span class="si">}</span><span class="s2">]sparse matrix </span><span class="si">{</span><span class="n">input_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> is made.  Sparsity:</span><span class="si">{</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">input_matrix</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="o">*</span><span class="n">input_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">weight_by</span> <span class="o">==</span> <span class="s1">&#39;SLIT&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">weight_by</span> <span class="o">==</span> <span class="s1">&#39;SLIS&#39;</span><span class="p">:</span>
            <span class="c1"># Value of repeated items --&gt; 1</span>
            <span class="n">input_matrix</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">input_matrix</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">target_matrix</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">target_matrix</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Normalization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">==</span> <span class="s1">&#39;l1&#39;</span><span class="p">:</span>
            <span class="n">input_matrix</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">input_matrix</span><span class="p">,</span> <span class="s1">&#39;l1&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">==</span> <span class="s1">&#39;l2&#39;</span><span class="p">:</span>
            <span class="n">input_matrix</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">input_matrix</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">input_matrix</span><span class="p">,</span> <span class="n">target_matrix</span><span class="p">,</span> <span class="n">w2</span>

    <span class="c1"># ÌïÑÏàò</span>

    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">predict_for_item_ids</span><span class="p">,</span> <span class="n">input_user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gives predicton scores for a selected set of items on how likely they be the next item in the session.</span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_id : int or string</span>
<span class="sd">            The session IDs of the event.</span>
<span class="sd">        input_item_id : int or string</span>
<span class="sd">            The item ID of the event.</span>
<span class="sd">        predict_for_item_ids : 1D array</span>
<span class="sd">            IDs of items for which the network should give prediction scores. Every ID must be in the set of item IDs of the training set.</span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : pandas.Series</span>
<span class="sd">            Prediction scores for selected items on how likely to be the next item of this session. Indexed by the item IDs.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># new session</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_times</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;view&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_item_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>

        <span class="c1"># item id transfomration</span>
        <span class="n">session_items_new_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">predict_for_item_ids_new_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">predict_for_item_ids</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">if</span> <span class="n">session_items_new_id</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">predict_for_item_ids</span><span class="p">)</span>

        <span class="n">W_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">W_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc_w</span><span class="p">[</span><span class="n">session_items_new_id</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">session_items_new_id</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">W_test</span><span class="p">)):</span>
            <span class="n">W_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">W_test</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_weight</span><span class="p">)</span>

        <span class="n">W_test</span> <span class="o">=</span> <span class="n">W_test</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">W_test</span><span class="p">)</span>
        <span class="n">W_test</span> <span class="o">=</span> <span class="n">W_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># [session_items, num_items]</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc_w</span><span class="p">[</span><span class="n">session_items_new_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">W_test</span>
        <span class="c1"># [num_items]</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">predict_for_item_ids_new_id</span><span class="p">]</span>

        <span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">predict_for_item_ids</span><span class="p">)</span>

        <span class="n">series</span> <span class="o">=</span> <span class="n">series</span> <span class="o">/</span> <span class="n">series</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="c1"># remove current item from series of prediction</span>
        <span class="c1"># series.drop(labels=[input_item_id])</span>
        
        <span class="k">return</span> <span class="n">series</span>

    <span class="c1"># ÌïÑÏàò</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enc_w</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Main">Main<a class="anchor-link" href="#Main"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">FILE PARAMETERS</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">PATH_PROCESSED</span> <span class="o">=</span> <span class="s1">&#39;./prepared/&#39;</span>
<span class="n">FILE</span> <span class="o">=</span> <span class="s1">&#39;events&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">MODEL HYPERPARAMETER TUNING</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="c1">#[0.2, 0.4, 0.6, 0.8] </span>
<span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span> <span class="c1"># sr / part / all</span>
<span class="n">reg</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">train_weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#0.5 #[0.125, 0.25, 0.5, 1, 2, 4, 8]</span>
<span class="n">predict_weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#4 #[0.125, 0.25, 0.5, 1, 2, 4, 8]</span>
<span class="n">session_weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#256 #[1, 2, 4, 8, 16, 32, 64, 128, 256]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">load_data_session</span><span class="p">(</span><span class="n">PATH_PROCESSED</span><span class="p">,</span> <span class="n">FILE</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SLIST</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">train_weight</span><span class="o">=</span><span class="n">train_weight</span><span class="p">,</span> 
              <span class="n">predict_weight</span><span class="o">=</span><span class="n">predict_weight</span><span class="p">,</span> <span class="n">session_weight</span><span class="o">=</span><span class="n">session_weight</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="n">mrr</span> <span class="o">=</span> <span class="n">MRR</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">hr</span> <span class="o">=</span> <span class="n">HitRate</span><span class="p">()</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">Popularity</span><span class="p">()</span>
<span class="n">pop</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">Coverage</span><span class="p">()</span>
<span class="n">cov</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>START load data
Loaded train set
	Events: 53254
	Sessions: 13629
	Items: 2873
	Span: 2014-04-01 / 2014-04-06

Loaded test set
	Events: 16539
	Sessions: 4084
	Items: 2029
	Span: 2014-04-06 / 2014-04-07

END load data  0.08983836199999473 c /  0.0898427963256836 s
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>SLIS: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 13629/13629 [00:03&lt;00:00, 3569.65it/s]
SLIT: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 13629/13629 [00:09&lt;00:00, 1411.28it/s]
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">evaluate_sessions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="n">mrr</span><span class="p">,</span> <span class="n">hr</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>START evaluation of  16539  actions in  4084  sessions
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 16539/16539 [01:02&lt;00:00, 263.56it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
END evaluation in  62.77697779699997 c /  62.77697801589966 s
    avg rt  0.003989196120376618 s /  0.003987816305178503 c
    time count  12455 count/ 49.68543767929077  sum
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(&#39;MRR@100: &#39;,
  0.3521687942062188,
  &#39;Bin: ;\nPrecision@100: ;&#39;,
  &#39;Pos: ;0;1;2;3;4;5;6;7;8;9;10;11;12;13;14;15;16;17;18;19;20;21;22;23;24;25;26;27;28;29;30;31;32;33;34;35;36;37;38;39;40;41;42;43;44;45;46;47;48;49;50;51;\nPrecision@100: ;0.39043544699954863;0.3325325335562308;0.358431025984701;0.31195065232051633;0.3372114712929858;0.32268523251291464;0.3555237695229066;0.3166781959167088;0.34238487011710844;0.3221189158972095;0.31515860275983537;0.2895189958634645;0.3960849891052557;0.3853882229014253;0.3197574713916099;0.3025236016461091;0.3004164800841002;0.36369765591924186;0.3808260628265034;0.29341860165801975;0.2725921570091597;0.34991145218417946;0.24232666413393963;0.4091435185185185;0.2363186813186813;0.22504370629370626;0.18930041152263372;0.11895735686058267;0.14806547619047616;0.3020408163265306;0.13849206349206347;0.3333333333333333;0.3482142857142857;0.10606060606060605;0.125;0.6;0.2;0.0;0.03333333333333333;0.0;0.06666666666666667;0.3333333333333333;0.14285714285714285;0.1111111111111111;0.058823529411764705;0.14285714285714285;0.0;0.06666666666666667;0.0;0.058823529411764705;0.047619047619047616;0.3333333333333333;&#39;),
 (&#39;HitRate@20: &#39;,
  0.637173825772782,
  &#39;Bin: ;\nHitRate@20: ;&#39;,
  &#39;Pos: ;0;1;2;3;4;5;6;7;8;9;10;11;12;13;14;15;16;17;18;19;20;21;22;23;24;25;26;27;28;29;30;31;32;33;34;35;36;37;38;39;40;41;42;43;44;45;46;47;48;49;50;51;\nHitRate@20: ;0.6339373163565132;0.6320914479254869;0.6607958251793868;0.627134724857685;0.6466575716234653;0.626641651031895;0.6666666666666666;0.6081504702194357;0.6629213483146067;0.6051282051282051;0.6329113924050633;0.59375;0.7247706422018348;0.6630434782608695;0.5833333333333334;0.639344262295082;0.6;0.6122448979591837;0.7297297297297297;0.6774193548387096;0.4583333333333333;0.6363636363636364;0.6842105263157895;0.7222222222222222;0.5333333333333333;0.7272727272727273;0.4444444444444444;0.4444444444444444;0.625;0.42857142857142855;0.5;0.5;0.75;0.5;0.5;1.0;1.0;0.0;0.0;0.0;1.0;1.0;1.0;1.0;1.0;1.0;0.0;1.0;0.0;1.0;0.0;1.0;&#39;),
 (&#39;Popularity@20: &#39;, 0.12476653149405403),
 (&#39;Coverage@20: &#39;, 0.9557953358858337)]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">reload_ext</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;Sparsh A.&quot;</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">t</span> <span class="o">-</span><span class="n">d</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Author: Sparsh A.

Last updated: 2021-12-10 06:52:33

Compiler    : GCC 7.5.0
OS          : Linux
Release     : 5.4.104+
Machine     : x86_64
Processor   : x86_64
CPU cores   : 2
Architecture: 64bit

numpy  : 1.19.5
IPython: 5.5.0
scipy  : 1.4.1
pandas : 1.1.5

</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>END</strong></p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/2022/01/12/slist-yoochoose.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
