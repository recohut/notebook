<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Training GroupIM model on Weeplaces dataset | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Training GroupIM model on Weeplaces dataset" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/09/groupim-weeplaces.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/09/groupim-weeplaces.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-09T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Training GroupIM model on Weeplaces dataset" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-09T00:00:00-06:00","datePublished":"2022-01-09T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Training GroupIM model on Weeplaces dataset","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/09/groupim-weeplaces.html"},"url":"https://nb.recohut.com/2022/01/09/groupim-weeplaces.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Training GroupIM model on Weeplaces dataset</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-09T00:00:00-06:00" itemprop="datePublished">
        Jan 9, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      25 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-09-groupim-weeplaces.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-09-groupim-weeplaces.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-09-groupim-weeplaces.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-09-groupim-weeplaces.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-09-groupim-weeplaces.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Executive-summary">Executive summary<a class="anchor-link" href="#Executive-summary"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Problem</td>
<td>Group interactions are sparse in nature which makes it difficult to provide relevant recommendation to the group.</td>
</tr>
<tr>
<td>Solution</td>
<td>Regularize the user-group latent space to overcome group interaction sparsity by: maximizing mutual information between representations of groups and group members; and dynamically prioritizing the preferences of highly informative members through contextual preference weighting.</td>
</tr>
<tr>
<td>Dataset</td>
<td>Weeplaces</td>
</tr>
<tr>
<td>Preprocessing</td>
<td>We extract check-ins on POIs over all major cities in the United States, across various categories including Food, Nightlife, Outdoors, Entertainment and Travel. We randomly split the set of all groups into training (70%), validation (10%), and test (20%) sets, while utilizing the individual interactions of all users for training. Note that each group appears only in one of the three sets. The test set contains strict ephemeral groups (i.e., a specific combination of users) that do not occur in the training set. Thus, we train on ephemeral groups and test on strict ephemeral groups.</td>
</tr>
<tr>
<td>Metrics</td>
<td>NDCG, Recall</td>
</tr>
<tr>
<td>Hyperparams</td>
<td>We tune the latent dimension in the range {32, 64, 128} and other baseline hyper-parameters in ranges centered at author-provided values. In GroupIM, we use two fully connected layers of size 64 each in fenc(Â·) and tune Î» in the range {$2^{âˆ’4}$,$2^{âˆ’3}$,$\dots$, $2^{6}$}. We use 5 negatives for each true user-group pair to train the discriminator.</td>
</tr>
<tr>
<td>Models</td>
<td>GroupIM along with Encoder, 3 types of Aggregators to choose from, and a discriminator module.</td>
</tr>
<tr>
<td>Platform</td>
<td>PyTorch, preferable GPU for faster computation.</td>
</tr>
<tr>
<td>Links</td>
<td><a href="https://arxiv.org/abs/2006.03736">Paper</a>, <a href="https://github.com/RecoHut-Stanzas/S168471">Code</a></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">recohut</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124 kB 5.4 MB/s 
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Datasets">Datasets<a class="anchor-link" href="#Datasets"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">normalize</span>
<span class="kn">from</span> <span class="nn">torch.utils</span> <span class="kn">import</span> <span class="n">data</span>

<span class="kn">from</span> <span class="nn">recohut.datasets</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">recohut.utils.common_utils</span> <span class="kn">import</span> <span class="n">download_url</span><span class="p">,</span> <span class="n">extract_zip</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">WeeplacesDataset</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/RecoHut-Datasets/weeplaces/raw/v2/data.zip&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">is_group</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">negs_per_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">datatype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="n">n_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negs_per_group</span> <span class="o">=</span> <span class="n">negs_per_group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_group</span> <span class="o">=</span> <span class="n">is_group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span> <span class="o">=</span> <span class="n">padding_idx</span>
        <span class="k">if</span> <span class="n">is_group</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_user_data_train</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_group_data_train</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_users</span><span class="p">[</span><span class="n">g</span><span class="p">]]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_list</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eval_groups_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_user_data_tr_te</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eval_group_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_group_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_group_data_tr_te</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_data_ui</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ui_train</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_users</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ui_tr_te</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_group</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_groups_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__train__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load user_id, binary vector over items &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">user_items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_data_ui</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># [I]</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">user</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)),</span> <span class="n">user_items</span>

    <span class="k">def</span> <span class="nf">__test__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load user_id, fold-in items, held-out items &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">fold_in</span><span class="p">,</span> <span class="n">held_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tr</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_te</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>  <span class="c1"># [I], [I]</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">fold_in</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">held_out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># user, fold-in items, fold-out items.</span>

    <span class="k">def</span> <span class="nf">__train_group__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load group_id, padded group users, mask, group items, group member items, negative user items &quot;&quot;&quot;</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">user_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_users</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>  <span class="c1"># [G] group member ids</span>
        <span class="n">group_items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_data</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>  <span class="c1"># [I] items per group</span>

        <span class="n">corrupted_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_corrupted_users</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>  <span class="c1"># [# negs]</span>
        <span class="n">corrupted_user_items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="n">corrupted_group</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>  <span class="c1"># [# negs, I]</span>

        <span class="c1"># group mask to create fixed-size padded groups.</span>
        <span class="n">group_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span> <span class="o">-</span> <span class="nb">list</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span><span class="p">)</span>
        <span class="n">group_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">group_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span>
                                                      <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span> <span class="o">-</span> <span class="n">group_length</span><span class="p">,</span>
                                                              <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)]))</span>  <span class="c1"># [G]</span>

        <span class="n">user_items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_inputs</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>  <span class="c1"># [G, |I|] group member items</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">group</span><span class="p">]),</span> <span class="n">user_ids</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span><span class="p">,</span> <span class="n">corrupted_user_items</span>

    <span class="k">def</span> <span class="nf">__test_group__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load group_id, padded group users, mask, group items, group member items &quot;&quot;&quot;</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_groups_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_group_users</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># [G]</span>
        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gsize</span> <span class="o">-</span> <span class="nb">list</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_gsize</span> <span class="o">-</span> <span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)]))</span>  <span class="c1"># [G]</span>
        <span class="n">group_items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_group_data</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>  <span class="c1"># [I]</span>
        <span class="n">user_items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="n">user_ids</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>  <span class="c1"># [G, I]</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">group</span><span class="p">]),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">user_ids</span><span class="p">),</span> <span class="n">mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_group</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__train_group__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__test_group__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__train__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__test__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">raw_file_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;train_ui.csv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;val_ui_te.csv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;group_users.csv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;data.zip&#39;</span><span class="p">,</span>
                <span class="s1">&#39;train_gi.csv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;test_ui_tr.csv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;val_ui_tr.csv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;test_ui_te.csv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;val_gi.csv&#39;</span><span class="p">,</span>
                <span class="s1">&#39;test_gi.csv&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">download_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_dir</span><span class="p">)</span>
        <span class="n">extract_zip</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_dir</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">processed_file_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">load_ui_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load training user-item interactions as a sparse matrix &quot;&quot;&quot;</span>
        <span class="n">path_ui</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s2">&quot;train_ui&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df_ui</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_ui</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">rows_ui</span><span class="p">,</span> <span class="n">cols_ui</span> <span class="o">=</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
        <span class="n">data_ui</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rows_ui</span><span class="p">),</span> <span class="p">(</span><span class="n">rows_ui</span><span class="p">,</span> <span class="n">cols_ui</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">))</span>  <span class="c1"># [# train users, I] sparse matrix</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# train users&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span><span class="p">,</span> <span class="s2">&quot;# items&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_ui</span>

    <span class="k">def</span> <span class="nf">load_ui_tr_te</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load user-item interactions of val/test user sets as two sparse matrices of fold-in and held-out items &quot;&quot;&quot;</span>
        <span class="n">ui_tr_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_ui_tr.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ui_te_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_ui_te.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ui_df_tr</span><span class="p">,</span> <span class="n">ui_df_te</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ui_tr_path</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ui_te_path</span><span class="p">)</span>

        <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ui_df_tr</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ui_df_te</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ui_df_tr</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ui_df_te</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="n">rows_tr</span><span class="p">,</span> <span class="n">cols_tr</span> <span class="o">=</span> <span class="n">ui_df_tr</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">ui_df_tr</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
        <span class="n">rows_te</span><span class="p">,</span> <span class="n">cols_te</span> <span class="o">=</span> <span class="n">ui_df_te</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">ui_df_te</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">ui_data_tr</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rows_tr</span><span class="p">),</span> <span class="p">(</span><span class="n">rows_tr</span><span class="p">,</span> <span class="n">cols_tr</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                                   <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">))</span>  <span class="c1"># [# eval users, I] sparse matrix</span>
        <span class="n">ui_data_te</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rows_te</span><span class="p">),</span> <span class="p">(</span><span class="n">rows_te</span><span class="p">,</span> <span class="n">cols_te</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                                   <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">))</span>  <span class="c1"># [# eval users, I] sparse matrix</span>
        <span class="k">return</span> <span class="n">ui_data_tr</span><span class="p">,</span> <span class="n">ui_data_te</span>

    <span class="k">def</span> <span class="nf">get_corrupted_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; negative user sampling per group (eta balances item-biased and random sampling) &quot;&quot;&quot;</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_users</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_users</span><span class="p">[</span><span class="n">group</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">([</span><span class="n">p</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">item_biased</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_data</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">item_biased</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span>
        <span class="n">negative_users</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">negs_per_group</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">negative_users</span>

    <span class="k">def</span> <span class="nf">load_user_data_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load user-item interactions of all users that appear in training groups, as a sparse matrix &quot;&quot;&quot;</span>
        <span class="n">df_ui</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">train_path_ui</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;train_ui.csv&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df_train_ui</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_path_ui</span><span class="p">)</span>
        <span class="n">df_ui</span> <span class="o">=</span> <span class="n">df_ui</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_train_ui</span><span class="p">)</span>

        <span class="c1"># include users from the (fold-in item set) of validation and test sets of user-item data.</span>
        <span class="n">val_path_ui</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;val_ui_tr.csv&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df_val_ui</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">val_path_ui</span><span class="p">)</span>
        <span class="n">df_ui</span> <span class="o">=</span> <span class="n">df_ui</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_val_ui</span><span class="p">)</span>

        <span class="n">test_path_ui</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;test_ui_tr.csv&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df_test_ui</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">test_path_ui</span><span class="p">)</span>
        <span class="n">df_ui</span> <span class="o">=</span> <span class="n">df_ui</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_test_ui</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span> <span class="o">=</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span>  <span class="c1"># padding idx for user when creating groups of fixed size.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">==</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">rows_ui</span><span class="p">,</span> <span class="n">cols_ui</span> <span class="o">=</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>

        <span class="n">data_ui</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rows_ui</span><span class="p">),</span> <span class="p">(</span><span class="n">rows_ui</span><span class="p">,</span> <span class="n">cols_ui</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_users</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">))</span>  <span class="c1"># [U, I] sparse matrix</span>
        <span class="k">return</span> <span class="n">data_ui</span>

    <span class="k">def</span> <span class="nf">load_user_data_tr_te</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load all user-item interactions of users that occur in val/test groups, as a sparse matrix &quot;&quot;&quot;</span>
        <span class="n">df_ui</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">train_path_ui</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;train_ui.csv&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df_train_ui</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_path_ui</span><span class="p">)</span>
        <span class="n">df_ui</span> <span class="o">=</span> <span class="n">df_ui</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_train_ui</span><span class="p">)</span>

        <span class="n">val_path_ui</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;val_ui_tr.csv&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df_val_ui</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">val_path_ui</span><span class="p">)</span>
        <span class="n">df_ui</span> <span class="o">=</span> <span class="n">df_ui</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_val_ui</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;val&#39;</span> <span class="ow">or</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="c1"># include eval user set (tr) items (since they might occur in evaluation set)</span>
            <span class="n">test_path_ui</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;test_ui_tr.csv&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df_test_ui</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">test_path_ui</span><span class="p">)</span>
            <span class="n">df_ui</span> <span class="o">=</span> <span class="n">df_ui</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_test_ui</span><span class="p">)</span>

        <span class="n">n_users</span> <span class="o">=</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">==</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">rows_ui</span><span class="p">,</span> <span class="n">cols_ui</span> <span class="o">=</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">df_ui</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
        <span class="n">data_ui</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rows_ui</span><span class="p">),</span> <span class="p">(</span><span class="n">rows_ui</span><span class="p">,</span> <span class="n">cols_ui</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_users</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">))</span>  <span class="c1"># [# users, I] sparse matrix</span>
        <span class="k">return</span> <span class="n">data_ui</span>

    <span class="k">def</span> <span class="nf">load_group_data_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load training group-item interactions as a sparse matrix and user-group memberships &quot;&quot;&quot;</span>
        <span class="n">path_ug</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;group_users.csv&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">path_gi</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;train_gi.csv&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_gi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_gi</span><span class="p">)</span>  <span class="c1"># load training group-item interactions.</span>
        <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">df_gi</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_gi</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">rows_gi</span><span class="p">,</span> <span class="n">cols_gi</span> <span class="o">=</span> <span class="n">df_gi</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">df_gi</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>

        <span class="n">data_gi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rows_gi</span><span class="p">),</span> <span class="p">(</span><span class="n">rows_gi</span><span class="p">,</span> <span class="n">cols_gi</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">))</span>  <span class="c1"># [# groups,  I] sparse matrix.</span>

        <span class="n">df_ug</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_ug</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># load user-group memberships.</span>
        <span class="n">df_ug_train</span> <span class="o">=</span> <span class="n">df_ug</span><span class="p">[</span><span class="n">df_ug</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))]</span>
        <span class="n">df_ug_train</span> <span class="o">=</span> <span class="n">df_ug_train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>  <span class="c1"># sort in ascending order of group ids.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span> <span class="o">=</span> <span class="n">df_ug_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c1"># max group size denoted by G</span>

        <span class="n">g_u_list_train</span> <span class="o">=</span> <span class="n">df_ug_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">g_u_list_train</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
                                          <span class="n">g_u_list_train</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
        <span class="n">data_gu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">g_u_list_train</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>  <span class="c1"># [# groups, G] with padding.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_ug_train</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# training groups: </span><span class="si">{}</span><span class="s2">, # max train group size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">data_gi</span><span class="p">,</span> <span class="n">data_gu</span>

    <span class="k">def</span> <span class="nf">load_group_data_tr_te</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load val/test group-item interactions as a sparse matrix and user-group memberships &quot;&quot;&quot;</span>
        <span class="n">path_ug</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;group_users.csv&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">path_gi</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_paths</span> <span class="k">if</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_gi.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span> <span class="ow">in</span> <span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_gi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_gi</span><span class="p">)</span>  <span class="c1"># load group-item interactions</span>
        <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">df_gi</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_gi</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">rows_gi</span><span class="p">,</span> <span class="n">cols_gi</span> <span class="o">=</span> <span class="n">df_gi</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">df_gi</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
        <span class="n">data_gi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rows_gi</span><span class="p">),</span> <span class="p">(</span><span class="n">rows_gi</span><span class="p">,</span> <span class="n">cols_gi</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">))</span>  <span class="c1"># [# eval groups, I] sparse matrix</span>

        <span class="n">df_ug</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_ug</span><span class="p">)</span>  <span class="c1"># load user-group memberships</span>
        <span class="n">df_ug_eval</span> <span class="o">=</span> <span class="n">df_ug</span><span class="p">[</span><span class="n">df_ug</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))]</span>
        <span class="n">df_ug_eval</span> <span class="o">=</span> <span class="n">df_ug_eval</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>  <span class="c1"># sort in ascending order of group ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gsize</span> <span class="o">=</span> <span class="n">df_ug_eval</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c1"># max group size denoted by G</span>
        <span class="n">g_u_list_eval</span> <span class="o">=</span> <span class="n">df_ug_eval</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">g_u_list_eval</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_gsize</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
                                         <span class="n">g_u_list_eval</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
        <span class="n">data_gu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">g_u_list_eval</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>  <span class="c1"># [# groups, G]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_groups_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data_gi</span><span class="p">,</span> <span class="n">data_gu</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Models">Models<a class="anchor-link" href="#Models"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Encoder">Encoder<a class="anchor-link" href="#Encoder"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; User Preference Encoder implemented as fully connected layers over binary bag-of-words vector</span>
<span class="sd">    (over item set) per user &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">user_layers</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">drop_ratio</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Encoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="n">n_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="n">embedding_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">drop_ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_preference_encoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>  <span class="c1"># user individual preference encoder layers.</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">]</span> <span class="o">+</span> <span class="n">user_layers</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">user_layers</span><span class="p">)):</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transform_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_layer</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_layer</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_predictor</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># item embedding for pre-training</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_predictor</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pre_train_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; user individual preference encoder (excluding final layer) for user-item pre-training</span>
<span class="sd">            :param user_items: [B, G, I] or [B, I]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_items_norm</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">user_items</span><span class="p">)</span>  <span class="c1"># [B, G, I] or [B, I]</span>
        <span class="n">user_pref_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">user_items_norm</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="p">))):</span>
            <span class="n">user_pref_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="p">[</span><span class="n">idx</span><span class="p">](</span><span class="n">user_pref_embedding</span><span class="p">)</span>  <span class="c1"># [B, G, D] or [B, D]</span>
            <span class="n">user_pref_embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">user_pref_embedding</span><span class="p">)</span>  <span class="c1"># [B, G, D] or [B, D]</span>

        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_predictor</span><span class="p">(</span><span class="n">user_pref_embedding</span><span class="p">)</span>  <span class="c1"># [B, G, D] or [B, D]</span>
        <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">user_pref_embedding</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; user individual preference encoder</span>
<span class="sd">            :param user_items: [B, G, I]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">user_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_train_forward</span><span class="p">(</span><span class="n">user_items</span><span class="p">)</span>  <span class="c1"># [B, G, D]</span>
        <span class="n">user_embeds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_layer</span><span class="p">(</span><span class="n">user_embeds</span><span class="p">))</span>  <span class="c1"># [B, G, D]</span>
        <span class="k">return</span> <span class="n">user_embeds</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Aggregator">Aggregator<a class="anchor-link" href="#Aggregator"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">MaxPoolAggregator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Group Preference Aggregator implemented as max pooling over group member embeddings &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">drop_ratio</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MaxPoolAggregator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">drop_ratio</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; max pooling aggregator:</span>
<span class="sd">            :param x: [B, G, D]  group member embeddings</span>
<span class="sd">            :param mask: [B, G]  -inf/0 for absent/present</span>
<span class="sd">            :param mlp: flag to add a linear layer before max pooling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mlp</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">values</span>


<span class="c1"># mask:  -inf/0 for absent/present.</span>
<span class="k">class</span> <span class="nc">MeanPoolAggregator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Group Preference Aggregator implemented as mean pooling over group member embeddings &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">drop_ratio</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MeanPoolAggregator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">drop_ratio</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; mean pooling aggregator:</span>
<span class="sd">            :param x: [B, G, D]  group member embeddings</span>
<span class="sd">            :param mask: [B, G]  -inf/0 for absent/present</span>
<span class="sd">            :param mlp: flag to add a linear layer before mean pooling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mlp</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>


<span class="k">class</span> <span class="nc">AttentionAggregator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Group Preference Aggregator implemented as attention over group member embeddings &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">drop_ratio</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionAggregator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">drop_ratio</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">output_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">drop_ratio</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; attentive aggregator:</span>
<span class="sd">            :param x: [B, G, D]  group member embeddings</span>
<span class="sd">            :param mask: [B, G]  -inf/0 for absent/present</span>
<span class="sd">            :param mlp: flag to add a linear layer before attention</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mlp</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">x</span>

        <span class="n">attention_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attention_out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attention_out</span> <span class="o">+</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Discriminator">Discriminator<a class="anchor-link" href="#Discriminator"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Discriminator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Discriminator for Mutual Information Estimation and Maximization, implemented with bilinear layers and</span>
<span class="sd">    binary cross-entropy loss training &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Discriminator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="n">embedding_dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc_layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_layer</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_layer</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bilinear_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Bilinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># output_dim = 1 =&gt; single score.</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bilinear_layer</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bilinear_layer</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bce_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_inputs</span><span class="p">,</span> <span class="n">user_inputs</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; bilinear discriminator:</span>
<span class="sd">            :param group_inputs: [B, I]</span>
<span class="sd">            :param user_inputs: [B, n_samples, I] where n_samples is either G or # negs</span>
<span class="sd">            :param group_mask: [B, G]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FC + activation.</span>
        <span class="n">group_encoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_layer</span><span class="p">(</span><span class="n">group_inputs</span><span class="p">)</span>  <span class="c1"># [B, D]</span>
        <span class="n">group_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">group_encoded</span><span class="p">)</span>  <span class="c1"># [B, D]</span>

        <span class="c1"># FC + activation.</span>
        <span class="n">user_pref_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_layer</span><span class="p">(</span><span class="n">user_inputs</span><span class="p">)</span>
        <span class="n">user_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">user_pref_embedding</span><span class="p">)</span>  <span class="c1"># [B, n_samples, D]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bilinear_layer</span><span class="p">(</span><span class="n">user_embed</span><span class="p">,</span> <span class="n">group_embed</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">mi_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores_group</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">scores_corrupted</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; binary cross-entropy loss over (group, user) pairs for discriminator training</span>
<span class="sd">            :param scores_group: [B, G]</span>
<span class="sd">            :param group_mask: [B, G]</span>
<span class="sd">            :param scores_corrupted: [B, N]</span>
<span class="sd">            :param device (cpu/gpu)</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">scores_group</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos_size</span><span class="p">,</span> <span class="n">neg_size</span> <span class="o">=</span> <span class="n">scores_group</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scores_corrupted</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">one_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">pos_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># [B, G]</span>
        <span class="n">zero_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">neg_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># [B, N]</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">one_labels</span><span class="p">,</span> <span class="n">zero_labels</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, G+N]</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">scores_group</span><span class="p">,</span> <span class="n">scores_corrupted</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># [B, G + N]</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">group_mask</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">neg_size</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)),</span>
                         <span class="mi">1</span><span class="p">)</span>  <span class="c1"># torch.exp(.) to binarize since original mask has -inf.</span>

        <span class="n">mi_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bce_loss</span><span class="p">(</span><span class="n">logits</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">labels</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">pos_size</span> <span class="o">+</span> <span class="n">neg_size</span><span class="p">))</span> \
                  <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">group_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">neg_size</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mi_loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="GroupIM-Model">GroupIM Model<a class="anchor-link" href="#GroupIM-Model"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">GroupIM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GroupIM framework for Group Recommendation:</span>
<span class="sd">    (a) User Preference encoding: user_preference_encoder</span>
<span class="sd">    (b) Group Aggregator: preference_aggregator</span>
<span class="sd">    (c) InfoMax Discriminator: discriminator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">user_layers</span><span class="p">,</span> <span class="n">lambda_mi</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">drop_ratio</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">aggregator_type</span><span class="o">=</span><span class="s1">&#39;attention&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GroupIM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="n">n_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_mi</span> <span class="o">=</span> <span class="n">lambda_mi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">drop_ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="n">user_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator_type</span> <span class="o">=</span> <span class="n">aggregator_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_preference_encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="n">user_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">drop_ratio</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator_type</span> <span class="o">==</span> <span class="s1">&#39;maxpool&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preference_aggregator</span> <span class="o">=</span> <span class="n">MaxPoolAggregator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator_type</span> <span class="o">==</span> <span class="s1">&#39;meanpool&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preference_aggregator</span> <span class="o">=</span> <span class="n">MeanPoolAggregator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator_type</span> <span class="o">==</span> <span class="s1">&#39;attention&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preference_aggregator</span> <span class="o">=</span> <span class="n">AttentionAggregator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Aggregator type </span><span class="si">{}</span><span class="s2"> not implemented &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregator_type</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">group_predictor</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_predictor</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span> <span class="o">=</span> <span class="n">Discriminator</span><span class="p">(</span><span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">):</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">user_items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; compute group embeddings and item recommendations by user preference encoding, group aggregation and</span>
<span class="sd">        item prediction</span>
<span class="sd">        :param group: [B] group id</span>
<span class="sd">        :param group_users: [B, G] group user ids with padding</span>
<span class="sd">        :param group_mask: [B, G] -inf/0 for absent/present user</span>
<span class="sd">        :param user_items: [B, G, I] individual item interactions of group members</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_pref_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="p">(</span><span class="n">user_items</span><span class="p">)</span>
        <span class="n">group_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preference_aggregator</span><span class="p">(</span><span class="n">user_pref_embeds</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># [B, D]</span>
        <span class="n">group_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_predictor</span><span class="p">(</span><span class="n">group_embed</span><span class="p">)</span>  <span class="c1"># [B, I]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
            <span class="n">obs_user_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="p">(</span><span class="n">user_items</span><span class="p">)</span>  <span class="c1"># [B, G, D]</span>
            <span class="n">scores_ug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">group_embed</span><span class="p">,</span> <span class="n">obs_user_embeds</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># [B, G]</span>
            <span class="k">return</span> <span class="n">group_logits</span><span class="p">,</span> <span class="n">group_embed</span><span class="p">,</span> <span class="n">scores_ug</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">group_logits</span><span class="p">,</span> <span class="n">group_embed</span>

    <span class="k">def</span> <span class="nf">multinomial_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; multinomial likelihood with softmax over item set &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">items</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">user_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_logits</span><span class="p">,</span> <span class="n">user_items</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">multinomial_loss</span><span class="p">(</span><span class="n">user_logits</span><span class="p">,</span> <span class="n">user_items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">infomax_group_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_logits</span><span class="p">,</span> <span class="n">group_embeds</span><span class="p">,</span> <span class="n">scores_ug</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span><span class="p">,</span>
                           <span class="n">corrupted_user_items</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; loss function with three terms: L_G, L_UG, L_MI</span>
<span class="sd">            :param group_logits: [B, G, I] group item predictions</span>
<span class="sd">            :param group_embeds: [B, D] group embedding</span>
<span class="sd">            :param scores_ug: [B, G] discriminator scores for group members</span>
<span class="sd">            :param group_mask: [B, G] -inf/0 for absent/present user</span>
<span class="sd">            :param group_items: [B, I] item interactions of group</span>
<span class="sd">            :param user_items: [B, G, I] individual item interactions of group members</span>
<span class="sd">            :param corrupted_user_items: [B, N, I] individual item interactions of negative user samples</span>
<span class="sd">            :param device: cpu/gpu</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">group_user_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="p">(</span><span class="n">user_items</span><span class="p">)</span>  <span class="c1"># [B, G, D]</span>
        <span class="n">corrupt_user_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="p">(</span><span class="n">corrupted_user_items</span><span class="p">)</span>  <span class="c1"># [B, N, D]</span>

        <span class="n">scores_observed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">group_embeds</span><span class="p">,</span> <span class="n">group_user_embeds</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">)</span>  <span class="c1"># [B, G]</span>
        <span class="n">scores_corrupted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">group_embeds</span><span class="p">,</span> <span class="n">corrupt_user_embeds</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">)</span>  <span class="c1"># [B, N]</span>

        <span class="n">mi_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="o">.</span><span class="n">mi_loss</span><span class="p">(</span><span class="n">scores_observed</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">scores_corrupted</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="n">ui_sum</span> <span class="o">=</span> <span class="n">user_items</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [B, G]</span>
        <span class="n">user_items_norm</span> <span class="o">=</span> <span class="n">user_items</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ui_sum</span><span class="p">),</span> <span class="n">ui_sum</span><span class="p">)</span>  <span class="c1"># [B, G, I]</span>
        <span class="n">gi_sum</span> <span class="o">=</span> <span class="n">group_items</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">group_items_norm</span> <span class="o">=</span> <span class="n">group_items</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">gi_sum</span><span class="p">),</span> <span class="n">gi_sum</span><span class="p">)</span>  <span class="c1"># [B, I]</span>
        <span class="k">assert</span> <span class="n">scores_ug</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">is</span> <span class="kc">False</span>

        <span class="n">group_mask_zeros</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">group_mask</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># [B, G, 1]</span>
        <span class="n">scores_ug</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">scores_ug</span><span class="p">)</span>  <span class="c1"># [B, G, 1]</span>

        <span class="n">user_items_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">user_items_norm</span> <span class="o">*</span> <span class="n">scores_ug</span> <span class="o">*</span> <span class="n">group_mask_zeros</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">group_mask_zeros</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">user_group_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multinomial_loss</span><span class="p">(</span><span class="n">group_logits</span><span class="p">,</span> <span class="n">user_items_norm</span><span class="p">)</span>
        <span class="n">group_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multinomial_loss</span><span class="p">(</span><span class="n">group_logits</span><span class="p">,</span> <span class="n">group_items_norm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mi_loss</span><span class="p">,</span> <span class="n">user_group_loss</span><span class="p">,</span> <span class="n">group_loss</span>

    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_logits</span><span class="p">,</span> <span class="n">summary_embeds</span><span class="p">,</span> <span class="n">scores_ug</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span><span class="p">,</span> <span class="n">corrupted_user_items</span><span class="p">,</span>
             <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; L_G + lambda L_UG + L_MI &quot;&quot;&quot;</span>
        <span class="n">mi_loss</span><span class="p">,</span> <span class="n">user_group_loss</span><span class="p">,</span> <span class="n">group_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infomax_group_loss</span><span class="p">(</span><span class="n">group_logits</span><span class="p">,</span> <span class="n">summary_embeds</span><span class="p">,</span> <span class="n">scores_ug</span><span class="p">,</span>
                                                                       <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span><span class="p">,</span>
                                                                       <span class="n">corrupted_user_items</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">group_loss</span> <span class="o">+</span> <span class="n">mi_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_mi</span> <span class="o">*</span> <span class="n">user_group_loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Trainers">Trainers<a class="anchor-link" href="#Trainers"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gc</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">ndcg_binary_at_k_batch_torch</span><span class="p">(</span><span class="n">X_pred</span><span class="p">,</span> <span class="n">heldout_batch</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalized Discounted Cumulative Gain@k for for predictions [B, I] and ground-truth [B, I], with binary relevance.</span>
<span class="sd">    ASSUMPTIONS: all the 0&#39;s in heldout_batch indicate 0 relevance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">batch_users</span> <span class="o">=</span> <span class="n">X_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># batch_size</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">idx_topk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">X_pred</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="n">heldout_batch_nonzero</span> <span class="o">=</span> <span class="p">(</span><span class="n">heldout_batch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">DCG</span> <span class="o">=</span> <span class="p">(</span><span class="n">heldout_batch_nonzero</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_users</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">idx_topk</span><span class="p">]</span> <span class="o">*</span> <span class="n">tp</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">heldout_nonzero</span> <span class="o">=</span> <span class="p">(</span><span class="n">heldout_batch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># num. of non-zero items per batch. [B]</span>
    <span class="n">IDCG</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([(</span><span class="n">tp</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">heldout_nonzero</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DCG</span> <span class="o">/</span> <span class="n">IDCG</span>


<span class="k">def</span> <span class="nf">recall_at_k_batch_torch</span><span class="p">(</span><span class="n">X_pred</span><span class="p">,</span> <span class="n">heldout_batch</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recall@k for predictions [B, I] and ground-truth [B, I].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_users</span> <span class="o">=</span> <span class="n">X_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">topk_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">X_pred</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># [B, K]</span>
    <span class="n">X_pred_binary</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X_pred</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">X_pred_binary</span> <span class="o">=</span> <span class="n">X_pred_binary</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="n">X_pred_binary</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_users</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">topk_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">X_true_binary</span> <span class="o">=</span> <span class="p">(</span><span class="n">heldout_batch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># .toarray() #  [B, I]</span>
    <span class="n">k_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">k</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">X_true_binary</span> <span class="o">=</span> <span class="n">X_true_binary</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">k_tensor</span> <span class="o">=</span> <span class="n">k_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_true_binary</span> <span class="o">*</span> <span class="n">X_pred_binary</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">k_tensor</span><span class="p">,</span> <span class="n">X_true_binary</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">recall</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">evaluate_user</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eval_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;pretrain&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; evaluate model on recommending items to users (primarily during pre-training step) &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">eval_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n100_list</span><span class="p">,</span> <span class="n">r20_list</span><span class="p">,</span> <span class="n">r50_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">eval_preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">eval_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eval_loader</span><span class="p">):</span>
            <span class="n">eval_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eval_data</span><span class="p">]</span>
            <span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">fold_in_items</span><span class="p">,</span> <span class="n">held_out_items</span><span class="p">)</span> <span class="o">=</span> <span class="n">eval_data</span>
            <span class="n">fold_in_items</span> <span class="o">=</span> <span class="n">fold_in_items</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pretrain&#39;</span><span class="p">:</span>
                <span class="n">recon_batch</span><span class="p">,</span> <span class="n">emb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="o">.</span><span class="n">pre_train_forward</span><span class="p">(</span><span class="n">fold_in_items</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">recon_batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">group_predictor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="p">(</span><span class="n">fold_in_items</span><span class="p">))</span>

            <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">multinomial_loss</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">held_out_items</span><span class="p">)</span>
            <span class="n">eval_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">fold_in_items</span> <span class="o">=</span> <span class="n">fold_in_items</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">recon_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># softmax over the item set to get normalized scores.</span>
            <span class="n">recon_batch</span><span class="p">[</span><span class="n">fold_in_items</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

            <span class="n">n100</span> <span class="o">=</span> <span class="n">ndcg_binary_at_k_batch_torch</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">held_out_items</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">r20</span> <span class="o">=</span> <span class="n">recall_at_k_batch_torch</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">held_out_items</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">r50</span> <span class="o">=</span> <span class="n">recall_at_k_batch_torch</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">held_out_items</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

            <span class="n">n100_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n100</span><span class="p">)</span>
            <span class="n">r20_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r20</span><span class="p">)</span>
            <span class="n">r50_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r50</span><span class="p">)</span>

            <span class="n">eval_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recon_batch</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="k">del</span> <span class="n">users</span><span class="p">,</span> <span class="n">fold_in_items</span><span class="p">,</span> <span class="n">held_out_items</span><span class="p">,</span> <span class="n">recon_batch</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">num_batches</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span> <span class="o">/</span> <span class="n">eval_loader</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">eval_loss</span> <span class="o">/=</span> <span class="n">num_batches</span>
    <span class="n">n100_list</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">n100_list</span><span class="p">)</span>
    <span class="n">r20_list</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">r20_list</span><span class="p">)</span>
    <span class="n">r50_list</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">r50_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eval_loss</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">n100_list</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r20_list</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r50_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">evaluate_group</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eval_group_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; evaluate model on recommending items to groups &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">eval_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n100_list</span><span class="p">,</span> <span class="n">r20_list</span><span class="p">,</span> <span class="n">r50_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">eval_preds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eval_group_loader</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">recon_batch</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">user_items</span><span class="p">)</span>

            <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">multinomial_loss</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">group_items</span><span class="p">)</span>
            <span class="n">eval_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">recon_batch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># softmax over the item set to get normalized scores.</span>
            <span class="n">heldout_data</span> <span class="o">=</span> <span class="n">group_items</span>

            <span class="n">r20</span> <span class="o">=</span> <span class="n">recall_at_k_batch_torch</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">heldout_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">r50</span> <span class="o">=</span> <span class="n">recall_at_k_batch_torch</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">heldout_data</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">n100</span> <span class="o">=</span> <span class="n">ndcg_binary_at_k_batch_torch</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">heldout_data</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

            <span class="n">n100_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n100</span><span class="p">)</span>
            <span class="n">r20_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r20</span><span class="p">)</span>
            <span class="n">r50_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r50</span><span class="p">)</span>

            <span class="n">eval_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recon_batch</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="k">del</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">n100_list</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">n100_list</span><span class="p">)</span>
    <span class="n">r20_list</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">r20_list</span><span class="p">)</span>
    <span class="n">r50_list</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">r50_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eval_loss</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">n100_list</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r20_list</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r50_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Experiments">Experiments<a class="anchor-link" href="#Experiments"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;nvidia-smi -q -d Memory |grep -A4 GPU|grep Free &gt;tmp&#39;</span><span class="p">)</span>
    <span class="n">memory_available</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
    <span class="n">gpu_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">memory_available</span><span class="p">))</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">gpu_id</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>

    <span class="c1"># Dataset</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;weeplaces&#39;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="s1">&#39;/content/data&#39;</span>

    <span class="c1"># Training settings</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="mf">5e-3</span> <span class="c1"># initial learning rate</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="mf">0.00</span> <span class="c1"># weight decay coefficient</span>
    <span class="n">lambda_mi</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># MI lambda hyper param</span>
    <span class="n">drop_ratio</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1"># Dropout ratio</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span> <span class="c1"># batch size</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># maximum # training epochs</span>
    <span class="n">eval_freq</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># frequency to evaluate performance on validation set</span>

    <span class="c1"># Model settings</span>
    <span class="n">emb_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="c1"># layer size</span>
    <span class="n">aggregator</span> <span class="o">=</span> <span class="s1">&#39;attention&#39;</span> <span class="c1"># choice of group preference aggregator&#39;, choices=[&#39;maxpool&#39;, &#39;meanpool&#39;, &#39;attention&#39;]</span>
    <span class="n">negs_per_group</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># negative users sampled per group</span>

    <span class="c1"># Pre-training settings</span>
    <span class="n">pretrain_user</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Pre-train user encoder on user-item interactions</span>
    <span class="n">pretrain_mi</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Pre-train MI estimator for a few epochs</span>
    <span class="n">pretrain_epochs</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># pre-train epochs for user encoder layer</span>

    <span class="n">cuda</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># use CUDA</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="mi">1111</span> <span class="c1"># random seed for reproducibility</span>

    <span class="c1"># Model save file parameters</span>
    <span class="n">save</span> <span class="o">=</span> <span class="s1">&#39;model_user.pt&#39;</span> <span class="c1"># path to save the final model</span>
    <span class="n">save_group</span> <span class="o">=</span> <span class="s1">&#39;model_group.pt&#39;</span> <span class="c1"># path to save the final model</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>  <span class="c1"># Set the random seed manually for reproducibility.</span>

<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">cuda</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: You have a CUDA device, so you should probably run with --cuda&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="c1"># Load data</span>
<span class="c1">###############################################################################</span>

<span class="n">train_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="s1">&#39;shuffle&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;num_workers&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;pin_memory&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<span class="n">eval_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="s1">&#39;shuffle&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;num_workers&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;pin_memory&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cuda</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="c1"># Define train/val/test datasets on user interactions.</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">WeeplacesDataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">is_group</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>  <span class="c1"># train dataset for user-item interactions.</span>
<span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">n_users</span><span class="p">,</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">n_items</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">WeeplacesDataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">is_group</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">n_items</span><span class="o">=</span><span class="n">n_items</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">WeeplacesDataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">is_group</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">n_items</span><span class="o">=</span><span class="n">n_items</span><span class="p">)</span>

<span class="c1"># Define train/val/test datasets on group and user interactions.</span>
<span class="n">train_group_dataset</span> <span class="o">=</span> <span class="n">WeeplacesDataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">is_group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">negs_per_group</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">negs_per_group</span><span class="p">,</span> <span class="n">n_items</span><span class="o">=</span><span class="n">n_items</span><span class="p">)</span>
<span class="n">padding_idx</span> <span class="o">=</span> <span class="n">train_group_dataset</span><span class="o">.</span><span class="n">padding_idx</span>
<span class="n">val_group_dataset</span> <span class="o">=</span> <span class="n">WeeplacesDataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">is_group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">n_items</span><span class="o">=</span><span class="n">n_items</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="n">padding_idx</span><span class="p">)</span>
<span class="n">test_group_dataset</span> <span class="o">=</span> <span class="n">WeeplacesDataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">is_group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">n_items</span><span class="o">=</span><span class="n">n_items</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="n">padding_idx</span><span class="p">)</span>

<span class="c1"># Define data loaders on user interactions.</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">train_params</span><span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">eval_params</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">eval_params</span><span class="p">)</span>

<span class="c1"># Define data loaders on group interactions.</span>
<span class="n">train_group_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_group_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">train_params</span><span class="p">)</span>
<span class="n">val_group_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_group_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">eval_params</span><span class="p">)</span>
<span class="n">test_group_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_group_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">eval_params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre># train users 6050 # items 25081
# training groups: 15913, # max train group size: 22
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="c1"># Build the model</span>
<span class="c1">###############################################################################</span>

<span class="n">user_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">emb_size</span><span class="p">]</span>  <span class="c1"># user encoder layer configuration is tunable.</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">GroupIM</span><span class="p">(</span><span class="n">n_items</span><span class="p">,</span> <span class="n">user_layers</span><span class="p">,</span> <span class="n">drop_ratio</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">drop_ratio</span><span class="p">,</span> <span class="n">aggregator_type</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">aggregator</span><span class="p">,</span>
                <span class="n">lambda_mi</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lambda_mi</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer_gr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">wd</span><span class="p">)</span>

<span class="n">best_user_n100</span><span class="p">,</span> <span class="n">best_group_n100</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">pretrain_user</span><span class="p">:</span>
    <span class="n">optimizer_ur</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">wd</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pre-training model on user-item interactions&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">pretrain_epochs</span><span class="p">):</span>
        <span class="n">epoch_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">train_user_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
            <span class="n">optimizer_ur</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="p">(</span><span class="n">train_users</span><span class="p">,</span> <span class="n">train_items</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">user_logits</span><span class="p">,</span> <span class="n">user_embeds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="o">.</span><span class="n">pre_train_forward</span><span class="p">(</span><span class="n">train_items</span><span class="p">)</span>
            <span class="n">user_loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">user_loss</span><span class="p">(</span><span class="n">user_logits</span><span class="p">,</span> <span class="n">train_items</span><span class="p">)</span>
            <span class="n">user_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">train_user_loss</span> <span class="o">+=</span> <span class="n">user_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">optimizer_ur</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">train_users</span><span class="p">,</span> <span class="n">train_items</span><span class="p">,</span> <span class="n">user_logits</span><span class="p">,</span> <span class="n">user_embeds</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| epoch </span><span class="si">{:3d}</span><span class="s1"> |  time </span><span class="si">{:4.2f}</span><span class="s1"> | loss </span><span class="si">{:4.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span>
                                                                    <span class="n">train_user_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">val_loss</span><span class="p">,</span> <span class="n">n100</span><span class="p">,</span> <span class="n">r20</span><span class="p">,</span> <span class="n">r50</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate_user</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;pretrain&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">n100</span> <span class="o">&gt;</span> <span class="n">best_user_n100</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">args</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>
                <span class="n">best_user_n100</span> <span class="o">=</span> <span class="n">n100</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load best pre-trained user encoder&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">save</span><span class="p">))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">val_loss</span><span class="p">,</span> <span class="n">n100</span><span class="p">,</span> <span class="n">r20</span><span class="p">,</span> <span class="n">r50</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate_user</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;pretrain&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">89</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| User evaluation | val loss </span><span class="si">{:4.4f}</span><span class="s1"> | n100 </span><span class="si">{:4.4f}</span><span class="s1"> | r20 </span><span class="si">{:4.4f}</span><span class="s1"> | &#39;</span>
            <span class="s1">&#39;r50 </span><span class="si">{:4.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_loss</span><span class="p">,</span> <span class="n">n100</span><span class="p">,</span> <span class="n">r20</span><span class="p">,</span> <span class="n">r50</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing group recommender with pre-train user encoder&quot;</span><span class="p">)</span>
    <span class="c1"># Initialize the group predictor (item embedding) weight based on the pre-trained user predictor.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">group_predictor</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="o">.</span><span class="n">user_predictor</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span>

<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">pretrain_mi</span><span class="p">:</span>
    <span class="c1"># pre-train MI estimator.</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">mi_epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_group_loader</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span><span class="p">,</span> <span class="n">corrupted_user_items</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">optimizer_gr</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">group_embeds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">user_items</span><span class="p">)</span>
            <span class="n">obs_user_embed</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="p">(</span><span class="n">user_items</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># [B, G, D]</span>
            <span class="n">corrupted_user_embed</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">user_preference_encoder</span><span class="p">(</span><span class="n">corrupted_user_items</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># [B, # negs, D]</span>

            <span class="n">scores_observed</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">group_embeds</span><span class="p">,</span> <span class="n">obs_user_embed</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">)</span>  <span class="c1"># [B, G]</span>
            <span class="n">scores_corrupted</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">group_embeds</span><span class="p">,</span> <span class="n">corrupted_user_embed</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">)</span>  <span class="c1"># [B, # negs]</span>

            <span class="n">mi_loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">discriminator</span><span class="o">.</span><span class="n">mi_loss</span><span class="p">(</span><span class="n">scores_observed</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">scores_corrupted</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">mi_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer_gr</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">mi_epoch_loss</span> <span class="o">+=</span> <span class="n">mi_loss</span>
            <span class="k">del</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span><span class="p">,</span> <span class="n">corrupted_user_items</span><span class="p">,</span> \
                <span class="n">obs_user_embed</span><span class="p">,</span> <span class="n">corrupted_user_embed</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MI loss: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mi_epoch_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_group_loader</span><span class="p">)))</span>

<span class="n">optimizer_gr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">wd</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
    <span class="n">epoch_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">train_group_epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_group_loader</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">group</span><span class="p">,</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span><span class="p">,</span> <span class="n">corrupted_user_items</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">optimizer_gr</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">group_logits</span><span class="p">,</span> <span class="n">group_embeds</span><span class="p">,</span> <span class="n">scores_ug</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">user_items</span><span class="p">)</span>
        <span class="n">group_loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">group_logits</span><span class="p">,</span> <span class="n">group_embeds</span><span class="p">,</span> <span class="n">scores_ug</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span><span class="p">,</span>
                                <span class="n">corrupted_user_items</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">group_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">train_group_epoch_loss</span> <span class="o">+=</span> <span class="n">group_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">optimizer_gr</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_users</span><span class="p">,</span> <span class="n">group_mask</span><span class="p">,</span> <span class="n">group_items</span><span class="p">,</span> <span class="n">user_items</span><span class="p">,</span> <span class="n">corrupted_user_items</span><span class="p">,</span> \
            <span class="n">group_logits</span><span class="p">,</span> <span class="n">group_embeds</span><span class="p">,</span> <span class="n">scores_ug</span>

    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train loss: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">train_group_epoch_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_group_loader</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Group evaluation.</span>
        <span class="n">val_loss_group</span><span class="p">,</span> <span class="n">n100_group</span><span class="p">,</span> <span class="n">r20_group</span><span class="p">,</span> <span class="n">r50_group</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate_group</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_group_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">89</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| end of epoch </span><span class="si">{:3d}</span><span class="s1"> | time: </span><span class="si">{:4.2f}</span><span class="s1">s | n100 (group) </span><span class="si">{:5.4f}</span><span class="s1"> | r20 (group) </span><span class="si">{:5.4f}</span><span class="s1"> | r50 (group) &#39;</span>
                <span class="s1">&#39;</span><span class="si">{:5.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">epoch_start_time</span><span class="p">,</span> <span class="n">n100_group</span><span class="p">,</span> <span class="n">r20_group</span><span class="p">,</span> <span class="n">r50_group</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">89</span><span class="p">)</span>

        <span class="c1"># Save the model if the n100 is the best we&#39;ve seen so far.</span>
        <span class="k">if</span> <span class="n">n100_group</span> <span class="o">&gt;</span> <span class="n">best_group_n100</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">save_group</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">best_group_n100</span> <span class="o">=</span> <span class="n">n100_group</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pre-training model on user-item interactions
| epoch   1 |  time 1.81 | loss 551.25
| epoch   2 |  time 1.83 | loss 491.16
| epoch   3 |  time 1.85 | loss 462.52
| epoch   4 |  time 1.82 | loss 446.23
| epoch   5 |  time 1.83 | loss 433.30
| epoch   6 |  time 1.79 | loss 422.86
| epoch   7 |  time 1.80 | loss 413.78
| epoch   8 |  time 1.90 | loss 405.75
| epoch   9 |  time 1.81 | loss 398.45
| epoch  10 |  time 1.83 | loss 391.82
Load best pre-trained user encoder
=========================================================================================
| User evaluation | val loss 218.1074 | n100 0.2767 | r20 0.2295 | r50 0.3257
Initializing group recommender with pre-train user encoder
MI loss: 2.164947267562624
MI loss: 2.0333072722904264
MI loss: 1.993176535954551
MI loss: 1.9732029021732391
MI loss: 1.9563575623527405
MI loss: 1.9452165876116072
MI loss: 1.9399088299463665
MI loss: 1.9283104548378596
MI loss: 1.9230254642547122
MI loss: 1.915149870372954
Train loss: 15.21117102910602
-----------------------------------------------------------------------------------------
| end of epoch   1 | time: 120.55s | n100 (group) 0.2932 | r20 (group) 0.4143 | r50 (group) 0.5469
-----------------------------------------------------------------------------------------
Train loss: 12.936415006243994
Train loss: 12.36263246384878
Train loss: 11.967980248587471
Train loss: 11.641981654696995
Train loss: 11.384485562642416
-----------------------------------------------------------------------------------------
| end of epoch   6 | time: 122.55s | n100 (group) 0.4271 | r20 (group) 0.5974 | r50 (group) 0.7124
-----------------------------------------------------------------------------------------
Train loss: 11.143094183906676
Train loss: 10.976203191848029
Train loss: 10.801382503812276
Train loss: 10.679489877488878
Train loss: 10.587046698918419
-----------------------------------------------------------------------------------------
| end of epoch  11 | time: 115.36s | n100 (group) 0.4728 | r20 (group) 0.6421 | r50 (group) 0.7480
-----------------------------------------------------------------------------------------
Train loss: 10.498487517947243
Train loss: 10.421664782932826
Train loss: 10.346160071236747
Train loss: 10.296602052355569
Train loss: 10.24328315068805
-----------------------------------------------------------------------------------------
| end of epoch  16 | time: 122.33s | n100 (group) 0.4916 | r20 (group) 0.6602 | r50 (group) 0.7651
-----------------------------------------------------------------------------------------
Train loss: 10.204238316369436
Train loss: 10.142736480349587
Train loss: 10.116823786780948
Train loss: 10.0895657766433
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">save_group</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Best validation evaluation</span>
<span class="n">val_loss</span><span class="p">,</span> <span class="n">n100</span><span class="p">,</span> <span class="n">r20</span><span class="p">,</span> <span class="n">r50</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate_user</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">89</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| User evaluation | val loss </span><span class="si">{:4.4f}</span><span class="s1"> | n100 </span><span class="si">{:4.4f}</span><span class="s1"> | r20 </span><span class="si">{:4.4f}</span><span class="s1"> | r50 </span><span class="si">{:4.4f}</span><span class="s1">&#39;</span>
      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_loss</span><span class="p">,</span> <span class="n">n100</span><span class="p">,</span> <span class="n">r20</span><span class="p">,</span> <span class="n">r50</span><span class="p">))</span>

<span class="c1"># Test evaluation</span>
<span class="n">test_loss</span><span class="p">,</span> <span class="n">n100</span><span class="p">,</span> <span class="n">r20</span><span class="p">,</span> <span class="n">r50</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate_user</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">89</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| User evaluation | test loss </span><span class="si">{:4.4f}</span><span class="s1"> | n100 </span><span class="si">{:4.4f}</span><span class="s1"> | r20 </span><span class="si">{:4.4f}</span><span class="s1"> | r50 </span><span class="si">{:4.4f}</span><span class="s1">&#39;</span>
      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_loss</span><span class="p">,</span> <span class="n">n100</span><span class="p">,</span> <span class="n">r20</span><span class="p">,</span> <span class="n">r50</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">89</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">n100_group</span><span class="p">,</span> <span class="n">r20_group</span><span class="p">,</span> <span class="n">r50_group</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate_group</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_group_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| Group evaluation (val) | n100 (group) </span><span class="si">{:4.4f}</span><span class="s1"> | r20 (group) </span><span class="si">{:4.4f}</span><span class="s1"> | r50 (group) </span><span class="si">{:4.4f}</span><span class="s1">&#39;</span>
      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n100_group</span><span class="p">,</span> <span class="n">r20_group</span><span class="p">,</span> <span class="n">r50_group</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">89</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">n100_group</span><span class="p">,</span> <span class="n">r20_group</span><span class="p">,</span> <span class="n">r50_group</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate_group</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_group_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| Group evaluation (test) | n100 (group) </span><span class="si">{:4.4f}</span><span class="s1"> | r20 (group) </span><span class="si">{:4.4f}</span><span class="s1"> | r50 (group) </span><span class="si">{:4.4f}</span><span class="s1">&#39;</span>
      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n100_group</span><span class="p">,</span> <span class="n">r20_group</span><span class="p">,</span> <span class="n">r50_group</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>=========================================================================================
| User evaluation | val loss 253.6573 | n100 0.3344 | r20 0.2670 | r50 0.3349
=========================================================================================
| User evaluation | test loss 235.2826 | n100 0.3255 | r20 0.2735 | r50 0.3307
=========================================================================================
| Group evaluation (val) | n100 (group) 0.4916 | r20 (group) 0.6602 | r50 (group) 0.7651
=========================================================================================
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">qq</span> <span class="n">install</span> <span class="n">tree</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">tree</span> <span class="o">-</span><span class="n">h</span> <span class="o">--</span><span class="n">du</span> <span class="o">-</span><span class="n">C</span> <span class="o">.</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-intense-fg ansi-bold">.</span>
â”œâ”€â”€ [9.1M]  <span class="ansi-blue-intense-fg ansi-bold">data</span>
â”‚Â Â  â””â”€â”€ [9.1M]  <span class="ansi-blue-intense-fg ansi-bold">raw</span>
â”‚Â Â      â”œâ”€â”€ [2.5M]  <span class="ansi-red-intense-fg ansi-bold">data.zip</span>
â”‚Â Â      â”œâ”€â”€ [794K]  group_users.csv
â”‚Â Â      â”œâ”€â”€ [156K]  test_gi.csv
â”‚Â Â      â”œâ”€â”€ [433K]  test_ui_te.csv
â”‚Â Â      â”œâ”€â”€ [635K]  test_ui_tr.csv
â”‚Â Â      â”œâ”€â”€ [498K]  train_gi.csv
â”‚Â Â      â”œâ”€â”€ [3.5M]  train_ui.csv
â”‚Â Â      â”œâ”€â”€ [ 72K]  val_gi.csv
â”‚Â Â      â”œâ”€â”€ [205K]  val_ui_te.csv
â”‚Â Â      â””â”€â”€ [300K]  val_ui_tr.csv
â”œâ”€â”€ [ 12M]  model_group.pt
â”œâ”€â”€ [ 18M]  model_user.pt
â””â”€â”€ [  54]  tmp

  40M used in 2 directories, 13 files
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">reload_ext</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;Sparsh A.&quot;</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">t</span> <span class="o">-</span><span class="n">d</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Author: Sparsh A.

Last updated: 2021-12-29 13:47:25

Compiler    : GCC 7.5.0
OS          : Linux
Release     : 5.4.144+
Machine     : x86_64
Processor   : x86_64
CPU cores   : 2
Architecture: 64bit

recohut : 0.0.8
IPython : 5.5.0
pandas  : 1.1.5
scipy   : 1.4.1
numpy   : 1.19.5
argparse: 1.1
torch   : 1.10.0+cu111

</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>END</strong></p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/2022/01/09/groupim-weeplaces.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
