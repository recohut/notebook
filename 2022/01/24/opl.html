<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Off-Policy Learning in Two-stage Recommender Systems | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Off-Policy Learning in Two-stage Recommender Systems" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/24/opl.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/24/opl.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-24T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Off-Policy Learning in Two-stage Recommender Systems" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-24T00:00:00-06:00","datePublished":"2022-01-24T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Off-Policy Learning in Two-stage Recommender Systems","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/24/opl.html"},"url":"https://nb.recohut.com/2022/01/24/opl.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Off-Policy Learning in Two-stage Recommender Systems</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-24T00:00:00-06:00" itemprop="datePublished">
        Jan 24, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      36 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-24-opl.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-24-opl.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-24-opl.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-24-opl.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-24-opl.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Many real-world recommender systems need to be highly scalable: matching millions of items with billions of users, with milliseconds latency. The scalability requirement has led to widely used two-stage recommender systems, consisting of efficient candidate generation model(s) in the first stage and a more powerful ranking model in the second stage.</p>
<p>Logged user feedback, e.g., user clicks or dwell time, are often used to build both candidate generation and ranking models for recommender systems. While it’s easy to collect large amount of such data, they are inherently biased because the feedback can only be observed on items recommended by the previous systems. Recently, off-policy correction on such biases have attracted increasing interest in the field of recommender system research. However, most existing work either assumed that the recommender system is a single-stage system or only studied how to apply off-policy correction to the candidate generation stage of the system without explicitly considering the interactions between the two stages.</p>
<p>In this work, we propose a two-stage off-policy policy gradient method, and showcase that ignoring the interaction between the two stages leads to a sub-optimal policy in two-stage recommender systems. The proposed method explicitly takes into account the ranking model when training the candidate generation model, which helps improve the performance of the whole system. We conduct experiments on real-world datasets with large item space and demonstrate the effectiveness of our proposed method.</p>
<h2 id="Pseudo-code">Pseudo code<a class="anchor-link" href="#Pseudo-code"> </a></h2><p><img src="https://github.com/recohut/drl-recsys/raw/a8a38a68e3606557f3501c8adc85fc6aa5726bc1/docs/_images/T257798_1.png" alt="" /></p>
<h2 id="Model-structure">Model structure<a class="anchor-link" href="#Model-structure"> </a></h2><p><img src="https://github.com/recohut/drl-recsys/raw/a8a38a68e3606557f3501c8adc85fc6aa5726bc1/docs/_images/T257798_2.png" alt="" /></p>
<p><img src="https://github.com/recohut/drl-recsys/raw/a8a38a68e3606557f3501c8adc85fc6aa5726bc1/docs/_images/T257798_3.png" alt="" /></p>
<h2 id="Training-model">Training model<a class="anchor-link" href="#Training-model"> </a></h2><ol>
<li>The simulation model - divides MovieLens-1M into training set, validation set and test set at 3:1:1.</li>
<li>Behavior strategy model and ranking model - Use 10,000 user-item pairs randomly generated by the simulation model to train the behavior strategy model, and then obtain a bandit data set by sampling the top-5 items of each user predicted by the behavior strategy model. Train the ranking model based on this data set, divide 2000 users as the verification set, and 4000 users as the test set.</li>
<li>Candidate generation model - Set the optimizer to AdaGrad, the initial learning rate is 0.05, and the weight limit parameters of 1-IPS and 2-IPS are set c1 = 10, c2 = 0.01 c_1 = 10, c_2=0.01.
For each training method, we trained 20 candidate generation models initialized with different random seeds. The early stopping method is applied in both one-stage evaluation and two-stage evaluation.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Imports">Imports<a class="anchor-link" href="#Imports"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model">Model<a class="anchor-link" href="#Model"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">NUM_ITEMS</span> <span class="o">=</span> <span class="mi">3883</span>
<span class="n">NUM_YEARS</span> <span class="o">=</span> <span class="mi">81</span>
<span class="n">NUM_GENRES</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">NUM_USERS</span> <span class="o">=</span> <span class="mi">6040</span>
<span class="n">NUM_OCCUPS</span> <span class="o">=</span> <span class="mi">21</span>
<span class="n">NUM_AGES</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">NUM_ZIPS</span> <span class="o">=</span> <span class="mi">3439</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">ItemRep</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Item representation layer.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_emb_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">year_emb_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">genre_hidden</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ItemRep</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">NUM_ITEMS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">item_emb_size</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">NUM_YEARS</span><span class="p">,</span> <span class="n">year_emb_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genre_linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">NUM_GENRES</span><span class="p">,</span> <span class="n">genre_hidden</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rep_dim</span> <span class="o">=</span> <span class="n">item_emb_size</span> <span class="o">+</span> <span class="n">year_emb_size</span> <span class="o">+</span> <span class="n">genre_hidden</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">categorical_feats</span><span class="p">,</span> <span class="n">real_feats</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_embedding</span><span class="p">(</span><span class="n">categorical_feats</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">year_embedding</span><span class="p">(</span><span class="n">categorical_feats</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">genre_linear</span><span class="p">(</span><span class="n">real_feats</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">UserRep</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;User representation layer.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_emb_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">feature_emb_size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UserRep</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">NUM_USERS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">user_emb_size</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gender_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">feature_emb_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">NUM_AGES</span><span class="p">,</span> <span class="n">feature_emb_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occup_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">NUM_OCCUPS</span><span class="p">,</span> <span class="n">feature_emb_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">NUM_ZIPS</span><span class="p">,</span> <span class="n">feature_emb_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rep_dim</span> <span class="o">=</span> <span class="n">user_emb_size</span> <span class="o">+</span> <span class="n">feature_emb_size</span> <span class="o">*</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">categorical_feats</span><span class="p">,</span> <span class="n">real_feats</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">reps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_embedding</span><span class="p">(</span><span class="n">categorical_feats</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gender_embedding</span><span class="p">(</span><span class="n">categorical_feats</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">age_embedding</span><span class="p">(</span><span class="n">categorical_feats</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">occup_embedding</span><span class="p">(</span><span class="n">categorical_feats</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zip_embedding</span><span class="p">(</span><span class="n">categorical_feats</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reps</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">ImpressionSimulator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simulator model that predicts the outcome of impression.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">use_impression_feats</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ImpressionSimulator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_rep</span> <span class="o">=</span> <span class="n">UserRep</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_rep</span> <span class="o">=</span> <span class="n">ItemRep</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_impression_feats</span> <span class="o">=</span> <span class="n">use_impression_feats</span>
        <span class="n">input_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_rep</span><span class="o">.</span><span class="n">rep_dim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_rep</span><span class="o">.</span><span class="n">rep_dim</span>
        <span class="k">if</span> <span class="n">use_impression_feats</span><span class="p">:</span>
            <span class="n">input_dim</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_feats</span><span class="p">,</span> <span class="n">item_feats</span><span class="p">,</span> <span class="n">impression_feats</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_rep</span><span class="p">(</span><span class="o">**</span><span class="n">user_feats</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_rep</span><span class="p">(</span><span class="o">**</span><span class="n">item_feats</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_impression_feats</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">inputs</span><span class="p">,</span> <span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Nominator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two tower nominator model.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Nominator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_rep</span> <span class="o">=</span> <span class="n">ItemRep</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_rep</span> <span class="o">=</span> <span class="n">UserRep</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_rep</span><span class="o">.</span><span class="n">rep_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_rep</span><span class="o">.</span><span class="n">rep_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_feats</span><span class="p">,</span> <span class="n">item_feats</span><span class="p">):</span>
        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_rep</span><span class="p">(</span><span class="o">**</span><span class="n">user_feats</span><span class="p">)))</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># (b, h) -&gt; (b, h, 1)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_rep</span><span class="p">(</span><span class="o">**</span><span class="n">item_feats</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (b, h) -&gt; (b, 1, h)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                     <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (c, h) -&gt; (b, c, h)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">logits</span>

    <span class="k">def</span> <span class="nf">set_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Ranker</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ranker model.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Ranker</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_rep</span> <span class="o">=</span> <span class="n">ItemRep</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_rep</span> <span class="o">=</span> <span class="n">UserRep</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_rep</span><span class="o">.</span><span class="n">rep_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">item_rep</span><span class="o">.</span><span class="n">rep_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_feats</span><span class="p">,</span> <span class="n">item_feats</span><span class="p">,</span> <span class="n">impression_feats</span><span class="p">):</span>
        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_rep</span><span class="p">(</span><span class="o">**</span><span class="n">user_feats</span><span class="p">)</span>
        <span class="n">context_users</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">users</span><span class="p">,</span> <span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">context_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">context_users</span><span class="p">)</span>
        <span class="n">context_users</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">context_users</span><span class="p">,</span>
                                        <span class="mi">2</span><span class="p">)</span>  <span class="c1"># (b, h) -&gt; (b, h, 1)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_rep</span><span class="p">(</span><span class="o">**</span><span class="n">item_feats</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (b, h) -&gt; (b, 1, h)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                <span class="n">users</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (c, h) -&gt; (b, c, h), c=#items</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">context_users</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">logits</span>

    <span class="k">def</span> <span class="nf">set_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Download-data">Download data<a class="anchor-link" href="#Download-data"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">progress</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">files</span><span class="o">.</span><span class="n">grouplens</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">datasets</span><span class="o">/</span><span class="n">movielens</span><span class="o">/</span><span class="n">ml</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">zip</span>
<span class="err">!</span><span class="n">unzip</span> <span class="n">ml</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">zip</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>ml-1m.zip           100%[===================&gt;]   5.64M  32.7MB/s    in 0.2s    
Archive:  ml-1m.zip
   creating: ml-1m/
  inflating: ml-1m/movies.dat        
  inflating: ml-1m/ratings.dat       
  inflating: ml-1m/README            
  inflating: ml-1m/users.dat         
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset">Dataset<a class="anchor-link" href="#Dataset"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create a torch dataset class for ML-1M; convert the label into binary labels (positive if rating &gt; 3).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">MovieLensDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="n">ratings</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_feats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_feats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_feats</span><span class="p">[</span><span class="s2">&quot;categorical_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">users</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_feats</span><span class="p">[</span><span class="s2">&quot;categorical_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
            <span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;user_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">ratings</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;item_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">ratings</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
            <span class="n">ratings</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
            <span class="n">ratings</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;user_ids&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">feats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;impression_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;impression_feats&quot;</span><span class="p">][</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span>
            <span class="s2">&quot;real_feats&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;user_ids&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;item_ids&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;user_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">user_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;item_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">item_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">feats</span><span class="p">,</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;UserID::MovieID::Rating::Timestamp&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
        <span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;ratings.dat&quot;</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Rating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Rating&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;UserID::Gender::Age::Occupation::Zip-code&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;users.dat&quot;</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">users</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;MovieID::Title::Genres&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
        <span class="n">Genres</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Action&quot;</span><span class="p">,</span> <span class="s2">&quot;Adventure&quot;</span><span class="p">,</span> <span class="s2">&quot;Animation&quot;</span><span class="p">,</span> <span class="s2">&quot;Children&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;Comedy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Crime&quot;</span><span class="p">,</span> <span class="s2">&quot;Documentary&quot;</span><span class="p">,</span> <span class="s2">&quot;Drama&quot;</span><span class="p">,</span> <span class="s2">&quot;Fantasy&quot;</span><span class="p">,</span> <span class="s2">&quot;Film-Noir&quot;</span><span class="p">,</span> <span class="s2">&quot;Horror&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Musical&quot;</span><span class="p">,</span> <span class="s2">&quot;Mystery&quot;</span><span class="p">,</span> <span class="s2">&quot;Romance&quot;</span><span class="p">,</span> <span class="s2">&quot;Sci-Fi&quot;</span><span class="p">,</span> <span class="s2">&quot;Thriller&quot;</span><span class="p">,</span> <span class="s2">&quot;War&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Western&quot;</span>
        <span class="p">]</span>
        <span class="n">movies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;movies.dat&quot;</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">Genres</span><span class="p">:</span>
            <span class="n">movies</span><span class="p">[</span><span class="n">genre</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;Genres&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">movies</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Genres</span><span class="p">]</span>
        <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">movie_id_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">movie_id_map</span><span class="p">[</span><span class="n">movies</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;MovieID&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">movie_id_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">movie_id_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_ITEMS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">MovieID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_YEARS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">Year</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_GENRES</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_USERS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">UserID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_OCCUPS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">Occupation</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_AGES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_ZIPS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="s2">&quot;Zip-code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">movies</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">SyntheticMovieLensDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">simulator_path</span><span class="p">,</span> <span class="n">synthetic_data_path</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="mf">0.764506</span><span class="p">,</span>
                 <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ratings</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_feats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_feats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_feats</span><span class="p">[</span><span class="s2">&quot;categorical_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_feats</span><span class="p">[</span><span class="s2">&quot;categorical_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">synthetic_data_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">synthetic_data_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;label_probs&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loaded full_impression_feats.pt&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;generating impression_feats&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="n">ImpressionSimulator</span><span class="p">(</span><span class="n">use_impression_feats</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">simulator_path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="n">impressions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_impressions</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;user_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
                <span class="n">impressions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;item_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
                <span class="n">impressions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                <span class="n">impressions</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;label_probs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_labels</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;label_probs&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cut</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">,</span> <span class="n">synthetic_data_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saved impression_feats&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;user_ids&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">feats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;impression_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;impression_feats&quot;</span><span class="p">][</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span>
            <span class="s2">&quot;real_feats&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;user_ids&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;item_ids&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;user_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">user_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;item_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">item_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">feats</span><span class="p">,</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;UserID::MovieID::Rating::Timestamp&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
        <span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;ratings.dat&quot;</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Rating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Rating&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;UserID::Gender::Age::Occupation::Zip-code&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;users.dat&quot;</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">users</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;MovieID::Title::Genres&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
        <span class="n">Genres</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Action&quot;</span><span class="p">,</span> <span class="s2">&quot;Adventure&quot;</span><span class="p">,</span> <span class="s2">&quot;Animation&quot;</span><span class="p">,</span> <span class="s2">&quot;Children&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;Comedy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Crime&quot;</span><span class="p">,</span> <span class="s2">&quot;Documentary&quot;</span><span class="p">,</span> <span class="s2">&quot;Drama&quot;</span><span class="p">,</span> <span class="s2">&quot;Fantasy&quot;</span><span class="p">,</span> <span class="s2">&quot;Film-Noir&quot;</span><span class="p">,</span> <span class="s2">&quot;Horror&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Musical&quot;</span><span class="p">,</span> <span class="s2">&quot;Mystery&quot;</span><span class="p">,</span> <span class="s2">&quot;Romance&quot;</span><span class="p">,</span> <span class="s2">&quot;Sci-Fi&quot;</span><span class="p">,</span> <span class="s2">&quot;Thriller&quot;</span><span class="p">,</span> <span class="s2">&quot;War&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Western&quot;</span>
        <span class="p">]</span>
        <span class="n">movies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;movies.dat&quot;</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">Genres</span><span class="p">:</span>
            <span class="n">movies</span><span class="p">[</span><span class="n">genre</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;Genres&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">movies</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Genres</span><span class="p">]</span>
        <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">movies</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">movie_id_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">movie_id_map</span><span class="p">[</span><span class="n">movies</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;MovieID&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">movie_id_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">movie_id_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_ITEMS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">MovieID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_YEARS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">Year</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_GENRES</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_USERS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">UserID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_OCCUPS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">Occupation</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_AGES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_ZIPS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="s2">&quot;Zip-code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">movies</span>

    <span class="k">def</span> <span class="nf">get_full_impressions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets NUM_USERS x NUM_ITEMS impression features by iterating the user and item ids.</span>
<span class="sd">        The impression-level feature, i.e. the timestamp, is sampled from a normal distribution with</span>
<span class="sd">        mean and std as the empirical mean and std of each user&#39;s recorded timestamps in the real data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratings</span><span class="p">)):</span>
            <span class="n">u_id</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;UserID&quot;</span><span class="p">]</span>
            <span class="n">timestamps</span><span class="p">[</span><span class="n">u_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">u_id</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">timestamps</span><span class="p">[</span><span class="n">u_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;Timestamp&quot;</span><span class="p">])</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t_samples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_USERS</span><span class="p">):</span>
            <span class="n">u_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">t_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">rs</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">u_id</span><span class="p">]),</span>
                    <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">u_id</span><span class="p">]),</span>
                    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_ITEMS</span><span class="p">,</span> <span class="p">)))</span>
        <span class="n">t_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_samples</span><span class="p">)</span>

        <span class="n">impressions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_USERS</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_ITEMS</span><span class="p">):</span>
                <span class="n">impressions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]])</span>
        <span class="n">impressions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">impressions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">impressions</span>

    <span class="k">def</span> <span class="nf">to_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">transformed_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">transformed_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">transformed_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">transformed_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Type </span><span class="si">{}</span><span class="s2"> not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">transformed_data</span>

    <span class="k">def</span> <span class="nf">generate_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates the binary labels using the simulator on every user-item pair.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span> <span class="o">//</span> <span class="mi">500</span><span class="p">)):</span>
                <span class="n">feats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500</span><span class="p">)))</span>
                <span class="n">feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="p">(</span><span class="o">**</span><span class="n">feats</span><span class="p">))</span>
                <span class="n">preds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]):</span>
                <span class="n">feats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">range</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span>
                              <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]))))</span>
                <span class="n">feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="p">(</span><span class="o">**</span><span class="n">feats</span><span class="p">))</span>
                <span class="n">preds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">preds</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metrics">Metrics<a class="anchor-link" href="#Metrics"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">BaseMetric</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_threshold</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_threshold</span> <span class="o">=</span> <span class="n">rel_threshold</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">PrecisionRecall</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrecisionRecall</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rel_threshold</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">str_precision</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Precision@%1.f&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="n">str_recall</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Recall@%1.f&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_precision</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_recall</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
        <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>
        <span class="n">num_hit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">targets</span><span class="p">)))</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_hit</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_hit</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">MeanAP</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MeanAP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rel_threshold</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="s1">&#39;MeanAP@%1.f&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>

        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">num_hits</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">targets</span> <span class="ow">and</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[:</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">num_hits</span> <span class="o">+=</span> <span class="mf">1.0</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="n">num_hits</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="n">score</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">),</span> <span class="n">k</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">NormalizedDCG</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NormalizedDCG</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rel_threshold</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="s1">&#39;NDCG@%1.f&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">),</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>

        <span class="c1"># compute idcg</span>
        <span class="n">idcg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="n">dcg</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                <span class="n">dcg</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ndcg</span> <span class="o">=</span> <span class="n">dcg</span> <span class="o">/</span> <span class="n">idcg</span>

        <span class="k">return</span> <span class="n">ndcg</span>


<span class="n">all_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrecisionRecall</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),</span> <span class="n">NormalizedDCG</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">])]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Evaluator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluator for both one-stage and two-stage evaluations.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">simulator</span><span class="p">,</span> <span class="n">syn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="n">simulator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syn</span> <span class="o">=</span> <span class="n">syn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_rankings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target_rankings</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">all_metrics</span>

    <span class="k">def</span> <span class="nf">get_target_rankings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">target_rankings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_USERS</span><span class="p">):</span>
                <span class="n">impression_ids</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">NUM_ITEMS</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">NUM_ITEMS</span><span class="p">)</span>
                <span class="n">feats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">[</span><span class="n">impression_ids</span><span class="p">]</span>
                <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;impression_feats&quot;</span><span class="p">][</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;impression_feats&quot;</span><span class="p">][</span><span class="s2">&quot;real_feats&quot;</span><span class="p">],</span>
                    <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">NUM_ITEMS</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="p">(</span><span class="o">**</span><span class="n">feats</span><span class="p">))</span>
                <span class="n">user_target_ranking</span> <span class="o">=</span> <span class="p">(</span><span class="n">outputs</span> <span class="o">&gt;</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">cut</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">target_rankings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_target_ranking</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">target_rankings</span>

    <span class="k">def</span> <span class="nf">one_stage_ranking_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">user_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_list</span><span class="p">):</span>
            <span class="n">user_rated_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">==</span> <span class="n">user</span><span class="p">]</span>
            <span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">user_rated_items</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="c1"># Init evaluation results.</span>
        <span class="n">total_metrics_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="n">total_metrics_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

        <span class="n">total_val_metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">user_list</span><span class="p">),</span> <span class="n">total_metrics_len</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">valid_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_list</span><span class="p">):</span>
            <span class="n">pred_ranking</span> <span class="o">=</span> <span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">target_ranking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_rankings</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_ranking</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">metric_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span>
                    <span class="n">targets</span><span class="o">=</span><span class="n">target_ranking</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="n">pred_ranking</span><span class="p">)</span>
                <span class="n">metric_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">total_val_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">metric_results</span><span class="p">)</span>
            <span class="n">valid_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># Average evaluation results by user.</span>
        <span class="n">total_val_metrics</span> <span class="o">=</span> <span class="n">total_val_metrics</span><span class="p">[</span><span class="n">valid_rows</span><span class="p">]</span>
        <span class="n">avg_val_metrics</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_val_metrics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1"># Summary evaluation results into a dict.</span>
        <span class="n">ind</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">avg_val_metrics</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="n">values</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">ind</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">two_stage_ranking_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">ranker</span><span class="p">,</span> <span class="n">user_list</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">topk_item_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_list</span><span class="p">):</span>
            <span class="n">topk_item_ids</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">==</span> <span class="n">user</span><span class="p">]:</span>
                    <span class="n">topk_item_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">topk_item_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="n">time_feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                    <span class="n">NUM_USERS</span><span class="p">,</span> <span class="n">NUM_ITEMS</span><span class="p">),</span>
                <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Init evaluation results.</span>
        <span class="n">total_metrics_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="n">total_metrics_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

        <span class="n">total_val_metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">user_list</span><span class="p">),</span> <span class="n">total_metrics_len</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">valid_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_list</span><span class="p">):</span>
            <span class="n">user_feats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">user_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">item_feats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">topk_item_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">item_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="n">user_feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">user_feats</span><span class="p">)</span>
            <span class="n">item_feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">item_feats</span><span class="p">)</span>
            <span class="n">impression_feats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;real_feats&quot;</span><span class="p">:</span> <span class="n">time_feats</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)}</span>
            <span class="n">ranker_logits</span> <span class="o">=</span> <span class="n">ranker</span><span class="p">(</span><span class="n">user_feats</span><span class="p">,</span> <span class="n">item_feats</span><span class="p">,</span>
                                   <span class="n">impression_feats</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">ranker_logits</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">pred_ranking</span> <span class="o">=</span> <span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">pred</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">target_ranking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_rankings</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_ranking</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">metric_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span>
                    <span class="n">targets</span><span class="o">=</span><span class="n">target_ranking</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="n">pred_ranking</span><span class="p">)</span>
                <span class="n">metric_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">total_val_metrics</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">metric_results</span><span class="p">)</span>
            <span class="n">valid_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># Average evaluation results by user.</span>
        <span class="n">total_val_metrics</span> <span class="o">=</span> <span class="n">total_val_metrics</span><span class="p">[</span><span class="n">valid_rows</span><span class="p">]</span>
        <span class="n">avg_val_metrics</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_val_metrics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1"># Summary evaluation results into a dict.</span>
        <span class="n">ind</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">avg_val_metrics</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="n">values</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">ind</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">one_stage_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">impression_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_USERS</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">==</span> <span class="n">i</span><span class="p">]:</span>
                    <span class="k">break</span>
            <span class="n">impression_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">NUM_ITEMS</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
        <span class="n">feats</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">[</span><span class="n">impression_ids</span><span class="p">]</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;impression_feats&quot;</span><span class="p">][</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NUM_USERS</span><span class="p">,</span> <span class="n">NUM_ITEMS</span><span class="p">),</span>
            <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="p">(</span><span class="o">**</span><span class="n">feats</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="p">(</span><span class="n">outputs</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">cut</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">two_stage_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">ranker</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">topk_item_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_USERS</span><span class="p">):</span>
            <span class="n">topk_item_ids</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">==</span> <span class="n">i</span><span class="p">]:</span>
                    <span class="n">topk_item_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">topk_item_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="n">time_feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                    <span class="n">NUM_USERS</span><span class="p">,</span> <span class="n">NUM_ITEMS</span><span class="p">),</span>
                <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">recommneded</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_USERS</span><span class="p">):</span>
            <span class="n">user_feats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">user_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">item_feats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">topk_item_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">item_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="n">user_feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">user_feats</span><span class="p">)</span>
            <span class="n">item_feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">item_feats</span><span class="p">)</span>
            <span class="n">impression_feats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;real_feats&quot;</span><span class="p">:</span> <span class="n">time_feats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)}</span>
            <span class="n">ranker_logits</span> <span class="o">=</span> <span class="n">ranker</span><span class="p">(</span><span class="n">user_feats</span><span class="p">,</span> <span class="n">item_feats</span><span class="p">,</span>
                                   <span class="n">impression_feats</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ranker_logits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">recommneded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topk_item_ids</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">pred</span><span class="p">])</span>

        <span class="n">impression_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_USERS</span><span class="p">):</span>
            <span class="n">impression_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">NUM_ITEMS</span> <span class="o">+</span> <span class="n">recommneded</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">feats</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">[</span><span class="n">impression_ids</span><span class="p">]</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;impression_feats&quot;</span><span class="p">][</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NUM_USERS</span><span class="p">,</span> <span class="n">NUM_ITEMS</span><span class="p">),</span>
            <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="p">(</span><span class="o">**</span><span class="n">feats</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="p">(</span><span class="n">outputs</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="o">.</span><span class="n">cut</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Losses">Losses<a class="anchor-link" href="#Losses"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">batch_select</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
        <span class="n">mat</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="n">idx</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">unique_and_padding</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">padding_idx</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Conducts unique operation along dim and pads to the same length.&quot;&quot;&quot;</span>
    <span class="n">samples</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">samples_roll</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">samples_diff</span> <span class="o">=</span> <span class="n">samples</span> <span class="o">-</span> <span class="n">samples_roll</span>
    <span class="n">samples_diff</span><span class="p">[:,</span>
                 <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># deal with the edge case that there is only one unique sample in a row</span>
    <span class="n">samples_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">samples_diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># unique mask</span>
    <span class="n">samples</span> <span class="o">*=</span> <span class="n">samples_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">samples</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">samples_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">samples</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span> <span class="o">*</span> <span class="n">padding_idx</span>
    <span class="n">samples</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
    <span class="c1"># shrink size to max unique length</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samples</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">loss_ce</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">unused_p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unused_ranker_logits</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cross entropy.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">batch_select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">a</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">loss_ips</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span>
             <span class="n">a</span><span class="p">,</span>
             <span class="n">p</span><span class="p">,</span>
             <span class="n">unused_ranker_logits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">upper_limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
             <span class="n">lower_limit</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;IPS loss (one-stage).&quot;&quot;&quot;</span>
    <span class="n">importance_weight</span> <span class="o">=</span> <span class="n">batch_select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span>
    <span class="n">importance_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">importance_weight</span> <span class="o">&gt;</span> <span class="n">lower_limit</span><span class="p">,</span> <span class="n">importance_weight</span><span class="p">,</span>
        <span class="n">lower_limit</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">importance_weight</span><span class="p">))</span>
    <span class="n">importance_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">importance_weight</span> <span class="o">&lt;</span> <span class="n">upper_limit</span><span class="p">,</span> <span class="n">importance_weight</span><span class="p">,</span>
        <span class="n">upper_limit</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">importance_weight</span><span class="p">))</span>
    <span class="n">importance_weight</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">importance_weight</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
        <span class="n">batch_select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">importance_weight</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">loss_2s</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span>
            <span class="n">a</span><span class="p">,</span>
            <span class="n">p</span><span class="p">,</span>
            <span class="n">ranker_logits</span><span class="p">,</span>
            <span class="n">slate_sample_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">slate_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
            <span class="n">upper_limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">lower_limit</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two stage loss.&quot;&quot;&quot;</span>
    <span class="n">num_logits</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rls</span> <span class="o">=</span> <span class="n">ranker_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">log_probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">rls</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">rls</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">rls</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                <span class="n">rls</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">log_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">log_probs</span><span class="p">,</span>
         <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">log_probs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">log_probs</span><span class="o">.</span><span class="n">device</span><span class="p">)],</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">importance_weight</span> <span class="o">=</span> <span class="n">batch_select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span>
    <span class="n">importance_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">importance_weight</span> <span class="o">&gt;</span> <span class="n">lower_limit</span><span class="p">,</span> <span class="n">importance_weight</span><span class="p">,</span>
        <span class="n">lower_limit</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">importance_weight</span><span class="p">))</span>
    <span class="n">importance_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">importance_weight</span> <span class="o">&lt;</span> <span class="n">upper_limit</span><span class="p">,</span> <span class="n">importance_weight</span><span class="p">,</span>
        <span class="n">upper_limit</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">importance_weight</span><span class="p">))</span>
    <span class="n">importance_weight</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">importance_weight</span><span class="p">)</span>

    <span class="n">log_action_res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sampled_slate_res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span>
            <span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">slate_sample_size</span> <span class="o">*</span> <span class="n">slate_size</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                <span class="n">slate_sample_size</span><span class="p">,</span> <span class="n">slate_size</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">samples</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">unique_and_padding</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">num_logits</span><span class="p">)</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span>
            <span class="n">F</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">rls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">F</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">log_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">sampled_slate_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">importance_weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rp</span><span class="p">[</span><span class="n">samples</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">lp</span><span class="p">))</span>
        <span class="n">log_action_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">importance_weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rp</span><span class="p">[</span><span class="n">samples</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">log_action_res</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_select</span><span class="p">(</span><span class="n">log_probs</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
    <span class="n">loss</span> <span class="o">+=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sampled_slate_res</span><span class="p">))</span> <span class="o">*</span> <span class="n">alpha</span>
    <span class="k">return</span> <span class="n">loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Main">Main<a class="anchor-link" href="#Main"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">torchnet</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">cPickle</span> <span class="k">as</span> <span class="n">pickle</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Subset</span>
<span class="kn">from</span> <span class="nn">torchnet.meter</span> <span class="kn">import</span> <span class="n">AUCMeter</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Verbose.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--seed&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Random seed.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--loss_type&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;loss_ce&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--device&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--alpha&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Loss ratio.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--lr&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Learning rate.&quot;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{})</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">filepath</span> <span class="o">=</span> <span class="s2">&quot;./ml-1m&quot;</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">MovieLensDataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">NUM_ITEMS</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">NUM_ITEMS</span>
<span class="n">NUM_YEARS</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">NUM_YEARS</span>
<span class="n">NUM_GENRES</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">NUM_GENRES</span>

<span class="n">NUM_USERS</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">NUM_USERS</span>
<span class="n">NUM_OCCUPS</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">NUM_OCCUPS</span>
<span class="n">NUM_AGES</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">NUM_AGES</span>
<span class="n">NUM_ZIPS</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">NUM_ZIPS</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">simulator_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;simulator.pt&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">simulator_path</span><span class="p">):</span>
    <span class="n">simulator</span> <span class="o">=</span> <span class="n">ImpressionSimulator</span><span class="p">(</span><span class="n">use_impression_feats</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">simulator</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">simulator_path</span><span class="p">))</span>
    <span class="n">simulator</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">simulator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># train a simulator model on the original ML-1M dataset</span>
    <span class="c1"># the simulator will be used to generate synthetic labels later</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">Subset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">//</span> <span class="mi">5</span><span class="p">))),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">Subset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span>
               <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">//</span> <span class="mi">5</span><span class="p">))),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">Subset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">))),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

    <span class="n">simulator</span> <span class="o">=</span> <span class="n">ImpressionSimulator</span><span class="p">(</span><span class="n">use_impression_feats</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span>
        <span class="n">simulator</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()</span>

    <span class="n">simulator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---epoch </span><span class="si">{}</span><span class="s2">---&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
            <span class="n">feats</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">simulator</span><span class="p">(</span><span class="o">**</span><span class="n">feats</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">simulator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                    <span class="n">auc</span> <span class="o">=</span> <span class="n">AUCMeter</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">feats</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
                        <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">simulator</span><span class="p">(</span><span class="o">**</span><span class="n">feats</span><span class="p">))</span>
                        <span class="n">auc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">auc</span><span class="o">.</span><span class="n">value</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">auc</span><span class="o">.</span><span class="n">value</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.735</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">simulator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">simulator</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">simulator</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">simulator_path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>---epoch 0---
499 0.6932387523620361
999 0.7135402368767171
1499 0.7215369956250887
1999 0.7251487885185414
2499 0.7250320801426405
2999 0.7272670074151073
3499 0.7281266442311184
3999 0.7294850286875231
4499 0.7296389614963857
---epoch 1---
499 0.7283547770191316
999 0.7295152100721607
1499 0.7300909216769196
1999 0.7302949709078976
2499 0.7307115513456678
2999 0.7303182560548731
3499 0.729832712732132
3999 0.7313203021611654
4499 0.7318606932964403
---epoch 2---
499 0.7313658487455917
999 0.731270933721071
1499 0.7307394064320014
1999 0.7323340285603053
2499 0.7322074757365146
2999 0.7321213073333425
3499 0.7330514084885155
3999 0.7328071902744475
4499 0.7332603719115534
---epoch 3---
499 0.7324623727995114
999 0.7323136933519381
1499 0.7327187807719571
1999 0.7329365712368654
2499 0.7318917432430467
2999 0.733582752772605
3499 0.7342934273983486
3999 0.7341365564445322
4499 0.7340031962421637
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">synthetic_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;full_impression_feats.pt&quot;</span><span class="p">)</span>
<span class="n">syn</span> <span class="o">=</span> <span class="n">SyntheticMovieLensDataset</span><span class="p">(</span>
    <span class="n">filepath</span><span class="p">,</span> <span class="n">simulator_path</span><span class="p">,</span> <span class="n">synthetic_data_path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">logging_policy_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;logging_policy.pt&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logging_policy_path</span><span class="p">):</span>
    <span class="n">logging_policy</span> <span class="o">=</span> <span class="n">Nominator</span><span class="p">()</span>
    <span class="n">logging_policy</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">logging_policy_path</span><span class="p">))</span>
    <span class="n">logging_policy</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">logging_policy</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># train a logging policy using the synthetic dataset</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syn</span><span class="p">)</span>
    <span class="n">idx_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rs</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idx_list</span><span class="p">)</span>
    <span class="n">train_idx</span> <span class="o">=</span> <span class="n">idx_list</span><span class="p">[:</span><span class="mi">10000</span><span class="p">]</span>
    <span class="n">val_idx</span> <span class="o">=</span> <span class="n">idx_list</span><span class="p">[</span><span class="mi">10000</span><span class="p">:</span><span class="mi">20000</span><span class="p">]</span>
    <span class="n">test_idx</span> <span class="o">=</span> <span class="n">idx_list</span><span class="p">[</span><span class="o">-</span><span class="mi">100000</span><span class="p">:]</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">Subset</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span> <span class="n">train_idx</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">Subset</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span> <span class="n">val_idx</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">Subset</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

    <span class="n">logging_policy</span> <span class="o">=</span> <span class="n">Nominator</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span>
        <span class="n">logging_policy</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()</span>

    <span class="n">logging_policy</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">40</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---epoch </span><span class="si">{}</span><span class="s2">---&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
            <span class="n">feats</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">logging_policy</span><span class="p">(</span><span class="n">feats</span><span class="p">[</span><span class="s2">&quot;user_feats&quot;</span><span class="p">],</span> <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;item_feats&quot;</span><span class="p">])</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">logging_policy</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="n">AUCMeter</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">feats</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
                <span class="n">feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span>
                    <span class="n">logging_policy</span><span class="p">(</span><span class="n">feats</span><span class="p">[</span><span class="s2">&quot;user_feats&quot;</span><span class="p">],</span> <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;item_feats&quot;</span><span class="p">]))</span>
                <span class="n">auc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">auc</span><span class="o">.</span><span class="n">value</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">logging_policy</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">logging_policy</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="n">logging_policy</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">logging_policy</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">logging_policy_path</span><span class="p">)</span>
    <span class="n">logging_policy</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>generating impression_feats
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 46906/46906 [01:04&lt;00:00, 726.33it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>saved impression_feats
---epoch 0---
78 0.7303382306338263
---epoch 1---
78 0.7581630234600971
---epoch 2---
78 0.7758875382286556
---epoch 3---
78 0.7947954816858157
---epoch 4---
78 0.8092959307857327
---epoch 5---
78 0.8209026242576345
---epoch 6---
78 0.8281561300331621
---epoch 7---
78 0.831641647559472
---epoch 8---
78 0.8359850391331326
---epoch 9---
78 0.838561799838773
---epoch 10---
78 0.8401704563395371
---epoch 11---
78 0.8411352317648504
---epoch 12---
78 0.8419039896279034
---epoch 13---
78 0.8420276300116679
---epoch 14---
78 0.8417600912427988
---epoch 15---
78 0.8424424910531916
---epoch 16---
78 0.8427186846489241
---epoch 17---
78 0.8426326119202265
---epoch 18---
78 0.8428287245904745
---epoch 19---
78 0.842670274683281
---epoch 20---
78 0.8428754226123425
---epoch 21---
78 0.8429700550599161
---epoch 22---
78 0.8431265076993719
---epoch 23---
78 0.8433620901844372
---epoch 24---
78 0.8435445073044836
---epoch 25---
78 0.8435860694950261
---epoch 26---
78 0.8435829309314381
---epoch 27---
78 0.843662155885035
---epoch 28---
78 0.8437115169305534
---epoch 29---
78 0.8438241247877666
---epoch 30---
78 0.843904205713251
---epoch 31---
78 0.843980862751185
---epoch 32---
78 0.8440994624116114
---epoch 33---
78 0.8442256707110387
---epoch 34---
78 0.8444167426579487
---epoch 35---
78 0.8444864568127943
---epoch 36---
78 0.8446461431238256
---epoch 37---
78 0.8447101507994208
---epoch 38---
78 0.8447210882179845
---epoch 39---
78 0.8447308843406981
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">generate_bandit_samples</span><span class="p">(</span><span class="n">logging_policy</span><span class="p">,</span> <span class="n">syn</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates partial-labeled bandit samples with the logging policy.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        k: The number of items to be sampled for each user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging_policy</span><span class="o">.</span><span class="n">set_binary</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">feats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;user_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">user_feats</span>
        <span class="n">feats</span><span class="p">[</span><span class="s2">&quot;item_feats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">item_feats</span>
        <span class="n">feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logging_policy</span><span class="p">(</span><span class="o">**</span><span class="n">feats</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sampled_users</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sampled_actions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sampled_probs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sampled_rewards</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
        <span class="n">sampled_users</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">sampled_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">sampled_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">sampled_actions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">sampled_rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syn</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][[</span>
            <span class="n">i</span> <span class="o">*</span> <span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sampled_actions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sampled_users</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">sampled_actions</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sampled_probs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sampled_rewards</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">u</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">generate_bandit_samples</span><span class="p">(</span>
    <span class="n">logging_policy</span><span class="p">,</span> <span class="n">syn</span><span class="p">,</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># u: user, a: item, p: logging policy probability, r: reward/label</span>

<span class="n">simulator</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">ev</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">simulator</span><span class="p">,</span> <span class="n">syn</span><span class="p">)</span>

<span class="n">all_user_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">syn</span><span class="o">.</span><span class="n">user_feats</span><span class="p">)</span>
<span class="n">all_item_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">syn</span><span class="o">.</span><span class="n">item_feats</span><span class="p">)</span>
<span class="n">all_impression_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">({</span>
    <span class="s2">&quot;real_feats&quot;</span><span class="p">:</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
        <span class="n">syn</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NUM_USERS</span><span class="p">,</span> <span class="n">NUM_ITEMS</span><span class="p">),</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">num_val_users</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">val_user_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_val_users</span><span class="p">))</span>
<span class="n">test_user_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_val_users</span><span class="p">,</span> <span class="n">NUM_USERS</span><span class="p">))</span>

<span class="n">test_item_feats</span> <span class="o">=</span> <span class="n">all_item_feats</span>
<span class="n">test_user_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span>
    <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">test_user_list</span><span class="p">]</span>
     <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">all_user_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
<span class="n">test_impression_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">({</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">test_user_list</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">all_impression_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">})</span>

<span class="n">val_item_feats</span> <span class="o">=</span> <span class="n">all_item_feats</span>
<span class="n">val_user_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span>
    <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">val_user_list</span><span class="p">]</span>
     <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">all_user_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
<span class="n">val_impression_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span>
    <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">val_user_list</span><span class="p">]</span>
     <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">all_impression_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

<span class="n">ranker_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;ranker.pt&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ranker_path</span><span class="p">):</span>
    <span class="n">ranker</span> <span class="o">=</span> <span class="n">Ranker</span><span class="p">()</span>
    <span class="n">ranker</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ranker_path</span><span class="p">))</span>
    <span class="n">ranker</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">ranker</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">ranker</span><span class="o">.</span><span class="n">set_binary</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># train the ranker with binary cross-entropy</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">neg_sample_size</span> <span class="o">=</span> <span class="mi">29</span>

    <span class="n">ranker</span> <span class="o">=</span> <span class="n">Ranker</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span><span class="n">ranker</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()</span>

    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ranker</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---epoch </span><span class="si">{}</span><span class="s2">---&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">user_list</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">step</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">:(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">]</span>
            <span class="n">item_list</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">step</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">:(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">]</span>
            <span class="n">user_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">({</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">user_list</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">syn</span><span class="o">.</span><span class="n">user_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">})</span>
            <span class="n">item_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">({</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">item_list</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">syn</span><span class="o">.</span><span class="n">item_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">})</span>
            <span class="n">impression_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">user_id</span> <span class="o">*</span> <span class="n">NUM_ITEMS</span> <span class="o">+</span> <span class="n">item_id</span>
                <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">item_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">user_list</span><span class="p">,</span> <span class="n">item_list</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">impression_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">({</span>
                <span class="s2">&quot;real_feats&quot;</span><span class="p">:</span>
                <span class="n">syn</span><span class="o">.</span><span class="n">impression_feats</span><span class="p">[</span><span class="s2">&quot;real_feats&quot;</span><span class="p">][</span><span class="n">impression_list</span><span class="p">]</span>
            <span class="p">})</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
                <span class="n">r</span><span class="p">[</span><span class="n">step</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">:(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="n">logits</span> <span class="o">=</span> <span class="n">ranker</span><span class="p">(</span><span class="n">user_feats</span><span class="p">,</span> <span class="n">item_feats</span><span class="p">,</span> <span class="n">impression_feats</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">ranker</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">ranker</span><span class="o">.</span><span class="n">set_binary</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">ranker</span><span class="p">(</span><span class="n">all_user_feats</span><span class="p">,</span> <span class="n">all_item_feats</span><span class="p">,</span>
                            <span class="n">all_impression_feats</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">one_stage_eval</span><span class="p">(</span><span class="n">logits</span><span class="p">))</span>

            <span class="c1"># Evaluate ranking metrics on validation users.</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">ranker</span><span class="p">(</span><span class="n">val_user_feats</span><span class="p">,</span> <span class="n">val_item_feats</span><span class="p">,</span>
                            <span class="n">val_impression_feats</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">one_stage_ranking_eval</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">val_user_list</span><span class="p">))</span>

            <span class="n">ranker</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">ranker</span><span class="o">.</span><span class="n">set_binary</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ranker</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">ranker</span><span class="o">.</span><span class="n">set_binary</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ranker</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ranker</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">ranker_path</span><span class="p">)</span>
    <span class="n">ranker</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>---epoch 0---
234 0.49751657247543335
234 OrderedDict([(&#39;Precision@1&#39;, 0.525853157043457), (&#39;Precision@5&#39;, 0.37435382604599), (&#39;Precision@10&#39;, 0.3275078535079956), (&#39;Recall@1&#39;, 0.001950422883965075), (&#39;Recall@5&#39;, 0.006817308254539967), (&#39;Recall@10&#39;, 0.011337128467857838), (&#39;NDCG@5&#39;, 0.40602830052375793), (&#39;NDCG@10&#39;, 0.36229410767555237), (&#39;NDCG@20&#39;, 0.3150430917739868)])
---epoch 1---
234 0.5798013210296631
234 OrderedDict([(&#39;Precision@1&#39;, 0.6003102660179138), (&#39;Precision@5&#39;, 0.4798329174518585), (&#39;Precision@10&#39;, 0.42228519916534424), (&#39;Recall@1&#39;, 0.002812947379425168), (&#39;Recall@5&#39;, 0.011755581945180893), (&#39;Recall@10&#39;, 0.02120870165526867), (&#39;NDCG@5&#39;, 0.5004847645759583), (&#39;NDCG@10&#39;, 0.45322883129119873), (&#39;NDCG@20&#39;, 0.39284855127334595)])
---epoch 2---
234 0.5889073014259338
234 OrderedDict([(&#39;Precision@1&#39;, 0.6106514930725098), (&#39;Precision@5&#39;, 0.5765244960784912), (&#39;Precision@10&#39;, 0.5148389339447021), (&#39;Recall@1&#39;, 0.003235821146517992), (&#39;Recall@5&#39;, 0.016686489805579185), (&#39;Recall@10&#39;, 0.03442412614822388), (&#39;NDCG@5&#39;, 0.5764947533607483), (&#39;NDCG@10&#39;, 0.5345680713653564), (&#39;NDCG@20&#39;, 0.4556241035461426)])
---epoch 3---
234 0.628311276435852
234 OrderedDict([(&#39;Precision@1&#39;, 0.6411582231521606), (&#39;Precision@5&#39;, 0.6560497283935547), (&#39;Precision@10&#39;, 0.6184099912643433), (&#39;Recall@1&#39;, 0.0033987725619226694), (&#39;Recall@5&#39;, 0.0258512943983078), (&#39;Recall@10&#39;, 0.045876603573560715), (&#39;NDCG@5&#39;, 0.6525105237960815), (&#39;NDCG@10&#39;, 0.6282448172569275), (&#39;NDCG@20&#39;, 0.5369541049003601)])
---epoch 4---
234 0.7625827789306641
234 OrderedDict([(&#39;Precision@1&#39;, 0.7487073540687561), (&#39;Precision@5&#39;, 0.750673770904541), (&#39;Precision@10&#39;, 0.6952475309371948), (&#39;Recall@1&#39;, 0.004413578659296036), (&#39;Recall@5&#39;, 0.033956073224544525), (&#39;Recall@10&#39;, 0.05853657424449921), (&#39;NDCG@5&#39;, 0.7535479068756104), (&#39;NDCG@10&#39;, 0.715246319770813), (&#39;NDCG@20&#39;, 0.6256369352340698)])
---epoch 5---
234 0.8622516989707947
234 OrderedDict([(&#39;Precision@1&#39;, 0.8490175604820251), (&#39;Precision@5&#39;, 0.8347484469413757), (&#39;Precision@10&#39;, 0.7592080235481262), (&#39;Recall@1&#39;, 0.009471286088228226), (&#39;Recall@5&#39;, 0.045272961258888245), (&#39;Recall@10&#39;, 0.07097340375185013), (&#39;NDCG@5&#39;, 0.840373158454895), (&#39;NDCG@10&#39;, 0.7897650003433228), (&#39;NDCG@20&#39;, 0.717039942741394)])
---epoch 6---
234 0.9102649092674255
234 OrderedDict([(&#39;Precision@1&#39;, 0.9089968800544739), (&#39;Precision@5&#39;, 0.8815937042236328), (&#39;Precision@10&#39;, 0.8184615969657898), (&#39;Recall@1&#39;, 0.015791630372405052), (&#39;Recall@5&#39;, 0.053664132952690125), (&#39;Recall@10&#39;, 0.07895129173994064), (&#39;NDCG@5&#39;, 0.8917895555496216), (&#39;NDCG@10&#39;, 0.8513309359550476), (&#39;NDCG@20&#39;, 0.7841229438781738)])
---epoch 7---
234 0.9369205236434937
234 OrderedDict([(&#39;Precision@1&#39;, 0.9441571831703186), (&#39;Precision@5&#39;, 0.9020691514015198), (&#39;Precision@10&#39;, 0.8512938618659973), (&#39;Recall@1&#39;, 0.01766125112771988), (&#39;Recall@5&#39;, 0.05773942917585373), (&#39;Recall@10&#39;, 0.08265078067779541), (&#39;NDCG@5&#39;, 0.9147428274154663), (&#39;NDCG@10&#39;, 0.8829164505004883), (&#39;NDCG@20&#39;, 0.8230650424957275)])
---epoch 8---
234 0.9519867897033691
234 OrderedDict([(&#39;Precision@1&#39;, 0.9565666913986206), (&#39;Precision@5&#39;, 0.9139613509178162), (&#39;Precision@10&#39;, 0.8667538166046143), (&#39;Recall@1&#39;, 0.01800968125462532), (&#39;Recall@5&#39;, 0.060318805277347565), (&#39;Recall@10&#39;, 0.08457545191049576), (&#39;NDCG@5&#39;, 0.9267275929450989), (&#39;NDCG@10&#39;, 0.8979306817054749), (&#39;NDCG@20&#39;, 0.844747006893158)])
---epoch 9---
234 0.9541391134262085
234 OrderedDict([(&#39;Precision@1&#39;, 0.9601861238479614), (&#39;Precision@5&#39;, 0.9185118079185486), (&#39;Precision@10&#39;, 0.8744063973426819), (&#39;Recall@1&#39;, 0.018171625211834908), (&#39;Recall@5&#39;, 0.061439476907253265), (&#39;Recall@10&#39;, 0.08633137494325638), (&#39;NDCG@5&#39;, 0.9311888217926025), (&#39;NDCG@10&#39;, 0.9044811129570007), (&#39;NDCG@20&#39;, 0.8586583733558655)])
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">check_metric</span> <span class="o">=</span> <span class="s2">&quot;Precision@10&quot;</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

<span class="n">nominator</span> <span class="o">=</span> <span class="n">Nominator</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">nominator</span><span class="o">.</span><span class="n">set_binary</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span>
    <span class="n">nominator</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">nominator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Nominator(
  (item_rep): ItemRep(
    (item_embedding): Embedding(3884, 10, padding_idx=0)
    (year_embedding): Embedding(81, 5)
    (genre_linear): Linear(in_features=18, out_features=5, bias=True)
  )
  (user_rep): UserRep(
    (user_embedding): Embedding(6041, 10, padding_idx=0)
    (gender_embedding): Embedding(2, 5)
    (age_embedding): Embedding(7, 5)
    (occup_embedding): Embedding(21, 5)
    (zip_embedding): Embedding(3439, 5)
  )
  (linear): Linear(in_features=30, out_features=20, bias=True)
)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">best_result</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">val_results</span><span class="p">,</span> <span class="n">test_results</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;loss_2s&quot;</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">ranker</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">ranker</span><span class="o">.</span><span class="n">set_binary</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ranker_logits</span> <span class="o">=</span> <span class="n">ranker</span><span class="p">(</span><span class="n">all_user_feats</span><span class="p">,</span> <span class="n">all_item_feats</span><span class="p">,</span>
                               <span class="n">all_impression_feats</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---epoch </span><span class="si">{}</span><span class="s2">---&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">item_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">a</span><span class="p">[</span><span class="n">step</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">:(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">item_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="n">step</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">:(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">user_ids</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">step</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">:(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">]</span>
        <span class="n">user_feats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">user_ids</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">syn</span><span class="o">.</span><span class="n">user_feats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">user_feats</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">user_feats</span><span class="p">)</span>

        <span class="n">logits</span> <span class="o">=</span> <span class="n">nominator</span><span class="p">(</span><span class="n">user_feats</span><span class="p">,</span> <span class="n">val_item_feats</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;loss_ce&quot;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_ce</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">item_ids</span><span class="p">,</span> <span class="n">item_probs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;loss_ips&quot;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_ips</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">item_ids</span><span class="p">,</span> <span class="n">item_probs</span><span class="p">,</span> <span class="n">upper_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;loss_2s&quot;</span><span class="p">:</span>
            <span class="n">batch_ranker_logits</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">ranker_logits</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_2s</span><span class="p">(</span>
                <span class="n">logits</span><span class="p">,</span>
                <span class="n">item_ids</span><span class="p">,</span>
                <span class="n">item_probs</span><span class="p">,</span>
                <span class="n">batch_ranker_logits</span><span class="p">,</span>
                <span class="n">upper_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">loss_type</span><span class="p">))</span>

        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">nominator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="n">logits</span> <span class="o">=</span> <span class="n">nominator</span><span class="p">(</span><span class="n">all_user_feats</span><span class="p">,</span> <span class="n">all_item_feats</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1 stage&quot;</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">one_stage_eval</span><span class="p">(</span><span class="n">logits</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2 stage&quot;</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">two_stage_eval</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">ranker</span><span class="p">))</span>

        <span class="c1"># Evaluate ranking metrics on validation users.</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">nominator</span><span class="p">(</span><span class="n">val_user_feats</span><span class="p">,</span> <span class="n">val_item_feats</span><span class="p">)</span>
        <span class="n">one_stage_results</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">one_stage_ranking_eval</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">val_user_list</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1 stage (val)&quot;</span><span class="p">,</span> <span class="n">one_stage_results</span><span class="p">)</span>
        <span class="n">two_stage_results</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">two_stage_ranking_eval</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">ranker</span><span class="p">,</span>
                                                      <span class="n">val_user_list</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2 stage (val)&quot;</span><span class="p">,</span> <span class="n">two_stage_results</span><span class="p">)</span>
        <span class="n">val_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">one_stage_results</span><span class="p">,</span> <span class="n">two_stage_results</span><span class="p">))</span>
        <span class="c1"># Log best epoch</span>
        <span class="k">if</span> <span class="n">two_stage_results</span><span class="p">[</span><span class="n">check_metric</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">epoch</span>
            <span class="n">best_result</span> <span class="o">=</span> <span class="n">two_stage_results</span><span class="p">[</span><span class="n">check_metric</span><span class="p">]</span>
        <span class="c1"># Evaluate ranking metrics on test users.</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">nominator</span><span class="p">(</span><span class="n">test_user_feats</span><span class="p">,</span> <span class="n">test_item_feats</span><span class="p">)</span>
        <span class="n">one_stage_results</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">one_stage_ranking_eval</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">test_user_list</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1 stage (test)&quot;</span><span class="p">,</span> <span class="n">one_stage_results</span><span class="p">)</span>
        <span class="n">two_stage_results</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">two_stage_ranking_eval</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">ranker</span><span class="p">,</span>
                                                      <span class="n">test_user_list</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2 stage (test)&quot;</span><span class="p">,</span> <span class="n">two_stage_results</span><span class="p">)</span>
        <span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">one_stage_results</span><span class="p">,</span> <span class="n">two_stage_results</span><span class="p">))</span>

        <span class="n">nominator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>---epoch 0---
1 stage 0.8389073014259338
2 stage 0.931456983089447
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7761116623878479), (&#39;Precision@5&#39;, 0.7825230956077576), (&#39;Precision@10&#39;, 0.7693895101547241), (&#39;Recall@1&#39;, 0.0026108406018465757), (&#39;Recall@5&#39;, 0.01443537138402462), (&#39;Recall@10&#39;, 0.02800210937857628), (&#39;NDCG@5&#39;, 0.7805129289627075), (&#39;NDCG@10&#39;, 0.7720701694488525), (&#39;NDCG@20&#39;, 0.7773204445838928)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9152016639709473), (&#39;Precision@5&#39;, 0.8799382448196411), (&#39;Precision@10&#39;, 0.8639603853225708), (&#39;Recall@1&#39;, 0.010427681729197502), (&#39;Recall@5&#39;, 0.02969161979854107), (&#39;Recall@10&#39;, 0.04909321665763855), (&#39;NDCG@5&#39;, 0.8888923525810242), (&#39;NDCG@10&#39;, 0.8768721222877502), (&#39;NDCG@20&#39;, 0.8476952910423279)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.894406795501709), (&#39;Precision@5&#39;, 0.8917496204376221), (&#39;Precision@10&#39;, 0.8819892406463623), (&#39;Recall@1&#39;, 0.003005631733685732), (&#39;Recall@5&#39;, 0.015431685373187065), (&#39;Recall@10&#39;, 0.030124178156256676), (&#39;NDCG@5&#39;, 0.8914320468902588), (&#39;NDCG@10&#39;, 0.8846309781074524), (&#39;NDCG@20&#39;, 0.8876312971115112)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9671432375907898), (&#39;Precision@5&#39;, 0.9465765357017517), (&#39;Precision@10&#39;, 0.9378731846809387), (&#39;Recall@1&#39;, 0.006223659496754408), (&#39;Recall@5&#39;, 0.022564038634300232), (&#39;Recall@10&#39;, 0.0406784787774086), (&#39;NDCG@5&#39;, 0.9511790871620178), (&#39;NDCG@10&#39;, 0.9443507790565491), (&#39;NDCG@20&#39;, 0.9283153414726257)])
---epoch 1---
1 stage 0.8367549777030945
2 stage 0.9365894198417664
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7730093002319336), (&#39;Precision@5&#39;, 0.780661404132843), (&#39;Precision@10&#39;, 0.7693895101547241), (&#39;Recall@1&#39;, 0.002592692384496331), (&#39;Recall@5&#39;, 0.01431603729724884), (&#39;Recall@10&#39;, 0.027908695861697197), (&#39;NDCG@5&#39;, 0.7788269519805908), (&#39;NDCG@10&#39;, 0.7716042399406433), (&#39;NDCG@20&#39;, 0.7761374115943909)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9255428910255432), (&#39;Precision@5&#39;, 0.883350670337677), (&#39;Precision@10&#39;, 0.8641155958175659), (&#39;Recall@1&#39;, 0.012946750037372112), (&#39;Recall@5&#39;, 0.03286115825176239), (&#39;Recall@10&#39;, 0.052004944533109665), (&#39;NDCG@5&#39;, 0.894393801689148), (&#39;NDCG@10&#39;, 0.8804171681404114), (&#39;NDCG@20&#39;, 0.851220965385437)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8926511406898499), (&#39;Precision@5&#39;, 0.889492392539978), (&#39;Precision@10&#39;, 0.8817635774612427), (&#39;Recall@1&#39;, 0.002984470222145319), (&#39;Recall@5&#39;, 0.01524937804788351), (&#39;Recall@10&#39;, 0.030079031363129616), (&#39;NDCG@5&#39;, 0.8897153735160828), (&#39;NDCG@10&#39;, 0.8841732740402222), (&#39;NDCG@20&#39;, 0.8868218660354614)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9699021577835083), (&#39;Precision@5&#39;, 0.9467771649360657), (&#39;Precision@10&#39;, 0.9376724362373352), (&#39;Recall@1&#39;, 0.007032747846096754), (&#39;Recall@5&#39;, 0.023379521444439888), (&#39;Recall@10&#39;, 0.04146404191851616), (&#39;NDCG@5&#39;, 0.9522501826286316), (&#39;NDCG@10&#39;, 0.9452073574066162), (&#39;NDCG@20&#39;, 0.9290862083435059)])
---epoch 2---
1 stage 0.8357616066932678
2 stage 0.9385761618614197
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.771458089351654), (&#39;Precision@5&#39;, 0.7803509831428528), (&#39;Precision@10&#39;, 0.7697516083717346), (&#39;Recall@1&#39;, 0.002546904841437936), (&#39;Recall@5&#39;, 0.014310559257864952), (&#39;Recall@10&#39;, 0.027927899733185768), (&#39;NDCG@5&#39;, 0.7782995104789734), (&#39;NDCG@10&#39;, 0.7716609239578247), (&#39;NDCG@20&#39;, 0.7768319845199585)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9281282424926758), (&#39;Precision@5&#39;, 0.8846949934959412), (&#39;Precision@10&#39;, 0.8650981783866882), (&#39;Recall@1&#39;, 0.013078119605779648), (&#39;Recall@5&#39;, 0.03309616446495056), (&#39;Recall@10&#39;, 0.05231418088078499), (&#39;NDCG@5&#39;, 0.895997166633606), (&#39;NDCG@10&#39;, 0.8816695213317871), (&#39;NDCG@20&#39;, 0.8517394661903381)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8918986916542053), (&#39;Precision@5&#39;, 0.8886397480964661), (&#39;Precision@10&#39;, 0.8822652101516724), (&#39;Recall@1&#39;, 0.002973585156723857), (&#39;Recall@5&#39;, 0.015205418691039085), (&#39;Recall@10&#39;, 0.030113695189356804), (&#39;NDCG@5&#39;, 0.8889814615249634), (&#39;NDCG@10&#39;, 0.8843721747398376), (&#39;NDCG@20&#39;, 0.886855959892273)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9716578722000122), (&#39;Precision@5&#39;, 0.9481315016746521), (&#39;Precision@10&#39;, 0.9381741285324097), (&#39;Recall@1&#39;, 0.007616504095494747), (&#39;Recall@5&#39;, 0.024297403171658516), (&#39;Recall@10&#39;, 0.0423288531601429), (&#39;NDCG@5&#39;, 0.9539521932601929), (&#39;NDCG@10&#39;, 0.9464597702026367), (&#39;NDCG@20&#39;, 0.9301363229751587)])
---epoch 3---
1 stage 0.8339403867721558
2 stage 0.940562903881073
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7683557271957397), (&#39;Precision@5&#39;, 0.7795237898826599), (&#39;Precision@10&#39;, 0.7704238891601562), (&#39;Recall@1&#39;, 0.0025028539821505547), (&#39;Recall@5&#39;, 0.014192001894116402), (&#39;Recall@10&#39;, 0.028007399290800095), (&#39;NDCG@5&#39;, 0.7769649624824524), (&#39;NDCG@10&#39;, 0.7715820074081421), (&#39;NDCG@20&#39;, 0.7766546607017517)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9332988858222961), (&#39;Precision@5&#39;, 0.8861426711082458), (&#39;Precision@10&#39;, 0.8660286664962769), (&#39;Recall@1&#39;, 0.01370152272284031), (&#39;Recall@5&#39;, 0.034078482538461685), (&#39;Recall@10&#39;, 0.05330389738082886), (&#39;NDCG@5&#39;, 0.8979603052139282), (&#39;NDCG@10&#39;, 0.88340163230896), (&#39;NDCG@20&#39;, 0.8530087471008301)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8906446099281311), (&#39;Precision@5&#39;, 0.8880879282951355), (&#39;Precision@10&#39;, 0.8825662732124329), (&#39;Recall@1&#39;, 0.002958007389679551), (&#39;Recall@5&#39;, 0.015176204033195972), (&#39;Recall@10&#39;, 0.030142122879624367), (&#39;NDCG@5&#39;, 0.8884179592132568), (&#39;NDCG@10&#39;, 0.884431004524231), (&#39;NDCG@20&#39;, 0.8868438005447388)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9721595048904419), (&#39;Precision@5&#39;, 0.9488838315010071), (&#39;Precision@10&#39;, 0.938500165939331), (&#39;Recall@1&#39;, 0.00781310349702835), (&#39;Recall@5&#39;, 0.02463247813284397), (&#39;Recall@10&#39;, 0.04265395551919937), (&#39;NDCG@5&#39;, 0.9547868967056274), (&#39;NDCG@10&#39;, 0.9471161961555481), (&#39;NDCG@20&#39;, 0.9306148290634155)])
---epoch 4---
1 stage 0.8331125974655151
2 stage 0.9425497055053711
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7652533650398254), (&#39;Precision@5&#39;, 0.7786965370178223), (&#39;Precision@10&#39;, 0.7709408402442932), (&#39;Recall@1&#39;, 0.0024512740783393383), (&#39;Recall@5&#39;, 0.014100495725870132), (&#39;Recall@10&#39;, 0.028065374121069908), (&#39;NDCG@5&#39;, 0.7758020758628845), (&#39;NDCG@10&#39;, 0.7715065479278564), (&#39;NDCG@20&#39;, 0.7763851284980774)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9358841776847839), (&#39;Precision@5&#39;, 0.8872801661491394), (&#39;Precision@10&#39;, 0.8661839962005615), (&#39;Recall@1&#39;, 0.013996284455060959), (&#39;Recall@5&#39;, 0.03461095318198204), (&#39;Recall@10&#39;, 0.05393322929739952), (&#39;NDCG@5&#39;, 0.8994066715240479), (&#39;NDCG@10&#39;, 0.8842594623565674), (&#39;NDCG@20&#39;, 0.8535211086273193)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.890895426273346), (&#39;Precision@5&#39;, 0.8875863552093506), (&#39;Precision@10&#39;, 0.8828924298286438), (&#39;Recall@1&#39;, 0.002969894791021943), (&#39;Recall@5&#39;, 0.015152904205024242), (&#39;Recall@10&#39;, 0.03018353506922722), (&#39;NDCG@5&#39;, 0.887993335723877), (&#39;NDCG@10&#39;, 0.8845545053482056), (&#39;NDCG@20&#39;, 0.886780858039856)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9739152193069458), (&#39;Precision@5&#39;, 0.9496864676475525), (&#39;Precision@10&#39;, 0.9387760162353516), (&#39;Recall@1&#39;, 0.007960631512105465), (&#39;Recall@5&#39;, 0.024898577481508255), (&#39;Recall@10&#39;, 0.04285132512450218), (&#39;NDCG@5&#39;, 0.9557564854621887), (&#39;NDCG@10&#39;, 0.9477135539054871), (&#39;NDCG@20&#39;, 0.9310080409049988)])
---epoch 5---
1 stage 0.8336092829704285
2 stage 0.942218542098999
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.765770435333252), (&#39;Precision@5&#39;, 0.7783864140510559), (&#39;Precision@10&#39;, 0.7712510228157043), (&#39;Recall@1&#39;, 0.0024701899383217096), (&#39;Recall@5&#39;, 0.014151088893413544), (&#39;Recall@10&#39;, 0.02811473049223423), (&#39;NDCG@5&#39;, 0.7756521701812744), (&#39;NDCG@10&#39;, 0.7717127799987793), (&#39;NDCG@20&#39;, 0.7761114239692688)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9364012479782104), (&#39;Precision@5&#39;, 0.888003945350647), (&#39;Precision@10&#39;, 0.8662872314453125), (&#39;Recall@1&#39;, 0.013898404315114021), (&#39;Recall@5&#39;, 0.03511940315365791), (&#39;Recall@10&#39;, 0.05434870347380638), (&#39;NDCG@5&#39;, 0.8998069763183594), (&#39;NDCG@10&#39;, 0.8843777179718018), (&#39;NDCG@20&#39;, 0.8532311916351318)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8913970589637756), (&#39;Precision@5&#39;, 0.887134850025177), (&#39;Precision@10&#39;, 0.8827671408653259), (&#39;Recall@1&#39;, 0.0029800296761095524), (&#39;Recall@5&#39;, 0.015131834894418716), (&#39;Recall@10&#39;, 0.03018496185541153), (&#39;NDCG@5&#39;, 0.8876475095748901), (&#39;NDCG@10&#39;, 0.8844181895256042), (&#39;NDCG@20&#39;, 0.8867219686508179)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9731627702713013), (&#39;Precision@5&#39;, 0.9494857788085938), (&#39;Precision@10&#39;, 0.9387760162353516), (&#39;Recall@1&#39;, 0.007924147881567478), (&#39;Recall@5&#39;, 0.024823080748319626), (&#39;Recall@10&#39;, 0.042789481580257416), (&#39;NDCG@5&#39;, 0.9554441571235657), (&#39;NDCG@10&#39;, 0.9475792646408081), (&#39;NDCG@20&#39;, 0.9307677149772644)])
---epoch 6---
1 stage 0.8346026539802551
2 stage 0.9417218565940857
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7652533650398254), (&#39;Precision@5&#39;, 0.7777659296989441), (&#39;Precision@10&#39;, 0.7713546752929688), (&#39;Recall@1&#39;, 0.002462433883920312), (&#39;Recall@5&#39;, 0.014112057164311409), (&#39;Recall@10&#39;, 0.02813573367893696), (&#39;NDCG@5&#39;, 0.7751555442810059), (&#39;NDCG@10&#39;, 0.7717844247817993), (&#39;NDCG@20&#39;, 0.7759582996368408)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9353671073913574), (&#39;Precision@5&#39;, 0.8887278437614441), (&#39;Precision@10&#39;, 0.866390585899353), (&#39;Recall@1&#39;, 0.013995282351970673), (&#39;Recall@5&#39;, 0.035590916872024536), (&#39;Recall@10&#39;, 0.05474210903048515), (&#39;NDCG@5&#39;, 0.9002852439880371), (&#39;NDCG@10&#39;, 0.8846437931060791), (&#39;NDCG@20&#39;, 0.8533338904380798)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8931527733802795), (&#39;Precision@5&#39;, 0.8867837190628052), (&#39;Precision@10&#39;, 0.8830179572105408), (&#39;Recall@1&#39;, 0.0030013115610927343), (&#39;Recall@5&#39;, 0.01514824852347374), (&#39;Recall@10&#39;, 0.03022931143641472), (&#39;NDCG@5&#39;, 0.8876431584358215), (&#39;NDCG@10&#39;, 0.8846896886825562), (&#39;NDCG@20&#39;, 0.886621356010437)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9729119539260864), (&#39;Precision@5&#39;, 0.9496863484382629), (&#39;Precision@10&#39;, 0.9388262033462524), (&#39;Recall@1&#39;, 0.007614111993461847), (&#39;Recall@5&#39;, 0.024715635925531387), (&#39;Recall@10&#39;, 0.04267028719186783), (&#39;NDCG@5&#39;, 0.9553412199020386), (&#39;NDCG@10&#39;, 0.9473593235015869), (&#39;NDCG@20&#39;, 0.9304744601249695)])
---epoch 7---
1 stage 0.8350993394851685
2 stage 0.9408940672874451
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7652533650398254), (&#39;Precision@5&#39;, 0.7769388556480408), (&#39;Precision@10&#39;, 0.771303117275238), (&#39;Recall@1&#39;, 0.002458712086081505), (&#39;Recall@5&#39;, 0.014063295908272266), (&#39;Recall@10&#39;, 0.028185289353132248), (&#39;NDCG@5&#39;, 0.7745227813720703), (&#39;NDCG@10&#39;, 0.7716432809829712), (&#39;NDCG@20&#39;, 0.7753005027770996)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9322647452354431), (&#39;Precision@5&#39;, 0.8887277841567993), (&#39;Precision@10&#39;, 0.865925133228302), (&#39;Recall@1&#39;, 0.013905792497098446), (&#39;Recall@5&#39;, 0.035767413675785065), (&#39;Recall@10&#39;, 0.05483044683933258), (&#39;NDCG@5&#39;, 0.8999837636947632), (&#39;NDCG@10&#39;, 0.8842496871948242), (&#39;NDCG@20&#39;, 0.8529420495033264)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8939051628112793), (&#39;Precision@5&#39;, 0.8863823413848877), (&#39;Precision@10&#39;, 0.8830680847167969), (&#39;Recall@1&#39;, 0.003021263051778078), (&#39;Recall@5&#39;, 0.015123428776860237), (&#39;Recall@10&#39;, 0.03023369051516056), (&#39;NDCG@5&#39;, 0.887448787689209), (&#39;NDCG@10&#39;, 0.8847446441650391), (&#39;NDCG@20&#39;, 0.886391818523407)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9731627702713013), (&#39;Precision@5&#39;, 0.9496863484382629), (&#39;Precision@10&#39;, 0.9387257099151611), (&#39;Recall@1&#39;, 0.00767667219042778), (&#39;Recall@5&#39;, 0.024805083870887756), (&#39;Recall@10&#39;, 0.04274982586503029), (&#39;NDCG@5&#39;, 0.9554198384284973), (&#39;NDCG@10&#39;, 0.9473903179168701), (&#39;NDCG@20&#39;, 0.9302816390991211)])
---epoch 8---
1 stage 0.8354305028915405
2 stage 0.9399006962776184
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.765770435333252), (&#39;Precision@5&#39;, 0.7759048342704773), (&#39;Precision@10&#39;, 0.771199643611908), (&#39;Recall@1&#39;, 0.0024883777368813753), (&#39;Recall@5&#39;, 0.013925631530582905), (&#39;Recall@10&#39;, 0.028112078085541725), (&#39;NDCG@5&#39;, 0.7737619876861572), (&#39;NDCG@10&#39;, 0.7714693546295166), (&#39;NDCG@20&#39;, 0.7745940685272217)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9307135343551636), (&#39;Precision@5&#39;, 0.8879006505012512), (&#39;Precision@10&#39;, 0.8653048872947693), (&#39;Recall@1&#39;, 0.013744794763624668), (&#39;Recall@5&#39;, 0.03534204140305519), (&#39;Recall@10&#39;, 0.05429835617542267), (&#39;NDCG@5&#39;, 0.8989336490631104), (&#39;NDCG@10&#39;, 0.8833516836166382), (&#39;NDCG@20&#39;, 0.8518505096435547)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8941559791564941), (&#39;Precision@5&#39;, 0.8859308362007141), (&#39;Precision@10&#39;, 0.8831183314323425), (&#39;Recall@1&#39;, 0.0030219820328056812), (&#39;Recall@5&#39;, 0.015090204775333405), (&#39;Recall@10&#39;, 0.030239716172218323), (&#39;NDCG@5&#39;, 0.8871259689331055), (&#39;NDCG@10&#39;, 0.8847541809082031), (&#39;NDCG@20&#39;, 0.8861094117164612)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9724103212356567), (&#39;Precision@5&#39;, 0.9492348432540894), (&#39;Precision@10&#39;, 0.9386504292488098), (&#39;Recall@1&#39;, 0.007493751123547554), (&#39;Recall@5&#39;, 0.02462335117161274), (&#39;Recall@10&#39;, 0.04261213541030884), (&#39;NDCG@5&#39;, 0.9548900723457336), (&#39;NDCG@10&#39;, 0.9471115469932556), (&#39;NDCG@20&#39;, 0.9297663569450378)])
---epoch 9---
1 stage 0.8354305028915405
2 stage 0.9394040107727051
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7673215866088867), (&#39;Precision@5&#39;, 0.7746638655662537), (&#39;Precision@10&#39;, 0.7714064717292786), (&#39;Recall@1&#39;, 0.002514956519007683), (&#39;Recall@5&#39;, 0.013873514719307423), (&#39;Recall@10&#39;, 0.028209399431943893), (&#39;NDCG@5&#39;, 0.7729977965354919), (&#39;NDCG@10&#39;, 0.7715849876403809), (&#39;NDCG@20&#39;, 0.7738854885101318)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9312306046485901), (&#39;Precision@5&#39;, 0.8884176015853882), (&#39;Precision@10&#39;, 0.8655635714530945), (&#39;Recall@1&#39;, 0.01376135554164648), (&#39;Recall@5&#39;, 0.03537794202566147), (&#39;Recall@10&#39;, 0.0541960671544075), (&#39;NDCG@5&#39;, 0.8995826244354248), (&#39;NDCG@10&#39;, 0.8838357329368591), (&#39;NDCG@20&#39;, 0.8522109389305115)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8934035897254944), (&#39;Precision@5&#39;, 0.8860311508178711), (&#39;Precision@10&#39;, 0.8833188414573669), (&#39;Recall@1&#39;, 0.003013131907209754), (&#39;Recall@5&#39;, 0.015086286701261997), (&#39;Recall@10&#39;, 0.030243460088968277), (&#39;NDCG@5&#39;, 0.8870205283164978), (&#39;NDCG@10&#39;, 0.884793758392334), (&#39;NDCG@20&#39;, 0.8854647278785706)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9714070558547974), (&#39;Precision@5&#39;, 0.9491847157478333), (&#39;Precision@10&#39;, 0.9384247064590454), (&#39;Recall@1&#39;, 0.00736744562163949), (&#39;Recall@5&#39;, 0.024592455476522446), (&#39;Recall@10&#39;, 0.04252685606479645), (&#39;NDCG@5&#39;, 0.9546566605567932), (&#39;NDCG@10&#39;, 0.9468095302581787), (&#39;NDCG@20&#39;, 0.9292915463447571)])
---epoch 10---
1 stage 0.8355960249900818
2 stage 0.9394040107727051
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7688727974891663), (&#39;Precision@5&#39;, 0.7746636271476746), (&#39;Precision@10&#39;, 0.7718202471733093), (&#39;Recall@1&#39;, 0.002541040303185582), (&#39;Recall@5&#39;, 0.013961467891931534), (&#39;Recall@10&#39;, 0.028273116797208786), (&#39;NDCG@5&#39;, 0.773000955581665), (&#39;NDCG@10&#39;, 0.7718640565872192), (&#39;NDCG@20&#39;, 0.7727073431015015)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9317476749420166), (&#39;Precision@5&#39;, 0.8890381455421448), (&#39;Precision@10&#39;, 0.8653049468994141), (&#39;Recall@1&#39;, 0.01362884882837534), (&#39;Recall@5&#39;, 0.03554679825901985), (&#39;Recall@10&#39;, 0.05419434234499931), (&#39;NDCG@5&#39;, 0.8999322652816772), (&#39;NDCG@10&#39;, 0.8837052583694458), (&#39;NDCG@20&#39;, 0.8518556952476501)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8929019570350647), (&#39;Precision@5&#39;, 0.885880708694458), (&#39;Precision@10&#39;, 0.8833938837051392), (&#39;Recall@1&#39;, 0.0030145926866680384), (&#39;Recall@5&#39;, 0.015049256384372711), (&#39;Recall@10&#39;, 0.030261926352977753), (&#39;NDCG@5&#39;, 0.886837363243103), (&#39;NDCG@10&#39;, 0.8847842812538147), (&#39;NDCG@20&#39;, 0.8847416043281555)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9711562395095825), (&#39;Precision@5&#39;, 0.9493853449821472), (&#39;Precision@10&#39;, 0.9385502338409424), (&#39;Recall@1&#39;, 0.007329127751290798), (&#39;Recall@5&#39;, 0.024591417983174324), (&#39;Recall@10&#39;, 0.04251473769545555), (&#39;NDCG@5&#39;, 0.9547252058982849), (&#39;NDCG@10&#39;, 0.9468643069267273), (&#39;NDCG@20&#39;, 0.9290348887443542)])
---epoch 11---
1 stage 0.8360927104949951
2 stage 0.939238429069519
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7683557271957397), (&#39;Precision@5&#39;, 0.7737331390380859), (&#39;Precision@10&#39;, 0.7717682719230652), (&#39;Recall@1&#39;, 0.0025312236975878477), (&#39;Recall@5&#39;, 0.013931073248386383), (&#39;Recall@10&#39;, 0.02832760475575924), (&#39;NDCG@5&#39;, 0.7724922895431519), (&#39;NDCG@10&#39;, 0.7718040943145752), (&#39;NDCG@20&#39;, 0.772021472454071)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9317476749420166), (&#39;Precision@5&#39;, 0.8892449736595154), (&#39;Precision@10&#39;, 0.8650463223457336), (&#39;Recall@1&#39;, 0.01362884882837534), (&#39;Recall@5&#39;, 0.03550821170210838), (&#39;Recall@10&#39;, 0.05416148528456688), (&#39;NDCG@5&#39;, 0.900104284286499), (&#39;NDCG@10&#39;, 0.8835929036140442), (&#39;NDCG@20&#39;, 0.8518088459968567)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8939051628112793), (&#39;Precision@5&#39;, 0.8860311508178711), (&#39;Precision@10&#39;, 0.8833186030387878), (&#39;Recall@1&#39;, 0.003023584373295307), (&#39;Recall@5&#39;, 0.015060748904943466), (&#39;Recall@10&#39;, 0.030287474393844604), (&#39;NDCG@5&#39;, 0.8870344161987305), (&#39;NDCG@10&#39;, 0.8848085403442383), (&#39;NDCG@20&#39;, 0.8842055201530457)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9709054231643677), (&#39;Precision@5&#39;, 0.949586033821106), (&#39;Precision@10&#39;, 0.9382994174957275), (&#39;Recall@1&#39;, 0.0073165870271623135), (&#39;Recall@5&#39;, 0.02467793971300125), (&#39;Recall@10&#39;, 0.04251282662153244), (&#39;NDCG@5&#39;, 0.9548905491828918), (&#39;NDCG@10&#39;, 0.9467594623565674), (&#39;NDCG@20&#39;, 0.9288665652275085)])
---epoch 12---
1 stage 0.8357616066932678
2 stage 0.9385761618614197
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7688727974891663), (&#39;Precision@5&#39;, 0.7738365530967712), (&#39;Precision@10&#39;, 0.7722853422164917), (&#39;Recall@1&#39;, 0.002532533835619688), (&#39;Recall@5&#39;, 0.01389816403388977), (&#39;Recall@10&#39;, 0.028517844155430794), (&#39;NDCG@5&#39;, 0.7726624011993408), (&#39;NDCG@10&#39;, 0.7721626162528992), (&#39;NDCG@20&#39;, 0.7710179686546326)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9312306046485901), (&#39;Precision@5&#39;, 0.8893485069274902), (&#39;Precision@10&#39;, 0.8653566241264343), (&#39;Recall@1&#39;, 0.013489209115505219), (&#39;Recall@5&#39;, 0.03542754054069519), (&#39;Recall@10&#39;, 0.05412572622299194), (&#39;NDCG@5&#39;, 0.9000642895698547), (&#39;NDCG@10&#39;, 0.8836491703987122), (&#39;NDCG@20&#39;, 0.8513972163200378)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8931527733802795), (&#39;Precision@5&#39;, 0.8858307003974915), (&#39;Precision@10&#39;, 0.8832935690879822), (&#39;Recall@1&#39;, 0.003019903087988496), (&#39;Recall@5&#39;, 0.015028968453407288), (&#39;Recall@10&#39;, 0.030282167717814445), (&#39;NDCG@5&#39;, 0.886849045753479), (&#39;NDCG@10&#39;, 0.8847469687461853), (&#39;NDCG@20&#39;, 0.8832032680511475)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9701529741287231), (&#39;Precision@5&#39;, 0.9494857788085938), (&#39;Precision@10&#39;, 0.9382240772247314), (&#39;Recall@1&#39;, 0.007107383105903864), (&#39;Recall@5&#39;, 0.024620026350021362), (&#39;Recall@10&#39;, 0.04242135211825371), (&#39;NDCG@5&#39;, 0.9546770453453064), (&#39;NDCG@10&#39;, 0.9465430974960327), (&#39;NDCG@20&#39;, 0.9285589456558228)])
---epoch 13---
1 stage 0.8362582921981812
2 stage 0.937748372554779
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7709410786628723), (&#39;Precision@5&#39;, 0.7739399671554565), (&#39;Precision@10&#39;, 0.7720269560813904), (&#39;Recall@1&#39;, 0.0025725809391587973), (&#39;Recall@5&#39;, 0.013920770026743412), (&#39;Recall@10&#39;, 0.028608163818717003), (&#39;NDCG@5&#39;, 0.77310711145401), (&#39;NDCG@10&#39;, 0.7722665071487427), (&#39;NDCG@20&#39;, 0.7705519795417786)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9296793937683105), (&#39;Precision@5&#39;, 0.8893485069274902), (&#39;Precision@10&#39;, 0.8653048276901245), (&#39;Recall@1&#39;, 0.013278146274387836), (&#39;Recall@5&#39;, 0.03546256572008133), (&#39;Recall@10&#39;, 0.054152097553014755), (&#39;NDCG@5&#39;, 0.8998194932937622), (&#39;NDCG@10&#39;, 0.8834453225135803), (&#39;NDCG@20&#39;, 0.8509284257888794)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8929019570350647), (&#39;Precision@5&#39;, 0.8853790760040283), (&#39;Precision@10&#39;, 0.8832684755325317), (&#39;Recall@1&#39;, 0.0030202772468328476), (&#39;Recall@5&#39;, 0.015010001137852669), (&#39;Recall@10&#39;, 0.030313612893223763), (&#39;NDCG@5&#39;, 0.8865785002708435), (&#39;NDCG@10&#39;, 0.8847340941429138), (&#39;NDCG@20&#39;, 0.8825224041938782)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9696513414382935), (&#39;Precision@5&#39;, 0.9491847157478333), (&#39;Precision@10&#39;, 0.9378730654716492), (&#39;Recall@1&#39;, 0.007022056728601456), (&#39;Recall@5&#39;, 0.024508126080036163), (&#39;Recall@10&#39;, 0.0422583743929863), (&#39;NDCG@5&#39;, 0.9543265700340271), (&#39;NDCG@10&#39;, 0.9461403489112854), (&#39;NDCG@20&#39;, 0.9281177520751953)])
---epoch 14---
1 stage 0.8352649211883545
2 stage 0.937748372554779
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7699069380760193), (&#39;Precision@5&#39;, 0.7740433216094971), (&#39;Precision@10&#39;, 0.7716652154922485), (&#39;Recall@1&#39;, 0.0025672533083707094), (&#39;Recall@5&#39;, 0.013907205313444138), (&#39;Recall@10&#39;, 0.028547627851366997), (&#39;NDCG@5&#39;, 0.7730266451835632), (&#39;NDCG@10&#39;, 0.7719103097915649), (&#39;NDCG@20&#39;, 0.7697432637214661)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9286453127861023), (&#39;Precision@5&#39;, 0.8890382647514343), (&#39;Precision@10&#39;, 0.8652012944221497), (&#39;Recall@1&#39;, 0.012992068193852901), (&#39;Recall@5&#39;, 0.03513404354453087), (&#39;Recall@10&#39;, 0.05389030650258064), (&#39;NDCG@5&#39;, 0.8995911478996277), (&#39;NDCG@10&#39;, 0.8832032084465027), (&#39;NDCG@20&#39;, 0.8503848314285278)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8918986916542053), (&#39;Precision@5&#39;, 0.8851282596588135), (&#39;Precision@10&#39;, 0.8826413154602051), (&#39;Recall@1&#39;, 0.003015252063050866), (&#39;Recall@5&#39;, 0.015008385293185711), (&#39;Recall@10&#39;, 0.030310826376080513), (&#39;NDCG@5&#39;, 0.8863389492034912), (&#39;NDCG@10&#39;, 0.8842962384223938), (&#39;NDCG@20&#39;, 0.8815882802009583)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9701529741287231), (&#39;Precision@5&#39;, 0.9492349028587341), (&#39;Precision@10&#39;, 0.9378228783607483), (&#39;Recall@1&#39;, 0.006919103674590588), (&#39;Recall@5&#39;, 0.024281606078147888), (&#39;Recall@10&#39;, 0.04200495406985283), (&#39;NDCG@5&#39;, 0.9543092846870422), (&#39;NDCG@10&#39;, 0.9460137486457825), (&#39;NDCG@20&#39;, 0.9279131889343262)])
---epoch 15---
1 stage 0.8342715501785278
2 stage 0.9382450580596924
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7688727974891663), (&#39;Precision@5&#39;, 0.7741466164588928), (&#39;Precision@10&#39;, 0.7720270752906799), (&#39;Recall@1&#39;, 0.0025641624815762043), (&#39;Recall@5&#39;, 0.013893092051148415), (&#39;Recall@10&#39;, 0.028611961752176285), (&#39;NDCG@5&#39;, 0.7728968262672424), (&#39;NDCG@10&#39;, 0.7719386219978333), (&#39;NDCG@20&#39;, 0.7689577341079712)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9301964640617371), (&#39;Precision@5&#39;, 0.8893486857414246), (&#39;Precision@10&#39;, 0.8648910522460938), (&#39;Recall@1&#39;, 0.012969724833965302), (&#39;Recall@5&#39;, 0.035027049481868744), (&#39;Recall@10&#39;, 0.0536569282412529), (&#39;NDCG@5&#39;, 0.8999989032745361), (&#39;NDCG@10&#39;, 0.8830557465553284), (&#39;NDCG@20&#39;, 0.8499181270599365)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.890895426273346), (&#39;Precision@5&#39;, 0.885128378868103), (&#39;Precision@10&#39;, 0.8826413154602051), (&#39;Recall@1&#39;, 0.0030101861339062452), (&#39;Recall@5&#39;, 0.014987428672611713), (&#39;Recall@10&#39;, 0.030330732464790344), (&#39;NDCG@5&#39;, 0.8862097859382629), (&#39;NDCG@10&#39;, 0.8841873407363892), (&#39;NDCG@20&#39;, 0.8804370760917664)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9701529741287231), (&#39;Precision@5&#39;, 0.9493853449821472), (&#39;Precision@10&#39;, 0.9377727508544922), (&#39;Recall@1&#39;, 0.006855727173388004), (&#39;Recall@5&#39;, 0.0241836067289114), (&#39;Recall@10&#39;, 0.04189404845237732), (&#39;NDCG@5&#39;, 0.9543688297271729), (&#39;NDCG@10&#39;, 0.9459018707275391), (&#39;NDCG@20&#39;, 0.9275990128517151)])
---epoch 16---
1 stage 0.8342715501785278
2 stage 0.939238429069519
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7699069380760193), (&#39;Precision@5&#39;, 0.7728022933006287), (&#39;Precision@10&#39;, 0.7725440263748169), (&#39;Recall@1&#39;, 0.002587593160569668), (&#39;Recall@5&#39;, 0.01379038393497467), (&#39;Recall@10&#39;, 0.02874572202563286), (&#39;NDCG@5&#39;, 0.7722145915031433), (&#39;NDCG@10&#39;, 0.7722715139389038), (&#39;NDCG@20&#39;, 0.7682958245277405)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9322647452354431), (&#39;Precision@5&#39;, 0.8898658752441406), (&#39;Precision@10&#39;, 0.8647358417510986), (&#39;Recall@1&#39;, 0.01313948817551136), (&#39;Recall@5&#39;, 0.03528093919157982), (&#39;Recall@10&#39;, 0.053822338581085205), (&#39;NDCG@5&#39;, 0.9008933305740356), (&#39;NDCG@10&#39;, 0.8833855390548706), (&#39;NDCG@20&#39;, 0.8500461578369141)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8903937935829163), (&#39;Precision@5&#39;, 0.8849779367446899), (&#39;Precision@10&#39;, 0.8826160430908203), (&#39;Recall@1&#39;, 0.0030037390533834696), (&#39;Recall@5&#39;, 0.014980170875787735), (&#39;Recall@10&#39;, 0.03035588748753071), (&#39;NDCG@5&#39;, 0.8861247897148132), (&#39;NDCG@10&#39;, 0.8841509819030762), (&#39;NDCG@20&#39;, 0.8795574903488159)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9706546068191528), (&#39;Precision@5&#39;, 0.9496863484382629), (&#39;Precision@10&#39;, 0.9377727508544922), (&#39;Recall@1&#39;, 0.006977349519729614), (&#39;Recall@5&#39;, 0.024342140182852745), (&#39;Recall@10&#39;, 0.0420152023434639), (&#39;NDCG@5&#39;, 0.9546906352043152), (&#39;NDCG@10&#39;, 0.9460608959197998), (&#39;NDCG@20&#39;, 0.9275720715522766)])
---epoch 17---
1 stage 0.8339403867721558
2 stage 0.9387417435646057
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7688727974891663), (&#39;Precision@5&#39;, 0.7732157707214355), (&#39;Precision@10&#39;, 0.7721819281578064), (&#39;Recall@1&#39;, 0.0025853486731648445), (&#39;Recall@5&#39;, 0.013845651410520077), (&#39;Recall@10&#39;, 0.028628256171941757), (&#39;NDCG@5&#39;, 0.7722429633140564), (&#39;NDCG@10&#39;, 0.7718576192855835), (&#39;NDCG@20&#39;, 0.767686665058136)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9312306046485901), (&#39;Precision@5&#39;, 0.8897624015808105), (&#39;Precision@10&#39;, 0.864425778388977), (&#39;Recall@1&#39;, 0.013013952411711216), (&#39;Recall@5&#39;, 0.035018254071474075), (&#39;Recall@10&#39;, 0.05353393778204918), (&#39;NDCG@5&#39;, 0.9006258249282837), (&#39;NDCG@10&#39;, 0.8829480409622192), (&#39;NDCG@20&#39;, 0.8497097492218018)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8903937935829163), (&#39;Precision@5&#39;, 0.8849778175354004), (&#39;Precision@10&#39;, 0.8823150396347046), (&#39;Recall@1&#39;, 0.0030055013485252857), (&#39;Recall@5&#39;, 0.014995132572948933), (&#39;Recall@10&#39;, 0.030364053323864937), (&#39;NDCG@5&#39;, 0.8861544132232666), (&#39;NDCG@10&#39;, 0.8839383721351624), (&#39;NDCG@20&#39;, 0.8786713480949402)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.970403790473938), (&#39;Precision@5&#39;, 0.9499371647834778), (&#39;Precision@10&#39;, 0.9376974701881409), (&#39;Recall@1&#39;, 0.006946822162717581), (&#39;Recall@5&#39;, 0.024365242570638657), (&#39;Recall@10&#39;, 0.04201309755444527), (&#39;NDCG@5&#39;, 0.9548534750938416), (&#39;NDCG@10&#39;, 0.9460048079490662), (&#39;NDCG@20&#39;, 0.9273778200149536)])
---epoch 18---
1 stage 0.8332781791687012
2 stage 0.9384106397628784
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7683557271957397), (&#39;Precision@5&#39;, 0.7734225392341614), (&#39;Precision@10&#39;, 0.7714068293571472), (&#39;Recall@1&#39;, 0.0025810804218053818), (&#39;Recall@5&#39;, 0.013942412100732327), (&#39;Recall@10&#39;, 0.02855859324336052), (&#39;NDCG@5&#39;, 0.7723387479782104), (&#39;NDCG@10&#39;, 0.7713356614112854), (&#39;NDCG@20&#39;, 0.767216145992279)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9301964640617371), (&#39;Precision@5&#39;, 0.889141857624054), (&#39;Precision@10&#39;, 0.8643222451210022), (&#39;Recall@1&#39;, 0.01304357685148716), (&#39;Recall@5&#39;, 0.034884266555309296), (&#39;Recall@10&#39;, 0.053411055356264114), (&#39;NDCG@5&#39;, 0.9000440239906311), (&#39;NDCG@10&#39;, 0.8827939033508301), (&#39;NDCG@20&#39;, 0.8493320941925049)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8896413445472717), (&#39;Precision@5&#39;, 0.8848274350166321), (&#39;Precision@10&#39;, 0.8820641040802002), (&#39;Recall@1&#39;, 0.0029982151463627815), (&#39;Recall@5&#39;, 0.015002566389739513), (&#39;Recall@10&#39;, 0.03033376671373844), (&#39;NDCG@5&#39;, 0.8859151601791382), (&#39;NDCG@10&#39;, 0.883664071559906), (&#39;NDCG@20&#39;, 0.8777598142623901)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.970403790473938), (&#39;Precision@5&#39;, 0.949836790561676), (&#39;Precision@10&#39;, 0.9376975297927856), (&#39;Recall@1&#39;, 0.006989224348217249), (&#39;Recall@5&#39;, 0.024378934875130653), (&#39;Recall@10&#39;, 0.042055051773786545), (&#39;NDCG@5&#39;, 0.9547573924064636), (&#39;NDCG@10&#39;, 0.946016252040863), (&#39;NDCG@20&#39;, 0.9272603392601013)])
---epoch 19---
1 stage 0.8344370722770691
2 stage 0.937417209148407
1 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.7724922299385071), (&#39;Precision@5&#39;, 0.7734224796295166), (&#39;Precision@10&#39;, 0.7712516784667969), (&#39;Recall@1&#39;, 0.0026290433015674353), (&#39;Recall@5&#39;, 0.013950219377875328), (&#39;Recall@10&#39;, 0.028614703565835953), (&#39;NDCG@5&#39;, 0.7729315161705017), (&#39;NDCG@10&#39;, 0.7716161608695984), (&#39;NDCG@20&#39;, 0.7671958208084106)])
2 stage (val) OrderedDict([(&#39;Precision@1&#39;, 0.9281282424926758), (&#39;Precision@5&#39;, 0.8886248469352722), (&#39;Precision@10&#39;, 0.8638569712638855), (&#39;Recall@1&#39;, 0.01269526220858097), (&#39;Recall@5&#39;, 0.03449012339115143), (&#39;Recall@10&#39;, 0.05301033332943916), (&#39;NDCG@5&#39;, 0.8991745114326477), (&#39;NDCG@10&#39;, 0.8819308876991272), (&#39;NDCG@20&#39;, 0.8481321334838867)])
1 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.8893905282020569), (&#39;Precision@5&#39;, 0.8843759894371033), (&#39;Precision@10&#39;, 0.8814369440078735), (&#39;Recall@1&#39;, 0.0030090906657278538), (&#39;Recall@5&#39;, 0.014989291317760944), (&#39;Recall@10&#39;, 0.030279411002993584), (&#39;NDCG@5&#39;, 0.8855165243148804), (&#39;NDCG@10&#39;, 0.8831601738929749), (&#39;NDCG@20&#39;, 0.8770545125007629)])
2 stage (test) OrderedDict([(&#39;Precision@1&#39;, 0.9699021577835083), (&#39;Precision@5&#39;, 0.9497867226600647), (&#39;Precision@10&#39;, 0.9374968409538269), (&#39;Recall@1&#39;, 0.006969019304960966), (&#39;Recall@5&#39;, 0.024379633367061615), (&#39;Recall@10&#39;, 0.04202014207839966), (&#39;NDCG@5&#39;, 0.9546409845352173), (&#39;NDCG@10&#39;, 0.9458295702934265), (&#39;NDCG@20&#39;, 0.9270906448364258)])
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best validation epoch: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_epoch</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best validation stage results</span><span class="se">\n</span><span class="s2"> 1 stage: </span><span class="si">{}</span><span class="se">\n</span><span class="s2"> 2 stage: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">val_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">val_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best test results</span><span class="se">\n</span><span class="s2"> 1 stage: </span><span class="si">{}</span><span class="se">\n</span><span class="s2"> 2 stage: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">test_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best validation epoch: 6
Best validation stage results
 1 stage: OrderedDict([(&#39;Precision@1&#39;, 0.7652533650398254), (&#39;Precision@5&#39;, 0.7777659296989441), (&#39;Precision@10&#39;, 0.7713546752929688), (&#39;Recall@1&#39;, 0.002462433883920312), (&#39;Recall@5&#39;, 0.014112057164311409), (&#39;Recall@10&#39;, 0.02813573367893696), (&#39;NDCG@5&#39;, 0.7751555442810059), (&#39;NDCG@10&#39;, 0.7717844247817993), (&#39;NDCG@20&#39;, 0.7759582996368408)])
 2 stage: OrderedDict([(&#39;Precision@1&#39;, 0.9353671073913574), (&#39;Precision@5&#39;, 0.8887278437614441), (&#39;Precision@10&#39;, 0.866390585899353), (&#39;Recall@1&#39;, 0.013995282351970673), (&#39;Recall@5&#39;, 0.035590916872024536), (&#39;Recall@10&#39;, 0.05474210903048515), (&#39;NDCG@5&#39;, 0.9002852439880371), (&#39;NDCG@10&#39;, 0.8846437931060791), (&#39;NDCG@20&#39;, 0.8533338904380798)])
Best test results
 1 stage: OrderedDict([(&#39;Precision@1&#39;, 0.8931527733802795), (&#39;Precision@5&#39;, 0.8867837190628052), (&#39;Precision@10&#39;, 0.8830179572105408), (&#39;Recall@1&#39;, 0.0030013115610927343), (&#39;Recall@5&#39;, 0.01514824852347374), (&#39;Recall@10&#39;, 0.03022931143641472), (&#39;NDCG@5&#39;, 0.8876431584358215), (&#39;NDCG@10&#39;, 0.8846896886825562), (&#39;NDCG@20&#39;, 0.886621356010437)])
 2 stage: OrderedDict([(&#39;Precision@1&#39;, 0.9729119539260864), (&#39;Precision@5&#39;, 0.9496863484382629), (&#39;Precision@10&#39;, 0.9388262033462524), (&#39;Recall@1&#39;, 0.007614111993461847), (&#39;Recall@5&#39;, 0.024715635925531387), (&#39;Recall@10&#39;, 0.04267028719186783), (&#39;NDCG@5&#39;, 0.9553412199020386), (&#39;NDCG@10&#39;, 0.9473593235015869), (&#39;NDCG@20&#39;, 0.9304744601249695)])
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="n">best_epoch</span><span class="p">,</span> <span class="n">val_results</span><span class="p">,</span> <span class="n">test_results</span><span class="p">),</span>
            <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-a</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">loss_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">tree</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">tree</span> <span class="o">--</span><span class="n">du</span> <span class="o">-</span><span class="n">h</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>.
├── [ 20K]  ce-a0.001_0.pkl
├── [651M]  ml-1m
│   ├── [626M]  full_impression_feats.pt
│   ├── [463K]  logging_policy.pt
│   ├── [167K]  movies.dat
│   ├── [463K]  ranker.pt
│   ├── [ 23M]  ratings.dat
│   ├── [5.4K]  README
│   ├── [502K]  simulator.pt
│   └── [131K]  users.dat
├── [5.6M]  ml-1m.zip
└── [ 54M]  sample_data
    ├── [1.7K]  anscombe.json
    ├── [294K]  california_housing_test.csv
    ├── [1.6M]  california_housing_train.csv
    ├── [ 17M]  mnist_test.csv
    ├── [ 35M]  mnist_train_small.csv
    └── [ 930]  README.md

 711M used in 2 directories, 16 files
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Experimental-results">Experimental results<a class="anchor-link" href="#Experimental-results"> </a></h2><p><img src="https://github.com/recohut/drl-recsys/raw/a8a38a68e3606557f3501c8adc85fc6aa5726bc1/docs/_images/T257798_4.png" alt="" /></p>
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion"> </a></h2><ul>
<li>The results of 2-IPS method in both evaluations are better than 1-IPS and cross-entropy.</li>
<li>1-IPS performs better than the cross-entropy method in one-stage evaluation, and performs worse than the cross-entropy method in two-stage evaluation, indicating that only improving the performance of a part of the system may not necessarily improve the performance of the entire system.</li>
</ul>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/2022/01/24/opl.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
