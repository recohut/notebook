<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>SimpleX MF Model on ML-100k Dataset | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="SimpleX MF Model on ML-100k Dataset" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/24/simplex-mf.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/24/simplex-mf.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-24T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="SimpleX MF Model on ML-100k Dataset" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-24T00:00:00-06:00","datePublished":"2022-01-24T00:00:00-06:00","description":"Jupyter notebook database.","headline":"SimpleX MF Model on ML-100k Dataset","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/24/simplex-mf.html"},"url":"https://nb.recohut.com/2022/01/24/simplex-mf.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">SimpleX MF Model on ML-100k Dataset</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-24T00:00:00-06:00" itemprop="datePublished">
        Jan 24, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      39 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-24-simplex-mf.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-24-simplex-mf.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-24-simplex-mf.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-24-simplex-mf.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-24-simplex-mf.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">sparsh</span><span class="o">-</span><span class="n">ai</span><span class="o">/</span><span class="n">recochef</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>  Installing build dependencies ... done
  Getting requirements to build wheel ... done
    Preparing wheel metadata ... done
     |████████████████████████████████| 4.3 MB 5.1 MB/s 
  Building wheel for recochef (PEP 517) ... done
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span> 
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">random</span> <span class="k">as</span> <span class="nn">rd</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="kn">from</span> <span class="nn">recochef.preprocessing.split</span> <span class="kn">import</span> <span class="n">chrono_split</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">progress</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">files</span><span class="o">.</span><span class="n">grouplens</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">datasets</span><span class="o">/</span><span class="n">movielens</span><span class="o">/</span><span class="n">ml</span><span class="o">-</span><span class="mi">100</span><span class="n">k</span><span class="o">.</span><span class="n">zip</span>
<span class="err">!</span><span class="n">unzip</span> <span class="n">ml</span><span class="o">-</span><span class="mi">100</span><span class="n">k</span><span class="o">.</span><span class="n">zip</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>ml-100k.zip         100%[===================&gt;]   4.70M  16.6MB/s    in 0.3s    
Archive:  ml-100k.zip
   creating: ml-100k/
  inflating: ml-100k/allbut.pl       
  inflating: ml-100k/mku.sh          
  inflating: ml-100k/README          
  inflating: ml-100k/u.data          
  inflating: ml-100k/u.genre         
  inflating: ml-100k/u.info          
  inflating: ml-100k/u.item          
  inflating: ml-100k/u.occupation    
  inflating: ml-100k/u.user          
  inflating: ml-100k/u1.base         
  inflating: ml-100k/u1.test         
  inflating: ml-100k/u2.base         
  inflating: ml-100k/u2.test         
  inflating: ml-100k/u3.base         
  inflating: ml-100k/u3.test         
  inflating: ml-100k/u4.base         
  inflating: ml-100k/u4.test         
  inflating: ml-100k/u5.base         
  inflating: ml-100k/u5.test         
  inflating: ml-100k/ua.base         
  inflating: ml-100k/ua.test         
  inflating: ml-100k/ub.base         
  inflating: ml-100k/ub.test         
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ml-100k/u.data&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;USERID&#39;</span><span class="p">,</span><span class="s1">&#39;ITEMID&#39;</span><span class="p">,</span><span class="s1">&#39;RATING&#39;</span><span class="p">,</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">])</span>
<span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">chrono_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;USERID&#39;</span><span class="p">,</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;USERID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;USERID&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ITEMID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ITEMID&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span><span class="s1">&#39;RATING&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;USERID&#39;</span><span class="p">)[</span><span class="s1">&#39;ITEMID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ITEMID&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_file</span><span class="o">=</span><span class="s1">&#39;./data/movielens/train.txt&#39;</span><span class="p">):</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">USERID</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">USERID</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">ITEMID</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">USERID</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">store</span><span class="p">(</span><span class="n">preprocess</span><span class="p">(</span><span class="n">df_train</span><span class="p">),</span> <span class="s1">&#39;/content/data/ml-100k/train.txt&#39;</span><span class="p">)</span>
<span class="n">store</span><span class="p">(</span><span class="n">preprocess</span><span class="p">(</span><span class="n">df_test</span><span class="p">),</span> <span class="s1">&#39;/content/data/ml-100k/test.txt&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">head</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">ml</span><span class="o">-</span><span class="mi">100</span><span class="n">k</span><span class="o">/</span><span class="n">train</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0 167 171 164 155 165 195 186 13 249 126 180 116 108 0 245 256 247 49 248 252 261 92 223 123 18 122 136 145 6 234 14 244 259 23 263 125 236 12 24 120 250 235 239 117 129 64 189 46 30 27 113 38 51 237 198 182 10 68 160 94 59 82 178 21 97 63 134 162 25 201 88 7 213 181 47 98 159 174 191 179 127 142 184 67 54 203 55 95 80 78 150 211 22 69 83 93 196 190 183 133 206 144 187 185 96 84 35 143 158 16 173 251 104 147 107 146 219 105 242 121 106 103 246 119 44 267 266 258 260 262 9 149 233 91 70 41 175 90 192 216 176 215 193 72 58 132 40 194 217 169 212 156 222 26 226 79 230 66 118 199 3 214 163 1 205 76 52 135 45 39 152 268 253 114 172 210 228 154 202 61 89 218 166 229 34 161 60 264 111 56 48 29 232 130 151 81 140 71 32 157 197 224 112 20 148 87 100 109 102 238 33 28 42 131 209 204 115 124
1 285 257 304 306 287 311 300 305 291 302 268 298 314 295 0 18 296 292 274 256 294 276 286 254 297 289 279 273 275 272 290 277 293 24 278 13 110 9 281 12 236 283 99 126 312 284 301 282 250 310
2 301 332 343 299 267 336 302 344 353 257 287 318 340 351 271 349 352 333 342 338 341 335 298 325 293 306 331 270 244 354 323 348 322 321 334 263 324 337 329 350 346 339 328
3 257 287 299 327 270 358 361 302 326 328 359 360 353 300 323 209 355 356 49
4 266 454 221 120 404 362 256 249 24 20 99 108 368 234 411 406 410 104 367 224 150 0 180 49 405 423 412 78 396 372 230 398 228 225 175 449 182 434 88 1 227 229 226 448 209 430 173 171 143 402 397 390 384 16 371 385 392 395 166 366 89 400 389 41 152 185 455 69 383 109 79 380 363 208 450 381 427 382 429 210 432 238 172 207 203 413 167 153 421 431 422 418 142 416 414 373 28 433 364 365 379 391 386 428 424 213 134 61 374 97 447 184 233 435 199 442 444 446 218 443 378 369 440 144 445 401 240 370 215 65 420 426 377 94 419 101 415 417 98 403
5 285 241 301 268 305 257 339 302 303 320 309 258 267 308 537 260 181 247 407 274 6 296 126 275 99 8 458 123 13 514 14 136 292 533 535 12 116 284 220 474 0 256 110 476 245 507 470 150 297 283 124 409 532 236 457 293 471 459 534 404 531 472 20 475 300 307 63 523 7 513 97 426 164 222 134 78 530 509 177 486 176 135 88 49 526 204 512 480 461 186 191 46 168 173 519 317 483 488 497 142 70 11 478 190 496 479 491 503 511 495 210 468 524 196 481 198 529 55 536 499 473 68 520 203 506 31 179 182 518 489 188 22 193 463 494 510 460 184 165 174 487 485 69 132 528 482 215 521 522 434 192 462 431 492 237 493 58 208 130 21 94 502 527 86 490 316 467 505 155
6 268 677 681 258 680 306 265 285 267 682 299 287 263 679 308 63 173 186 602 514 175 179 85 366 264 227 522 434 617 185 418 215 446 529 177 642 31 650 171 649 181 100 473 172 615 428 97 233 487 49 92 525 196 88 99 481 495 513 21 611 203 610 652 658 96 143 483 190 402 656 131 170 180 633 7 494 222 95 22 645 654 635 55 8 490 195 435 81 200 498 655 632 167 422 603 134 272 430 67 204 384 165 614 660 510 182 214 155 607 647 643 197 212 670 68 126 189 43 595 355 542 236 526 512 3 284 135 163 497 237 151 484 592 193 482 612 91 478 491 191 317 392 156 381 583 479 509 420 496 202 429 486 590 6 426 662 152 207 501 567 587 631 78 460 178 629 504 480 27 506 130 228 213 503 433 657 10 588 24 646 160 613 549 469 628 206 210 98 69 626 601 194 528 80 555 673 527 651 70 26 46 547 608 150 536 187 508 216 667 618 274 518 431 627 606 634 9 470 176 120 401 605 209 403 674 201 50 630 89 621 377 211 659 415 454 609 548 153 139 520 678 464 124 462 132 419 125 648 442 543 669 404 604 76 378 229 471 565 117 500 162 161 545 140 580 488 199 636 639 505 644 38 225 591 638 280 383 546 600 596 672 364 231 594 597 51 28 572 447 451 598 90 105 623 619 450 570 586 502 663 71 240 379 561 141 577 599 388 593 77 622 440 400 395 443 571 398 79 414 664 563 676
7 257 293 300 258 335 259 687 242 357 456 340 686 337 688 650 171 186 126 49 384 88 21 55 189 181 180 95 173 510 509 567 176 10 434 175 182 402 143 54 227 78 272 209 6 194 228 685
8 339 241 478 520 401 506 614 526 689 275 293 6 370 49 384 5 297 200
9 301 285 268 288 318 244 333 332 653 526 429 55 512 662 63 31 173 126 492 193 152 557 58 185 517 701 610 628 417 473 384 692 602 706 155 504 655 587 485 663 22 11 403 530 685 370 81 222 123 474 49 708 190 272 609 487 220 705 174 274 696 10 177 21 710 700 167 204 650 184 605 181 233 15 510 697 0 479 196 460 159 115 477 134 178 156 8 508 495 197 601 47 194 210 651 175 3 98 133 68 136 284 356 154 462 97 434 501 496 217 691 199 481 482 215 179 273 163 169 497 69 446 461 99 469 275 132 466 654 483 588 191 478 413 128 202 704 12 198 703 160 694 518 702 656 520 603
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">user_history_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">item_corpus</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">corpus_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="n">max_hist</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/content/data/ml-100k/train.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="o">&gt;</span><span class="n">max_hist</span><span class="p">:</span> <span class="n">max_hist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">user_history_dict</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">corpus_index</span><span class="p">:</span>
                <span class="n">corpus_index</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">corpus_index</span><span class="p">)</span>
                <span class="n">item_corpus</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">corpus_index</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">item</span><span class="p">])</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">user_history_dict</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">history</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">train_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">user_id</span><span class="p">,</span> <span class="n">corpus_index</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">history</span><span class="p">)])</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;query_index&quot;</span><span class="p">,</span> <span class="s2">&quot;corpus_index&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;user_history&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train samples:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">))</span>
<span class="n">train</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;train.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/content/data/ml-100k/test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">corpus_index</span><span class="p">:</span>
                <span class="n">corpus_index</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">corpus_index</span><span class="p">)</span>
                <span class="n">item_corpus</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">corpus_index</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">item</span><span class="p">])</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">user_history_dict</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">test_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">user_id</span><span class="p">,</span> <span class="n">corpus_index</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">history</span><span class="p">)])</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;query_index&quot;</span><span class="p">,</span> <span class="s2">&quot;corpus_index&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;user_history&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test samples:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
<span class="n">test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;test.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">corpus</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">item_corpus</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;corpus_index&quot;</span><span class="p">,</span> <span class="s2">&quot;item_id&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of items:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_corpus</span><span class="p">))</span>
<span class="n">corpus</span> <span class="o">=</span> <span class="n">corpus</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;corpus_index&quot;</span><span class="p">)</span>
<span class="n">corpus</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;item_corpus.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>train samples: 80000
test samples: 20000
number of items: 1682
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">max_hist</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>590</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>query_index</th>
      <th>corpus_index</th>
      <th>label</th>
      <th>user_id</th>
      <th>user_history</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>171^164^155^165^195^186^13^249^126^180^116^108...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>167^164^155^165^195^186^13^249^126^180^116^108...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>167^171^155^165^195^186^13^249^126^180^116^108...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>167^171^164^165^195^186^13^249^126^180^116^108...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>167^171^164^155^195^186^13^249^126^180^116^108...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">corpus</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>item_id</th>
    </tr>
    <tr>
      <th>corpus_index</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>167</td>
    </tr>
    <tr>
      <th>1</th>
      <td>171</td>
    </tr>
    <tr>
      <th>2</th>
      <td>164</td>
    </tr>
    <tr>
      <th>3</th>
      <td>155</td>
    </tr>
    <tr>
      <th>4</th>
      <td>165</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">import</span> <span class="nn">sklearn.preprocessing</span> <span class="k">as</span> <span class="nn">sklearn_preprocess</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.sequence</span> <span class="kn">import</span> <span class="n">pad_sequences</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.dataloader</span> <span class="kn">import</span> <span class="n">default_collate</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">mkdir</span> <span class="n">checkpoints</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;ml100k&#39;</span>
    <span class="n">data_root</span> <span class="o">=</span> <span class="s1">&#39;/content&#39;</span>
    <span class="n">data_format</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="s1">&#39;/content/train.csv&#39;</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="s1">&#39;/content/test.csv&#39;</span>
    <span class="n">item_corpus</span> <span class="o">=</span> <span class="s1">&#39;/content/item_corpus.csv&#39;</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_block_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">min_categr_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">query_index</span> <span class="o">=</span> <span class="s1">&#39;query_index&#39;</span>
    <span class="n">corpus_index</span> <span class="o">=</span> <span class="s1">&#39;corpus_index&#39;</span>
    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;query_index&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;index&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;corpus_index&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;index&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;user_history&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;splitter&#39;</span><span class="p">:</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span>
         <span class="s1">&#39;max_len&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;padding&#39;</span><span class="p">:</span> <span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="s1">&#39;embedding_callback&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;item&#39;</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">label_col</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">}</span>

    <span class="n">model_root</span> <span class="o">=</span> <span class="s1">&#39;checkpoints/&#39;</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">patience</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">save_best_only</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">eval_interval_epochs</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;SimpleX&#39;</span>
    <span class="n">dataset_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;pytorch&#39;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Recall(k=20)&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall(k=50)&#39;</span><span class="p">,</span> <span class="s1">&#39;NDCG(k=20)&#39;</span><span class="p">,</span> <span class="s1">&#39;NDCG(k=50)&#39;</span><span class="p">,</span> <span class="s1">&#39;HitRate(k=20)&#39;</span><span class="p">,</span> <span class="s1">&#39;HitRate(k=50)&#39;</span><span class="p">]</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;adam&#39;</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1.0e-3</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="n">num_negs</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">aggregator</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">user_id_field</span> <span class="o">=</span> <span class="s1">&#39;user_id&#39;</span>
    <span class="n">item_id_field</span> <span class="o">=</span> <span class="s1">&#39;item_id&#39;</span>
    <span class="n">user_history_field</span> <span class="o">=</span> <span class="s1">&#39;user_history&#39;</span>
    <span class="n">embedding_regularizer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">net_regularizer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">net_dropout</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">attention_dropout</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">enable_bias</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">similarity_score</span> <span class="o">=</span> <span class="s1">&#39;dot&#39;</span>
    <span class="c1"># loss = &#39;PairwiseLogisticLoss&#39;</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;CosineContrastiveLoss&#39;</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">negative_weight</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sampling_num_process</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fix_sampling_seeds</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ignore_pos_items</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="mi">2019</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;Recall(k=20)&#39;</span>
    <span class="n">monitor_mode</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>


<span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">model_configs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s1">&#39;model_config.yaml&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">model_configs</span><span class="p">:</span>
        <span class="n">model_configs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s1">&#39;model_config/*.yaml&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">model_configs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;config_dir=</span><span class="si">{}</span><span class="s1"> is not valid!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_dir</span><span class="p">))</span>
    <span class="n">found_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">model_configs</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;Base&#39;</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="n">found_params</span><span class="p">[</span><span class="s1">&#39;Base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Base&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="n">found_params</span><span class="p">[</span><span class="n">experiment_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="n">experiment_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c1"># Update base setting first so that values can be overrided when conflict </span>
    <span class="c1"># with experiment_id settings</span>
    <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">found_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Base&#39;</span><span class="p">,</span> <span class="p">{}))</span>
    <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">found_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;dataset_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;experiment_id=</span><span class="si">{}</span><span class="s1"> is not valid in config.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">))</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment_id</span>
    <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">]</span>
    <span class="n">dataset_configs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s1">&#39;dataset_config.yaml&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_configs</span><span class="p">:</span>
        <span class="n">dataset_configs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s1">&#39;dataset_config/*.yaml&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">dataset_configs</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dataset_id</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="n">dataset_id</span><span class="p">])</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">params</span>


<span class="k">def</span> <span class="nf">set_logger</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">]</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_id&#39;</span><span class="p">]</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_root&#39;</span><span class="p">],</span> <span class="n">dataset_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">model_id</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span>

    <span class="c1"># logs will not show in the file without the two lines.</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span> 
        <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> P</span><span class="si">%(process)d</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">),</span>
                                  <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()])</span>


<span class="k">def</span> <span class="nf">print_to_json</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">sort_keys</span><span class="p">:</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">new_data</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_to_list</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39; - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">Monitor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kv</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kv</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">kv</span> <span class="o">=</span> <span class="p">{</span><span class="n">kv</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kv_pairs</span> <span class="o">=</span> <span class="n">kv</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="n">logs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">seed_everything</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1029</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONHASHSEED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">set_device</span><span class="p">(</span><span class="n">gpu</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gpu</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gpu</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>   
    <span class="k">return</span> <span class="n">device</span>

<span class="k">def</span> <span class="nf">set_optimizer</span><span class="p">(</span><span class="n">optimizer</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;adam&quot;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="s2">&quot;Adam&quot;</span>
        <span class="k">elif</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rmsprop&quot;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="s2">&quot;RMSprop&quot;</span>
        <span class="k">elif</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;sgd&quot;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="s2">&quot;SGD&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">set_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">loss</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bce&quot;</span><span class="p">,</span> <span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="s2">&quot;binary_cross_entropy&quot;</span><span class="p">]:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="s2">&quot;binary_cross_entropy&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;loss=</span><span class="si">{}</span><span class="s2"> is not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="k">def</span> <span class="nf">set_regularizer</span><span class="p">(</span><span class="n">reg</span><span class="p">):</span>
    <span class="n">reg_pair</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># of tuples (p_norm, weight)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">reg_pair</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;l1(&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">reg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;l2(&quot;</span><span class="p">):</span>
                <span class="n">reg_pair</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
            <span class="k">elif</span> <span class="n">reg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;l1_l2&quot;</span><span class="p">):</span>
                <span class="n">l1_reg</span><span class="p">,</span> <span class="n">l2_reg</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">reg_pair</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">l1_reg</span><span class="p">)))</span>
                <span class="n">reg_pair</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">l2_reg</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;regularizer=</span><span class="si">{}</span><span class="s2"> is not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">reg_pair</span>

<span class="k">def</span> <span class="nf">set_activation</span><span class="p">(</span><span class="n">activation</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activation</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">activation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;relu&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">activation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">activation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tanh&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">activation</span><span class="p">)()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">activation</span>

<span class="k">def</span> <span class="nf">pad_sequences</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span>
                  <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="n">truncating</span><span class="o">=</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Pads sequences (list of list) to the ndarray of same length </span>
<span class="sd">        This is an equivalent implementation of tf.keras.preprocessing.sequence.pad_sequences</span>
<span class="sd">        for Pytorch</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">padding</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">],</span> <span class="s2">&quot;Invalid padding=</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">padding</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">truncating</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">],</span> <span class="s2">&quot;Invalid truncating=</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">truncating</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">maxlen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">),</span> <span class="n">maxlen</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sequences</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># empty list</span>
        <span class="k">if</span> <span class="n">truncating</span> <span class="o">==</span> <span class="s1">&#39;pre&#39;</span><span class="p">:</span>
            <span class="n">trunc</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="n">maxlen</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trunc</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">maxlen</span><span class="p">]</span>
        <span class="n">trunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">trunc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">padding</span> <span class="o">==</span> <span class="s1">&#39;pre&#39;</span><span class="p">:</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">trunc</span><span class="p">):]</span> <span class="o">=</span> <span class="n">trunc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">trunc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trunc</span>
    <span class="k">return</span> <span class="n">arr</span>


<span class="k">def</span> <span class="nf">save_h5</span><span class="p">(</span><span class="n">darray_dict</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving data to h5: &quot;</span> <span class="o">+</span> <span class="n">data_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">data_path</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">data_path</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
        <span class="n">hf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;num_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">darray_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">darray_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">arr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_h5</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading data from h5: &#39;</span> <span class="o">+</span> <span class="n">data_path</span><span class="p">)</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;num_samples&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>
    <span class="k">return</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">num_samples</span>


<span class="k">def</span> <span class="nf">split_train_test</span><span class="p">(</span><span class="n">train_ddf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_ddf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test_ddf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                     <span class="n">test_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">split_type</span><span class="o">=</span><span class="s2">&quot;sequential&quot;</span><span class="p">):</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_ddf</span><span class="p">)</span>
    <span class="n">train_size</span> <span class="o">=</span> <span class="n">num_samples</span>
    <span class="n">instance_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">split_type</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">instance_IDs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">test_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">test_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">*</span> <span class="n">test_size</span><span class="p">)</span>
        <span class="n">train_size</span> <span class="o">=</span> <span class="n">train_size</span> <span class="o">-</span> <span class="n">test_size</span>
        <span class="n">test_ddf</span> <span class="o">=</span> <span class="n">train_ddf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">instance_IDs</span><span class="p">[</span><span class="n">train_size</span><span class="p">:],</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">instance_IDs</span> <span class="o">=</span> <span class="n">instance_IDs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">valid_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">valid_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">valid_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_samples</span> <span class="o">*</span> <span class="n">valid_size</span><span class="p">)</span>
        <span class="n">train_size</span> <span class="o">=</span> <span class="n">train_size</span> <span class="o">-</span> <span class="n">valid_size</span>
        <span class="n">valid_ddf</span> <span class="o">=</span> <span class="n">train_ddf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">instance_IDs</span><span class="p">[</span><span class="n">train_size</span><span class="p">:],</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">instance_IDs</span> <span class="o">=</span> <span class="n">instance_IDs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">valid_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">test_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">train_ddf</span> <span class="o">=</span> <span class="n">train_ddf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">instance_IDs</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">train_ddf</span><span class="p">,</span> <span class="n">valid_ddf</span><span class="p">,</span> <span class="n">test_ddf</span>


<span class="k">def</span> <span class="nf">transform_h5</span><span class="p">(</span><span class="n">feature_encoder</span><span class="p">,</span> <span class="n">ddf</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_transform_block</span><span class="p">(</span><span class="n">feature_encoder</span><span class="p">,</span> <span class="n">df_block</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">preprocess</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">preprocess</span><span class="p">:</span>
            <span class="n">df_block</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">df_block</span><span class="p">)</span>
        <span class="n">darray_dict</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_block</span><span class="p">)</span>
        <span class="n">save_h5</span><span class="p">(</span><span class="n">darray_dict</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feature_encoder</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">block_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">block_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ddf</span><span class="p">),</span> <span class="n">block_size</span><span class="p">):</span>
            <span class="n">df_block</span> <span class="o">=</span> <span class="n">ddf</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">block_size</span><span class="p">)]</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">_transform_block</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">feature_encoder</span><span class="p">,</span> 
                                                     <span class="n">df_block</span><span class="p">,</span> 
                                                     <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;_part_</span><span class="si">{}</span><span class="s1">.h5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">block_id</span><span class="p">)),</span>
                                                     <span class="n">preprocess</span><span class="p">))</span>
            <span class="n">block_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_transform_block</span><span class="p">(</span><span class="n">feature_encoder</span><span class="p">,</span> <span class="n">ddf</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">preprocess</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Tokenizer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topk_words</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">na_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">lower</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">oov_token</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;pre&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topk_words</span> <span class="o">=</span> <span class="n">topk_words</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_na_value</span> <span class="o">=</span> <span class="n">na_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_freq</span> <span class="o">=</span> <span class="n">min_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lower</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span> <span class="o">=</span> <span class="n">splitter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oov_token</span> <span class="o">=</span> <span class="n">oov_token</span> <span class="c1"># use 0 for __OOV__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># include oov and padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_padding</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">use_padding</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_padding</span> <span class="o">=</span> <span class="n">use_padding</span>
        <span class="n">word_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># for sequence</span>
            <span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                    <span class="n">text_split</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span><span class="p">)</span>
                    <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_split</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">text_split</span><span class="p">:</span>
                        <span class="n">word_counts</span><span class="p">[</span><span class="n">text</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span> <span class="c1"># use pre-set max_len otherwise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
            <span class="n">word_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">word_counts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_counts</span><span class="p">):</span>
        <span class="c1"># sort to guarantee the determinism of index order</span>
        <span class="n">word_counts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">word_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_freq</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_na_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">token</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_na_value</span><span class="p">:</span>
                    <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lower</span> <span class="k">else</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topk_words</span><span class="p">:</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_topk_words</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">oov_token</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s2">&quot;__OOV__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oov_token</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_padding</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s2">&quot;__PAD__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">oov_token</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># use the last index for __PAD__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">oov_token</span>

    <span class="k">def</span> <span class="nf">encode_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">categories</span><span class="p">):</span>
        <span class="n">category_indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oov_token</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">category_indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encode_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">):</span>
        <span class="n">sequence_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="ow">or</span> <span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">sequence_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sequence_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oov_token</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span><span class="p">)])</span>
        <span class="n">sequence_list</span> <span class="o">=</span> <span class="n">pad_sequences</span><span class="p">(</span><span class="n">sequence_list</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="n">truncating</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sequence_list</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load_pretrained_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">,</span> <span class="n">key_dtype</span><span class="p">,</span> <span class="n">pretrain_path</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">pretrain_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">][:]</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">key_dtype</span><span class="p">):</span> <span class="c1"># in case mismatch between int and str</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">key_dtype</span><span class="p">)</span>
            <span class="n">pretrained_vocab</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">))))</span>
            <span class="n">pretrained_emb</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">][:]</span>
        <span class="c1"># update vocab with pretrained keys, in case new token ids appear in validation or test set</span>
        <span class="n">num_new_words</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">pretrained_vocab</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__PAD__&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_words</span>
                <span class="n">num_new_words</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">+=</span> <span class="n">num_new_words</span>
        <span class="n">embedding_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.e-4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;__PAD__&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s2">&quot;__PAD__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">embedding_matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># set as zero vector for PAD</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">pretrained_vocab</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">embedding_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">word</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pretrained_emb</span><span class="p">[</span><span class="n">pretrained_vocab</span><span class="p">[</span><span class="n">word</span><span class="p">]]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">embedding_matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_vocab_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vocab_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
            <span class="n">word_counts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">word_counts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">vocab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">oov_token</span>
            
        
<span class="k">class</span> <span class="nc">Normalizer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalizer_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">normalizer_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;StandardScaler&#39;</span><span class="p">,</span> <span class="s1">&#39;MinMaxScaler&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sklearn_preprocess</span><span class="p">,</span> <span class="n">normalizer_name</span><span class="p">)()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;normalizer=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normalizer_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">null_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">null_index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">FeatureMap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">query_index</span><span class="p">,</span> <span class="n">corpus_index</span><span class="p">,</span> <span class="n">label_name</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;pytorch&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span> <span class="o">=</span> <span class="n">dataset_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_fields</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_index</span> <span class="o">=</span> <span class="n">query_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corpus_index</span> <span class="o">=</span> <span class="n">corpus_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_name</span> <span class="o">=</span> <span class="n">label_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_specs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_file</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load feature_map from json: &quot;</span> <span class="o">+</span> <span class="n">json_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">feature_map</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;dataset_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;dataset_id=</span><span class="si">{}</span><span class="s2"> does not match to feature_map!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_fields</span> <span class="o">=</span> <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;num_fields&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="n">feature_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_features&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_name</span> <span class="o">=</span> <span class="n">feature_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_specs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;feature_specs&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_file</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Save feature_map to json: &quot;</span> <span class="o">+</span> <span class="n">json_file</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">feature_map</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;dataset_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span>
        <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;num_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fields</span>
        <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;num_features&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span>
        <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;num_items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span>
        <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;query_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_index</span>
        <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;corpus_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpus_index</span>
        <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;label_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_name</span>
        <span class="n">feature_map</span><span class="p">[</span><span class="s2">&quot;feature_specs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_specs</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_num_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_source</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">feature_source</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">feature_source</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_source</span><span class="p">]</span>
        <span class="n">num_fields</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">feature_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_source</span> <span class="ow">or</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">feature_source</span><span class="p">:</span>
                <span class="n">num_fields</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">num_fields</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">FeatureEncoder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">feature_cols</span><span class="o">=</span><span class="p">[],</span> 
                 <span class="n">label_col</span><span class="o">=</span><span class="p">{},</span> 
                 <span class="n">dataset_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">data_root</span><span class="o">=</span><span class="s2">&quot;../data/&quot;</span><span class="p">,</span> 
                 <span class="n">version</span><span class="o">=</span><span class="s2">&quot;pytorch&quot;</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set up feature encoder...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;feature_encoder.pkl&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;feature_map.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete_feature_cols</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_col</span> <span class="o">=</span> <span class="n">label_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span> <span class="o">=</span> <span class="n">FeatureMap</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;query_index&quot;</span><span class="p">],</span> 
                                      <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;corpus_index&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">feat</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="nb">eval</span><span class="p">(</span><span class="n">feat</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">feat</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">feat</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">])</span> 
                               <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_cols</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_col</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoders</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_complete_feature_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">):</span>
        <span class="n">full_feature_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
            <span class="n">name_or_namelist</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_namelist</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">_name</span> <span class="ow">in</span> <span class="n">name_or_namelist</span><span class="p">:</span>
                    <span class="n">_col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">_col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_name</span>
                    <span class="n">full_feature_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">full_feature_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">full_feature_cols</span>

    <span class="k">def</span> <span class="nf">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading file: &quot;</span> <span class="o">+</span> <span class="n">data_path</span><span class="p">)</span>
            <span class="n">usecols_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype_dict</span>
            <span class="n">ddf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">usecols_fn</span><span class="p">,</span> 
                              <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span> <span class="n">memory_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ddf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ddf</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preprocess feature columns...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">query_index</span> <span class="ow">in</span> <span class="n">ddf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="c1"># for train/val/test ddf</span>
            <span class="n">all_cols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_col</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_cols</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;item&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># for item_corpus ddf</span>
            <span class="n">all_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_cols</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;item&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_cols</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ddf</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">ddf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">ddf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_na_</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">ddf</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;preprocess&quot;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;preprocess&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">preprocess_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;preprocess&quot;</span><span class="p">])</span>
                <span class="n">ddf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess_fn</span><span class="p">(</span><span class="n">ddf</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">ddf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype_dict</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="n">active_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_cols</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">]</span>
        <span class="n">ddf</span> <span class="o">=</span> <span class="n">ddf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">active_cols</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ddf</span>

    <span class="k">def</span> <span class="nf">_fill_na_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">series</span><span class="p">):</span>
        <span class="n">na_value</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;na_value&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">na_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">na_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Feature column=</span><span class="si">{}</span><span class="s2"> requires to assign na_value!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_ddf</span><span class="p">,</span> <span class="n">corpus_ddf</span><span class="p">,</span> <span class="n">min_categr_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_buckets</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>      
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fit feature encoder...&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">corpus_ddf</span><span class="p">)</span>
        <span class="n">train_ddf</span> <span class="o">=</span> <span class="n">train_ddf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">corpus_ddf</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">corpus_index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_cols</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">num_fields</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing column: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_index_col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;numeric&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_numeric_col</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">train_ddf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_categorical_col</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">train_ddf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                             <span class="n">min_categr_count</span><span class="o">=</span><span class="n">min_categr_count</span><span class="p">,</span>
                                             <span class="n">num_buckets</span><span class="o">=</span><span class="n">num_buckets</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sequence&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_sequence_col</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">train_ddf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                          <span class="n">min_categr_count</span><span class="o">=</span><span class="n">min_categr_count</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;feature_col=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature_col</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_file</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set feature encoder done.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit_index_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_col</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">feature_type</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">feature_source</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">feature_source</span><span class="p">,</span>
                                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">feature_type</span><span class="p">}</span>  

    <span class="k">def</span> <span class="nf">fit_numeric_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_col</span><span class="p">,</span> <span class="n">data_vector</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">feature_type</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">feature_source</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">feature_source</span><span class="p">,</span>
                                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">feature_type</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;embedding_callback&quot;</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;embedding_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;embedding_callback&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;normalizer&quot;</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
            <span class="n">normalizer</span> <span class="o">=</span> <span class="n">Normalizer</span><span class="p">(</span><span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;normalizer&quot;</span><span class="p">])</span>
            <span class="n">normalizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_vector</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_normalizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">num_features</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="k">def</span> <span class="nf">fit_categorical_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_col</span><span class="p">,</span> <span class="n">data_vector</span><span class="p">,</span> <span class="n">min_categr_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_buckets</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">feature_type</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">feature_source</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">min_categr_count</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_categr_count&quot;</span><span class="p">,</span> <span class="n">min_categr_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">feature_source</span><span class="p">,</span>
                                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">feature_type</span><span class="p">,</span>
                                                <span class="s2">&quot;min_categr_count&quot;</span><span class="p">:</span> <span class="n">min_categr_count</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;embedding_callback&quot;</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;embedding_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;embedding_callback&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;embedding_dim&quot;</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;embedding_dim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;embedding_dim&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;category_encoder&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
            <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="n">min_freq</span><span class="o">=</span><span class="n">min_categr_count</span><span class="p">,</span> 
                                  <span class="n">na_value</span><span class="o">=</span><span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;na_value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s2">&quot;share_embedding&quot;</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;share_embedding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;share_embedding&quot;</span><span class="p">]</span>
                <span class="n">tokenizer</span><span class="o">.</span><span class="n">set_vocab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_tokenizer&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;share_embedding&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whether_share_emb_with_sequence</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                    <span class="n">tokenizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_vector</span><span class="p">,</span> <span class="n">use_padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;pretrained_emb&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;padding_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tokenizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_vector</span><span class="p">,</span> <span class="n">use_padding</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;pretrained_emb&quot;</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading pretrained embedding: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;pretrained_emb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pretrained_</span><span class="si">{}</span><span class="s2">.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;freeze_emb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;freeze_emb&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">tokenizer</span><span class="o">.</span><span class="n">load_pretrained_embedding</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">dtype_dict</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                    <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;pretrained_emb&quot;</span><span class="p">],</span> 
                                                    <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;embedding_dim&quot;</span><span class="p">],</span>
                                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;pretrained_</span><span class="si">{}</span><span class="s2">.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">use_padding</span><span class="p">:</span> <span class="c1"># update to account pretrained keys</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;padding_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_tokenizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;vocab_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">num_features</span> <span class="o">+=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">category_encoder</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;category_encoder&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;category_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_encoder</span>
            <span class="k">if</span> <span class="n">category_encoder</span> <span class="o">==</span> <span class="s2">&quot;quantile_bucket&quot;</span><span class="p">:</span> <span class="c1"># transform numeric value to bucket</span>
                <span class="n">num_buckets</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_buckets&quot;</span><span class="p">,</span> <span class="n">num_buckets</span><span class="p">)</span>
                <span class="n">qtf</span> <span class="o">=</span> <span class="n">sklearn_preprocess</span><span class="o">.</span><span class="n">QuantileTransformer</span><span class="p">(</span><span class="n">n_quantiles</span><span class="o">=</span><span class="n">num_buckets</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">qtf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_vector</span><span class="p">)</span>
                <span class="n">boundaries</span> <span class="o">=</span> <span class="n">qtf</span><span class="o">.</span><span class="n">quantiles_</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;vocab_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_buckets</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">num_features</span> <span class="o">+=</span> <span class="n">num_buckets</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_boundaries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boundaries</span>
            <span class="k">elif</span> <span class="n">category_encoder</span> <span class="o">==</span> <span class="s2">&quot;hash_bucket&quot;</span><span class="p">:</span>
                <span class="n">num_buckets</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_buckets&quot;</span><span class="p">,</span> <span class="n">num_buckets</span><span class="p">)</span>
                <span class="n">uniques</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">data_vector</span><span class="p">)</span>
                <span class="n">num_buckets</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_buckets</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniques</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;vocab_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_buckets</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_num_buckets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_buckets</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">num_features</span> <span class="o">+=</span> <span class="n">num_buckets</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;category_encoder=</span><span class="si">{}</span><span class="s2"> not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">category_encoder</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fit_sequence_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_col</span><span class="p">,</span> <span class="n">data_vector</span><span class="p">,</span> <span class="n">min_categr_count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">feature_type</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">feature_source</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">min_categr_count</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_categr_count&quot;</span><span class="p">,</span> <span class="n">min_categr_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">feature_source</span><span class="p">,</span>
                                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">feature_type</span><span class="p">,</span>
                                                <span class="s2">&quot;min_categr_count&quot;</span><span class="p">:</span> <span class="n">min_categr_count</span><span class="p">}</span>
        <span class="n">embedding_callback</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embedding_callback&quot;</span><span class="p">,</span> <span class="s2">&quot;layers.MaskedAveragePooling()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">embedding_callback</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;embedding_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_callback</span>
        <span class="n">splitter</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;splitter&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">na_value</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;na_value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_len&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;padding&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">)</span> <span class="c1"># &quot;post&quot; or &quot;pre&quot;</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="n">min_freq</span><span class="o">=</span><span class="n">min_categr_count</span><span class="p">,</span> <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span> 
                              <span class="n">na_value</span><span class="o">=</span><span class="n">na_value</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;share_embedding&quot;</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;share_embedding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;share_embedding&quot;</span><span class="p">]</span>
            <span class="n">tokenizer</span><span class="o">.</span><span class="n">set_vocab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_tokenizer&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;share_embedding&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tokenizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_vector</span><span class="p">,</span> <span class="n">use_padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;pretrained_emb&quot;</span> <span class="ow">in</span> <span class="n">feature_col</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading pretrained embedding: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;pretrained_emb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pretrained_</span><span class="si">{}</span><span class="s2">.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;freeze_emb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;freeze_emb&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">tokenizer</span><span class="o">.</span><span class="n">load_pretrained_embedding</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">dtype_dict</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                                <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;pretrained_emb&quot;</span><span class="p">],</span> 
                                                <span class="n">feature_col</span><span class="p">[</span><span class="s2">&quot;embedding_dim&quot;</span><span class="p">],</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;pretrained_</span><span class="si">{}</span><span class="s2">.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_tokenizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;padding_idx&quot;</span><span class="p">:</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                     <span class="s2">&quot;vocab_size&quot;</span><span class="p">:</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span>
                                                     <span class="s2">&quot;max_len&quot;</span><span class="p">:</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">max_len</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">num_features</span> <span class="o">+=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab_size</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ddf</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transform feature columns...&quot;</span><span class="p">)</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">feature_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">ddf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">feature_type</span> <span class="o">=</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
                <span class="n">data_vector</span> <span class="o">=</span> <span class="n">ddf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_vector</span>
                <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s2">&quot;numeric&quot;</span><span class="p">:</span>
                    <span class="n">data_vector</span> <span class="o">=</span> <span class="n">data_vector</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature</span> <span class="o">+</span> <span class="s2">&quot;_normalizer&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">normalizer</span><span class="p">:</span>
                         <span class="n">data_vector</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_vector</span><span class="p">)</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_vector</span>
                <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="n">category_encoder</span> <span class="o">=</span> <span class="n">feature_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category_encoder&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">category_encoder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data_dict</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature</span> <span class="o">+</span> <span class="s2">&quot;_tokenizer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode_category</span><span class="p">(</span><span class="n">data_vector</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">encoder</span> <span class="o">==</span> <span class="s2">&quot;numeric_bucket&quot;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                    <span class="k">elif</span> <span class="n">encoder</span> <span class="o">==</span> <span class="s2">&quot;hash_bucket&quot;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s2">&quot;sequence&quot;</span><span class="p">:</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature</span> <span class="o">+</span> <span class="s2">&quot;_tokenizer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode_sequence</span><span class="p">(</span><span class="n">data_vector</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ddf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_dict</span>

    <span class="k">def</span> <span class="nf">_whether_share_emb_with_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;share_embedding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">feature</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sequence&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">load_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickle_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load feature encoder from cache &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pickle_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pickle_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_file</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load feature_encoder from pickle: &quot;</span> <span class="o">+</span> <span class="n">pickle_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">):</span>
            <span class="n">pickled_feature_encoder</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">pickled_feature_encoder</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">dataset_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">:</span>
                <span class="n">pickled_feature_encoder</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
                <span class="k">return</span> <span class="n">pickled_feature_encoder</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;pickle_file=</span><span class="si">{}</span><span class="s2"> not valid.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">save_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickle_file</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pickle feature_encode: &quot;</span> <span class="o">+</span> <span class="n">pickle_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">feature_encoder</span> <span class="o">=</span> <span class="n">FeatureEncoder</span><span class="p">(</span><span class="o">**</span><span class="n">Args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">build_dataset</span><span class="p">(</span><span class="n">feature_encoder</span><span class="p">,</span> <span class="n">item_corpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="n">test_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">split_type</span><span class="o">=</span><span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Build feature_map and transform h5 data &quot;&quot;&quot;</span>
    
    <span class="c1"># Load csv data</span>
    <span class="n">train_ddf</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">valid_ddf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">test_ddf</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Split data for train/validation/test</span>
    <span class="k">if</span> <span class="n">valid_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">test_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">valid_ddf</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">test_ddf</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">train_ddf</span><span class="p">,</span> <span class="n">valid_ddf</span><span class="p">,</span> <span class="n">test_ddf</span> <span class="o">=</span> <span class="n">split_train_test</span><span class="p">(</span><span class="n">train_ddf</span><span class="p">,</span> <span class="n">valid_ddf</span><span class="p">,</span> <span class="n">test_ddf</span><span class="p">,</span> 
                                                          <span class="n">valid_size</span><span class="p">,</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">split_type</span><span class="p">)</span>

    <span class="c1"># fit feature_encoder</span>
    <span class="n">corpus_ddf</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">item_corpus</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">corpus_ddf</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">corpus_ddf</span><span class="p">)</span>
    <span class="n">train_ddf</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">train_ddf</span><span class="p">)</span>
    <span class="n">feature_encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ddf</span><span class="p">,</span> <span class="n">corpus_ddf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># transform corpus_ddf</span>
    <span class="n">item_corpus_dict</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">corpus_ddf</span><span class="p">)</span>
    <span class="n">save_h5</span><span class="p">(</span><span class="n">item_corpus_dict</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feature_encoder</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;item_corpus.h5&#39;</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">item_corpus_dict</span><span class="p">,</span> <span class="n">corpus_ddf</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># transform train_ddf</span>
    <span class="n">block_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data_block_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="c1"># Num of samples in a data block</span>
    <span class="n">transform_h5</span><span class="p">(</span><span class="n">feature_encoder</span><span class="p">,</span> <span class="n">train_ddf</span><span class="p">,</span> <span class="s1">&#39;train.h5&#39;</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="n">block_size</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">train_ddf</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Transfrom valid_ddf</span>
    <span class="k">if</span> <span class="n">valid_ddf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">valid_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">valid_ddf</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid_ddf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">transform_h5</span><span class="p">(</span><span class="n">feature_encoder</span><span class="p">,</span> <span class="n">valid_ddf</span><span class="p">,</span> <span class="s1">&#39;valid.h5&#39;</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="n">block_size</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">valid_ddf</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Transfrom test_ddf</span>
    <span class="k">if</span> <span class="n">test_ddf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">test_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">test_ddf</span> <span class="o">=</span> <span class="n">feature_encoder</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test_ddf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">transform_h5</span><span class="p">(</span><span class="n">feature_encoder</span><span class="p">,</span> <span class="n">test_ddf</span><span class="p">,</span> <span class="s1">&#39;test.h5&#39;</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="n">block_size</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">test_ddf</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transform csv data to h5 done.&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">build_dataset</span><span class="p">(</span><span class="n">feature_encoder</span><span class="p">,</span> <span class="o">**</span><span class="n">Args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">TrainDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">item_corpus</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">load_h5</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_corpus_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="n">load_h5</span><span class="p">(</span><span class="n">item_corpus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">label_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_item_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">corpus_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_item_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">corpus_index</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">user_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_array_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">item_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_item_indexes</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">item_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_array_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_corpus_dict</span><span class="p">,</span> <span class="n">item_indexes</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">user_dict</span><span class="p">,</span> <span class="n">item_dict</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">item_indexes</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span>

    <span class="k">def</span> <span class="nf">slice_array_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_dict</span><span class="p">,</span> <span class="n">slice_index</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">slice_index</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">array_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">get_user2items_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">):</span>
    <span class="n">user2items_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">query_index</span><span class="p">,</span> <span class="n">corpus_index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">query_index</span><span class="p">],</span> 
                                         <span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">corpus_index</span><span class="p">]):</span>
        <span class="n">user2items_dict</span><span class="p">[</span><span class="n">query_index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corpus_index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user2items_dict</span>


<span class="k">def</span> <span class="nf">collate_fn_unique</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span> 
    <span class="c1"># TODO: check correctness</span>
    <span class="n">user_dict</span><span class="p">,</span> <span class="n">item_dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">item_indexes</span> <span class="o">=</span> <span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">num_negs</span> <span class="o">=</span> <span class="n">item_indexes</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">unique</span><span class="p">,</span> <span class="n">inverse_indexes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">item_indexes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">perm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">inverse_indexes</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">inverse_indexes</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">inverse_indexes</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">inverse_indexes</span><span class="p">,</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">inverse_indexes</span><span class="o">.</span><span class="n">flip</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">perm</span><span class="o">.</span><span class="n">flip</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">unique_indexes</span> <span class="o">=</span> <span class="n">inverse_indexes</span><span class="o">.</span><span class="n">new_empty</span><span class="p">(</span><span class="n">unique</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">scatter_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inverse_indexes</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span> <span class="c1"># obtain return_indicies in np.unique</span>
    <span class="c1"># reshape item data with (b*(num_neg + 1) x input_dim)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">item_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">item_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">end_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">unique_indexes</span><span class="p">]</span>
    <span class="c1"># add negative labels</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">labels</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">num_negs</span><span class="p">))],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user_dict</span><span class="p">,</span> <span class="n">item_dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">inverse_indexes</span>


<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="n">user_dict</span><span class="p">,</span> <span class="n">item_dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">item_indexes</span> <span class="o">=</span> <span class="n">default_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">num_negs</span> <span class="o">=</span> <span class="n">item_indexes</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1"># reshape item data with (b*(num_neg + 1) x input_dim)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">item_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">item_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">end_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># add negative labels</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">labels</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">num_negs</span><span class="p">))],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user_dict</span><span class="p">,</span> <span class="n">item_dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">sampling_block</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">block_query_indexes</span><span class="p">,</span> <span class="n">num_negs</span><span class="p">,</span> <span class="n">user2items_dict</span><span class="p">,</span> 
                   <span class="n">sampling_probs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_pos_items</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dump_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="c1"># used in multiprocessing</span>
    <span class="k">if</span> <span class="n">sampling_probs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sampling_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_items</span> <span class="c1"># uniform sampling</span>
    <span class="k">if</span> <span class="n">ignore_pos_items</span><span class="p">:</span>
        <span class="n">sampled_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">query_index</span> <span class="ow">in</span> <span class="n">block_query_indexes</span><span class="p">:</span>
            <span class="n">pos_items</span> <span class="o">=</span> <span class="n">user2items_dict</span><span class="p">[</span><span class="n">query_index</span><span class="p">]</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sampling_probs</span><span class="p">)</span>
            <span class="n">probs</span><span class="p">[</span><span class="n">pos_items</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span> <span class="c1"># renomalize to sum 1</span>
            <span class="n">sampled_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_negs</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">))</span>
        <span class="n">sampled_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sampled_items</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sampled_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span>
                                         <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block_query_indexes</span><span class="p">),</span> <span class="n">num_negs</span><span class="p">),</span> 
                                         <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dump_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># To fix bug in multiprocessing: https://github.com/xue-pai/Open-CF-Benchmarks/issues/1</span>
        <span class="n">pickle_array</span><span class="p">(</span><span class="n">sampled_array</span><span class="p">,</span> <span class="n">dump_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sampled_array</span>


<span class="k">def</span> <span class="nf">pickle_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">fout</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_pickled_array</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TrainGenerator</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
    <span class="c1"># reference https://cloud.tencent.com/developer/article/1010247</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">item_corpus</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_negs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">compress_duplicate_items</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_negs</span> <span class="o">=</span> <span class="n">num_negs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">TrainDataset</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">item_corpus</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrainGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                             <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
                                             <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn_unique</span> <span class="k">if</span> <span class="n">compress_duplicate_items</span> <span class="k">else</span> <span class="n">collate_fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user2items_dict</span> <span class="o">=</span> <span class="n">get_user2items_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">query_index</span><span class="p">]</span>
        <span class="c1"># delete some columns to speed up batch generator</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">query_index</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">corpus_index</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">label_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling_num_process</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sampling_num_process&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_pos_items</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ignore_pos_items&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_sampling_seeds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fix_sampling_seeds&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negative_sampling</span><span class="p">()</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TrainGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span> <span class="c1"># a batch iterator</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_batches</span>

    <span class="k">def</span> <span class="nf">negative_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_negs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Negative sampling num_negs=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_negs</span><span class="p">))</span>
            <span class="n">sampling_probs</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># set it to item popularity when using importance sampling</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_num_process</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">chunked_query_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_indexes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_num_process</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_sampling_seeds</span><span class="p">:</span>
                    <span class="n">seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sampling_num_process</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_num_process</span>
                <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampling_num_process</span><span class="p">)</span>
                <span class="n">block_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./tmp/pid_</span><span class="si">{}</span><span class="s2">/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">dump_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;./tmp/pid_</span><span class="si">{}</span><span class="s2">/part_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunked_query_indexes</span><span class="p">))]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">block_query_indexes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunked_query_indexes</span><span class="p">):</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">sampling_block</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> 
                                                           <span class="n">block_query_indexes</span><span class="p">,</span> 
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">num_negs</span><span class="p">,</span> 
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">user2items_dict</span><span class="p">,</span> 
                                                           <span class="n">sampling_probs</span><span class="p">,</span> 
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">ignore_pos_items</span><span class="p">,</span>
                                                           <span class="n">seeds</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                                           <span class="n">dump_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="n">block_result</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_pickled_array</span><span class="p">(</span><span class="n">dump_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunked_query_indexes</span><span class="p">))]</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;./tmp/pid_</span><span class="si">{}</span><span class="s2">/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
                <span class="n">neg_item_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">block_result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">neg_item_indexes</span> <span class="o">=</span> <span class="n">sampling_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> 
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">query_indexes</span><span class="p">,</span> 
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">num_negs</span><span class="p">,</span> 
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">user2items_dict</span><span class="p">,</span> 
                                                  <span class="n">sampling_probs</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">ignore_pos_items</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">all_item_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">pos_item_indexes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
                                                       <span class="n">neg_item_indexes</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Negative sampling done&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">load_h5</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">batch_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_array_dict</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch_dict</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span>

    <span class="k">def</span> <span class="nf">slice_array_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_index</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">slice_index</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">TestGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">item_corpus</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">user_dataset</span> <span class="o">=</span> <span class="n">TestDataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user2items_dict</span> <span class="o">=</span> <span class="n">get_user2items_dict</span><span class="p">(</span><span class="n">user_dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">)</span>
        <span class="c1"># pick users of unique query_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_indexes</span><span class="p">,</span> <span class="n">unique_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">user_dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">query_index</span><span class="p">],</span> 
                                                    <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">user_dataset</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_rows</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_dataset</span><span class="p">)</span>
        <span class="c1"># delete some columns to speed up batch generator</span>
        <span class="k">del</span> <span class="n">user_dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">query_index</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">user_dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">corpus_index</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">user_dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">label_name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">user_dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">user_dataset</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">unique_rows</span><span class="p">]</span>
        <span class="n">item_dataset</span> <span class="o">=</span> <span class="n">TestDataset</span><span class="p">(</span><span class="n">item_corpus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">user_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                      <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">item_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                      <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="h5_generator">h5_generator<a class="anchor-link" href="#h5_generator"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">h5_generator</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">train_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">item_corpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">num_negs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading data...&quot;</span><span class="p">)</span>
    <span class="n">train_gen</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">valid_gen</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">test_gen</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">]:</span>
        <span class="n">train_blocks</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
        <span class="n">valid_blocks</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_blocks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_blocks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;invalid data files or paths.&quot;</span>
        <span class="n">train_gen</span> <span class="o">=</span> <span class="n">TrainGenerator</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">train_blocks</span><span class="p">,</span> <span class="n">item_corpus</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
                                   <span class="n">num_negs</span><span class="o">=</span><span class="n">num_negs</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">valid_gen</span> <span class="o">=</span> <span class="n">TestGenerator</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">valid_blocks</span><span class="p">,</span> <span class="n">item_corpus</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
                                  <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Train samples: total/</span><span class="si">{:d}</span><span class="s2">, blocks/</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_gen</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">train_gen</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validation samples: total/</span><span class="si">{:d}</span><span class="s2">, blocks/</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valid_gen</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">valid_gen</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading train data done.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">valid_gen</span>

    <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
        <span class="n">test_blocks</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="n">test_gen</span> <span class="o">=</span> <span class="n">TestGenerator</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">test_blocks</span><span class="p">,</span> <span class="n">item_corpus</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
                                 <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test samples: total/</span><span class="si">{:d}</span><span class="s2">, blocks/</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_gen</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">test_gen</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading test data done.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">test_gen</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading data done.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">valid_gen</span><span class="p">,</span> <span class="n">test_gen</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">()</span>
<span class="n">args</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="s1">&#39;/content/train.h5&#39;</span>
<span class="n">args</span><span class="o">.</span><span class="n">valid_data</span> <span class="o">=</span> <span class="s1">&#39;/content/valid.h5&#39;</span>
<span class="c1"># args.test_data = &#39;/content/valid.h5&#39;</span>
<span class="n">args</span><span class="o">.</span><span class="n">item_corpus</span> <span class="o">=</span> <span class="s1">&#39;/content/item_corpus.h5&#39;</span>
<span class="c1"># train_gen, valid_gen, test_gen = h5_generator(feature_encoder.feature_map, **args.__dict__)</span>
<span class="n">train_gen</span><span class="p">,</span> <span class="n">valid_gen</span> <span class="o">=</span> <span class="n">h5_generator</span><span class="p">(</span><span class="n">feature_encoder</span><span class="o">.</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">SoftmaxCrossEntropyLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param num_negs: number of negative instances in bpr loss.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SoftmaxCrossEntropyLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param y_true: Labels</span>
<span class="sd">        :param y_pred: Predicted result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hit_probs</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hit_probs</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loss</span>


<span class="k">class</span> <span class="nc">CosineContrastiveLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">negative_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param margin: float, margin in CosineContrastiveLoss</span>
<span class="sd">        :param num_negs: int, number of negative samples</span>
<span class="sd">        :param negative_weight:, float, the weight set to the negative samples. When negative_weight=None, it</span>
<span class="sd">            equals to num_negs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CosineContrastiveLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_margin</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negative_weight</span> <span class="o">=</span> <span class="n">negative_weight</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param y_pred: prdicted values of shape (batch_size, 1 + num_negs) </span>
<span class="sd">        :param y_true: true labels of shape (batch_size, 1 + num_negs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos_logits</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">pos_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pos_logits</span><span class="p">)</span>
        <span class="n">neg_logits</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">neg_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">neg_logits</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_margin</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_weight</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">pos_loss</span> <span class="o">+</span> <span class="n">neg_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_weight</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">pos_loss</span> <span class="o">+</span> <span class="n">neg_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">MSELoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MSELoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param y_pred: prdicted values of shape (batch_size, 1 + num_negs) </span>
<span class="sd">        :param y_true: true labels of shape (batch_size, 1 + num_negs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos_logits</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">pos_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">pos_logits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">neg_logits</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">neg_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">neg_logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">pos_loss</span> <span class="o">+</span> <span class="n">neg_loss</span>
        <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PairwiseLogisticLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PairwiseLogisticLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param y_true: Labels</span>
<span class="sd">        :param y_pred: Predicted result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos_logits</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">neg_logits</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">logits_diff</span> <span class="o">=</span> <span class="n">pos_logits</span> <span class="o">-</span> <span class="n">neg_logits</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits_diff</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loss</span>


<span class="k">class</span> <span class="nc">PairwiseMarginLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param num_negs: number of negative instances in bpr loss.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PairwiseMarginLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_margin</span> <span class="o">=</span> <span class="n">margin</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param y_true: Labels</span>
<span class="sd">        :param y_pred: Predicted result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos_logits</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">neg_logits</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_margin</span> <span class="o">+</span> <span class="n">neg_logits</span> <span class="o">-</span> <span class="n">pos_logits</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loss</span>


<span class="k">class</span> <span class="nc">SigmoidCrossEntropyLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param num_negs: number of negative instances in bpr loss.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SigmoidCrossEntropyLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param y_true: Labels</span>
<span class="sd">        :param y_pred: Predicted result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">y_true</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">feature_map</span><span class="p">,</span> 
                 <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;BaseModel&quot;</span><span class="p">,</span> 
                 <span class="n">gpu</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;AUC&quot;</span><span class="p">,</span> 
                 <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">monitor_mode</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> 
                 <span class="n">patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                 <span class="n">eval_interval_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">embedding_regularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">net_regularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">reduce_lr_on_plateau</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">embedding_initializer</span><span class="o">=</span><span class="s2">&quot;lambda w: nn.init.normal_(w, std=1e-4)&quot;</span><span class="p">,</span> 
                 <span class="n">num_negs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">set_device</span><span class="p">(</span><span class="n">gpu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span> <span class="o">=</span> <span class="n">feature_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span> <span class="o">=</span> <span class="n">Monitor</span><span class="p">(</span><span class="n">kv</span><span class="o">=</span><span class="n">monitor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_mode</span> <span class="o">=</span> <span class="n">monitor_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patience</span> <span class="o">=</span> <span class="n">patience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eval_interval_epochs</span> <span class="o">=</span> <span class="n">eval_interval_epochs</span> <span class="c1"># float acceptable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_best_only</span> <span class="o">=</span> <span class="n">save_best_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_regularizer</span> <span class="o">=</span> <span class="n">embedding_regularizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_net_regularizer</span> <span class="o">=</span> <span class="n">net_regularizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_lr_on_plateau</span> <span class="o">=</span> <span class="n">reduce_lr_on_plateau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_initializer</span> <span class="o">=</span> <span class="n">embedding_initializer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model_root&quot;</span><span class="p">],</span> <span class="n">feature_map</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">+</span> <span class="s2">&quot;.model&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_metrics</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_negs</span> <span class="o">=</span> <span class="n">num_negs</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">set_optimizer</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;optimizer=</span><span class="si">{}</span><span class="s2"> is not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">optimizer</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;SigmoidCrossEntropyLoss&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">SigmoidCrossEntropyLoss</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;PairwiseLogisticLoss&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">PairwiseLogisticLoss</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;SoftmaxCrossEntropyLoss&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropyLoss</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;PairwiseMarginLoss&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">PairwiseMarginLoss</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;margin&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;MSELoss&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">MSELoss</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;CosineContrastiveLoss&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">CosineContrastiveLoss</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;margin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                        <span class="n">negative_weight</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;negative_weight&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;loss=</span><span class="si">{}</span><span class="s2"> is not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_total_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
        <span class="c1"># y_pred: N x (1 + num_negs) </span>
        <span class="c1"># y_true:  N x (1 + num_negs) </span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_regularizer</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_net_regularizer</span><span class="p">:</span>
            <span class="n">emb_reg</span> <span class="o">=</span> <span class="n">set_regularizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_embedding_regularizer</span><span class="p">)</span>
            <span class="n">net_reg</span> <span class="o">=</span> <span class="n">set_regularizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_regularizer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;embedding_layer&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_regularizer</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">emb_p</span><span class="p">,</span> <span class="n">emb_lambda</span> <span class="ow">in</span> <span class="n">emb_reg</span><span class="p">:</span>
                                <span class="n">total_loss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">emb_lambda</span> <span class="o">/</span> <span class="n">emb_p</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">emb_p</span><span class="p">)</span> <span class="o">**</span> <span class="n">emb_p</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_net_regularizer</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">net_p</span><span class="p">,</span> <span class="n">net_lambda</span> <span class="ow">in</span> <span class="n">net_reg</span><span class="p">:</span>
                                <span class="n">total_loss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">net_lambda</span> <span class="o">/</span> <span class="n">net_p</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">net_p</span><span class="p">)</span> <span class="o">**</span> <span class="n">net_p</span>
        <span class="k">return</span> <span class="n">total_loss</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;pretrained_emb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="c1"># skip pretrained</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">initialize_emb</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_embedding_initializer</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">padding_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># using the last index as padding_idx</span>
                            <span class="n">initialize_emb</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">initialize_emb</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;embedding_initializer=</span><span class="si">{}</span><span class="s2"> is not supported.&quot;</span>\
                                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_embedding_initializer</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">:</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">to_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputs</span>

    <span class="k">def</span> <span class="nf">on_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_generator</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_batches</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">batch_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_interval_batches</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">batch_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batches_per_epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">val_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_generator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_gen</span><span class="p">)</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_batches</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batches_per_epoch</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_and_earlystop</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">val_logs</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> batches finished ---&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batches_per_epoch</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">reduce_learning_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
            <span class="n">reduced_lr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">param_group</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">min_lr</span><span class="p">)</span>
            <span class="n">param_group</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduced_lr</span>
        <span class="k">return</span> <span class="n">reduced_lr</span>

    <span class="k">def</span> <span class="nf">checkpoint_and_earlystop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">logs</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">monitor_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_mode</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span> <span class="ow">and</span> <span class="n">monitor_value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_metric</span> <span class="o">-</span> <span class="n">min_delta</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="ow">and</span> <span class="n">monitor_value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_metric</span> <span class="o">+</span> <span class="n">min_delta</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stopping_steps</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Monitor(</span><span class="si">{}</span><span class="s2">) STOP: </span><span class="si">{:.6f}</span><span class="s2"> !&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_mode</span><span class="p">,</span> <span class="n">monitor_value</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_lr_on_plateau</span><span class="p">:</span>
                <span class="n">current_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_learning_rate</span><span class="p">()</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reduce learning rate on plateau: </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_lr</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load best model: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stopping_steps</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_metric</span> <span class="o">=</span> <span class="n">monitor_value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_best_only</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Save best model: monitor(</span><span class="si">{}</span><span class="s2">): </span><span class="si">{:.6f}</span><span class="s2">&quot;</span>\
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_mode</span><span class="p">,</span> <span class="n">monitor_value</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopping_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_interval_epochs</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patience</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Early stopping at epoch=</span><span class="si">{:g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_best_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span>
     
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_generator</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">valid_generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_gradient_norm</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_gen</span> <span class="o">=</span> <span class="n">valid_generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_gradient_norm</span> <span class="o">=</span> <span class="n">max_gradient_norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_mode</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopping_steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_batches</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batches_per_epoch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_generator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eval_interval_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eval_interval_epochs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batches_per_epoch</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;**** Start training: </span><span class="si">{}</span><span class="s2"> batches/epoch ****&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batches_per_epoch</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
            <span class="n">epoch_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_on_epoch</span><span class="p">(</span><span class="n">train_generator</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Train loss: </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;************ Epoch=</span><span class="si">{}</span><span class="s2"> end ************&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Training finished.&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load best model: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_on_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_generator</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">batch_generator</span> <span class="o">=</span> <span class="n">train_generator</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">batch_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_generator</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="c1">#, file=sys.stdout)</span>
        <span class="k">for</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">batch_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_generator</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">return_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">return_dict</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_gradient_norm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_batch_end</span><span class="p">(</span><span class="n">train_generator</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">epoch_loss</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batches_per_epoch</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_generator</span><span class="p">,</span> <span class="n">valid_generator</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--- Start evaluation ---&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># set to evaluation mode</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">user_vecs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">item_vecs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">user_batch</span> <span class="ow">in</span> <span class="n">valid_generator</span><span class="o">.</span><span class="n">user_loader</span><span class="p">:</span>
                <span class="n">user_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tower</span><span class="p">(</span><span class="n">user_batch</span><span class="p">)</span>
                <span class="n">user_vecs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">user_vec</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">item_batch</span> <span class="ow">in</span> <span class="n">valid_generator</span><span class="o">.</span><span class="n">item_loader</span><span class="p">:</span>
                <span class="n">item_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_tower</span><span class="p">(</span><span class="n">item_batch</span><span class="p">)</span>
                <span class="n">item_vecs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item_vec</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">user_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">user_vecs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">item_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item_vecs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">val_logs</span> <span class="o">=</span> <span class="n">evaluate_metrics</span><span class="p">(</span><span class="n">user_vecs</span><span class="p">,</span>
                                        <span class="n">item_vecs</span><span class="p">,</span>
                                        <span class="n">train_generator</span><span class="o">.</span><span class="n">user2items_dict</span><span class="p">,</span>
                                        <span class="n">valid_generator</span><span class="o">.</span><span class="n">user2items_dict</span><span class="p">,</span>
                                        <span class="n">valid_generator</span><span class="o">.</span><span class="n">query_indexes</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_metrics</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val_logs</span>
                
    <span class="k">def</span> <span class="nf">save_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">checkpoint</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">count_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count_embedding</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">total_params</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">count_embedding</span> <span class="ow">and</span> <span class="s2">&quot;embedding&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                <span class="n">total_params</span> <span class="o">+=</span> <span class="n">param</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total number of parameters: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_params</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">EmbeddingLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">feature_map</span><span class="p">,</span>
                 <span class="n">embedding_dim</span><span class="p">,</span>
                 <span class="n">disable_sharing_pretrain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">required_feature_columns</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">not_required_feature_columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EmbeddingLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layer</span> <span class="o">=</span> <span class="n">EmbeddingDictLayer</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> 
                                                  <span class="n">embedding_dim</span><span class="p">,</span>
                                                  <span class="n">disable_sharing_pretrain</span><span class="o">=</span><span class="n">disable_sharing_pretrain</span><span class="p">,</span>
                                                  <span class="n">required_feature_columns</span><span class="o">=</span><span class="n">required_feature_columns</span><span class="p">,</span>
                                                  <span class="n">not_required_feature_columns</span><span class="o">=</span><span class="n">not_required_feature_columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">feature_source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">feature_emb_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layer</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">feature_source</span><span class="o">=</span><span class="n">feature_source</span><span class="p">)</span>
        <span class="n">feature_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layer</span><span class="o">.</span><span class="n">dict2tensor</span><span class="p">(</span><span class="n">feature_emb_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feature_emb</span>


<span class="k">class</span> <span class="nc">EmbeddingDictLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">feature_map</span><span class="p">,</span> 
                 <span class="n">embedding_dim</span><span class="p">,</span>
                 <span class="n">disable_sharing_pretrain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">required_feature_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">not_required_feature_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EmbeddingDictLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_map</span> <span class="o">=</span> <span class="n">feature_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_feature_columns</span> <span class="o">=</span> <span class="n">required_feature_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_required_feature_columns</span> <span class="o">=</span> <span class="n">not_required_feature_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_callbacks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">feature_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_required</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">disable_sharing_pretrain</span><span class="p">:</span> <span class="c1"># in case for LR</span>
                    <span class="k">assert</span> <span class="n">embedding_dim</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="n">feat_emb_dim</span> <span class="o">=</span> <span class="n">embedding_dim</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">feat_emb_dim</span> <span class="o">=</span> <span class="n">feature_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embedding_dim&quot;</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">disable_sharing_pretrain</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;embedding_callback&quot;</span> <span class="ow">in</span> <span class="n">feature_spec</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_callbacks</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;embedding_callback&quot;</span><span class="p">])</span>
                <span class="c1"># Set embedding_layer according to share_embedding</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">disable_sharing_pretrain</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;share_embedding&quot;</span> <span class="ow">in</span> <span class="n">feature_spec</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span><span class="p">[</span><span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;share_embedding&quot;</span><span class="p">]]</span>
                    <span class="k">continue</span>
                    
                <span class="k">if</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;numeric&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">feat_emb_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="n">padding_idx</span> <span class="o">=</span> <span class="n">feature_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;padding_idx&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">embedding_matrix</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;vocab_size&quot;</span><span class="p">],</span> 
                                                    <span class="n">feat_emb_dim</span><span class="p">,</span>
                                                    <span class="n">padding_idx</span><span class="o">=</span><span class="n">padding_idx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">disable_sharing_pretrain</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;pretrained_emb&quot;</span> <span class="ow">in</span> <span class="n">feature_spec</span><span class="p">:</span>
                        <span class="n">embedding_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pretrained_embedding</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="p">,</span>
                                                                          <span class="n">feature_map</span><span class="p">,</span> 
                                                                          <span class="n">feature_name</span><span class="p">,</span> 
                                                                          <span class="n">freeze</span><span class="o">=</span><span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;freeze_emb&quot;</span><span class="p">],</span>
                                                                          <span class="n">padding_idx</span><span class="o">=</span><span class="n">padding_idx</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_matrix</span>
                <span class="k">elif</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sequence&quot;</span><span class="p">:</span>
                    <span class="n">padding_idx</span> <span class="o">=</span> <span class="n">feature_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;padding_idx&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">embedding_matrix</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;vocab_size&quot;</span><span class="p">],</span> 
                                                    <span class="n">feat_emb_dim</span><span class="p">,</span> 
                                                    <span class="n">padding_idx</span><span class="o">=</span><span class="n">padding_idx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">disable_sharing_pretrain</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;pretrained_emb&quot;</span> <span class="ow">in</span> <span class="n">feature_spec</span><span class="p">:</span>
                        <span class="n">embedding_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pretrained_embedding</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="p">,</span> 
                                                                          <span class="n">feature_map</span><span class="p">,</span> 
                                                                          <span class="n">feature_name</span><span class="p">,</span>
                                                                          <span class="n">freeze</span><span class="o">=</span><span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;freeze_emb&quot;</span><span class="p">],</span>
                                                                          <span class="n">padding_idx</span><span class="o">=</span><span class="n">padding_idx</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_matrix</span>

    <span class="k">def</span> <span class="nf">is_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check whether feature is required for embedding &quot;&quot;&quot;</span>
        <span class="n">feature_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_feature_columns</span> <span class="ow">and</span> <span class="p">(</span><span class="n">feature</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_feature_columns</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_required_feature_columns</span> <span class="ow">and</span> <span class="p">(</span><span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_required_feature_columns</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_pretrained_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretrained_path</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">pretrained_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="n">embeddings</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="n">feature_name</span><span class="p">][:]</span>
        <span class="k">return</span> <span class="n">embeddings</span>

    <span class="k">def</span> <span class="nf">load_pretrained_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embedding_matrix</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">,</span> <span class="n">freeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">pretrained_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feature_map</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="p">[</span><span class="n">feature_name</span><span class="p">][</span><span class="s2">&quot;pretrained_emb&quot;</span><span class="p">])</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pretrained_embedding</span><span class="p">(</span><span class="n">pretrained_path</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">padding_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">embeddings</span><span class="p">[</span><span class="n">padding_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">embedding_matrix</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
            <span class="n">embedding_matrix</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">embedding_matrix</span>

    <span class="k">def</span> <span class="nf">dict2tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embedding_dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">feature_emb</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">embedding_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">embedding_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feature_emb</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">feature_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">feature_emb_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">feature_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_map</span><span class="o">.</span><span class="n">feature_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">feature_source</span> <span class="ow">and</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">feature_source</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">feature_type</span> <span class="ow">and</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">feature_type</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;numeric&quot;</span><span class="p">:</span>
                    <span class="n">inp</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span><span class="p">[</span><span class="n">feature</span><span class="p">](</span><span class="n">inp</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="n">inp</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
                    <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span><span class="p">[</span><span class="n">feature</span><span class="p">](</span><span class="n">inp</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">feature_spec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sequence&quot;</span><span class="p">:</span>
                    <span class="n">inp</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
                    <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layers</span><span class="p">[</span><span class="n">feature</span><span class="p">](</span><span class="n">inp</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_callbacks</span><span class="p">:</span>
                    <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_callbacks</span><span class="p">[</span><span class="n">feature</span><span class="p">](</span><span class="n">embeddings</span><span class="p">)</span>     
                <span class="n">feature_emb_dict</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">embeddings</span>
        <span class="k">return</span> <span class="n">feature_emb_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">SimpleX</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">feature_map</span><span class="p">,</span> 
                 <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;SimpleX&quot;</span><span class="p">,</span> 
                 <span class="n">gpu</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> 
                 <span class="n">embedding_initializer</span><span class="o">=</span><span class="s2">&quot;lambda w: nn.init.normal_(w, std=1e-4)&quot;</span><span class="p">,</span> 
                 <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                 <span class="n">user_id_field</span><span class="o">=</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span>
                 <span class="n">item_id_field</span><span class="o">=</span><span class="s2">&quot;item_id&quot;</span><span class="p">,</span>
                 <span class="n">user_history_field</span><span class="o">=</span><span class="s2">&quot;user_history&quot;</span><span class="p">,</span>
                 <span class="n">enable_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">num_negs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">net_dropout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">aggregator</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
                 <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">attention_dropout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">net_regularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">embedding_regularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">similarity_score</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleX</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> 
                                      <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span> 
                                      <span class="n">gpu</span><span class="o">=</span><span class="n">gpu</span><span class="p">,</span> 
                                      <span class="n">embedding_regularizer</span><span class="o">=</span><span class="n">embedding_regularizer</span><span class="p">,</span>
                                      <span class="n">net_regularizer</span><span class="o">=</span><span class="n">net_regularizer</span><span class="p">,</span>
                                      <span class="n">num_negs</span><span class="o">=</span><span class="n">num_negs</span><span class="p">,</span>
                                      <span class="n">embedding_initializer</span><span class="o">=</span><span class="n">embedding_initializer</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_score</span> <span class="o">=</span> <span class="n">similarity_score</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="n">embedding_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id_field</span> <span class="o">=</span> <span class="n">user_id_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history_field</span> <span class="o">=</span> <span class="n">user_history_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layer</span> <span class="o">=</span> <span class="n">EmbeddingDictLayer</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_aggregation</span> <span class="o">=</span> <span class="n">BehaviorAggregator</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> 
                                                       <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                                                       <span class="n">aggregator</span><span class="o">=</span><span class="n">aggregator</span><span class="p">,</span> 
                                                       <span class="n">dropout_rate</span><span class="o">=</span><span class="n">attention_dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_bias</span> <span class="o">=</span> <span class="n">enable_bias</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_bias</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_bias</span> <span class="o">=</span> <span class="n">EmbeddingLayer</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                            <span class="n">disable_sharing_pretrain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                            <span class="n">required_feature_columns</span><span class="o">=</span><span class="p">[</span><span class="n">user_id_field</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_bias</span> <span class="o">=</span> <span class="n">EmbeddingLayer</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> 
                                            <span class="n">disable_sharing_pretrain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                            <span class="n">required_feature_columns</span><span class="o">=</span><span class="p">[</span><span class="n">item_id_field</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">net_dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inputs: [user_dict, item_dict, label]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_dict</span><span class="p">,</span> <span class="n">item_dict</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">user_vecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tower</span><span class="p">(</span><span class="n">user_dict</span><span class="p">)</span>
        <span class="n">user_vecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">user_vecs</span><span class="p">)</span>
        <span class="n">item_vecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_tower</span><span class="p">(</span><span class="n">item_dict</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">item_vecs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">user_vecs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_negs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
                           <span class="n">user_vecs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_bias</span><span class="p">:</span> <span class="c1"># user_bias and global_bias only influence training, but not inference for ranking</span>
            <span class="n">y_pred</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_bias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">user_dict</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_bias</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_loss</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s2">&quot;y_pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">return_dict</span>

    <span class="k">def</span> <span class="nf">user_tower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">user_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">user_emb_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layer</span><span class="p">(</span><span class="n">user_inputs</span><span class="p">,</span> <span class="n">feature_source</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
        <span class="n">user_id_emb</span> <span class="o">=</span> <span class="n">user_emb_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id_field</span><span class="p">]</span>
        <span class="n">user_history_emb</span> <span class="o">=</span> <span class="n">user_emb_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_history_field</span><span class="p">]</span>
        <span class="n">user_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_aggregation</span><span class="p">(</span><span class="n">user_id_emb</span><span class="p">,</span> <span class="n">user_history_emb</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_score</span> <span class="o">==</span> <span class="s2">&quot;cosine&quot;</span><span class="p">:</span>
            <span class="n">user_vec</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">user_vec</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_bias</span><span class="p">:</span> 
            <span class="n">user_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_vec</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">user_vec</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user_vec</span>

    <span class="k">def</span> <span class="nf">item_tower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">item_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">item_vec_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layer</span><span class="p">(</span><span class="n">item_inputs</span><span class="p">,</span> <span class="n">feature_source</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">)</span>
        <span class="n">item_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_layer</span><span class="o">.</span><span class="n">dict2tensor</span><span class="p">(</span><span class="n">item_vec_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_score</span> <span class="o">==</span> <span class="s2">&quot;cosine&quot;</span><span class="p">:</span>
            <span class="n">item_vec</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">item_vec</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_bias</span><span class="p">:</span>
            <span class="n">item_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">item_vec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_bias</span><span class="p">(</span><span class="n">item_inputs</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item_vec</span>


<span class="k">class</span> <span class="nc">BehaviorAggregator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">aggregator</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BehaviorAggregator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="o">=</span> <span class="n">aggregator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cross_attention&quot;</span><span class="p">,</span> <span class="s2">&quot;self_attention&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">),</span>
                                     <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)</span> <span class="k">if</span> <span class="n">dropout_rate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="o">==</span> <span class="s2">&quot;self_attention&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_emb</span><span class="p">,</span> <span class="n">sequence_emb</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">id_emb</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_pooling</span><span class="p">(</span><span class="n">sequence_emb</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="o">==</span> <span class="s2">&quot;cross_attention&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_attention</span><span class="p">(</span><span class="n">id_emb</span><span class="p">,</span> <span class="n">sequence_emb</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="o">==</span> <span class="s2">&quot;self_attention&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attention</span><span class="p">(</span><span class="n">sequence_emb</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">id_emb</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">cross_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_emb</span><span class="p">,</span> <span class="n">sequence_emb</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">(</span><span class="n">sequence_emb</span><span class="p">)</span> <span class="c1"># b x seq_len x attention_dim</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">sequence_emb</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">id_emb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># b x seq_len</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masked_softmax</span><span class="p">(</span><span class="n">attention</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">attention</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">attention</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">sequence_emb</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">self_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_emb</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">(</span><span class="n">sequence_emb</span><span class="p">)</span> <span class="c1"># b x seq_len x attention_dim</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">sequence_emb</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># b x seq_len</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masked_softmax</span><span class="p">(</span><span class="n">attention</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">attention</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">attention</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">sequence_emb</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">average_pooling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_emb</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">sequence_emb</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">sequence_emb</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.e-12</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">masked_softmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="c1"># use the following softmax to avoid nans when a sequence is entirely masked</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">masked_fill_</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">e_X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e_X</span> <span class="o">/</span> <span class="p">(</span><span class="n">e_X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.e-12</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">SimpleX</span><span class="p">(</span><span class="n">feature_encoder</span><span class="o">.</span><span class="n">feature_map</span><span class="p">,</span> <span class="o">**</span><span class="n">Args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SimpleX(
  (embedding_layer): EmbeddingDictLayer(
    (embedding_layers): ModuleDict(
      (user_id): Embedding(944, 64)
      (user_history): Embedding(1615, 64, padding_idx=1614)
      (item_id): Embedding(1614, 64)
    )
    (embedding_callbacks): ModuleDict()
  )
  (behavior_aggregation): BehaviorAggregator(
    (W_v): Linear(in_features=64, out_features=64, bias=False)
  )
  (dropout): Dropout(p=0, inplace=False)
  (loss_fn): CosineContrastiveLoss()
)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">()</span> <span class="c1"># print number of parameters used in model</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">for</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">batch_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_gen</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;user_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>torch.Size([32, 100])
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Danger:Didn't worked!</p>
</blockquote>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_generator</span><span class="o">=</span><span class="n">train_gen</span><span class="p">,</span> <span class="n">valid_generator</span><span class="o">=</span><span class="n">valid_gen</span><span class="p">,</span> <span class="o">**</span><span class="n">Args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>  0%|          | 0/2500 [00:00&lt;?, ?it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-55-3b943f407e36&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>model<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>train_generator<span class="ansi-blue-fg">=</span>train_gen<span class="ansi-blue-fg">,</span> valid_generator<span class="ansi-blue-fg">=</span>valid_gen<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>Args<span class="ansi-blue-fg">.</span>__dict__<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-49-4280415101aa&gt;</span> in <span class="ansi-cyan-fg">fit</span><span class="ansi-blue-fg">(self, train_generator, epochs, valid_generator, verbose, max_gradient_norm, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    160</span>         logging<span class="ansi-blue-fg">.</span>info<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;**** Start training: {} batches/epoch ****&#34;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_batches_per_epoch<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    161</span>         <span class="ansi-green-fg">for</span> epoch <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>epochs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 162</span><span class="ansi-red-fg">             </span>epoch_loss <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>train_on_epoch<span class="ansi-blue-fg">(</span>train_generator<span class="ansi-blue-fg">,</span> epoch<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    163</span>             logging<span class="ansi-blue-fg">.</span>info<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;Train loss: {:.6f}&#34;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>epoch_loss<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    164</span>             <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>_stop_training<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">&lt;ipython-input-49-4280415101aa&gt;</span> in <span class="ansi-cyan-fg">train_on_epoch</span><span class="ansi-blue-fg">(self, train_generator, epoch)</span>
<span class="ansi-green-intense-fg ansi-bold">    178</span>         <span class="ansi-green-fg">for</span> batch_index<span class="ansi-blue-fg">,</span> batch_data <span class="ansi-green-fg">in</span> enumerate<span class="ansi-blue-fg">(</span>batch_generator<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    179</span>             self<span class="ansi-blue-fg">.</span>optimizer<span class="ansi-blue-fg">.</span>zero_grad<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 180</span><span class="ansi-red-fg">             </span>return_dict <span class="ansi-blue-fg">=</span> model<span class="ansi-blue-fg">.</span>forward<span class="ansi-blue-fg">(</span>batch_data<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    181</span>             loss <span class="ansi-blue-fg">=</span> return_dict<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#34;loss&#34;</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">    182</span>             loss<span class="ansi-blue-fg">.</span>backward<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-51-a4cd18815685&gt;</span> in <span class="ansi-cyan-fg">forward</span><span class="ansi-blue-fg">(self, inputs)</span>
<span class="ansi-green-intense-fg ansi-bold">     59</span>         user_vecs <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dropout<span class="ansi-blue-fg">(</span>user_vecs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     60</span>         item_vecs <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>item_tower<span class="ansi-blue-fg">(</span>item_dict<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 61</span><span class="ansi-red-fg">         y_pred = torch.bmm(item_vecs.view(user_vecs.size(0), self.num_negs + 1, -1), 
</span><span class="ansi-green-intense-fg ansi-bold">     62</span>                            user_vecs.unsqueeze(-1)).squeeze(-1)
<span class="ansi-green-intense-fg ansi-bold">     63</span>         <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>enable_bias<span class="ansi-blue-fg">:</span> <span class="ansi-red-fg"># user_bias and global_bias only influence training, but not inference for ranking</span>

<span class="ansi-red-fg">RuntimeError</span>: shape &#39;[32, 21, -1]&#39; is invalid for input of size 22528</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/2022/01/24/simplex-mf.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
