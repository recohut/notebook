<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AGGN Cold-start Recommendation on ML-100k | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="AGGN Cold-start Recommendation on ML-100k" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/24/agnn.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/24/agnn.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-24T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AGGN Cold-start Recommendation on ML-100k" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-24T00:00:00-06:00","datePublished":"2022-01-24T00:00:00-06:00","description":"Jupyter notebook database.","headline":"AGGN Cold-start Recommendation on ML-100k","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/24/agnn.html"},"url":"https://nb.recohut.com/2022/01/24/agnn.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">AGGN Cold-start Recommendation on ML-100k</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-24T00:00:00-06:00" itemprop="datePublished">
        Jan 24, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      17 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-24-agnn.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-24-agnn.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-24-agnn.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-24-agnn.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-24-agnn.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://github.com/recohut/coldstart-recsys/raw/da72950ca514faee94f010a2cb6e99a373044ec1/docs/_images/T290734_1.png" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">Introduction<a class="anchor-link" href="#Introduction"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Input-Layer">Input Layer<a class="anchor-link" href="#Input-Layer"> </a></h3><p>We first design an input layer to build the user (item) attribute graph $\mathcal{A}_u$ ($\mathcal{A}_i$). We calculate two kinds of proximity scores between the nodes - preference proximity and attribute proximity (can be calculated with cosine similarity).</p>
<ul>
<li>The preference proximity measures the historical preference similarity between two nodes. If two users have similar rating record list (or two items have similar rated record list), they will have a high preference proximity. Note we cannot calculate preference proximity for the cold start nodes as they do not have the historical ratings.</li>
<li>The attribute proximity measures the similarity between the attributes of two nodes. If two users have similar user profiles, e.g., gender, occupation (or two items have similar properties, e.g., category), they will have a high attribute proximity.</li>
</ul>
<p>After calculating the overall proximity between two nodes, it becomes a natural choice to build a k-NN graph as adopted in (Monti, Bronstein, and Bresson 2017). Such a method will keep a fixed number of neighbors once the graph is constructed.</p>
<h3 id="Attribute-Interaction-Layer">Attribute Interaction Layer<a class="anchor-link" href="#Attribute-Interaction-Layer"> </a></h3><p>In the constructed attribute graph $\mathcal{A}_u$ and $\mathcal{A}_i$, each nodes has an attached multi-hot attribute encoding and a unique one-hot representation denoting its identity. Due to the huge number of users and items in the web-scale recommender systems, the dimensionality of nodes’ one-hot representation is extremely high. Moreover, the multi-hot attribute representation simply combines multiple types of attributes into one long vector without considering their interactive relations. The goal of interaction layer is to reduce the dimensionality for one-hot identity representation and learn the high-order attribute interactions for multi-hot attribute representation. To this end, we first set up a lookup table to transform a node’s one-hot representation into the low-dimensional dense vector. The lookup layers correspond to two parameter matrices $M \in \mathbb{R}^{M×D}$ and $N \in \mathbb{R}^{ N×D}$. Each entry $m_u \in \mathbb{R}^D$ and $n_i \in \mathbb{R}^D$ encodes the user $u$’s preference and the item $i$’s property, respectively. Note that $m_u$ and $n_i$ for cold start nodes are meaningless, since no interaction is observed to train their preference embedding. Inspired by (He and Chua 2017), we capture the high-order attribute interactions with a <strong><em>Bi-Interactive pooling operation</em></strong>, in addition to the linear combination operation.</p>
<h3 id="Gated-GNN-Layer">Gated GNN Layer<a class="anchor-link" href="#Gated-GNN-Layer"> </a></h3><p>Intuitively, different neighbors have different relations to a node. Furthermore, one neighbor usually has multiple attributes. For example, in a social network, a user’s neighborhood may consist of classmates, family members, colleagues, and so on, and each neighbor may have several attributes such as age, gender, and occupation. Since all these attributes (along with the preferences) are now encoded in the node’s embedding, it is necessary to pay different attentions to different dimensions of the neighbor node’s embedding. However, existing GCN (Kipf and Welling 2017) or GAT (Veliˇckovi´c et al. 2018) structures cannot do this because they are at the coarse granularity. GCN treats all neighbors equally and GAT differentiates the importance of neighbors at the node level. To solve this problem, we design a gated-GNN structure to aggregate the fine-grained neighbor information.</p>
<h3 id="Prediction-Layer">Prediction Layer<a class="anchor-link" href="#Prediction-Layer"> </a></h3><p>Given a user $u$’s final representation $\tilde{p}_u$ and an item $i$’s final representation $\tilde{q}_i$ after the gated-GNN layer, we model the predicted rating of the user $u$ to the item $i$ as:</p>
<p>
$$\hat{R}_{u,i} = MLP([\tilde{p}_u; \tilde{q}_i]) + \tilde{p}_u\tilde{q}_i^T + b_u + b_i + \mu,$$
</p>
<p>where the MLP function is the multilayer perceptron implemented with one hidden layer, and $b_u$, $b_i$ , and $\mu$ denotes user bias, item bias, and global bias, respectively. The second term is inner product interaction function (Koren, Bell, and Volinsky 2009), and we add the first term to capture the complicated nonlinear interaction between the user and the item.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Solution-to-Cold-Start-Problem">Solution to Cold Start Problem<a class="anchor-link" href="#Solution-to-Cold-Start-Problem"> </a></h3><p>The cold start problem is caused by the lack of historical interactions for cold start nodes. We view this as a missing preference problem, and solve it by employing the variational autoencoder structure to reconstruct the preference from the attribute distribution.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://github.com/recohut/coldstart-recsys/raw/da72950ca514faee94f010a2cb6e99a373044ec1/docs/_images/T290734_2.png" alt="" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Loss-Functions">Loss Functions<a class="anchor-link" href="#Loss-Functions"> </a></h3><p>For the rating prediction loss, we employ the square loss as the objective function:</p>
<p>
$$L_{pred} = \sum_{u,i \in \mathcal{T}} (\hat{R}_{u,i} - R_{u,i})^2,$$
</p>
<p>where $\mathcal{T}$ denotes the set of instances for training, i.e., $\mathcal{T} = {(u, i, r_{u,i}, a_u, a_i)}$, $R_{u,i}$ is ground truth rating in the training set $\mathcal{T}$ , and $\hat{R}_{u,i}$ is the predicted rating.</p>
<p>The reconstruction loss function in eVAE is defined as follows:</p>
<p>
$$L_{recon} = − KL(q_\phi(z_u|x_u)||p(z_u)) + \mathbb{E}_{q_\phi}(z_u|x_u)[\log p_θ(x'_u|z_u)] + ||x'_u − m_u||_2,$$
</p>
<p>where the first two terms are same as those in standard VAE, and the last one is our extension for the approximation part.</p>
<p>The overall loss function then becomes:</p>
<p>
$$L = L_{pred} + L_{recon},$$
</p>
<p>where $L_{pred}$ is the task-specific rating prediction loss, and $L_{recon}$ is the reconstruction loss.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Imports">Imports<a class="anchor-link" href="#Imports"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.init</span> <span class="k">as</span> <span class="nn">init</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">torch.utils.tensorboard</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Params">Params<a class="anchor-link" href="#Params"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--lr&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
					<span class="n">help</span><span class="o">=</span><span class="s2">&quot;learning rate.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dropout&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
					<span class="n">help</span><span class="o">=</span><span class="s2">&quot;dropout rate.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--batch_size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
					<span class="n">help</span><span class="o">=</span><span class="s2">&quot;batch size when training.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--gpu&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
					<span class="n">help</span><span class="o">=</span><span class="s2">&quot;gpu card ID.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--epochs&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
					<span class="n">help</span><span class="o">=</span><span class="s2">&quot;training epoches.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--clip_norm&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
					<span class="n">help</span><span class="o">=</span><span class="s2">&quot;clip norm for preventing gradient exploding.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--embed_size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;embedding size for users and items.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--attention_size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;embedding size for users and items.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--item_layer1_nei_num&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--user_layer1_nei_num&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--vae_lambda&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>_StoreAction(option_strings=[&#39;--vae_lambda&#39;], dest=&#39;vae_lambda&#39;, nargs=None, const=None, default=1, type=&lt;class &#39;int&#39;&gt;, choices=None, help=None, metavar=None)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset">Dataset<a class="anchor-link" href="#Dataset"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">progress</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">sparsh</span><span class="o">-</span><span class="n">ai</span><span class="o">/</span><span class="n">coldstart</span><span class="o">-</span><span class="n">recsys</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">AGNN</span><span class="o">/</span><span class="n">ml100k</span><span class="o">.</span><span class="n">zip</span>
<span class="err">!</span><span class="n">unzip</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">zip</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>ml100k.zip          100%[===================&gt;]  15.31M  96.6MB/s    in 0.2s    
Archive:  ml100k.zip
   creating: ml100k/
  inflating: ml100k/neighbor_aspect_extension_2_zscore_warm_uuii.pkl  
  inflating: ml100k/uiinfo.pkl       
  inflating: ml100k/ics_train.dat    
  inflating: ml100k/warm_val.dat     
  inflating: ml100k/neighbor_aspect_extension_2_zscore_ics_uuii_0.20.pkl  
  inflating: ml100k/ucs_train.dat    
  inflating: ml100k/ucs_val.dat      
  inflating: ml100k/neighbor_aspect_extension_2_zscore_ucs_uuii.pkl  
  inflating: ml100k/ics_val.dat      
  inflating: ml100k/warm_train.dat   
   creating: ml100k/source_data/
  inflating: ml100k/source_data/item_content.dat  
 extracting: ml100k/source_data/ml-100k.zip  
  inflating: ml100k/source_data/item_url_all.dat  
 extracting: ml100k/source_data/__   
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">get_data_list</span><span class="p">(</span><span class="n">ftrain</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ftrain</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">train_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">eachline</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">eachline</span> <span class="o">=</span> <span class="n">eachline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">eachline</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">eachline</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">eachline</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">train_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>
    <span class="n">num_batches_per_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">train_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span> <span class="n">train_list</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">get_batch_instances</span><span class="p">(</span><span class="n">train_list</span><span class="p">,</span> <span class="n">user_feature_dict</span><span class="p">,</span> <span class="n">item_feature_dict</span><span class="p">,</span> <span class="n">item_director_dict</span><span class="p">,</span> <span class="n">item_writer_dict</span><span class="p">,</span> <span class="n">item_star_dict</span><span class="p">,</span> <span class="n">item_country_dict</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">user_nei_dict</span><span class="p">,</span> <span class="n">item_nei_dict</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">num_batches_per_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">train_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">train_list</span><span class="p">):</span>
        <span class="n">data_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_list</span><span class="p">)</span>
        <span class="n">user_feature_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">user_feature_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">max_user_cate_size</span> <span class="o">=</span> <span class="n">user_feature_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">item_genre_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">item_feature_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="c1">#len=6 ,0</span>
        <span class="n">item_director_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">item_director_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="c1">#len=3 ,6</span>
        <span class="n">item_writer_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">item_writer_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="c1">#len=3, 9</span>
        <span class="n">item_star_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">item_star_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="c1">#len=3, 12</span>
        <span class="n">item_country_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">item_country_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>   <span class="c1">#len=8, 15</span>

        <span class="n">item_feature_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">item_genre_arr</span><span class="p">,</span> <span class="n">item_director_arr</span><span class="p">,</span> <span class="n">item_writer_arr</span><span class="p">,</span> <span class="n">item_star_arr</span><span class="p">,</span> <span class="n">item_country_arr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">max_item_cate_size</span> <span class="o">=</span> <span class="n">item_feature_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">item_layer1_nei_num</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">item_layer1_nei_num</span>
        <span class="n">user_layer1_nei_num</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">user_layer1_nei_num</span>

        <span class="k">if</span> <span class="n">shuffle</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">train_list</span><span class="p">)</span>
        <span class="n">train_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches_per_epoch</span><span class="p">):</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="n">batch_num</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">batch_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span>
            <span class="n">current_batch_size</span> <span class="o">=</span> <span class="n">end_index</span> <span class="o">-</span> <span class="n">start_index</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">train_list</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span> <span class="n">end_index</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">train_list</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span> <span class="n">end_index</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">train_list</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span> <span class="n">end_index</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="n">i_self_cate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">current_batch_size</span><span class="p">,</span> <span class="n">max_item_cate_size</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="n">i_onehop_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">current_batch_size</span><span class="p">,</span> <span class="n">item_layer1_nei_num</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="n">i_onehop_cate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">current_batch_size</span><span class="p">,</span> <span class="n">item_layer1_nei_num</span><span class="p">,</span> <span class="n">max_item_cate_size</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

            <span class="n">u_self_cate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">current_batch_size</span><span class="p">,</span> <span class="n">max_user_cate_size</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="n">u_onehop_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">current_batch_size</span><span class="p">,</span> <span class="n">user_layer1_nei_num</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="n">u_onehop_cate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">current_batch_size</span><span class="p">,</span> <span class="n">user_layer1_nei_num</span><span class="p">,</span> <span class="n">max_user_cate_size</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">each_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">i_self_cate</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_feature_arr</span><span class="p">[</span><span class="n">each_i</span><span class="p">]</span>    <span class="c1">#item_self_cate</span>

                <span class="n">tmp_one_nei</span> <span class="o">=</span> <span class="n">item_nei_dict</span><span class="p">[</span><span class="n">each_i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tmp_prob</span> <span class="o">=</span> <span class="n">item_nei_dict</span><span class="p">[</span><span class="n">each_i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_one_nei</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">item_layer1_nei_num</span><span class="p">:</span>  <span class="c1">#re-sampling</span>
                    <span class="n">tmp_one_nei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tmp_one_nei</span><span class="p">,</span> <span class="n">item_layer1_nei_num</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">tmp_prob</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_one_nei</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">item_layer1_nei_num</span><span class="p">:</span>
                    <span class="n">tmp_one_nei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tmp_one_nei</span><span class="p">,</span> <span class="n">item_layer1_nei_num</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">tmp_prob</span><span class="p">)</span>
                <span class="n">tmp_one_nei</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">each_i</span>

                <span class="n">i_onehop_id</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_one_nei</span>    <span class="c1">#item_1_neigh</span>
                <span class="n">i_onehop_cate</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_feature_arr</span><span class="p">[</span><span class="n">tmp_one_nei</span><span class="p">]</span>  <span class="c1">#item_1_neigh_cate</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">each_u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
                <span class="n">u_self_cate</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_feature_dict</span><span class="p">[</span><span class="n">each_u</span><span class="p">]</span>  <span class="c1"># item_self_cate</span>

                <span class="n">tmp_one_nei</span> <span class="o">=</span> <span class="n">user_nei_dict</span><span class="p">[</span><span class="n">each_u</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tmp_prob</span> <span class="o">=</span> <span class="n">user_nei_dict</span><span class="p">[</span><span class="n">each_u</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_one_nei</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">user_layer1_nei_num</span><span class="p">:</span>  <span class="c1"># re-sampling</span>
                    <span class="n">tmp_one_nei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tmp_one_nei</span><span class="p">,</span> <span class="n">user_layer1_nei_num</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">tmp_prob</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_one_nei</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">user_layer1_nei_num</span><span class="p">:</span>
                    <span class="n">tmp_one_nei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tmp_one_nei</span><span class="p">,</span> <span class="n">user_layer1_nei_num</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">tmp_prob</span><span class="p">)</span>
                <span class="n">tmp_one_nei</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">each_u</span>

                <span class="n">u_onehop_id</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_one_nei</span>  <span class="c1"># user_1_neigh</span>
                <span class="n">u_onehop_cate</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_feature_arr</span><span class="p">[</span><span class="n">tmp_one_nei</span><span class="p">]</span>  <span class="c1"># user_1_neigh_cate</span>

            <span class="k">yield</span> <span class="p">([</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">u_self_cate</span><span class="p">,</span> <span class="n">u_onehop_id</span><span class="p">,</span> <span class="n">u_onehop_cate</span><span class="p">,</span> <span class="n">i_self_cate</span><span class="p">,</span> <span class="n">i_onehop_id</span><span class="p">,</span> <span class="n">i_onehop_cate</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">train_list</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model">Model<a class="anchor-link" href="#Model"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">VAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VAE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">Z_dim</span> <span class="o">=</span> <span class="n">X_dim</span> <span class="o">=</span> <span class="n">h_dim</span> <span class="o">=</span> <span class="n">embed_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_dim</span> <span class="o">=</span> <span class="n">Z_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_dim</span><span class="o">=</span> <span class="n">X_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_dim</span> <span class="o">=</span> <span class="n">h_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="o">=</span> <span class="n">embed_size</span>

        <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># =============================== Q(z|X) ======================================</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_xh</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">X_dim</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_xh</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dense_hz_mu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">Z_dim</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_hz_mu</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dense_hz_var</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">Z_dim</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_hz_var</span><span class="p">)</span>

        <span class="c1"># =============================== P(X|z) ======================================</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_zh</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">Z_dim</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_zh</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dense_hx</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">X_dim</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_hx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_xh</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">z_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_hz_mu</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">z_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_hz_var</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_var</span>

    <span class="k">def</span> <span class="nf">sample_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">):</span>
        <span class="n">mb_size</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">mb_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_dim</span><span class="p">))</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_var</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps</span>

    <span class="k">def</span> <span class="nf">P</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_zh</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_hx</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">AGNN</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_size</span><span class="p">,</span> <span class="n">item_size</span><span class="p">,</span> <span class="n">gender_size</span><span class="p">,</span> <span class="n">age_size</span><span class="p">,</span> <span class="n">occupation_size</span><span class="p">,</span> <span class="n">genre_size</span><span class="p">,</span> <span class="n">director_size</span><span class="p">,</span> <span class="n">writer_size</span><span class="p">,</span> <span class="n">star_size</span><span class="p">,</span> <span class="n">country_size</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">,</span> <span class="n">attention_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AGNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_size</span> <span class="o">=</span> <span class="n">user_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_size</span> <span class="o">=</span> <span class="n">item_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gender_size</span> <span class="o">=</span> <span class="n">gender_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_size</span> <span class="o">=</span> <span class="n">age_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupation_size</span> <span class="o">=</span> <span class="n">occupation_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genre_size</span> <span class="o">=</span> <span class="n">genre_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">director_size</span> <span class="o">=</span> <span class="n">director_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer_size</span> <span class="o">=</span> <span class="n">writer_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star_size</span> <span class="o">=</span> <span class="n">star_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country_size</span> <span class="o">=</span> <span class="n">country_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span> <span class="o">=</span> <span class="n">embed_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention_size</span> <span class="o">=</span> <span class="n">attention_size</span>

        <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_embed</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_embed</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_bias</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_bias</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">miu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gender_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gender_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gender_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupation_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupation_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupation_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">genre_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genre_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genre_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">director_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">director_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">director_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writer_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">country_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>


        <span class="c1">#--------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_self_biinter</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_self_siinter</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_onehop_biinter</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_onehop_siinter</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_self_biinter</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_self_siinter</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_onehop_biinter</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_onehop_siinter</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_self_biinter</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_self_siinter</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_onehop_biinter</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_onehop_siinter</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_user_self_biinter</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_user_self_siinter</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_user_onehop_biinter</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_user_onehop_siinter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_cate_self</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_cate_hop1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_cate_self</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_cate_hop1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_cate_self</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_cate_hop1</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_user_cate_self</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_user_cate_hop1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_addgate</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_addgate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_erasegate</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_erasegate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_addgate</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_user_addgate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_erasegate</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_vae</span> <span class="o">=</span> <span class="n">VAE</span><span class="p">(</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_vae</span> <span class="o">=</span> <span class="n">VAE</span><span class="p">(</span><span class="n">embed_size</span><span class="p">)</span>

        <span class="c1">#----------------------------------------------------</span>
        <span class="c1">#concat, mlp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FC_pre</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">embed_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FC_pre</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;# dot</span>
<span class="sd">        self.user_bias = nn.Embedding(self.user_size, 1)</span>
<span class="sd">        self.item_bias = nn.Embedding(self.item_size, 1)</span>
<span class="sd">        self.user_bias.weight.data.normal_(0, 0.01)</span>
<span class="sd">        self.item_bias.weight.data.normal_(0, 0.01)</span>
<span class="sd">        self.bias = torch.nn.Parameter(torch.rand(1), requires_grad=True)</span>
<span class="sd">        self.bias.data.uniform_(0, 0.1)&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leakyrelu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">feat_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_embedding</span><span class="p">,</span> <span class="n">fun_bi</span><span class="p">,</span> <span class="n">fun_si</span><span class="p">,</span> <span class="n">dimension</span><span class="p">):</span>
        <span class="n">summed_features_emb_square</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">feature_embedding</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dimension</span><span class="p">))</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">squared_sum_features_emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">feature_embedding</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="n">dimension</span><span class="p">)</span>
        <span class="n">deep_fm</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">summed_features_emb_square</span> <span class="o">-</span> <span class="n">squared_sum_features_emb</span><span class="p">)</span>
        <span class="n">deep_fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leakyrelu</span><span class="p">(</span><span class="n">fun_bi</span><span class="p">(</span><span class="n">deep_fm</span><span class="p">))</span>
        <span class="n">bias_fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leakyrelu</span><span class="p">(</span><span class="n">fun_si</span><span class="p">(</span><span class="n">feature_embedding</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dimension</span><span class="p">)))</span>
        <span class="n">nfm</span> <span class="o">=</span> <span class="n">deep_fm</span> <span class="o">+</span> <span class="n">bias_fm</span>
        <span class="k">return</span> <span class="n">nfm</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">user_self_cate</span><span class="p">,</span> <span class="n">user_onehop_id</span><span class="p">,</span> <span class="n">user_onehop_cate</span><span class="p">,</span> <span class="n">item_self_cate</span><span class="p">,</span> <span class="n">item_self_director</span><span class="p">,</span> <span class="n">item_self_writer</span><span class="p">,</span> <span class="n">item_self_star</span><span class="p">,</span> <span class="n">item_self_country</span><span class="p">,</span> <span class="n">item_onehop_id</span><span class="p">,</span> <span class="n">item_onehop_cate</span><span class="p">,</span> <span class="n">item_onehop_director</span><span class="p">,</span> <span class="n">item_onehop_writer</span><span class="p">,</span> <span class="n">item_onehop_star</span><span class="p">,</span> <span class="n">item_onehop_country</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">):</span>

        <span class="n">uids_list</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">sids_list</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;warm&#39;</span><span class="p">:</span>
            <span class="n">user_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_embed</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">uids_list</span><span class="p">))</span>
            <span class="n">item_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embed</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">sids_list</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ics&#39;</span><span class="p">:</span>
            <span class="n">user_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_embed</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">uids_list</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ucs&#39;</span><span class="p">:</span>
            <span class="n">item_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embed</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">sids_list</span><span class="p">))</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">item_self_cate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cate_size</span> <span class="o">=</span> <span class="n">item_self_cate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">director_size</span> <span class="o">=</span> <span class="n">item_self_director</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">writer_size</span> <span class="o">=</span> <span class="n">item_self_writer</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">star_size</span> <span class="o">=</span> <span class="n">item_self_star</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">country_size</span> <span class="o">=</span> <span class="n">item_self_country</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">user_onehop_size</span> <span class="o">=</span> <span class="n">user_onehop_id</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">item_onehop_size</span> <span class="o">=</span> <span class="n">item_onehop_id</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#------------------------------------------------------GCN-item</span>
        <span class="c1"># K=2</span>
        <span class="n">item_onehop_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_onehop_id</span><span class="p">))</span>

        <span class="n">item_onehop_cate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genre_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_onehop_cate</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cate_size</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="n">item_onehop_size</span><span class="p">,</span><span class="n">cate_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_onehop_director</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">director_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_onehop_director</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">director_size</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">item_onehop_size</span><span class="p">,</span> <span class="n">director_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_onehop_writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_onehop_writer</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">writer_size</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">item_onehop_size</span><span class="p">,</span> <span class="n">writer_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_onehop_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_onehop_star</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">star_size</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">item_onehop_size</span><span class="p">,</span> <span class="n">star_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_onehop_country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_onehop_country</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">country_size</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">item_onehop_size</span><span class="p">,</span> <span class="n">country_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">item_onehop_feature</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">item_onehop_cate</span><span class="p">,</span> <span class="n">item_onehop_director</span><span class="p">,</span> <span class="n">item_onehop_writer</span><span class="p">,</span> <span class="n">item_onehop_star</span><span class="p">,</span> <span class="n">item_onehop_country</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">item_onehop_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_cate_hop1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_interaction</span><span class="p">(</span><span class="n">item_onehop_feature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_onehop_biinter</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_onehop_siinter</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">item_onehop_id</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># K=1</span>
        <span class="n">item_self_cate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genre_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_self_cate</span><span class="p">))</span>
        <span class="n">item_self_director</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">director_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_self_director</span><span class="p">))</span>
        <span class="n">item_self_writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_self_writer</span><span class="p">))</span>
        <span class="n">item_self_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_self_star</span><span class="p">))</span>
        <span class="n">item_self_country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">item_self_country</span><span class="p">))</span>

        <span class="n">item_self_feature</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">item_self_cate</span><span class="p">,</span> <span class="n">item_self_director</span><span class="p">,</span> <span class="n">item_self_writer</span><span class="p">,</span> <span class="n">item_self_star</span><span class="p">,</span> <span class="n">item_self_country</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_self_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_interaction</span><span class="p">(</span><span class="n">item_self_feature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_self_biinter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_self_siinter</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ics&#39;</span><span class="p">:</span>
            <span class="n">item_mu</span><span class="p">,</span> <span class="n">item_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_vae</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">item_self_feature</span><span class="p">)</span>
            <span class="n">item_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_vae</span><span class="o">.</span><span class="n">sample_z</span><span class="p">(</span><span class="n">item_mu</span><span class="p">,</span> <span class="n">item_var</span><span class="p">)</span>
            <span class="n">item_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_vae</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">item_z</span><span class="p">)</span>
        <span class="n">item_self_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_item_cate_self</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">item_self_feature</span><span class="p">,</span> <span class="n">item_embedding</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">item_addgate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_addgate</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">item_self_embed</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">item_onehop_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">item_onehop_embed</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>  <span class="c1"># 商品的邻居门，控制邻居信息多少作为输入</span>
        <span class="n">item_erasegate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_item_erasegate</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">item_self_embed</span><span class="p">,</span> <span class="n">item_onehop_embed</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">item_onehop_embed_final</span> <span class="o">=</span> <span class="p">(</span><span class="n">item_onehop_embed</span> <span class="o">*</span> <span class="n">item_addgate</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_self_embed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">item_erasegate</span><span class="p">)</span> <span class="o">*</span> <span class="n">item_self_embed</span>

        <span class="n">item_gcn_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leakyrelu</span><span class="p">(</span><span class="n">item_self_embed</span> <span class="o">+</span> <span class="n">item_onehop_embed_final</span><span class="p">)</span>  <span class="c1"># [batch, embed]</span>

        <span class="c1">#----------------------------------------------------------GCN-user</span>
        <span class="c1"># K=2</span>
        <span class="n">user_onehop_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">user_onehop_id</span><span class="p">))</span>

        <span class="n">user_onehop_gender_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gender_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">user_onehop_cate</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">user_onehop_age_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">user_onehop_cate</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">user_onehop_occupation_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupation_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">user_onehop_cate</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]))</span>

        <span class="n">user_onehop_feat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_onehop_gender_emb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">user_onehop_age_emb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">user_onehop_occupation_emb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">user_onehop_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_cate_hop1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_interaction</span><span class="p">(</span><span class="n">user_onehop_feat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_onehop_biinter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_onehop_siinter</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">user_onehop_id</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># K=1</span>
        <span class="n">user_gender_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gender_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">user_self_cate</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">user_age_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">user_self_cate</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">user_occupation_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupation_embed</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">user_self_cate</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))</span>

        <span class="n">user_self_feature</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_gender_emb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">user_age_emb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">user_occupation_emb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">user_self_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feat_interaction</span><span class="p">(</span><span class="n">user_self_feature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_self_biinter</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_onehop_siinter</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ucs&#39;</span><span class="p">:</span>
            <span class="n">user_mu</span><span class="p">,</span> <span class="n">user_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_vae</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">user_self_feature</span><span class="p">)</span>
            <span class="n">user_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_vae</span><span class="o">.</span><span class="n">sample_z</span><span class="p">(</span><span class="n">user_mu</span><span class="p">,</span> <span class="n">user_var</span><span class="p">)</span>
            <span class="n">user_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_vae</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">user_z</span><span class="p">)</span>
        <span class="n">user_self_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense_user_cate_self</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_self_feature</span><span class="p">,</span> <span class="n">user_embedding</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">user_addgate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_user_addgate</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_self_embed</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_onehop_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">user_onehop_embed</span><span class="p">],</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">user_erasegate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense_user_erasegate</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_self_embed</span><span class="p">,</span> <span class="n">user_onehop_embed</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">user_onehop_embed_final</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_onehop_embed</span> <span class="o">*</span> <span class="n">user_addgate</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">user_self_embed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">user_erasegate</span><span class="p">)</span> <span class="o">*</span> <span class="n">user_self_embed</span>

        <span class="n">user_gcn_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leakyrelu</span><span class="p">(</span><span class="n">user_self_embed</span> <span class="o">+</span> <span class="n">user_onehop_embed_final</span><span class="p">)</span>

        <span class="c1">#--------------------------------------------------norm</span>
        <span class="n">item_mu</span><span class="p">,</span> <span class="n">item_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_vae</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">item_self_feature</span><span class="p">)</span>
        <span class="n">item_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_vae</span><span class="o">.</span><span class="n">sample_z</span><span class="p">(</span><span class="n">item_mu</span><span class="p">,</span> <span class="n">item_var</span><span class="p">)</span>
        <span class="n">item_preference_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_vae</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">item_z</span><span class="p">)</span>

        <span class="n">user_mu</span><span class="p">,</span> <span class="n">user_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_vae</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">user_self_feature</span><span class="p">)</span>
        <span class="n">user_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_vae</span><span class="o">.</span><span class="n">sample_z</span><span class="p">(</span><span class="n">user_mu</span><span class="p">,</span> <span class="n">user_var</span><span class="p">)</span>
        <span class="n">user_preference_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_vae</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">user_z</span><span class="p">)</span>

        <span class="n">recon_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">item_preference_sample</span> <span class="o">-</span> <span class="n">item_embedding</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">user_preference_sample</span> <span class="o">-</span> <span class="n">user_embedding</span><span class="p">)</span>
        <span class="n">kl_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">item_z</span><span class="p">)</span> <span class="o">+</span> <span class="n">item_mu</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">item_var</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> \
                  <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">user_z</span><span class="p">)</span> <span class="o">+</span> <span class="n">user_mu</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">user_var</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1">####################################prediction#####################################################</span>

        <span class="c1">#concat -&gt; mlp</span>
        <span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_bias</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">uids_list</span><span class="p">))</span>
        <span class="n">bi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_bias</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">sids_list</span><span class="p">))</span>
        <span class="c1">#pred = (user_gcn_embed * item_gcn_embed).sum(1, keepdim=True) + bu + bi + (self.miu).repeat(batch_size, 1)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_gcn_embed</span><span class="p">,</span> <span class="n">item_gcn_embed</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FC_pre</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">user_gcn_embed</span> <span class="o">*</span> <span class="n">item_gcn_embed</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">bu</span> <span class="o">+</span> <span class="n">bi</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">miu</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pred</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">recon_loss</span><span class="p">,</span> <span class="n">kl_loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metrics-and-Evaluation">Metrics and Evaluation<a class="anchor-link" href="#Metrics-and-Evaluation"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_dataloader</span><span class="p">):</span>
    <span class="n">label_lst</span><span class="p">,</span> <span class="n">pred_lst</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">rmse</span><span class="p">,</span> <span class="n">mse</span><span class="p">,</span> <span class="n">mae</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">batch_data</span> <span class="ow">in</span> <span class="n">test_dataloader</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">user_self_cate</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">user_onehop_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">user_onehop_cate</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">item_self_cate</span><span class="p">,</span> <span class="n">item_self_director</span><span class="p">,</span> <span class="n">item_self_writer</span><span class="p">,</span> <span class="n">item_self_star</span><span class="p">,</span> <span class="n">item_self_country</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">15</span><span class="p">:]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">item_onehop_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">item_onehop_cate</span><span class="p">,</span> <span class="n">item_onehop_director</span><span class="p">,</span> <span class="n">item_onehop_writer</span><span class="p">,</span> <span class="n">item_onehop_star</span><span class="p">,</span> <span class="n">item_onehop_country</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
            <span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">15</span><span class="p">:]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

        <span class="n">prediction</span><span class="p">,</span> <span class="n">recon_loss</span><span class="p">,</span> <span class="n">kl_loss</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">user_self_cate</span><span class="p">,</span> <span class="n">user_onehop_id</span><span class="p">,</span> <span class="n">user_onehop_cate</span><span class="p">,</span> <span class="n">item_self_cate</span><span class="p">,</span>
                           <span class="n">item_self_director</span><span class="p">,</span> <span class="n">item_self_writer</span><span class="p">,</span> <span class="n">item_self_star</span><span class="p">,</span> <span class="n">item_self_country</span><span class="p">,</span> <span class="n">item_onehop_id</span><span class="p">,</span>
                           <span class="n">item_onehop_cate</span><span class="p">,</span> <span class="n">item_onehop_director</span><span class="p">,</span> <span class="n">item_onehop_writer</span><span class="p">,</span> <span class="n">item_onehop_star</span><span class="p">,</span>
                           <span class="n">item_onehop_country</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">my_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">label</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">my_mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">label</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">my_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">label</span><span class="p">))</span>
        <span class="c1"># my_rmse = torch.sqrt(torch.sum((prediction - label) ** 2) / FLAGS.batch_size)</span>
        <span class="n">rmse</span><span class="o">+=</span><span class="n">my_rmse</span>
        <span class="n">mse</span><span class="o">+=</span><span class="n">my_mse</span>
        <span class="n">mae</span><span class="o">+=</span><span class="n">my_mae</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">label_lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">label</span><span class="p">]))</span>
        <span class="n">pred_lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">prediction</span><span class="p">]))</span>

    <span class="n">my_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="o">/</span><span class="n">count</span>
    <span class="n">my_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rmse</span><span class="o">/</span><span class="n">count</span><span class="p">)</span>
    <span class="n">my_mae</span> <span class="o">=</span> <span class="n">mae</span><span class="o">/</span><span class="n">count</span>
    <span class="k">return</span> <span class="n">my_rmse</span><span class="p">,</span> <span class="n">my_mse</span><span class="p">,</span> <span class="n">my_mae</span><span class="p">,</span> <span class="n">label_lst</span><span class="p">,</span> <span class="n">pred_lst</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1">#item cold start</span>
    <span class="n">f_info</span> <span class="o">=</span> <span class="s1">&#39;ml100k/uiinfo.pkl&#39;</span>
    <span class="n">f_neighbor</span> <span class="o">=</span> <span class="s1">&#39;ml100k/neighbor_aspect_extension_2_zscore_ics_uuii_0.20.pkl&#39;</span>
    <span class="n">f_train</span> <span class="o">=</span> <span class="s1">&#39;ml100k/ics_train.dat&#39;</span>
    <span class="n">f_test</span> <span class="o">=</span> <span class="s1">&#39;ml100k/ics_val.dat&#39;</span>
    <span class="n">f_model</span> <span class="o">=</span> <span class="s1">&#39;ml100k/agnn_ics_&#39;</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;ics&#39;</span>

    <span class="sd">&quot;&quot;&quot;# user cold start</span>
<span class="sd">    f_info = &#39;ml100k/uiinfo.pkl&#39;</span>
<span class="sd">    f_neighbor = &#39;ml100k/neighbor_aspect_extension_2_zscore_ucs_uuii.pkl&#39;</span>
<span class="sd">    f_train = &#39;ml100k/ucs_train.dat&#39;</span>
<span class="sd">    f_test = &#39;ml100k/ucs_val.dat&#39;</span>
<span class="sd">    f_model = &#39;ml100k/agnn_ucs_&#39;</span>
<span class="sd">    mode = &#39;ucs&#39;&quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;# warm start</span>
<span class="sd">    f_info = &#39;ml100k/uiinfo.pkl&#39;</span>
<span class="sd">    f_neighbor = &#39;ml100k/neighbor_aspect_extension_2_zscore_warm_uuii.pkl&#39;</span>
<span class="sd">    f_train = &#39;ml100k/warm_train.dat&#39;</span>
<span class="sd">    f_test = &#39;ml100k/warm_val.dat&#39;</span>
<span class="sd">    f_model = &#39;ml100k/agnn_warm_&#39;</span>
<span class="sd">    mode = &#39;warm&#39;&quot;&quot;&quot;</span>


    <span class="n">FLAGS</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{})</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parameters:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_neighbor</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">neighbor_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">user_nei_dict</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;user_nei_dict&#39;</span><span class="p">]</span>
    <span class="n">item_nei_dict</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;item_nei_dict&#39;</span><span class="p">]</span>
    <span class="n">director_num</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;director_num&#39;</span><span class="p">]</span>
    <span class="n">writer_num</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;writer_num&#39;</span><span class="p">]</span>
    <span class="n">star_num</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;star_num&#39;</span><span class="p">]</span>
    <span class="n">country_num</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;country_num&#39;</span><span class="p">]</span>

    <span class="n">item_director_dict</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;item_director_dict&#39;</span><span class="p">]</span>    <span class="c1">#dict[i]=[x,x,x]</span>
    <span class="n">item_writer_dict</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;item_writer_dict&#39;</span><span class="p">]</span>        <span class="c1">#dict[i]=[x,x,x]</span>
    <span class="n">item_star_dict</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;item_star_dict&#39;</span><span class="p">]</span>            <span class="c1">#dict[i]=[x,x,x]</span>
    <span class="n">item_country_dict</span> <span class="o">=</span> <span class="n">neighbor_dict</span><span class="p">[</span><span class="s1">&#39;item_country_dict&#39;</span><span class="p">]</span>      <span class="c1">#dict[i]=[x,x,x,x,x,x,x,x]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_info</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">item_info</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">user_num</span> <span class="o">=</span> <span class="n">item_info</span><span class="p">[</span><span class="s1">&#39;user_num&#39;</span><span class="p">]</span>
    <span class="n">item_num</span> <span class="o">=</span> <span class="n">item_info</span><span class="p">[</span><span class="s1">&#39;item_num&#39;</span><span class="p">]</span>
    <span class="n">gender_num</span> <span class="o">=</span> <span class="n">item_info</span><span class="p">[</span><span class="s1">&#39;gender_num&#39;</span><span class="p">]</span>
    <span class="n">age_num</span> <span class="o">=</span> <span class="n">item_info</span><span class="p">[</span><span class="s1">&#39;age_num&#39;</span><span class="p">]</span>
    <span class="n">occupation_num</span> <span class="o">=</span> <span class="n">item_info</span><span class="p">[</span><span class="s1">&#39;occupation_num&#39;</span><span class="p">]</span>
    <span class="n">genre_num</span> <span class="o">=</span> <span class="n">item_info</span><span class="p">[</span><span class="s1">&#39;genre_num&#39;</span><span class="p">]</span>
    <span class="n">user_feature_dict</span> <span class="o">=</span> <span class="n">item_info</span><span class="p">[</span><span class="s1">&#39;user_feature_dict&#39;</span><span class="p">]</span>  <span class="c1">#gender, age, occupation    dict[u]=[x,x,x]</span>
    <span class="n">item_feature_dict</span> <span class="o">=</span> <span class="n">item_info</span><span class="p">[</span><span class="s1">&#39;item_feature_dict&#39;</span><span class="p">]</span>  <span class="c1">#genre                      dict[i]=[x,x,x,x,x,x]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user_num </span><span class="si">{}</span><span class="s2">, item_num </span><span class="si">{}</span><span class="s2">, gender_num </span><span class="si">{}</span><span class="s2">, age_num </span><span class="si">{}</span><span class="s2">, occupation_num </span><span class="si">{}</span><span class="s2">, genre_num </span><span class="si">{}</span><span class="s2">, director_num </span><span class="si">{}</span><span class="s2">, writer_num </span><span class="si">{}</span><span class="s2">, star_num </span><span class="si">{}</span><span class="s2">, country_num </span><span class="si">{}</span><span class="s2">, mode </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_num</span><span class="p">,</span> <span class="n">item_num</span><span class="p">,</span> <span class="n">gender_num</span><span class="p">,</span> <span class="n">age_num</span><span class="p">,</span> <span class="n">occupation_num</span><span class="p">,</span> <span class="n">genre_num</span><span class="p">,</span> <span class="n">director_num</span><span class="p">,</span> <span class="n">writer_num</span><span class="p">,</span> <span class="n">star_num</span><span class="p">,</span> <span class="n">country_num</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>

    <span class="n">train_steps</span><span class="p">,</span> <span class="n">train_list</span> <span class="o">=</span> <span class="n">get_data_list</span><span class="p">(</span><span class="n">f_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">test_steps</span><span class="p">,</span> <span class="n">test_list</span> <span class="o">=</span> <span class="n">get_data_list</span><span class="p">(</span><span class="n">f_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">AGNN</span><span class="p">(</span><span class="n">user_num</span><span class="p">,</span> <span class="n">item_num</span><span class="p">,</span> <span class="n">gender_num</span><span class="p">,</span> <span class="n">age_num</span><span class="p">,</span> <span class="n">occupation_num</span><span class="p">,</span> <span class="n">genre_num</span><span class="p">,</span> <span class="n">director_num</span><span class="p">,</span> <span class="n">writer_num</span><span class="p">,</span> <span class="n">star_num</span><span class="p">,</span> <span class="n">country_num</span><span class="p">,</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">attention_size</span><span class="p">,</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="n">loss_function</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">size_average</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span> <span class="n">lr</span><span class="o">=</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">()</span>  <span class="c1"># For visualization</span>
    <span class="c1">#f_loss_curve = open(&#39;tmp_loss_curve.txt&#39;, &#39;w&#39;)</span>
    <span class="n">best_rmse</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
        <span class="c1">#tmp_main_loss, tmp_vae_loss = [], []</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># Enable dropout (if have).</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">get_batch_instances</span><span class="p">(</span><span class="n">train_list</span><span class="p">,</span> <span class="n">user_feature_dict</span><span class="p">,</span> <span class="n">item_feature_dict</span><span class="p">,</span> <span class="n">item_director_dict</span><span class="p">,</span> <span class="n">item_writer_dict</span><span class="p">,</span> <span class="n">item_star_dict</span><span class="p">,</span> <span class="n">item_country_dict</span><span class="p">,</span>  <span class="n">batch_size</span><span class="o">=</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">user_nei_dict</span><span class="o">=</span><span class="n">user_nei_dict</span><span class="p">,</span> <span class="n">item_nei_dict</span><span class="o">=</span><span class="n">item_nei_dict</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">batch_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span> <span class="c1">#u, i, l, u_self_cate, u_onehop_id, u_onehop_rating, u_onehop_cate, i_self_cate, i_onehop_id, i_onehop_cate</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">user_self_cate</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">user_onehop_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">user_onehop_cate</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">item_self_cate</span><span class="p">,</span> <span class="n">item_self_director</span><span class="p">,</span> <span class="n">item_self_writer</span><span class="p">,</span> <span class="n">item_self_star</span><span class="p">,</span> <span class="n">item_self_country</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])[:,</span> <span class="mi">15</span><span class="p">:]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">item_onehop_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">item_onehop_cate</span><span class="p">,</span> <span class="n">item_onehop_director</span><span class="p">,</span> <span class="n">item_onehop_writer</span><span class="p">,</span> <span class="n">item_onehop_star</span><span class="p">,</span> <span class="n">item_onehop_country</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="mi">8</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="mi">15</span><span class="p">:]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

            <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">prediction</span><span class="p">,</span> <span class="n">recon_loss</span><span class="p">,</span> <span class="n">kl_loss</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">user_self_cate</span><span class="p">,</span> <span class="n">user_onehop_id</span><span class="p">,</span> <span class="n">user_onehop_cate</span><span class="p">,</span> <span class="n">item_self_cate</span><span class="p">,</span> <span class="n">item_self_director</span><span class="p">,</span> <span class="n">item_self_writer</span><span class="p">,</span> <span class="n">item_self_star</span><span class="p">,</span> <span class="n">item_self_country</span><span class="p">,</span> <span class="n">item_onehop_id</span><span class="p">,</span> <span class="n">item_onehop_cate</span><span class="p">,</span> <span class="n">item_onehop_director</span><span class="p">,</span> <span class="n">item_onehop_writer</span><span class="p">,</span> <span class="n">item_onehop_star</span><span class="p">,</span> <span class="n">item_onehop_country</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>

            <span class="n">label</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">main_loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">main_loss</span> <span class="o">+</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">vae_lambda</span> <span class="o">*</span> <span class="p">(</span><span class="n">recon_loss</span> <span class="o">+</span> <span class="n">kl_loss</span><span class="p">)</span>

            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># nn.utils.clip_grad_norm(model.parameters(), FLAGS.clip_norm)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;data/loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">tmploss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">50</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch: &#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="s1">&#39;     &#39;</span><span class="p">,</span> <span class="n">tmploss</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time = &#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
        <span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">get_batch_instances</span><span class="p">(</span><span class="n">test_list</span><span class="p">,</span> <span class="n">user_feature_dict</span><span class="p">,</span> <span class="n">item_feature_dict</span><span class="p">,</span> <span class="n">item_director_dict</span><span class="p">,</span> <span class="n">item_writer_dict</span><span class="p">,</span> <span class="n">item_star_dict</span><span class="p">,</span> <span class="n">item_country_dict</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">user_nei_dict</span><span class="o">=</span><span class="n">user_nei_dict</span><span class="p">,</span> <span class="n">item_nei_dict</span><span class="o">=</span><span class="n">item_nei_dict</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">rmse</span><span class="p">,</span> <span class="n">mse</span><span class="p">,</span> <span class="n">mae</span><span class="p">,</span> <span class="n">label_lst</span><span class="p">,</span> <span class="n">pred_lst</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_dataloader</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test rmse,mse,mae: &#39;</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span><span class="n">mse</span><span class="p">,</span><span class="n">mae</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;if (rmse &lt; best_rmse):</span>
<span class="sd">            best_rmse = rmse</span>
<span class="sd">            f_name = f_model + str(best_rmse)[:7] + &#39;.dat&#39; #f_model + str(best_rmse)[:7] + &#39;.dat&#39;</span>
<span class="sd">            #torch.save(model, f_name)</span>
<span class="sd">            f = open(f_name, &#39;w&#39;)</span>
<span class="sd">            res_dict = {}</span>
<span class="sd">            res_dict[&#39;label&#39;] = label_lst</span>
<span class="sd">            res_dict[&#39;pred&#39;] = pred_lst</span>
<span class="sd">            json.dump(res_dict, f)</span>
<span class="sd">            f.close()</span>
<span class="sd">            print(&#39;save result ok&#39;)&quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
Parameters:
{&#39;lr&#39;: 0.0005, &#39;dropout&#39;: 0.5, &#39;batch_size&#39;: 128, &#39;gpu&#39;: &#39;0&#39;, &#39;epochs&#39;: 20, &#39;clip_norm&#39;: 5.0, &#39;embed_size&#39;: 30, &#39;attention_size&#39;: 50, &#39;item_layer1_nei_num&#39;: 10, &#39;user_layer1_nei_num&#39;: 10, &#39;vae_lambda&#39;: 1}
user_num 944, item_num 1683, gender_num 2, age_num 7, occupation_num 21, genre_num 19, director_num 1112, writer_num 2016, star_num 2568, country_num 128, mode ics 
##################################################
epoch:  0       tensor(0.5626, device=&#39;cuda:0&#39;)
time =  47.153045654296875
test rmse,mse,mae:  1.0325273649289848 1.066112759327193 0.8309432697873491
##################################################
epoch:  1       tensor(0.5689, device=&#39;cuda:0&#39;)
time =  43.06915545463562
test rmse,mse,mae:  1.0266010076226462 1.0539096288518324 0.824870026105042
##################################################
epoch:  2       tensor(0.6943, device=&#39;cuda:0&#39;)
time =  42.44387221336365
test rmse,mse,mae:  1.0571549817251507 1.1175766553863038 0.8638132363016552
##################################################
epoch:  3       tensor(0.5527, device=&#39;cuda:0&#39;)
time =  42.13542699813843
test rmse,mse,mae:  1.0517702752306248 1.1062207118587042 0.8609723428611776
##################################################
epoch:  4       tensor(0.5443, device=&#39;cuda:0&#39;)
time =  43.24214553833008
test rmse,mse,mae:  1.0358337215744027 1.0729514987506772 0.8453118500108566
##################################################
epoch:  5       tensor(0.4815, device=&#39;cuda:0&#39;)
time =  42.43221974372864
test rmse,mse,mae:  1.0231939566804946 1.0469258729874857 0.8253297993686741
##################################################
epoch:  6       tensor(0.4968, device=&#39;cuda:0&#39;)
time =  42.93929886817932
test rmse,mse,mae:  1.0359929845205296 1.0732814639757542 0.8411421427834342
##################################################
epoch:  7       tensor(0.4895, device=&#39;cuda:0&#39;)
time =  42.229517459869385
test rmse,mse,mae:  1.0532774718633056 1.1093934327347565 0.8607855100322045
##################################################
epoch:  8       tensor(0.5074, device=&#39;cuda:0&#39;)
time =  42.55834674835205
test rmse,mse,mae:  1.0247800932391622 1.050174239499266 0.824709580819818
##################################################
epoch:  9       tensor(0.4578, device=&#39;cuda:0&#39;)
time =  41.558250427246094
test rmse,mse,mae:  1.0922955741421183 1.19310962129046 0.8990770569855391
##################################################
epoch:  10       tensor(0.5202, device=&#39;cuda:0&#39;)
time =  42.752477407455444
test rmse,mse,mae:  1.0405772957327133 1.0828011083944065 0.8449710432355982
##################################################
epoch:  11       tensor(0.5196, device=&#39;cuda:0&#39;)
time =  41.88001823425293
test rmse,mse,mae:  1.0647690947606663 1.1337332251574486 0.8694145861863434
##################################################
epoch:  12       tensor(0.5833, device=&#39;cuda:0&#39;)
time =  41.569355964660645
test rmse,mse,mae:  1.0307747052978313 1.0624964930818313 0.832099199058856
##################################################
epoch:  13       tensor(0.5642, device=&#39;cuda:0&#39;)
time =  41.10500383377075
test rmse,mse,mae:  1.0283506332487717 1.05750502490315 0.8281871831344915
##################################################
epoch:  14       tensor(0.5756, device=&#39;cuda:0&#39;)
time =  41.294716119766235
test rmse,mse,mae:  1.05585361314044 1.1148268523817215 0.8628918800500965
##################################################
epoch:  15       tensor(0.5247, device=&#39;cuda:0&#39;)
time =  41.94802975654602
test rmse,mse,mae:  1.0287578659232348 1.0583427466989286 0.831378873784134
##################################################
epoch:  16       tensor(0.5186, device=&#39;cuda:0&#39;)
time =  41.139464139938354
test rmse,mse,mae:  1.0345978113820935 1.070392631316618 0.8337778758005447
##################################################
epoch:  17       tensor(0.4468, device=&#39;cuda:0&#39;)
time =  42.24388003349304
test rmse,mse,mae:  1.027209256353785 1.0551588563388956 0.8190214309314482
##################################################
epoch:  18       tensor(0.4668, device=&#39;cuda:0&#39;)
time =  41.94647932052612
test rmse,mse,mae:  1.0637774120911032 1.1316223824752447 0.8678730945240749
##################################################
epoch:  19       tensor(0.4666, device=&#39;cuda:0&#39;)
time =  41.875648021698
test rmse,mse,mae:  1.063158955390531 1.1303069644270851 0.8644698513033106
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>END</strong></p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/2022/01/24/agnn.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
