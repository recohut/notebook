<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Personalized Counterfactual Fairness in Recommendation | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Personalized Counterfactual Fairness in Recommendation" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/24/fairness.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/24/fairness.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-24T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Personalized Counterfactual Fairness in Recommendation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-24T00:00:00-06:00","datePublished":"2022-01-24T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Personalized Counterfactual Fairness in Recommendation","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/24/fairness.html"},"url":"https://nb.recohut.com/2022/01/24/fairness.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Personalized Counterfactual Fairness in Recommendation</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-24T00:00:00-06:00" itemprop="datePublished">
        Jan 24, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      38 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-24-fairness.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-24-fairness.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-24-fairness.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-24-fairness.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-24-fairness.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Installations">Installations<a class="anchor-link" href="#Installations"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">wget</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Imports">Imports<a class="anchor-link" href="#Imports"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">wget</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">osp</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelBinarizer</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Params">Params<a class="anchor-link" href="#Params"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/content&#39;</span>
    <span class="n">train_suffix</span> <span class="o">=</span> <span class="s1">&#39;.train.tsv&#39;</span>             <span class="c1"># train file suffix</span>
    <span class="n">validation_suffix</span> <span class="o">=</span> <span class="s1">&#39;.validation.tsv&#39;</span>   <span class="c1"># validation file suffix</span>
    <span class="n">test_suffix</span> <span class="o">=</span> <span class="s1">&#39;.test.tsv&#39;</span>               <span class="c1"># test file suffix</span>
    <span class="n">all_suffix</span> <span class="o">=</span> <span class="s1">&#39;.all.tsv&#39;</span>                 <span class="c1"># all data file</span>
    <span class="n">feature_suffix</span> <span class="o">=</span> <span class="s1">&#39;.features.txt&#39;</span>         <span class="c1"># feature file</span>
    <span class="n">test_pkl_suffix</span> <span class="o">=</span> <span class="s1">&#39;.test.pkl&#39;</span>         <span class="c1"># prepared test data pickle file suffix</span>
    <span class="n">valid_pkl_suffix</span> <span class="o">=</span> <span class="s1">&#39;.validation.pkl&#39;</span>  <span class="c1"># prepared validation data pickle file suffix</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="s1">&#39;uid&#39;</span>                   <span class="c1"># user column name</span>
    <span class="n">ITEM</span> <span class="o">=</span> <span class="s1">&#39;iid&#39;</span>                   <span class="c1"># item column name</span>
    <span class="n">LABEL</span> <span class="o">=</span> <span class="s1">&#39;label&#39;</span>                 <span class="c1"># label column name</span>
    <span class="n">RANK_FILE_NAME</span> <span class="o">=</span> <span class="s1">&#39;rank.csv&#39;</span>     <span class="c1"># Trained model generated ranking list</span>
    <span class="n">SAMPLE_ID</span> <span class="o">=</span> <span class="s1">&#39;sample_id&#39;</span>         <span class="c1"># sample id for each record</span>
    <span class="n">gpu</span> <span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="c1"># Set CUDA_VISIBLE_DEVICES</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="c1"># Logging Level, 0, 10, ..., 50</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="s1">&#39;log.txt&#39;</span> <span class="c1"># Logging file path</span>
    <span class="n">result_file</span> <span class="o">=</span> <span class="s1">&#39;result.npy&#39;</span> <span class="c1"># Result file path</span>
    <span class="n">random_seed</span> <span class="o">=</span> <span class="mi">2020</span> <span class="c1"># Random seed of numpy and tensorflow</span>
    <span class="n">train</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># To train the model or not</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;ml1M&#39;</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="c1"># sep of csv file</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;label&#39;</span> <span class="c1"># name of dataset label column</span>
    <span class="n">disc_batch_size</span> <span class="o">=</span> <span class="mi">7000</span> <span class="c1"># discriminator train batch size</span>
    <span class="n">train_num_neg</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Negative sample num for each instance in train set</span>
    <span class="n">vt_num_neg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># Number of negative sample in validation/testing stage</span>
    <span class="n">model_path</span> <span class="o">=</span><span class="s1">&#39;model.pt&#39;</span> <span class="c1"># Model save path</span>
    <span class="n">u_vector_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="c1"># user vector size</span>
    <span class="n">i_vector_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="c1"># item vector size</span>
    <span class="n">filter_mode</span> <span class="o">=</span> <span class="s1">&#39;combine&#39;</span> <span class="c1"># combine for using one filter per sensitive feature, separate for using one filter per sensitive feature combination</span>
    <span class="n">load</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Whether load model and continue to train</span>
    <span class="n">load_attack</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Whether load attacker model and continue to train</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Number of epochs</span>
    <span class="n">disc_epoch</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># Number of epochs for training extra discriminator</span>
    <span class="n">check_epoch</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Check every epochs</span>
    <span class="n">early_stop</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># whether to early-stop</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="c1"># Learning rate</span>
    <span class="n">lr_attack</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="c1"># attacker learning rate</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="c1"># Batch size during training</span>
    <span class="n">vt_batch_size</span> <span class="o">=</span> <span class="mi">512</span> <span class="c1"># Batch size during testing</span>
    <span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="c1"># Dropout probability for each deep layer</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="mf">1e-4</span> <span class="c1"># Weight of l2_regularize in loss</span>
    <span class="n">l2_attack</span> <span class="o">=</span> <span class="mf">1e-4</span> <span class="c1"># Weight of attacker l2_regularize in loss</span>
    <span class="n">no_filter</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># if or not use filters</span>
    <span class="n">reg_weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Trade off for adversarial penalty</span>
    <span class="n">d_steps</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># the number of steps of updating discriminator</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;GD&#39;</span> <span class="c1"># &#39;optimizer: GD, Adam, Adagrad</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="s2">&quot;RMSE&quot;</span> <span class="c1"># metrics: RMSE, MAE, AUC, F1, Accuracy, Precision, Recall</span>
    <span class="n">skip_eval</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of epochs without evaluation</span>
    <span class="n">num_worker</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># number of processes for multi-processing data loading</span>
    <span class="n">fix_one</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># fix one feature for evaluation</span>
    <span class="n">eval_disc</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># train extra discriminator for evaluation</span>
    <span class="n">data_reader</span> <span class="o">=</span> <span class="s1">&#39;RecDataReader&#39;</span> <span class="c1"># Choose data_reader</span>
    <span class="n">data_processor</span> <span class="o">=</span> <span class="s1">&#39;RecDataset&#39;</span> <span class="c1"># Choose data_processor</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;BiasedMF&#39;</span> <span class="c1"># Choose model to run</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="s1">&#39;RecRunner&#39;</span> <span class="c1"># Choose runner</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">LOWER_METRIC_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Logger">Logger<a class="anchor-link" href="#Logger"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> [</span><span class="si">%(levelname)s</span><span class="s1">] : </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;T297944 Logger&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Utilities">Utilities<a class="anchor-link" href="#Utilities"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Dataset">Dataset<a class="anchor-link" href="#Dataset"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">download_movielens</span><span class="p">():</span>
    <span class="n">download_link</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/sparsh-ai/fairness-recsys/raw/main/data/bronze/ml1m/ml1m_t297944.zip&#39;</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="o">+</span><span class="s1">&#39;.zip&#39;</span><span class="p">)</span>
    <span class="n">save_path_extracted</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">save_path_extracted</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">save_path_extracted</span><span class="p">):</span>
        <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">download_link</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">save_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
            <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">save_path_extracted</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Files saved in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_path_extracted</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Files already exists in </span><span class="si">{}</span><span class="s1">, skipping!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_path_extracted</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">DataReader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">seq_sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="n">dataset_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_sep</span> <span class="o">=</span> <span class="n">seq_sep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">train_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">validation_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">test_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">all_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">feature_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_feature</span><span class="p">()</span> <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_file</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;load all csv...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;all file is not found.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;load train csv...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;size of train: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;train file is not found.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;load validation csv...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;size of validation: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_df</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;validation file is not found.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;load test csv...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;size of test: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_df</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;test file is not found.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load pre-trained/feature embeddings. It is saved as a numpy text file.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">RecDataReader</span><span class="p">(</span><span class="n">DataReader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">seq_sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">seq_sep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">USER</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">ITEM</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_ids_set</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_ids_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_item2users_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_item2users_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">all_user2items_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_user2items_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_user2items_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_user2items_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_user2items_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_user2items_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_user2items_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_user2items_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_df</span><span class="p">)</span>
        <span class="c1"># add feature info for discriminator and filters</span>
        <span class="n">uid_iid_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ITEM</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uid_iid_label</span><span class="p">]</span>
        <span class="n">Feature</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Feature&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;num_class&#39;</span><span class="p">,</span> <span class="s1">&#39;label_min&#39;</span><span class="p">,</span> <span class="s1">&#39;label_max&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_info</span> <span class="o">=</span> \
            <span class="n">OrderedDict</span><span class="p">({</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                          <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_prepare_user2items_dict</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="n">df_groups</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">USER</span><span class="p">)</span>
        <span class="n">user_sample_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_groups</span><span class="p">:</span>
            <span class="n">user_sample_dict</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">ITEM</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">user_sample_dict</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_prepare_item2users_dict</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="n">df_groups</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ITEM</span><span class="p">)</span>
        <span class="n">user_sample_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_groups</span><span class="p">:</span>
            <span class="n">user_sample_dict</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">USER</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">user_sample_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">DiscriminatorDataReader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">seq_sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">test_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_sep</span> <span class="o">=</span> <span class="n">seq_sep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">all_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_attacker_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">+</span> <span class="s1">&#39;.attacker&#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">train_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_attacker_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">+</span> <span class="s1">&#39;.attacker&#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">test_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># add feature info for discriminator and filters</span>
        <span class="n">uid_iid_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ITEM</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uid_iid_label</span><span class="p">]</span>

        <span class="n">Feature</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Feature&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;num_class&#39;</span><span class="p">,</span> <span class="s1">&#39;label_min&#39;</span><span class="p">,</span> <span class="s1">&#39;label_max&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_info</span> <span class="o">=</span> \
            <span class="n">OrderedDict</span><span class="p">({</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                          <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_name_2_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">f_name</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_attacker_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_attacker_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_attacker_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_attacker_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_feature_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_df</span><span class="p">,</span> <span class="n">test_ratio</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_feature_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_df</span><span class="p">,</span> <span class="n">test_ratio</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing attacker train/test file...&#39;</span><span class="p">)</span>
        <span class="n">feature_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">all_df</span> <span class="o">=</span> <span class="n">all_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;uid&#39;</span><span class="p">)</span>
        <span class="n">all_group</span> <span class="o">=</span> <span class="n">all_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">)</span>

        <span class="n">uid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">feature_list_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">all_group</span><span class="p">:</span>
            <span class="n">uid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">feature_list_dict</span><span class="p">:</span>
                <span class="n">feature_list_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">feature_df</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">USER</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid_list</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">:</span>
            <span class="n">feature_df</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_list_dict</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>

        <span class="n">test_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_df</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_ratio</span><span class="p">)</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">sign</span><span class="p">:</span>
            <span class="n">test_set</span> <span class="o">=</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">test_size</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">:</span>
                <span class="n">num_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">f_name_2_idx</span><span class="p">[</span><span class="n">f</span><span class="p">]]</span><span class="o">.</span><span class="n">num_class</span>
                <span class="n">val_range</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_class</span><span class="p">)])</span>
                <span class="n">test_range</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_set</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_range</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_range</span><span class="p">):</span>
                    <span class="n">sign</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sign</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">train_set</span> <span class="o">=</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">test_set</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">train_set</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_attacker_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">test_set</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_attacker_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">train_set</span><span class="p">,</span> <span class="n">test_set</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">RecDataset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_reader</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">num_neg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span> <span class="o">=</span> <span class="n">data_reader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_user</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_reader</span><span class="o">.</span><span class="n">user_ids_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_item</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_reader</span><span class="o">.</span><span class="n">item_ids_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_neg</span> <span class="o">=</span> <span class="n">num_neg</span>
        <span class="c1"># prepare test/validation dataset</span>
        <span class="n">valid_pkl_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">valid_pkl_suffix</span><span class="p">)</span>
        <span class="n">test_pkl_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">test_pkl_suffix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">valid_pkl_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">valid_pkl_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Load validation data from pickle file.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">valid_pkl_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">test_pkl_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_pkl_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Load test data from pickle file.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_pkl_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_train_data</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vt_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_train_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">train_df</span>
        <span class="n">df</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">SAMPLE_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">columns_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ITEM</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">SAMPLE_ID</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f_col</span> <span class="k">for</span> <span class="n">f_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_order</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_get_vt_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">validation_df</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Prepare validation data...&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">test_df</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Prepare test data...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Wrong stage in dataset.&#39;</span><span class="p">)</span>
            
        <span class="n">df</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">SAMPLE_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">columns_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ITEM</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">SAMPLE_ID</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f_col</span> <span class="k">for</span> <span class="n">f_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_order</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">total_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">n_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">total_batches</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Prepare Batches&#39;</span><span class="p">):</span>
            <span class="n">batch_start</span> <span class="o">=</span> <span class="n">n_batch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">batch_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">batch_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

            <span class="n">real_batch_size</span> <span class="o">=</span> <span class="n">batch_end</span> <span class="o">-</span> <span class="n">batch_start</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_start</span> <span class="o">+</span> <span class="n">real_batch_size</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">batch</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">batch</span><span class="p">)[:,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">batch</span><span class="p">)[:,</span> <span class="mi">4</span><span class="p">:]</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">inputs</span><span class="p">,</span> <span class="n">features</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">neg_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neg_samples_from_all</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg</span><span class="p">)</span>
            <span class="n">neg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">neg_samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">tmp_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">inputs</span><span class="p">,</span> <span class="n">neg_samples</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">tmp_sample</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">labels</span><span class="p">,</span> <span class="n">neg_labels</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">tmp_sample</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:])</span>

            <span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">samples</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="n">features</span><span class="p">}</span>
            <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feed_dict</span><span class="p">)</span>

            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">batches</span>

    <span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="n">feed_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collate_train</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feed_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collate_vt</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feed_dict</span>

    <span class="k">def</span> <span class="nf">_collate_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">batch</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">batch</span><span class="p">)[:,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">batch</span><span class="p">)[:,</span> <span class="mi">4</span><span class="p">:]</span>
        <span class="n">neg_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neg_sampler</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">neg_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">neg_samples</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">neg_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">neg_samples</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">neg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">neg_samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">neg_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_samples</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">inputs</span><span class="p">,</span> <span class="n">neg_samples</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">labels</span><span class="p">,</span> <span class="n">neg_labels</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">features</span><span class="p">,</span> <span class="n">neg_features</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">samples</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="n">features</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">feed_dict</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collate_vt</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_neg_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">neg_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_item</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
            <span class="n">user_clicked_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">all_user2items_dict</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neg</span><span class="p">):</span>
                <span class="k">while</span> <span class="n">neg_items</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">user_clicked_set</span><span class="p">:</span>
                    <span class="n">neg_items</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">neg_items</span>

    <span class="k">def</span> <span class="nf">_neg_samples_from_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">num_neg</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">neg_items</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sample_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="n">neg_candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">item_ids_set</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">all_user2items_dict</span><span class="p">[</span><span class="n">user</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">num_neg</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num_neg</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">):</span>
                    <span class="n">neg_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">,</span> <span class="n">num_neg</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">neg_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">user_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">user</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">))</span>
            <span class="n">id_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">sample_id</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">))</span>
            <span class="n">feature_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">neg_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">neg_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">user_arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">neg_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">neg_candidates</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">id_arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">neg_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">neg_candidates</span><span class="p">,</span> <span class="n">feature_arr</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">neg_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">neg_items</span> <span class="o">=</span> <span class="n">neg_candidates</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">neg_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">neg_items</span><span class="p">,</span> <span class="n">neg_candidates</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">neg_items</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">DiscriminatorDataset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_reader</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span> <span class="o">=</span> <span class="n">data_reader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_train_data</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_test_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_train_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">train_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_get_test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">test_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">feed_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">feed_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">feed_dict</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">feed_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Models">Models<a class="anchor-link" href="#Models"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">BaseRecModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initialize nn weights，called in main.py</span>
<span class="sd">        :param m: parameter or the nn</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_processor_dict</span><span class="p">,</span> <span class="n">user_num</span><span class="p">,</span> <span class="n">item_num</span><span class="p">,</span> <span class="n">u_vector_size</span><span class="p">,</span> <span class="n">i_vector_size</span><span class="p">,</span>
                 <span class="n">random_seed</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;../model/Model/Model.pt&#39;</span><span class="p">,</span> <span class="n">filter_mode</span><span class="o">=</span><span class="s1">&#39;combine&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param data_processor_dict:</span>
<span class="sd">        :param user_num:</span>
<span class="sd">        :param item_num:</span>
<span class="sd">        :param u_vector_size:</span>
<span class="sd">        :param i_vector_size:</span>
<span class="sd">        :param random_seed:</span>
<span class="sd">        :param dropout:</span>
<span class="sd">        :param model_path:</span>
<span class="sd">        :param filter_mode: &#39;combine&#39;-&gt; for each combination train one filter;</span>
<span class="sd">        &#39;separate&#39; -&gt; one filter for one sensitive feature, do combination for complex case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseRecModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_dict</span> <span class="o">=</span> <span class="n">data_processor_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_num</span> <span class="o">=</span> <span class="n">user_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_num</span> <span class="o">=</span> <span class="n">item_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u_vector_size</span> <span class="o">=</span> <span class="n">u_vector_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_vector_size</span> <span class="o">=</span> <span class="n">i_vector_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_mode</span> <span class="o">=</span> <span class="n">filter_mode</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_nn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_sensitive_filter</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_variables</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# of params: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_parameters</span><span class="p">)</span>

        <span class="c1"># optimizer assigned by *_runner.py</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_init_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize neural networks</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_init_sensitive_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get_sensitive_filter</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">):</span>
            <span class="n">sequential</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">embed_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">sequential</span>
        <span class="n">num_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span> <span class="o">=</span> <span class="n">num_features</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_mode</span> <span class="o">==</span> <span class="s1">&#39;combine&#39;</span> <span class="k">else</span> <span class="mi">2</span><span class="o">**</span><span class="n">num_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="n">num_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span>
            <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">get_sensitive_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_vector_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">apply_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">filter_mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_mode</span> <span class="o">==</span> <span class="s1">&#39;separate&#39;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filter_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filter_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">filter_mask</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">filter_mask</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">filter_mask</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">sens_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">sens_filter</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_mode</span> <span class="o">==</span> <span class="s1">&#39;combine&#39;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filter_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filter_mask</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sens_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">sens_filter</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">result</span> <span class="o">+</span> <span class="n">sens_filter</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filter_mask</span><span class="p">)</span>   <span class="c1"># average the embedding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">vectors</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">count_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Total number of parameters in the model</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_parameters</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_parameters</span>

    <span class="k">def</span> <span class="nf">l2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calc the summation of l2 of all parameters</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">l2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">p</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">l2</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed_dict</span><span class="p">,</span> <span class="n">filter_mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        prediction only without loss calculation</span>
<span class="sd">        :param feed_dict: input dictionary</span>
<span class="sd">        :param filter_mask: mask for filter selection</span>
<span class="sd">        :return: output dictionary，with keys (at least)</span>
<span class="sd">                &quot;prediction&quot;: predicted values;</span>
<span class="sd">                &quot;check&quot;: intermediate results to be checked and printed out</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_bn</span><span class="p">(</span><span class="n">feed_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">feed_dict</span><span class="p">[</span><span class="s1">&#39;dropout&#39;</span><span class="p">])(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
                    <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="n">check_list</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out_dict</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed_dict</span><span class="p">,</span> <span class="n">filter_mask</span><span class="p">):</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">feed_dict</span><span class="p">,</span> <span class="n">filter_mask</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">feed_dict</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">neg</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">][:</span><span class="n">batch_size</span><span class="p">],</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">][</span><span class="n">batch_size</span><span class="p">:]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">neg</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span>
        <span class="k">return</span> <span class="n">out_dict</span>

    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Save model to &#39;</span> <span class="o">+</span> <span class="n">model_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Load model from &#39;</span> <span class="o">+</span> <span class="n">model_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">freeze_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">params</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">PMF</span><span class="p">(</span><span class="n">BaseRecModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_init_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid_embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_vector_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iid_embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_vector_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed_dict</span><span class="p">,</span> <span class="n">filter_mask</span><span class="p">):</span>
        <span class="n">check_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u_ids</span> <span class="o">=</span> <span class="n">feed_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">i_ids</span> <span class="o">=</span> <span class="n">feed_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">pmf_u_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid_embeddings</span><span class="p">(</span><span class="n">u_ids</span><span class="p">)</span>
        <span class="n">pmf_i_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iid_embeddings</span><span class="p">(</span><span class="n">i_ids</span><span class="p">)</span>

        <span class="n">pmf_u_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_filter</span><span class="p">(</span><span class="n">pmf_u_vectors</span><span class="p">,</span> <span class="n">filter_mask</span><span class="p">)</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmf_u_vectors</span> <span class="o">*</span> <span class="n">pmf_i_vectors</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
                    <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="n">check_list</span><span class="p">,</span>
                    <span class="s1">&#39;u_vectors&#39;</span><span class="p">:</span> <span class="n">pmf_u_vectors</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">RecRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;GD&#39;</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">eval_batch_size</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">128</span><span class="p">,</span>
                 <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="n">check_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">early_stop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">no_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">reg_weight</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">d_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">disc_epoch</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        初始化</span>
<span class="sd">        :param optimizer: optimizer name</span>
<span class="sd">        :param learning_rate: learning rate</span>
<span class="sd">        :param epoch: total training epochs</span>
<span class="sd">        :param batch_size: batch size for training</span>
<span class="sd">        :param eval_batch_size: batch size for evaluation</span>
<span class="sd">        :param dropout: dropout rate</span>
<span class="sd">        :param l2: l2 weight</span>
<span class="sd">        :param metrics: evaluation metrics list</span>
<span class="sd">        :param check_epoch: check intermediate results in every n epochs</span>
<span class="sd">        :param early_stop: 1 for early stop, 0 for not.</span>
<span class="sd">        :param no_filter: if or not use filters</span>
<span class="sd">        :param reg_weight: adversarial penalty weight</span>
<span class="sd">        :param d_steps: the number of steps to optimize discriminator</span>
<span class="sd">        :param disc_epoch: number of epoch for training extra discriminator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_batch_size</span> <span class="o">=</span> <span class="n">eval_batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_dropout</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2_weight</span> <span class="o">=</span> <span class="n">l2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_weight</span> <span class="o">=</span> <span class="n">reg_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_steps</span> <span class="o">=</span> <span class="n">d_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span> <span class="o">=</span> <span class="n">no_filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disc_epoch</span> <span class="o">=</span> <span class="n">disc_epoch</span>

        <span class="c1"># convert metrics to list of str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_epoch</span> <span class="o">=</span> <span class="n">check_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="n">early_stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># record train, validation, test results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_results</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disc_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_worker</span> <span class="o">=</span> <span class="n">num_worker</span>

    <span class="k">def</span> <span class="nf">_build_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l2_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">optimizer_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span>
        <span class="k">if</span> <span class="n">l2_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">l2_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_weight</span>

        <span class="k">if</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s1">&#39;gd&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Optimizer: GD&quot;</span><span class="p">)</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2_weight</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s1">&#39;adagrad&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Optimizer: Adagrad&quot;</span><span class="p">)</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2_weight</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Optimizer: Adam&quot;</span><span class="p">)</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2_weight</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown Optimizer: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;GD&#39;</span><span class="p">,</span> <span class="s1">&#39;Adagrad&#39;</span><span class="p">,</span> <span class="s1">&#39;Adam&#39;</span><span class="p">]</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2_weight</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimizer</span>

    <span class="k">def</span> <span class="nf">_check_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">start</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">()]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmp_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmp_time</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_filter_mask</span><span class="p">(</span><span class="n">filter_num</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">filter_num</span><span class="p">,))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_masked_disc</span><span class="p">(</span><span class="n">disc_dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">masked_disc_label</span> <span class="o">=</span> <span class="p">[(</span><span class="n">disc_dict</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">masked_disc_label</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># fit the results for an input set</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train the model</span>
<span class="sd">        :param model: model instance</span>
<span class="sd">        :param batches: train data in batches</span>
<span class="sd">        :param fair_disc_dict: fairness discriminator dictionary</span>
<span class="sd">        :param epoch: epoch number</span>
<span class="sd">        :return: return the output of the last round</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_optimizer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">fair_disc_dict</span><span class="p">:</span>
            <span class="n">discriminator</span> <span class="o">=</span> <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">discriminator</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">discriminator</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_optimizer</span><span class="p">(</span><span class="n">discriminator</span><span class="p">)</span>
            <span class="n">discriminator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="n">loss_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">output_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">eval_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Epoch </span><span class="si">%5d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                          <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># step1: use filter mask select filters</span>
            <span class="c1"># step2: use selected filter filter out the embeddings</span>
            <span class="c1"># step3: use the filtered embeddings for recommendation task and get rec loss rec_loss</span>
            <span class="c1"># step4: apply the discriminator with the filtered embeddings and get discriminator loss d_loss</span>
            <span class="c1">#  (use filter_mask to decide use which discriminator)</span>
            <span class="c1"># step5: combine rec_loss and d_loss and do optimization (use filter and rec model optimizer)</span>
            <span class="c1"># step6: use discriminator optimizer to optimize discriminator K times</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">num_features</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_mask</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_features</span><span class="p">)</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch_to_gpu</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
                <span class="n">masked_disc_label</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_masked_disc</span><span class="p">(</span><span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">masked_disc_label</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_masked_disc</span><span class="p">(</span><span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># calculate recommendation loss + fair discriminator penalty</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">rec_loss</span> <span class="o">=</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="n">vectors</span> <span class="o">=</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;u_vectors&#39;</span><span class="p">]</span>
            <span class="n">vectors</span> <span class="o">=</span> <span class="n">vectors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">fair_d_penalty</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fair_disc</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">masked_disc_label</span><span class="p">:</span>
                    <span class="n">fair_d_penalty</span> <span class="o">+=</span> <span class="n">fair_disc</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="n">fair_d_penalty</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">rec_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_weight</span> <span class="o">*</span> <span class="n">fair_d_penalty</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">rec_loss</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;check&#39;</span><span class="p">]</span>

            <span class="c1"># update discriminator</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">masked_disc_label</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_steps</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">discriminator</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">masked_disc_label</span><span class="p">:</span>
                            <span class="n">discriminator</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                            <span class="n">disc_loss</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">vectors</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">label</span><span class="p">)</span>
                            <span class="n">disc_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">discriminator</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="c1"># collect discriminator evaluation results</span>
            <span class="k">if</span> <span class="n">eval_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">eval_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_discriminator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">vectors</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch_eval_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_discriminator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">vectors</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">eval_dict</span><span class="p">:</span>
                    <span class="n">new_label</span> <span class="o">=</span> <span class="n">batch_eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                    <span class="n">current_label</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                    <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">current_label</span><span class="p">,</span> <span class="n">new_label</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="n">new_prediction</span> <span class="o">=</span> <span class="n">batch_eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span>
                    <span class="n">current_prediction</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span>
                    <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">current_prediction</span><span class="p">,</span> <span class="n">new_prediction</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># generate discriminator evaluation scores</span>
        <span class="n">d_score_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">eval_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">eval_dict</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span>
                <span class="n">n_class</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;num_class&#39;</span><span class="p">]</span>
                <span class="n">d_score_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eval_method</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">n_class</span><span class="p">)</span>

        <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;d_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_score_dict</span>
        <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dict</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dp_dict</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">skip_eval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fix_one</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train model</span>
<span class="sd">        :param model: model obj</span>
<span class="sd">        :param dp_dict: Data processors for train valid and test</span>
<span class="sd">        :param skip_eval: number of epochs to skip for evaluations</span>
<span class="sd">        :param fair_disc_dict: fairness discriminator dictionary</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_worker</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">)</span>
        <span class="n">validation_data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_worker</span><span class="p">,</span>
                                     <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">)</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_worker</span><span class="p">,</span>
                               <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_time</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># start time</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_time</span><span class="p">()</span>
                <span class="n">output_dict</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_epoch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">)</span>
                <span class="n">training_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_time</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;=</span> <span class="n">skip_eval</span><span class="p">:</span>
                    <span class="n">valid_result_dict</span><span class="p">,</span> <span class="n">test_result_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
                        <span class="n">valid_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">validation_data</span><span class="p">)</span> <span class="k">if</span> \
                            <span class="n">validation_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                        <span class="n">test_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span> \
                            <span class="k">if</span> <span class="n">test_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">valid_result</span><span class="p">,</span> <span class="n">valid_result_dict</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">eval_multi_combination</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">validation_data</span><span class="p">,</span> <span class="n">fix_one</span><span class="p">)</span> \
                            <span class="k">if</span> <span class="n">validation_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                        <span class="n">test_result</span><span class="p">,</span> <span class="n">test_result_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_multi_combination</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">fix_one</span><span class="p">)</span> \
                            <span class="k">if</span> <span class="n">test_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>

                    <span class="n">testing_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_time</span><span class="p">()</span>

                    <span class="c1"># self.train_results.append(train_result)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">valid_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disc_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;d_score&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">%5d</span><span class="s2"> [</span><span class="si">%.1f</span><span class="s2"> s]</span><span class="se">\n</span><span class="s2"> validation= </span><span class="si">%s</span><span class="s2"> test= </span><span class="si">%s</span><span class="s2"> [</span><span class="si">%.1f</span><span class="s2"> s] &quot;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">training_time</span><span class="p">,</span>
                                        <span class="n">format_metric</span><span class="p">(</span><span class="n">valid_result</span><span class="p">),</span> <span class="n">format_metric</span><span class="p">(</span><span class="n">test_result</span><span class="p">),</span>
                                        <span class="n">testing_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">%5d</span><span class="s2"> [</span><span class="si">%.1f</span><span class="s2"> s]</span><span class="se">\t</span><span class="s2"> Average: validation= </span><span class="si">%s</span><span class="s2"> test= </span><span class="si">%s</span><span class="s2"> [</span><span class="si">%.1f</span><span class="s2"> s] &quot;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">training_time</span><span class="p">,</span>
                                        <span class="n">format_metric</span><span class="p">(</span><span class="n">valid_result</span><span class="p">),</span> <span class="n">format_metric</span><span class="p">(</span><span class="n">test_result</span><span class="p">),</span>
                                        <span class="n">testing_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">valid_result_dict</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;validation= </span><span class="si">%s</span><span class="s2"> test= </span><span class="si">%s</span><span class="s2"> &quot;</span>
                                         <span class="o">%</span> <span class="p">(</span><span class="n">format_metric</span><span class="p">(</span><span class="n">valid_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span>
                                            <span class="n">format_metric</span><span class="p">(</span><span class="n">test_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span> <span class="o">+</span>
                                         <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;) &#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">best_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_results</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">save_model</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">fair_disc_dict</span><span class="p">:</span>
                            <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">save_model</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eva_termination</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Early stop at </span><span class="si">%d</span><span class="s2"> based on validation result.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">skip_eval</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">%5d</span><span class="s2"> [</span><span class="si">%.1f</span><span class="s2"> s]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">training_time</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Early stop manually&quot;</span><span class="p">)</span>
            <span class="n">save_here</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Save here? (1/0) (default 0):&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">save_here</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">):</span>
                <span class="n">model</span><span class="o">.</span><span class="n">save_model</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">fair_disc_dict</span><span class="p">:</span>
                    <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">save_model</span><span class="p">()</span>

        <span class="c1"># Find the best validation result across iterations</span>
        <span class="n">best_valid_score</span> <span class="o">=</span> <span class="n">best_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_results</span><span class="p">)</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_results</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">best_valid_score</span><span class="p">)</span>
        <span class="c1"># prepare disc result string</span>
        <span class="n">disc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">]</span>
        <span class="n">disc_info_str</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">disc_info</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">disc_info</span><span class="p">]</span>
        <span class="n">disc_info_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">disc_info_str</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Best Iter(validation)= </span><span class="si">%5d</span><span class="se">\t</span><span class="s2"> valid= </span><span class="si">%s</span><span class="s2"> test= </span><span class="si">%s</span><span class="s2"> [</span><span class="si">%.1f</span><span class="s2"> s] &quot;</span>
                     <span class="o">%</span> <span class="p">(</span><span class="n">best_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">format_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">]),</span>
                        <span class="n">format_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">disc_info_str</span> <span class="o">+</span>
                     <span class="s1">&#39; AUC&#39;</span><span class="p">)</span>
        <span class="n">best_test_score</span> <span class="o">=</span> <span class="n">best_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_results</span><span class="p">)</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_results</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">best_test_score</span><span class="p">)</span>
        <span class="n">disc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">]</span>
        <span class="n">disc_info_str</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">disc_info</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">disc_info</span><span class="p">]</span>
        <span class="n">disc_info_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">disc_info_str</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Best Iter(test)= </span><span class="si">%5d</span><span class="se">\t</span><span class="s2"> valid= </span><span class="si">%s</span><span class="s2"> test= </span><span class="si">%s</span><span class="s2"> [</span><span class="si">%.1f</span><span class="s2"> s] &quot;</span>
                     <span class="o">%</span> <span class="p">(</span><span class="n">best_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">format_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">]),</span>
                        <span class="n">format_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_results</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">disc_info_str</span> <span class="o">+</span>
                     <span class="s1">&#39; AUC&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">fair_disc_dict</span><span class="p">:</span>
            <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">eval_multi_combination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fix_one</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate model on validation/test dataset under different filter combinations.</span>
<span class="sd">        The output is the averaged result over all the possible combinations.</span>
<span class="sd">        :param model: trained model</span>
<span class="sd">        :param data: validation or test data (not train data)</span>
<span class="sd">        :param fix_one: if true, only evaluate on one feature instead of all the combinations (save running time)</span>
<span class="sd">        :return: averaged evaluated result on given dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">num_features</span>
        <span class="n">feature_info</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data_processor_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">feature_info</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fix_one</span><span class="p">:</span>
            <span class="n">mask_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">repeat</span><span class="o">=</span><span class="n">n_features</span><span class="p">)]</span>
            <span class="n">mask_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># mask_list = [[1, 0, 0], [0, 1, 0], [0, 0, 1]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature_range</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">feature_range</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">one_hot</span><span class="p">[</span><span class="n">feature_range</span><span class="p">,</span> <span class="n">feature_range</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask_list</span> <span class="o">=</span> <span class="n">one_hot</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">mask_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">acc_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">mask_list</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">feature_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">f_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">feature_idx</span><span class="p">]</span>
            <span class="n">f_name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f_name_list</span><span class="p">)</span>

            <span class="n">cur_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
            <span class="n">acc_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cur_result</span><span class="p">)</span> <span class="k">if</span> <span class="n">acc_result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">acc_result</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cur_result</span><span class="p">)</span>

            <span class="n">result_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_result</span>

        <span class="k">if</span> <span class="n">acc_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_result</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">acc_result</span><span class="p">),</span> <span class="n">result_dict</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        evaluate recommendation performance</span>
<span class="sd">        :param model:</span>
<span class="sd">        :param batches: data batches, each batch is a dict.</span>
<span class="sd">        :param mask: filter mask</span>
<span class="sd">        :param metrics: list of str</span>
<span class="sd">        :return: list of float number for each metric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">filter_num</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Predict&#39;</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch_to_gpu</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">out_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">sample_ids</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_ids</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">SAMPLE_ID</span><span class="p">:</span> <span class="n">sample_ids</span><span class="p">}</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_method</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">evaluations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">evaluations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">result_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">evaluations</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">evaluate_method</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate model predictions.</span>
<span class="sd">        :param p: predicted values, np.array</span>
<span class="sd">        :param data: data dictionary which include ground truth labels</span>
<span class="sd">        :param metrics: metrics list</span>
<span class="sd">        :return: a list of results. The order is consistent to metric list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">LABEL</span><span class="p">]</span>
        <span class="n">evaluations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;rmse&#39;</span><span class="p">:</span>
                <span class="n">evaluations</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">p</span><span class="p">))]</span>
            <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;mae&#39;</span><span class="p">:</span>
                <span class="n">evaluations</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">p</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;auc&#39;</span><span class="p">:</span>
                <span class="n">evaluations</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">p</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">SAMPLE_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">SAMPLE_ID</span><span class="p">]</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">df_group</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">SAMPLE_ID</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ndcg@&#39;</span><span class="p">):</span>
                    <span class="n">ndcgs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_group</span><span class="p">:</span>
                        <span class="n">ndcgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndcg_at_k</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">evaluations</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndcgs</span>
                <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;hit@&#39;</span><span class="p">):</span>
                    <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_group</span><span class="p">:</span>
                        <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][:</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">evaluations</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">hits</span>
                <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;precision@&#39;</span><span class="p">):</span>
                    <span class="n">precisions</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_group</span><span class="p">:</span>
                        <span class="n">precisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision_at_k</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>
                    <span class="n">evaluations</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">precisions</span>
                <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;recall@&#39;</span><span class="p">):</span>
                    <span class="n">recalls</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_group</span><span class="p">:</span>
                        <span class="n">recalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][:</span><span class="n">k</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]))</span>
                    <span class="n">evaluations</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">recalls</span>
                <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f1@&#39;</span><span class="p">):</span>
                    <span class="n">f1</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_group</span><span class="p">:</span>
                        <span class="n">num_overlap</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">][:</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">f1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_overlap</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">])))</span>
                    <span class="n">evaluations</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1</span>
        <span class="k">return</span> <span class="n">evaluations</span>

    <span class="k">def</span> <span class="nf">eva_termination</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Early stopper</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_results</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">LOWER_METRIC_LIST</span> <span class="ow">and</span> <span class="n">strictly_increasing</span><span class="p">(</span><span class="n">valid</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LOWER_METRIC_LIST</span> <span class="ow">and</span> <span class="n">strictly_decreasing</span><span class="p">(</span><span class="n">valid</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">-</span> <span class="n">valid</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">best_result</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">valid</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_eval_discriminator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">u_vectors</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">num_disc</span><span class="p">):</span>
        <span class="n">feature_info</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data_processor_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">feature_info</span>
        <span class="n">feature_eval_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_disc</span><span class="p">):</span>
            <span class="n">discriminator</span> <span class="o">=</span> <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="c1"># metric = &#39;auc&#39; if feature_info[i + 1].num_class == 2 else &#39;f1&#39;</span>
            <span class="n">feature_name</span> <span class="o">=</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">discriminator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">num_class</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prediction</span> <span class="o">=</span> <span class="n">discriminator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">u_vectors</span><span class="p">)[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prediction</span> <span class="o">=</span> <span class="n">discriminator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">u_vectors</span><span class="p">)[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
            <span class="n">feature_eval_dict</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
                                               <span class="s1">&#39;num_class&#39;</span><span class="p">:</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">num_class</span><span class="p">}</span>
            <span class="n">discriminator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">feature_eval_dict</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_disc_eval_method</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">num_class</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;auc&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;auc&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_class</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;micro&#39;</span><span class="p">)</span>
                <span class="c1"># score = roc_auc_score(label, prediction)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">score</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">score</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="n">LabelBinarizer</span><span class="p">()</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_class</span><span class="p">)]</span>
                <span class="n">lb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="c1"># label = lb.fit_transform(label)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovo&#39;</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">score</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">score</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown evaluation metric in _disc_eval_method().&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">out_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check intermediate results</span>
<span class="sd">        :param model: model obj</span>
<span class="sd">        :param out_dict: output dictionary</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">out_dict</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="s1">&#39;check&#39;</span><span class="p">]):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">)])</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>

        <span class="n">loss</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="n">model</span><span class="o">.</span><span class="n">l2</span><span class="p">()</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">l2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_weight</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">l2</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;loss = </span><span class="si">%.4f</span><span class="s1">, l2 = </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">l2</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.005</span> <span class="o">&lt;</span> <span class="n">l2</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;l2 inappropriate: loss = </span><span class="si">%.4f</span><span class="s1">, l2 = </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">l2</span><span class="p">))</span>

        <span class="c1"># for discriminator</span>
        <span class="n">disc_score_dict</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;d_score&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">disc_score_dict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> AUC = </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">disc_score_dict</span><span class="p">[</span><span class="n">feature</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">train_discriminator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dp_dict</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">lr_attack</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l2_attack</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train discriminator to evaluate the quality of learned embeddings</span>
<span class="sd">        :param model: trained model</span>
<span class="sd">        :param dp_dict: Data processors for train valid and test</span>
<span class="sd">        :param fair_disc_dict: fairness discriminator dictionary</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_worker</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">)</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_worker</span><span class="p">,</span>
                               <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_time</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 记录初始时间s</span>

        <span class="n">feature_results</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">best_results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_epoch</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_time</span><span class="p">()</span>
                <span class="n">output_dict</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_disc</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
                                  <span class="n">lr_attack</span><span class="o">=</span><span class="n">lr_attack</span><span class="p">,</span> <span class="n">l2_attack</span><span class="o">=</span><span class="n">l2_attack</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_epoch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_epoch</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_disc</span><span class="p">(</span><span class="n">output_dict</span><span class="p">)</span>
                <span class="n">training_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_time</span><span class="p">()</span>

                <span class="n">test_result_dict</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_disc</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])</span>
                <span class="n">d_score_dict</span> <span class="o">=</span> <span class="n">test_result_dict</span><span class="p">[</span><span class="s1">&#39;d_score&#39;</span><span class="p">]</span>
                <span class="c1"># testing_time = self._check_time()</span>
                <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_epoch</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">%5d</span><span class="s2"> [</span><span class="si">%.1f</span><span class="s2"> s]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">training_time</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">d_score_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_epoch</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> AUC= </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="n">d_score_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">]))</span>
                    <span class="n">feature_results</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_score_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">d_score_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">feature_results</span><span class="p">[</span><span class="n">f_name</span><span class="p">]):</span>
                        <span class="n">best_results</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_score_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">dp_dict</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">f_name_2_idx</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span>
                        <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">save_model</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Early stop manually&quot;</span><span class="p">)</span>
            <span class="n">save_here</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Save here? (1/0) (default 0):&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">save_here</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">fair_disc_dict</span><span class="p">:</span>
                    <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">save_model</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">best_results</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> best AUC: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="n">best_results</span><span class="p">[</span><span class="n">f_name</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">fair_disc_dict</span><span class="p">:</span>
            <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fit_disc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_attack</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l2_attack</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train the discriminator</span>
<span class="sd">        :param model: model instance</span>
<span class="sd">        :param batches: train data in batches</span>
<span class="sd">        :param fair_disc_dict: fairness discriminator dictionary</span>
<span class="sd">        :param epoch: epoch number</span>
<span class="sd">        :param lr_attack: attacker learning rate</span>
<span class="sd">        :param l2_attack: l2 regularization weight for attacker</span>
<span class="sd">        :return: return the output of the last round</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">fair_disc_dict</span><span class="p">:</span>
            <span class="n">discriminator</span> <span class="o">=</span> <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">discriminator</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">discriminator</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_optimizer</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_attack</span><span class="p">,</span> <span class="n">l2_weight</span><span class="o">=</span><span class="n">l2_attack</span><span class="p">)</span>
            <span class="n">discriminator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="n">output_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">loss_acc</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="n">eval_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Epoch </span><span class="si">%5d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                          <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">num_features</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_mask</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_features</span><span class="p">)</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch_to_gpu</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
                <span class="n">masked_disc_label</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_masked_disc</span><span class="p">(</span><span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">masked_disc_label</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_masked_disc</span><span class="p">(</span><span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># calculate recommendation loss + fair discriminator penalty</span>
            <span class="n">uids</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">vectors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">apply_filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">uid_embeddings</span><span class="p">(</span><span class="n">uids</span><span class="p">),</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># update discriminator</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">masked_disc_label</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masked_disc_label</span><span class="p">):</span>
                    <span class="n">discriminator</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                    <span class="n">disc_loss</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">vectors</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">label</span><span class="p">)</span>
                    <span class="n">disc_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                    <span class="n">discriminator</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                    <span class="n">loss_acc</span><span class="p">[</span><span class="n">discriminator</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disc_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">loss_acc</span><span class="p">:</span>
            <span class="n">loss_acc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_acc</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_acc</span>
        <span class="k">return</span> <span class="n">output_dict</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">evaluation_disc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">dp</span><span class="p">):</span>
        <span class="n">num_features</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">num_features</span>

        <span class="k">def</span> <span class="nf">eval_disc</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">u_vectors</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
            <span class="n">feature_info</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">data_reader</span><span class="o">.</span><span class="n">feature_info</span>
            <span class="n">feature_eval_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">discriminator</span> <span class="o">=</span> <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="c1"># metric = &#39;auc&#39; if feature_info[i + 1].num_class == 2 else &#39;f1&#39;</span>
                <span class="n">feature_name</span> <span class="o">=</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">discriminator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">num_class</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">prediction</span> <span class="o">=</span> <span class="n">discriminator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">u_vectors</span><span class="p">)[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prediction</span> <span class="o">=</span> <span class="n">discriminator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">u_vectors</span><span class="p">)[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
                <span class="n">feature_eval_dict</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
                                                   <span class="s1">&#39;num_class&#39;</span><span class="p">:</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">num_class</span><span class="p">}</span>
                <span class="n">discriminator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">feature_eval_dict</span>

        <span class="n">eval_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
            <span class="c1"># VERSION 1</span>
            <span class="c1"># if self.no_filter:</span>
            <span class="c1">#     # mask = [0] * model.num_features</span>
            <span class="c1">#     feature_range = np.arange(num_features)</span>
            <span class="c1">#     shape = (feature_range.size, feature_range.max() + 1)</span>
            <span class="c1">#     one_hot = np.zeros(shape).astype(int)</span>
            <span class="c1">#     one_hot[feature_range, feature_range] = 1</span>
            <span class="c1">#     mask_list = one_hot.tolist()</span>
            <span class="c1">#     # if num_features == 3:</span>
            <span class="c1">#     #     mask_list = [[1, 0, 0], [0, 1, 0], [0, 0, 1]]</span>
            <span class="c1">#     # elif num_features == 4:</span>
            <span class="c1">#     #     mask_list = [[1, 0, 0, 0], [0, 1, 0, 0], [0, 0, 1, 0], [0, 0, 0, 1]]</span>
            <span class="c1"># else:</span>
            <span class="c1">#     mask_list = [list(i) for i in it.product([0, 1], repeat=num_features)]</span>
            <span class="c1">#     mask_list.pop(0)</span>

            <span class="c1"># VERSION 2</span>
            <span class="n">mask_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">repeat</span><span class="o">=</span><span class="n">num_features</span><span class="p">)]</span>
            <span class="n">mask_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch_to_gpu</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
            <span class="n">uids</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">mask_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
                    <span class="n">vectors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">uid_embeddings</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vectors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">apply_filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">uid_embeddings</span><span class="p">(</span><span class="n">uids</span><span class="p">),</span> <span class="n">mask</span><span class="p">)</span>
                <span class="n">batch_eval_dict</span> <span class="o">=</span> <span class="n">eval_disc</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">vectors</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">batch_eval_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eval_dict</span><span class="p">:</span>
                        <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_label</span> <span class="o">=</span> <span class="n">batch_eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                        <span class="n">current_label</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                        <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">current_label</span><span class="p">,</span> <span class="n">new_label</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                        <span class="n">new_prediction</span> <span class="o">=</span> <span class="n">batch_eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span>
                        <span class="n">current_prediction</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span>
                        <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">current_prediction</span><span class="p">,</span> <span class="n">new_prediction</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># generate discriminator evaluation scores</span>
        <span class="n">d_score_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">eval_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">eval_dict</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span>
                <span class="n">n_class</span> <span class="o">=</span> <span class="n">eval_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="s1">&#39;num_class&#39;</span><span class="p">]</span>
                <span class="n">d_score_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eval_method</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">n_class</span><span class="p">)</span>

        <span class="n">output_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;d_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_score_dict</span>
        <span class="k">return</span> <span class="n">output_dict</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_disc</span><span class="p">(</span><span class="n">out_dict</span><span class="p">):</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">out_dict</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="s1">&#39;check&#39;</span><span class="p">]):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">)])</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>

        <span class="n">loss_dict</span> <span class="o">=</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">disc_name</span><span class="p">,</span> <span class="n">disc_loss</span> <span class="ow">in</span> <span class="n">loss_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> loss = </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">disc_name</span><span class="p">,</span> <span class="n">disc_loss</span><span class="p">))</span>

        <span class="c1"># for discriminator</span>
        <span class="k">if</span> <span class="s1">&#39;d_score&#39;</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="p">:</span>
            <span class="n">disc_score_dict</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;d_score&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">disc_score_dict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> AUC = </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">disc_score_dict</span><span class="p">[</span><span class="n">feature</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Utils">Utils<a class="anchor-link" href="#Utils"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">balance_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">pos_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">copy_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_indexes</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_indexes</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">copy_num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">copy_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pos_indexes</span><span class="p">,</span> <span class="n">copy_num</span><span class="p">)</span>
        <span class="n">sample_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">])),</span> <span class="n">copy_indexes</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">sample_index</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">input_data_is_list</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;input_data_is_list&quot;</span><span class="p">)</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">new_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">new_data</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">format_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">):</span>
    <span class="c1"># print(metric, type(metric))</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="p">]</span>
    <span class="n">format_str</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="c1"># print(type(m))</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">format_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
                <span class="n">format_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">format_str</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">shuffle_in_unison_scary</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    shuffle entire dataset</span>
<span class="sd">    :param data:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">rng_state</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">best_result</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">results_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">LOWER_METRIC_LIST</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">results_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">results_list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">strictly_increasing</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>


<span class="k">def</span> <span class="nf">strictly_decreasing</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>


<span class="k">def</span> <span class="nf">non_increasing</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>


<span class="k">def</span> <span class="nf">non_decreasing</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>


<span class="k">def</span> <span class="nf">monotonic</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">non_increasing</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="n">non_decreasing</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">numpy_to_torch</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t</span>


<span class="k">def</span> <span class="nf">str2bool</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="s1">&#39;Boolean value expected.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">batch_to_gpu</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
                <span class="n">batch</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">batch</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Metrics">Metrics<a class="anchor-link" href="#Metrics"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">mean_reciprocal_rank</span><span class="p">(</span><span class="n">rs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score is reciprocal of the rank of the first relevant item</span>
<span class="sd">    First element is &#39;rank 1&#39;.  Relevance is binary (nonzero is relevant).</span>
<span class="sd">    Example from http://en.wikipedia.org/wiki/Mean_reciprocal_rank</span>
<span class="sd">    &gt;&gt;&gt; rs = [[0, 0, 1], [0, 1, 0], [1, 0, 0]]</span>
<span class="sd">    &gt;&gt;&gt; mean_reciprocal_rank(rs)</span>
<span class="sd">    0.61111111111111105</span>
<span class="sd">    &gt;&gt;&gt; rs = np.array([[0, 0, 0], [0, 1, 0], [1, 0, 0]])</span>
<span class="sd">    &gt;&gt;&gt; mean_reciprocal_rank(rs)</span>
<span class="sd">    0.5</span>
<span class="sd">    &gt;&gt;&gt; rs = [[0, 0, 0, 1], [1, 0, 0], [1, 0, 0]]</span>
<span class="sd">    &gt;&gt;&gt; mean_reciprocal_rank(rs)</span>
<span class="sd">    0.75</span>
<span class="sd">    Args:</span>
<span class="sd">        rs: Iterator of relevance scores (list or numpy) in rank order</span>
<span class="sd">            (first element is the first item)</span>
<span class="sd">    Returns:</span>
<span class="sd">        Mean reciprocal rank</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mf">0.</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">reciprocal_rank</span><span class="p">(</span><span class="n">rs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score is reciprocal of the rank of the first relevant item</span>
<span class="sd">    Args:</span>
<span class="sd">        rs: Iterator of relevance scores (list or numpy) in rank order</span>
<span class="sd">            (first element is the first item)</span>
<span class="sd">    Returns:</span>
<span class="sd">        reciprocal rank</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mf">0.</span>


<span class="k">def</span> <span class="nf">r_precision</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score is precision after all relevant documents have been retrieved</span>
<span class="sd">    Relevance is binary (nonzero is relevant).</span>
<span class="sd">    &gt;&gt;&gt; r = [0, 0, 1]</span>
<span class="sd">    &gt;&gt;&gt; r_precision(r)</span>
<span class="sd">    0.33333333333333331</span>
<span class="sd">    &gt;&gt;&gt; r = [0, 1, 0]</span>
<span class="sd">    &gt;&gt;&gt; r_precision(r)</span>
<span class="sd">    0.5</span>
<span class="sd">    &gt;&gt;&gt; r = [1, 0, 0]</span>
<span class="sd">    &gt;&gt;&gt; r_precision(r)</span>
<span class="sd">    1.0</span>
<span class="sd">    Args:</span>
<span class="sd">        r: Relevance scores (list or numpy) in rank order</span>
<span class="sd">            (first element is the first item)</span>
<span class="sd">    Returns:</span>
<span class="sd">        R Precision</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">z</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r</span><span class="p">[:</span><span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">precision_at_k</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score is precision @ k</span>
<span class="sd">    Relevance is binary (nonzero is relevant).</span>
<span class="sd">    &gt;&gt;&gt; r = [0, 0, 1]</span>
<span class="sd">    &gt;&gt;&gt; precision_at_k(r, 1)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; precision_at_k(r, 2)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; precision_at_k(r, 3)</span>
<span class="sd">    0.33333333333333331</span>
<span class="sd">    &gt;&gt;&gt; precision_at_k(r, 4)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        File &quot;&lt;stdin&gt;&quot;, line 1, in ?</span>
<span class="sd">    ValueError: Relevance score length &lt; k</span>
<span class="sd">    Args:</span>
<span class="sd">        r: Relevance scores (list or numpy) in rank order</span>
<span class="sd">            (first element is the first item)</span>
<span class="sd">    Returns:</span>
<span class="sd">        Precision @ k</span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: len(r) must be &gt;= k</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">)[:</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Relevance score length &lt; k&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">average_precision</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score is average precision (area under PR curve)</span>
<span class="sd">    Relevance is binary (nonzero is relevant).</span>
<span class="sd">    &gt;&gt;&gt; r = [1, 1, 0, 1, 0, 1, 0, 0, 0, 1]</span>
<span class="sd">    &gt;&gt;&gt; delta_r = 1. / sum(r)</span>
<span class="sd">    &gt;&gt;&gt; sum([sum(r[:x + 1]) / (x + 1.) * delta_r for x, y in enumerate(r) if y])</span>
<span class="sd">    0.7833333333333333</span>
<span class="sd">    &gt;&gt;&gt; average_precision(r)</span>
<span class="sd">    0.78333333333333333</span>
<span class="sd">    Args:</span>
<span class="sd">        r: Relevance scores (list or numpy) in rank order</span>
<span class="sd">            (first element is the first item)</span>
<span class="sd">    Returns:</span>
<span class="sd">        Average precision</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">precision_at_k</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mean_average_precision</span><span class="p">(</span><span class="n">rs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score is mean average precision</span>
<span class="sd">    Relevance is binary (nonzero is relevant).</span>
<span class="sd">    &gt;&gt;&gt; rs = [[1, 1, 0, 1, 0, 1, 0, 0, 0, 1]]</span>
<span class="sd">    &gt;&gt;&gt; mean_average_precision(rs)</span>
<span class="sd">    0.78333333333333333</span>
<span class="sd">    &gt;&gt;&gt; rs = [[1, 1, 0, 1, 0, 1, 0, 0, 0, 1], [0]]</span>
<span class="sd">    &gt;&gt;&gt; mean_average_precision(rs)</span>
<span class="sd">    0.39166666666666666</span>
<span class="sd">    Args:</span>
<span class="sd">        rs: Iterator of relevance scores (list or numpy) in rank order</span>
<span class="sd">            (first element is the first item)</span>
<span class="sd">    Returns:</span>
<span class="sd">        Mean average precision</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">average_precision</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">dcg_at_k</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score is discounted cumulative gain (dcg)</span>
<span class="sd">    Relevance is positive real values.  Can use binary</span>
<span class="sd">    as the previous methods.</span>
<span class="sd">    Example from</span>
<span class="sd">    http://www.stanford.edu/class/cs276/handouts/EvaluationNew-handout-6-per.pdf</span>
<span class="sd">    &gt;&gt;&gt; r = [3, 2, 3, 0, 0, 1, 2, 2, 3, 0]</span>
<span class="sd">    &gt;&gt;&gt; dcg_at_k(r, 1)</span>
<span class="sd">    3.0</span>
<span class="sd">    &gt;&gt;&gt; dcg_at_k(r, 1, method=1)</span>
<span class="sd">    3.0</span>
<span class="sd">    &gt;&gt;&gt; dcg_at_k(r, 2)</span>
<span class="sd">    5.0</span>
<span class="sd">    &gt;&gt;&gt; dcg_at_k(r, 2, method=1)</span>
<span class="sd">    4.2618595071429155</span>
<span class="sd">    &gt;&gt;&gt; dcg_at_k(r, 10)</span>
<span class="sd">    9.6051177391888114</span>
<span class="sd">    &gt;&gt;&gt; dcg_at_k(r, 11)</span>
<span class="sd">    9.6051177391888114</span>
<span class="sd">    Args:</span>
<span class="sd">        r: Relevance scores (list or numpy) in rank order</span>
<span class="sd">            (first element is the first item)</span>
<span class="sd">        k: Number of results to consider</span>
<span class="sd">        method: If 0 then weights are [1.0, 1.0, 0.6309, 0.5, 0.4307, ...]</span>
<span class="sd">                If 1 then weights are [1.0, 0.6309, 0.5, 0.4307, ...]</span>
<span class="sd">    Returns:</span>
<span class="sd">        Discounted cumulative gain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfarray</span><span class="p">(</span><span class="n">r</span><span class="p">)[:</span><span class="n">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;method must be 0 or 1.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.</span>


<span class="k">def</span> <span class="nf">ndcg_at_k</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score is normalized discounted cumulative gain (ndcg)</span>
<span class="sd">    Relevance is positive real values.  Can use binary</span>
<span class="sd">    as the previous methods.</span>
<span class="sd">    Example from</span>
<span class="sd">    http://www.stanford.edu/class/cs276/handouts/EvaluationNew-handout-6-per.pdf</span>
<span class="sd">    &gt;&gt;&gt; r = [3, 2, 3, 0, 0, 1, 2, 2, 3, 0]</span>
<span class="sd">    &gt;&gt;&gt; ndcg_at_k(r, 1)</span>
<span class="sd">    1.0</span>
<span class="sd">    &gt;&gt;&gt; r = [2, 1, 2, 0]</span>
<span class="sd">    &gt;&gt;&gt; ndcg_at_k(r, 4)</span>
<span class="sd">    0.9203032077642922</span>
<span class="sd">    &gt;&gt;&gt; ndcg_at_k(r, 4, method=1)</span>
<span class="sd">    0.96519546960144276</span>
<span class="sd">    &gt;&gt;&gt; ndcg_at_k([0], 1)</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; ndcg_at_k([1], 2)</span>
<span class="sd">    1.0</span>
<span class="sd">    Args:</span>
<span class="sd">        r: Relevance scores (list or numpy) in rank order</span>
<span class="sd">            (first element is the first item)</span>
<span class="sd">        k: Number of results to consider</span>
<span class="sd">        method: If 0 then weights are [1.0, 1.0, 0.6309, 0.5, 0.4307, ...]</span>
<span class="sd">                If 1 then weights are [1.0, 0.6309, 0.5, 0.4307, ...]</span>
<span class="sd">    Returns:</span>
<span class="sd">        Normalized discounted cumulative gain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dcg_max</span> <span class="o">=</span> <span class="n">dcg_at_k</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">k</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dcg_max</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">dcg_at_k</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span> <span class="o">/</span> <span class="n">dcg_max</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Jobs">Jobs<a class="anchor-link" href="#Jobs"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="c1"># python ./main.py --model_name BiasedMF --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/biasedMF_ml1m_no_filter_neg_sample=100/biasedMF_ml1m_l2=1e-4_dim=64_no_filter_neg_sample=100.pt&quot; --runner RecRunner --d_step 10 --vt_num_neg 100 --vt_batch_size 1024 --no_filter --eval_dict</span>
<span class="c1"># python ./main.py --model_name PMF --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/PMF_ml1m_no_filter_neg_sample=100/PMF_ml1m_l2=1e-4_dim=64_no_filter_neg_sample=100.pt&quot; --runner RecRunner --d_step 10 --vt_num_neg 100 --vt_batch_size 1024 --no_filter --eval_disc</span>
<span class="c1"># python ./main.py --model_name DMF --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/DMF_ml1m_no_filter_neg_sample=100/DMF_ml1m_l2=1e-4_dim=64_no_filter_neg_sample=100.pt&quot; --runner RecRunner --d_step 10 --vt_num_neg 100 --vt_batch_size 1024 --no_filter --eval_disc</span>
<span class="c1"># python ./main.py --model_name MLP --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/MLP_ml1m_no_filter_neg_sample=100/MLP_ml1m_l2=1e-4_dim=64_no_filter_neg_sample=100.pt&quot; --runner RecRunner --d_step 10 --vt_num_neg 100 --vt_batch_size 1024 --no_filter --eval_disc</span>

<span class="c1"># # Sample command for separate method</span>
<span class="c1"># python ./main.py --model_name BiasedMF --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/biasedMF_ml1m_neg_sample=100_reg_weight=20_separate/biasedMF_ml1m_l2=1e-4_dim=64_reg_weight=20_neg_sample=100_separate.pt&quot; --runner RecRunner --d_step 10 --reg_weight 20 --epoch 200 --vt_num_neg 100 --vt_batch_size 1024 --filter_mode separate --fix_one --eval_disc</span>
<span class="c1"># python ./main.py --model_name PMF --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/PMF_ml1m_neg_sample=100_reg_weight=20_separate/PMF_ml1m_l2=1e-4_dim=64_reg_weight=20_neg_sample=100_separate.pt&quot; --runner RecRunner --d_step 10 --reg_weight 20 --epoch 200 --vt_num_neg 100 --vt_batch_size 1024 --filter_mode separate --fix_one --eval_disc</span>
<span class="c1"># python ./main.py --model_name DMF --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/DMF_ml1m_neg_sample=100_reg_weight=20_separate/DMF_ml1m_l2=1e-4_dim=64_reg_weight=20_neg_sample=100_separate.pt&quot; --runner RecRunner --d_step 10 --reg_weight 20 --epoch 200 --vt_num_neg 100 --vt_batch_size 1024 --filter_mode separate --fix_one --eval_disc</span>
<span class="c1"># python ./main.py --model_name MLP --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --u_vector_size 32 --batch_size 1024 --model_path &quot;../model/MLP_ml1m_neg_sample=100_reg_weight=20_separate/MLP_ml1m_l2=1e-4_dim=32_reg_weight=20_neg_sample=100_separate.pt&quot; --runner RecRunner --d_step 10 --reg_weight 20 --vt_num_neg 100 --vt_batch_size 1024 --fix_one --filter_mode separate --eval_disc</span>

<span class="c1"># # Sample command for combination method</span>
<span class="c1"># python ./main.py --model_name BiasedMF --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/biasedMF_ml1m_reg_weight=20_neg_sample=100_combine/biasedMF_ml1m_l2=1e-4_dim=64_reg_weight=20_neg_sample=100_combine.pt&quot; --runner RecRunner --d_step 10 --reg_weight 20 --vt_num_neg 100 --vt_batch_size 1024 --fix_one --eval_disc</span>
<span class="c1"># python ./main.py --model_name PMF --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/PMF_ml1m_reg_weight=20_neg_sample=100_combine/PMF_ml1m_l2=1e-4_dim=64_reg_weight=20_neg_sample=100_combine.pt&quot; --runner RecRunner --d_step 10 --reg_weight 20 --vt_num_neg 100 --vt_batch_size 1024 --fix_one --eval_disc</span>
<span class="c1"># python ./main.py --model_name DMF --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --batch_size 1024 --model_path &quot;../model/DMF_ml1m_reg_weight=20_neg_sample=100_combine/DMF_ml1m_l2=1e-4_dim=64_reg_weight=20_neg_sample=100_combine.pt&quot; --runner RecRunner --d_step 10 --reg_weight 20 --vt_num_neg 100 --vt_batch_size 1024 --fix_one --eval_disc</span>
<span class="c1"># python ./main.py --model_name MLP --optimizer Adam --dataset ml1M --data_processor RecDataset --metric ndcg@5,ndcg@10,hit@5,hit@10 --l2 1e-4 --u_vector_size 32 --batch_size 1024 --model_path &quot;../model/MLP_ml1m_l2=1e-4_dim=32_reg_weight=20_neg_sample=100/MLP_ml1m_l2=1e-4_dim=32_reg_weight=20_neg_sample=100.pt&quot; --runner RecRunner --d_step 10 --vt_num_neg 100 --vt_batch_size 1024 --reg_weight 20 --fix_one --eval_disc</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">download_movielens</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>09-Nov-21 11:23:26 [INFO] : Files already exists in /content/ml1M, skipping!
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">args</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;PMF&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">data_reader_name</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_reader</span><span class="p">)</span>

<span class="c1"># choose model</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
<span class="n">runner_name</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">runner</span><span class="p">)</span>

<span class="c1"># choose data_processor</span>
<span class="n">data_processor_name</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_processor</span><span class="p">)</span>

<span class="c1"># logging</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;DataReader: &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">data_reader</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Model: &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Runner: &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">runner</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;DataProcessor: &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">data_processor</span><span class="p">)</span>

<span class="c1"># random seed</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>

<span class="c1"># cuda</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">gpu</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# cuda devices: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>09-Nov-21 11:23:28 [INFO] : DataReader: RecDataReader
09-Nov-21 11:23:28 [INFO] : Model: PMF
09-Nov-21 11:23:28 [INFO] : Runner: RecRunner
09-Nov-21 11:23:28 [INFO] : DataProcessor: RecDataset
09-Nov-21 11:23:29 [INFO] : # cuda devices: 0
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">data_reader</span> <span class="o">=</span> <span class="n">data_reader_name</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>09-Nov-21 11:23:34 [INFO] : load all csv...
09-Nov-21 11:23:35 [INFO] : load train csv...
09-Nov-21 11:23:35 [INFO] : size of train: 800169
09-Nov-21 11:23:35 [INFO] : load validation csv...
09-Nov-21 11:23:35 [INFO] : size of validation: 100020
09-Nov-21 11:23:35 [INFO] : load test csv...
09-Nov-21 11:23:36 [INFO] : size of test: 100020
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">data_processor_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">data_processor</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RecDataset&#39;</span><span class="p">]:</span>
            <span class="n">data_processor_dict</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_processor_name</span><span class="p">(</span>
                <span class="n">data_reader</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_neg</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">train_num_neg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown DataProcessor&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">data_processor</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RecDataset&#39;</span><span class="p">]:</span>
            <span class="n">data_processor_dict</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_processor_name</span><span class="p">(</span>
                <span class="n">data_reader</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">vt_batch_size</span><span class="p">,</span> <span class="n">num_neg</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">vt_num_neg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown DataProcessor&#39;</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>09-Nov-21 11:25:21 [INFO] : Prepare validation data...
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;BiasedMF&#39;</span><span class="p">,</span> <span class="s1">&#39;PMF&#39;</span><span class="p">]:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model_name</span><span class="p">(</span><span class="n">data_processor_dict</span><span class="p">,</span> <span class="n">user_num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_reader</span><span class="o">.</span><span class="n">user_ids_set</span><span class="p">),</span>
                        <span class="n">item_num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_reader</span><span class="o">.</span><span class="n">item_ids_set</span><span class="p">),</span> <span class="n">u_vector_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">u_vector_size</span><span class="p">,</span>
                        <span class="n">i_vector_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">i_vector_size</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                        <span class="n">model_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="n">filter_mode</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">filter_mode</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DMF&#39;</span><span class="p">,</span> <span class="s1">&#39;MLP&#39;</span><span class="p">]:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model_name</span><span class="p">(</span><span class="n">data_processor_dict</span><span class="p">,</span> <span class="n">user_num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_reader</span><span class="o">.</span><span class="n">user_ids_set</span><span class="p">),</span>
                        <span class="n">item_num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_reader</span><span class="o">.</span><span class="n">item_ids_set</span><span class="p">),</span> <span class="n">u_vector_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">u_vector_size</span><span class="p">,</span>
                        <span class="n">i_vector_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">i_vector_size</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                        <span class="n">random_seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                        <span class="n">model_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="n">filter_mode</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">filter_mode</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unknown Model: &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>

<span class="c1"># init model params</span>
<span class="n">model</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">init_weights</span><span class="p">)</span>

<span class="c1"># use gpu</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">fair_disc_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">feat_idx</span> <span class="ow">in</span> <span class="n">data_reader</span><span class="o">.</span><span class="n">feature_info</span><span class="p">:</span>
    <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">Discriminator</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">u_vector_size</span><span class="p">,</span> <span class="n">data_reader</span><span class="o">.</span><span class="n">feature_info</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">],</span>
                        <span class="n">random_seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span> <span class="n">neg_slope</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">neg_slope</span><span class="p">,</span>
                        <span class="n">model_dir_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_path</span><span class="p">))</span>
    <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">init_weights</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">runner</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;BaseRunner&#39;</span><span class="p">]:</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">runner_name</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span>
        <span class="n">epoch</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">eval_batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">vt_batch_size</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">l2</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">check_epoch</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">check_epoch</span><span class="p">,</span> <span class="n">early_stop</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">early_stop</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">runner</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RecRunner&#39;</span><span class="p">]:</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">runner_name</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span>
        <span class="n">epoch</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">eval_batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">vt_batch_size</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">l2</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">check_epoch</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">check_epoch</span><span class="p">,</span> <span class="n">early_stop</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">early_stop</span><span class="p">,</span> <span class="n">num_worker</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_worker</span><span class="p">,</span>
        <span class="n">no_filter</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">no_filter</span><span class="p">,</span> <span class="n">reg_weight</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">reg_weight</span><span class="p">,</span> <span class="n">d_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">d_steps</span><span class="p">,</span> <span class="n">disc_epoch</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">disc_epoch</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unknown Runner: &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">runner</span><span class="p">)</span>

<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">fair_disc_dict</span><span class="p">:</span>
        <span class="n">fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">train</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_processor_dict</span><span class="p">,</span> <span class="n">fair_disc_dict</span><span class="p">,</span> <span class="n">skip_eval</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">skip_eval</span><span class="p">,</span> <span class="n">fix_one</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">fix_one</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>

<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_disc</span><span class="p">:</span>
    <span class="c1"># Train extra discriminator for evaluation</span>
    <span class="c1"># create data reader</span>
    <span class="n">disc_data_reader</span> <span class="o">=</span> <span class="n">DiscriminatorDataReader</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

    <span class="c1"># create data processor</span>
    <span class="n">extra_data_processor_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]:</span>
        <span class="n">extra_data_processor_dict</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span> <span class="o">=</span> <span class="n">DiscriminatorDataset</span><span class="p">(</span><span class="n">disc_data_reader</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">disc_batch_size</span><span class="p">)</span>

    <span class="c1"># create discriminators</span>
    <span class="n">extra_fair_disc_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">feat_idx</span> <span class="ow">in</span> <span class="n">disc_data_reader</span><span class="o">.</span><span class="n">feature_info</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">disc_data_reader</span><span class="o">.</span><span class="n">feature_info</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">num_class</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">extra_fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">BinaryAttacker</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">u_vector_size</span><span class="p">,</span> <span class="n">disc_data_reader</span><span class="o">.</span><span class="n">feature_info</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">],</span>
                                <span class="n">random_seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                                <span class="n">neg_slope</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">neg_slope</span><span class="p">,</span> <span class="n">model_dir_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_path</span><span class="p">),</span>
                                <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">MultiClassAttacker</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">u_vector_size</span><span class="p">,</span> <span class="n">disc_data_reader</span><span class="o">.</span><span class="n">feature_info</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">],</span>
                                    <span class="n">random_seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span> <span class="n">neg_slope</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">neg_slope</span><span class="p">,</span>
                                    <span class="n">model_dir_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_path</span><span class="p">),</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
        <span class="n">extra_fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">extra_fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">init_weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">extra_fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_fair_disc_dict</span><span class="p">[</span><span class="n">feat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load_attack</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">extra_fair_disc_dict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;load attacker model...&#39;</span><span class="p">)</span>
            <span class="n">extra_fair_disc_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">freeze_model</span><span class="p">()</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">train_discriminator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">extra_data_processor_dict</span><span class="p">,</span> <span class="n">extra_fair_disc_dict</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">lr_attack</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">l2_attack</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">test_data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data_processor_dict</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_worker</span><span class="p">,</span>
                        <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">data_processor_dict</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">)</span>

<span class="n">test_result_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
    <span class="n">test_result</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">test_result</span><span class="p">,</span> <span class="n">test_result_dict</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">eval_multi_combination</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">fix_one</span><span class="p">)</span>

<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_filter</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test After Training = </span><span class="si">%s</span><span class="s2"> &quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">format_metric</span><span class="p">(</span><span class="n">test_result</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">metrics</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test After Training:</span><span class="se">\t</span><span class="s2"> Average: </span><span class="si">%s</span><span class="s2"> &quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">format_metric</span><span class="p">(</span><span class="n">test_result</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">metrics</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">test_result_dict</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;test= </span><span class="si">%s</span><span class="s2"> &quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">format_metric</span><span class="p">(</span><span class="n">test_result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;) &#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>

<script type="application/vnd.jupyter.widget-state+json">
{"b5c1118b4bfb4f9fa0695e91163a1e47": {"model_module": "@jupyter-widgets/controls", "model_name": "HBoxModel", "model_module_version": "1.5.0", "state": {"_view_name": "HBoxView", "_dom_classes": [], "_model_name": "HBoxModel", "_view_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_view_count": null, "_view_module_version": "1.5.0", "box_style": "", "layout": "IPY_MODEL_47532d7cbe0a4c5fb1f1b3575d836ea9", "_model_module": "@jupyter-widgets/controls", "children": ["IPY_MODEL_32db06de410a4481a5ca0b75b42f7ec2", "IPY_MODEL_f0c36db39c5746e79a5643c8dcb21abf", "IPY_MODEL_2d8aeab54e2d4b0ab739c96445f91394"]}}, "47532d7cbe0a4c5fb1f1b3575d836ea9": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "model_module_version": "1.2.0", "state": {"_view_name": "LayoutView", "grid_template_rows": null, "right": null, "justify_content": null, "_view_module": "@jupyter-widgets/base", "overflow": null, "_model_module_version": "1.2.0", "_view_count": null, "flex_flow": "row wrap", "width": "100px", "min_width": null, "border": null, "align_items": null, "bottom": null, "_model_module": "@jupyter-widgets/base", "top": null, "grid_column": null, "overflow_y": null, "overflow_x": null, "grid_auto_flow": null, "grid_area": null, "grid_template_columns": null, "flex": null, "_model_name": "LayoutModel", "justify_items": null, "grid_row": null, "max_height": null, "align_content": null, "visibility": null, "align_self": null, "height": null, "min_height": null, "padding": null, "grid_auto_rows": null, "grid_gap": null, "max_width": null, "order": null, "_view_module_version": "1.2.0", "grid_template_areas": null, "object_position": null, "object_fit": null, "grid_auto_columns": null, "margin": null, "display": "inline-flex", "left": null}}, "32db06de410a4481a5ca0b75b42f7ec2": {"model_module": "@jupyter-widgets/controls", "model_name": "HTMLModel", "model_module_version": "1.5.0", "state": {"_view_name": "HTMLView", "style": "IPY_MODEL_a39ae408211c46bd95e4a333f2eabbff", "_dom_classes": [], "description": "", "_model_name": "HTMLModel", "placeholder": "\u200b", "_view_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "value": "Prepare Batches:  61%", "_view_count": null, "_view_module_version": "1.5.0", "description_tooltip": null, "_model_module": "@jupyter-widgets/controls", "layout": "IPY_MODEL_79f7f84ff4b640c7bc7c3cc40f161798"}}, "f0c36db39c5746e79a5643c8dcb21abf": {"model_module": "@jupyter-widgets/controls", "model_name": "FloatProgressModel", "model_module_version": "1.5.0", "state": {"_view_name": "ProgressView", "style": "IPY_MODEL_62be46a350e846a5995ccad4fc4a5954", "_dom_classes": [], "description": "", "_model_name": "FloatProgressModel", "bar_style": "", "max": 196, "_view_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "value": 120, "_view_count": null, "_view_module_version": "1.5.0", "orientation": "horizontal", "min": 0, "description_tooltip": null, "_model_module": "@jupyter-widgets/controls", "layout": "IPY_MODEL_b720c3aaf1644da789fdad2d70251972"}}, "2d8aeab54e2d4b0ab739c96445f91394": {"model_module": "@jupyter-widgets/controls", "model_name": "HTMLModel", "model_module_version": "1.5.0", "state": {"_view_name": "HTMLView", "style": "IPY_MODEL_4a16f523a0ca4d83b0dd9ce12ff32e4e", "_dom_classes": [], "description": "", "_model_name": "HTMLModel", "placeholder": "\u200b", "_view_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "value": " 120/196 [15:05&lt;11:21,  8.97s/it]", "_view_count": null, "_view_module_version": "1.5.0", "description_tooltip": null, "_model_module": "@jupyter-widgets/controls", "layout": "IPY_MODEL_e02966e60c78464496a57d61417d7aa1"}}, "a39ae408211c46bd95e4a333f2eabbff": {"model_module": "@jupyter-widgets/controls", "model_name": "DescriptionStyleModel", "model_module_version": "1.5.0", "state": {"_view_name": "StyleView", "_model_name": "DescriptionStyleModel", "description_width": "", "_view_module": "@jupyter-widgets/base", "_model_module_version": "1.5.0", "_view_count": null, "_view_module_version": "1.2.0", "_model_module": "@jupyter-widgets/controls"}}, "79f7f84ff4b640c7bc7c3cc40f161798": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "model_module_version": "1.2.0", "state": {"_view_name": "LayoutView", "grid_template_rows": null, "right": null, "justify_content": null, "_view_module": "@jupyter-widgets/base", "overflow": null, "_model_module_version": "1.2.0", "_view_count": null, "flex_flow": null, "width": null, "min_width": null, "border": null, "align_items": null, "bottom": null, "_model_module": "@jupyter-widgets/base", "top": null, "grid_column": null, "overflow_y": null, "overflow_x": null, "grid_auto_flow": null, "grid_area": null, "grid_template_columns": null, "flex": null, "_model_name": "LayoutModel", "justify_items": null, "grid_row": null, "max_height": null, "align_content": null, "visibility": null, "align_self": null, "height": null, "min_height": null, "padding": null, "grid_auto_rows": null, "grid_gap": null, "max_width": null, "order": null, "_view_module_version": "1.2.0", "grid_template_areas": null, "object_position": null, "object_fit": null, "grid_auto_columns": null, "margin": null, "display": null, "left": null}}, "62be46a350e846a5995ccad4fc4a5954": {"model_module": "@jupyter-widgets/controls", "model_name": "ProgressStyleModel", "model_module_version": "1.5.0", "state": {"_view_name": "StyleView", "_model_name": "ProgressStyleModel", "description_width": "", "_view_module": "@jupyter-widgets/base", "_model_module_version": "1.5.0", "_view_count": null, "_view_module_version": "1.2.0", "bar_color": null, "_model_module": "@jupyter-widgets/controls"}}, "b720c3aaf1644da789fdad2d70251972": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "model_module_version": "1.2.0", "state": {"_view_name": "LayoutView", "grid_template_rows": null, "right": null, "justify_content": null, "_view_module": "@jupyter-widgets/base", "overflow": null, "_model_module_version": "1.2.0", "_view_count": null, "flex_flow": null, "width": null, "min_width": null, "border": null, "align_items": null, "bottom": null, "_model_module": "@jupyter-widgets/base", "top": null, "grid_column": null, "overflow_y": null, "overflow_x": null, "grid_auto_flow": null, "grid_area": null, "grid_template_columns": null, "flex": "2", "_model_name": "LayoutModel", "justify_items": null, "grid_row": null, "max_height": null, "align_content": null, "visibility": null, "align_self": null, "height": null, "min_height": null, "padding": null, "grid_auto_rows": null, "grid_gap": null, "max_width": null, "order": null, "_view_module_version": "1.2.0", "grid_template_areas": null, "object_position": null, "object_fit": null, "grid_auto_columns": null, "margin": null, "display": null, "left": null}}, "4a16f523a0ca4d83b0dd9ce12ff32e4e": {"model_module": "@jupyter-widgets/controls", "model_name": "DescriptionStyleModel", "model_module_version": "1.5.0", "state": {"_view_name": "StyleView", "_model_name": "DescriptionStyleModel", "description_width": "", "_view_module": "@jupyter-widgets/base", "_model_module_version": "1.5.0", "_view_count": null, "_view_module_version": "1.2.0", "_model_module": "@jupyter-widgets/controls"}}, "e02966e60c78464496a57d61417d7aa1": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "model_module_version": "1.2.0", "state": {"_view_name": "LayoutView", "grid_template_rows": null, "right": null, "justify_content": null, "_view_module": "@jupyter-widgets/base", "overflow": null, "_model_module_version": "1.2.0", "_view_count": null, "flex_flow": null, "width": null, "min_width": null, "border": null, "align_items": null, "bottom": null, "_model_module": "@jupyter-widgets/base", "top": null, "grid_column": null, "overflow_y": null, "overflow_x": null, "grid_auto_flow": null, "grid_area": null, "grid_template_columns": null, "flex": null, "_model_name": "LayoutModel", "justify_items": null, "grid_row": null, "max_height": null, "align_content": null, "visibility": null, "align_self": null, "height": null, "min_height": null, "padding": null, "grid_auto_rows": null, "grid_gap": null, "max_width": null, "order": null, "_view_module_version": "1.2.0", "grid_template_areas": null, "object_position": null, "object_fit": null, "grid_auto_columns": null, "margin": null, "display": null, "left": null}}}
</script>



  </div><a class="u-url" href="/2022/01/24/fairness.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
