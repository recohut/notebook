<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Off-Policy Evaluation for Slate Recommendation | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Off-Policy Evaluation for Slate Recommendation" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/24/ope-slate.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/24/ope-slate.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-24T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Off-Policy Evaluation for Slate Recommendation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-24T00:00:00-06:00","datePublished":"2022-01-24T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Off-Policy Evaluation for Slate Recommendation","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/24/ope-slate.html"},"url":"https://nb.recohut.com/2022/01/24/ope-slate.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Off-Policy Evaluation for Slate Recommendation</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-24T00:00:00-06:00" itemprop="datePublished">
        Jan 24, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      23 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-24-ope-slate.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-24-ope-slate.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-24-ope-slate.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-24-ope-slate.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-24-ope-slate.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Imports">Imports<a class="anchor-link" href="#Imports"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sklearn.model_selection</span>
<span class="kn">import</span> <span class="nn">sklearn.tree</span>
<span class="kn">import</span> <span class="nn">sklearn.linear_model</span>
<span class="kn">import</span> <span class="nn">sklearn.tree</span>
<span class="kn">import</span> <span class="nn">sklearn.ensemble</span>
<span class="kn">from</span> <span class="nn">sklearn.externals</span> <span class="kn">import</span> <span class="n">joblib</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span>
<span class="kn">import</span> <span class="nn">itertools</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Settings">Settings<a class="anchor-link" href="#Settings"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">DATA_DIR</span><span class="o">=</span><span class="s2">&quot;/content&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">get_feature_sets</span><span class="p">(</span><span class="n">datasetName</span><span class="p">):</span>
    <span class="n">anchorURL</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bodyDoc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">datasetName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MSLR&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
            <span class="n">anchorURL</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">bodyDoc</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">anchorURL</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">126</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">131</span><span class="p">])</span>
        <span class="n">bodyDoc</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">132</span><span class="p">,</span><span class="mi">133</span><span class="p">])</span>
        
    <span class="k">elif</span> <span class="n">datasetName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MQ200&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">anchorURL</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">bodyDoc</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">anchorURL</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Settings:get_feature_sets [ERR] Unknown dataset. Use MSLR/MQ200*&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">anchorURL</span><span class="p">,</span> <span class="n">bodyDoc</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Datasets">Datasets<a class="anchor-link" href="#Datasets"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Classes that pre-process datasets for semi-synthetic experiments</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Datasets</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#Must call either loadTxt(...)/loadNpz(...) to set all these members</span>
        <span class="c1">#before using Datasets objects elsewhere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relevances</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queryMappings</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span>
    
        <span class="c1">#For filtered datasets, some docsPerQuery may be masked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span>
        
    <span class="c1">###As a side-effect, loadTxt(...) stores a npz file for</span>
    <span class="c1">###faster subsequent loading via loadNpz(...)</span>
    <span class="c1">#file_name: (str) Path to dataset file (.txt format)</span>
    <span class="c1">#name:      (str) String to identify this Datasets object henceforth</span>
    <span class="k">def</span> <span class="nf">loadTxt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1">#Internal: Counters to keep track of docID and qID</span>
        <span class="n">previousQueryID</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">docID</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">qID</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">relevanceArray</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="c1">#QueryMappings: list[int],length=numQueries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queryMappings</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">name</span>
        
        <span class="c1">#DocsPerQuery:  list[int],length=numQueries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c1">#Relevances:    list[Alpha],length=numQueries; Alpha:= numpy.array[int],length=docsForQuery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relevances</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c1">#Features:      list[Alpha],length=numQueries; </span>
        <span class="c1">#Alpha:= scipy.sparse.coo_matrix[double],shape=(docsForQuery, numFeatures)</span>
        <span class="n">featureRows</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">featureCols</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">featureVals</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">numFeatures</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="c1">#Now read in data</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">outputFilename</span><span class="o">=</span><span class="n">file_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">outputFileDir</span><span class="o">=</span><span class="n">outputFilename</span><span class="o">+</span><span class="s1">&#39;_processed&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputFileDir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outputFileDir</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">relevance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">queryID</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="c1">#Remove any trailing comments before extracting features</span>
                <span class="n">remainder</span><span class="o">=</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">featureTokens</span><span class="o">=</span><span class="n">remainder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">numFeatures</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">numFeatures</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">featureTokens</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                    
                <span class="k">if</span> <span class="p">(</span><span class="n">previousQueryID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">queryID</span><span class="o">!=</span><span class="n">previousQueryID</span><span class="p">):</span>
                    <span class="c1">#Begin processing a new query&#39;s documents</span>
                    <span class="n">docID</span><span class="o">=</span><span class="mi">0</span>
                    
                    <span class="k">if</span> <span class="n">relevanceArray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1">#Previous query&#39;s data should be persisted to file/self.members</span>
                        <span class="n">currentRelevances</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">relevanceArray</span><span class="p">,</span> 
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">relevances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentRelevances</span><span class="p">)</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputFileDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_rel&#39;</span><span class="p">),</span> 
                                                <span class="n">relevances</span><span class="o">=</span><span class="n">currentRelevances</span><span class="p">)</span>
                        
                        <span class="n">maxDocs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">relevanceArray</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxDocs</span><span class="p">)</span>
                        
                        <span class="n">currentFeatures</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">featureVals</span><span class="p">,</span> <span class="p">(</span><span class="n">featureRows</span><span class="p">,</span> <span class="n">featureCols</span><span class="p">)),</span>
                                                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">maxDocs</span><span class="p">,</span> <span class="n">numFeatures</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                        <span class="n">currentFeatures</span><span class="o">=</span><span class="n">currentFeatures</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentFeatures</span><span class="p">)</span>
                        <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">save_npz</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputFileDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_feat&#39;</span><span class="p">),</span> 
                                                <span class="n">currentFeatures</span><span class="p">)</span>
        
                        <span class="n">qID</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">queryMappings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previousQueryID</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            
                    <span class="n">relevanceArray</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">featureRows</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">featureCols</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">featureVals</span><span class="o">=</span><span class="p">[]</span>
                    
                    <span class="n">previousQueryID</span><span class="o">=</span><span class="n">queryID</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">docID</span><span class="o">+=</span><span class="mi">1</span>
                    
                <span class="n">relevanceArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relevance</span><span class="p">)</span>
                
                <span class="c1">#Add a feature for the the intercept</span>
                <span class="n">featureRows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">docID</span><span class="p">)</span>
                <span class="n">featureCols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">featureVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">featureToken</span> <span class="ow">in</span> <span class="n">featureTokens</span><span class="p">:</span>
                    <span class="n">featureTokenSplit</span><span class="o">=</span><span class="n">featureToken</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">featureIndex</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">featureTokenSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">featureValue</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">featureTokenSplit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    
                    <span class="n">featureRows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">docID</span><span class="p">)</span>
                    <span class="n">featureCols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">featureIndex</span><span class="p">)</span>
                    <span class="n">featureVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">featureValue</span><span class="p">)</span>
            
            <span class="c1">#Finish processing the final query&#39;s data</span>
            <span class="n">currentRelevances</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">relevanceArray</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relevances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentRelevances</span><span class="p">)</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputFileDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_rel&#39;</span><span class="p">),</span> 
                                        <span class="n">relevances</span><span class="o">=</span><span class="n">currentRelevances</span><span class="p">)</span>
            
            <span class="n">maxDocs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">relevanceArray</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxDocs</span><span class="p">)</span>
            
            <span class="n">currentFeatures</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">featureVals</span><span class="p">,</span> <span class="p">(</span><span class="n">featureRows</span><span class="p">,</span> <span class="n">featureCols</span><span class="p">)),</span>
                                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">maxDocs</span><span class="p">,</span> <span class="n">numFeatures</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">currentFeatures</span><span class="o">=</span><span class="n">currentFeatures</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentFeatures</span><span class="p">)</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">save_npz</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputFileDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_feat&#39;</span><span class="p">),</span>
                                        <span class="n">currentFeatures</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">queryMappings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previousQueryID</span><span class="p">)</span>
        
        <span class="c1">#Persist meta-data for the dataset for faster loading through loadNpz</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">outputFilename</span><span class="p">,</span> <span class="n">docsPerQuery</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">,</span> 
                                        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">queryMappings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queryMappings</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Datasets:loadTxt [INFO] Loaded&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> 
                    <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> NumQueries&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">),</span> 
                    <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> [Min/Max]DocsPerQuery&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">),</span> 
                    <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1">#file_name: (str) Path to dataset file/directory</span>
    <span class="k">def</span> <span class="nf">loadNpz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">npFile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="o">=</span><span class="n">npFile</span><span class="p">[</span><span class="s1">&#39;docsPerQuery&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">npFile</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queryMappings</span><span class="o">=</span><span class="n">npFile</span><span class="p">[</span><span class="s1">&#39;queryMappings&#39;</span><span class="p">]</span>
        
        <span class="n">fileDir</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">+</span><span class="s1">&#39;_processed&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileDir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relevances</span><span class="o">=</span><span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">=</span><span class="p">[]</span>
            
            <span class="n">qID</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_rel.npz&#39;</span><span class="p">)):</span>
                <span class="k">with</span> <span class="n">numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_rel.npz&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">currRelFile</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">relevances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currRelFile</span><span class="p">[</span><span class="s1">&#39;relevances&#39;</span><span class="p">])</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">load_npz</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_feat.npz&#39;</span><span class="p">)))</span>
                    
                <span class="n">qID</span><span class="o">+=</span><span class="mi">1</span>
                
                <span class="k">if</span> <span class="n">qID</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Datasets:loadNpz [INFO] Loaded&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> NumQueries&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">),</span> 
                    <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> [Min/Max]DocsPerQuery&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">),</span> 
                    <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> [Sum] docsPerQuery&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">mq2008Data=Datasets()</span>
<span class="sd">mq2008Data.loadTxt(Settings.DATA_DIR+&#39;MQ2008.txt&#39;, &#39;MQ2008&#39;)</span>
<span class="sd">mq2008Data.loadNpz(Settings.DATA_DIR+&#39;MQ2008&#39;)</span>
<span class="sd">del mq2008Data</span>

<span class="sd">mq2007Data=Datasets()</span>
<span class="sd">mq2007Data.loadTxt(Settings.DATA_DIR+&#39;MQ2007.txt&#39;, &#39;MQ2007&#39;)</span>
<span class="sd">mq2007Data.loadNpz(Settings.DATA_DIR+&#39;MQ2007&#39;)</span>
<span class="sd">del mq2007Data</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">mslrData</span><span class="o">=</span><span class="n">Datasets</span><span class="p">()</span>
<span class="n">mslrData</span><span class="o">.</span><span class="n">loadTxt</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="s1">&#39;MSLR-WEB10K/mslr.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;MSLR10k&#39;</span><span class="p">)</span>
<span class="k">del</span> <span class="n">mslrData</span>

<span class="k">for</span> <span class="n">foldID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;vali&#39;</span><span class="p">,</span><span class="s1">&#39;test&#39;</span><span class="p">]:</span>
        <span class="n">mslrData</span><span class="o">=</span><span class="n">Datasets</span><span class="p">()</span>
        <span class="n">mslrData</span><span class="o">.</span><span class="n">loadTxt</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="s1">&#39;MSLR-WEB10K</span><span class="se">\\</span><span class="s1">Fold&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">foldID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">fraction</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;MSLR10k-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">foldID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">fraction</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">mslrData</span>

<span class="n">mslrData</span><span class="o">=</span><span class="n">Datasets</span><span class="p">()</span>
<span class="n">mslrData</span><span class="o">.</span><span class="n">loadTxt</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="s1">&#39;MSLR/mslr.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;MSLR&#39;</span><span class="p">)</span>
<span class="k">del</span> <span class="n">mslrData</span>

<span class="k">for</span> <span class="n">foldID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;vali&#39;</span><span class="p">,</span><span class="s1">&#39;test&#39;</span><span class="p">]:</span>
        <span class="n">mslrData</span><span class="o">=</span><span class="n">Datasets</span><span class="p">()</span>
        <span class="n">mslrData</span><span class="o">.</span><span class="n">loadTxt</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="s1">&#39;MSLR</span><span class="se">\\</span><span class="s1">Fold&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">foldID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">fraction</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;MSLR-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">foldID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">fraction</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">mslrData</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Estimators">Estimators<a class="anchor-link" href="#Estimators"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Estimator</span><span class="p">:</span>
    <span class="c1">#ranking_size: (int) Size of slate, l</span>
    <span class="c1">#logging_policy: (UniformPolicy) Logging policy, \mu</span>
    <span class="c1">#target_policy: (Policy) Target policy, \pi</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="o">=</span><span class="n">ranking_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">=</span><span class="n">logging_policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetPolicy</span><span class="o">=</span><span class="n">target_policy</span>
        
        <span class="k">if</span> <span class="n">target_policy</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">logging_policy</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimator:init [ERR] Either target or logging policy is not initialized&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">target_policy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">logging_policy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimator:init [ERR] Target and logging policy operate on different datasets&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="c1">###All sub-classes of Estimator should supply a estimate method</span>
        <span class="c1">###Requires: query, logged_ranking, logged_value,</span>
        <span class="c1">###Returns: float indicating estimated value</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">runningSum</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span><span class="o">=</span><span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">updateRunningAverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningSum</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">delta</span><span class="o">=</span><span class="n">value</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span><span class="o">+=</span><span class="n">delta</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runningSum</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningSum</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span><span class="o">=</span><span class="mf">0.0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">OnPolicy</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;OnPolicy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span>
        
        <span class="c1">#This member is set on-demand by estimateAll(...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="o">=</span><span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">estimateAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">numQueries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numQueries</span><span class="p">):</span>
            <span class="n">newRanking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">targetPolicy</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">computeMetric</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">newRanking</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OnPolicy:estimateAll [LOG] Precomputed estimates.&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">currentValue</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">currentValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">currentValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">computeMetric</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="o">=</span><span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Uniform-IPS">Uniform IPS<a class="anchor-link" href="#Uniform-IPS"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">UniformIPS</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Unif-IPS&#39;</span>
        
    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">exactMatch</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">new_ranking</span><span class="o">-</span><span class="n">logged_ranking</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">currentValue</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">exactMatch</span><span class="p">:</span>
            <span class="n">numAllowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
            <span class="n">validDocs</span><span class="o">=</span><span class="n">logged_ranking</span><span class="o">.</span><span class="n">size</span>
            <span class="n">invPropensity</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">:</span>
                <span class="n">invPropensity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float_power</span><span class="p">(</span><span class="n">numAllowedDocs</span><span class="p">,</span> <span class="n">validDocs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invPropensity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numAllowedDocs</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                
            <span class="n">currentValue</span><span class="o">=</span><span class="n">logged_value</span><span class="o">*</span><span class="n">invPropensity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Non-uniform-IPS">Non-uniform IPS<a class="anchor-link" href="#Non-uniform-IPS"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">NonUniformIPS</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NonUnif-IPS&#39;</span>
        
    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">exactMatch</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">new_ranking</span><span class="o">-</span><span class="n">logged_ranking</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">currentValue</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">exactMatch</span><span class="p">:</span>
            <span class="n">numAllowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
            <span class="n">underlyingRanking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">currentDistribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">multinomials</span><span class="p">[</span><span class="n">numAllowedDocs</span><span class="p">]</span>
            
            <span class="n">numRankedDocs</span><span class="o">=</span><span class="n">logged_ranking</span><span class="o">.</span><span class="n">size</span>
            <span class="n">invPropensity</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="n">denominator</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numRankedDocs</span><span class="p">):</span>
                <span class="n">underlyingIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">underlyingRanking</span> <span class="o">==</span> <span class="n">logged_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">invPropensity</span><span class="o">*=</span><span class="p">(</span><span class="n">denominator</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">currentDistribution</span><span class="p">[</span><span class="n">underlyingIndex</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">:</span>
                    <span class="n">denominator</span><span class="o">-=</span><span class="n">currentDistribution</span><span class="p">[</span><span class="n">underlyingIndex</span><span class="p">]</span>
                
            <span class="n">currentValue</span><span class="o">=</span><span class="n">logged_value</span><span class="o">*</span><span class="n">invPropensity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Uniform-SNIPS">Uniform SNIPS<a class="anchor-link" href="#Uniform-SNIPS"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">UniformSNIPS</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Unif-IPS_SN&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">=</span><span class="mf">0.0</span>
        
    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">exactMatch</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">new_ranking</span><span class="o">-</span><span class="n">logged_ranking</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">currentValue</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">exactMatch</span><span class="p">:</span>
            <span class="n">numAllowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
            <span class="n">validDocs</span><span class="o">=</span><span class="n">logged_ranking</span><span class="o">.</span><span class="n">size</span>
            <span class="n">invPropensity</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">:</span>
                <span class="n">invPropensity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float_power</span><span class="p">(</span><span class="n">numAllowedDocs</span><span class="p">,</span> <span class="n">validDocs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invPropensity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numAllowedDocs</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                
            <span class="n">currentValue</span><span class="o">=</span><span class="n">logged_value</span><span class="o">*</span><span class="n">invPropensity</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
            <span class="n">denominatorDelta</span><span class="o">=</span><span class="n">invPropensity</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">+=</span><span class="n">denominatorDelta</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runningSum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">=</span><span class="mf">0.0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Non-uniform-SNIPS">Non-uniform SNIPS<a class="anchor-link" href="#Non-uniform-SNIPS"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">NonUniformSNIPS</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NonUnif-IPS_SN&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">=</span><span class="mf">0.0</span>
        
    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">exactMatch</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">new_ranking</span><span class="o">-</span><span class="n">logged_ranking</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">currentValue</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">exactMatch</span><span class="p">:</span>
            <span class="n">numAllowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
            <span class="n">underlyingRanking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">currentDistribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">multinomials</span><span class="p">[</span><span class="n">numAllowedDocs</span><span class="p">]</span>
            
            <span class="n">numRankedDocs</span><span class="o">=</span><span class="n">logged_ranking</span><span class="o">.</span><span class="n">size</span>
            <span class="n">invPropensity</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="n">denominator</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numRankedDocs</span><span class="p">):</span>
                <span class="n">underlyingIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">underlyingRanking</span> <span class="o">==</span> <span class="n">logged_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">invPropensity</span><span class="o">*=</span><span class="p">(</span><span class="n">denominator</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">currentDistribution</span><span class="p">[</span><span class="n">underlyingIndex</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">:</span>
                    <span class="n">denominator</span><span class="o">-=</span><span class="n">currentDistribution</span><span class="p">[</span><span class="n">underlyingIndex</span><span class="p">]</span>
                
            <span class="n">currentValue</span><span class="o">=</span><span class="n">logged_value</span><span class="o">*</span><span class="n">invPropensity</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
            <span class="n">denominatorDelta</span><span class="o">=</span><span class="n">invPropensity</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">+=</span><span class="n">denominatorDelta</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runningSum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">=</span><span class="mf">0.0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Uniform-PI">Uniform PI<a class="anchor-link" href="#Uniform-PI"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">UniformPI</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Unif-PI&#39;</span>
        
    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">numAllowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="n">logged_ranking</span><span class="o">.</span><span class="n">size</span>
        <span class="n">vectorDimension</span><span class="o">=</span><span class="n">validDocs</span><span class="o">*</span><span class="n">numAllowedDocs</span>
        
        <span class="n">exploredMatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">newMatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">exploredMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">newMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">query</span><span class="p">]</span> <span class="o">==</span> <span class="n">logged_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">newIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">query</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">exploredMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">logIndex</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">newMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">newIndex</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        
        <span class="n">posRelVector</span><span class="o">=</span><span class="n">exploredMatrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vectorDimension</span><span class="p">)</span>
        <span class="n">newSlateVector</span><span class="o">=</span><span class="n">newMatrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vectorDimension</span><span class="p">)</span>
        
        <span class="n">estimatedPhi</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">gammas</span><span class="p">[</span><span class="n">numAllowedDocs</span><span class="p">],</span> <span class="n">posRelVector</span><span class="p">)</span>
        <span class="n">invPropensity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">estimatedPhi</span><span class="p">,</span> <span class="n">newSlateVector</span><span class="p">)</span>
        
        <span class="n">currentValue</span><span class="o">=</span><span class="n">logged_value</span><span class="o">*</span><span class="n">invPropensity</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Non-uniform-PI">Non-uniform PI<a class="anchor-link" href="#Non-uniform-PI"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">NonUniformPI</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NonUnif-PI&#39;</span>
        
    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">numAllowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
        <span class="n">underlyingRanking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="n">logged_ranking</span><span class="o">.</span><span class="n">size</span>
        <span class="n">vectorDimension</span><span class="o">=</span><span class="n">validDocs</span><span class="o">*</span><span class="n">numAllowedDocs</span>
        
        <span class="n">exploredMatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">newMatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
            <span class="n">logIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">underlyingRanking</span> <span class="o">==</span> <span class="n">logged_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">newIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">underlyingRanking</span> <span class="o">==</span> <span class="n">new_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">exploredMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">logIndex</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">newMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">newIndex</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        
        <span class="n">posRelVector</span><span class="o">=</span><span class="n">exploredMatrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vectorDimension</span><span class="p">)</span>
        <span class="n">newSlateVector</span><span class="o">=</span><span class="n">newMatrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vectorDimension</span><span class="p">)</span>
        
        <span class="n">estimatedPhi</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">gammas</span><span class="p">[</span><span class="n">numAllowedDocs</span><span class="p">],</span> <span class="n">posRelVector</span><span class="p">)</span>
        <span class="n">invPropensity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">estimatedPhi</span><span class="p">,</span> <span class="n">newSlateVector</span><span class="p">)</span>
 
        <span class="n">currentValue</span><span class="o">=</span><span class="n">logged_value</span><span class="o">*</span><span class="n">invPropensity</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Uniform-SNPI">Uniform SNPI<a class="anchor-link" href="#Uniform-SNPI"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">UniformSNPI</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Unif-PI_SN&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">=</span><span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">numAllowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="n">logged_ranking</span><span class="o">.</span><span class="n">size</span>
        <span class="n">vectorDimension</span><span class="o">=</span><span class="n">validDocs</span><span class="o">*</span><span class="n">numAllowedDocs</span>
        
        <span class="n">exploredMatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">newMatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">exploredMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">newMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">query</span><span class="p">]</span> <span class="o">==</span> <span class="n">logged_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">newIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">query</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">exploredMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">logIndex</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">newMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">newIndex</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        
        <span class="n">posRelVector</span><span class="o">=</span><span class="n">exploredMatrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vectorDimension</span><span class="p">)</span>
        <span class="n">newSlateVector</span><span class="o">=</span><span class="n">newMatrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vectorDimension</span><span class="p">)</span>
        
        <span class="n">estimatedPhi</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">gammas</span><span class="p">[</span><span class="n">numAllowedDocs</span><span class="p">],</span> <span class="n">posRelVector</span><span class="p">)</span>
        <span class="n">invPropensity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">estimatedPhi</span><span class="p">,</span> <span class="n">newSlateVector</span><span class="p">)</span>
        <span class="n">currentValue</span><span class="o">=</span><span class="n">logged_value</span><span class="o">*</span><span class="n">invPropensity</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
        
        <span class="n">denominatorDelta</span><span class="o">=</span><span class="n">invPropensity</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">+=</span><span class="n">denominatorDelta</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runningSum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">=</span><span class="mf">0.0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Non-uniform-SNPI">Non-uniform SNPI<a class="anchor-link" href="#Non-uniform-SNPI"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">NonUniformSNPI</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NonUnif-PI_SN&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">=</span><span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">numAllowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
        <span class="n">underlyingRanking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">validDocs</span><span class="o">=</span><span class="n">logged_ranking</span><span class="o">.</span><span class="n">size</span>
        <span class="n">vectorDimension</span><span class="o">=</span><span class="n">validDocs</span><span class="o">*</span><span class="n">numAllowedDocs</span>
        
        <span class="n">exploredMatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">newMatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">numAllowedDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
            <span class="n">logIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">underlyingRanking</span> <span class="o">==</span> <span class="n">logged_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">newIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">underlyingRanking</span> <span class="o">==</span> <span class="n">new_ranking</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">exploredMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">logIndex</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">newMatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">newIndex</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        
        <span class="n">posRelVector</span><span class="o">=</span><span class="n">exploredMatrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vectorDimension</span><span class="p">)</span>
        <span class="n">newSlateVector</span><span class="o">=</span><span class="n">newMatrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vectorDimension</span><span class="p">)</span>
        
        <span class="n">estimatedPhi</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">gammas</span><span class="p">[</span><span class="n">numAllowedDocs</span><span class="p">],</span> <span class="n">posRelVector</span><span class="p">)</span>
        <span class="n">invPropensity</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">estimatedPhi</span><span class="p">,</span> <span class="n">newSlateVector</span><span class="p">)</span>
        <span class="n">currentValue</span><span class="o">=</span><span class="n">logged_value</span><span class="o">*</span><span class="n">invPropensity</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
        
        <span class="n">denominatorDelta</span><span class="o">=</span><span class="n">invPropensity</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">+=</span><span class="n">denominatorDelta</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runningSum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningDenominatorMean</span><span class="o">=</span><span class="mf">0.0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="DM">DM<a class="anchor-link" href="#DM"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Direct</span><span class="p">(</span><span class="n">Estimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">,</span> <span class="n">estimator_type</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">logging_policy</span><span class="p">,</span> <span class="n">target_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Direct_&#39;</span><span class="o">+</span><span class="n">estimator_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimatorType</span> <span class="o">=</span> <span class="n">estimator_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treeDepths</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimatorType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="kc">None</span>
            
        <span class="c1">#This member is set on-demand by estimateAll(...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="o">=</span><span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">estimateAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">numQueries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numQueries</span><span class="p">):</span>
            <span class="n">newRanking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">targetPolicy</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="p">)</span>
            <span class="n">allFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">query</span><span class="p">][</span><span class="n">newRanking</span><span class="p">,:]</span>
        
            <span class="k">if</span> <span class="n">newRanking</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="p">:</span>
                <span class="n">emptyPad</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="o">-</span><span class="n">newRanking</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numFeatures</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">allFeatures</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">allFeatures</span><span class="p">,</span> <span class="n">emptyPad</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            
            <span class="n">allFeatures</span><span class="o">=</span><span class="n">allFeatures</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
            <span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span> <span class="o">=</span> <span class="n">allFeatures</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">size</span><span class="o">=</span><span class="n">nRows</span><span class="o">*</span><span class="n">nCols</span>
            <span class="n">currentFeatures</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">allFeatures</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>
        
            <span class="n">currentValue</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimatorType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span><span class="p">:</span>
                <span class="n">currentValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">currentFeatures</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">currentValue</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">currentFeatures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">low</span><span class="o">=</span><span class="kc">None</span>
            <span class="n">high</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">low</span><span class="o">=</span><span class="n">metric</span><span class="o">.</span><span class="n">getMin</span><span class="p">(</span><span class="n">newRanking</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">high</span><span class="o">=</span><span class="n">metric</span><span class="o">.</span><span class="n">getMax</span><span class="p">(</span><span class="n">newRanking</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">currentValue</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">currentValue</span><span class="p">,</span> <span class="n">low</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">currentValue</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">currentValue</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">currentValue</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">currentValue</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Direct:estimateAll [LOG] estimate </span><span class="si">%0.3f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">currentValue</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">del</span> <span class="n">allFeatures</span>
            <span class="k">del</span> <span class="n">currentFeatures</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">query</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Direct:estimateAll [LOG] Precomputed estimates.&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logged_data</span><span class="p">):</span>
        <span class="n">numInstances</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">logged_data</span><span class="p">)</span>
        <span class="n">targets</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numInstances</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">covariates</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="n">numInstances</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numFeatures</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting to create covariates&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numInstances</span><span class="p">):</span>
            <span class="n">currentDatapoint</span><span class="o">=</span><span class="n">logged_data</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">currentDatapoint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="n">currentQuery</span><span class="o">=</span><span class="n">currentDatapoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">currentRanking</span><span class="o">=</span><span class="n">currentDatapoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">allFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">currentQuery</span><span class="p">][</span><span class="n">currentRanking</span><span class="p">,:]</span>
            <span class="n">allFeatures</span><span class="o">.</span><span class="n">eliminate_zeros</span><span class="p">()</span>
            
            <span class="n">covariates</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">allFeatures</span><span class="o">.</span><span class="n">data</span>
            <span class="n">newIndices</span><span class="o">=</span><span class="n">allFeatures</span><span class="o">.</span><span class="n">indices</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">allFeatures</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">newIndices</span><span class="p">[</span><span class="n">allFeatures</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span><span class="n">allFeatures</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">+=</span><span class="n">k</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numFeatures</span>
                
            <span class="n">covariates</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">newIndices</span>
                
            <span class="k">if</span> <span class="n">j</span><span class="o">%</span><span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">currentDatapoint</span>
            <span class="k">del</span> <span class="n">allFeatures</span>

            
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting covariates&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">covariates</span><span class="o">=</span><span class="n">covariates</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished conversion&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimatorType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span><span class="p">:</span>
            <span class="n">treeCV</span><span class="o">=</span><span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">GridSearchCV</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">criterion</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span>
                                                        <span class="n">splitter</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                                                        <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">presort</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                <span class="n">param_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">treeDepths</span><span class="p">,</span>
                                <span class="n">scoring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fit_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">iid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">error_score</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">treeCV</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">covariates</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">=</span><span class="n">treeCV</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DirectEstimator:train [INFO] Done. Best depth&quot;</span><span class="p">,</span> 
                            <span class="n">treeCV</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;max_depth&#39;</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimatorType</span><span class="o">==</span><span class="s1">&#39;lasso&#39;</span><span class="p">:</span>
            <span class="n">lassoCV</span><span class="o">=</span><span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">GridSearchCV</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">Lasso</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                                        <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy_X</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                                        <span class="n">max_iter</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">warm_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">),</span>
                                <span class="n">param_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">,</span>
                                <span class="n">scoring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fit_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">iid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">error_score</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">lassoCV</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">covariates</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="n">lassoCV</span><span class="o">.</span><span class="n">best_estimator_</span><span class="o">.</span><span class="n">coef_</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DirectEstimator:train [INFO] Done. CVAlpha&quot;</span><span class="p">,</span> <span class="n">lassoCV</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimatorType</span><span class="o">==</span><span class="s1">&#39;ridge&#39;</span><span class="p">:</span>
            <span class="n">ridgeCV</span><span class="o">=</span><span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">GridSearchCV</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">Ridge</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy_X</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;sag&#39;</span><span class="p">,</span>
                                                        <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                <span class="n">param_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">,</span>
                                <span class="n">scoring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fit_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">iid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">error_score</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ridgeCV</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">covariates</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="n">ridgeCV</span><span class="o">.</span><span class="n">best_estimator_</span><span class="o">.</span><span class="n">coef_</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DirectEstimator:train [INFO] Done. CVAlpha&quot;</span><span class="p">,</span> <span class="n">ridgeCV</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DirectEstimator:train [ERR] </span><span class="si">%s</span><span class="s2"> not supported.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">logged_ranking</span><span class="p">,</span> <span class="n">new_ranking</span><span class="p">,</span> <span class="n">logged_value</span><span class="p">):</span>
        <span class="n">currentValue</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">currentValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="p">[</span><span class="n">query</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggingPolicy</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">query</span><span class="p">][</span><span class="n">new_ranking</span><span class="p">,:]</span>
        
            <span class="k">if</span> <span class="n">new_ranking</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="p">:</span>
                <span class="n">emptyPad</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="o">-</span><span class="n">new_ranking</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numFeatures</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">allFeatures</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">allFeatures</span><span class="p">,</span> <span class="n">emptyPad</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            
            <span class="n">allFeatures</span><span class="o">=</span><span class="n">allFeatures</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
            <span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span> <span class="o">=</span> <span class="n">allFeatures</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">size</span><span class="o">=</span><span class="n">nRows</span><span class="o">*</span><span class="n">nCols</span>
            <span class="n">currentFeatures</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">allFeatures</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimatorType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span><span class="p">:</span>
                <span class="n">currentValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">currentFeatures</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">currentValue</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">currentFeatures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
            <span class="k">del</span> <span class="n">allFeatures</span>
            <span class="k">del</span> <span class="n">currentFeatures</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRunningAverage</span><span class="p">(</span><span class="n">currentValue</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningMean</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Estimator</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedValues</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimatorType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Utils">Utils<a class="anchor-link" href="#Utils"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">GammaCalculator</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">nSlots</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">nSlots</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;NSLOTS MUST BE POSITIVE&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nDocs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nSlots</span> <span class="o">=</span> <span class="n">nSlots</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weightToType</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typeToWeight</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typeToDocs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docToType</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)):</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightToType</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">typeToWeight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">weight</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">typeToDocs</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weightToType</span><span class="p">[</span><span class="n">weight</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightToType</span><span class="p">[</span><span class="n">weight</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docToType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typeToDocs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">empty_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span> <span class="n">empty_prefix</span><span class="p">,</span> <span class="p">()</span> <span class="p">]</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_table</span><span class="p">(</span><span class="n">empty_prefix</span><span class="p">,</span> <span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gamma_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">anchor</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">prefix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                    <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prob</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">anchor</span><span class="o">==</span><span class="p">():</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;types1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;types2&quot;</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_types</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gamma_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gamma_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">prob</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unitMarginals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nSlots</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nDocs</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairwiseMarginals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;types1&quot;</span><span class="p">:</span>
                <span class="n">pos</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">normalize</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeToDocs</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unitMarginals</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">prob</span><span class="o">/</span><span class="n">normalize</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;types2&quot;</span><span class="p">:</span>
                <span class="n">pos1</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pos2</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">normalize</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">t1</span><span class="o">==</span><span class="n">t2</span><span class="p">:</span>
                    <span class="n">normalize</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">t2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">normalize</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">t2</span><span class="p">])</span>

                <span class="n">newKey</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairwiseMarginals</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pairwiseMarginals</span><span class="p">[</span><span class="n">newKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nDocs</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
         
                <span class="k">for</span> <span class="n">d1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeToDocs</span><span class="p">[</span><span class="n">t1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">d2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeToDocs</span><span class="p">[</span><span class="n">t2</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">d1</span> <span class="o">!=</span> <span class="n">d2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pairwiseMarginals</span><span class="p">[</span><span class="n">newKey</span><span class="p">][</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">prob</span><span class="o">/</span><span class="n">normalize</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">decr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">prefix_mut</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">prefix_mut</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;DECR PREFIX OUT OF BOUNDS&quot;</span>
        <span class="n">prefix_mut</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">prefix_mut</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">incr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">prefix_mut</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">prefix_mut</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s2">&quot;INCR PREFIX OUT OF BOUNDS&quot;</span>
        <span class="n">prefix_mut</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">prefix_mut</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">posterior</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeToWeight</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span><span class="o">-</span><span class="n">prefix</span><span class="p">[</span><span class="n">tt</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_table</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span> <span class="o">*</span> <span class="n">posterior</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="n">normalize</span>

    <span class="k">def</span> <span class="nf">eval_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">anchor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;evaluate an entry in the DP table. here:</span>
<span class="sd">              prefix: tuple of type counts</span>
<span class="sd">              anchor: specifies (pos, type) where pos&lt;len(prefix)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">anchor</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">prefix</span><span class="p">,</span><span class="n">anchor</span><span class="p">]</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">anchor</span><span class="o">==</span><span class="p">()</span> <span class="ow">or</span> <span class="n">anchor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">prefix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">prefix0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decr</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">anchor</span><span class="o">==</span><span class="p">()</span> <span class="ow">or</span> <span class="n">prefix0</span><span class="p">[</span><span class="n">anchor</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">prob</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prob</span><span class="p">(</span><span class="n">prefix0</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span><span class="o">=</span><span class="n">anchor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">prefix0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decr</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prob</span><span class="p">(</span><span class="n">prefix0</span><span class="p">,</span> <span class="p">(),</span> <span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">prefix</span><span class="p">,</span><span class="n">anchor</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>
        <span class="k">return</span> <span class="n">prob</span>
        
    <span class="k">def</span> <span class="nf">fill_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">anchor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;add more entries to the DP table extending the current prefix. here:</span>
<span class="sd">              prefix: tuple of type counts</span>
<span class="sd">              anchor: specifies (pos, type) where pos&lt;len(prefix)&quot;&quot;&quot;</span>

        <span class="n">length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visited</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_table</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">nSlots</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prefix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">nDocsOfType</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                <span class="n">prefix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                <span class="n">anchor1</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fill_table</span><span class="p">(</span><span class="n">prefix1</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">anchor</span><span class="o">==</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fill_table</span><span class="p">(</span><span class="n">prefix1</span><span class="p">,</span> <span class="n">anchor1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metrics">Metrics<a class="anchor-link" href="#Metrics"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">Metric</span><span class="p">:</span>
    <span class="c1">#dataset: (Datasets) Must be initialized using Datasets.loadTxt(...)/loadNpz(...)</span>
    <span class="c1">#ranking_size: (int) Maximum size of slate across contexts, l</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="o">=</span><span class="n">ranking_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span>
        <span class="c1">###All sub-classes of Metric should supply a computeMetric method</span>
        <span class="c1">###Requires: (int) query_id; list[int],length=ranking_size ranking</span>
        <span class="c1">###Returns: (double) value</span>


<span class="k">class</span> <span class="nc">ConstantMetric</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="c1">#constant: (double) Value returned by this metric</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">constant</span><span class="p">):</span>
        <span class="n">Metric</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="o">=</span><span class="n">constant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Constant&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ConstantMetric:init [INFO] RankingSize&quot;</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Constant&quot;</span><span class="p">,</span> <span class="n">constant</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1">#query_id: (int) Index of the query                                                                 (unused)</span>
    <span class="c1">#ranking: list[int],length=min(ranking_size,docsForQuery); Valid DocID in each slot of the slate    (unused)</span>
    <span class="k">def</span> <span class="nf">computeMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span>

        
<span class="k">class</span> <span class="nc">DCG</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="n">Metric</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="o">=</span><span class="mf">1.0</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;DCG&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DCG:init [INFO] RankingSize&quot;</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">computeMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking</span><span class="p">):</span>
        <span class="n">relevanceList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">relevances</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="n">ranking</span><span class="p">]</span>
        <span class="n">gain</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp2</span><span class="p">(</span><span class="n">relevanceList</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span>
        <span class="n">dcg</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">gain</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">gain</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dcg</span>

        
<span class="k">class</span> <span class="nc">NDCG</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="c1">#allow_repetitions: (bool) If True, max gain is computed as if repetitions are allowed in the ranking</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">allow_repetitions</span><span class="p">):</span>
        <span class="n">Metric</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="o">=</span><span class="mf">1.0</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NDCG&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">numQueries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">currentQuery</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numQueries</span><span class="p">):</span>
            <span class="n">validDocs</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">currentQuery</span><span class="p">],</span> <span class="n">ranking_size</span><span class="p">)</span>
            <span class="n">currentRelevances</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">relevances</span><span class="p">[</span><span class="n">currentQuery</span><span class="p">]</span>
            
            <span class="c1">#Handle filtered datasets properly</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">currentRelevances</span><span class="o">=</span><span class="n">currentRelevances</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">currentQuery</span><span class="p">]]</span>
            
            <span class="n">maxRelevances</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">if</span> <span class="n">allow_repetitions</span><span class="p">:</span>
                <span class="n">maxRelevances</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">currentRelevances</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">validDocs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxRelevances</span><span class="o">=-</span><span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="o">-</span><span class="n">currentRelevances</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">validDocs</span><span class="p">]</span>
        
            <span class="n">maxGain</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp2</span><span class="p">(</span><span class="n">maxRelevances</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span>
            <span class="n">maxDCG</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">validDocs</span><span class="p">],</span> <span class="n">maxGain</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxDCG</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">currentQuery</span> <span class="o">%</span> <span class="mi">1000</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NDCG:init [INFO] RankingSize&quot;</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> AllowRepetitions?&quot;</span><span class="p">,</span> <span class="n">allow_repetitions</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">computeMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking</span><span class="p">):</span>
        <span class="n">normalizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">normalizer</span><span class="o">&lt;=</span><span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relevanceList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">relevances</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="n">ranking</span><span class="p">]</span>
            <span class="n">gain</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp2</span><span class="p">(</span><span class="n">relevanceList</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span>
            <span class="n">dcg</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discountParams</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">gain</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">gain</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dcg</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">normalizer</span>

    <span class="k">def</span> <span class="nf">getMax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ranking_size</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span>
            
    <span class="k">def</span> <span class="nf">getMin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ranking_size</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span>
   
<span class="k">class</span> <span class="nc">ERR</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="n">Metric</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ERR&#39;</span>
        
        <span class="c1">#ERR needs the maximum relevance grade for the dataset</span>
        <span class="c1">#For MQ200*, this is 2;  For MSLR, this is 4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxrel</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MSLR&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxrel</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MQ200&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxrel</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERR:init [ERR] Unknown dataset. Use MSLR/MQ200*&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERR:init [INFO] RankingSize&quot;</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">computeMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking</span><span class="p">):</span>
        <span class="n">relevanceList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">relevances</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="n">ranking</span><span class="p">]</span>
        <span class="n">gain</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp2</span><span class="p">(</span><span class="n">relevanceList</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span>
        <span class="n">probs</span><span class="o">=</span><span class="n">gain</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrel</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">probs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">err</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">p</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
            <span class="n">err</span><span class="o">+=</span><span class="n">p</span><span class="o">*</span><span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">getMax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="n">probs</span><span class="o">=</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrel</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrel</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ranking_size</span><span class="p">)]</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">probs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">err</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">p</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
            <span class="n">err</span><span class="o">+=</span><span class="n">p</span><span class="o">*</span><span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">getMin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span>
        
<span class="k">class</span> <span class="nc">MaxRelevance</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="n">Metric</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;MaxRelevance&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MaxRelevance:init [INFO] RankingSize&quot;</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">computeMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking</span><span class="p">):</span>
        <span class="n">relevanceList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">relevances</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="n">ranking</span><span class="p">]</span>
        <span class="n">maxRelevance</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">relevanceList</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">maxRelevance</span>

        
<span class="k">class</span> <span class="nc">SumRelevance</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="n">Metric</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SumRelevance&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SumRelevance:init [INFO] RankingSize&quot;</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">computeMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking</span><span class="p">):</span>
        <span class="n">relevanceList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">relevances</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="n">ranking</span><span class="p">]</span>
        <span class="n">sumRelevance</span><span class="o">=</span><span class="n">relevanceList</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sumRelevance</span>

        
        
<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Settings</span>
    <span class="kn">import</span> <span class="nn">Datasets</span>
    
    <span class="n">mslrData</span> <span class="o">=</span> <span class="n">Datasets</span><span class="o">.</span><span class="n">Datasets</span><span class="p">()</span>
    <span class="n">mslrData</span><span class="o">.</span><span class="n">loadNpz</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="s2">&quot;mslr/mslr&quot;</span><span class="p">)</span>
    
    <span class="n">const</span><span class="o">=</span><span class="n">ConstantMetric</span><span class="p">(</span><span class="n">mslrData</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Constant&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">computeMetric</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">const</span>
    
    <span class="n">dcg</span><span class="o">=</span><span class="n">DCG</span><span class="p">(</span><span class="n">mslrData</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DCG&quot;</span><span class="p">,</span> <span class="n">dcg</span><span class="o">.</span><span class="n">computeMetric</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">dcg</span>
    
    <span class="n">ndcg</span><span class="o">=</span><span class="n">NDCG</span><span class="p">(</span><span class="n">mslrData</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NDCG NoRep&quot;</span><span class="p">,</span> <span class="n">ndcg</span><span class="o">.</span><span class="n">computeMetric</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">ndcg</span>
    
    <span class="n">ndcg</span><span class="o">=</span><span class="n">NDCG</span><span class="p">(</span><span class="n">mslrData</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NDCG YesRep&quot;</span><span class="p">,</span> <span class="n">ndcg</span><span class="o">.</span><span class="n">computeMetric</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">ndcg</span>
    
    <span class="n">err</span><span class="o">=</span><span class="n">ERR</span><span class="p">(</span><span class="n">mslrData</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERR&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">computeMetric</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">err</span>
    
    <span class="n">maxrel</span><span class="o">=</span><span class="n">MaxRelevance</span><span class="p">(</span><span class="n">mslrData</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MaxRelevance&quot;</span><span class="p">,</span> <span class="n">maxrel</span><span class="o">.</span><span class="n">computeMetric</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">maxrel</span>
    
    <span class="n">sumrel</span><span class="o">=</span><span class="n">SumRelevance</span><span class="p">(</span><span class="n">mslrData</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SumRelevance&quot;</span><span class="p">,</span> <span class="n">sumrel</span><span class="o">.</span><span class="n">computeMetric</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
    <span class="k">del</span> <span class="n">sumrel</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Policy">Policy<a class="anchor-link" href="#Policy"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Class that models a policy for exploration or evaluation</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="c1">#num_candidates: (int) Number of candidates, m</span>
<span class="c1">#ranking_size: (int) Size of slate, l</span>
<span class="c1">#allow_repetitions: (bool) If True, repetitions were allowed in the ranking</span>
<span class="k">def</span> <span class="nf">UniformGamma</span><span class="p">(</span><span class="n">num_candidates</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">allow_repetitions</span><span class="p">):</span>
    <span class="n">validDocs</span><span class="o">=</span><span class="n">ranking_size</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_repetitions</span><span class="p">:</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">ranking_size</span><span class="p">,</span> <span class="n">num_candidates</span><span class="p">)</span>
                
    <span class="n">gamma</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_candidates</span><span class="o">*</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">num_candidates</span><span class="o">*</span><span class="n">validDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_candidates</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">gamma</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#First set all the off-diagonal blocks</span>
        <span class="k">if</span> <span class="n">allow_repetitions</span><span class="p">:</span>
            <span class="n">gamma</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">num_candidates</span><span class="o">*</span><span class="n">num_candidates</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gamma</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">num_candidates</span><span class="o">*</span><span class="p">(</span><span class="n">num_candidates</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="c1">#Correct the diagonal of each off-diagonal block: Pairwise=0</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">validDocs</span><span class="p">):</span>
                <span class="n">diag</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">p</span><span class="o">*</span><span class="n">num_candidates</span><span class="p">)</span>
                <span class="n">diag</span><span class="o">.</span><span class="n">setflags</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">diag</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        
                <span class="n">diag</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="n">p</span><span class="o">*</span><span class="n">num_candidates</span><span class="p">)</span>
                <span class="n">diag</span><span class="o">.</span><span class="n">setflags</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">diag</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        
        <span class="c1">#Now correct the diagonal blocks: Diagonal matrix with marginals = 1/m</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
            <span class="n">currentStart</span><span class="o">=</span><span class="n">j</span><span class="o">*</span><span class="n">num_candidates</span>
            <span class="n">currentEnd</span><span class="o">=</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">num_candidates</span>
            <span class="n">gamma</span><span class="p">[</span><span class="n">currentStart</span><span class="p">:</span><span class="n">currentEnd</span><span class="p">,</span> <span class="n">currentStart</span><span class="p">:</span><span class="n">currentEnd</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">num_candidates</span><span class="p">)</span>

    <span class="n">gammaInv</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">num_candidates</span><span class="p">,</span> <span class="n">gammaInv</span><span class="p">)</span>
    
    
<span class="c1">#NonUniformGamma(...) computes a Gamma_pinv matrix for non-uniform exploration</span>
<span class="c1">#num_candidates: (int) Number of candidates, m</span>
<span class="c1">#decay: (double) Decay factor. Doc Selection Prob \propto exp2(-decay * floor[ log2(rank) ])</span>
<span class="c1">#ranking_size: (int) Size of slate, l</span>
<span class="c1">#allow_repetitions: (bool) If True, repetitions were allowed in the ranking</span>
<span class="k">def</span> <span class="nf">NonUniformGamma</span><span class="p">(</span><span class="n">num_candidates</span><span class="p">,</span> <span class="n">decay</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">allow_repetitions</span><span class="p">):</span>
    <span class="n">validDocs</span><span class="o">=</span><span class="n">ranking_size</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_repetitions</span><span class="p">:</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">ranking_size</span><span class="p">,</span> <span class="n">num_candidates</span><span class="p">)</span>

    <span class="n">multinomial</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_candidates</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">multinomial</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp2</span><span class="p">((</span><span class="o">-</span><span class="n">decay</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">multinomial</span><span class="p">)))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_candidates</span><span class="p">):</span>
        <span class="n">prevVal</span><span class="o">=</span><span class="n">multinomial</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">currVal</span><span class="o">=</span><span class="n">multinomial</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">currVal</span><span class="p">,</span> <span class="n">prevVal</span><span class="p">):</span>
            <span class="n">multinomial</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">prevVal</span>
    
    <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">num_candidates</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">gamma</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">num_candidates</span><span class="o">*</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">num_candidates</span><span class="o">*</span><span class="n">validDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">allow_repetitions</span><span class="p">:</span>
            <span class="n">offDiagonal</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">multinomial</span><span class="p">,</span> <span class="n">multinomial</span><span class="p">)</span>
            <span class="n">gamma</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">offDiagonal</span><span class="p">,</span> <span class="p">(</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">validDocs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
                <span class="n">currentStart</span><span class="o">=</span><span class="n">j</span><span class="o">*</span><span class="n">num_candidates</span>
                <span class="n">currentEnd</span><span class="o">=</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">num_candidates</span>
                <span class="n">gamma</span><span class="p">[</span><span class="n">currentStart</span><span class="p">:</span><span class="n">currentEnd</span><span class="p">,</span> <span class="n">currentStart</span><span class="p">:</span><span class="n">currentEnd</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">multinomial</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gammaVals</span><span class="o">=</span><span class="n">GammaDP</span><span class="o">.</span><span class="n">GammaCalculator</span><span class="p">(</span><span class="n">multinomial</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">validDocs</span><span class="p">)</span>
            <span class="n">gamma</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">gammaVals</span><span class="o">.</span><span class="n">unitMarginals</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">validDocs</span><span class="p">):</span>
                    <span class="n">pairMarginals</span><span class="o">=</span><span class="n">gammaVals</span><span class="o">.</span><span class="n">pairwiseMarginals</span><span class="p">[(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">)]</span>
                    <span class="n">currentRowStart</span><span class="o">=</span><span class="n">p</span><span class="o">*</span><span class="n">num_candidates</span>
                    <span class="n">currentRowEnd</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">num_candidates</span>
                    <span class="n">currentColumnStart</span><span class="o">=</span><span class="n">q</span><span class="o">*</span><span class="n">num_candidates</span>
                    <span class="n">currentColumnEnd</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">num_candidates</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">currentRowStart</span><span class="p">:</span><span class="n">currentRowEnd</span><span class="p">,</span> <span class="n">currentColumnStart</span><span class="p">:</span><span class="n">currentColumnEnd</span><span class="p">]</span><span class="o">=</span><span class="n">pairMarginals</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">currentColumnStart</span><span class="p">:</span><span class="n">currentColumnEnd</span><span class="p">,</span> <span class="n">currentRowStart</span><span class="p">:</span><span class="n">currentRowEnd</span><span class="p">]</span><span class="o">=</span><span class="n">pairMarginals</span><span class="o">.</span><span class="n">T</span>
    
    <span class="n">normalizer</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">multinomial</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
    <span class="n">multinomial</span><span class="o">=</span><span class="n">multinomial</span><span class="o">/</span><span class="n">normalizer</span>

    <span class="n">gammaInv</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">num_candidates</span><span class="p">,</span> <span class="n">multinomial</span><span class="p">,</span> <span class="n">gammaInv</span><span class="p">)</span>
    

<span class="k">class</span> <span class="nc">RecursiveSlateEval</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="o">=</span><span class="n">scores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortedIndices</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bestSoFar</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bestSlate</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upperPos</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_slate</span><span class="p">([],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">eval_slate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slate_prefix</span><span class="p">,</span> <span class="n">prefix_value</span><span class="p">):</span>
        <span class="n">currentPos</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">slate_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">currentPos</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestSoFar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">prefix_value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestSoFar</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bestSoFar</span><span class="o">=</span><span class="n">prefix_value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bestSlate</span><span class="o">=</span><span class="n">slate_prefix</span>
            <span class="k">return</span>
        
        <span class="n">docSet</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">slate_prefix</span><span class="p">)</span>
        <span class="n">bestFutureVal</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">currentPos</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span>
            <span class="n">bestFutureVal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upperPos</span><span class="p">[</span><span class="n">currentPos</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">delta</span><span class="o">=</span><span class="n">prefix_value</span><span class="o">+</span><span class="n">bestFutureVal</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
            <span class="n">currentDoc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sortedIndices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="n">currentPos</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">currentDoc</span> <span class="ow">in</span> <span class="n">docSet</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">currentVal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">currentDoc</span><span class="p">,</span> <span class="n">currentPos</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestSoFar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">((</span><span class="n">currentVal</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestSoFar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eval_slate</span><span class="p">(</span><span class="n">slate_prefix</span> <span class="o">+</span> <span class="p">[</span><span class="n">currentDoc</span><span class="p">],</span> <span class="n">prefix_value</span><span class="o">+</span><span class="n">currentVal</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            
<span class="k">class</span> <span class="nc">Policy</span><span class="p">:</span>
    <span class="c1">#dataset: (Datasets) Must be initialized using Datasets.loadTxt(...)/loadNpz(...)</span>
    <span class="c1">#allow_repetitions: (bool) If true, the policy predicts rankings with repeated documents</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">allow_repetitions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="o">=</span><span class="n">allow_repetitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span>
        <span class="c1">###All sub-classes of Policy should supply a predict method</span>
        <span class="c1">###Requires: (int) query_id; (int) ranking_size.</span>
        <span class="c1">###Returns: list[int],length=min(ranking_size,docsPerQuery[query_id]) ranking</span>


<span class="k">class</span> <span class="nc">L2RPolicy</span><span class="p">(</span><span class="n">Policy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">greedy_select</span><span class="p">,</span> <span class="n">cross_features</span><span class="p">):</span>
        <span class="n">Policy</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="o">=</span><span class="n">ranking_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numDocFeatures</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">=</span><span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossFeatures</span><span class="o">=</span><span class="n">cross_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;gbrt&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span><span class="o">=</span><span class="n">greedy_select</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">numFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numDocFeatures</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossFeatures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numFeatures</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">numDocFeatures</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L2RPolicy:init [INFO] Dataset:&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docFeatures</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">currFeature</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numFeatures</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">currFeature</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">numDocFeatures</span><span class="p">]</span><span class="o">=</span><span class="n">docFeatures</span>
        <span class="n">currFeature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">numDocFeatures</span><span class="o">+</span><span class="n">position</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossFeatures</span><span class="p">:</span>
            <span class="n">currFeature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">numDocFeatures</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="o">+</span><span class="n">position</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numDocFeatures</span><span class="p">:</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">numDocFeatures</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="o">+</span><span class="p">(</span><span class="n">position</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numDocFeatures</span><span class="p">]</span><span class="o">=</span><span class="n">docFeatures</span>

        <span class="k">return</span> <span class="n">currFeature</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="n">allowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">allowedDocs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="p">)</span>

        <span class="n">allScores</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">allowedDocs</span><span class="p">,</span> <span class="n">validDocs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">allFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">allowedDocs</span><span class="p">):</span>
            <span class="n">docID</span><span class="o">=</span><span class="n">doc</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">docID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="n">doc</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
                <span class="n">currFeature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">createFeature</span><span class="p">(</span><span class="n">allFeatures</span><span class="p">[</span><span class="n">docID</span><span class="p">,:],</span> <span class="n">pos</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;gbrt&#39;</span><span class="p">:</span>
                    <span class="n">allScores</span><span class="p">[</span><span class="n">doc</span><span class="p">,</span> <span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">currFeature</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">allScores</span><span class="p">[</span><span class="n">doc</span><span class="p">,</span> <span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">currFeature</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="p">)</span>

        <span class="n">tieBreaker</span><span class="o">=</span><span class="mf">1e-14</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">allowedDocs</span><span class="p">,</span> <span class="n">validDocs</span><span class="p">))</span>
        <span class="n">allScores</span><span class="o">+=</span><span class="n">tieBreaker</span>
        <span class="n">upperBound</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">allScores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">producedRanking</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span><span class="p">:</span>
            
            <span class="n">producedRanking</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">validDocs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">currentVal</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validDocs</span><span class="p">):</span>
                <span class="n">maxIndex</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">allScores</span><span class="p">)</span>
                <span class="n">chosenDoc</span><span class="p">,</span><span class="n">chosenPos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">maxIndex</span><span class="p">,</span> <span class="n">allScores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">currentVal</span><span class="o">+=</span><span class="n">allScores</span><span class="p">[</span><span class="n">chosenDoc</span><span class="p">,</span> <span class="n">chosenPos</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">producedRanking</span><span class="p">[</span><span class="n">chosenPos</span><span class="p">]</span><span class="o">=</span><span class="n">chosenDoc</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">producedRanking</span><span class="p">[</span><span class="n">chosenPos</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="n">chosenDoc</span><span class="p">]</span>
                
                <span class="n">allScores</span><span class="p">[</span><span class="n">chosenDoc</span><span class="p">,:]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
                <span class="n">allScores</span><span class="p">[:,</span><span class="n">chosenPos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="n">upperBound</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="n">currentVal</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slateScorer</span><span class="o">=</span><span class="n">RecursiveSlateEval</span><span class="p">(</span><span class="n">allScores</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">producedRanking</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slateScorer</span><span class="o">.</span><span class="n">bestSlate</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">producedRanking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">slateScorer</span><span class="o">.</span><span class="n">bestSlate</span><span class="p">]</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="n">upperBound</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="n">slateScorer</span><span class="o">.</span><span class="n">bestSoFar</span>
            <span class="k">del</span> <span class="n">slateScorer</span>
            
        <span class="k">del</span> <span class="n">allFeatures</span>
        <span class="k">del</span> <span class="n">allScores</span>
        
        <span class="k">return</span> <span class="n">producedRanking</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">hyper_params</span><span class="p">):</span>
        <span class="n">numQueries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rankingSize</span><span class="p">)</span>
        <span class="n">queryDocPosTriplets</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">,</span> <span class="n">validDocs</span><span class="p">)</span>
        <span class="n">designMatrix</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">queryDocPosTriplets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numFeatures</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">regressionTargets</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">queryDocPosTriplets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">sampleWeights</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">queryDocPosTriplets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">currID</span><span class="o">=-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numQueries</span><span class="p">):</span>
            <span class="n">numAllowedDocs</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">currValidDocs</span><span class="o">=</span><span class="n">validDocs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">allFeatures</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numAllowedDocs</span><span class="p">):</span>
                <span class="n">docID</span><span class="o">=</span><span class="n">doc</span>
                <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">docID</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">doc</span><span class="p">]</span>
                    
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">currValidDocs</span><span class="p">):</span>
                    <span class="n">currID</span><span class="o">+=</span><span class="mi">1</span>

                    <span class="n">designMatrix</span><span class="p">[</span><span class="n">currID</span><span class="p">,:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">createFeature</span><span class="p">(</span><span class="n">allFeatures</span><span class="p">[</span><span class="n">docID</span><span class="p">,:],</span> <span class="n">j</span><span class="p">)</span>
                    <span class="n">regressionTargets</span><span class="p">[</span><span class="n">currID</span><span class="p">]</span><span class="o">=</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">,</span><span class="n">doc</span><span class="p">]</span> 
                    <span class="n">sampleWeights</span><span class="p">[</span><span class="n">currID</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">numAllowedDocs</span> <span class="o">*</span> <span class="n">currValidDocs</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">i</span>
        <span class="k">del</span> <span class="n">targets</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L2RPolicy:train [LOG] Finished creating features and targets &quot;</span><span class="p">,</span> 
                <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">regressionTargets</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">regressionTargets</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">regressionTargets</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L2RPolicy:train [LOG] Histogram of targets &quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">regressionTargets</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span> <span class="o">==</span> <span class="s1">&#39;gbrt&#39;</span><span class="p">:</span>
            <span class="n">tree</span><span class="o">=</span><span class="n">sklearn</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">hyper_params</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span>
                            <span class="n">n_estimators</span><span class="o">=</span><span class="n">hyper_params</span><span class="p">[</span><span class="s1">&#39;ensemble&#39;</span><span class="p">],</span> <span class="n">subsample</span><span class="o">=</span><span class="n">hyper_params</span><span class="p">[</span><span class="s1">&#39;subsample&#39;</span><span class="p">],</span> <span class="n">max_leaf_nodes</span><span class="o">=</span><span class="n">hyper_params</span><span class="p">[</span><span class="s1">&#39;leaves&#39;</span><span class="p">],</span> 
                            <span class="n">max_features</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">presort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">designMatrix</span><span class="p">,</span> <span class="n">regressionTargets</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sampleWeights</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L2RPolicy:train [INFO] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span> <span class="o">==</span> <span class="s1">&#39;ridge&#39;</span><span class="p">:</span>
            <span class="n">ridgeCV</span><span class="o">=</span><span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">RidgeCV</span><span class="p">(</span><span class="n">alphas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                            <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">ridgeCV</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">designMatrix</span><span class="p">,</span> <span class="n">regressionTargets</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sampleWeights</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="n">ridgeCV</span><span class="o">.</span><span class="n">coef_</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L2RPolicy:train [INFO] Done. &quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L2RPolicy:train [ERR] </span><span class="si">%s</span><span class="s2"> not supported.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L2R:train [INFO] Created </span><span class="si">%s</span><span class="s2"> predictor using dataset </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                
                
<span class="k">class</span> <span class="nc">DeterministicPolicy</span><span class="p">(</span><span class="n">Policy</span><span class="p">):</span>
    <span class="c1">#model_type: (str) Model class to use for scoring documents</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">regress_gains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weighted_ls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hyper_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">Policy</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">=</span><span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">hyper_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="o">=</span><span class="n">hyper_params</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">regressGains</span><span class="o">=</span><span class="n">regress_gains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighted</span><span class="o">=</span><span class="n">weighted_ls</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">treeDepths</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">3</span><span class="p">))}</span>
        
        <span class="c1">#Must call train(...) to set all these members</span>
        <span class="c1">#before using DeterministicPolicy objects elsewhere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureList</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="kc">None</span>
            
        <span class="c1">#These members are set by predictAll(...) method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedRankingsSize</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedRankings</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:init [INFO] Dataset&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1">#feature_list: list[int],length=unmaskedFeatures; List of features that should be used for training</span>
    <span class="c1">#name: (str) String to help identify this DeterministicPolicy object henceforth</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureList</span><span class="o">=</span><span class="n">feature_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">modelType</span>
        <span class="n">modelFile</span><span class="o">=</span><span class="n">Settings</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="s1">&#39;alpha&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">:</span>
            <span class="c1">#Expecting hyper-params for GBRT; Add those hyper-params to the model file name</span>
            <span class="n">modelFile</span><span class="o">=</span><span class="n">modelFile</span><span class="o">+</span><span class="s1">&#39;ensemble-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">[</span><span class="s1">&#39;ensemble&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;_lr-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;_subsample-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">[</span><span class="s1">&#39;subsample&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;_leaves-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">[</span><span class="s1">&#39;leaves&#39;</span><span class="p">])</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;gbrt&#39;</span><span class="p">:</span>
            <span class="n">modelFile</span><span class="o">+=</span><span class="s1">&#39;.z&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modelFile</span><span class="o">+=</span><span class="s1">&#39;.npz&#39;</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">savedRankingsSize</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedRankings</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">modelFile</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;gbrt&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">=</span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">modelFile</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] Using precomputed policy&quot;</span><span class="p">,</span> <span class="n">modelFile</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">modelFile</span><span class="p">)</span> <span class="k">as</span> <span class="n">npFile</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="n">npFile</span><span class="p">[</span><span class="s1">&#39;policyParams&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] Using precomputed policy&quot;</span><span class="p">,</span> <span class="n">modelFile</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] PolicyParams&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numQueries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
        
            <span class="n">allFeatures</span><span class="o">=</span><span class="kc">None</span>
            <span class="n">allTargets</span><span class="o">=</span><span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] Constructing features and targets&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">allFeatures</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csc&#39;</span><span class="p">)</span>
                <span class="n">allTargets</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">relevances</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temporaryFeatures</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">temporaryTargets</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">currentQuery</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numQueries</span><span class="p">):</span>
                    <span class="n">temporaryFeatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">currentQuery</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">currentQuery</span><span class="p">],</span> <span class="p">:])</span>
                    <span class="n">temporaryTargets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">relevances</span><span class="p">[</span><span class="n">currentQuery</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">currentQuery</span><span class="p">]])</span>
                
                <span class="n">allFeatures</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">temporaryFeatures</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csc&#39;</span><span class="p">)</span>
                <span class="n">allTargets</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">temporaryTargets</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressGains</span><span class="p">:</span>
                <span class="n">allTargets</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp2</span><span class="p">(</span><span class="n">allTargets</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span>
            
            <span class="n">allSampleWeights</span><span class="o">=</span><span class="kc">None</span>
            <span class="n">fitParams</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted</span><span class="p">:</span>
                <span class="n">allSampleWeights</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">allSampleWeights</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">allSampleWeights</span><span class="p">)</span>
                <span class="n">allSampleWeights</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">allSampleWeights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span>    
                <span class="n">fitParams</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sample_weight&#39;</span><span class="p">:</span> <span class="n">allSampleWeights</span><span class="p">}</span>
            
            <span class="c1">#Restrict features to only the unmasked features</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] Masking unused features. Remaining feature size&quot;</span><span class="p">,</span> 
                    <span class="nb">len</span><span class="p">(</span><span class="n">feature_list</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">allFeatures</span> <span class="o">=</span> <span class="n">allFeatures</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureList</span><span class="p">]</span>
        
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] Beginning training&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span><span class="p">:</span>
                <span class="n">treeCV</span><span class="o">=</span><span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">GridSearchCV</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">criterion</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span>
                                                        <span class="n">splitter</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                                                        <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">presort</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                <span class="n">param_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">treeDepths</span><span class="p">,</span>
                                <span class="n">scoring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fit_params</span><span class="o">=</span><span class="n">fitParams</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">iid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="s2">&quot;1*n_jobs&quot;</span><span class="p">,</span>
                                <span class="n">error_score</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            
                <span class="n">treeCV</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">allFeatures</span><span class="p">,</span> <span class="n">allTargets</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">=</span><span class="n">treeCV</span><span class="o">.</span><span class="n">best_estimator_</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] Done. Best depth&quot;</span><span class="p">,</span> 
                            <span class="n">treeCV</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;max_depth&#39;</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">modelFile</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;lasso&#39;</span><span class="p">:</span>
                <span class="n">lassoCV</span><span class="o">=</span><span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">GridSearchCV</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">Lasso</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy_X</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                                        <span class="n">max_iter</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">warm_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">),</span>
                                <span class="n">param_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">,</span>
                                <span class="n">scoring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fit_params</span><span class="o">=</span><span class="n">fitParams</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">iid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="s2">&quot;1*n_jobs&quot;</span><span class="p">,</span>
                                <span class="n">error_score</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                
                <span class="n">lassoCV</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">allFeatures</span><span class="p">,</span> <span class="n">allTargets</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="n">lassoCV</span><span class="o">.</span><span class="n">best_estimator_</span><span class="o">.</span><span class="n">coef_</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] Done. CVAlpha&quot;</span><span class="p">,</span> <span class="n">lassoCV</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] PolicyParams&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">modelFile</span><span class="p">,</span> <span class="n">policyParams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="p">)</span>
        
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span> <span class="o">==</span> <span class="s1">&#39;ridge&#39;</span><span class="p">:</span>
                <span class="n">ridgeCV</span><span class="o">=</span><span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">GridSearchCV</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">Ridge</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                                    <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy_X</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                                    <span class="n">max_iter</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                                         <span class="n">param_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">,</span>
                                                         <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">fit_params</span><span class="o">=</span><span class="n">fitParams</span><span class="p">,</span>
                                                         <span class="n">iid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="s1">&#39;1*n_jobs&#39;</span><span class="p">)</span>
                <span class="n">ridgeCV</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">allFeatures</span><span class="p">,</span> <span class="n">allTargets</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="o">=</span><span class="n">ridgeCV</span><span class="o">.</span><span class="n">best_estimator_</span><span class="o">.</span><span class="n">coef_</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] Done. CVAlpha&quot;</span><span class="p">,</span> <span class="n">ridgeCV</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;gbrt&#39;</span><span class="p">:</span>
                <span class="n">tree</span><span class="o">=</span><span class="n">sklearn</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span>
                            <span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">[</span><span class="s1">&#39;ensemble&#39;</span><span class="p">],</span> <span class="n">subsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">[</span><span class="s1">&#39;subsample&#39;</span><span class="p">],</span> <span class="n">max_leaf_nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperParams</span><span class="p">[</span><span class="s1">&#39;leaves&#39;</span><span class="p">],</span> 
                            <span class="n">max_features</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">presort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">allFeatures</span><span class="p">,</span> <span class="n">allTargets</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">allSampleWeights</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [INFO] Done.&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">modelFile</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:train [ERR] </span><span class="si">%s</span><span class="s2"> not supported.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">#query_id: (int) Query ID in self.dataset</span>
    <span class="c1">#ranking_size: (int) Size of ranking. Returned ranking length is min(ranking_size,docsPerQuery[query_id])</span>
    <span class="c1">#                       Use ranking_size=-1 to rank all available documents for query_id</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedRankingsSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedRankingsSize</span><span class="o">==</span><span class="n">ranking_size</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedRankings</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span>
        
        <span class="n">allowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span>
        <span class="n">validDocs</span><span class="o">=</span><span class="n">ranking_size</span>
        <span class="k">if</span> <span class="n">ranking_size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">validDocs</span> <span class="o">&gt;</span> <span class="n">allowedDocs</span><span class="p">:</span>
            <span class="n">validDocs</span><span class="o">=</span><span class="n">allowedDocs</span>
        
        <span class="n">currentFeatures</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">currentFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">query_id</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureList</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">currentFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">currentFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">query_id</span><span class="p">],</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">currentFeatures</span><span class="o">=</span><span class="n">currentFeatures</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureList</span><span class="p">]</span>
        
        <span class="n">allDocScores</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;tree&#39;</span><span class="p">:</span>
            <span class="n">allDocScores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">currentFeatures</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelType</span><span class="o">==</span><span class="s1">&#39;gbrt&#39;</span><span class="p">:</span>
            <span class="n">allDocScores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">currentFeatures</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allDocScores</span><span class="o">=</span><span class="n">currentFeatures</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policyParams</span><span class="p">)</span>
            
        <span class="n">tieBreaker</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">allDocScores</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">sortedDocScores</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">tieBreaker</span><span class="p">,</span><span class="o">-</span><span class="n">allDocScores</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="n">validDocs</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sortedDocScores</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="n">sortedDocScores</span><span class="p">]</span>
    
    <span class="c1">#ranking_size: (int) Size of ranking. Returned ranking length is min(ranking_size,docsPerQuery[query_id])</span>
    <span class="c1">#                       Use ranking_size=-1 to rank all available documents for query_id</span>
    <span class="k">def</span> <span class="nf">predictAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedRankingsSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">savedRankingsSize</span><span class="o">==</span><span class="n">ranking_size</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">numQueries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
        <span class="n">predictedRankings</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numQueries</span><span class="p">):</span>
            <span class="n">predictedRankings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">))</span>
                
            <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">savedRankingsSize</span><span class="o">=</span><span class="n">ranking_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedRankings</span><span class="o">=</span><span class="n">predictedRankings</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:predictAll [INFO] Generated all predictions for </span><span class="si">%s</span><span class="s2"> using policy: &quot;</span> <span class="o">%</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="c1">#num_allowed_docs: (int) Filters the dataset where the max docs per query is num_allowed_docs.</span>
    <span class="c1">#                        Uses policyParams to rank and filter the original document set.</span>
    <span class="k">def</span> <span class="nf">filterDataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_allowed_docs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedRankingsSize</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savedRankings</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="n">numQueries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;-filt(&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_allowed_docs</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
        
        <span class="n">newMask</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numQueries</span><span class="p">):</span>
            <span class="n">producedRanking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">num_allowed_docs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">producedRanking</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">newMask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">producedRanking</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">newMask</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeterministicPolicy:filteredDataset [INFO] New Name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> MaxNumDocs&quot;</span><span class="p">,</span> <span class="n">num_allowed_docs</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        
<span class="k">class</span> <span class="nc">UniformPolicy</span><span class="p">(</span><span class="n">Policy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">allow_repetitions</span><span class="p">):</span>
        <span class="n">Policy</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">allow_repetitions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Unif-&#39;</span>
        <span class="k">if</span> <span class="n">allow_repetitions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;Rep&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;NoRep&#39;</span>
    
        <span class="c1">#These members are set on-demand by setupGamma(...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UniformPolicy:init [INFO] Dataset: </span><span class="si">%s</span><span class="s2"> AllowRepetitions:&quot;</span> <span class="o">%</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">allow_repetitions</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1">#ranking_size: (int) Size of ranking.</span>
    <span class="k">def</span> <span class="nf">setupGamma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span><span class="o">==</span><span class="n">ranking_size</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UniformPolicy:setupGamma [INFO] Gamma has been pre-computed for this ranking_size. Size of Gamma cache:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">gammaFile</span><span class="o">=</span><span class="n">Settings</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ranking_size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.z&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gammaFile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="o">=</span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">gammaFile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span><span class="o">=</span><span class="n">ranking_size</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UniformPolicy:setupGamma [INFO] Using precomputed gamma&quot;</span><span class="p">,</span> <span class="n">gammaFile</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="o">=</span><span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span><span class="o">=</span><span class="n">ranking_size</span>
            
            <span class="n">candidateSet</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span>
            
            <span class="n">responses</span><span class="o">=</span><span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">50</span><span class="p">)(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">UniformGamma</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">candidateSet</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">,</span> <span class="n">gammaFile</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UniformPolicy:setupGamma [INFO] Finished creating Gamma_pinv cache. Size&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="n">allowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span>    
        
        <span class="n">validDocs</span><span class="o">=</span><span class="n">ranking_size</span>
        <span class="k">if</span> <span class="n">ranking_size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">validDocs</span> <span class="o">&gt;</span> <span class="n">allowedDocs</span><span class="p">)):</span>
            <span class="n">validDocs</span><span class="o">=</span><span class="n">allowedDocs</span>
            
        <span class="n">producedRanking</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">:</span>
            <span class="n">producedRanking</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">allowedDocs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">validDocs</span><span class="p">,</span>
                                <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">producedRanking</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">allowedDocs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">validDocs</span><span class="p">,</span>
                                <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">producedRanking</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">query_id</span><span class="p">][</span><span class="n">producedRanking</span><span class="p">]</span>
        

<span class="k">class</span> <span class="nc">NonUniformPolicy</span><span class="p">(</span><span class="n">Policy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deterministic_policy</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">allow_repetitions</span><span class="p">,</span> <span class="n">decay</span><span class="p">):</span>
        <span class="n">Policy</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">allow_repetitions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decay</span> <span class="o">=</span> <span class="n">decay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">deterministic_policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NonUnif-&#39;</span>
        <span class="k">if</span> <span class="n">allow_repetitions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;Rep&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+=</span><span class="s1">&#39;NoRep&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">deterministic_policy</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decay</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        
        <span class="c1">#These members are set on-demand by setupGamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multinomials</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NonUniformPolicy:init [INFO] Dataset: </span><span class="si">%s</span><span class="s2"> AllowRepetitions:&quot;</span> <span class="o">%</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">allow_repetitions</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Decay:&quot;</span><span class="p">,</span> <span class="n">decay</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">setupGamma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span><span class="o">==</span><span class="n">ranking_size</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NonUniformPolicy:setupGamma [INFO] Gamma has been pre-computed for this ranking_size. Size of Gamma cache:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">gammaFile</span><span class="o">=</span><span class="n">Settings</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ranking_size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.z&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gammaFile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multinomials</span><span class="o">=</span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">gammaFile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span><span class="o">=</span><span class="n">ranking_size</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NonUniformPolicy:setupGamma [INFO] Using precomputed gamma&quot;</span><span class="p">,</span> <span class="n">gammaFile</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="o">=</span><span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multinomials</span><span class="o">=</span><span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gammaRankingSize</span><span class="o">=</span><span class="n">ranking_size</span>
            
            <span class="n">candidateSet</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span>
            <span class="n">responses</span><span class="o">=</span><span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">50</span><span class="p">)(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">NonUniformGamma</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">candidateSet</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">multinomials</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multinomials</span><span class="p">),</span> <span class="n">gammaFile</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NonUniformPolicy:setupGamma [INFO] Finished creating Gamma_pinv cache. Size&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">predictAll</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_id</span><span class="p">,</span> <span class="n">ranking_size</span><span class="p">):</span>
        <span class="n">allowedDocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span>    
        <span class="n">underlyingRanking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">query_id</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="n">validDocs</span><span class="o">=</span><span class="n">ranking_size</span>
        <span class="k">if</span> <span class="n">ranking_size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">validDocs</span> <span class="o">&gt;</span> <span class="n">allowedDocs</span><span class="p">)):</span>
            <span class="n">validDocs</span><span class="o">=</span><span class="n">allowedDocs</span>
            
        <span class="n">currentDistribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multinomials</span><span class="p">[</span><span class="n">allowedDocs</span><span class="p">]</span>
        <span class="n">producedRanking</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowRepetitions</span><span class="p">:</span>
            <span class="n">producedRanking</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">allowedDocs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">validDocs</span><span class="p">,</span>
                                <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">currentDistribution</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">producedRanking</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">allowedDocs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">validDocs</span><span class="p">,</span>
                                <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">currentDistribution</span><span class="p">)</span>
                                
        <span class="k">return</span> <span class="n">underlyingRanking</span><span class="p">[</span><span class="n">producedRanking</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">M</span><span class="o">=</span><span class="mi">100</span>
<span class="n">L</span><span class="o">=</span><span class="mi">10</span>
<span class="n">resetSeed</span><span class="o">=</span><span class="mi">387</span>

<span class="n">mslrData</span><span class="o">=</span><span class="n">Datasets</span><span class="o">.</span><span class="n">Datasets</span><span class="p">()</span>
<span class="n">mslrData</span><span class="o">.</span><span class="n">loadNpz</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="s1">&#39;MSLR/mslr&#39;</span><span class="p">)</span>

<span class="n">anchorURLFeatures</span><span class="p">,</span> <span class="n">bodyTitleDocFeatures</span><span class="o">=</span><span class="n">Settings</span><span class="o">.</span><span class="n">get_feature_sets</span><span class="p">(</span><span class="s2">&quot;MSLR&quot;</span><span class="p">)</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">resetSeed</span><span class="p">)</span>
<span class="n">detLogger</span><span class="o">=</span><span class="n">DeterministicPolicy</span><span class="p">(</span><span class="n">mslrData</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">)</span>
<span class="n">detLogger</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">anchorURLFeatures</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span>

<span class="n">detLogger</span><span class="o">.</span><span class="n">filterDataset</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

<span class="n">filteredDataset</span><span class="o">=</span><span class="n">detLogger</span><span class="o">.</span><span class="n">dataset</span>
<span class="k">del</span> <span class="n">mslrData</span>
<span class="k">del</span> <span class="n">detLogger</span>

<span class="n">uniform</span><span class="o">=</span><span class="n">UniformPolicy</span><span class="p">(</span><span class="n">filteredDataset</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">uniform</span><span class="o">.</span><span class="n">setupGamma</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
<span class="k">del</span> <span class="n">uniform</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">resetSeed</span><span class="p">)</span>
<span class="n">loggingPolicyTree</span><span class="o">=</span><span class="n">DeterministicPolicy</span><span class="p">(</span><span class="n">filteredDataset</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">)</span>
<span class="n">loggingPolicyTree</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">anchorURLFeatures</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span>
        
<span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">resetSeed</span><span class="p">)</span>
<span class="n">targetPolicyTree</span><span class="o">=</span><span class="n">DeterministicPolicy</span><span class="p">(</span><span class="n">filteredDataset</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">)</span>
<span class="n">targetPolicyTree</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">bodyTitleDocFeatures</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">resetSeed</span><span class="p">)</span>
<span class="n">loggingPolicyLinear</span><span class="o">=</span><span class="n">DeterministicPolicy</span><span class="p">(</span><span class="n">filteredDataset</span><span class="p">,</span> <span class="s1">&#39;lasso&#39;</span><span class="p">)</span>
<span class="n">loggingPolicyLinear</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">anchorURLFeatures</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">resetSeed</span><span class="p">)</span>
<span class="n">targetPolicyLinear</span><span class="o">=</span><span class="n">DeterministicPolicy</span><span class="p">(</span><span class="n">filteredDataset</span><span class="p">,</span> <span class="s1">&#39;lasso&#39;</span><span class="p">)</span>
<span class="n">targetPolicyLinear</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">bodyTitleDocFeatures</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span>

<span class="n">numQueries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">filteredDataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">)</span>

<span class="n">TTtau</span><span class="o">=</span><span class="p">[]</span>
<span class="n">TToverlap</span><span class="o">=</span><span class="p">[]</span>
<span class="n">TLtau</span><span class="o">=</span><span class="p">[]</span>
<span class="n">TLoverlap</span><span class="o">=</span><span class="p">[]</span>
<span class="n">LTtau</span><span class="o">=</span><span class="p">[]</span>
<span class="n">LToverlap</span><span class="o">=</span><span class="p">[]</span>
<span class="n">LLtau</span><span class="o">=</span><span class="p">[]</span>
<span class="n">LLoverlap</span><span class="o">=</span><span class="p">[]</span>
<span class="n">LogLogtau</span><span class="o">=</span><span class="p">[]</span>
<span class="n">LogLogoverlap</span><span class="o">=</span><span class="p">[]</span>
<span class="n">TargetTargettau</span><span class="o">=</span><span class="p">[]</span>
<span class="n">TargetTargetoverlap</span><span class="o">=</span><span class="p">[]</span>

<span class="k">def</span> <span class="nf">computeTau</span><span class="p">(</span><span class="n">ranking1</span><span class="p">,</span> <span class="n">ranking2</span><span class="p">):</span>
    <span class="n">rank1set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">ranking1</span><span class="p">)</span>
    <span class="n">rank2set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">ranking2</span><span class="p">)</span>
    <span class="n">documents</span><span class="o">=</span><span class="n">rank1set</span> <span class="o">|</span> <span class="n">rank2set</span>
    <span class="n">rankingSize</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rank1set</span><span class="p">)</span>
    
    <span class="n">newRanking1</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">newRanking2</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">docID</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">documents</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">doc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rank1set</span><span class="p">:</span>
            <span class="n">newRanking1</span><span class="p">[</span><span class="n">docID</span><span class="p">]</span><span class="o">=</span><span class="n">rankingSize</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">newRanking2</span><span class="p">[</span><span class="n">docID</span><span class="p">]</span><span class="o">=</span><span class="n">ranking2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">doc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rank2set</span><span class="p">:</span>
            <span class="n">newRanking2</span><span class="p">[</span><span class="n">docID</span><span class="p">]</span><span class="o">=</span><span class="n">rankingSize</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">newRanking1</span><span class="p">[</span><span class="n">docID</span><span class="p">]</span><span class="o">=</span><span class="n">ranking1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newRanking1</span><span class="p">[</span><span class="n">docID</span><span class="p">]</span><span class="o">=</span><span class="n">ranking1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="n">newRanking2</span><span class="p">[</span><span class="n">docID</span><span class="p">]</span><span class="o">=</span><span class="n">ranking2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">kendalltau</span><span class="p">(</span><span class="n">newRanking1</span><span class="p">,</span> <span class="n">newRanking2</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.0</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">rank1set</span><span class="o">&amp;</span><span class="n">rank2set</span><span class="p">)</span><span class="o">/</span><span class="n">rankingSize</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">resetSeed</span><span class="p">)</span>    
<span class="k">for</span> <span class="n">currentQuery</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numQueries</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filteredDataset</span><span class="o">.</span><span class="n">docsPerQuery</span><span class="p">[</span><span class="n">currentQuery</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">:</span>
        <span class="k">continue</span>
        
    <span class="n">logTreeRanking</span><span class="o">=</span><span class="n">loggingPolicyTree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">currentQuery</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">logLinearRanking</span><span class="o">=</span><span class="n">loggingPolicyLinear</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">currentQuery</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="n">targetTreeRanking</span><span class="o">=</span><span class="n">targetPolicyTree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">currentQuery</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">targetLinearRanking</span><span class="o">=</span><span class="n">targetPolicyLinear</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">currentQuery</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="n">tau</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">computeTau</span><span class="p">(</span><span class="n">logTreeRanking</span><span class="p">,</span> <span class="n">targetTreeRanking</span><span class="p">)</span>
    <span class="n">TTtau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">TToverlap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span>
    
    <span class="n">tau</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">computeTau</span><span class="p">(</span><span class="n">logTreeRanking</span><span class="p">,</span> <span class="n">targetLinearRanking</span><span class="p">)</span>
    <span class="n">TLtau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">TLoverlap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span>
    
    <span class="n">tau</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">computeTau</span><span class="p">(</span><span class="n">logLinearRanking</span><span class="p">,</span> <span class="n">targetTreeRanking</span><span class="p">)</span>
    <span class="n">LTtau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">LToverlap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span>
    
    <span class="n">tau</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">computeTau</span><span class="p">(</span><span class="n">logLinearRanking</span><span class="p">,</span> <span class="n">targetLinearRanking</span><span class="p">)</span>
    <span class="n">LLtau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">LLoverlap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span>
    
    <span class="n">tau</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">computeTau</span><span class="p">(</span><span class="n">logLinearRanking</span><span class="p">,</span> <span class="n">logTreeRanking</span><span class="p">)</span>
    <span class="n">LogLogtau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">LogLogoverlap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span>
    
    <span class="n">tau</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">computeTau</span><span class="p">(</span><span class="n">targetLinearRanking</span><span class="p">,</span> <span class="n">targetTreeRanking</span><span class="p">)</span>
    <span class="n">TargetTargettau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">TargetTargetoverlap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TTtau</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">TTtau</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TTtau</span><span class="p">)</span>
<span class="n">TLtau</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TLtau</span><span class="p">)</span>
<span class="n">LTtau</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LTtau</span><span class="p">)</span>
<span class="n">LLtau</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LLtau</span><span class="p">)</span>
<span class="n">LogLogtau</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LogLogtau</span><span class="p">)</span>
<span class="n">TargetTargettau</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TargetTargettau</span><span class="p">)</span>

<span class="n">TToverlap</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TToverlap</span><span class="p">)</span>
<span class="n">TLoverlap</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TLoverlap</span><span class="p">)</span>
<span class="n">LToverlap</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LToverlap</span><span class="p">)</span>
<span class="n">LLoverlap</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LLoverlap</span><span class="p">)</span>
<span class="n">LogLogoverlap</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LogLogoverlap</span><span class="p">)</span>
<span class="n">TargetTargetoverlap</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TargetTargetoverlap</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TTtau&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">TTtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">TTtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">TTtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">TTtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">TTtau</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TTtau</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TToverlap&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">TToverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">TToverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">TToverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">TToverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">TToverlap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TToverlap</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TLtau&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">TLtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">TLtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">TLtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">TLtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">TLtau</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TLtau</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TLoverlap&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">TLoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">TLoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">TLoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">TLoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">TLoverlap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TLoverlap</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LTtau&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">LTtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">LTtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LTtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">LTtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">LTtau</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LTtau</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LToverlap&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">LToverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">LToverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LToverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">LToverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">LToverlap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LToverlap</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LLtau&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">LLtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">LLtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LLtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">LLtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">LLtau</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LLtau</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LLoverlap&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">LLoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">LLoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LLoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">LLoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">LLoverlap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LLoverlap</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LogLogtau&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">LogLogtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">LogLogtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LogLogtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">LogLogtau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">LogLogtau</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LogLogtau</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LogLogoverlap&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">LogLogoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">LogLogoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LogLogoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">LogLogoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">LogLogoverlap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LogLogoverlap</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TargetTargettau&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">TargetTargettau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">TargetTargettau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">TargetTargettau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">TargetTargettau</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">TargetTargettau</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TargetTargettau</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TargetTargetoverlap&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">TargetTargetoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">TargetTargetoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">TargetTargetoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">TargetTargetoverlap</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">TargetTargetoverlap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TargetTargetoverlap</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Optimization">Optimization<a class="anchor-link" href="#Optimization"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Script for semi-synthetic optimization runs</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="c1"># import argparse</span>
<span class="c1"># import Settings</span>
<span class="c1"># import sys</span>
<span class="c1"># import os</span>
<span class="c1"># import numpy</span>
<span class="c1"># import Policy</span>
<span class="c1"># import Metrics</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/2022/01/24/ope-slate.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
