<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Training MPM Recommendation Model on ML-1m in PyTorch | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Training MPM Recommendation Model on ML-1m in PyTorch" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jupyter notebook database." />
<meta property="og:description" content="Jupyter notebook database." />
<link rel="canonical" href="https://nb.recohut.com/2022/01/14/mpm.html" />
<meta property="og:url" content="https://nb.recohut.com/2022/01/14/mpm.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-14T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Training MPM Recommendation Model on ML-1m in PyTorch" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-14T00:00:00-06:00","datePublished":"2022-01-14T00:00:00-06:00","description":"Jupyter notebook database.","headline":"Training MPM Recommendation Model on ML-1m in PyTorch","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/2022/01/14/mpm.html"},"url":"https://nb.recohut.com/2022/01/14/mpm.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Training MPM Recommendation Model on ML-1m in PyTorch</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-14T00:00:00-06:00" itemprop="datePublished">
        Jan 14, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      23 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2022-01-14-mpm.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2022-01-14-mpm.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2022-01-14-mpm.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2022-01-14-mpm.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-14-mpm.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Problem</td>
<td>In the implicit feedback recommendation, incorporating short-term preference into recommender systems has attracted increasing attention in recent years. However, unexpected behaviors in historical interactions like clicking some items by accident don’t well reflect users’ inherent preferences. Existing studies fail to model the effects of unexpected behaviors thus achieve inferior recommendation performance</td>
</tr>
<tr>
<td>Solution</td>
<td>Multi-Preferences Model (MPM) tries to eliminate the effects of unexpected behaviors by first extracting the users’ instant preferences from their recent historical interactions by a fine-grained preferences module. Then an unexpected-behaviors detector is trained to judge whether these instant preferences are biased by unexpected behaviors. we also integrate user’s general preference in MPM. Finally, an output module is performed to eliminates the effects of unexpected behaviors and integrates all the information to make a final recommendation.</td>
</tr>
<tr>
<td>Dataset</td>
<td>ML-1m</td>
</tr>
<tr>
<td>Preprocessing</td>
<td>We evaluate the performance of our proposed model by the leave-one-out evaluation. For each dataset, we hold out the last one item that each user has interacted with and sample 99 items that unobserved interactions to form the test set, a validation set is also created like the test set and remaining data as a training set. For each positive user-item interaction pair in the training set, we conducted the negative sampling strategy to pair it with four negative items.</td>
</tr>
<tr>
<td>Metrics</td>
<td>HR@10, NDCG@10</td>
</tr>
<tr>
<td>Models</td>
<td>MPM (Multi-Preferences Model)</td>
</tr>
<tr>
<td>Platform</td>
<td>PyTorch 1.10.0+cpu, Ubuntu 18.0 Google Colab instnce (VM)</td>
</tr>
<tr>
<td>Links</td>
<td><a href="https://arxiv.org/pdf/2112.11023v1.pdf">Paper</a>, <a href="https://github.com/chenjie04/MPM">Code</a></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">mlperf_compliance</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting mlperf_compliance
  Downloading mlperf_compliance-0.0.10-py3-none-any.whl (24 kB)
Installing collected packages: mlperf-compliance
Successfully installed mlperf-compliance-0.0.10
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">mkdir</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">data</span>
<span class="o">%</span><span class="n">cd</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">data</span>
<span class="err">!</span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">files</span><span class="o">.</span><span class="n">grouplens</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">datasets</span><span class="o">/</span><span class="n">movielens</span><span class="o">/</span><span class="n">ml</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">zip</span>
<span class="err">!</span><span class="n">unzip</span> <span class="n">ml</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">zip</span>
<span class="o">%</span><span class="n">cd</span> <span class="o">/</span><span class="n">content</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>/content/data
--2021-12-30 10:50:10--  https://files.grouplens.org/datasets/movielens/ml-1m.zip
Resolving files.grouplens.org (files.grouplens.org)... 128.101.65.152
Connecting to files.grouplens.org (files.grouplens.org)|128.101.65.152|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 5917549 (5.6M) [application/zip]
Saving to: ‘ml-1m.zip’

ml-1m.zip           100%[===================&gt;]   5.64M  34.8MB/s    in 0.2s    

2021-12-30 10:50:11 (34.8 MB/s) - ‘ml-1m.zip’ saved [5917549/5917549]

Archive:  ml-1m.zip
   creating: ml-1m/
  inflating: ml-1m/movies.dat        
  inflating: ml-1m/ratings.dat       
  inflating: ml-1m/README            
  inflating: ml-1m/users.dat         
/content
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Datasets">Datasets<a class="anchor-link" href="#Datasets"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="n">RatingData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RatingData&#39;</span><span class="p">,</span>
                        <span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;ratings&#39;</span><span class="p">,</span> <span class="s1">&#39;min_date&#39;</span><span class="p">,</span> <span class="s1">&#39;max_date&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">describe_ratings</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">RatingData</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
                      <span class="n">users</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
                      <span class="n">ratings</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ratings</span><span class="p">),</span>
                      <span class="n">min_date</span><span class="o">=</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                      <span class="n">max_date</span><span class="o">=</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{ratings}</span><span class="s2"> ratings on </span><span class="si">{items}</span><span class="s2"> items from </span><span class="si">{users}</span><span class="s2"> users&quot;</span>
          <span class="s2">&quot; from </span><span class="si">{min_date}</span><span class="s2"> to </span><span class="si">{max_date}</span><span class="s2">&quot;</span>
          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">_asdict</span><span class="p">())))</span>
    <span class="k">return</span> <span class="n">info</span>


<span class="k">def</span> <span class="nf">process_movielens</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">ratings</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">describe_ratings</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ratings</span>

<span class="k">def</span> <span class="nf">process_taobao</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">ratings</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">describe_ratings</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ratings</span>


<span class="k">def</span> <span class="nf">load_ml_100k</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
    <span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_movielens</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_ml_1m</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
    <span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_movielens</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_ml_10m</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
    <span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_movielens</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_ml_20m</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;userId&#39;</span><span class="p">:</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;movieId&#39;</span><span class="p">:</span> <span class="s1">&#39;item_id&#39;</span><span class="p">}</span>
    <span class="n">ratings</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_movielens</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">load_taobao</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span><span class="s1">&#39;category_id&#39;</span><span class="p">,</span><span class="s1">&#39;behavior_type&#39;</span><span class="p">,</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
    <span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_taobao</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span>



<span class="n">DATASETS</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;load_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;load_&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_dataset_name</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">DATASETS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">dataset</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">def</span> <span class="nf">implicit_load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;load_&quot;</span> <span class="o">+</span> <span class="n">get_dataset_name</span><span class="p">(</span><span class="n">filename</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>


<span class="kn">from</span> <span class="nn">mlperf_compliance</span> <span class="kn">import</span> <span class="n">mlperf_log</span>


<span class="n">MIN_RATINGS</span> <span class="o">=</span> <span class="mi">20</span>


<span class="n">USER_COLUMN</span> <span class="o">=</span> <span class="s1">&#39;user_id&#39;</span>
<span class="n">ITEM_COLUMN</span> <span class="o">=</span> <span class="s1">&#39;item_id&#39;</span>


<span class="n">TRAIN_RATINGS_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;train_ratings.csv&#39;</span>
<span class="n">TEST_RATINGS_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;test_ratings.csv&#39;</span>
<span class="n">TEST_NEG_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;test_negative.csv&#39;</span>
<span class="n">DATA_SUMMARY_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;data_summary.csv&quot;</span>

<span class="c1"># PATH = &#39;data/taobao-1m&#39;</span>
<span class="c1"># OUTPUT = &#39;data/taobao-1m&#39;</span>
<span class="n">PATH</span> <span class="o">=</span> <span class="s1">&#39;data/ml-1m&#39;</span>
<span class="n">OUTPUT</span> <span class="o">=</span> <span class="s1">&#39;data/ml-1m&#39;</span>
<span class="n">NEGATIVES</span> <span class="o">=</span> <span class="mi">99</span>
<span class="n">HISTORY_SIZE</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">RANDOM_SEED</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="c1"># parser.add_argument(&#39;--file&#39;,type=str,default=(os.path.join(PATH,&#39;UserBehavior01.csv&#39;)),</span>
    <span class="c1">#                     help=&#39;Path to reviews CSV file from dataset&#39;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--file&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span><span class="s1">&#39;ratings.dat&#39;</span><span class="p">)),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to reviews CSV file from dataset&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">OUTPUT</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output directory for train and test CSV files&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--negatives&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NEGATIVES</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of negative samples for each positive&#39;</span>
                             <span class="s1">&#39;test example&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--history_size&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">HISTORY_SIZE</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The size of history&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--seed&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Random seed to reproduce same negative samples&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">({})</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading raw data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
    <span class="c1">#-------------- MovieLens dataset ------------------------------</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">implicit_load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1">#---------------------------------------------------------------</span>

    <span class="c1">#------ retailrocket-recommender-system-dataset --------------------</span>
    <span class="c1"># df = pd.read_csv(args.file, sep=&#39;,&#39;, header=0)</span>
    <span class="c1"># df.columns = [&#39;timestamp&#39;, &#39;user_id&#39;, &#39;event&#39;, &#39;item_id&#39;, &#39;transaction_id&#39;]</span>
    <span class="c1"># df[&#39;timestamp&#39;] = pd.to_datetime(df[&#39;timestamp&#39;], unit=&#39;ms&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># RatingData = namedtuple(&#39;RatingData&#39;,</span>
    <span class="c1">#                         [&#39;items&#39;, &#39;users&#39;, &#39;ratings&#39;, &#39;min_date&#39;, &#39;max_date&#39;])</span>
    <span class="c1"># info = RatingData(items=len(df[&#39;item_id&#39;].unique()),</span>
    <span class="c1">#                   users=len(df[&#39;user_id&#39;].unique()),</span>
    <span class="c1">#                   ratings=len(df),</span>
    <span class="c1">#                   min_date=df[&#39;timestamp&#39;].min(),</span>
    <span class="c1">#                   max_date=df[&#39;timestamp&#39;].max())</span>
    <span class="c1"># print(&quot;{ratings} ratings on {items} items from {users} users&quot;</span>
    <span class="c1">#           &quot; from {min_date} to {max_date}&quot;</span>
    <span class="c1">#           .format(**(info._asdict())))</span>
    <span class="c1"># #--------------------------------------------------------------------</span>

    <span class="c1">#-------------------amazon dataset------------------------</span>
    <span class="c1"># df = pd.read_csv(args.file, sep=&#39;,&#39;, header=None)</span>
    <span class="c1"># df.columns = [&#39;user_id&#39;, &#39;item_id&#39;, &#39;rating&#39;, &#39;timestamp&#39;]</span>
    <span class="c1"># df[&#39;timestamp&#39;] = pd.to_datetime(df[&#39;timestamp&#39;], unit=&#39;s&#39;)</span>
    <span class="c1">#</span>
    <span class="c1"># RatingData = namedtuple(&#39;RatingData&#39;,</span>
    <span class="c1">#                         [&#39;items&#39;, &#39;users&#39;, &#39;ratings&#39;, &#39;min_date&#39;, &#39;max_date&#39;])</span>
    <span class="c1"># info = RatingData(items=len(df[&#39;item_id&#39;].unique()),</span>
    <span class="c1">#                   users=len(df[&#39;user_id&#39;].unique()),</span>
    <span class="c1">#                   ratings=len(df),</span>
    <span class="c1">#                   min_date=df[&#39;timestamp&#39;].min(),</span>
    <span class="c1">#                   max_date=df[&#39;timestamp&#39;].max())</span>
    <span class="c1"># print(&quot;{ratings} ratings on {items} items from {users} users&quot;</span>
    <span class="c1">#           &quot; from {min_date} to {max_date}&quot;</span>
    <span class="c1">#           .format(**(info._asdict())))</span>


    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="c1">#------------------- hetrec2011 dataset------------------------</span>
    <span class="c1"># df = pd.read_csv(args.file, sep=&#39;\t&#39;, header=0)</span>
    <span class="c1"># df.columns = [&#39;user_id&#39;, &#39;item_id&#39;, &#39;tag_id&#39;, &#39;timestamp&#39;]</span>
    <span class="c1"># df[&#39;timestamp&#39;] = pd.to_datetime(df[&#39;timestamp&#39;], unit=&#39;ms&#39;)</span>
    <span class="c1">#</span>
    <span class="c1"># RatingData = namedtuple(&#39;RatingData&#39;,</span>
    <span class="c1">#                         [&#39;items&#39;, &#39;users&#39;, &#39;ratings&#39;, &#39;min_date&#39;, &#39;max_date&#39;])</span>
    <span class="c1"># info = RatingData(items=len(df[&#39;item_id&#39;].unique()),</span>
    <span class="c1">#                   users=len(df[&#39;user_id&#39;].unique()),</span>
    <span class="c1">#                   ratings=len(df),</span>
    <span class="c1">#                   min_date=df[&#39;timestamp&#39;].min(),</span>
    <span class="c1">#                   max_date=df[&#39;timestamp&#39;].max())</span>
    <span class="c1"># print(&quot;{ratings} ratings on {items} items from {users} users&quot;</span>
    <span class="c1">#           &quot; from {min_date} to {max_date}&quot;</span>
    <span class="c1">#           .format(**(info._asdict())))</span>
    <span class="c1">#</span>

    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="c1">#------------------- taobao UserBehavior dataset------------------------</span>
    <span class="c1"># df = pd.read_csv(args.file, sep=&#39;,&#39;, header=None)</span>
    <span class="c1"># df.columns = [&#39;user_id&#39;, &#39;item_id&#39;, &#39;category_id&#39;, &#39;behavior_type&#39;, &#39;timestamp&#39;]</span>
    <span class="c1"># df[&#39;timestamp&#39;] = pd.to_datetime(df[&#39;timestamp&#39;], unit=&#39;s&#39;)</span>

    <span class="c1"># RatingData = namedtuple(&#39;RatingData&#39;,</span>
    <span class="c1">#                         [&#39;items&#39;, &#39;users&#39;, &#39;ratings&#39;, &#39;min_date&#39;, &#39;max_date&#39;])</span>
    <span class="c1"># info = RatingData(items=len(df[&#39;item_id&#39;].unique()),</span>
    <span class="c1">#                   users=len(df[&#39;user_id&#39;].unique()),</span>
    <span class="c1">#                   ratings=len(df),</span>
    <span class="c1">#                   min_date=df[&#39;timestamp&#39;].min(),</span>
    <span class="c1">#                   max_date=df[&#39;timestamp&#39;].max())</span>
    <span class="c1"># print(&quot;{ratings} ratings on {items} items from {users} users&quot;</span>
    <span class="c1">#           &quot; from {min_date} to {max_date}&quot;</span>
    <span class="c1">#           .format(**(info._asdict())))</span>


    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering out users with less than </span><span class="si">{}</span><span class="s2"> ratings&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MIN_RATINGS</span><span class="p">))</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">USER_COLUMN</span><span class="p">)</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">PREPROC_HP_MIN_RATINGS</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">MIN_RATINGS</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MIN_RATINGS</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping original user and item IDs to new sequential IDs&quot;</span><span class="p">)</span>
    <span class="n">original_users</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">USER_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">original_items</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ITEM_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="n">nb_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_users</span><span class="p">)</span>
    <span class="n">nb_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_items</span><span class="p">)</span>

    <span class="n">user_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">user</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">original_users</span><span class="p">)}</span>
    <span class="n">item_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">original_items</span><span class="p">)}</span>

    <span class="n">df</span><span class="p">[</span><span class="n">USER_COLUMN</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">USER_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="n">user_map</span><span class="p">[</span><span class="n">user</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="n">ITEM_COLUMN</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ITEM_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item_map</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>

    <span class="c1"># print(df)</span>


    <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="n">USER_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_users</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="n">ITEM_COLUMN</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_items</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating list of items for each user&quot;</span><span class="p">)</span>
    <span class="c1"># Need to sort before popping to get last item</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">all_ratings</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">USER_COLUMN</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">ITEM_COLUMN</span><span class="p">]))</span>
    <span class="n">user_to_items</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Ratings&#39;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
        <span class="n">user_to_items</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">USER_COLUMN</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ITEM_COLUMN</span><span class="p">))</span>  <span class="c1"># noqa: E501</span>

    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_to_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user_to_items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user_to_items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="n">args</span><span class="o">.</span><span class="n">history_size</span><span class="p">:])</span>



    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">{}</span><span class="s2"> negative samples for each user and creating training set&quot;</span>
          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">negatives</span><span class="p">))</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">PREPROC_HP_NUM_EVAL</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">negatives</span><span class="p">)</span>

    <span class="n">train_ratings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_ratings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_negs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original_items</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">user_to_items</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">user_to_items</span><span class="p">)):</span>
        <span class="n">all_negs</span> <span class="o">=</span> <span class="n">all_items</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">all_negs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_negs</span><span class="p">))</span>
        <span class="n">negs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_negs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">negatives</span><span class="p">)</span>

        <span class="n">test_item</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">test_item</span><span class="p">]</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">negs</span><span class="p">)</span>
        <span class="n">test_negs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">test_item</span><span class="p">]</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="n">args</span><span class="o">.</span><span class="n">history_size</span><span class="p">:])</span>
        <span class="n">test_ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">args</span><span class="o">.</span><span class="n">history_size</span><span class="p">:</span>
            <span class="n">tgItem</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="n">tgItem</span><span class="p">]</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="n">args</span><span class="o">.</span><span class="n">history_size</span><span class="p">:])</span>
            <span class="n">train_ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>



    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saving train and test CSV files to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">))</span>



    <span class="n">df_train_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">train_ratings</span><span class="p">))</span>
    <span class="n">df_test_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">test_ratings</span><span class="p">))</span>
    <span class="n">df_test_negs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">test_negs</span><span class="p">))</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving data description ...&#39;</span><span class="p">)</span>
    <span class="n">data_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">nb_users</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="n">nb_items</span><span class="p">,</span> <span class="s1">&#39;history_size&#39;</span><span class="p">:</span> <span class="n">HISTORY_SIZE</span><span class="p">,</span> <span class="s1">&#39;train_entries&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_train_ratings</span><span class="p">),</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_test_ratings</span><span class="p">)},</span>
        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data_summary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">DATA_SUMMARY_FILENAME</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="n">df_train_ratings</span><span class="p">[</span><span class="s1">&#39;fake_rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">df_train_ratings</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">TRAIN_RATINGS_FILENAME</span><span class="p">),</span>
                            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">INPUT_SIZE</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_train_ratings</span><span class="p">))</span>


    <span class="n">df_test_ratings</span><span class="p">[</span><span class="s1">&#39;fake_rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">df_test_ratings</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">TEST_RATINGS_FILENAME</span><span class="p">),</span>
                           <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="n">df_test_negs</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">TEST_NEG_FILENAME</span><span class="p">),</span>
                        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
    <span class="c1"># main()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">mlperf_compliance</span> <span class="kn">import</span> <span class="n">mlperf_log</span>


<span class="k">class</span> <span class="nc">CFTrainDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_fname</span><span class="p">,</span> <span class="n">data_summary_fname</span><span class="p">,</span> <span class="n">nb_neg</span><span class="p">):</span>
        <span class="n">data_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_summary_fname</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_users</span> <span class="o">=</span> <span class="n">data_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_items</span> <span class="o">=</span> <span class="n">data_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;items&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_train_matrix</span><span class="p">(</span><span class="n">train_fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_neg</span> <span class="o">=</span> <span class="n">nb_neg</span>

        <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">INPUT_STEP_TRAIN_NEG_GEN</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">nb_neg</span><span class="p">)</span>
        <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">INPUT_HP_SAMPLE_TRAIN_REPLACEMENT</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_train_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_fname</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">process_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">tmp</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">process_line</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
        <span class="c1"># self.nb_users = max(data, key=lambda x: x[0])[0] + 1</span>
        <span class="c1"># self.nb_items = max(data, key=lambda x: x[1])[1] + 1</span>

        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">dok_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_items</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_neg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_neg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_neg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_neg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">random_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_items</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">random_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_items</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_test_ratings</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">ratings</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">process_line</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_test_negs</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">negs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">process_line</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">negs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Utils">Utils<a class="anchor-link" href="#Utils"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>


<span class="k">class</span> <span class="nc">AverageMeter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes and stores the average and current value&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>


<span class="k">def</span> <span class="nf">count_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">()),</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;config_</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_file</span><span class="p">)</span>
        <span class="n">config_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">save_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">write_heading</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">write_heading</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Layers">Layers<a class="anchor-link" href="#Layers"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.nn.utils</span> <span class="kn">import</span> <span class="n">weight_norm</span>


<span class="k">class</span> <span class="nc">Chomp1d</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chomp_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Chomp1d</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chomp_size</span> <span class="o">=</span> <span class="n">chomp_size</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">chomp_size</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TemporalBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_inputs</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">dilation</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TemporalBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">weight_norm</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">n_inputs</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span>
                                           <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="n">dilation</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chomp1</span> <span class="o">=</span> <span class="n">Chomp1d</span><span class="p">(</span><span class="n">padding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">weight_norm</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">n_outputs</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span>
                                           <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="n">dilation</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chomp2</span> <span class="o">=</span> <span class="n">Chomp1d</span><span class="p">(</span><span class="n">padding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chomp1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chomp2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">n_inputs</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_inputs</span> <span class="o">!=</span> <span class="n">n_outputs</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="n">res</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TemporalConvNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_inputs</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TemporalConvNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_levels</span><span class="p">):</span>
            <span class="n">dilation_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">i</span>
            <span class="n">in_channels</span> <span class="o">=</span> <span class="n">num_inputs</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">num_channels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">out_channels</span> <span class="o">=</span> <span class="n">num_channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">TemporalBlock</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="n">dilation_size</span><span class="p">,</span>
                                     <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dilation_size</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="MPM-Model">MPM Model<a class="anchor-link" href="#MPM-Model"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">class</span> <span class="nc">Multi_Preference_Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_users</span><span class="p">,</span> <span class="n">nb_items</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="n">history_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Multi_Preference_Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nb_users</span> <span class="o">=</span> <span class="n">nb_users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_items</span> <span class="o">=</span> <span class="n">nb_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_size</span> <span class="o">=</span> <span class="n">history_size</span>

        <span class="c1">#user and item embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_embed</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>

        <span class="c1">#TCN</span>
        <span class="n">nhid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">num_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">nhid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">embed_dim</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcn</span> <span class="o">=</span> <span class="n">TemporalConvNet</span><span class="p">(</span><span class="n">num_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">num_channels</span><span class="o">=</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

        <span class="c1">#MLP</span>
        <span class="n">mlp_layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">]</span>
        <span class="n">nb_mlp_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlp_layer_sizes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb_mlp_layers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">mlp_layer_sizes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mlp_layer_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span>

        <span class="c1">#Output Module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">mlp_layer_sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span><span class="mi">128</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">golorot_uniform</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
            <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">in_features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">out_features</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.</span> <span class="o">/</span> <span class="p">(</span><span class="n">fan_in</span> <span class="o">+</span> <span class="n">fan_out</span><span class="p">))</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">limit</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">lecunn_uniform</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
            <span class="n">fan_in</span><span class="p">,</span> <span class="n">fan_out</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">in_features</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">out_features</span>  <span class="c1"># noqa: F841, E501</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.</span> <span class="o">/</span> <span class="n">fan_in</span><span class="p">)</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">limit</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">golorot_uniform</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="n">lecunn_uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_1</span><span class="p">)</span>
        <span class="n">lecunn_uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_2</span><span class="p">)</span>
        <span class="n">lecunn_uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_3</span><span class="p">)</span>
        <span class="n">lecunn_uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span><span class="n">sigmoid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embed</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1">#multi granularity preference module</span>
        <span class="n">xhistory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embed</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

        <span class="n">output_TCN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcn</span><span class="p">(</span><span class="n">xhistory</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">predict_vectors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_size</span><span class="p">):</span>
            <span class="n">preference</span> <span class="o">=</span> <span class="n">output_TCN</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">output_mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">preference</span><span class="p">,</span><span class="n">item</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">):</span>
                <span class="n">output_mlp</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">output_mlp</span><span class="p">)</span>
                <span class="n">output_mlp</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">output_mlp</span><span class="p">)</span>

            <span class="n">output_mlp</span> <span class="o">=</span> <span class="n">output_mlp</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">output_mlp</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">predict_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_mlp</span><span class="p">)</span>

        <span class="n">predict_vectors_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">predict_vectors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># general preference module</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_embed</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">xmlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">):</span>
            <span class="n">xmlp</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">xmlp</span><span class="p">)</span>
            <span class="n">xmlp</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">xmlp</span><span class="p">)</span>

        <span class="c1">#output module</span>
        <span class="n">xmlp</span> <span class="o">=</span> <span class="n">xmlp</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">xmlp</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">predict_vectors_sum</span><span class="p">,</span><span class="n">xmlp</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sigmoid</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training-and-Evaluation">Training and Evaluation<a class="anchor-link" href="#Training-and-Evaluation"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>

<span class="kn">from</span> <span class="nn">mlperf_compliance</span> <span class="kn">import</span> <span class="n">mlperf_log</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Train a Nerual Collaborative&quot;</span>
                                        <span class="s2">&quot; Filtering model&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--data&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;data/ml-1m&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to test and training data files&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;--epochs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of epochs for training&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--batch-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of examples for each iteration&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--negative-samples&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of negative examples per interaction&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--learning-rate&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;learning rate for optimizer&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="s1">&#39;--topk&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;rank for test examples to be considered a hit&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-cuda&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use available GPUs&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--seed&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;manually set random seed for torch&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--processes&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of processes for evaluating model&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--workers&#39;</span><span class="p">,</span> <span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of workers for training DataLoader&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--resume&#39;</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;resume from checkpoint&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">({})</span>


<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="p">[(</span><span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">],</span><span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">])</span>
               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)]</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">_history</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">proc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># outp, _ = model(proc(user), proc(item), proc(_history), sigmoid=True)</span>
        <span class="n">outp</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">proc</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="n">proc</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">proc</span><span class="p">(</span><span class="n">_history</span><span class="p">),</span> <span class="n">sigmoid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">outp</span> <span class="o">=</span> <span class="n">outp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">preds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">preds</span>


<span class="k">def</span> <span class="nf">_calculate_hit</span><span class="p">(</span><span class="n">ranked</span><span class="p">,</span> <span class="n">test_item</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_item</span> <span class="ow">in</span> <span class="n">ranked</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_calculate_ndcg</span><span class="p">(</span><span class="n">ranked</span><span class="p">,</span> <span class="n">test_item</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranked</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">test_item</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.</span>


<span class="k">def</span> <span class="nf">eval_one</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">rating</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">test_item</span> <span class="o">=</span> <span class="n">rating</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_item</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_history</span> <span class="o">=</span> <span class="n">rating</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)):</span>
        <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_history</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">)</span>

    <span class="n">map_item_score</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">pred</span> <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)}</span>
    <span class="n">ranked</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">map_item_score</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">map_item_score</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

    <span class="n">hit</span> <span class="o">=</span> <span class="n">_calculate_hit</span><span class="p">(</span><span class="n">ranked</span><span class="p">,</span> <span class="n">test_item</span><span class="p">)</span>
    <span class="n">ndcg</span> <span class="o">=</span> <span class="n">_calculate_ndcg</span><span class="p">(</span><span class="n">ranked</span><span class="p">,</span> <span class="n">test_item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hit</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">val_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">negs</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial evaluation&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">{}</span><span class="s2"> evaluation&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>

    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">EVAL_START</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span>
        <span class="n">_eval_one</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">eval_one</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">workers</span><span class="p">:</span>
            <span class="n">hits_ndcg_numpred</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">_eval_one</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">negs</span><span class="p">))</span>
        <span class="n">hits</span><span class="p">,</span> <span class="n">ndcgs</span><span class="p">,</span> <span class="n">num_preds</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">hits_ndcg_numpred</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hits</span><span class="p">,</span> <span class="n">ndcgs</span><span class="p">,</span> <span class="n">num_preds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rating</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">negs</span><span class="p">):</span>
            <span class="n">hit</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">num_pred</span> <span class="o">=</span> <span class="n">eval_one</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">)</span>
            <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
            <span class="n">ndcgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndcg</span><span class="p">)</span>
            <span class="n">num_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_pred</span><span class="p">)</span>

    <span class="n">hits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ndcgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndcgs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">num_preds</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">num_neg</span> <span class="o">=</span> <span class="n">num_preds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># one true positive, many negatives</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">EVAL_SIZE</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">num_neg</span><span class="p">)})</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">EVAL_HP_NUM_USERS</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">))</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">EVAL_HP_NUM_NEG</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">num_neg</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;hit_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;NDCG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcgs</span><span class="p">)</span>
        <span class="n">save_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hits</span><span class="p">,</span> <span class="n">ndcgs</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Note: The run start is in data_preprocess.py</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using seed = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Save configuration to file</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;local_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="s2">&quot;./run/MGPM/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">)),</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving config and results to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_dir</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">run_dir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>
    <span class="n">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">)</span>

    <span class="c1"># Check that GPUs are actually available</span>
    <span class="n">use_cuda</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_cuda</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using cuda ...&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using CPU ...&quot;</span><span class="p">)</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">best_hit</span><span class="p">,</span> <span class="n">best_ndcg</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
    <span class="n">start_epoch</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># start from epoch 0 or last checkpoint epoch</span>

    <span class="c1"># Load Data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading data&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">TRAIN_RATINGS_FILENAME</span><span class="p">))</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CFTrainDataset</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">TRAIN_RATINGS_FILENAME</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">DATA_SUMMARY_FILENAME</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">negative_samples</span><span class="p">)</span>

    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">INPUT_BATCH_SIZE</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">INPUT_ORDER</span><span class="p">)</span>  <span class="c1"># set shuffle=True in DataLoader</span>
    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">workers</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_ratings</span> <span class="o">=</span> <span class="n">load_test_ratings</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">TEST_RATINGS_FILENAME</span><span class="p">))</span>  <span class="c1"># noqa: E501</span>
    <span class="n">test_negs</span> <span class="o">=</span> <span class="n">load_test_negs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">TEST_NEG_FILENAME</span><span class="p">))</span>
    <span class="n">nb_users</span><span class="p">,</span> <span class="n">nb_items</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">nb_users</span><span class="p">,</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">nb_items</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Load data done [</span><span class="si">%.1f</span><span class="s1"> s]. #user=</span><span class="si">%d</span><span class="s1">, #item=</span><span class="si">%d</span><span class="s1">, #train=</span><span class="si">%d</span><span class="s1">, #test=</span><span class="si">%d</span><span class="s1">&#39;</span>
          <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="n">nb_users</span><span class="p">,</span> <span class="n">nb_items</span><span class="p">,</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">nnz</span><span class="p">,</span>
             <span class="nb">len</span><span class="p">(</span><span class="n">test_ratings</span><span class="p">)))</span>

    <span class="c1"># Create model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Multi_Preference_Model</span><span class="p">(</span><span class="n">nb_users</span><span class="o">=</span><span class="n">nb_users</span><span class="p">,</span> <span class="n">nb_items</span><span class="o">=</span><span class="n">nb_items</span><span class="p">,</span>
                      <span class="n">embed_dim</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">history_size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> parameters&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">)))</span>

    <span class="c1"># Save model text description</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s1">&#39;model.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>

    <span class="c1"># Add optimizer and loss to graph</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">OPT_LR</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
    <span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">,</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">,</span> <span class="mf">1e-8</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">OPT_NAME</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Adam&quot;</span><span class="p">)</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">OPT_HP_ADAM_BETA1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">beta1</span><span class="p">)</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">OPT_HP_ADAM_BETA2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">beta2</span><span class="p">)</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">OPT_HP_ADAM_EPSILON</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">),</span>
                                 <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>

    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">MODEL_HP_LOSS_FN</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">BCE</span><span class="p">)</span>
    <span class="c1"># optimizer = torch.optim.SGD(model.parameters(),lr=args.learning_rate,momentum=0.9)</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()</span>


    <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
        <span class="c1"># Move model and loss to GPU</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
        <span class="c1"># Load checkpoint.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==&gt; Resuming from checkpoint..&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">),</span> <span class="s1">&#39;Error: no checkpoint directory found!&#39;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./checkpoint/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.pd&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state_dict&#39;</span><span class="p">])</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">])</span>
        <span class="n">start_epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
        <span class="n">best_hit</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;hit&#39;</span><span class="p">]</span>
        <span class="n">best_ndcg</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;ndcg&#39;</span><span class="p">]</span>


    <span class="c1"># Create files for tracking training</span>
    <span class="n">valid_results_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s1">&#39;valid_results.csv&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate initial Hit Ratio and NDCG</span>
    <span class="k">if</span> <span class="n">start_epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hits</span><span class="p">,</span> <span class="n">ndcgs</span> <span class="o">=</span> <span class="n">val_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_ratings</span><span class="p">,</span> <span class="n">test_negs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span>
                                <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial HR@</span><span class="si">{K}</span><span class="s1"> = </span><span class="si">{hit_rate:.4f}</span><span class="s1">, NDCG@</span><span class="si">{K}</span><span class="s1"> = </span><span class="si">{ndcg:.4f}</span><span class="s1">&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span> <span class="n">hit_rate</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hits</span><span class="p">),</span> <span class="n">ndcg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcgs</span><span class="p">)))</span>

    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">TRAIN_LOOP</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_epoch</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
        <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">TRAIN_EPOCH</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">()</span>

        <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">INPUT_HP_NUM_NEG</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">nb_neg</span><span class="p">)</span>
        <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">INPUT_STEP_TRAIN_NEG_GEN</span><span class="p">)</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch_index</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loader</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

            <span class="c1"># outputs, _ = model(user, item,history)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">user</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="c1"># Save stats to file</span>
            <span class="n">description</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Epoch </span><span class="si">{}</span><span class="s1"> Loss </span><span class="si">{loss.val:.4f}</span><span class="s1"> (</span><span class="si">{loss.avg:.4f}</span><span class="s1">)&#39;</span>
                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">losses</span><span class="p">))</span>
            <span class="n">loader</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

        <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">hits</span><span class="p">,</span> <span class="n">ndcgs</span> <span class="o">=</span> <span class="n">val_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_ratings</span><span class="p">,</span> <span class="n">test_negs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span>
                                <span class="n">use_cuda</span><span class="o">=</span><span class="n">use_cuda</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">valid_results_file</span><span class="p">,</span>
                                <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>
        <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">EVAL_ACCURACY</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hits</span><span class="p">))})</span>
        <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">EVAL_STOP</span><span class="p">)</span>
        <span class="n">val_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch </span><span class="si">{epoch}</span><span class="s1">: HR@</span><span class="si">{K}</span><span class="s1"> = </span><span class="si">{hit_rate:.4f}</span><span class="s1">, NDCG@</span><span class="si">{K}</span><span class="s1"> = </span><span class="si">{ndcg:.4f}</span><span class="s1">,&#39;</span>
              <span class="s1">&#39; train_time = </span><span class="si">{train_time:.2f}</span><span class="s1">, val_time = </span><span class="si">{val_time:.2f}</span><span class="s1">&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span> <span class="n">hit_rate</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hits</span><span class="p">),</span>
                      <span class="n">ndcg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcgs</span><span class="p">),</span> <span class="n">train_time</span><span class="o">=</span><span class="n">train_time</span><span class="p">,</span>
                      <span class="n">val_time</span><span class="o">=</span><span class="n">val_time</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">best_hit</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcgs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">best_ndcg</span><span class="p">:</span>
            <span class="n">best_hit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
            <span class="n">best_ndcg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcgs</span><span class="p">)</span>
            <span class="c1"># Save checkpoint.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving checkpoint..&#39;</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
                <span class="s1">&#39;model_state_dict&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                <span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                <span class="s1">&#39;hit&#39;</span><span class="p">:</span><span class="n">best_hit</span><span class="p">,</span>
                <span class="s1">&#39;ndcg&#39;</span><span class="p">:</span><span class="n">best_ndcg</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;./checkpoint/&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_name</span><span class="p">()</span>  <span class="o">+</span> <span class="s1">&#39;.pd&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best hit: &quot;</span><span class="p">,</span><span class="n">best_hit</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best_ndcg: &quot;</span><span class="p">,</span> <span class="n">best_ndcg</span><span class="p">)</span>

    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">RUN_STOP</span><span class="p">)</span>
    <span class="n">mlperf_log</span><span class="o">.</span><span class="n">ncf_print</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">mlperf_log</span><span class="o">.</span><span class="n">RUN_FINAL</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using seed = 3
Saving config and results to ./run/MGPM/ml-1m/1640859555
Using CPU ...
Loading data
data/ml-1m/train_ratings.csv

:::MLPv0.5.0 ncf 1640859578.866290331 (&lt;ipython-input-13-9639997e32b4&gt;:19) input_step_train_neg_gen: 4

:::MLPv0.5.0 ncf 1640859578.917798042 (&lt;ipython-input-13-9639997e32b4&gt;:20) input_hp_sample_train_replacement

:::MLPv0.5.0 ncf 1640859578.947994947 (&lt;ipython-input-15-12fac4022899&gt;:192) input_batch_size: 2048

:::MLPv0.5.0 ncf 1640859578.977500916 (&lt;ipython-input-15-12fac4022899&gt;:193) input_order
Load data done [24.7 s]. #user=6040, #item=3706, #train=939809, #test=6040
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/usr/local/lib/python3.7/dist-packages/torch/utils/data/dataloader.py:481: UserWarning: This DataLoader will create 4 worker processes in total. Our suggested max number of worker in current system is 2, which is smaller than what this DataLoader is going to create. Please be aware that excessive worker creation might get DataLoader running slow or even freeze, lower the worker number to avoid potential slowness/freeze if necessary.
  cpuset_checked))
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Multi_Preference_Model(
  (user_embed): Embedding(6040, 32)
  (item_embed): Embedding(3706, 32)
  (tcn): TemporalConvNet(
    (network): Sequential(
      (0): TemporalBlock(
        (conv1): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(2,))
        (chomp1): Chomp1d()
        (relu1): ReLU()
        (dropout1): Dropout(p=0.25, inplace=False)
        (conv2): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(2,))
        (chomp2): Chomp1d()
        (relu2): ReLU()
        (dropout2): Dropout(p=0.25, inplace=False)
        (net): Sequential(
          (0): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(2,))
          (1): Chomp1d()
          (2): ReLU()
          (3): Dropout(p=0.25, inplace=False)
          (4): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(2,))
          (5): Chomp1d()
          (6): ReLU()
          (7): Dropout(p=0.25, inplace=False)
        )
        (relu): ReLU()
      )
      (1): TemporalBlock(
        (conv1): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(4,), dilation=(2,))
        (chomp1): Chomp1d()
        (relu1): ReLU()
        (dropout1): Dropout(p=0.25, inplace=False)
        (conv2): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(4,), dilation=(2,))
        (chomp2): Chomp1d()
        (relu2): ReLU()
        (dropout2): Dropout(p=0.25, inplace=False)
        (net): Sequential(
          (0): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(4,), dilation=(2,))
          (1): Chomp1d()
          (2): ReLU()
          (3): Dropout(p=0.25, inplace=False)
          (4): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(4,), dilation=(2,))
          (5): Chomp1d()
          (6): ReLU()
          (7): Dropout(p=0.25, inplace=False)
        )
        (relu): ReLU()
      )
      (2): TemporalBlock(
        (conv1): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(8,), dilation=(4,))
        (chomp1): Chomp1d()
        (relu1): ReLU()
        (dropout1): Dropout(p=0.25, inplace=False)
        (conv2): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(8,), dilation=(4,))
        (chomp2): Chomp1d()
        (relu2): ReLU()
        (dropout2): Dropout(p=0.25, inplace=False)
        (net): Sequential(
          (0): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(8,), dilation=(4,))
          (1): Chomp1d()
          (2): ReLU()
          (3): Dropout(p=0.25, inplace=False)
          (4): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(8,), dilation=(4,))
          (5): Chomp1d()
          (6): ReLU()
          (7): Dropout(p=0.25, inplace=False)
        )
        (relu): ReLU()
      )
      (3): TemporalBlock(
        (conv1): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(16,), dilation=(8,))
        (chomp1): Chomp1d()
        (relu1): ReLU()
        (dropout1): Dropout(p=0.25, inplace=False)
        (conv2): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(16,), dilation=(8,))
        (chomp2): Chomp1d()
        (relu2): ReLU()
        (dropout2): Dropout(p=0.25, inplace=False)
        (net): Sequential(
          (0): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(16,), dilation=(8,))
          (1): Chomp1d()
          (2): ReLU()
          (3): Dropout(p=0.25, inplace=False)
          (4): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(16,), dilation=(8,))
          (5): Chomp1d()
          (6): ReLU()
          (7): Dropout(p=0.25, inplace=False)
        )
        (relu): ReLU()
      )
      (4): TemporalBlock(
        (conv1): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(32,), dilation=(16,))
        (chomp1): Chomp1d()
        (relu1): ReLU()
        (dropout1): Dropout(p=0.25, inplace=False)
        (conv2): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(32,), dilation=(16,))
        (chomp2): Chomp1d()
        (relu2): ReLU()
        (dropout2): Dropout(p=0.25, inplace=False)
        (net): Sequential(
          (0): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(32,), dilation=(16,))
          (1): Chomp1d()
          (2): ReLU()
          (3): Dropout(p=0.25, inplace=False)
          (4): Conv1d(32, 32, kernel_size=(3,), stride=(1,), padding=(32,), dilation=(16,))
          (5): Chomp1d()
          (6): ReLU()
          (7): Dropout(p=0.25, inplace=False)
        )
        (relu): ReLU()
      )
    )
  )
  (mlp): ModuleList(
    (0): Linear(in_features=64, out_features=128, bias=True)
    (1): Linear(in_features=128, out_features=64, bias=True)
    (2): Linear(in_features=64, out_features=32, bias=True)
  )
  (output_1): Linear(in_features=320, out_features=128, bias=True)
  (output_2): Linear(in_features=128, out_features=64, bias=True)
  (output_3): Linear(in_features=64, out_features=32, bias=True)
  (output_4): Linear(in_features=32, out_features=1, bias=True)
)
413345 parameters

:::MLPv0.5.0 ncf 1640859579.342340708 (&lt;ipython-input-15-12fac4022899&gt;:215) opt_learning_rate: 0.001

:::MLPv0.5.0 ncf 1640859579.373433352 (&lt;ipython-input-15-12fac4022899&gt;:217) opt_name: &#34;Adam&#34;

:::MLPv0.5.0 ncf 1640859579.403172970 (&lt;ipython-input-15-12fac4022899&gt;:218) opt_hp_Adam_beta1: 0.9

:::MLPv0.5.0 ncf 1640859579.434629202 (&lt;ipython-input-15-12fac4022899&gt;:219) opt_hp_Adam_beta2: 0.999

:::MLPv0.5.0 ncf 1640859579.472294331 (&lt;ipython-input-15-12fac4022899&gt;:220) opt_hp_Adam_epsilon: 1e-08

:::MLPv0.5.0 ncf 1640859579.528450012 (&lt;ipython-input-15-12fac4022899&gt;:224) model_hp_loss_fn: &#34;binary_cross_entropy&#34;
Initial evaluation

:::MLPv0.5.0 ncf 1640859579.571680069 (&lt;ipython-input-15-12fac4022899&gt;:114) eval_start

:::MLPv0.5.0 ncf 1640859669.393068314 (&lt;ipython-input-15-12fac4022899&gt;:136) eval_size: {&#34;epoch&#34;: null, &#34;value&#34;: 604000}

:::MLPv0.5.0 ncf 1640859669.430445910 (&lt;ipython-input-15-12fac4022899&gt;:137) eval_hp_num_users: 6040

:::MLPv0.5.0 ncf 1640859669.471741915 (&lt;ipython-input-15-12fac4022899&gt;:138) eval_hp_num_neg: 99
Initial HR@10 = 0.1028, NDCG@10 = 0.0464

:::MLPv0.5.0 ncf 1640859669.506453514 (&lt;ipython-input-15-12fac4022899&gt;:256) train_loop

:::MLPv0.5.0 ncf 1640859669.539647579 (&lt;ipython-input-15-12fac4022899&gt;:258) train_epoch: 0

:::MLPv0.5.0 ncf 1640859669.571592093 (&lt;ipython-input-15-12fac4022899&gt;:262) input_hp_num_neg: 4

:::MLPv0.5.0 ncf 1640859669.601731777 (&lt;ipython-input-15-12fac4022899&gt;:263) input_step_train_neg_gen
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Epoch 0 Loss 0.2374 (0.2826): 100%|██████████| 2295/2295 [26:25&lt;00:00,  1.45it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 0 evaluation

:::MLPv0.5.0 ncf 1640861255.056983471 (&lt;ipython-input-15-12fac4022899&gt;:114) eval_start: 0
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
:::MLPv0.5.0 ncf 1640861349.036993027 (&lt;ipython-input-15-12fac4022899&gt;:136) eval_size: {&#34;epoch&#34;: 0, &#34;value&#34;: 610040}

:::MLPv0.5.0 ncf 1640861349.082477808 (&lt;ipython-input-15-12fac4022899&gt;:137) eval_hp_num_users: 6040

:::MLPv0.5.0 ncf 1640861349.121448755 (&lt;ipython-input-15-12fac4022899&gt;:138) eval_hp_num_neg: 100

:::MLPv0.5.0 ncf 1640861349.155122280 (&lt;ipython-input-15-12fac4022899&gt;:296) eval_accuracy: {&#34;epoch&#34;: 0, &#34;value&#34;: 0.7293046116828918}

:::MLPv0.5.0 ncf 1640861349.186644793 (&lt;ipython-input-15-12fac4022899&gt;:297) eval_stop
Epoch 0: HR@10 = 0.7293, NDCG@10 = 0.4740, train_time = 1585.40, val_time = 94.19
Saving checkpoint..

:::MLPv0.5.0 ncf 1640861349.240695238 (&lt;ipython-input-15-12fac4022899&gt;:258) train_epoch: 1

:::MLPv0.5.0 ncf 1640861349.282543659 (&lt;ipython-input-15-12fac4022899&gt;:262) input_hp_num_neg: 4

:::MLPv0.5.0 ncf 1640861349.318470001 (&lt;ipython-input-15-12fac4022899&gt;:263) input_step_train_neg_gen
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Epoch 1 Loss 0.1842 (0.2037): 100%|██████████| 2295/2295 [26:20&lt;00:00,  1.45it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 1 evaluation

:::MLPv0.5.0 ncf 1640862929.946528673 (&lt;ipython-input-15-12fac4022899&gt;:114) eval_start: 1
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
:::MLPv0.5.0 ncf 1640863025.670297623 (&lt;ipython-input-15-12fac4022899&gt;:136) eval_size: {&#34;epoch&#34;: 1, &#34;value&#34;: 616080}

:::MLPv0.5.0 ncf 1640863025.707294464 (&lt;ipython-input-15-12fac4022899&gt;:137) eval_hp_num_users: 6040

:::MLPv0.5.0 ncf 1640863025.745534420 (&lt;ipython-input-15-12fac4022899&gt;:138) eval_hp_num_neg: 101

:::MLPv0.5.0 ncf 1640863025.777830362 (&lt;ipython-input-15-12fac4022899&gt;:296) eval_accuracy: {&#34;epoch&#34;: 1, &#34;value&#34;: 0.7749999761581421}

:::MLPv0.5.0 ncf 1640863025.808667183 (&lt;ipython-input-15-12fac4022899&gt;:297) eval_stop
Epoch 1: HR@10 = 0.7750, NDCG@10 = 0.5323, train_time = 1580.58, val_time = 95.91
Saving checkpoint..

:::MLPv0.5.0 ncf 1640863025.864041567 (&lt;ipython-input-15-12fac4022899&gt;:258) train_epoch: 2

:::MLPv0.5.0 ncf 1640863025.894696951 (&lt;ipython-input-15-12fac4022899&gt;:262) input_hp_num_neg: 4

:::MLPv0.5.0 ncf 1640863025.925774336 (&lt;ipython-input-15-12fac4022899&gt;:263) input_step_train_neg_gen
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Epoch 2 Loss 0.1913 (0.1822): 100%|██████████| 2295/2295 [26:58&lt;00:00,  1.42it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 2 evaluation

:::MLPv0.5.0 ncf 1640864644.619865417 (&lt;ipython-input-15-12fac4022899&gt;:114) eval_start: 2
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
:::MLPv0.5.0 ncf 1640864747.343717098 (&lt;ipython-input-15-12fac4022899&gt;:136) eval_size: {&#34;epoch&#34;: 2, &#34;value&#34;: 622120}

:::MLPv0.5.0 ncf 1640864747.386755466 (&lt;ipython-input-15-12fac4022899&gt;:137) eval_hp_num_users: 6040

:::MLPv0.5.0 ncf 1640864747.428090811 (&lt;ipython-input-15-12fac4022899&gt;:138) eval_hp_num_neg: 102

:::MLPv0.5.0 ncf 1640864747.462394714 (&lt;ipython-input-15-12fac4022899&gt;:296) eval_accuracy: {&#34;epoch&#34;: 2, &#34;value&#34;: 0.7903973460197449}

:::MLPv0.5.0 ncf 1640864747.506796598 (&lt;ipython-input-15-12fac4022899&gt;:297) eval_stop
Epoch 2: HR@10 = 0.7904, NDCG@10 = 0.5532, train_time = 1618.65, val_time = 102.93
Saving checkpoint..

:::MLPv0.5.0 ncf 1640864747.572065830 (&lt;ipython-input-15-12fac4022899&gt;:258) train_epoch: 3

:::MLPv0.5.0 ncf 1640864747.607133150 (&lt;ipython-input-15-12fac4022899&gt;:262) input_hp_num_neg: 4

:::MLPv0.5.0 ncf 1640864747.644344091 (&lt;ipython-input-15-12fac4022899&gt;:263) input_step_train_neg_gen
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Epoch 3 Loss 0.1644 (0.1707): 100%|██████████| 2295/2295 [27:37&lt;00:00,  1.38it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 3 evaluation

:::MLPv0.5.0 ncf 1640866405.631515026 (&lt;ipython-input-15-12fac4022899&gt;:114) eval_start: 3
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
:::MLPv0.5.0 ncf 1640866518.570442915 (&lt;ipython-input-15-12fac4022899&gt;:136) eval_size: {&#34;epoch&#34;: 3, &#34;value&#34;: 628160}

:::MLPv0.5.0 ncf 1640866518.605526447 (&lt;ipython-input-15-12fac4022899&gt;:137) eval_hp_num_users: 6040

:::MLPv0.5.0 ncf 1640866518.641601324 (&lt;ipython-input-15-12fac4022899&gt;:138) eval_hp_num_neg: 103

:::MLPv0.5.0 ncf 1640866518.670853138 (&lt;ipython-input-15-12fac4022899&gt;:296) eval_accuracy: {&#34;epoch&#34;: 3, &#34;value&#34;: 0.7995033264160156}

:::MLPv0.5.0 ncf 1640866518.699945927 (&lt;ipython-input-15-12fac4022899&gt;:297) eval_stop
Epoch 3: HR@10 = 0.7995, NDCG@10 = 0.5674, train_time = 1657.94, val_time = 113.12
Saving checkpoint..

:::MLPv0.5.0 ncf 1640866518.759350777 (&lt;ipython-input-15-12fac4022899&gt;:258) train_epoch: 4

:::MLPv0.5.0 ncf 1640866518.789437532 (&lt;ipython-input-15-12fac4022899&gt;:262) input_hp_num_neg: 4

:::MLPv0.5.0 ncf 1640866518.818580627 (&lt;ipython-input-15-12fac4022899&gt;:263) input_step_train_neg_gen
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Epoch 4 Loss 0.1665 (0.1631): 100%|██████████| 2295/2295 [28:24&lt;00:00,  1.35it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 4 evaluation

:::MLPv0.5.0 ncf 1640868223.097388268 (&lt;ipython-input-15-12fac4022899&gt;:114) eval_start: 4
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
:::MLPv0.5.0 ncf 1640868339.778037786 (&lt;ipython-input-15-12fac4022899&gt;:136) eval_size: {&#34;epoch&#34;: 4, &#34;value&#34;: 634200}

:::MLPv0.5.0 ncf 1640868339.817111492 (&lt;ipython-input-15-12fac4022899&gt;:137) eval_hp_num_users: 6040

:::MLPv0.5.0 ncf 1640868339.855721712 (&lt;ipython-input-15-12fac4022899&gt;:138) eval_hp_num_neg: 104

:::MLPv0.5.0 ncf 1640868339.887498140 (&lt;ipython-input-15-12fac4022899&gt;:296) eval_accuracy: {&#34;epoch&#34;: 4, &#34;value&#34;: 0.8074503540992737}

:::MLPv0.5.0 ncf 1640868339.916709185 (&lt;ipython-input-15-12fac4022899&gt;:297) eval_stop
Epoch 4: HR@10 = 0.8075, NDCG@10 = 0.5802, train_time = 1704.22, val_time = 116.87
Saving checkpoint..

:::MLPv0.5.0 ncf 1640868339.975879908 (&lt;ipython-input-15-12fac4022899&gt;:258) train_epoch: 5

:::MLPv0.5.0 ncf 1640868340.008387327 (&lt;ipython-input-15-12fac4022899&gt;:262) input_hp_num_neg: 4

:::MLPv0.5.0 ncf 1640868340.038704634 (&lt;ipython-input-15-12fac4022899&gt;:263) input_step_train_neg_gen
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Epoch 5 Loss 0.1519 (0.1573): 100%|██████████| 2295/2295 [28:54&lt;00:00,  1.32it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 5 evaluation

:::MLPv0.5.0 ncf 1640870074.719893694 (&lt;ipython-input-15-12fac4022899&gt;:114) eval_start: 5
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
:::MLPv0.5.0 ncf 1640870197.294473886 (&lt;ipython-input-15-12fac4022899&gt;:136) eval_size: {&#34;epoch&#34;: 5, &#34;value&#34;: 640240}

:::MLPv0.5.0 ncf 1640870197.326944113 (&lt;ipython-input-15-12fac4022899&gt;:137) eval_hp_num_users: 6040

:::MLPv0.5.0 ncf 1640870197.360785246 (&lt;ipython-input-15-12fac4022899&gt;:138) eval_hp_num_neg: 105

:::MLPv0.5.0 ncf 1640870197.388211012 (&lt;ipython-input-15-12fac4022899&gt;:296) eval_accuracy: {&#34;epoch&#34;: 5, &#34;value&#34;: 0.810927152633667}

:::MLPv0.5.0 ncf 1640870197.414030552 (&lt;ipython-input-15-12fac4022899&gt;:297) eval_stop
Epoch 5: HR@10 = 0.8109, NDCG@10 = 0.5857, train_time = 1734.64, val_time = 122.74
Saving checkpoint..

:::MLPv0.5.0 ncf 1640870197.469210863 (&lt;ipython-input-15-12fac4022899&gt;:258) train_epoch: 6

:::MLPv0.5.0 ncf 1640870197.495621204 (&lt;ipython-input-15-12fac4022899&gt;:262) input_hp_num_neg: 4

:::MLPv0.5.0 ncf 1640870197.527369499 (&lt;ipython-input-15-12fac4022899&gt;:263) input_step_train_neg_gen
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Epoch 6 Loss 0.1276 (0.1526): 100%|██████████| 2295/2295 [29:29&lt;00:00,  1.30it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 6 evaluation

:::MLPv0.5.0 ncf 1640871966.699860334 (&lt;ipython-input-15-12fac4022899&gt;:114) eval_start: 6
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
:::MLPv0.5.0 ncf 1640872091.283187628 (&lt;ipython-input-15-12fac4022899&gt;:136) eval_size: {&#34;epoch&#34;: 6, &#34;value&#34;: 646280}

:::MLPv0.5.0 ncf 1640872091.319001198 (&lt;ipython-input-15-12fac4022899&gt;:137) eval_hp_num_users: 6040

:::MLPv0.5.0 ncf 1640872091.352862120 (&lt;ipython-input-15-12fac4022899&gt;:138) eval_hp_num_neg: 106

:::MLPv0.5.0 ncf 1640872091.382253408 (&lt;ipython-input-15-12fac4022899&gt;:296) eval_accuracy: {&#34;epoch&#34;: 6, &#34;value&#34;: 0.8145695328712463}

:::MLPv0.5.0 ncf 1640872091.409046412 (&lt;ipython-input-15-12fac4022899&gt;:297) eval_stop
Epoch 6: HR@10 = 0.8146, NDCG@10 = 0.5908, train_time = 1769.05, val_time = 124.83
Saving checkpoint..

:::MLPv0.5.0 ncf 1640872091.464409828 (&lt;ipython-input-15-12fac4022899&gt;:258) train_epoch: 7

:::MLPv0.5.0 ncf 1640872091.491896629 (&lt;ipython-input-15-12fac4022899&gt;:262) input_hp_num_neg: 4

:::MLPv0.5.0 ncf 1640872091.518489122 (&lt;ipython-input-15-12fac4022899&gt;:263) input_step_train_neg_gen
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Epoch 7 Loss 0.1427 (0.1453):   3%|▎         | 78/2295 [01:03&lt;28:48,  1.28it/s]</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/2022/01/14/mpm.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
