<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Matrix Factorization based Movie Recommender built in PyTorch | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Matrix Factorization based Movie Recommender built in PyTorch" />
<meta name="author" content="<a href='https://github.com/EthanRosenthal/torchmf'>Ethan Rosenthal</a>" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Simple PyTorch based Matrix Factorization models on movielens-100k dataset - implicit, explicit and hogwild variant" />
<meta property="og:description" content="Simple PyTorch based Matrix Factorization models on movielens-100k dataset - implicit, explicit and hogwild variant" />
<link rel="canonical" href="https://nb.recohut.com/pytorch/movie/mf/factorization/2021/07/05/mf-movielens-pytorch.html" />
<meta property="og:url" content="https://nb.recohut.com/pytorch/movie/mf/factorization/2021/07/05/mf-movielens-pytorch.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-05T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Matrix Factorization based Movie Recommender built in PyTorch" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"<a href='https://github.com/EthanRosenthal/torchmf'>Ethan Rosenthal</a>"},"dateModified":"2021-07-05T00:00:00-05:00","datePublished":"2021-07-05T00:00:00-05:00","description":"Simple PyTorch based Matrix Factorization models on movielens-100k dataset - implicit, explicit and hogwild variant","headline":"Matrix Factorization based Movie Recommender built in PyTorch","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/pytorch/movie/mf/factorization/2021/07/05/mf-movielens-pytorch.html"},"url":"https://nb.recohut.com/pytorch/movie/mf/factorization/2021/07/05/mf-movielens-pytorch.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Matrix Factorization based Movie Recommender built in PyTorch</h1><p class="page-description">Simple PyTorch based Matrix Factorization models on movielens-100k dataset - implicit, explicit and hogwild variant</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-07-05T00:00:00-05:00" itemprop="datePublished">
        Jul 5, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name"><a href='https://github.com/EthanRosenthal/torchmf'>Ethan Rosenthal</a></span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      16 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#PyTorch">PyTorch</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#Movie">Movie</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#MF">MF</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#Factorization">Factorization</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2021-07-05-mf-movielens-pytorch.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2021-07-05-mf-movielens-pytorch.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2021-07-05-mf-movielens-pytorch.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2021-07-05-mf-movielens-pytorch.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#utils.py">utils.py </a></li>
<li class="toc-entry toc-h2"><a href="#metrics.py">metrics.py </a></li>
<li class="toc-entry toc-h2"><a href="#torchmf.py">torchmf.py </a></li>
<li class="toc-entry toc-h2"><a href="#run.py">run.py </a></li>
<li class="toc-entry toc-h2"><a href="#explicit-run">explicit run </a></li>
<li class="toc-entry toc-h2"><a href="#implicit">implicit </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-07-05-mf-movielens-pytorch.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="utils.py">
<a class="anchor" href="#utils.py" aria-hidden="true"><span class="octicon octicon-link"></span></a>utils.py<a class="anchor-link" href="#utils.py"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="o">%%</span><span class="n">writefile</span> <span class="n">utils</span><span class="o">.</span><span class="n">py</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>

<span class="sd">"""</span>
<span class="sd">Shamelessly stolen from</span>
<span class="sd">https://github.com/maciejkula/triplet_recommendations_keras</span>
<span class="sd">"""</span>


<span class="k">def</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">interactions</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Split an interactions matrix into training and test sets.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interactions : np.ndarray</span>
<span class="sd">    n : int (default=10)</span>
<span class="sd">        Number of items to select / row to place into test.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    train : np.ndarray</span>
<span class="sd">    test : np.ndarray</span>
<span class="sd">    """</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">interactions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">interactions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">interactions</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">test_interactions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">interactions</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                                                 <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">train</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">test_interactions</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">test</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">test_interactions</span><span class="p">]</span> <span class="o">=</span> <span class="n">interactions</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">test_interactions</span><span class="p">]</span>

    <span class="c1"># Test and training are truly disjoint</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">train</span> <span class="o">*</span> <span class="n">test</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>


<span class="k">def</span> <span class="nf">_get_data_path</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    Get path to the movielens dataset file.</span>
<span class="sd">    """</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span>
                        <span class="s1">'data'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Making data path'</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_path</span>


<span class="k">def</span> <span class="nf">_download_movielens</span><span class="p">(</span><span class="n">dest_path</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Download the dataset.</span>
<span class="sd">    """</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://files.grouplens.org/datasets/movielens/ml-100k.zip'</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'Downloading MovieLens data'</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="s1">'ml-100k.zip'</span><span class="p">),</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="s1">'ml-100k.zip'</span><span class="p">),</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
        <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_movielens_df</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">_get_data_path</span><span class="p">()</span>
    <span class="n">zipfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">'ml-100k.zip'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">zipfile</span><span class="p">):</span>
        <span class="n">_download_movielens</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">'ml-100k'</span><span class="p">,</span> <span class="s1">'u.data'</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'item_id'</span><span class="p">,</span> <span class="s1">'rating'</span><span class="p">,</span> <span class="s1">'timestamp'</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">get_movielens_interactions</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">read_movielens_df</span><span class="p">()</span>

    <span class="n">n_users</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_items</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">item_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">interactions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">interactions</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">interactions</span>


<span class="k">def</span> <span class="nf">get_movielens_train_test_split</span><span class="p">(</span><span class="n">implicit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">interactions</span> <span class="o">=</span> <span class="n">get_movielens_interactions</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">implicit</span><span class="p">:</span>
        <span class="n">interactions</span> <span class="o">=</span> <span class="p">(</span><span class="n">interactions</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">interactions</span><span class="p">)</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Writing utils.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="metrics.py">
<a class="anchor" href="#metrics.py" aria-hidden="true"><span class="octicon octicon-link"></span></a>metrics.py<a class="anchor-link" href="#metrics.py"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="o">%%</span><span class="n">writefile</span> <span class="n">metrics</span><span class="o">.</span><span class="n">py</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="nn">torch</span>


<span class="k">def</span> <span class="nf">get_row_indices</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">interactions</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">interactions</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">auc</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">interactions</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">aucs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_users</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mp_batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_users</span> <span class="o">/</span> <span class="n">num_workers</span><span class="p">))</span>

    <span class="n">queue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_users</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_workers</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">*</span> <span class="n">mp_batch</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">start</span> <span class="o">+</span> <span class="n">mp_batch</span><span class="p">,</span>  <span class="n">n_users</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">batch_auc</span><span class="p">,</span>
                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">rows</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">interactions</span><span class="p">,</span> <span class="n">model</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">is_alive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">is_alive</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_alive</span> <span class="ow">and</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">break</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">aucs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

    <span class="n">queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aucs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">batch_auc</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">interactions</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">n_items</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_items</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">users_init</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_items</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">users_init</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
        <span class="n">actuals</span> <span class="o">=</span> <span class="n">get_row_indices</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">interactions</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actuals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_items</span><span class="p">)</span>
        <span class="n">y_test</span><span class="p">[</span><span class="n">actuals</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">preds</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>


<span class="k">def</span> <span class="nf">patk</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">interactions</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">patks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_users</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mp_batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_users</span> <span class="o">/</span> <span class="n">num_workers</span><span class="p">))</span>

    <span class="n">queue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_users</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_workers</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">*</span> <span class="n">mp_batch</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">start</span> <span class="o">+</span> <span class="n">mp_batch</span><span class="p">,</span> <span class="n">n_users</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">batch_patk</span><span class="p">,</span>
                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">rows</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">interactions</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span>
                       <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'k'</span><span class="p">:</span> <span class="n">k</span><span class="p">})</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">is_alive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">is_alive</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_alive</span> <span class="ow">and</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">break</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">patks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

    <span class="n">queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">patks</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">batch_patk</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">interactions</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">n_items</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_items</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">users_init</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_items</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">users_init</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
        <span class="n">actuals</span> <span class="o">=</span> <span class="n">get_row_indices</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">interactions</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actuals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">top_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">top_k</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">top_k</span><span class="p">[:</span><span class="n">k</span><span class="p">])</span>
        <span class="n">true_pids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">actuals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">true_pids</span><span class="p">:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_k</span> <span class="o">&amp;</span> <span class="n">true_pids</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Writing metrics.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="torchmf.py">
<a class="anchor" href="#torchmf.py" aria-hidden="true"><span class="octicon octicon-link"></span></a>torchmf.py<a class="anchor-link" href="#torchmf.py"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="o">%%</span><span class="n">writefile</span> <span class="n">torchmf</span><span class="o">.</span><span class="n">py</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span> <span class="k">as</span> <span class="nn">data</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">metrics</span>


<span class="c1"># Models</span>
<span class="c1"># Interactions Dataset =&gt; Singular Iter =&gt; Singular Loss</span>
<span class="c1"># Pairwise Datasets =&gt; Pairwise Iter =&gt; Pairwise Loss</span>
<span class="c1"># Pairwise Iters</span>
<span class="c1"># Loss Functions</span>
<span class="c1"># Optimizers</span>
<span class="c1"># Metric callbacks</span>

<span class="c1"># Serve up users, items (and items could be pos_items, neg_items)</span>
<span class="c1"># In this case, the iteration remains the same. Pass both items into a model</span>
<span class="c1"># which is a concat of the base model. it handles the pos and neg_items</span>
<span class="c1"># accordingly. define the loss after.</span>


<span class="k">class</span> <span class="nc">Interactions</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Hold data in the form of an interactions matrix.</span>
<span class="sd">    Typical use-case is like a ratings matrix:</span>
<span class="sd">    - Users are the rows</span>
<span class="sd">    - Items are the columns</span>
<span class="sd">    - Elements of the matrix are the ratings given by a user for an item.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">nnz</span>


<span class="k">class</span> <span class="nc">PairwiseInteractions</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Sample data from an interactions matrix in a pairwise fashion. The row is</span>
<span class="sd">    treated as the main dimension, and the columns are sampled pairwise.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mat_csr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_csr</span><span class="o">.</span><span class="n">has_sorted_indices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat_csr</span><span class="o">.</span><span class="n">sort_indices</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">neg_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_rated</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">neg_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_csr</span><span class="o">.</span><span class="n">indptr</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">mat_csr</span><span class="o">.</span><span class="n">indices</span><span class="p">):</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">pos_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="n">pos_col</span><span class="p">,</span> <span class="n">neg_col</span><span class="p">)),</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">nnz</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">not_rated</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">indptr</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="c1"># similar to use of bsearch in lightfm</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">indptr</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">indptr</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">searched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span> <span class="s1">'right'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">searched</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">):</span>
            <span class="c1"># After the array</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">indices</span><span class="p">[</span><span class="n">searched</span><span class="p">]</span>  <span class="c1"># Not found</span>

    <span class="k">def</span> <span class="nf">get_row_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_csr</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_csr</span><span class="o">.</span><span class="n">indptr</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_csr</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">BaseModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Base module for explicit matrix factorization.</span>
<span class="sd">    """</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">n_users</span><span class="p">,</span>
                 <span class="n">n_items</span><span class="p">,</span>
                 <span class="n">n_factors</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                 <span class="n">dropout_p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_users : int</span>
<span class="sd">            Number of users</span>
<span class="sd">        n_items : int</span>
<span class="sd">            Number of items</span>
<span class="sd">        n_factors : int</span>
<span class="sd">            Number of latent factors (or embeddings or whatever you want to</span>
<span class="sd">            call it).</span>
<span class="sd">        dropout_p : float</span>
<span class="sd">            p in nn.Dropout module. Probability of dropout.</span>
<span class="sd">        sparse : bool</span>
<span class="sd">            Whether or not to treat embeddings as sparse. NOTE: cannot use</span>
<span class="sd">            weight decay on the optimizer if sparse=True. Also, can only use</span>
<span class="sd">            Adagrad.</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span> <span class="o">=</span> <span class="n">n_users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="n">n_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span> <span class="o">=</span> <span class="n">n_factors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_biases</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">n_users</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_biases</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">n_items</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_embeddings</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">n_users</span><span class="p">,</span> <span class="n">n_factors</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_embeddings</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">n_items</span><span class="p">,</span> <span class="n">n_factors</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span> <span class="o">=</span> <span class="n">dropout_p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sparse</span> <span class="o">=</span> <span class="n">sparse</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Forward pass through the model. For a single user and item, this</span>
<span class="sd">        looks like:</span>

<span class="sd">        user_bias + item_bias + user_embeddings.dot(item_embeddings)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        users : np.ndarray</span>
<span class="sd">            Array of user indices</span>
<span class="sd">        items : np.ndarray</span>
<span class="sd">            Array of item indices</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        preds : np.ndarray</span>
<span class="sd">            Predicted ratings.</span>

<span class="sd">        """</span>
        <span class="n">ues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_embeddings</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
        <span class="n">uis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embeddings</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

        <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_biases</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_biases</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">ues</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">uis</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">preds</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bpr_loss</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sig</span><span class="p">(</span><span class="n">preds</span><span class="p">))</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">BPRModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">n_users</span><span class="p">,</span>
                 <span class="n">n_items</span><span class="p">,</span>
                 <span class="n">n_factors</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                 <span class="n">dropout_p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">model</span><span class="o">=</span><span class="n">BaseModule</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BPRModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span> <span class="o">=</span> <span class="n">n_users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="n">n_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span> <span class="o">=</span> <span class="n">n_factors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span> <span class="o">=</span> <span class="n">dropout_p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse</span> <span class="o">=</span> <span class="n">sparse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_model</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span>
            <span class="n">n_factors</span><span class="o">=</span><span class="n">n_factors</span><span class="p">,</span>
            <span class="n">dropout_p</span><span class="o">=</span><span class="n">dropout_p</span><span class="p">,</span>
            <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> \
            <span class="s1">'Must pass in items as (pos_items, neg_items)'</span>
        <span class="c1"># Unpack</span>
        <span class="p">(</span><span class="n">pos_items</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">)</span> <span class="o">=</span> <span class="n">items</span>
        <span class="n">pos_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_model</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">pos_items</span><span class="p">)</span>
        <span class="n">neg_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_model</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">neg_items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pos_preds</span> <span class="o">-</span> <span class="n">neg_preds</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_model</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BasePipeline</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Class defining a training pipeline. Instantiates data loaders, model,</span>
<span class="sd">    and optimizer. Handles training for multiple epochs and keeping track of</span>
<span class="sd">    train and test loss.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">train</span><span class="p">,</span>
                 <span class="n">test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">model</span><span class="o">=</span><span class="n">BaseModule</span><span class="p">,</span>
                 <span class="n">n_factors</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                 <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                 <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="n">optimizer</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span>
                 <span class="n">loss_function</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">'sum'</span><span class="p">),</span>
                 <span class="n">n_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">interaction_class</span><span class="o">=</span><span class="n">Interactions</span><span class="p">,</span>
                 <span class="n">hogwild</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">eval_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span>

        <span class="k">if</span> <span class="n">hogwild</span><span class="p">:</span>
            <span class="n">num_loader_workers</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_loader_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">interaction_class</span><span class="p">(</span><span class="n">train</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_loader_workers</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">interaction_class</span><span class="p">(</span><span class="n">test</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="n">num_loader_workers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span> <span class="o">=</span> <span class="n">n_factors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span> <span class="o">=</span> <span class="n">dropout_p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span> <span class="o">=</span> <span class="n">weight_decay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="n">loss_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_epochs</span> <span class="o">=</span> <span class="n">n_epochs</span>
        <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">weight_decay</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_users</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span>
                           <span class="n">n_factors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span><span class="p">,</span>
                           <span class="n">dropout_p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">,</span>
                           <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                                   <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span>
                                   <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hogwild</span> <span class="o">=</span> <span class="n">hogwild</span>
        <span class="k">if</span> <span class="n">random_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hogwild</span><span class="p">:</span>
                <span class="n">random_seed</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eval_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eval_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_metrics</span> <span class="o">=</span> <span class="n">eval_metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>

    <span class="k">def</span> <span class="nf">break_grads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="c1"># Break gradient sharing</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hogwild</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">share_memory</span><span class="p">()</span>
                <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">train_losses</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">queue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_epoch</span><span class="p">,</span>
                                   <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'epoch'</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
                                           <span class="s1">'queue'</span><span class="p">:</span> <span class="n">queue</span><span class="p">})</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">is_alive</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                            <span class="n">is_alive</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_alive</span> <span class="ow">and</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                        <span class="k">break</span>

                    <span class="k">while</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                        <span class="n">train_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">train_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">train_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">[</span><span class="s1">'train'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="s1">'Epoch: </span><span class="si">{0:^3}</span><span class="s1">  train: </span><span class="si">{1:^10.5f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">[</span><span class="s1">'train'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">[</span><span class="s1">'test'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_validation_loss</span><span class="p">())</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="s1">'val: </span><span class="si">{0:^10.5f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">[</span><span class="s1">'test'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_metrics</span><span class="p">:</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mat_csr</span><span class="p">,</span>
                               <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">[</span><span class="s1">'eval-</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="s1">'eval-</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1:^10.5f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">[</span><span class="s1">'epoch'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fit_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hogwild</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">break_grads</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="p">),</span>
                    <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="p">),</span>
                    <span class="n">desc</span><span class="o">=</span><span class="s1">'(</span><span class="si">{0:^3}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">((</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
            <span class="c1"># TODO: turn this into a collate_fn like the data_loader</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">col</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">long</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

            <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">batch_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">train_loss</span><span class="o">=</span><span class="n">batch_loss</span><span class="p">)</span>
        <span class="n">total_loss</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">nnz</span>
        <span class="k">if</span> <span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">total_loss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_loss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_validation_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">((</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">col</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">long</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

            <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">total_loss</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">nnz</span>
        <span class="k">return</span> <span class="n">total_loss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Writing torchmf.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="run.py">
<a class="anchor" href="#run.py" aria-hidden="true"><span class="octicon octicon-link"></span></a>run.py<a class="anchor-link" href="#run.py"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="o">%%</span><span class="n">writefile</span> <span class="n">run</span><span class="o">.</span><span class="n">py</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">torchmf</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BaseModule</span><span class="p">,</span> <span class="n">BPRModule</span><span class="p">,</span> <span class="n">BasePipeline</span><span class="p">,</span>
                     <span class="n">bpr_loss</span><span class="p">,</span> <span class="n">PairwiseInteractions</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">utils</span>


<span class="k">def</span> <span class="nf">explicit</span><span class="p">():</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_movielens_train_test_split</span><span class="p">()</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">BasePipeline</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">BaseModule</span><span class="p">,</span>
                            <span class="n">n_factors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                            <span class="n">lr</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                            <span class="n">optimizer</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">2017</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">implicit</span><span class="p">():</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_movielens_train_test_split</span><span class="p">(</span><span class="n">implicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">BasePipeline</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                           <span class="n">n_factors</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">lr</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">optimizer</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                           <span class="n">random_seed</span><span class="o">=</span><span class="mi">2017</span><span class="p">,</span> <span class="n">loss_function</span><span class="o">=</span><span class="n">bpr_loss</span><span class="p">,</span>
                           <span class="n">model</span><span class="o">=</span><span class="n">BPRModule</span><span class="p">,</span>
                           <span class="n">interaction_class</span><span class="o">=</span><span class="n">PairwiseInteractions</span><span class="p">,</span>
                           <span class="n">eval_metrics</span><span class="o">=</span><span class="p">(</span><span class="s1">'auc'</span><span class="p">,</span> <span class="s1">'patk'</span><span class="p">))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">hogwild</span><span class="p">():</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_movielens_train_test_split</span><span class="p">(</span><span class="n">implicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">BasePipeline</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="n">n_factors</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">lr</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">optimizer</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                            <span class="n">random_seed</span><span class="o">=</span><span class="mi">2017</span><span class="p">,</span> <span class="n">loss_function</span><span class="o">=</span><span class="n">bpr_loss</span><span class="p">,</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">BPRModule</span><span class="p">,</span> <span class="n">hogwild</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">interaction_class</span><span class="o">=</span><span class="n">PairwiseInteractions</span><span class="p">,</span>
                            <span class="n">eval_metrics</span><span class="o">=</span><span class="p">(</span><span class="s1">'auc'</span><span class="p">,</span> <span class="s1">'patk'</span><span class="p">))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">'torchmf'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--example'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'explicit, implicit, or hogwild'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">example</span> <span class="o">==</span> <span class="s1">'explicit'</span><span class="p">:</span>
        <span class="n">explicit</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">example</span> <span class="o">==</span> <span class="s1">'implicit'</span><span class="p">:</span>
        <span class="n">implicit</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">example</span> <span class="o">==</span> <span class="s1">'hogwild'</span><span class="p">:</span>
        <span class="n">hogwild</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'example must be explicit, implicit, or hogwild'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Writing run.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="explicit-run">
<a class="anchor" href="#explicit-run" aria-hidden="true"><span class="octicon octicon-link"></span></a>explicit run<a class="anchor-link" href="#explicit-run"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">python</span> <span class="n">run</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">example</span> <span class="n">explicit</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Downloading MovieLens data
( 1 ): 100% 89/89 [00:01&lt;00:00, 71.00it/s, train_loss=8.19]
Epoch:  1   train:  14.64144 val:  8.70737  
( 2 ): 100% 89/89 [00:00&lt;00:00, 97.51it/s, train_loss=3.03]
Epoch:  2   train:  4.25602  val:  4.06002  
( 3 ): 100% 89/89 [00:00&lt;00:00, 96.01it/s, train_loss=1.47]
Epoch:  3   train:  1.90983  val:  2.49680  
( 4 ): 100% 89/89 [00:00&lt;00:00, 96.26it/s, train_loss=1.11]
Epoch:  4   train:  1.24095  val:  1.85090  
( 5 ): 100% 89/89 [00:00&lt;00:00, 94.35it/s, train_loss=0.972]
Epoch:  5   train:  0.99838  val:  1.54036  
( 6 ): 100% 89/89 [00:00&lt;00:00, 93.74it/s, train_loss=0.936]
Epoch:  6   train:  0.89663  val:  1.36695  
( 7 ): 100% 89/89 [00:00&lt;00:00, 96.31it/s, train_loss=0.906]
Epoch:  7   train:  0.84003  val:  1.26457  
( 8 ): 100% 89/89 [00:00&lt;00:00, 95.79it/s, train_loss=0.864]
Epoch:  8   train:  0.80580  val:  1.19734  
( 9 ): 100% 89/89 [00:00&lt;00:00, 97.95it/s, train_loss=0.809]
Epoch:  9   train:  0.77795  val:  1.15100  
(10 ): 100% 89/89 [00:00&lt;00:00, 97.03it/s, train_loss=0.805]
Epoch: 10   train:  0.75526  val:  1.11836  
(11 ): 100% 89/89 [00:00&lt;00:00, 94.96it/s, train_loss=0.762]
Epoch: 11   train:  0.73437  val:  1.09048  
(12 ): 100% 89/89 [00:00&lt;00:00, 97.37it/s, train_loss=0.717]
Epoch: 12   train:  0.71592  val:  1.07447  
(13 ): 100% 89/89 [00:00&lt;00:00, 96.82it/s, train_loss=0.721]
Epoch: 13   train:  0.70062  val:  1.05621  
(14 ): 100% 89/89 [00:00&lt;00:00, 97.52it/s, train_loss=0.672]
Epoch: 14   train:  0.68740  val:  1.04526  
(15 ): 100% 89/89 [00:00&lt;00:00, 97.48it/s, train_loss=0.725]
Epoch: 15   train:  0.67550  val:  1.03545  
(16 ): 100% 89/89 [00:00&lt;00:00, 103.46it/s, train_loss=0.676]
Epoch: 16   train:  0.66732  val:  1.02976  
(17 ): 100% 89/89 [00:00&lt;00:00, 99.98it/s, train_loss=0.634]
Epoch: 17   train:  0.65880  val:  1.02630  
(18 ): 100% 89/89 [00:00&lt;00:00, 102.10it/s, train_loss=0.684]
Epoch: 18   train:  0.65355  val:  1.02109  
(19 ): 100% 89/89 [00:00&lt;00:00, 101.78it/s, train_loss=0.678]
Epoch: 19   train:  0.64726  val:  1.01894  
(20 ): 100% 89/89 [00:00&lt;00:00, 100.12it/s, train_loss=0.646]
Epoch: 20   train:  0.64413  val:  1.01405  
(21 ): 100% 89/89 [00:00&lt;00:00, 97.41it/s, train_loss=0.724]
Epoch: 21   train:  0.64022  val:  1.01139  
(22 ): 100% 89/89 [00:00&lt;00:00, 102.92it/s, train_loss=0.653]
Epoch: 22   train:  0.63731  val:  1.00706  
(23 ): 100% 89/89 [00:00&lt;00:00, 96.05it/s, train_loss=0.588] 
Epoch: 23   train:  0.63537  val:  1.00648  
(24 ): 100% 89/89 [00:00&lt;00:00, 96.94it/s, train_loss=0.677] 
Epoch: 24   train:  0.63058  val:  1.00690  
(25 ): 100% 89/89 [00:00&lt;00:00, 90.87it/s, train_loss=0.712]
Epoch: 25   train:  0.63242  val:  1.01011  
(26 ): 100% 89/89 [00:00&lt;00:00, 95.66it/s, train_loss=0.666]
Epoch: 26   train:  0.62927  val:  1.01176  
(27 ): 100% 89/89 [00:00&lt;00:00, 94.58it/s, train_loss=0.594]
Epoch: 27   train:  0.63036  val:  1.00783  
(28 ): 100% 89/89 [00:00&lt;00:00, 92.47it/s, train_loss=0.703]
Epoch: 28   train:  0.62958  val:  1.00737  
(29 ): 100% 89/89 [00:00&lt;00:00, 92.86it/s, train_loss=0.669]
Epoch: 29   train:  0.62973  val:  1.00857  
(30 ): 100% 89/89 [00:00&lt;00:00, 95.10it/s, train_loss=0.723]
Epoch: 30   train:  0.62967  val:  1.01080  
(31 ): 100% 89/89 [00:00&lt;00:00, 95.64it/s, train_loss=0.726]
Epoch: 31   train:  0.62821  val:  1.00937  
(32 ): 100% 89/89 [00:00&lt;00:00, 94.79it/s, train_loss=0.674]
Epoch: 32   train:  0.63007  val:  1.00693  
(33 ): 100% 89/89 [00:00&lt;00:00, 96.29it/s, train_loss=0.65]
Epoch: 33   train:  0.62933  val:  1.00872  
(34 ): 100% 89/89 [00:00&lt;00:00, 95.44it/s, train_loss=0.669]
Epoch: 34   train:  0.62964  val:  1.00822  
(35 ): 100% 89/89 [00:00&lt;00:00, 92.46it/s, train_loss=0.711]
Epoch: 35   train:  0.62926  val:  1.01489  
(36 ): 100% 89/89 [00:00&lt;00:00, 93.36it/s, train_loss=0.689]
Epoch: 36   train:  0.63266  val:  1.01679  
(37 ): 100% 89/89 [00:00&lt;00:00, 95.29it/s, train_loss=0.695]
Epoch: 37   train:  0.62937  val:  1.00905  
(38 ): 100% 89/89 [00:00&lt;00:00, 94.00it/s, train_loss=0.653]
Epoch: 38   train:  0.63059  val:  1.01712  
(39 ): 100% 89/89 [00:00&lt;00:00, 95.39it/s, train_loss=0.71]
Epoch: 39   train:  0.63048  val:  1.01576  
(40 ): 100% 89/89 [00:00&lt;00:00, 96.14it/s, train_loss=0.761]
Epoch: 40   train:  0.63232  val:  1.01292  
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="implicit">
<a class="anchor" href="#implicit" aria-hidden="true"><span class="octicon octicon-link"></span></a>implicit<a class="anchor-link" href="#implicit"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">python</span> <span class="n">run</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">example</span> <span class="n">implicit</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>/usr/local/lib/python3.7/dist-packages/torch/utils/data/dataloader.py:481: UserWarning: This DataLoader will create 4 worker processes in total. Our suggested max number of worker in current system is 2, which is smaller than what this DataLoader is going to create. Please be aware that excessive worker creation might get DataLoader running slow or even freeze, lower the worker number to avoid potential slowness/freeze if necessary.
  cpuset_checked))
( 1 ): 100% 46/46 [00:01&lt;00:00, 28.55it/s, train_loss=0.382]
Epoch:  1   train:  0.41578  val:  0.39289  eval-auc:  0.55840  eval-patk:  0.00913  
( 2 ): 100% 46/46 [00:01&lt;00:00, 28.86it/s, train_loss=0.323]
Epoch:  2   train:  0.34652  val:  0.34228  eval-auc:  0.61282  eval-patk:  0.01507  
( 3 ): 100% 46/46 [00:01&lt;00:00, 30.01it/s, train_loss=0.273]
Epoch:  3   train:  0.27728  val:  0.31357  eval-auc:  0.65768  eval-patk:  0.02215  
( 4 ): 100% 46/46 [00:01&lt;00:00, 29.36it/s, train_loss=0.226]
Epoch:  4   train:  0.23051  val:  0.29723  eval-auc:  0.69258  eval-patk:  0.02991  
( 5 ): 100% 46/46 [00:01&lt;00:00, 29.57it/s, train_loss=0.198]
Epoch:  5   train:  0.20115  val:  0.28018  eval-auc:  0.71729  eval-patk:  0.03539  
( 6 ): 100% 46/46 [00:01&lt;00:00, 28.66it/s, train_loss=0.152]
Epoch:  6   train:  0.17812  val:  0.26524  eval-auc:  0.73440  eval-patk:  0.03607  
( 7 ): 100% 46/46 [00:01&lt;00:00, 30.65it/s, train_loss=0.15]
Epoch:  7   train:  0.16726  val:  0.25652  eval-auc:  0.74640  eval-patk:  0.03813  
( 8 ): 100% 46/46 [00:01&lt;00:00, 29.89it/s, train_loss=0.172]
Epoch:  8   train:  0.15538  val:  0.24975  eval-auc:  0.75780  eval-patk:  0.03950  
( 9 ): 100% 46/46 [00:01&lt;00:00, 29.88it/s, train_loss=0.133]
Epoch:  9   train:  0.14574  val:  0.24520  eval-auc:  0.76651  eval-patk:  0.04498  
(10 ): 100% 46/46 [00:01&lt;00:00, 30.02it/s, train_loss=0.14]
Epoch: 10   train:  0.13953  val:  0.22739  eval-auc:  0.77529  eval-patk:  0.04749  
(11 ): 100% 46/46 [00:01&lt;00:00, 29.70it/s, train_loss=0.151]
Epoch: 11   train:  0.13218  val:  0.22872  eval-auc:  0.78306  eval-patk:  0.04749  
(12 ): 100% 46/46 [00:01&lt;00:00, 29.81it/s, train_loss=0.13]
Epoch: 12   train:  0.12857  val:  0.22756  eval-auc:  0.78880  eval-patk:  0.04840  
(13 ): 100% 46/46 [00:01&lt;00:00, 30.26it/s, train_loss=0.13]
Epoch: 13   train:  0.12364  val:  0.21565  eval-auc:  0.79382  eval-patk:  0.05114  
(14 ): 100% 46/46 [00:01&lt;00:00, 30.80it/s, train_loss=0.0979]
Epoch: 14   train:  0.11943  val:  0.21567  eval-auc:  0.79833  eval-patk:  0.05479  
(15 ): 100% 46/46 [00:01&lt;00:00, 30.27it/s, train_loss=0.109]
Epoch: 15   train:  0.11619  val:  0.21074  eval-auc:  0.80249  eval-patk:  0.05548  
(16 ): 100% 46/46 [00:01&lt;00:00, 29.81it/s, train_loss=0.129]
Epoch: 16   train:  0.11254  val:  0.21105  eval-auc:  0.80617  eval-patk:  0.05890  
(17 ): 100% 46/46 [00:01&lt;00:00, 30.27it/s, train_loss=0.111]
Epoch: 17   train:  0.10796  val:  0.20284  eval-auc:  0.80958  eval-patk:  0.05890  
(18 ): 100% 46/46 [00:01&lt;00:00, 30.48it/s, train_loss=0.1]
Epoch: 18   train:  0.10627  val:  0.19820  eval-auc:  0.81167  eval-patk:  0.06119  
(19 ): 100% 46/46 [00:01&lt;00:00, 29.63it/s, train_loss=0.132]
Epoch: 19   train:  0.10392  val:  0.20573  eval-auc:  0.81511  eval-patk:  0.06370  
(20 ): 100% 46/46 [00:01&lt;00:00, 29.22it/s, train_loss=0.106]
Epoch: 20   train:  0.10310  val:  0.20031  eval-auc:  0.81784  eval-patk:  0.06393  
(21 ): 100% 46/46 [00:01&lt;00:00, 29.44it/s, train_loss=0.084]
Epoch: 21   train:  0.10323  val:  0.19672  eval-auc:  0.82062  eval-patk:  0.06530  
(22 ): 100% 46/46 [00:01&lt;00:00, 28.61it/s, train_loss=0.123]
Epoch: 22   train:  0.10163  val:  0.19164  eval-auc:  0.82266  eval-patk:  0.06986  
(23 ): 100% 46/46 [00:01&lt;00:00, 29.98it/s, train_loss=0.109]
Epoch: 23   train:  0.09932  val:  0.18622  eval-auc:  0.82489  eval-patk:  0.06849  
(24 ): 100% 46/46 [00:01&lt;00:00, 30.33it/s, train_loss=0.125]
Epoch: 24   train:  0.09856  val:  0.18985  eval-auc:  0.82689  eval-patk:  0.06941  
(25 ): 100% 46/46 [00:01&lt;00:00, 30.46it/s, train_loss=0.0867]
Epoch: 25   train:  0.09591  val:  0.18680  eval-auc:  0.82851  eval-patk:  0.07100  
(26 ): 100% 46/46 [00:01&lt;00:00, 29.23it/s, train_loss=0.0945]
Epoch: 26   train:  0.09670  val:  0.18181  eval-auc:  0.83038  eval-patk:  0.07009  
(27 ): 100% 46/46 [00:01&lt;00:00, 29.79it/s, train_loss=0.0699]
Epoch: 27   train:  0.09253  val:  0.18122  eval-auc:  0.83169  eval-patk:  0.06667  
(28 ): 100% 46/46 [00:01&lt;00:00, 30.00it/s, train_loss=0.0759]
Epoch: 28   train:  0.09226  val:  0.18196  eval-auc:  0.83282  eval-patk:  0.06826  
(29 ): 100% 46/46 [00:01&lt;00:00, 29.22it/s, train_loss=0.0822]
Epoch: 29   train:  0.09307  val:  0.18249  eval-auc:  0.83441  eval-patk:  0.07648  
(30 ): 100% 46/46 [00:01&lt;00:00, 30.18it/s, train_loss=0.114]
Epoch: 30   train:  0.09162  val:  0.18411  eval-auc:  0.83504  eval-patk:  0.07648  
(31 ): 100% 46/46 [00:01&lt;00:00, 29.39it/s, train_loss=0.086]
Epoch: 31   train:  0.08987  val:  0.17815  eval-auc:  0.83631  eval-patk:  0.07374  
(32 ): 100% 46/46 [00:01&lt;00:00, 29.27it/s, train_loss=0.0911]
Epoch: 32   train:  0.08841  val:  0.18399  eval-auc:  0.83683  eval-patk:  0.07306  
(33 ): 100% 46/46 [00:01&lt;00:00, 29.72it/s, train_loss=0.0876]
Epoch: 33   train:  0.09061  val:  0.17719  eval-auc:  0.83845  eval-patk:  0.07489  
(34 ): 100% 46/46 [00:01&lt;00:00, 29.93it/s, train_loss=0.0647]
Epoch: 34   train:  0.08688  val:  0.18095  eval-auc:  0.83955  eval-patk:  0.06918  
(35 ): 100% 46/46 [00:01&lt;00:00, 30.05it/s, train_loss=0.0928]
Epoch: 35   train:  0.08915  val:  0.17626  eval-auc:  0.84050  eval-patk:  0.07215  
(36 ): 100% 46/46 [00:01&lt;00:00, 29.89it/s, train_loss=0.111]
Epoch: 36   train:  0.08683  val:  0.17530  eval-auc:  0.84146  eval-patk:  0.07420  
(37 ): 100% 46/46 [00:01&lt;00:00, 29.70it/s, train_loss=0.0915]
Epoch: 37   train:  0.08663  val:  0.16717  eval-auc:  0.84286  eval-patk:  0.07215  
(38 ): 100% 46/46 [00:01&lt;00:00, 29.93it/s, train_loss=0.0765]
Epoch: 38   train:  0.08452  val:  0.16749  eval-auc:  0.84417  eval-patk:  0.07763  
(39 ): 100% 46/46 [00:01&lt;00:00, 30.19it/s, train_loss=0.0737]
Epoch: 39   train:  0.08514  val:  0.16763  eval-auc:  0.84427  eval-patk:  0.07443  
(40 ): 100% 46/46 [00:01&lt;00:00, 29.84it/s, train_loss=0.0934]
Epoch: 40   train:  0.08454  val:  0.16994  eval-auc:  0.84553  eval-patk:  0.07283  
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="recohut/notebook"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/pytorch/movie/mf/factorization/2021/07/05/mf-movielens-pytorch.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
