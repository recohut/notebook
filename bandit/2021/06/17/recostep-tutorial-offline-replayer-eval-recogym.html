<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Offline Replayer Evaluation I - Recogym | reconb</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Offline Replayer Evaluation I - Recogym" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Running recogym for offline simulation and evaluation" />
<meta property="og:description" content="Running recogym for offline simulation and evaluation" />
<link rel="canonical" href="https://nb.recohut.com/bandit/2021/06/17/recostep-tutorial-offline-replayer-eval-recogym.html" />
<meta property="og:url" content="https://nb.recohut.com/bandit/2021/06/17/recostep-tutorial-offline-replayer-eval-recogym.html" />
<meta property="og:site_name" content="reconb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-17T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Offline Replayer Evaluation I - Recogym" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-06-17T00:00:00-05:00","datePublished":"2021-06-17T00:00:00-05:00","description":"Running recogym for offline simulation and evaluation","headline":"Offline Replayer Evaluation I - Recogym","mainEntityOfPage":{"@type":"WebPage","@id":"https://nb.recohut.com/bandit/2021/06/17/recostep-tutorial-offline-replayer-eval-recogym.html"},"url":"https://nb.recohut.com/bandit/2021/06/17/recostep-tutorial-offline-replayer-eval-recogym.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nb.recohut.com/feed.xml" title="reconb" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">reconb</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Offline Replayer Evaluation I - Recogym</h1><p class="page-description">Running recogym for offline simulation and evaluation</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-06-17T00:00:00-05:00" itemprop="datePublished">
        Jun 17, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      14 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#bandit">bandit</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/recohut/notebook/tree/master/_notebooks/2021-06-17-recostep-tutorial-offline-replayer-eval-recogym.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/recohut/notebook/master?filepath=_notebooks%2F2021-06-17-recostep-tutorial-offline-replayer-eval-recogym.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/recohut/notebook/blob/master/_notebooks/2021-06-17-recostep-tutorial-offline-replayer-eval-recogym.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Frecohut%2Fnotebook%2Fblob%2Fmaster%2F_notebooks%2F2021-06-17-recostep-tutorial-offline-replayer-eval-recogym.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Environment-setup">Environment setup </a></li>
<li class="toc-entry toc-h2"><a href="#Defining-evaluation-methods">Defining evaluation methods </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Traditional-evaluation">Traditional evaluation </a></li>
<li class="toc-entry toc-h3"><a href="#Counterfactual-evaluation">Counterfactual evaluation </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Creating-agents">Creating agents </a>
<ul>
<li class="toc-entry toc-h3"><a href="#SVD-agent">SVD agent </a></li>
<li class="toc-entry toc-h3"><a href="#Item-KNN-agent">Item-KNN agent </a></li>
<li class="toc-entry toc-h3"><a href="#User-KNN-agent">User-KNN agent </a></li>
<li class="toc-entry toc-h3"><a href="#Agent-initializations">Agent initializations </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Offline-evaluation">Offline evaluation </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Generating-test-logs">Generating test logs </a></li>
<li class="toc-entry toc-h3"><a href="#(Util)-helper-function-to-plot-barchart">(Util) helper function to plot barchart </a></li>
<li class="toc-entry toc-h3"><a href="#Leave-one-out-evaluation">Leave-one-out evaluation </a></li>
<li class="toc-entry toc-h3"><a href="#IPS-Estimators">IPS Estimators </a></li>
<li class="toc-entry toc-h3"><a href="#A/B-tests">A/B tests </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-06-17-recostep-tutorial-offline-replayer-eval-recogym.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://colab.research.google.com/github/recohut-admin/reco-nb-dev/blob/master/_notebooks/2021-06-17-recostep-tutorial-offline-replayer-eval-recogym.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Environment-setup">
<a class="anchor" href="#Environment-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Environment setup<a class="anchor-link" href="#Environment-setup"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">recogym</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.random.mtrand</span> <span class="kn">import</span> <span class="n">RandomState</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">logsumexp</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.stats.distributions</span> <span class="kn">import</span> <span class="n">beta</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">svds</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FormatStrFormatter</span>

<span class="kn">import</span> <span class="nn">gym</span><span class="o">,</span> <span class="nn">recogym</span>
<span class="kn">from</span> <span class="nn">recogym</span> <span class="kn">import</span> <span class="n">env_1_args</span><span class="p">,</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">recogym.agents</span> <span class="kn">import</span> <span class="n">OrganicUserEventCounterAgent</span><span class="p">,</span> <span class="n">organic_user_count_args</span>
<span class="kn">from</span> <span class="nn">recogym.agents.organic_count</span> <span class="kn">import</span> <span class="n">OrganicCount</span><span class="p">,</span> <span class="n">organic_count_args</span><span class="p">,</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">recogym</span> <span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">recogym.agents</span> <span class="kn">import</span> <span class="n">Agent</span>
<span class="kn">from</span> <span class="nn">recogym.envs.observation</span> <span class="kn">import</span> <span class="n">Observation</span>
<span class="kn">from</span> <span class="nn">recogym.agents</span> <span class="kn">import</span> <span class="n">RandomAgent</span><span class="p">,</span> <span class="n">random_args</span>
<span class="kn">from</span> <span class="nn">recogym</span> <span class="kn">import</span> <span class="n">verify_agents</span><span class="p">,</span> <span class="n">verify_agents_IPS</span>
<span class="kn">from</span> <span class="nn">recogym.evaluate_agent</span> <span class="kn">import</span> <span class="n">plot_verify_agents</span><span class="p">,</span> <span class="n">verify_agents_recall_at_k</span>

<span class="kn">from</span> <span class="nn">recogym.envs.session</span> <span class="kn">import</span> <span class="n">OrganicSessions</span>
<span class="kn">from</span> <span class="nn">recogym.envs.context</span> <span class="kn">import</span> <span class="n">DefaultContext</span>
<span class="kn">from</span> <span class="nn">recogym.envs.observation</span> <span class="kn">import</span> <span class="n">Observation</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">P</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># Number of Products</span>
<span class="n">U</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># Number of Users</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">env_1_args</span><span class="p">[</span><span class="s1">'random_seed'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">'num_products'</span><span class="p">]</span><span class="o">=</span> <span class="n">P</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">'phi_var'</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">'number_of_flips'</span><span class="p">]</span><span class="o">=</span><span class="n">P</span><span class="o">//</span><span class="mi">2</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">'sigma_mu_organic'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">'sigma_omega'</span><span class="p">]</span><span class="o">=</span><span class="mf">0.05</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">'reco-gym-v1'</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">init_gym</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">reco_log</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">generate_logs</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
<span class="n">reco_log</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 2000/2000 [02:15&lt;00:00, 14.73it/s]
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>t</th>
      <th>u</th>
      <th>z</th>
      <th>v</th>
      <th>a</th>
      <th>c</th>
      <th>ps</th>
      <th>ps-a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0</td>
      <td>organic</td>
      <td>116</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1123</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1332</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>805</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1184</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.0</td>
      <td>1</td>
      <td>organic</td>
      <td>1205</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1.0</td>
      <td>1</td>
      <td>organic</td>
      <td>1137</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2.0</td>
      <td>1</td>
      <td>organic</td>
      <td>1337</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>8</th>
      <td>3.0</td>
      <td>1</td>
      <td>organic</td>
      <td>972</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>9</th>
      <td>4.0</td>
      <td>1</td>
      <td>organic</td>
      <td>841</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>10</th>
      <td>5.0</td>
      <td>1</td>
      <td>organic</td>
      <td>140</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>11</th>
      <td>6.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1367</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>12</th>
      <td>7.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1086</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>13</th>
      <td>8.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1698</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>14</th>
      <td>9.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1513</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>15</th>
      <td>10.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>134</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>16</th>
      <td>11.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1056</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>17</th>
      <td>12.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1751</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>18</th>
      <td>13.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>725</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>19</th>
      <td>14.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>612</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">n_events</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_organic</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'z'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'organic'</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Training on </span><span class="si">{0}</span><span class="s1"> organic and </span><span class="si">{1}</span><span class="s1"> bandit events'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_organic</span><span class="p">,</span> <span class="n">n_events</span> <span class="o">-</span> <span class="n">n_organic</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Training on 43753 organic and 159967 bandit events
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Defining-evaluation-methods">
<a class="anchor" href="#Defining-evaluation-methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining evaluation methods<a class="anchor-link" href="#Defining-evaluation-methods"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Traditional-evaluation">
<a class="anchor" href="#Traditional-evaluation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Traditional evaluation<a class="anchor-link" href="#Traditional-evaluation"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">leave_one_out</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="c1"># 1. Extract all organic events</span>
    <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'z'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'organic'</span><span class="p">]</span>
    
    <span class="c1"># 2. For every user sequence - randomly sample out an item</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">folds</span><span class="p">):</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="c1"># If we have a new user</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
                    <span class="c1"># Sample out last item</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Sample out a random item from the history</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">),</span>
                                             <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">test</span>  <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">train</span> <span class="o">=</span> <span class="n">history</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">history</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

                <span class="c1"># 3. Recreate the user sequence without these items - Let the agent observe the incomplete sequence</span>
                <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">train</span><span class="p">):</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

                <span class="c1"># 4. Generate a top-N set of recommendations by letting the agent act</span>
                <span class="c1"># TODO - For now only works for N = 1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prob_a</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">Observation</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="n">session</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)[</span><span class="s1">'ps-a'</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">prob_a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">P</span><span class="p">]</span> <span class="o">*</span> <span class="n">P</span>

                <span class="c1"># 5. Compute metrics checking whether the sampled test item is in the top-N</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">prob_a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">except</span><span class="p">:</span>
                  <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Reset variables</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span>
                <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

            <span class="c1"># Save the organic interaction to the running average for the session</span>
            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
    
    <span class="c1"># Error analysis</span>
    <span class="n">mean_hits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
    <span class="n">serr_hits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">))</span>
    <span class="n">low_bound</span> <span class="o">=</span> <span class="n">mean_hits</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">serr_hits</span>
    <span class="n">upp_bound</span> <span class="o">=</span> <span class="n">mean_hits</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">serr_hits</span>
    
    <span class="k">return</span> <span class="n">mean_hits</span><span class="p">,</span> <span class="n">low_bound</span><span class="p">,</span> <span class="n">upp_bound</span>

<span class="k">def</span> <span class="nf">verify_agents_traditional</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agents</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Placeholder DataFrame for result</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'Agent'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.025'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.500'</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.975'</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="c1"># For every agent</span>
    <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
        <span class="c1"># Compute HR@k</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">upp</span> <span class="o">=</span> <span class="n">leave_one_out</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agents</span><span class="p">[</span><span class="n">agent_id</span><span class="p">],</span> <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="n">folds</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">'Agent'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">'0.025'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">'0.975'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Counterfactual-evaluation">
<a class="anchor" href="#Counterfactual-evaluation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Counterfactual evaluation<a class="anchor-link" href="#Counterfactual-evaluation"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">compute_ips_weights</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">):</span>
    <span class="c1"># Placeholder for return values</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Labels for actions</span>
    <span class="n">t_props</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Treatment propensities</span>
    <span class="n">l_props</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Logging propensities</span>
    
    <span class="c1"># For every logged interaction</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="c1"># If we have a new user</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="c1"># Reset</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span>
        
        <span class="c1"># If we have an organic event</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="s1">'organic'</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>        
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob_a</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">Observation</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="n">session</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)[</span><span class="s1">'ps-a'</span><span class="p">]</span>
            <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="n">t_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob_a</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">a</span><span class="p">)])</span>
            <span class="k">except</span><span class="p">:</span>
              <span class="n">t_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">l_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ps</span><span class="p">)</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rewards</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t_props</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">l_props</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">verify_agents_counterfactual</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agents</span><span class="p">,</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="c1"># Placeholder DataFrame for results</span>
    <span class="n">IPS_stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'Agent'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.025'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.500'</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.975'</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">CIPS_stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'Agent'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.025'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.500'</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.975'</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">SNIPS_stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'Agent'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.025'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.500'</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'0.975'</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="c1"># For every agent</span>
    <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
        <span class="c1"># Get the rewards and propensities</span>
        <span class="n">rewards</span><span class="p">,</span> <span class="n">t_props</span><span class="p">,</span> <span class="n">l_props</span> <span class="o">=</span> <span class="n">compute_ips_weights</span><span class="p">(</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_id</span><span class="p">],</span> <span class="n">reco_log</span><span class="p">)</span>
        
        <span class="c1"># Compute the sample weights - propensity ratios</span>
        <span class="n">p_ratio</span> <span class="o">=</span> <span class="n">t_props</span> <span class="o">/</span> <span class="n">l_props</span>

        <span class="c1"># Effective sample size for E_t estimate (from A. Owen)</span>
        <span class="n">n_e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_ratio</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_ratio</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">n_e</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">n_e</span><span class="p">)</span> <span class="k">else</span> <span class="n">n_e</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Effective sample size for agent </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">agent_id</span><span class="p">),</span> <span class="n">n_e</span><span class="p">))</span>
        
        <span class="c1"># Critical value from t-distribution as we have unknown variance</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">00125</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1">###############</span>
        <span class="c1"># VANILLA IPS #</span>
        <span class="c1">###############</span>
        <span class="c1"># Expected reward for pi_t</span>
        <span class="n">E_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio</span><span class="p">)</span>

        <span class="c1"># Variance of the estimate</span>
        <span class="n">var</span> <span class="o">=</span> <span class="p">((</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio</span> <span class="o">-</span> <span class="n">E_t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stddev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        
        <span class="c1"># C.I. assuming unknown variance - use t-distribution and effective sample size</span>
        <span class="n">min_bound</span> <span class="o">=</span> <span class="n">E_t</span> <span class="o">-</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        <span class="n">max_bound</span> <span class="o">=</span> <span class="n">E_t</span> <span class="o">+</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        
        <span class="c1"># Store result</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">'Agent'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">'0.025'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_bound</span><span class="p">)</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_t</span><span class="p">)</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">'0.975'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_bound</span><span class="p">)</span>
        
        <span class="c1">############## </span>
        <span class="c1"># CAPPED IPS #</span>
        <span class="c1">##############</span>
        <span class="c1"># Cap ratios</span>
        <span class="n">p_ratio_capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">p_ratio</span><span class="p">,</span> <span class="n">a_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">a_max</span> <span class="o">=</span> <span class="n">cap</span><span class="p">)</span>
        
        <span class="c1"># Expected reward for pi_t</span>
        <span class="n">E_t_capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio_capped</span><span class="p">)</span>

        <span class="c1"># Variance of the estimate</span>
        <span class="n">var_capped</span> <span class="o">=</span> <span class="p">((</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio_capped</span> <span class="o">-</span> <span class="n">E_t_capped</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stddev_capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_capped</span><span class="p">)</span>        
        
        <span class="c1"># C.I. assuming unknown variance - use t-distribution and effective sample size</span>
        <span class="n">min_bound_capped</span> <span class="o">=</span> <span class="n">E_t_capped</span> <span class="o">-</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_capped</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        <span class="n">max_bound_capped</span> <span class="o">=</span> <span class="n">E_t_capped</span> <span class="o">+</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_capped</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        
        <span class="c1"># Store result</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">'Agent'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">'0.025'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_bound_capped</span><span class="p">)</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_t_capped</span><span class="p">)</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">'0.975'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_bound_capped</span><span class="p">)</span>
        
        <span class="c1">##############</span>
        <span class="c1"># NORMED IPS #</span>
        <span class="c1">##############</span>
        <span class="c1"># Expected reward for pi_t</span>
        <span class="n">E_t_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_ratio</span><span class="p">)</span>

        <span class="c1"># Variance of the estimate</span>
        <span class="n">var_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">rewards</span> <span class="o">-</span> <span class="n">E_t_normed</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ratio</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_ratio</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>    
        <span class="n">stddev_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_normed</span><span class="p">)</span>

        <span class="c1"># C.I. assuming unknown variance - use t-distribution and effective sample size</span>
        <span class="n">min_bound_normed</span> <span class="o">=</span> <span class="n">E_t_normed</span> <span class="o">-</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_normed</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        <span class="n">max_bound_normed</span> <span class="o">=</span> <span class="n">E_t_normed</span> <span class="o">+</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_normed</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>

        <span class="c1"># Store result</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">'Agent'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">'0.025'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_bound_normed</span><span class="p">)</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_t_normed</span><span class="p">)</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">'0.975'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_bound_normed</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">IPS_stat</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">CIPS_stat</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">SNIPS_stat</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Creating-agents">
<a class="anchor" href="#Creating-agents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating agents<a class="anchor-link" href="#Creating-agents"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="SVD-agent">
<a class="anchor" href="#SVD-agent" aria-hidden="true"><span class="octicon octicon-link"></span></a>SVD agent<a class="anchor-link" href="#SVD-agent"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">SVDAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVDAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">P</span> <span class="o">&gt;=</span> <span class="n">K</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">):</span>
        <span class="c1"># Extract all organic user logs</span>
        <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'z'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'organic'</span><span class="p">]</span>
        
        <span class="c1"># Generate ratings matrix for training, row-based for efficient row (user) retrieval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)),</span>
                            <span class="p">(</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'u'</span><span class="p">],</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'v'</span><span class="p">])),</span>
                            <span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>

        <span class="c1"># Singular Value Decomposition</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">svds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">observation</span><span class="o">.</span><span class="n">sessions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="p">[</span><span class="n">session</span><span class="p">[</span><span class="s1">'v'</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="sd">"""Act method returns an Action based on current observation and past history"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">'a'</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">'ps'</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                <span class="s1">'ps-a'</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Item-KNN-agent">
<a class="anchor" href="#Item-KNN-agent" aria-hidden="true"><span class="octicon octicon-link"></span></a>Item-KNN agent<a class="anchor-link" href="#Item-KNN-agent"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">itemkNNAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">itemkNNAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span> <span class="o">=</span> <span class="n">greedy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rt</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">U</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">):</span>
        <span class="c1"># Extract all organic user logs</span>
        <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'z'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'organic'</span><span class="p">]</span>
        
        <span class="c1"># Generate ratings matrix for training, row-based for efficient row (user) retrieval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_t</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)),</span>
                              <span class="p">(</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'v'</span><span class="p">],</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'u'</span><span class="p">])),</span>
                              <span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">U</span><span class="p">))</span>

        <span class="c1"># Set up nearest neighbours module</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                              <span class="n">metric</span> <span class="o">=</span> <span class="s1">'cosine'</span><span class="p">)</span>

        <span class="c1"># Initialise placeholder for distances and indices</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span>   <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Dirty fix for multiprocessing backend being unable to pickle large objects</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_t</span><span class="p">)</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_t</span><span class="p">,</span> <span class="n">return_distance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Precompute similarity matrix S</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">distances</span><span class="p">))</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">P</span><span class="p">)))</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
        
        <span class="c1"># (P,P)-matrix with cosine similarities between items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span> <span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">P</span><span class="p">))</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">observation</span><span class="o">.</span><span class="n">sessions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="p">[</span><span class="n">session</span><span class="p">[</span><span class="s1">'v'</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="sd">"""Act method returns an Action based on current observation and past history"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">A1</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">**=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="n">prob</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">'a'</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">'ps'</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                <span class="s1">'ps-a'</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="User-KNN-agent">
<a class="anchor" href="#User-KNN-agent" aria-hidden="true"><span class="octicon octicon-link"></span></a>User-KNN agent<a class="anchor-link" href="#User-KNN-agent"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">userkNNAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">userkNNAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span> <span class="o">=</span> <span class="n">greedy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">'cosine'</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">):</span>
        <span class="c1"># Extract all organic user logs</span>
        <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'z'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'organic'</span><span class="p">]</span>
        
        <span class="c1"># Generate ratings matrix for training, row-based for efficient row (user) retrieval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)),</span>
                            <span class="p">(</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'u'</span><span class="p">],</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">'v'</span><span class="p">])),</span>
                            <span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>

        <span class="c1"># Fit nearest neighbours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">observation</span><span class="o">.</span><span class="n">sessions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="p">[</span><span class="n">session</span><span class="p">[</span><span class="s1">'v'</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="sd">"""Act method returns an Action based on current observation and past history"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        
        <span class="c1"># Get neighbouring users based on user history</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">dist</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span> <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span><span class="n">indices</span><span class="p">)])</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">**=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">prob</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">'a'</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">'ps'</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                <span class="s1">'ps-a'</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Agent-initializations">
<a class="anchor" href="#Agent-initializations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Agent initializations<a class="anchor-link" href="#Agent-initializations"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">SVD_agent</span> <span class="o">=</span> <span class="n">SVDAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">SVD_agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)</span>

<span class="c1"># item-kNN Agent</span>
<span class="n">itemkNN_agent</span> <span class="o">=</span> <span class="n">itemkNNAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">itemkNN_agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)</span>

<span class="c1"># user-kNN Agent</span>
<span class="n">userkNN_agent</span> <span class="o">=</span> <span class="n">userkNNAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">userkNN_agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)</span>

<span class="c1"># Generalised Popularity agent</span>
<span class="n">GPOP_agent</span> <span class="o">=</span> <span class="n">OrganicCount</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">'select_randomly'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Generalised Popularity agent</span>
<span class="n">GPOP_agent_greedy</span> <span class="o">=</span> <span class="n">OrganicCount</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">'select_randomly'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Peronalised Popularity agent</span>
<span class="n">PPOP_agent</span> <span class="o">=</span> <span class="n">OrganicUserEventCounterAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">organic_user_count_args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">'select_randomly'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Peronalised Popularity agent</span>
<span class="n">PPOP_agent_greedy</span> <span class="o">=</span> <span class="n">OrganicUserEventCounterAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">organic_user_count_args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">'select_randomly'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Random Agent</span>
<span class="n">random_args</span><span class="p">[</span><span class="s1">'num_products'</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
<span class="n">RAND_agent</span> <span class="o">=</span> <span class="n">RandomAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span><span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span> <span class="o">**</span><span class="n">random_args</span><span class="p">,}))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Offline-evaluation">
<a class="anchor" href="#Offline-evaluation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Offline evaluation<a class="anchor-link" href="#Offline-evaluation"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Generating-test-logs">
<a class="anchor" href="#Generating-test-logs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generating test logs<a class="anchor-link" href="#Generating-test-logs"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="c1"># Placeholder for agents</span>
<span class="n">agents</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'    Random'</span><span class="p">:</span> <span class="n">RAND_agent</span><span class="p">,</span>
    <span class="s1">'   Popular'</span><span class="p">:</span> <span class="n">GPOP_agent_greedy</span><span class="p">,</span>
    <span class="s1">'   User-pop'</span><span class="p">:</span> <span class="n">PPOP_agent</span><span class="p">,</span>
    <span class="s1">'  SVD'</span><span class="p">:</span>  <span class="n">SVD_agent</span><span class="p">,</span>
    <span class="s1">' User-kNN'</span><span class="p">:</span> <span class="n">userkNN_agent</span><span class="p">,</span>
    <span class="s1">'Item-kNN'</span><span class="p">:</span> <span class="n">itemkNN_agent</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">agent_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">agents</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="c1">#['SVD','GPOP','PPOP','RAND']</span>
<span class="c1"># Generate new logs, to be used for offline testing</span>
<span class="n">n_test_users</span> <span class="o">=</span> <span class="mi">5000</span> <span class="c1"># U</span>
<span class="n">test_log</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">generate_logs</span><span class="p">(</span><span class="n">n_test_users</span><span class="p">)</span>
<span class="n">n_events</span> <span class="o">=</span> <span class="n">test_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_organic</span> <span class="o">=</span> <span class="n">test_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_log</span><span class="p">[</span><span class="s1">'z'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'organic'</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Testing on </span><span class="si">{0}</span><span class="s1"> organic and </span><span class="si">{1}</span><span class="s1"> bandit events'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_organic</span><span class="p">,</span> <span class="n">n_events</span> <span class="o">-</span> <span class="n">n_organic</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [05:38&lt;00:00, 14.77it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Testing on 109631 organic and 403487 bandit events
CPU times: user 6min 4s, sys: 4min 47s, total: 10min 51s
Wall time: 5min 40s
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="(Util)-helper-function-to-plot-barchart">
<a class="anchor" href="#(Util)-helper-function-to-plot-barchart" aria-hidden="true"><span class="octicon octicon-link"></span></a>(Util) helper function to plot barchart<a class="anchor-link" href="#(Util)-helper-function-to-plot-barchart"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">plot_barchart</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span>  <span class="n">col</span> <span class="o">=</span> <span class="s1">'tab:red'</span><span class="p">,</span> <span class="n">figname</span> <span class="o">=</span> <span class="s1">'fig.eps'</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">n_agents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">yticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_agents</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.025'</span><span class="p">]</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.975'</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span>
             <span class="n">mean</span><span class="p">,</span>
             <span class="n">height</span> <span class="o">=</span> <span class="o">.</span><span class="mi">25</span><span class="p">,</span>
             <span class="n">xerr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span>
             <span class="n">align</span> <span class="o">=</span> <span class="s1">'center'</span><span class="p">,</span>
             <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">'Agent'</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">'</span><span class="si">%.2f</span><span class="s1">'</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Leave-one-out-evaluation">
<a class="anchor" href="#Leave-one-out-evaluation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Leave-one-out evaluation<a class="anchor-link" href="#Leave-one-out-evaluation"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">result_LOO</span> <span class="o">=</span> <span class="n">verify_agents_traditional</span><span class="p">(</span><span class="n">test_log</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">agents</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_LOO</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_LOO</span><span class="p">,</span> <span class="s1">'Evaluate on Organic Feedback'</span><span class="p">,</span> <span class="s1">'HR@1'</span><span class="p">,</span> <span class="s1">'tab:red'</span><span class="p">,</span> <span class="s1">'traditional_eval.eps'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/usr/local/lib/python3.7/dist-packages/recogym/agents/organic_user_count.py:51: RuntimeWarning: invalid value encountered in true_divide
  action_proba = features / np.sum(features)
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>0.074560</td>
      <td>0.076895</td>
      <td>0.079231</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>0.079927</td>
      <td>0.082336</td>
      <td>0.084746</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>0.074461</td>
      <td>0.076795</td>
      <td>0.079130</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 6min 45s, sys: 43 s, total: 7min 28s
Wall time: 4min 43s
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="IPS-Estimators">
<a class="anchor" href="#IPS-Estimators" aria-hidden="true"><span class="octicon octicon-link"></span></a>IPS Estimators<a class="anchor-link" href="#IPS-Estimators"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">test_log_ppop</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">generate_logs</span><span class="p">(</span><span class="n">n_test_users</span><span class="p">,</span> <span class="n">agent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">PPOP_agent</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">test_log_ppop</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>t</th>
      <th>u</th>
      <th>z</th>
      <th>v</th>
      <th>a</th>
      <th>c</th>
      <th>ps</th>
      <th>ps-a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0</td>
      <td>organic</td>
      <td>220</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>0</td>
      <td>organic</td>
      <td>867</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0</td>
      <td>0</td>
      <td>organic</td>
      <td>969</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0</td>
      <td>0</td>
      <td>organic</td>
      <td>730</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>969</td>
      <td>0.0</td>
      <td>0.25</td>
      <td>()</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">cap</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">result_IPS</span><span class="p">,</span> <span class="n">result_CIPS</span><span class="p">,</span> <span class="n">result_SNIPS</span> <span class="o">=</span> <span class="n">verify_agents_counterfactual</span><span class="p">(</span><span class="n">test_log_ppop</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">agents</span><span class="p">),</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_IPS</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_IPS</span><span class="p">,</span> <span class="s1">'IPS'</span><span class="p">,</span> <span class="s1">'CTR'</span><span class="p">,</span> <span class="s1">'tab:blue'</span><span class="p">,</span> <span class="s1">'bandit_eval_noclip.eps'</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_CIPS</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_CIPS</span><span class="p">,</span> <span class="s1">'Clipped IPS'</span><span class="p">,</span> <span class="s1">'CTR'</span><span class="p">,</span> <span class="s1">'tab:blue'</span><span class="p">,</span> <span class="s1">'bandit_eval_clip</span><span class="si">{0}</span><span class="s1">.eps'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cap</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:65: RuntimeWarning: invalid value encountered in double_scalars
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:120: RuntimeWarning: invalid value encountered in double_scalars
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Effective sample size for agent     Random is 0
Effective sample size for agent    Popular is 0
Effective sample size for agent    User-pop is 0
Effective sample size for agent   SVD is 21243.67667925834
Effective sample size for agent  User-kNN is 33971.880634000554
Effective sample size for agent Item-kNN is 39627.482103973896
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>0.005323</td>
      <td>0.013057</td>
      <td>0.020791</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>0.010922</td>
      <td>0.017513</td>
      <td>0.024104</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>0.012314</td>
      <td>0.018250</td>
      <td>0.024186</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>0.005590</td>
      <td>0.012160</td>
      <td>0.018731</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>0.010801</td>
      <td>0.016735</td>
      <td>0.022670</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>0.012184</td>
      <td>0.017599</td>
      <td>0.023014</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 45min 36s, sys: 2min 15s, total: 47min 51s
Wall time: 29min 38s
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="A/B-tests">
<a class="anchor" href="#A/B-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>A/B tests<a class="anchor-link" href="#A/B-tests"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">result_AB</span> <span class="o">=</span> <span class="n">verify_agents</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">n_test_users</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">agents</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_AB</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_AB</span><span class="p">,</span> <span class="s1">'A/B-test'</span><span class="p">,</span> <span class="s1">'CTR'</span><span class="p">,</span> <span class="s1">'tab:green'</span><span class="p">,</span> <span class="s1">'ABtest_eval.eps'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [05:39&lt;00:00, 14.71it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [05:35&lt;00:00, 14.92it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [06:49&lt;00:00, 12.20it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [06:39&lt;00:00, 12.53it/s]
Organic Users: 0it [00:00, ?it/s]
Users:  83%|████████▎ | 4163/5000 [18:04&lt;03:51,  3.62it/s]</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">combine_barchart</span><span class="p">(</span><span class="n">resultAB</span><span class="p">,</span> <span class="n">resultCIPS</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span>  <span class="n">figname</span> <span class="o">=</span> <span class="s1">'fig.eps'</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">n_agents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultAB</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">colour</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([(</span><span class="s1">'A/B-test'</span><span class="p">,</span> <span class="s1">'tab:green'</span><span class="p">,</span> <span class="n">result_AB</span><span class="p">),(</span><span class="s1">'CIPS'</span><span class="p">,</span> <span class="s1">'tab:blue'</span><span class="p">,</span> <span class="n">result_CIPS</span><span class="p">)]):</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.025'</span><span class="p">]</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.975'</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">'0.500'</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="o">.</span><span class="mi">25</span>
        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">height</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_agents</span><span class="p">)]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span>
                 <span class="n">mean</span><span class="p">,</span>
                 <span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">,</span>
                 <span class="n">xerr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span>
                 <span class="n">align</span> <span class="o">=</span> <span class="s1">'edge'</span><span class="p">,</span>
                 <span class="n">label</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
                 <span class="n">color</span> <span class="o">=</span> <span class="n">colour</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">'Agent'</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">'lower right'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">'</span><span class="si">%.3f</span><span class="s1">'</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">combine_barchart</span><span class="p">(</span><span class="n">result_AB</span><span class="p">,</span> <span class="n">result_CIPS</span><span class="p">,</span> <span class="s1">'Evaluate on Bandit Feedback'</span><span class="p">,</span> <span class="s1">'CTR'</span><span class="p">,</span> <span class="s1">'ABtest_CIPS.eps'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_LOO</span><span class="p">,</span> <span class="s1">'Evaluate on Organic Feedback'</span><span class="p">,</span> <span class="s1">'HR@1'</span><span class="p">,</span> <span class="s1">'tab:red'</span><span class="p">,</span> <span class="s1">'traditional_eval.eps'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="recohut/notebook"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/bandit/2021/06/17/recostep-tutorial-offline-replayer-eval-recogym.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Jupyter notebook database.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/recohut" target="_blank" title="recohut"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
